"use strict";var fb=Object.defineProperty;var a=(e,t)=>fb(e,"name",{value:t,configurable:!0});var S=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var is=S((M1,Tb)=>{Tb.exports={hdb_table:{hash_attribute:"id",name:"hdb_table",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"name"},{attribute:"hash_attribute"},{attribute:"schema"},{attribute:"residence"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_attribute:{hash_attribute:"id",name:"hdb_attribute",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"schema"},{attribute:"table"},{attribute:"attribute"},{attribute:"schema_table"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_schema:{hash_attribute:"name",name:"hdb_schema",schema:"system",residence:["*"],attributes:[{attribute:"name"},{attribute:"createddate"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_user:{hash_attribute:"username",name:"hdb_user",schema:"system",residence:["*"],attributes:[{attribute:"username"},{attribute:"password"},{attribute:"role"},{attribute:"active"},{attribute:"hash"},{attribute:"refresh_token"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_role:{hash_attribute:"id",name:"hdb_role",schema:"system",attributes:[{attribute:"id"},{attribute:"role"},{attribute:"permission"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}],residence:["*"]},hdb_job:{hash_attribute:"id",name:"hdb_job",schema:"system",attributes:[{attribute:"id"},{attribute:"user"},{attribute:"type"},{attribute:"status"},{attribute:"start_datetime"},{attribute:"end_datetime"},{attribute:"message"},{attribute:"created_datetime"},{attribute:"request"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_license:{hash_attribute:"license_key",name:"hdb_license",schema:"system",attributes:[{attribute:"license_key"},{attribute:"company"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_info:{hash_attribute:"info_id",name:"hdb_info",schema:"system",attributes:[{attribute:"info_id"},{attribute:"data_version_num"},{attribute:"hdb_version_num"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_nodes:{hash_attribute:"name",name:"hdb_nodes",schema:"system",attributes:[{attribute:"name"},{attribute:"subscriptions"},{attribute:"system_info"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_temp:{hash_attribute:"id",name:"hdb_temp",schema:"system",attributes:[{attribute:"id"}]}}});var T=S((P1,sh)=>{"use strict";var $e=require("path"),mb=require("fs");function Rb(){let e=__dirname;for(;!mb.existsSync($e.join(e,"package.json"));){let t=$e.dirname(e);if(t===e)throw new Error("Could not find package root");e=t}return e}a(Rb,"getHDBPackageRoot");var Gt=Rb(),Yd="js",xn=Yd,Ab="harperdb-config.yaml",Ob="defaultConfig.yaml",pb="hdb",Kd=`hdbServer.${xn}`,Qd=`customFunctionsServer.${xn}`,Wd=`hdbIpcServer.${xn}`,Nb=`restartHdb.${xn}`,z_="HarperDB",da="Custom Functions",ha="Clustering Hub",Sa="Clustering Leaf",j_="Clustering Ingest Service",eu="Clustering Reply Service",gb="foreground.pid",X_={HDB:z_,IPC:"IPC",CLUSTERING_HUB:ha,CLUSTERING_LEAF:Sa,CLUSTERING_INGEST_SERVICE:j_,CLUSTERING_REPLY_SERVICE:eu,CUSTOM_FUNCTIONS:da,RESTART_HDB:"Restart HDB",INSTALL:"Install",RUN:"Run",STOP:"Stop",UPGRADE:"Upgrade",REGISTER:"Register",JOB:"Job",PM2_LOGROTATE:"pm2-logrotate",CLUSTERING_UPGRADE_4_0_0:"Upgrade-4-0-0"},Ib={HDB:"hdb.log",IPC:"ipc.log",CLUSTERING_HUB:"clustering_hub.log",CLUSTERING_LEAF:"clustering_leaf.log",CLUSTERING_INGEST_SERVICE:"clustering_ingest_service.log",CLUSTERING_REPLY_SERVICE:"clustering_reply_service.log",CUSTOM_FUNCTIONS:"custom_functions.log",INSTALL:"install.log",CLI:"cli.log",PM2:"pm2.log",CLUSTERING_UPGRADE:"clustering_upgrade.log",JOBS:"jobs.log"},bb={NOTIFY:"notify",FATAL:"fatal",ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug",TRACE:"trace"},Cb={harperdb:z_,ipc:"IPC","clustering hub":ha,"clustering leaf":Sa,"clustering ingest service":j_,"clustering reply service":eu,"custom functions":da,custom_functions:da,"pm2-logrotate":X_.PM2_LOGROTATE,logrotate:X_.PM2_LOGROTATE,clustering:"clustering","clustering config":"clustering config"},wb={CLUSTERING_HUB_PROC_DESCRIPTOR:ha,CLUSTERING_LEAF_PROC_DESCRIPTOR:Sa,CLUSTERING_INGEST_PROC_DESCRIPTOR:j_,CLUSTERING_REPLY_SERVICE_DESCRIPTOR:eu},Ea={HDB:$e.join(Gt,"server/harperdb"),IPC:$e.join(Gt,"server/ipc"),CUSTOM_FUNCTIONS:$e.join(Gt,"server/customFunctions"),CLUSTERING_HUB:$e.join(Gt,"server/nats"),CLUSTERING_LEAF:$e.join(Gt,"server/nats")},Lb={HDB:$e.join(Ea.HDB,Kd),IPC:$e.join(Ea.IPC,Wd),CUSTOM_FUNCTIONS:$e.join(Ea.CUSTOM_FUNCTIONS,Qd)},Ub={HDB:$e.join(Gt,"launchServiceScripts/launchHarperDB.js"),CUSTOM_FUNCTIONS:$e.join(Gt,"launchServiceScripts/launchCustomFunctions.js"),NATS_INGEST_SERVICE:$e.join(Gt,"launchServiceScripts/launchNatsIngestService.js"),NATS_REPLY_SERVICE:$e.join(Gt,"launchServiceScripts/launchNatsReplyService.js"),NODES_UPGRADE_4_0_0:$e.resolve(Gt,"launchServiceScripts/launchUpdateNodes4-0-0.js")},yb={SUPER_USER:"super_user",CLUSTER_USER:"cluster_user"},Jd="support@harperdb.io",Db="customer-success@harperdb.io",Zd=1,Mb=4141,Xd="https://harperdbhelp.zendesk.com/hc/en-us/requests/new",Pb="https://www.harperdb.io/product",Bb=`For support, please submit a request at ${Xd} or contact ${Jd}`,zd=`For license support, please contact ${Db}`,vb="None of the specified records were found.",Hb="hash attribute not found",Gb=`Your current license only supports ${Zd} role.  ${zd}`,qb="Your current license only supports 3 connections to a node.",Fb="127.0.0.1",Vb=1,kb=/^\.$/,xb=/^\.\.$/,$b="U+002E",Yb=/\//g,Kb="U+002F",Qb=/U\+002F/g,Wb=/^U\+002E$/,Jb=/^U\+002EU\+002E$/,Zb="d",Xb=999999,zb="*",jb="--max-old-space-size=",eC="system",tC="__hdb_hash",rC=".harperdb",sC=".hdb",nC="keys",iC="hdb_boot_properties.file",aC=".updateConfig.json",oC="SIGTSTP",cC=24,_C=6e4,uC=448,lC="blob",EC="trash",dC="schema",hC="transactions",SC=".count",fC="id",TC="install_log.log",mC="run_log.log",RC="PROCESS_NAME",AC={SETTINGS_PATH_KEY:"settings_path"},jd=require("lodash"),OC={TC_AGREEMENT:"TC_AGREEMENT",CLUSTERING_USER:"CLUSTERING_USER",CLUSTERING_PASSWORD:"CLUSTERING_PASSWORD",HDB_ADMIN_USERNAME:"HDB_ADMIN_USERNAME",HDB_ADMIN_PASSWORD:"HDB_ADMIN_PASSWORD",OPERATIONSAPI_ROOT:"OPERATIONSAPI_ROOT",ROOTPATH:"ROOTPATH",OPERATIONSAPI_NETWORK_PORT:"OPERATIONSAPI_NETWORK_PORT",CLUSTERING_NODENAME:"CLUSTERING_NODENAME",CLUSTERING_ENABLED:"CLUSTERING_ENABLED",CLUSTERING_PORT:"CLUSTERING_PORT",HDB_ROOT:"HDB_ROOT",SERVER_PORT:"SERVER_PORT",NODE_NAME:"NODE_NAME",CLUSTERING:"CLUSTERING"},pC={HDB_PATH_KEY:"HDB_INTERNAL_PATH",HDB_AUTH_HEADER:"hdb_auth_header",HDB_USER_DATA_KEY:"hdb_user",CHUNK_SIZE:1e3,MAX_CHARACTER_SIZE:250},NC={DATA_VERSION:"data_version",UPGRADE_VERSION:"upgrade_version"},gC={JOB_TABLE_NAME:"hdb_job",NODE_TABLE_NAME:"hdb_nodes",ATTRIBUTE_TABLE_NAME:"hdb_attribute",LICENSE_TABLE_NAME:"hdb_license",ROLE_TABLE_NAME:"hdb_role",SCHEMA_TABLE_NAME:"hdb_schema",TABLE_TABLE_NAME:"hdb_table",USER_TABLE_NAME:"hdb_user",INFO_TABLE_NAME:"hdb_info"},IC={JOB_TABLE_HASH_ATTRIBUTE:"id",NODE_TABLE_HASH_ATTRIBUTE:"name",ATTRIBUTE_TABLE_HASH_ATTRIBUTE:"id",LICENSE_TABLE_HASH_ATTRIBUTE:"license_key",ROLE_TABLE_HASH_ATTRIBUTE:"id",SCHEMA_TABLE_HASH_ATTRIBUTE:"name",TABLE_TABLE_HASH_ATTRIBUTE:"id",USER_TABLE_HASH_ATTRIBUTE:"username",INFO_TABLE_ATTRIBUTE:"info_id"},ht="hdb_internal:",bC={CREATE_SCHEMA:ht+"create_schema",CREATE_TABLE:ht+"create_table",CREATE_ATTRIBUTE:ht+"create_attribute",ADD_USER:ht+"add_user",ALTER_USER:ht+"alter_user",DROP_USER:ht+"drop_user",HDB_NODES:ht+"hdb_nodes",HDB_USERS:ht+"hdb_users",HDB_WORKERS:ht+"hdb_workers",CATCHUP:ht+"catchup",SCHEMA_CATCHUP:ht+"schema_catchup",WORKER_ROOM:ht+"cluster_workers"},CC={ATTR_ATTRIBUTE_KEY:"attribute",ATTR_CREATEDDATE_KEY:"createddate",ATTR_HASH_ATTRIBUTE_KEY:"hash_attribute",ATTR_ID_KEY:"id",ATTR_NAME_KEY:"name",ATTR_PASSWORD_KEY:"password",ATTR_RESIDENCE_KEY:"residence",ATTR_ROLE_KEY:"role",ATTR_SCHEMA_KEY:"schema",ATTR_SCHEMA_TABLE_KEY:"schema_table",ATTR_TABLE_KEY:"table",ATTR_USERNAME_KEY:"username"},wC="060493.ks",LC=".license",UC={CREATED:"CREATED",IN_PROGRESS:"IN_PROGRESS",COMPLETE:"COMPLETE",ERROR:"ERROR"},g={INSERT:"insert",UPDATE:"update",UPSERT:"upsert",SEARCH_BY_CONDITIONS:"search_by_conditions",SEARCH_BY_HASH:"search_by_hash",SEARCH_BY_VALUE:"search_by_value",SEARCH:"search",SQL:"sql",CSV_DATA_LOAD:"csv_data_load",CSV_FILE_LOAD:"csv_file_load",CSV_URL_LOAD:"csv_url_load",CREATE_SCHEMA:"create_schema",CREATE_TABLE:"create_table",CREATE_ATTRIBUTE:"create_attribute",DROP_SCHEMA:"drop_schema",DROP_TABLE:"drop_table",DESCRIBE_SCHEMA:"describe_schema",DESCRIBE_TABLE:"describe_table",DESCRIBE_ALL:"describe_all",DELETE:"delete",ADD_USER:"add_user",ALTER_USER:"alter_user",DROP_USER:"drop_user",LIST_USERS:"list_users",LIST_ROLES:"list_roles",ADD_ROLE:"add_role",ALTER_ROLE:"alter_role",DROP_ROLE:"drop_role",USER_INFO:"user_info",READ_LOG:"read_log",ADD_NODE:"add_node",UPDATE_NODE:"update_node",EXPORT_TO_S3:"export_to_s3",IMPORT_FROM_S3:"import_from_s3",DELETE_FILES_BEFORE:"delete_files_before",DELETE_RECORDS_BEFORE:"delete_records_before",EXPORT_LOCAL:"export_local",SEARCH_JOBS_BY_START_DATE:"search_jobs_by_start_date",GET_JOB:"get_job",DELETE_JOB:"delete_job",UPDATE_JOB:"update_job",GET_FINGERPRINT:"get_fingerprint",SET_LICENSE:"set_license",GET_REGISTRATION_INFO:"registration_info",CONFIGURE_CLUSTER:"configure_cluster",SET_CONFIGURATION:"set_configuration",CLUSTER_STATUS:"cluster_status",DROP_ATTRIBUTE:"drop_attribute",REMOVE_NODE:"remove_node",RESTART:"restart",RESTART_SERVICE:"restart_service",CATCHUP:"catchup",SYSTEM_INFORMATION:"system_information",DELETE_AUDIT_LOGS_BEFORE:"delete_audit_logs_before",READ_AUDIT_LOG:"read_audit_log",CREATE_AUTHENTICATION_TOKENS:"create_authentication_tokens",REFRESH_OPERATION_TOKEN:"refresh_operation_token",GET_CONFIGURATION:"get_configuration",CUSTOM_FUNCTIONS_STATUS:"custom_functions_status",GET_CUSTOM_FUNCTIONS:"get_custom_functions",GET_CUSTOM_FUNCTION:"get_custom_function",SET_CUSTOM_FUNCTION:"set_custom_function",DROP_CUSTOM_FUNCTION:"drop_custom_function",ADD_CUSTOM_FUNCTION_PROJECT:"add_custom_function_project",DROP_CUSTOM_FUNCTION_PROJECT:"drop_custom_function_project",PACKAGE_CUSTOM_FUNCTION_PROJECT:"package_custom_function_project",DEPLOY_CUSTOM_FUNCTION_PROJECT:"deploy_custom_function_project",CLUSTER_SET_ROUTES:"cluster_set_routes",CLUSTER_DELETE_ROUTES:"cluster_delete_routes",CLUSTER_GET_ROUTES:"cluster_get_routes",READ_TRANSACTION_LOG:"read_transaction_log",DELETE_TRANSACTION_LOGS_BEFORE:"delete_transaction_logs_before",INSTALL_NODE_MODULES:"install_node_modules",AUDIT_NODE_MODULES:"audit_node_modules"},yC={CSV:".csv",JSON:".json"},DC={AWS_ACCESS_KEY:"aws_access_key_id",AWS_SECRET:"aws_secret_access_key",AWS_BUCKET:"bucket",AWS_FILE_KEY:"key"},MC={SELECT:"select",INSERT:"insert",UPDATE:"update",DELETE:"delete"},Dr={};Dr[g.CREATE_SCHEMA]=g.CREATE_SCHEMA;Dr[g.CREATE_TABLE]=g.CREATE_TABLE;Dr[g.CREATE_ATTRIBUTE]=g.CREATE_ATTRIBUTE;Dr[g.INSERT]=g.INSERT;Dr[g.UPDATE]=g.UPDATE;Dr[g.UPSERT]=g.UPSERT;Dr[g.DELETE]=g.DELETE;var J=Object.create(null);J[g.DESCRIBE_ALL]=g.DESCRIBE_ALL;J[g.DESCRIBE_TABLE]=g.DESCRIBE_TABLE;J[g.DESCRIBE_SCHEMA]=g.DESCRIBE_SCHEMA;J[g.READ_LOG]=g.READ_LOG;J[g.ADD_NODE]=g.ADD_NODE;J[g.LIST_USERS]=g.LIST_USERS;J[g.LIST_ROLES]=g.LIST_ROLES;J[g.USER_INFO]=g.USER_INFO;J[g.SQL]=g.SQL;J[g.GET_JOB]=g.GET_JOB;J[g.SEARCH_JOBS_BY_START_DATE]=g.SEARCH_JOBS_BY_START_DATE;J[g.DELETE_FILES_BEFORE]=g.DELETE_FILES_BEFORE;J[g.EXPORT_LOCAL]=g.EXPORT_LOCAL;J[g.EXPORT_TO_S3]=g.EXPORT_TO_S3;J[g.CLUSTER_STATUS]=g.CLUSTER_STATUS;J[g.REMOVE_NODE]=g.REMOVE_NODE;J[g.RESTART]=g.RESTART;J[g.CUSTOM_FUNCTIONS_STATUS]=g.CUSTOM_FUNCTIONS_STATUS;J[g.GET_CUSTOM_FUNCTIONS]=g.GET_CUSTOM_FUNCTIONS;J[g.GET_CUSTOM_FUNCTION]=g.GET_CUSTOM_FUNCTION;J[g.SET_CUSTOM_FUNCTION]=g.SET_CUSTOM_FUNCTION;J[g.DROP_CUSTOM_FUNCTION]=g.DROP_CUSTOM_FUNCTION;J[g.ADD_CUSTOM_FUNCTION_PROJECT]=g.ADD_CUSTOM_FUNCTION_PROJECT;J[g.DROP_CUSTOM_FUNCTION_PROJECT]=g.DROP_CUSTOM_FUNCTION_PROJECT;J[g.PACKAGE_CUSTOM_FUNCTION_PROJECT]=g.PACKAGE_CUSTOM_FUNCTION_PROJECT;J[g.DEPLOY_CUSTOM_FUNCTION_PROJECT]=g.DEPLOY_CUSTOM_FUNCTION_PROJECT;var PC={RUN:"run",INSTALL:"install",REGISTER:"register",STOP:"stop",RESTART:"restart",VERSION:"version",UPGRADE:"upgrade"},BC={point:"point",lineString:"lineString",multiLineString:"multiLineString",multiPoint:"multiPoint",multiPolygon:"multiPolygon",polygon:"polygon"},eh={HDB_ROOT_KEY:"HDB_ROOT",SERVER_PORT_KEY:"SERVER_PORT",CERT_KEY:"CERTIFICATE",PRIVATE_KEY_KEY:"PRIVATE_KEY",HTTP_SECURE_ENABLED_KEY:"HTTPS_ON",CORS_ENABLED_KEY:"CORS_ON",CORS_WHITELIST_KEY:"CORS_WHITELIST",LOG_LEVEL_KEY:"LOG_LEVEL",LOGGER_KEY:"LOGGER",LOG_PATH_KEY:"LOG_PATH",LOG_ROTATE:"LOG_ROTATE",LOG_ROTATE_MAX_SIZE:"LOG_ROTATE_MAX_SIZE",LOG_ROTATE_RETAIN:"LOG_ROTATE_RETAIN",LOG_ROTATE_COMPRESS:"LOG_ROTATE_COMPRESS",LOG_ROTATE_DATE_FORMAT:"LOG_ROTATE_DATE_FORMAT",LOG_ROTATE_ROTATE_MODULE:"LOG_ROTATE_ROTATE_MODULE",LOG_ROTATE_WORKER_INTERVAL:"LOG_ROTATE_WORKER_INTERVAL",LOG_ROTATE_ROTATE_INTERVAL:"LOG_ROTATE_ROTATE_INTERVAL",LOG_ROTATE_TIMEZONE:"LOG_ROTATE_TIMEZONE",LOG_DAILY_ROTATE_KEY:"LOG_DAILY_ROTATE",LOG_MAX_DAILY_FILES_KEY:"LOG_MAX_DAILY_FILES",PROPS_ENV_KEY:"NODE_ENV",SETTINGS_PATH_KEY:"settings_path",CLUSTERING_PORT_KEY:"CLUSTERING_PORT",CLUSTERING_NODE_NAME_KEY:"NODE_NAME",CLUSTERING_ENABLED_KEY:"CLUSTERING",ALLOW_SELF_SIGNED_SSL_CERTS:"ALLOW_SELF_SIGNED_SSL_CERTS",MAX_HDB_PROCESSES:"MAX_HDB_PROCESSES",INSTALL_USER:"install_user",CLUSTERING_USER_KEY:"CLUSTERING_USER",MAX_CLUSTERING_PROCESSES:"MAX_CLUSTERING_PROCESSES",SERVER_TIMEOUT_KEY:"SERVER_TIMEOUT_MS",SERVER_KEEP_ALIVE_TIMEOUT_KEY:"SERVER_KEEP_ALIVE_TIMEOUT",SERVER_HEADERS_TIMEOUT_KEY:"SERVER_HEADERS_TIMEOUT",DISABLE_TRANSACTION_LOG_KEY:"DISABLE_TRANSACTION_LOG",OPERATION_TOKEN_TIMEOUT_KEY:"OPERATION_TOKEN_TIMEOUT",REFRESH_TOKEN_TIMEOUT_KEY:"REFRESH_TOKEN_TIMEOUT",IPC_SERVER_PORT:"IPC_SERVER_PORT",CUSTOM_FUNCTIONS_ENABLED_KEY:"CUSTOM_FUNCTIONS",CUSTOM_FUNCTIONS_PORT_KEY:"CUSTOM_FUNCTIONS_PORT",CUSTOM_FUNCTIONS_DIRECTORY_KEY:"CUSTOM_FUNCTIONS_DIRECTORY",MAX_CUSTOM_FUNCTION_PROCESSES:"MAX_CUSTOM_FUNCTION_PROCESSES",LOG_TO_FILE:"LOG_TO_FILE",LOG_TO_STDSTREAMS:"LOG_TO_STDSTREAMS",RUN_IN_FOREGROUND:"RUN_IN_FOREGROUND",LOCAL_STUDIO_ON:"LOCAL_STUDIO_ON",STORAGE_WRITE_ASYNC:"STORAGE_WRITE_ASYNC"},vC=jd.invert(eh),f={CLUSTERING_USER:"clustering_user",CLUSTERING_ENABLED:"clustering_enabled",CLUSTERING_HUBSERVER_CLUSTER_NAME:"clustering_hubServer_cluster_name",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT:"clustering_hubServer_cluster_network_port",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES:"clustering_hubServer_cluster_network_routes",CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT:"clustering_hubServer_leafNodes_network_port",CLUSTERING_HUBSERVER_NETWORK_PORT:"clustering_hubServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_PORT:"clustering_leafServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_ROUTES:"clustering_leafServer_network_routes",CLUSTERING_NODENAME:"clustering_nodeName",CLUSTERING_TLS_CERTIFICATE:"clustering_tls_certificate",CLUSTERING_TLS_PRIVATEKEY:"clustering_tls_privateKey",CLUSTERING_TLS_CERT_AUTH:"clustering_tls_certificateAuthority",CLUSTERING_TLS_INSECURE:"clustering_tls_insecure",CUSTOMFUNCTIONS_ENABLED:"customFunctions_enabled",CUSTOMFUNCTIONS_NETWORK_PORT:"customFunctions_network_port",CUSTOMFUNCTIONS_TLS_CERTIFICATE:"customFunctions_tls_certificate",CUSTOMFUNCTIONS_NETWORK_CORS:"customFunctions_network_cors",CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST:"customFunctions_network_corsAccessList",CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT:"customFunctions_network_headersTimeout",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT:"customFunctions_network_keepAliveTimeout",CUSTOMFUNCTIONS_TLS_PRIVATEKEY:"customFunctions_tls_privateKey",CUSTOMFUNCTIONS_TLS_CERT_AUTH:"customFunctions_tls_certificateAuthority",CUSTOMFUNCTIONS_NETWORK_TIMEOUT:"customFunctions_network_timeout",CUSTOMFUNCTIONS_NODEENV:"customFunctions_nodeEnv",CUSTOMFUNCTIONS_ROOT:"customFunctions_root",HTTP_THREADS:"http_threads",IPC_NETWORK_PORT:"ipc_network_port",LOCALSTUDIO_ENABLED:"localStudio_enabled",LOGGING_FILE:"logging_file",LOGGING_LEVEL:"logging_level",LOGGING_ROOT:"logging_root",LOGGING_ROTATION_COMPRESS:"logging_rotation_compress",LOGGING_ROTATION_DATEFORMAT:"logging_rotation_dateFormat",LOGGING_ROTATION_MAXSIZE:"logging_rotation_maxSize",LOGGING_ROTATION_RETAIN:"logging_rotation_retain",LOGGING_ROTATION_ROTATE:"logging_rotation_rotate",LOGGING_ROTATION_ROTATEINTERVAL:"logging_rotation_rotateInterval",LOGGING_ROTATION_ROTATEMODULE:"logging_rotation_rotateModule",LOGGING_ROTATION_TIMEZONE:"logging_rotation_timezone",LOGGING_ROTATION_WORKERINTERVAL:"logging_rotation_workerInterval",LOGGING_STDSTREAMS:"logging_stdStreams",LOGGING_AUDITLOG:"logging_auditLog",OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT:"operationsApi_authentication_operationTokenTimeout",OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT:"operationsApi_authentication_refreshTokenTimeout",OPERATIONSAPI_FOREGROUND:"operationsApi_foreground",OPERATIONSAPI_TLS_CERTIFICATE:"operationsApi_tls_certificate",OPERATIONSAPI_NETWORK_CORS:"operationsApi_network_cors",OPERATIONSAPI_NETWORK_CORSACCESSLIST:"operationsApi_network_corsAccessList",OPERATIONSAPI_NETWORK_HEADERSTIMEOUT:"operationsApi_network_headersTimeout",OPERATIONSAPI_NETWORK_HTTPS:"operationsApi_network_https",OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT:"operationsApi_network_keepAliveTimeout",OPERATIONSAPI_NETWORK_PORT:"operationsApi_network_port",OPERATIONSAPI_TLS_PRIVATEKEY:"operationsApi_tls_privateKey",OPERATIONSAPI_TLS_CERT_AUTH:"operationsApi_tls_certificateAuthority",OPERATIONSAPI_NETWORK_TIMEOUT:"operationsApi_network_timeout",OPERATIONSAPI_NODEENV:"operationsApi_nodeEnv",ROOTPATH:"rootPath",STORAGE_WRITEASYNC:"storage_writeAsync",STORAGE_OVERLAPPINGSYNC:"storage_overlappingSync"},HC={hdb_root_key:f.ROOTPATH,hdb_root:f.ROOTPATH,server_port_key:f.OPERATIONSAPI_NETWORK_PORT,server_port:f.OPERATIONSAPI_NETWORK_PORT,cert_key:f.OPERATIONSAPI_TLS_CERTIFICATE,certificate:f.OPERATIONSAPI_TLS_CERTIFICATE,private_key_key:f.OPERATIONSAPI_TLS_PRIVATEKEY,private_key:f.OPERATIONSAPI_TLS_PRIVATEKEY,http_secure_enabled_key:f.OPERATIONSAPI_NETWORK_HTTPS,https_on:f.OPERATIONSAPI_NETWORK_HTTPS,cors_enabled_key:f.OPERATIONSAPI_NETWORK_CORS,cors_on:f.OPERATIONSAPI_NETWORK_CORS,cors_whitelist_key:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_whitelist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist_key:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,log_level_key:f.LOGGING_LEVEL,log_level:f.LOGGING_LEVEL,log_path_key:f.LOGGING_ROOT,log_path:f.LOGGING_ROOT,log_daily_rotate:f.LOGGING_ROTATION_ROTATE,log_rotate:f.LOGGING_ROTATION_ROTATE,log_rotate_max_size:f.LOGGING_ROTATION_MAXSIZE,log_rotate_retain:f.LOGGING_ROTATION_RETAIN,log_rotate_compress:f.LOGGING_ROTATION_COMPRESS,log_rotate_date_format:f.LOGGING_ROTATION_DATEFORMAT,log_rotate_rotate_module:f.LOGGING_ROTATION_ROTATEMODULE,log_rotate_worker_interval:f.LOGGING_ROTATION_WORKERINTERVAL,log_rotate_rotate_interval:f.LOGGING_ROTATION_ROTATEINTERVAL,log_rotate_timezone:f.LOGGING_ROTATION_TIMEZONE,props_env_key:f.OPERATIONSAPI_NODEENV,node_env:f.OPERATIONSAPI_NODEENV,clustering_node_name_key:f.CLUSTERING_NODENAME,node_name:f.CLUSTERING_NODENAME,clustering_enabled_key:f.CLUSTERING_ENABLED,clustering:f.CLUSTERING_ENABLED,max_http_threads:f.HTTP_THREADS,max_hdb_processes:f.HTTP_THREADS,server_timeout_key:f.OPERATIONSAPI_NETWORK_TIMEOUT,server_timeout_ms:f.OPERATIONSAPI_NETWORK_TIMEOUT,server_keep_alive_timeout_key:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_keep_alive_timeout:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_headers_timeout_key:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,server_headers_timeout:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,disable_transaction_log_key:f.LOGGING_AUDITLOG,disable_transaction_log:f.LOGGING_AUDITLOG,operation_token_timeout_key:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,operation_token_timeout:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,refresh_token_timeout_key:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,refresh_token_timeout:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,ipc_server_port:f.IPC_NETWORK_PORT,custom_functions_enabled_key:f.CUSTOMFUNCTIONS_ENABLED,custom_functions:f.CUSTOMFUNCTIONS_ENABLED,custom_functions_port_key:f.CUSTOMFUNCTIONS_NETWORK_PORT,custom_functions_port:f.CUSTOMFUNCTIONS_NETWORK_PORT,custom_functions_directory_key:f.CUSTOMFUNCTIONS_ROOT,custom_functions_directory:f.CUSTOMFUNCTIONS_ROOT,max_custom_function_processes:f.HTTP_THREADS,log_to_file:f.LOGGING_FILE,log_to_stdstreams:f.LOGGING_STDSTREAMS,run_in_foreground:f.OPERATIONSAPI_FOREGROUND,local_studio_on:f.LOCALSTUDIO_ENABLED,clustering_port:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_user:f.CLUSTERING_USER,clustering_enabled:f.CLUSTERING_ENABLED,clustering_hubserver_cluster_name:f.CLUSTERING_HUBSERVER_CLUSTER_NAME,clustering_hubserver_cluster_network_port:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_hubserver_cluster_network_routes:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,clustering_hubserver_leafnodes_network_port:f.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT,clustering_hubserver_network_port:f.CLUSTERING_HUBSERVER_NETWORK_PORT,clustering_leafserver_network_port:f.CLUSTERING_LEAFSERVER_NETWORK_PORT,clustering_leafserver_network_routes:f.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,clustering_nodename:f.CLUSTERING_NODENAME,clustering_tls_certificate:f.CLUSTERING_TLS_CERTIFICATE,clustering_tls_privatekey:f.CLUSTERING_TLS_PRIVATEKEY,clustering_tls_certificateauthority:f.CLUSTERING_TLS_CERT_AUTH,clustering_tls_insecure:f.CLUSTERING_TLS_INSECURE,customfunctions_enabled:f.CUSTOMFUNCTIONS_ENABLED,customfunctions_network_port:f.CUSTOMFUNCTIONS_NETWORK_PORT,customfunctions_tls_certificate:f.CUSTOMFUNCTIONS_TLS_CERTIFICATE,customfunctions_network_cors:f.CUSTOMFUNCTIONS_NETWORK_CORS,customfunctions_network_corsaccesslist:f.CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST,customfunctions_network_headerstimeout:f.CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT,customfunctions_network_https:f.CUSTOMFUNCTIONS_NETWORK_HTTPS,customfunctions_network_keepalivetimeout:f.CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT,customfunctions_tls_privatekey:f.CUSTOMFUNCTIONS_TLS_PRIVATEKEY,customfunctions_tls_certificateauthority:f.CUSTOMFUNCTIONS_TLS_CERT_AUTH,customfunctions_network_timeout:f.CUSTOMFUNCTIONS_NETWORK_TIMEOUT,customfunctions_nodeenv:f.CUSTOMFUNCTIONS_NODEENV,http_threads:f.HTTP_THREADS,customfunctions_processes:f.HTTP_THREADS,customfunctions_root:f.CUSTOMFUNCTIONS_ROOT,ipc_network_port:f.IPC_NETWORK_PORT,localstudio_enabled:f.LOCALSTUDIO_ENABLED,logging_file:f.LOGGING_FILE,logging_level:f.LOGGING_LEVEL,logging_root:f.LOGGING_ROOT,logging_rotation_compress:f.LOGGING_ROTATION_COMPRESS,logging_rotation_dateformat:f.LOGGING_ROTATION_DATEFORMAT,logging_rotation_maxsize:f.LOGGING_ROTATION_MAXSIZE,logging_rotation_retain:f.LOGGING_ROTATION_RETAIN,logging_rotation_rotate:f.LOGGING_ROTATION_ROTATE,logging_rotation_rotateinterval:f.LOGGING_ROTATION_ROTATEINTERVAL,logging_rotation_rotatemodule:f.LOGGING_ROTATION_ROTATEMODULE,logging_rotation_timezone:f.LOGGING_ROTATION_TIMEZONE,logging_rotation_workerinterval:f.LOGGING_ROTATION_WORKERINTERVAL,logging_stdstreams:f.LOGGING_STDSTREAMS,logging_auditlog:f.LOGGING_AUDITLOG,operationsapi_authentication_operationtokentimeout:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,operationsapi_authentication_refreshtokentimeout:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,operationsapi_foreground:f.OPERATIONSAPI_FOREGROUND,operationsapi_tls_certificate:f.OPERATIONSAPI_TLS_CERTIFICATE,operationsapi_network_cors:f.OPERATIONSAPI_NETWORK_CORS,operationsapi_network_corsaccesslist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,operationsapi_network_headerstimeout:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,operationsapi_network_https:f.OPERATIONSAPI_NETWORK_HTTPS,operationsapi_network_keepalivetimeout:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,operationsapi_network_port:f.OPERATIONSAPI_NETWORK_PORT,operationsapi_tls_privatekey:f.OPERATIONSAPI_TLS_PRIVATEKEY,operationsapi_network_timeout:f.OPERATIONSAPI_NETWORK_TIMEOUT,operationsapi_nodeenv:f.OPERATIONSAPI_NODEENV,operationsapi_root:f.ROOTPATH,rootpath:f.ROOTPATH,storage_writeasync:f.STORAGE_WRITEASYNC,storage_overlappingsync:f.STORAGE_OVERLAPPINGSYNC},GC={csv_file_load:"csv_file_load",csv_data_load:g.CSV_DATA_LOAD,csv_url_load:g.CSV_URL_LOAD,delete_files_before:"delete_files_before",delete_records_before:"delete_records_before",delete_audit_logs_before:"delete_audit_logs_before",delete_transaction_logs_before:"delete_transaction_logs_before",empty_trash:"empty_trash",export_local:"export_local",export_to_s3:"export_to_s3",import_from_s3:"import_from_s3"},qC={CLUSTERING_PAYLOAD:"clustering_payload",DELEGATE_THREAD_RESPONSE:"delegate_thread_response",CLUSTERING:"clustering",SCHEMA:"schema",CLUSTER_STATUS:"cluster_status",JOB:"job",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",USER:"user",RESTART:"restart"},FC={BIDIRECTIONAL:"BIDIRECTIONAL",OUTBOUND:"OUTBOUND",INBOUND:"INBOUND"},VC={FILE_SYSTEM:"fs",LMDB:"lmdb"},kC={API_CALL_DEFAULT:1e4,VERSION_DEFAULT:"2.2.0"},xC={DEVELOPMENT:8192,DEFAULT:512},$C={IDENTIFY:"identify",AUTHENTICATE:"authenticate",AUTHENTICATE_OK:"authenticated",AUTHENTICATE_FAIL:"authenticate_fail",CONNECTION:"connection",CONNECT:"connect",CATCHUP_REQUEST:"catchup_request",CATCHUP_RESPONSE:"catchup",CONFIRM_MSG:"confirm_msg",ERROR:"error",DISCONNECT:"disconnect",SCHEMA_UPDATE_REQ:"schema_update_request",SCHEMA_UPDATE_RES:"schema_update_response",RECONNECT_ATTEMPT:"reconnect_attempt",CONNECT_ERROR:"connect_error",MESSAGE:"msg",VERSION_MISMATCH:"version_mismatch",DIRECTION_CHANGE:"direction_change"},YC={1e3:"SUCCESSFUL_SHUTDOWN",1001:"CLOSE_GOING_AWAY",1002:"CLOSE_PROTOCOL_ERROR",1003:"CLOSE_UNSUPPORTED",1005:"CLOSE_NO_STATUS",1006:"CLOSE_ABNORMAL",1007:"UNSUPPORTED_PAYLOAD",1008:"POLICY_VIOLATION",1009:"CLOSE_TOO_LARGE",1010:"MANDATORY_EXTENSION",1011:"SERVER_ERROR",1012:"SERVICE_RESTART",1013:"SERVER_BUSY",1014:"BAD_GATEWAY",1015:"HANDSHAKE_FAIL",4141:"LICENSE_LIMIT_REACHED"},KC={ENOENT:"ENOENT",EACCES:"EACCES"},th={CREATED_TIME:"__createdtime__",UPDATED_TIME:"__updatedtime__"},QC="__clustering__",WC=Object.values(th),JC=15984864e5,rh={LESS:"<",LESS_OR_EQ:"<=",GREATER:">",GREATER_OR_EQ:">=",BETWEEN:"..."},ZC=jd.invert(rh),XC={GET_CLUSTER_STATUS:"GET_CLUSTER_STATUS",CLUSTER_STATUS_RESPONSE:"CLUSTER_STATUS_RESPONSE",ERROR_RESPONSE:"ERROR",ADD_USER:"ADD_USER",ALTER_USER:"ALTER_USER",DROP_USER:"DROP_USER",HDB_OPERATION:"HDB_OPERATION",ADD_NODE:"ADD_NODE",UPDATE_NODE:"UPDATE_NODE",REMOVE_NODE:"REMOVE_NODE",HDB_USERS_MSG:"HDB_USERS_MSG",HDB_WORKERS:"HDB_WORKERS",HDB_TRANSACTION:"HDB_TRANSACTION"},zC=111,jC=`\r
`,ew={READ:"read",INSERT:"insert",UPDATE:"update",DELETE:"delete"},tw=["*","%"],rw="unauthorized_access",sw="func_val",nw={HASH_VALUE:"hash_value",TIMESTAMP:"timestamp",USERNAME:"username"},iw={JWT_PRIVATE_KEY_NAME:".jwtPrivate.key",JWT_PUBLIC_KEY_NAME:".jwtPublic.key",JWT_PASSPHRASE_NAME:".jwtPass"},aw="hdb_ipc_server",ow="hdb_ipc_client_",cw={RESTART:"restart",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",SCHEMA:"schema",USER:"user",CLUSTER_STATUS_RESPONSE:"cluster_status_response",CLUSTER_STATUS_REQUEST:"cluster_status_request"},_w={HDB_CORE:"hdb_core",CUSTOM_FUNCTIONS:"custom_functions"},uw={STOPPED:"stopped",ONLINE:"online"},lw="3.x.x";sh.exports={LOCAL_HARPERDB_OPERATIONS:J,HDB_SUPPORT_ADDRESS:Jd,HDB_SUPPORT_URL:Xd,HDB_PRICING_URL:Pb,SUPPORT_HELP_MSG:Bb,LICENSE_HELP_MSG:zd,HDB_PROC_NAME:Kd,HDB_PROC_DESCRIPTOR:z_,CLUSTERING_LEAF_PROC_DESCRIPTOR:Sa,CLUSTERING_HUB_PROC_DESCRIPTOR:ha,SYSTEM_SCHEMA_NAME:eC,HASH_FOLDER_NAME:tC,HDB_HOME_DIR_NAME:rC,UPDATE_FILE_NAME:aC,LICENSE_KEY_DIR_NAME:nC,BOOT_PROPS_FILE_NAME:iC,JOB_TYPE_ENUM:GC,JOB_STATUS_ENUM:UC,SYSTEM_TABLE_NAMES:gC,SYSTEM_TABLE_HASH_ATTRIBUTES:IC,OPERATIONS_ENUM:g,VALID_S3_FILE_TYPES:yC,S3_BUCKET_AUTH_KEYS:DC,VALID_SQL_OPS_ENUM:MC,GEO_CONVERSION_ENUM:BC,HDB_SETTINGS_NAMES:eh,HDB_SETTINGS_NAMES_REVERSE_LOOKUP:vC,SERVICE_ACTIONS_ENUM:PC,CLUSTER_MESSAGE_TYPE_ENUM:qC,CLUSTER_CONNECTION_DIRECTION_ENUM:FC,CLUSTER_EVENTS_DEFS_ENUM:$C,PERIOD_REGEX:kb,DOUBLE_PERIOD_REGEX:xb,UNICODE_PERIOD:$b,FORWARD_SLASH_REGEX:Yb,UNICODE_FORWARD_SLASH:Kb,ESCAPED_FORWARD_SLASH_REGEX:Qb,ESCAPED_PERIOD_REGEX:Wb,ESCAPED_DOUBLE_PERIOD_REGEX:Jb,REG_KEY_FILE_NAME:wC,RESTART_TIMEOUT_MS:_C,HDB_FILE_PERMISSIONS:uC,SCHEMA_DIR_NAME:dC,TRANSACTIONS_DIR_NAME:hC,LIMIT_COUNT_NAME:SC,ID_ATTRIBUTE_STRING:fC,INSERT_MODULE_ENUM:pC,UPGRADE_JSON_FIELD_NAMES_ENUM:NC,RESTART_CODE:oC,RESTART_CODE_NUM:cC,CLUSTER_OPERATIONS:Dr,SYSTEM_DEFAULT_ATTRIBUTE_NAMES:CC,HDB_INTERNAL_SC_CHANNEL_PREFIX:ht,INTERNAL_SC_CHANNELS:bC,CLUSTERING_MESSAGE_TYPES:XC,HDB_FILE_SUFFIX:sC,BLOB_FOLDER_NAME:lC,HDB_TRASH_DIR:EC,ORIGINATOR_SET_VALUE:zC,LICENSE_VALUES:kC,RAM_ALLOCATION_ENUM:xC,STORAGE_TYPES_ENUM:VC,TIME_STAMP_NAMES_ENUM:th,TIME_STAMP_NAMES:WC,PERMS_UPDATE_RELEASE_TIMESTAMP:JC,SEARCH_NOT_FOUND_MESSAGE:vb,SEARCH_ATTRIBUTE_NOT_FOUND:Hb,LICENSE_ROLE_DENIED_RESPONSE:Gb,LICENSE_MAX_CONNS_REACHED:qb,BASIC_LICENSE_MAX_NON_CU_ROLES:Zd,BASIC_LICENSE_CLUSTER_CONNECTION_LIMIT_WS_ERROR_CODE:Mb,VALUE_SEARCH_COMPARATORS:rh,VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP:ZC,LICENSE_FILE_NAME:LC,WEBSOCKET_CLOSE_CODE_DESCRIPTION_LOOKUP:YC,NEW_LINE:jC,BASIC_LICENSE_MAX_CLUSTER_USER_ROLES:Vb,MOMENT_DAYS_TAG:Zb,API_TURNOVER_SEC:Xb,LOOPBACK:Fb,CODE_EXTENSION:xn,WILDCARD_SEARCH_VALUE:zb,NODE_ERROR_CODES:KC,JAVASCRIPT_EXTENSION:Yd,PERMS_CRUD_ENUM:ew,UNAUTHORIZED_PERMISSION_NAME:rw,SEARCH_WILDCARDS:tw,FUNC_VAL:sw,READ_AUDIT_LOG_SEARCH_TYPES_ENUM:nw,JWT_ENUM:iw,CLUSTERING_FLAG:QC,RUN_LOG:mC,INSTALL_LOG:TC,IPC_SERVER_MODULE:Wd,HDB_IPC_SERVER:aw,IPC_EVENT_TYPES:cw,HDB_IPC_CLIENT_PREFIX:ow,CUSTOM_FUNCTION_PROC_NAME:Qd,CUSTOM_FUNCTION_PROC_DESCRIPTOR:da,SERVICES:_w,MEM_SETTING_KEY:jb,HDB_RESTART_SCRIPT:Nb,PROCESS_DESCRIPTORS:X_,SERVICE_SERVERS:Lb,SERVICE_SERVERS_CWD:Ea,PROCESS_DESCRIPTORS_VALIDATE:Cb,LAUNCH_SERVICE_SCRIPTS:Ub,LOG_LEVELS:bb,PROCESS_NAME_ENV_PROP:RC,PROCESS_LOG_NAMES:Ib,PM2_PROCESS_STATUSES:uw,CONFIG_PARAM_MAP:HC,CONFIG_PARAMS:f,HDB_CONFIG_FILE:Ab,HDB_DEFAULT_CONFIG_FILE:Ob,ROLE_TYPES_ENUM:yb,BOOT_PROP_PARAMS:AC,INSTALL_PROMPTS:OC,HDB_ROOT_DIR_NAME:pb,CLUSTERING_PROCESSES:wb,FOREGROUND_PID_FILE:gb,PACKAGE_ROOT:Gt,PRE_4_0_0_VERSION:lw}});var tu=S((B1,ah)=>{"use strict";var nh=require("minimist");ah.exports=Ew;function Ew(e=[],t=!1){if(!Array.isArray(e))return{};let r,s;t?(r=ih(process.env),s=ih(nh(process.argv))):(r=process.env,s=nh(process.argv));let n={};for(let i=0,o=e.length;i<o;i++){let c=e[i];s[c]!==void 0?n[c]=s[c].toString().trim():r[c]!==void 0&&(n[c]=r[c].toString().trim())}return n}a(Ew,"assignCMDENVVariables");function ih(e){let t,r=Object.keys(e),s=r.length,n={};for(;s--;)t=r[s],n[t.toLowerCase()]=e[t];return n}a(ih,"objKeysToLowerCase")});var I=S((v1,dh)=>{"use strict";var as=require("fs-extra"),os=require("path"),ch=require("yaml"),_h=require("properties-reader"),Re=T(),dw=tu(),hw=require("os"),{PACKAGE_ROOT:nu}=T(),st={notify:7,fatal:6,error:5,warn:4,info:3,debug:2,trace:1},fa=os.join(nu,"logs"),Mr=process.env.pm_id===void 0,Sw=os.join(nu,"config/yaml/",Re.HDB_DEFAULT_CONFIG_FILE),iu=process.env.PROCESS_NAME===void 0?Re.PROCESS_DESCRIPTORS.INSTALL:process.env.PROCESS_NAME,Ys,Zt,lr,rt,ru,Ks;Ks===void 0&&uh();dh.exports={createLogFile:fw,notify:Rw,fatal:Aw,error:su,warn:Ow,info:Tw,debug:mw,trace:Eh,setLogLevel:Nw,log_level:rt};function uh(){try{if(Ks===void 0){let e=pw();Ks=_h(e),{level:rt,config_log_path:ru,to_file:Zt,to_stream:lr}=gw(Ks.get("settings_path"))}}catch(e){if(Ks=void 0,e.code===Re.NODE_ERROR_CODES.ENOENT){let t=dw(Object.keys(Re.CONFIG_PARAM_MAP),!0);for(let i in t){let o=Re.CONFIG_PARAM_MAP[i];o&&o.toLowerCase();let c=t[i];if(o===Re.CONFIG_PARAMS.LOGGING_LEVEL){rt=c;continue}if(o===Re.CONFIG_PARAMS.LOGGING_STDSTREAMS){lr=c;continue}o===Re.CONFIG_PARAMS.LOGGING_FILE&&(Zt=o)}let{default_level:r,default_to_file:s,default_to_stream:n}=Iw();Zt=Zt===void 0?s:Zt,Zt=oh(Zt),lr=lr===void 0?n:lr,lr=oh(lr),rt=rt===void 0?r:rt,ru=fa;return}throw su("Error initializing log settings"),su(e),e}}a(uh,"initLogSettings");function fw(e,t){if(!Mr){Eh("createLogFile should only be used if the process is not being managed by pm2");return}Ks===void 0&&uh(),iu=t;let r;e===Re.PROCESS_LOG_NAMES.INSTALL?r=fa:r=ru,Zt&&(Ys=os.join(r,e),as.ensureFileSync(Ys))}a(fw,"createLogFile");function cs(e,t){let r=new Date(Date.now()).toISOString(),s="",n=t.length,i=n-1;for(let o=0;o<n;o++){let c=t[o];c instanceof Error&&c.stack?s+=c.stack:typeof c=="object"?s+=JSON.stringify(c):s+=c,o<i&&(s+=" ")}return`{"process_name": "${iu}", "level": "${e}", "timestamp": "${r}", "message": "${s}"}
`}a(cs,"createLogRecord");function lh(e){Ys===void 0&&(iu=Re.PROCESS_DESCRIPTORS.INSTALL,as.ensureDirSync(fa),Ys=os.join(fa,Re.PROCESS_LOG_NAMES.INSTALL),as.ensureFileSync(Ys)),as.appendFileSync(Ys,e)}a(lh,"writeToLogFile");function Ta(e){Zt&&lh(e),lr&&process.stdout.write(e)}a(Ta,"nonPm2LogStdOut");function au(e){Zt&&lh(e),lr&&process.stderr.write(e)}a(au,"nonPm2LogStdErr");function Tw(...e){if(st[rt]<=st.info){let t=cs("info",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(Tw,"info");function Eh(...e){if(st[rt]<=st.trace){let t=cs("trace",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(Eh,"trace");function su(...e){if(st[rt]<=st.error){let t=cs("error",e);if(Mr){au(t);return}process.stderr.write(t)}}a(su,"error");function mw(...e){if(st[rt]<=st.debug){let t=cs("debug",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(mw,"debug");function Rw(...e){if(st[rt]<=st.notify){let t=cs("notify",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(Rw,"notify");function Aw(...e){if(st[rt]<=st.fatal){let t=cs("fatal",e);if(Mr){au(t);return}process.stderr.write(t)}}a(Aw,"fatal");function Ow(...e){if(st[rt]<=st.warn){let t=cs("warn",e);if(Mr){au(t);return}process.stderr.write(t)}}a(Ow,"warn");function pw(){let e;try{e=hw.homedir()}catch{e=process.env.HOME}e||(e="~/");let t=os.join(e,Re.HDB_HOME_DIR_NAME,Re.BOOT_PROPS_FILE_NAME);return as.existsSync(t)||(t=os.join(nu,"utility/hdb_boot_properties.file")),t}a(pw,"getPropsFilePath");function Nw(e){rt=e}a(Nw,"setLogLevel");function oh(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(oh,"autoCastBoolean");function gw(e){try{if(e.includes("config/settings.js")){let o=_h(e);return{level:o.get(Re.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY),config_log_path:os.dirname(o.get(Re.HDB_SETTINGS_NAMES.LOG_PATH_KEY)),to_file:o.get(Re.HDB_SETTINGS_NAMES.LOG_TO_FILE),to_stream:o.get(Re.HDB_SETTINGS_NAMES.LOG_TO_STDSTREAMS)}}let t=ch.parseDocument(as.readFileSync(e,"utf8")),r=t.getIn(["logging","level"]),s=t.getIn(["logging","root"]),n=t.getIn(["logging","file"]),i=t.getIn(["logging","stdStreams"]);return{level:r,config_log_path:s,to_file:n,to_stream:i}}catch(t){if(t.code===Re.NODE_ERROR_CODES.ENOENT)throw t;console.error("Error accessing config file for logging"),console.error(t)}}a(gw,"getLogConfig");function Iw(){try{let e=ch.parseDocument(as.readFileSync(Sw,"utf8")),t=e.getIn(["logging","level"]),r=e.getIn(["logging","file"]),s=e.getIn(["logging","stdStreams"]);return{default_level:t,default_to_file:r,default_to_stream:s}}catch(e){console.error("Error accessing default config file for logging"),console.error(e)}}a(Iw,"getDefaultConfig")});var Sh=S((H1,hh)=>{"use strict";var bw=require("util"),Cw=require("path"),ww=require("child_process"),Lw=bw.promisify(ww.execFile),Uw=1e3*1e3*10;hh.exports={findPs:yw};async function yw(e){let t={};try{await Promise.all(["comm","args","ppid","uid","%cpu","%mem"].map(async r=>{let{stdout:s}=await Lw("ps",["wwxo",`pid,${r}`],{maxBuffer:Uw});for(let n of s.trim().split(`
`).slice(1)){n=n.trim();let[i]=n.split(" ",1),o=n.slice(i.length+1).trim();t[i]===void 0&&(t[i]={}),t[i][r]=o}}))}catch(r){throw r}return Object.entries(t).filter(([,r])=>r.comm&&r.args&&r.ppid&&r.uid&&r["%cpu"]&&r["%mem"]&&r.args.includes(e)).map(([r,s])=>({pid:Number.parseInt(r,10),name:Cw.basename(s.comm),cmd:s.args,ppid:Number.parseInt(s.ppid,10),uid:Number.parseInt(s.uid,10),cpu:Number.parseFloat(s["%cpu"]),memory:Number.parseFloat(s["%mem"])}))}a(yw,"findPs")});var Ye=S((G1,Th)=>{"use strict";var Dw="__dbis__",Mw="__environment_name__",Pw="__dbi_defintion__",Bw={EQUALS:"equals",STARTS_WITH:"startsWith",_STARTS_WITH:"starts_with",ENDS_WITH:"endsWith",_ENDS_WITH:"ends_with",CONTAINS:"contains",SEARCH_ALL:"searchAll",SEARCH_ALL_TO_MAP:"searchAllToMap",BATCH_SEARCH_BY_HASH:"batchSearchByHash",BATCH_SEARCH_BY_HASH_TO_MAP:"batchSearchByHashToMap",GREATER_THAN:"greaterThan",_GREATER_THAN:"greater_than",GREATER_THAN_EQUAL:"greaterThanEqual",_GREATER_THAN_EQUAL:"greater_than_equal",LESS_THAN:"lessThan",_LESS_THAN:"less_than",LESS_THAN_EQUAL:"lessThanEqual",_LESS_THAN_EQUAL:"less_than_equal",BETWEEN:"between"},vw=["__createdtime__","__updatedtime__"],Hw="\uFFFF",fh={TIMESTAMP:"timestamp",HASH_VALUE:"hash_value",USER_NAME:"user_name"},Gw=Object.values(fh);Th.exports={INTERNAL_DBIS_NAME:Dw,DBI_DEFINITION_NAME:Pw,SEARCH_TYPES:Bw,TIMESTAMP_NAMES:vw,MAX_SEARCH_KEY_LENGTH:256,ENVIRONMENT_NAME_KEY:Mw,TRANSACTIONS_DBI_NAMES_ENUM:fh,TRANSACTIONS_DBIS:Gw,OVERFLOW_MARKER:Hw}});var Ke=S((q1,bh)=>{"use strict";var mh=T(),Rh=Ye(),Ah={CONTINUE:100,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,REQUEST_TIMEOUT:408,CONFLICT:409,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,INSUFFICIENT_STORAGE:507,NETWORK_AUTHENTICATION_REQUIRED:511},Oh=a(e=>`${e} Check logs and try again.`,"CHECK_LOGS_WRAPPER"),ph={500:Oh("There was an error processing your request."),400:"Invalid request"},qw=ph[Ah.INTERNAL_SERVER_ERROR],Fw={OP_NOT_SUPPORTED_FOR_FS:e=>`${e} is not available for this instance because it uses the File System data store.`,MISSING_VALUE:e=>`${e} is missing.`,INVALID_VALUE:e=>`${e} is invalid.`,NOT_FOUND:e=>`${e} not found.`},Vw={CONFIG_VALIDATION:e=>`HarperDB config file validation error: ${e}`},kw={DEFAULT_BULK_LOAD_ERR:"There was an error during your bulk load into HarperDB.",DOWNLOAD_FILE_ERR:e=>`There was an error downloading '${e}'.`,INSERT_JSON_ERR:"There was an error inserting the downloaded JSON data.",INSERT_CSV_ERR:"There was an error inserting the downloaded CSV data.",INVALID_ACTION_PARAM_ERR:e=>`Bulk load operation failed - ${e} is not a valid 'action' parameter`,INVALID_FILE_EXT_ERR:e=>`Error selecting correct parser - valid file type not found in json - ${e}`,MAX_FILE_SIZE_ERR:(e,t)=>`File size is ${e} bytes, which exceeded the maximum size allowed of: ${t} bytes`,PAPA_PARSE_ERR:"There was an error parsing the downloaded CSV data.",S3_DOWNLOAD_ERR:e=>`There was an error downloading '${e}' from AWS.`,WRITE_TEMP_FILE_ERR:"Error writing temporary file to storage"},xw={BASE_PATH_REQUIRED:"base_path is required",DESTINATION_PATH_REQUIRED:"destination_path is required",ENV_NAME_REQUIRED:"env_name is required",INVALID_BASE_PATH:"invalid base_path",INVALID_DESTINATION_PATH:"invalid destination_path",INVALID_ENVIRONMENT:"invalid environment",ENV_REQUIRED:"env is required",DBI_NAME_REQUIRED:"dbi_name is required",DBI_DOES_NOT_EXIST:"dbi does not exist",HASH_ATTRIBUTE_REQUIRED:"hash_attribute is required",ID_REQUIRED:"id is required",IDS_REQUIRED:"ids is required",IDS_MUST_BE_ARRAY:"ids must be an array",FETCH_ATTRIBUTES_REQUIRED:"fetch_attributes is required",FETCH_ATTRIBUTES_MUST_BE_ARRAY:"fetch_attributes must be an array",ATTRIBUTE_REQUIRED:"attribute is required",SEARCH_VALUE_REQUIRED:"search_value is required",SEARCH_VALUE_TOO_LARGE:"search_value is too long",WRITE_ATTRIBUTES_REQUIRED:"write_attributes is required",WRITE_ATTRIBUTES_MUST_BE_ARRAY:"write_attributes must be an array",RECORDS_REQUIRED:"records is required",RECORDS_MUST_BE_ARRAY:"records must be an array",CANNOT_CREATE_INTERNAL_DBIS_NAME:`cannot create a dbi named ${Rh.INTERNAL_DBIS_NAME}`,CANNOT_DROP_INTERNAL_DBIS_NAME:`cannot drop a dbi named ${Rh.INTERNAL_DBIS_NAME}`,START_VALUE_REQUIRED:"start_value is required",END_VALUE_REQUIRED:"end_value is required",CANNOT_COMPARE_STRING_TO_NUMERIC_KEYS:"cannot compare a string to numeric keys",END_VALUE_MUST_BE_GREATER_THAN_START_VALUE:"end_value must be greater than or equal to start_value",UNKNOWN_SEARCH_TYPE:"unknown search type",CANNOT_DROP_TABLE_HASH_ATTRIBUTE:"cannot drop a table's hash attribute"},$w={ATTR_NAME_LENGTH_ERR:e=>`transaction aborted due to attribute name ${e} being too long. Attribute names cannot be longer than ${mh.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes.`,ATTR_NAME_NULLISH_ERR:"transaction aborted due to record(s) with an attribute name that is null, undefined or empty string",HASH_VAL_LENGTH_ERR:`transaction aborted due to record(s) with a hash value that exceeds ${mh.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes, check log for more info`,INVALID_FORWARD_SLASH_IN_HASH_ERR:"transaction aborted due to record(s) with a hash value that contains a forward slash, check log for more info",RECORD_MISSING_HASH_ERR:"transaction aborted due to record(s) with no hash value, check log for more info"},Nh={GENERIC_AUTH_FAIL:"Login failed",USER_INACTIVE:"Cannot complete request: User is inactive",INVALID_TOKEN:"invalid token",NO_ENCRYPTION_KEYS:"unable to generate JWT as there are no encryption keys.  please contact your administrator",INVALID_CREDENTIALS:"invalid credentials",PASSWORD_REQUIRED:"password is required",USERNAME_REQUIRED:"username is required",REFRESH_TOKEN_REQUIRED:"refresh_token is required",INVALID_AUTH_OBJECT:"invalid auth_object",INVALID_BODY:"invalid body",TOKEN_EXPIRED:"token expired",REFRESH_TOKEN_SAVE_FAILED:"unable to store refresh_token"},Yw={DEFAULT_INVALID_REQUEST:"Invalid request",OP_AUTH_PERMS_ERROR:"This operation is not authorized due to role restrictions and/or invalid schema items",OP_IS_SU_ONLY:e=>`Operation '${e}' is restricted to 'super_user' roles`,OP_NOT_FOUND:e=>`Operation '${e}' not found`,SYSTEM_TIMESTAMP_PERMS_ERR:"Internal timestamp attributes - '__createdtime_' and '__updatedtime__' - cannot be inserted to or updated by HDB users.",UNKNOWN_OP_AUTH_ERROR:(e,t,r)=>`There was an error authorizing ${e} op on table '${t}.${r}'`,USER_HAS_NO_PERMS:e=>`User ${e} has no role or permissions.  Please assign the user a valid role.`,DROP_SYSTEM:"The 'system' schema, tables and records are used internally by HarperDB and cannot be updated or removed."},Kw={ATTR_PERM_MISSING:(e,t)=>`${e.toUpperCase()} attribute permission missing for '${t}'`,ATTR_PERM_MISSING_NAME:"Permission object in 'attribute_permission' missing an 'attribute_name'",ATTR_PERM_NOT_BOOLEAN:(e,t)=>`${e.toUpperCase()} attribute permission for '${t}' must be a boolean`,ATTR_PERMS_ARRAY_MISSING:"Missing 'attribute_permissions' array",ATTR_PERMS_NOT_ARRAY:"Value for 'attribute_permissions' must be an array",INVALID_ATTRIBUTE_IN_PERMS:e=>`Invalid attribute '${e}' in 'attribute_permissions'`,INVALID_PERM_KEY:e=>`Invalid table permission key value '${e}'`,INVALID_ATTR_PERM_KEY:e=>`Invalid attribute permission key value '${e}'`,INVALID_ROLE_JSON_KEYS:e=>`Invalid ${e.length>1?"keys":"key"} in JSON body - '${e.join("', '")}'`,MISMATCHED_TABLE_ATTR_PERMS:e=>`You have a conflict with TABLE permissions for '${e}' being false and ATTRIBUTE permissions being true`,OUTDATED_PERMS_TRANSLATION_ERROR:"This instance was recently upgraded and uses our new role permissions structure. Please login to this instance in HarperDB Studio, go to 'Roles', and click 'Update Role Permission' for all standard roles to migrate them to the new structure.",ROLE_ALREADY_EXISTS:e=>`A role with name '${e}' already exists`,ROLE_NOT_FOUND:"Role not found",ROLE_PERMS_ERROR:"Errors in the role permissions JSON provided",SCHEMA_PERM_ERROR:e=>`Your role does not have permission to view schema metadata for '${e}'`,SCHEMA_TABLE_PERM_ERROR:(e,t)=>`Your role does not have permission to view schema.table metadata for '${e}.${t}'`,SU_ROLE_MISSING_ERROR:"Missing 'super_user' key/value in permission set",SU_CU_ROLE_BOOLEAN_ERROR:e=>`Value for '${e}' permission must be a boolean`,STRUCTURE_USER_ROLE_TYPE_ERROR:e=>`Value for '${e}' permission must be a boolean or Array`,SU_CU_ROLE_NO_PERMS_ALLOWED:e=>`Roles with '${e}' set to true cannot have other permissions set.`,SU_CU_ROLE_COMBINED_ERROR:"Roles cannot have both 'super_user' and 'cluster_user' values included in their permissions set.",TABLE_PERM_MISSING:e=>`Missing table ${e.toUpperCase()} permission`,TABLE_PERM_NOT_BOOLEAN:e=>`Table ${e.toUpperCase()} permission must be a boolean`},Qw={ATTR_NOT_FOUND:(e,t,r)=>`Attribute '${r}' does not exist on '${e}.${t}'`,ATTR_EXISTS_ERR:(e,t,r)=>`Attribute '${r}' already exists in ${e}.${t}'`,DESCRIBE_ALL_ERR:"There was an error during describeAll.  Please check the logs and try again.",INVALID_TABLE_ERR:e=>`Invalid table ${JSON.stringify(e)}`,SCHEMA_NOT_FOUND:e=>`Schema '${e}' does not exist`,SCHEMA_EXISTS_ERR:e=>`Schema '${e}' already exists`,TABLE_EXISTS_ERR:(e,t)=>`Table '${t}' already exists in schema '${e}'`,SCHEMA_REQUIRED_ERR:"schema is required",TABLE_NOT_FOUND:(e,t)=>`Table '${e}.${t}' does not exist`,TABLE_REQUIRED_ERR:"table is required"},Ww={OUTER_JOIN_TRANSLATION_ERROR:"There was an error translating the final SQL outer join data."},Jw={ALTER_USER_DUP_ROLES:e=>`Update failed.  There are duplicates for the '${e}' role which is not allowed. Update your roles and try again.`,ALTER_USER_ROLE_NOT_FOUND:e=>`Update failed.  Requested '${e}' role not found.`,DUP_ROLES_FOUND:e=>`Multiple ${e} roles found.  Roles must have unique 'role' value. Please update and try again.`,ROLE_NAME_NOT_FOUND:e=>`${e} role not found`,USER_ALREADY_EXISTS:e=>`User ${e} already exists`,USER_NOT_EXIST:e=>`User ${e} does not exist`},gh={INVALID_DATE:"Invalid date, must be in ISO-8601 format (YYYY-MM-DD).",SEARCH_CONDITIONS_INVALID_SORT_ATTRIBUTE:e=>`invalid sort attribute '${e}', the attribute must either be the table's hash attribute or an attribute used in conditions.`},Ih={INVALID_IPC_DATA_TYPE:"Invalid IPC event data type, must be an object",MISSING_TYPE:"IPC event missing 'type'",MISSING_MSG:"IPC event missing 'message'",MISSING_ORIGIN:"IPC event message missing 'originator' property",INVALID_EVENT:e=>`IPC server received invalid event type: ${e}`},Zw={FUNCTION_STATUS:"Error getting custom function status, check the log for more details",GET_FUNCTIONS:"Error getting custom functions, check the log for more details",GET_FUNCTION:"Error getting custom function, check the log for more details",SET_FUNCTION:"Error setting custom function, check the log for more details",NO_PROJECT:"Project does not exist. Create one using 'add_custom_function_project'",PROJECT_EXISTS:"Project already exists",VALIDATION_ERR:"Error validating request, check the log for more details",NO_FILE:"File does not exist",BAD_FILE_NAME:"File name can only contain alphanumeric, dash and underscore characters",BAD_PROJECT_NAME:"Project name can only contain alphanumeric, dash and underscores characters",BAD_PACKAGE:"Packaged project must be base64-encoded tar file of project directory",DROP_FUNCTION:"Error dropping custom function, check the log for more details",ADD_FUNCTION:"Error adding custom function project, check the log for more details",DROP_FUNCTION_PROJECT:"Error dropping custom function project, check the log for more details",BAD_FILE_PATH:"Filepath must be valid, and contain the name of the tarball you wish to write",NOT_ENABLED:"Custom functions is not enabled, to enable set customFunctions enabled to true in hdb/harperdb-config.yaml file."},Xw={CLUSTERING_NOT_ENABLED:"Clustering must be enabled to perform this operation."},zw={...Nh,...kw,...Fw,...Yw,...Kw,...Qw,...Ww,...Jw,...$w,...gh,...Ih,...Zw,...Xw,...Vw};bh.exports={CHECK_LOGS_WRAPPER:Oh,HDB_ERROR_MSGS:zw,DEFAULT_ERROR_MSGS:ph,DEFAULT_ERROR_RESP:qw,HTTP_STATUS_CODES:Ah,LMDB_ERRORS_ENUM:xw,AUTHENTICATION_ERROR_MSGS:Nh,VALIDATION_ERROR_MSGS:gh,IPC_ERRORS:Ih}});var D=S((F1,Lh)=>{"use strict";var Qs=Ke(),jw=I(),eL=T(),$n=class extends Error{constructor(t,r,s,n,i){super(),Error.captureStackTrace(this,Ch),this.http_resp_code=s||Qs.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,this.http_resp_msg=r||(Qs.DEFAULT_ERROR_MSGS[s]?Qs.DEFAULT_ERROR_MSGS[s]:Qs.DEFAULT_ERROR_MSGS[Qs.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR]),this.message=t.message?t.message:this.http_resp_msg,this.type=t.name,typeof this.message!="string"&&(this.stack=t.stack),i&&jw[n](i)}};a($n,"HdbError");function Ch(e,t,r,s=eL.LOG_LEVELS.ERROR,n=null,i=!1){if(wh(e))return e;let o=new $n(e,t,r,s,n);return i&&delete o.stack,o}a(Ch,"handleHDBError");function wh(e){return e.__proto__.constructor.name===$n.name}a(wh,"isHDBError");Lh.exports={isHDBError:wh,handleHDBError:Ch,hdb_errors:Qs}});var b=S((k1,$h)=>{"use strict";var ou=require("path"),tL=require("fs-extra"),be=I(),Uh=require("fs-extra"),rL=require("truncate-utf8-bytes"),Yn=require("os"),sL=require("net"),nL=require("recursive-iterator"),Ue=T(),Bh=Sh(),yh=require("papaparse"),ma=require("moment"),{inspect:iL}=require("util"),Dh=require("is-number"),V1=require("lodash"),{hdb_errors:Ra}=D(),vh=require("util").promisify(setTimeout),aL=100,oL=5,cL="",_L=4,Mh=255,Ph={true:!0,false:!1,undefined:null,null:null,NaN:NaN};$h.exports={isEmpty:St,isEmptyOrZeroLength:Xt,arrayHasEmptyValues:EL,arrayHasEmptyOrZeroLengthValues:dL,buildFolderPath:hL,isBoolean:Hh,errorizeMessage:uL,stripFileExtension:fL,autoCast:TL,autoCastJSONDeep:cu,removeDir:RL,compareVersions:AL,isCompatibleDataVersion:OL,escapeRawValue:qh,unescapeValue:pL,stringifyProps:NL,valueConverter:gL,timeoutPromise:bL,isClusterOperation:wL,getClusterUser:yL,sendTransactionToSocketCluster:LL,checkGlobalSchemaTable:UL,getHomeDir:Fh,getPropsFilePath:IL,promisifyPapaParse:DL,removeBOM:Vh,createEventPromise:ML,checkProcessRunning:PL,checkSchemaTableExist:BL,checkSchemaExists:kh,checkTableExists:xh,getStartOfTomorrowInSeconds:vL,getLimitKey:HL,isObject:SL,isNotEmptyAndHasValue:lL,autoCasterIsNumberCheck:Gh,backtickASTSchemaItems:GL,isPortTaken:CL,stopProcess:qL,createForkArgs:FL,autoCastBoolean:VL,async_set_timeout:vh,getTableHashAttribute:kL,doesSchemaExist:xL,doesTableExist:$L,stringifyObj:YL,ms_to_time:KL,PACKAGE_ROOT:Ue.PACKAGE_ROOT};function uL(e){return e instanceof Error?e:new Error(e)}a(uL,"errorizeMessage");function St(e){return e==null}a(St,"isEmpty");function lL(e){return!St(e)&&(e||e===0||e===""||Hh(e))}a(lL,"isNotEmptyAndHasValue");function Xt(e){return St(e)||e.length===0||e.size===0}a(Xt,"isEmptyOrZeroLength");function EL(e){if(St(e))return!0;for(let t=0;t<e.length;t++)if(St(e[t]))return!0;return!1}a(EL,"arrayHasEmptyValues");function dL(e){if(Xt(e))return!0;for(let t=0;t<e.length;t++)if(Xt(e[t]))return!0;return!1}a(dL,"arrayHasEmptyOrZeroLengthValues");function hL(...e){try{return e.join(ou.sep)}catch{console.error(e)}}a(hL,"buildFolderPath");function Hh(e){return St(e)?!1:e===!0||e===!1}a(Hh,"isBoolean");function SL(e){return St(e)?!1:typeof e=="object"}a(SL,"isObject");function fL(e){return Xt(e)?cL:e.slice(0,-_L)}a(fL,"stripFileExtension");function TL(e){return St(e)||e===""||typeof e!="string"?e:Ph[e]!==void 0?Ph[e]:Gh(e)===!0?Number(e):e}a(TL,"autoCast");function mL(e){if(typeof e=="string"&&(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]")))try{return JSON.parse(e)}catch{}return e}a(mL,"autoCastJSON");function cu(e){if(e&&typeof e=="object"){if(Array.isArray(e))for(let t=0,r=e.length;t<r;t++){let s=e[t],n=cu(s);n!==s&&(e[t]=n)}else for(let t in e){let r=e[t],s=cu(r);s!==r&&(e[t]=s)}return e}else return mL(e)}a(cu,"autoCastJSONDeep");function Gh(e){if(e.startsWith("0.")&&Dh(e))return!0;let t=e.toUpperCase().includes("E");return!!((e!=="0"&&e.startsWith("0"))===!1&&t===!1&&Dh(e))}a(Gh,"autoCasterIsNumberCheck");async function RL(e){if(Xt(e))throw new Error(`Directory path: ${e} does not exist`);try{await Uh.emptyDir(e),await Uh.remove(e)}catch(t){throw be.error(`Error removing files in ${e} -- ${t}`),t}}a(RL,"removeDir");function AL(e,t){if(Xt(e)){be.info("Invalid current version sent as parameter.");return}if(Xt(t)){be.info("Invalid upgrade version sent as parameter.");return}let r,s=/(\.0+)+$/,n=e.version?e.version:e,i=t.version?t.version:t,o=n.replace(s,"").split("."),c=i.replace(s,"").split("."),_=Math.min(o.length,c.length);for(let u=0;u<_;u++)if(r=parseInt(o[u],10)-parseInt(c[u],10),r)return r;return o.length-c.length}a(AL,"compareVersions");function OL(e,t,r=!1){let s=e.toString().split("."),n=t.toString().split(".");return s[0]===n[0]&&(!r||s[1]===n[1])}a(OL,"isCompatibleDataVersion");function qh(e){if(St(e))return e;let t=String(e);return t==="."?Ue.UNICODE_PERIOD:t===".."?Ue.UNICODE_PERIOD+Ue.UNICODE_PERIOD:t.replace(Ue.FORWARD_SLASH_REGEX,Ue.UNICODE_FORWARD_SLASH)}a(qh,"escapeRawValue");function pL(e){if(St(e))return e;let t=String(e);return t===Ue.UNICODE_PERIOD?".":t===Ue.UNICODE_PERIOD+Ue.UNICODE_PERIOD?"..":String(e).replace(Ue.ESCAPED_FORWARD_SLASH_REGEX,"/")}a(pL,"unescapeValue");function NL(e,t){if(St(e))return be.info("Properties object is null"),"";let r="";return e.each(function(s,n){try{if(t&&t[s]){let i=t[s];for(let o of i)r+=";"+o+Yn.EOL}!Xt(s)&&s[0]===";"?r+="	"+s+n+Yn.EOL:Xt(s)||(r+=s+"="+n+Yn.EOL)}catch{be.error(`Found bad property during upgrade with key ${s} and value: ${n}`)}}),r}a(NL,"stringifyProps");function gL(e){let t;try{t=typeof e=="object"?JSON.stringify(e):e}catch(n){be.error(n),t=e}let r=String(qh(t)),s=Buffer.byteLength(r)>Mh?rL(r,Mh)+"/blob":r;return{value:t,value_stripped:r,value_path:s}}a(gL,"valueConverter");function Fh(){let e;try{e=Yn.homedir()}catch{e=process.env.HOME}return e||(e="~/"),e}a(Fh,"getHomeDir");function IL(){let e=ou.join(Fh(),Ue.HDB_HOME_DIR_NAME,Ue.BOOT_PROPS_FILE_NAME);return tL.existsSync(e)||(e=ou.join(__dirname,"../","hdb_boot_properties.file")),e}a(IL,"getPropsFilePath");function bL(e,t){let r,s;return s=new Promise(function(n){r=setTimeout(function(){n(t)},e)}),{promise:s,cancel:function(){clearTimeout(r)}}}a(bL,"timeoutPromise");async function CL(e){if(!e)throw new Error("Invalid port passed as parameter");return new Promise((t,r)=>{let s=sL.createServer().once("error",n=>{n.code==="EADDRINUSE"?t(!0):r(n)}).once("listening",()=>s.once("close",()=>t(!1)).close()).listen(e)})}a(CL,"isPortTaken");function wL(e){try{return Ue.CLUSTER_OPERATIONS[e.toLowerCase()]!==void 0}catch(t){be.error(`Error checking operation against cluster ops ${t}`)}return!1}a(wL,"isClusterOperation");function LL(e,t,r){if(global.hdb_socket_client!==void 0){be.trace(`Sending transaction to channel: ${e}`);let{hdb_user:s,hdb_auth_header:n,...i}=t;i.__originator||(i.__originator={}),i.__transacted=!0,r&&(i.__originator[r]=Ue.ORIGINATOR_SET_VALUE),global.hdb_socket_client.publish(e,i)}}a(LL,"sendTransactionToSocketCluster");function UL(e,t){if(!global.hdb_schema[e])return Ra.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e);if(!global.hdb_schema[e]||!global.hdb_schema[e][t])return Ra.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(UL,"checkGlobalSchemaTable");function yL(e,t){if(St(t)){be.warn("No CLUSTERING_USER defined, clustering disabled");return}if(St(e)||Xt(e)){be.warn("No users to search.");return}let r;try{let s=e.get(t);s&&s.role.permission.cluster_user===!0&&s.active===!0&&(r=s)}catch(s){be.error(`unable to find cluster_user due to: ${s.message}`);return}if(r===void 0){be.warn(`CLUSTERING_USER: ${t} not found or is not active.`);return}return r}a(yL,"getClusterUser");function DL(){yh.parsePromise=function(e,t){return new Promise(function(r,s){yh.parse(e,{header:!0,transformHeader:Vh,chunk:t.bind(null,s),skipEmptyLines:!0,dynamicTyping:!0,error:s,complete:r})})}}a(DL,"promisifyPapaParse");function Vh(e){if(typeof e!="string")throw new TypeError(`Expected a string, got ${typeof e}`);return e.charCodeAt(0)===65279?e.slice(1):e}a(Vh,"removeBOM");function ML(e,t,r){return new Promise(s=>{t.once(e,n=>{let i=r;be.info(`Got cluster status event response: ${iL(n)}`);try{i.cancel()}catch{be.error("Error trying to cancel timeout.")}s(n)})})}a(ML,"createEventPromise");async function PL(e){let t=!0,r=0;do await vh(aL*r++),(await Bh.findPs(e)).length>0&&(t=!1);while(t&&r<oL);if(t)throw new Error(`process ${e} was not started`)}a(PL,"checkProcessRunning");function BL(e,t){let r=kh(e);if(r)return r;let s=xh(e,t);if(s)return s}a(BL,"checkSchemaTableExist");function kh(e){if(!global.hdb_schema[e])return Ra.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(kh,"checkSchemaExists");function xh(e,t){if(!global.hdb_schema[e][t])return Ra.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(xh,"checkTableExists");function vL(){let e=ma().utc().add(1,Ue.MOMENT_DAYS_TAG).startOf(Ue.MOMENT_DAYS_TAG).unix(),t=ma().utc().unix();return e-t}a(vL,"getStartOfTomorrowInSeconds");function HL(){return ma().utc().format("DD-MM-YYYY")}a(HL,"getLimitKey");function GL(e){try{let t=new nL(e);for(let{node:r}of t)r&&(r.columnid&&typeof r.columnid!="string"&&(r.columnid=r.columnid.toString()),r.columnid&&!r.columnid.startsWith("`")&&(r.columnid_orig=r.columnid,r.columnid=`\`${r.columnid}\``),r.tableid&&!r.tableid.startsWith("`")&&(r.tableid_orig=r.tableid,r.tableid=`\`${r.tableid}\``),r.databaseid&&!r.databaseid.startsWith("`")&&(r.databaseid_orig=r.databaseid,r.databaseid=`\`${r.databaseid}\``),r.as&&typeof r.as=="string"&&!r.as.startsWith("[")&&(r.as_orig=r.as,r.as=`\`${r.as}\``))}catch(t){be.error("Got an error back ticking items."),be.error(t)}}a(GL,"backtickASTSchemaItems");async function qL(e){let t=Yn.userInfo();(await Bh.findPs(e)).forEach(s=>{(t.uid==0||s.uid==t.uid)&&(process.kill(s.pid),be.trace(`Following process was killed by stopProcess: ${s.cmd}`))})}a(qL,"stopProcess");function FL(e){return[e]}a(FL,"createForkArgs");function VL(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(VL,"autoCastBoolean");function kL(e,t){return global.hdb_schema?.[e]?.[t]?.hash_attribute}a(kL,"getTableHashAttribute");function xL(e){return global?.hdb_schema?.[e]!==void 0}a(xL,"doesSchemaExist");function $L(e,t){return global?.hdb_schema?.[e]?.[t]!==void 0}a($L,"doesTableExist");function YL(e){try{return JSON.stringify(e)}catch{return e}}a(YL,"stringifyObj");function KL(e){let t=ma.duration(e),r=t.seconds()>0?t.seconds()+"s":"",s=t.minutes()>0?t.minutes()+"m ":"",n=t.hours()>0?t.hours()+"h ":"",i=t.days()>0?t.days()+"d ":"";return(t.years()>0?t.years()+"y ":"")+i+n+s+r}a(KL,"ms_to_time")});var sS=S(($1,rS)=>{"use strict";var _u=require("recursive-iterator"),QL=require("alasql"),uu=require("clone"),Yh=b(),{handleHDBError:Kh,hdb_errors:WL}=D(),{HDB_ERROR_MSGS:Qh,HTTP_STATUS_CODES:Wh}=WL,JL=["DISTINCT_ARRAY"],Jh=Symbol("validateTables"),lu=Symbol("validateTable"),x1=Symbol("getAllColumns"),Zh=Symbol("validateAllColumns"),Aa=Symbol("findColumn"),Xh=Symbol("validateOrderBy"),Kn=Symbol("validateSegment"),Eu=Symbol("validateColumn"),zh=Symbol("setColumnsForTable"),jh=Symbol("checkColumnsForAsterisk"),eS=Symbol("validateGroupBy"),tS=Symbol("hasColumns"),Oa=class{constructor(t){this.statement=t,this.attributes=[]}validate(){if(!this.statement)throw new Error("invalid sql statement");this[Jh](),this[jh](),this[Zh]()}[Jh](){if(this[tS]()){if(!this.statement.from||this.statement.from.length===0)throw"no from clause";this.statement.from.forEach(t=>{this[lu](t)}),this.statement.joins&&this.statement.joins.forEach(t=>{t.table.as=t.as,this[lu](t.table)})}}[tS](){let t=!1,r=new _u(this.statement);for(let{node:s,path:n}of r)if(s&&s.columnid){t=!0;break}return t}[lu](t){if(!t.databaseid)throw`schema not defined for table ${t.tableid}`;if(!global.hdb_schema[t.databaseid])throw Kh(new Error,Qh.SCHEMA_NOT_FOUND(t.databaseid),Wh.NOT_FOUND);if(!global.hdb_schema[t.databaseid][t.tableid])throw Kh(new Error,Qh.TABLE_NOT_FOUND(t.databaseid,t.tableid),Wh.NOT_FOUND);global.hdb_schema[t.databaseid][t.tableid].attributes.forEach(s=>{let n=uu(s);n.table=uu(t),this.attributes.push(n)})}[Aa](t){return this.attributes.filter(r=>t.tableid?(r.table.as===t.tableid||r.table.tableid===t.tableid)&&r.attribute===t.columnid:r.attribute===t.columnid)}[jh](){let t=new _u(this.statement.columns);for(let{node:r,path:s}of t)r&&r.columnid==="*"&&s.indexOf("expression")<0&&this[zh](r.tableid)}[zh](t){this.attributes.forEach(r=>{(!t||t&&(r.table.tableid===t||r.table.as===t))&&this.statement.columns.push(new QL.yy.Column({columnid:r.attribute,tableid:r.table.as?r.table.as:r.table.tableid}))})}[Zh](){this[Kn](this.statement.columns,!1),this[Kn](this.statement.joins,!1),this[Kn](this.statement.where,!1),this[eS](this.statement.group,!1),this[Kn](this.statement.order,!0)}[Kn](t,r){if(!t)return;let s=new _u(t),n=[];for(let{node:i,path:o}of s)!Yh.isEmpty(i)&&!Yh.isEmpty(i.columnid)&&i.columnid!=="*"&&(r?this[Xh](i):n.push(this[Eu](i)));return n}[eS](t){if(!t)return;let r=[];if(this.statement.columns.forEach(s=>{if(!(s.funcid&&JL.indexOf(s.funcid.toUpperCase())>=0)){if(!s.aggregatorid&&!s.columnid){let n=uu(s);delete n.as,r.push(n)}else if(s.columnid){let n=this[Aa](s)[0];n&&r.push(n)}}}),this.statement.group.forEach(s=>{let n=null;if(!s.columnid)r.forEach((i,o)=>{if(i.toString()===s.toString()){n=i,r.splice(o,1);return}});else{let i=this[Aa](s);if(!i||i.length===0)throw`unknown column '${s.toString()}' in group by`;if(i.length>1)throw`ambiguously defined column '${s.toString()}' in group by`;r.forEach((o,c)=>{if(o.attribute===i[0].attribute&&o.table.tableid===i[0].table.tableid){n=o,r.splice(c,1);return}})}if(!n)throw`group by column '${s.toString()}' must be in select`}),r.length>0)throw`select column '${r[0].attribute?r[0].attribute:r[0].toString()}' must be in group by`}[Xh](t){let r=this.statement.columns.filter(s=>s.as===t.columnid);if(r.length>1)throw`ambiguous column reference ${(t.tableid?t.tableid+".":"")+t.columnid} in order by`;r.length===0&&this[Eu](t)}[Eu](t){let r=this[Aa](t),s=(t.tableid?t.tableid+".":"")+t.columnid;if(r.length===0)throw`unknown column ${s}`;if(r.length>1)throw`ambiguous column reference ${s}`;return r[0]}};a(Oa,"SelectValidator");rS.exports=Oa});var du=S((Y1,nS)=>{"use strict";var pa=class{createSchema(){throw new Error("createSchema bridge method is not defined")}dropSchema(){throw new Error("dropSchema bridge method is not defined")}createTable(){throw new Error("createTable bridge method is not defined")}dropTable(){throw new Error("dropTable bridge method is not defined")}createRecords(){throw new Error("createRecords bridge method is not defined")}updateRecords(){throw new Error("updateRecords bridge method is not defined")}async upsertRecords(){throw new Error("upsertRecords bridge method is not defined")}deleteRecords(){throw new Error("deleteRecords bridge method is not defined")}createAttribute(){throw new Error("createAttribute bridge method is not defined")}dropAttribute(){throw new Error("dropAttribute bridge method is not defined")}searchByConditions(){throw new Error("searchByConditions bridge method is not defined")}searchByHash(){throw new Error("searchByHash bridge method is not defined")}searchByValue(){throw new Error("searchByValue bridge method is not defined")}getDataByHash(){throw new Error("getDataByHash bridge method is not defined")}getDataByValue(){throw new Error("getDataByValue bridge method is not defined")}deleteRecordsBefore(){throw new Error("deleteRecordsBefore bridge method is not defined")}deleteAuditLogsBefore(){throw new Error("deleteAuditLogsBefore bridge method is not defined")}async readAuditLog(){throw new Error("readAuditLog bridge method is not defined")}};a(pa,"BridgeMethods");nS.exports=pa});var _s=S((W1,cS)=>{"use strict";var iS=Ke().LMDB_ERRORS_ENUM,K1=require("lmdb"),ZL=Ye(),Q1=require("buffer").Buffer,XL=require("microtime"),{OVERFLOW_MARKER:aS,MAX_SEARCH_KEY_LENGTH:Na}=ZL,oS=["number","string","symbol","boolean","bigint"];function zL(e){if(!e)throw new Error(iS.ENV_REQUIRED);if(e.constructor.name!=="LMDBStore")throw new Error(iS.INVALID_ENVIRONMENT)}a(zL,"validateEnv");function jL(e){if(e==null)return null;let t;try{t=typeof e=="object"?JSON.stringify(e):e.toString()}catch{t=e.toString()}return t}a(jL,"stringifyData");function eU(e){return e instanceof Date?e.valueOf():e}a(eU,"convertKeyValueToWrite");function tU(e){if(e==null)return;if(oS.includes(typeof e))return e.length>Na?[e.slice(0,Na)+aS]:[e];let t;if(Array.isArray(e)){t=[];for(let r=0,s=e.length;r<s;r++){let n=e[r];oS.includes(typeof n)&&(n.length>Na?t.push(n.slice(0,Na)+aS):t.push(n))}}return t}a(tU,"getIndexedValues");function rU(){let e=XL.now().toString(),t=e.length-3;return Number(e.slice(0,t)+"."+e.slice(t))}a(rU,"getMicroTime");cS.exports={validateEnv:zL,stringifyData:jL,convertKeyValueToWrite:eU,getMicroTime:rU,getIndexedValues:tU}});var uS=S((J1,_S)=>{"use strict";var ga=class{constructor(t=!1,r=!1){this.dup_sort=t,this.is_hash_attribute=r,this.useVersions=r}};a(ga,"DBIDefinition");_S.exports=ga});var ES=S((Z1,lS)=>{"use strict";var Ia=class{constructor(t,r=!1){this.dupSort=t===!0,this.encoding=t?"ordered-binary":"msgpack",this.useVersions=r,this.sharedStructuresKey=Symbol.for("structures"),r&&(this.cache={validated:!0},this.randomAccessStructure=!0,this.freezeData=!0)}};a(Ia,"OpenDBIObject");lS.exports=Ia});var hS=S((X1,dS)=>{"use strict";var ba=class{constructor(t,r,s,n,i=!1,o=!1,c=void 0){this.path=t,this.mapSize=r,this.maxDbs=s,this.maxReaders=n,this.sharedStructuresKey=Symbol.for("structures"),this.readOnly=i,this.trackMetrics=!0,this.noSync=o,c!==void 0&&(this.overlappingSync=c)}};a(ba,"OpenEnvironmentObject");dS.exports=ba});var fS=S((z1,SS)=>{"use strict";var sU={key:"-----BEGIN RSA PRIVATE KEY-----\rMIIEowIBAAKCAQEArBFJQRfFiJku/KwhV1Ssp7cX61vvuKmd4Rp6A9jB2QLgx8nj\r/+Xhp2hPRkISnOA8BuAxr4dMD9syGJwX4kNy9mbZ5Q0fWZCiEGBpVcU1J+k+N5K4\rSuZ2SqgxeN2IN2RLzt3GyQY4imcdHgNv7aHoXUrEwBx0MeYEw3IIDXtrYKCR2D8I\rvWBfwMUgWa24G8lpWILWA5hd9srRz9NxlAiHSjhbgT7B0xruEpHRCHSyKjvaIJVt\rWBR+amejYsAKVrD/hgrqjsA1123Y6++YqvU6vwg64xhS2kz5r3dkNKhvwbWgpZdI\rIaRvsiB77f4kLGo0vi8RFgJ1ZRjGg3RRK2w1LQIDAQABAoIBAQCEOmh78EOpnGZC\rYBjjHrvrysVD5gvLcfVUtl8Ls7gMB60re1eOIF+PoZZCHKZnDd6zPfiQtj1adg0C\rYnnsM/8VoaZS4gm0b3RLd3ubIQifWhuo40RissY2yxfxlPSH9LhZCY8ojnJG0cTL\resK579E8WCfopjUY33XLqEbN7Ylv39J+DSqInjqV3efJZUa+HqUJ98VxxzodcKMD\rP3bwUU4gHoSSp4pAsOFH5sQhaIWH1IcNjrAwpee2cJQuh4G157RRIuuUpagtaEG/\rXJIiAyBguJyu3JQFnIBQF01N5+omJgXYJ1L0m54543/iIRThmF3zDCDgCyUzmOk+\rH6As9fv1AoGBANOpOtOZLSAScjGsgJamT3ceJ2wCa86g2j8Oxu8lJUmUp5s3tA0v\rBFW5O3S4KR1EXwkLMBUMrfFM8YvzHWxsXBI6XV8azGLvyqPHxr65OhmpGYkGZMXu\rn9okgjkqlewnY2I073gvyK7ppX51UL5y9fF1vlsk+UlW+Rgx/vMHbdcjAoGBANAc\rxRUsxs4QJpbS4zD3JOkHjr24a97TrS3kCybAHUMpR2NrEHPZw9zex0/aphOJUHfL\rIMkOZdpfDqMfxWy4FAEmqBEMkO2SB+h0Wp4P+qp81ax4vGFiB0cD3wtixr11U1tt\rlZ/ZTdv4VDpDFNK1KaplhTDeyuCjeYfS3/GJia9vAoGAcOsAgjBevZR5rXx84WH6\rVO8WUu37u7FenXNxt9VWTinrPMh72uixZFY8nOk+rely1e1NCn3IMko9Ns9NbDFm\r8SaH95vhXArXTYbfxZIlp9jp0YtCqcHDL+p4Oq04bFMbFyJseu7rHj1x18QYfnHw\rOY/6LL/N6k1m+Hx7qgXVmIcCgYB/w0nTCBw84XlvWqSTqQaF8VfWbWP79mP5KmkW\rLxdH5g2noVEGbohqDnK6OXd/wusdwByukiJBf94Skyy25AOT+VFwthA7aU1ljhkb\rtJ+lDuJ28eBkwLPLCzthWBC+u0qjdJFJAzVjd/7tjcU43nNn4s90AzL12iaAFhvZ\rwyA+DQKBgGc/4cdyGJ3YkcA8150gQBawgJZ7q8V1JND87ggWA8wnK3cHn7rMZQl2\r3emDp9HEFXFex5dbGDDqZFAoesZCDxjknIn9oNfW4PvaWS8q7b6ZKLZG1p03Pu7/\rtYaD0kPbo0kysfFT/co+NgHbdykvIyboomfGdNLTUjYuy6lpwpvs\r-----END RSA PRIVATE KEY-----\r".replace(/\r/g,String.fromCharCode(13,10)),cert:"-----BEGIN CERTIFICATE-----\rMIIDXDCCAkSgAwIBAgIFNTE4MzQwDQYJKoZIhvcNAQELBQAwXTEXMBUGA1UEAxMO\rSGFycGVyREIsIEluYy4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDTzEPMA0GA1UE\rBxMGRGVudmVyMRcwFQYDVQQKEw5IYXJwZXJEQiwgSW5jLjAeFw0yMjAzMTEyMzAz\rNDlaFw0yNzAzMTAyMzAzNDlaMF0xFzAVBgNVBAMTDkhhcnBlckRCLCBJbmMuMQsw\rCQYDVQQGEwJVUzELMAkGA1UECBMCQ08xDzANBgNVBAcTBkRlbnZlcjEXMBUGA1UE\rChMOSGFycGVyREIsIEluYy4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB\rAQCsEUlBF8WImS78rCFXVKyntxfrW++4qZ3hGnoD2MHZAuDHyeP/5eGnaE9GQhKc\r4DwG4DGvh0wP2zIYnBfiQ3L2ZtnlDR9ZkKIQYGlVxTUn6T43krhK5nZKqDF43Yg3\rZEvO3cbJBjiKZx0eA2/toehdSsTAHHQx5gTDcggNe2tgoJHYPwi9YF/AxSBZrbgb\ryWlYgtYDmF32ytHP03GUCIdKOFuBPsHTGu4SkdEIdLIqO9oglW1YFH5qZ6NiwApW\rsP+GCuqOwDXXbdjr75iq9Tq/CDrjGFLaTPmvd2Q0qG/BtaCll0ghpG+yIHvt/iQs\rajS+LxEWAnVlGMaDdFErbDUtAgMBAAGjIzAhMA8GA1UdEwEB/wQFMAMBAf8wDgYD\rVR0PAQH/BAQDAgIEMA0GCSqGSIb3DQEBCwUAA4IBAQASR4YW/rPK7PNArHVe9zzM\rb0rKNX/2T9/0nybRhmE/+hdlSgliTAeebmwkUS2APckmekYt/q2ZY2NS65Fo/jjp\rG8TJrtcF4h+ylVqUp0ZXQLFtIsr7r2JZA7hJ6njW6G4DHSZ0gxtECLi4CBlTjzm5\rNmnmIDObvGRTuqmcdAZmXeObbta/He2XIzietukPAYX062pNM+G5XT5UM1eG/Vlp\rN86vjhpyI+ffKy+C60SJqxmKM3ydgN7oLscE7+2wLPN25XqN4W99OwGsp5dTdu/f\r5lPtFayXdJ55e/sNQKmGN+UGLrL05c2MWgjb8U/LFilnupUianceoeSERZmVjzKX\r-----END CERTIFICATE-----\r".replace(/\r/g,String.fromCharCode(13,10))},nU="certificate.pem",iU="privateKey.pem",aU="ca.pem";SS.exports={CERTIFICATE_VALUES:sU,CERTIFICATE_PEM_NAME:nU,PRIVATEKEY_PEM_NAME:iU,CA_PEM_NAME:aU}});var he=S((j1,TS)=>{"use strict";var nt=require("validate.js");nt.validators.type=function(e,t,r,s){return e===null||typeof e>"u"||nt.validators.type.checks[t](e)?null:` must be a '${t}' value`};nt.validators.type.checks={Object:function(e){return nt.isObject(e)&&!nt.isArray(e)},Array:nt.isArray,Integer:nt.isInteger,Number:nt.isNumber,String:nt.isString,Date:nt.isDate,Boolean:function(e){return typeof e=="boolean"}};nt.validators.hasValidFileExt=function(e,t){return!nt.isString(e)||e===""||t.filter(r=>e.endsWith(r)).length>0?null:`must include one of the following valid file extensions - '${t.join("', '")}'`};TS.exports={validateObject:oU,validateObjectAsync:cU,validateBySchema:_U};function oU(e,t){if(!e||!t)return new Error("validateObject parameters were null");let r=nt(e,t,{format:"flat"});return r?new Error(r):null}a(oU,"validateObject");async function cU(e,t){if(!e||!t)return new Error("validateObject parameters were null");try{await nt.async(e,t,{format:"flat"})}catch(r){let s=r.join(",");return new Error(s)}return null}a(cU,"validateObjectAsync");function _U(e,t){let r=t.validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}});if(r.error)return new Error(r.error.message)}a(_U,"validateBySchema")});var Su=S((eJ,RS)=>{"use strict";var uU=require("fs-extra"),F=require("joi"),lU=require("os"),{boolean:ye,string:dr,number:zt,array:hu}=F.types(),qt=require("path"),EU=I(),Ca=b(),hr=fS(),dU=he(),Er="keys",hU=hr.CERTIFICATE_PEM_NAME,SU=hr.PRIVATEKEY_PEM_NAME,fU=hr.CA_PEM_NAME,TU=hr.CERTIFICATE_PEM_NAME,mU=hr.PRIVATEKEY_PEM_NAME,RU=hr.CA_PEM_NAME,AU=hr.CERTIFICATE_PEM_NAME,OU=hr.PRIVATEKEY_PEM_NAME,pU=hr.CA_PEM_NAME,NU="log",gU="custom_functions",IU="Invalid logging.rotation.maxSize unit. Available units are G, M or K",bU="Invalid logging.rotation.maxSize value. Value should be a number followed by unit e.g. '10M'",CU="rootPath config parameter is undefined",wU="clustering.enabled config parameter is undefined",Pr=zt.min(0).required(),wa=hu.items({host:dr.required(),port:Pr}).empty(null),it;RS.exports={configValidator:LU,routesValidator:PU,route_constraints:wa};function LU(e){if(it=e.rootPath,Ca.isEmpty(it))throw CU;let t=ye.required(),r=F.valid("production","development").required(),s=zt.min(1).max(1e3).empty(null).default(MU),n=dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").empty(null).default(mS),i=F.custom(yU).messages({"any.custom":"{:#label} {:#error}"}).empty(null).default(mS),o=dr.pattern(/^[^\s.,*>]+$/).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >"}).empty(null),c=e.clustering?.enabled;if(Ca.isEmpty(c))throw wU;let _;return c===!0?_=F.object({enabled:t,hubServer:F.object({cluster:F.object({name:F.required().empty(null),network:F.object({port:Pr,routes:wa}).required()}).required(),leafNodes:F.object({network:F.object({port:Pr}).required()}).required(),network:F.object({port:Pr}).required()}).required(),leafServer:F.object({network:F.object({port:Pr,routes:wa}).required()}).required(),nodeName:o,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i,insecure:ye.required()}),user:F.string().required()}).required():_=F.object({enabled:t,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i,insecure:ye.required()})}).required(),F.object({clustering:_,customFunctions:F.object({enabled:t,network:F.object({cors:ye.required(),corsAccessList:hu.required(),headersTimeout:zt.min(1).required(),https:ye.required(),keepAliveTimeout:zt.min(1).required(),port:Pr,timeout:zt.min(1).required()}),nodeEnv:r,root:n,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i})}).required(),ipc:F.object({network:F.object({port:Pr})}).required(),localStudio:F.object({enabled:t}).required(),logging:F.object({file:ye.required(),level:F.valid("notify","fatal","error","warn","info","debug","trace"),rotation:F.object({compress:ye.required(),dateFormat:dr.required(),maxSize:dr.custom(DU).required(),retain:zt.min(0).required(),rotate:ye.required(),rotateInterval:dr.required(),rotateModule:ye.required(),timezone:dr.required(),workerInterval:zt.min(1).required()}).required(),root:n,stdStreams:ye.required(),auditLog:ye.required()}).required(),operationsApi:F.object({authentication:F.object({operationTokenTimeout:F.required(),refreshTokenTimeout:F.required()}).required(),foreground:ye.required(),network:F.object({cors:ye.required(),corsAccessList:hu.required(),headersTimeout:zt.min(1).required(),https:ye.required(),keepAliveTimeout:zt.min(1).required(),port:Pr,timeout:zt.min(1).required()}).required(),nodeEnv:r,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i})}).required(),rootPath:dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").required(),http:F.object({threads:s}).required(),storage:F.object({writeAsync:ye.required(),overlappingSync:ye.optional()}).required()}).validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}})}a(LU,"configValidator");function UU(e){return uU.existsSync(e)?null:`Specified path ${e} does not exist.`}a(UU,"doesPathExist");function yU(e,t){F.assert(e,dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+\.pem+$/).messages({"string.pattern.base":"must be a valid directory path and specify a .pem file"}));let r=UU(e);if(r)return t.message(r)}a(yU,"validatePemFile");function DU(e,t){let r=e.slice(-1);if(r!=="G"&&r!=="M"&&r!=="K")return t.message(IU);let s=e.slice(0,-1);if(isNaN(parseInt(s)))return t.message(bU)}a(DU,"validateRotationMaxSize");function MU(e,t){let r=t.state.path.join("."),s=lU.cpus().length,n=s-1;return n===1&&s===2&&(n=s),EU.info(`Detected ${s} cores on this machine, defaulting ${r} to ${n}`),n}a(MU,"setDefaultThreads");function mS(e,t){if(!Ca.isEmpty(t.original))return t.original;let r=t.state.path.join(".");if(Ca.isEmpty(it))throw new Error(`Error setting default root for: ${r}. HDB root is not defined`);switch(r){case"customFunctions.root":return qt.join(it,gU);case"logging.root":return qt.join(it,NU);case"operationsApi.tls.certificate":return qt.join(it,Er,hU);case"operationsApi.tls.privateKey":return qt.join(it,Er,SU);case"operationsApi.tls.certificateAuthority":return qt.join(it,Er,fU);case"customFunctions.tls.certificate":return qt.join(it,Er,TU);case"customFunctions.tls.privateKey":return qt.join(it,Er,mU);case"customFunctions.tls.certificateAuthority":return qt.join(it,Er,RU);case"clustering.tls.certificate":return qt.join(it,Er,AU);case"clustering.tls.privateKey":return qt.join(it,Er,OU);case"clustering.tls.certificateAuthority":return qt.join(it,Er,pU);default:throw new Error(`Error setting default root for config parameter: ${r}. Unrecognized config parameter`)}}a(mS,"setDefaultRoot");function PU(e){let t=F.object({routes:wa});return dU.validateBySchema({routes:e},t)}a(PU,"routesValidator")});var Sr=S((tJ,bS)=>{"use strict";var re=T(),It=b(),Qe=I(),{configValidator:BU,routesValidator:AS}=Su(),Ft=require("fs-extra"),vU=require("yaml"),Ws=require("path"),HU=require("is-number"),ya=require("properties-reader"),GU=require("lodash"),{handleHDBError:qU}=D(),{HTTP_STATUS_CODES:FU,HDB_ERROR_MSGS:La}=Ke(),{PACKAGE_ROOT:VU}=T(),kU="Unable to get config value because config is uninitialized",xU="Config successfully initialized",$U="Error backing up config file",YU="Empty parameter sent to getConfigValue",OS=Ws.join(VU,"config","yaml",re.HDB_DEFAULT_CONFIG_FILE),KU="Configuration successfully set. You must restart HarperDB for new config settings to take effect.",Ua,at;bS.exports={createConfigFile:QU,getDefaultConfig:WU,getConfigValue:pS,initConfig:NS,flattenConfig:us,updateConfigValue:gS,updateConfigObject:JU,getConfiguration:ZU,setConfiguration:XU,readConfigFile:mu,getClusteringRoutes:zU,initOldConfig:IS,getConfigFromFile:jU};function QU(e){let t=Js(OS);Ua=us(t.toJSON());for(let i in e){let o=re.CONFIG_PARAM_MAP[i.toLowerCase()];if(o!==void 0){let c=o.split("_"),_=fu(o,e[i]);try{t.setIn([...c],_)}catch(u){Qe.error(u)}}}Tu(t);let r=t.toJSON();at=us(r);let s=t.getIn(["rootPath"]),n=Ws.join(s,re.HDB_CONFIG_FILE);Ft.createFileSync(n),Ft.writeFileSync(n,String(t)),Qe.trace(`Config file written to ${n}`)}a(QU,"createConfigFile");function WU(e){if(Ua===void 0){let r=Js(OS);Ua=us(r.toJSON())}let t=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(t!==void 0)return Ua[t.toLowerCase()]}a(WU,"getDefaultConfig");function pS(e){if(It.isEmpty(e)){Qe.error(YU);return}if(at===void 0){Qe.trace(kU);return}let t=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(t!==void 0)return at[t.toLowerCase()]}a(pS,"getConfigValue");function NS(e=!1){if(at===void 0||e){let t=It.getPropsFilePath();try{Ft.accessSync(t,Ft.constants.F_OK|Ft.constants.R_OK)}catch(o){throw Qe.error(o),new Error(`HarperDB properties file at path ${t} does not exist`)}let s=ya(t).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),n;if(s.includes("config/settings.js"))try{IS(s);return}catch(o){if(o.code!==re.NODE_ERROR_CODES.ENOENT)throw o}try{n=Js(s)}catch(o){if(o.code===re.NODE_ERROR_CODES.ENOENT){Qe.trace(`HarperDB config file not found at ${s}. 
				This can occur during early stages of install where the config file has not yet been created`);return}else throw Qe.error(o),new Error(`Error reading HarperDB config file at ${s}`)}Tu(n);let i=n.toJSON();at=us(i),Qe.trace(xU)}}a(NS,"initConfig");function Tu(e){let t=e.toJSON(),r=BU(t);if(r.error)throw La.CONFIG_VALIDATION(r.error.message);e.setIn(["http","threads"],r.value.http.threads),e.setIn(["customFunctions","root"],r.value.customFunctions.root),e.setIn(["logging","root"],r.value.logging.root),e.setIn(["operationsApi","tls","certificate"],r.value.operationsApi.tls.certificate),e.setIn(["operationsApi","tls","privateKey"],r.value.operationsApi.tls.privateKey),e.setIn(["operationsApi","tls","certificateAuthority"],r.value.operationsApi.tls.certificateAuthority),e.setIn(["customFunctions","tls","certificate"],r.value.customFunctions.tls.certificate),e.setIn(["customFunctions","tls","privateKey"],r.value.customFunctions.tls.privateKey),e.setIn(["customFunctions","tls","certificateAuthority"],r.value.customFunctions.tls.certificateAuthority),e.setIn(["clustering","tls","certificate"],r.value.clustering.tls.certificate),e.setIn(["clustering","tls","privateKey"],r.value.clustering.tls.privateKey),e.setIn(["clustering","tls","certificateAuthority"],r.value.clustering.tls.certificateAuthority)}a(Tu,"validateConfig");function JU(e,t){at===void 0&&(at={});let r=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(r===void 0){Qe.trace(`Unable to update config object because config param '${e}' does not exist`);return}at[r.toLowerCase()]=t}a(JU,"updateConfigObject");function gS(e,t,r=void 0,s=!1,n=!1){at===void 0&&NS();let i=pS(re.CONFIG_PARAM_MAP.hdb_root),o=Ws.join(i,re.HDB_CONFIG_FILE),c=Js(o);if(r===void 0){let l=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(l===void 0)throw new Error(`Unable to update config, unrecognized config parameter: ${e}`);let E=l.split("_"),d=fu(l,t);c.setIn([...E],d)}else for(let l in r){let E=re.CONFIG_PARAM_MAP[l.toLowerCase()];if(E!==void 0){let d=E.split("_"),h=fu(E,r[l]);try{c.setIn([...d],h)}catch(m){Qe.error(m)}}}Tu(c);let _=c.getIn(["rootPath"]),u=Ws.join(_,re.HDB_CONFIG_FILE);if(s===!0)try{let l=Ws.join(_,"backup",`${re.HDB_CONFIG_FILE}.bak`);Ft.copySync(o,l),Qe.trace(`Config file: ${o} backed up to: ${l}`)}catch(l){Qe.error($U),Qe.error(l)}Ft.writeFileSync(u,String(c)),n&&(at=us(c.toJSON())),Qe.trace(`Config parameter: ${e} updated with value: ${t}`)}a(gS,"updateConfigValue");function us(e){let t={};for(let r in e)if(!!e.hasOwnProperty(r))if(typeof e[r]=="object"&&e[r]!==null&&!Array.isArray(e[r])){let s=us(e[r]);for(let n in s)!s.hasOwnProperty(n)||(t[r.toLowerCase()+"_"+n]=s[n])}else t[r.toLowerCase()]=e[r];return t}a(us,"flattenConfig");function fu(e,t){if(e===re.CONFIG_PARAMS.CLUSTERING_NODENAME||e===re.CONFIG_PARAMS.CLUSTERING_USER){if(!isNaN(t))return t.toString();if(typeof t=="string"&&t.toLowerCase()==="true"||typeof t=="string"&&t.toLowerCase()==="false")return t}else{if(HU(t))return parseFloat(t);if(t===!0||t===!1||Array.isArray(t)||It.isObject(t)||t===null)return t;if(typeof t=="string"&&t.toLowerCase()==="true")return!0;if(typeof t=="string"&&t.toLowerCase()==="false")return!1}if(t===void 0||t.toLowerCase()==="undefined")return null;if(typeof t=="string"&&(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")))try{return JSON.parse(t)}catch{}return It.autoCast(t)}a(fu,"castConfigValue");function ZU(){let e=It.getPropsFilePath(),r=ya(e).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY);return Js(r).toJSON()}a(ZU,"getConfiguration");async function XU(e){let{operation:t,hdb_user:r,hdb_auth_header:s,...n}=e;try{return gS(void 0,void 0,n,!0),KU}catch(i){throw typeof i=="string"||i instanceof String?qU(i,i,FU.BAD_REQUEST,void 0,void 0,!0):i}}a(XU,"setConfiguration");function mu(){let e=It.getPropsFilePath();try{Ft.accessSync(e,Ft.constants.F_OK|Ft.constants.R_OK)}catch(n){throw Qe.error(n),new Error(`HarperDB properties file at path ${e} does not exist`)}let r=ya(e).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY);return Js(r).toJSON()}a(mu,"readConfigFile");function Js(e){return vU.parseDocument(Ft.readFileSync(e,"utf8"),{simpleKeys:!0})}a(Js,"parseYamlDoc");function zU(){let e=mu(),t=e?.clustering?.hubServer?.cluster?.network?.routes;t=It.isEmptyOrZeroLength(t)?[]:t;let r=AS(t);if(r)throw La.CONFIG_VALIDATION(r.message);let s=e?.clustering?.leafServer?.network?.routes;s=It.isEmptyOrZeroLength(s)?[]:s;let n=AS(s);if(n)throw La.CONFIG_VALIDATION(n.message);if(!It.isEmptyOrZeroLength(s)&&!It.isEmptyOrZeroLength(t)){let i=t.filter(o=>s.some(c=>c.host===o.host&&c.port===o.port));if(!It.isEmptyOrZeroLength(i)){let o=`Duplicate hub and leaf routes found ${JSON.stringify(i)}`;throw La.CONFIG_VALIDATION(o)}}return{hub_routes:t,leaf_routes:s}}a(zU,"getClusteringRoutes");function IS(e){let t=ya(e);at={};for(let r in re.CONFIG_PARAM_MAP){let s=t.get(r.toUpperCase());if(It.isEmpty(s)||typeof s=="string"&&s.trim().length===0)continue;let n=re.CONFIG_PARAM_MAP[r].toLowerCase();n===re.CONFIG_PARAMS.LOGGING_ROOT?at[n]=Ws.dirname(s):at[n]=s}return at}a(IS,"initOldConfig");function jU(e){let t=mu();return GU.get(t,e.replaceAll("_","."))}a(jU,"getConfigFromFile")});var Y=S((rJ,wS)=>{"use strict";var Ru=require("fs-extra"),jt=require("path"),ey=require("os"),ty=require("properties-reader"),Qn=I(),Zs=b(),M=T(),Da=Sr(),ry="Error initializing environment manager",Ma="BOOT_PROPS_FILE_PATH",CS=!1,sy={[M.HDB_SETTINGS_NAMES.INSTALL_USER]:!0,[M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]:!0,[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]:!0,BOOT_PROPS_FILE_PATH:!0},fr={};wS.exports={BOOT_PROPS_FILE_PATH:Ma,getHdbBasePath:ny,setHdbBasePath:iy,get:ay,initSync:cy,setProperty:$,initTestEnvironment:_y};function ny(){return fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]}a(ny,"getHdbBasePath");function iy(e){fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=e}a(iy,"setHdbBasePath");function ay(e){let t=Da.getConfigValue(e);return t===void 0?fr[e]:t}a(ay,"get");function $(e,t){sy[e]&&(fr[e]=t),Da.updateConfigObject(e,t)}a($,"setProperty");function oy(){let e;try{e=Zs.getPropsFilePath(),Ru.accessSync(e,Ru.constants.F_OK|Ru.constants.R_OK),CS=!0;let t=ty(e);return fr[M.HDB_SETTINGS_NAMES.INSTALL_USER]=t.get(M.HDB_SETTINGS_NAMES.INSTALL_USER),fr[M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]=t.get(M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),fr[Ma]=e,!0}catch{return Qn.trace(`Environment manager found no properties file at ${e}`),!1}}a(oy,"doesPropFileExist");function cy(e=!1){try{(CS||oy())&&(Da.initConfig(e),fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=Da.getConfigValue(M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY))}catch(t){Qn.error(ry),Qn.error(t),console.error(t),process.exit(1)}}a(cy,"initSync");function _y(e={}){try{let{keep_alive_timeout:t,headers_timeout:r,server_timeout:s,https_enabled:n,cors_enabled:i,cors_accesslist:o,local_studio_on:c}=e,_=jt.join(__dirname,"../../","unitTests");fr[Ma]=jt.join(_,"hdb_boot_properties.file"),$(M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY,jt.join(_,"settings.test")),$(M.HDB_SETTINGS_NAMES.INSTALL_USER,ey.userInfo().username),$(M.HDB_SETTINGS_NAMES.PRIVATE_KEY_KEY,jt.join(_,"envDir","utility","keys","privateKey.pem")),$(M.HDB_SETTINGS_NAMES.CERT_KEY,jt.join(_,"envDir","utility","keys","certificate.pem")),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_TLS_PRIVATEKEY,jt.join(_,"envDir","utility","keys","privateKey.pem")),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_TLS_CERTIFICATE,jt.join(_,"envDir","utility","keys","certificate.pem")),$(M.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY,"debug"),$(M.HDB_SETTINGS_NAMES.LOG_PATH_KEY,jt.join(_,"envDir","log")),$(M.HDB_SETTINGS_NAMES.LOG_DAILY_ROTATE_KEY,!1),$(M.HDB_SETTINGS_NAMES.CLUSTERING_ENABLED_KEY,!0),$(M.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY,"1231412de213"),$(M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY,jt.join(_,"envDir")),$(M.HDB_SETTINGS_NAMES.HTTP_SECURE_ENABLED_KEY,Zs.isEmpty(n)?!0:n),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS,Zs.isEmpty(n)?!0:n),$(M.HDB_SETTINGS_NAMES.SERVER_PORT_KEY,9925),$(M.HDB_SETTINGS_NAMES.CORS_ENABLED_KEY,Zs.isEmpty(i)?!1:i),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_CORS,Zs.isEmpty(i)?!1:i),$(M.HDB_SETTINGS_NAMES.IPC_SERVER_PORT,9383),$(M.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES,2),$(M.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES,4),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY,9926),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY,!0),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY,jt.resolve(__dirname,"../../unitTests/server/customFunctions/custom_functions")),$(M.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON,Zs.isEmpty(c)?!1:c),o&&($("CORS_ACCESSLIST",o),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST,o)),s&&($(M.HDB_SETTINGS_NAMES.SERVER_TIMEOUT_KEY,s),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_TIMEOUT,s)),t&&($(M.HDB_SETTINGS_NAMES.SERVER_KEEP_ALIVE_TIMEOUT_KEY,t),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT,t)),r&&($(M.HDB_SETTINGS_NAMES.SERVER_HEADERS_TIMEOUT_KEY,r),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT,r))}catch(t){let r=`Error reading in HDB environment variables from path ${Ma}.  Please check your boot props and settings files`;Qn.fatal(r),Qn.error(t)}}a(_y,"initTestEnvironment")});var Z=S((nJ,FS)=>{"use strict";var Au=require("lmdb"),bt=require("fs-extra"),Vt=require("path"),Ba=_s(),LS=I(),De=Ke().LMDB_ERRORS_ENUM,va=uS(),Ou=ES(),US=hS(),Br=Ye(),sJ=T(),Wn=Y();Wn.initSync();var yS=Wn.get("STORAGE_WRITEASYNC")===!0||Wn.get("STORAGE_WRITEASYNC")==="true"||Wn.get("STORAGE_WRITEASYNC")==="TRUE",DS=Wn.get("STORAGE_OVERLAPPINGSYNC"),MS=1024*1024*1024,PS=1e4,BS=1e3,kt=Br.INTERNAL_DBIS_NAME,vS=Br.DBI_DEFINITION_NAME,uy="data.mdb",ly="lock.mdb",Jn=".mdb",Ey="-lock",Pa=class{constructor(t,r,s=!1){this.dbi=Ct(t,r),this.key_type=this.dbi[Br.DBI_DEFINITION_NAME].key_type,this.is_hash_attribute=this.dbi[Br.DBI_DEFINITION_NAME].is_hash_attribute,this.txn=t.beginTxn({readOnly:s===!1}),this.cursor=new Au.Cursor(this.txn,this.dbi)}close(){this.cursor.close(),this.txn.abort()}commit(){this.cursor.close(),this.txn.commit()}};a(Pa,"TransactionCursor");function pu(e,t){if(e===void 0)throw new Error(De.BASE_PATH_REQUIRED);if(t===void 0)throw new Error(De.ENV_NAME_REQUIRED)}a(pu,"pathEnvNameValidation");async function Nu(e,t,r=!0){try{await bt.access(e)}catch(s){throw s.code==="ENOENT"?new Error(De.INVALID_BASE_PATH):s}try{let s=Vt.join(e,t+Jn);return await bt.access(s,bt.constants.R_OK|bt.constants.F_OK),s}catch(s){if(s.code==="ENOENT")if(r)try{return await bt.access(Vt.join(e,t,uy),bt.constants.R_OK|bt.constants.F_OK),Vt.join(e,t)}catch(n){if(n.code==="ENOENT")throw new Error(De.INVALID_ENVIRONMENT)}else throw new Error(De.INVALID_ENVIRONMENT);throw s}}a(Nu,"validateEnvironmentPath");function Ha(e,t){if(Ba.validateEnv(e),t===void 0)throw new Error(De.DBI_NAME_REQUIRED)}a(Ha,"validateEnvDBIName");async function dy(e,t,r=!1,s=!1){pu(e,t),t=t.toString();try{return await Nu(e,t,s),gu(e,t,r)}catch(n){if(n.message===De.INVALID_ENVIRONMENT){let i=Vt.join(e,t);await bt.mkdirp(s?i:e);let o=new US(s?i:i+Jn,MS,PS,BS,!1,yS,DS),c=Au.open(o);c.dbis=Object.create(null);let _=new Ou(!1);c.openDB(kt,_),global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null));let u=Iu(e,t,r);return c[Br.ENVIRONMENT_NAME_KEY]=u,global.lmdb_map[u]=c,c}throw n}}a(dy,"createEnvironment");async function hy(e,t,r,s=!0){let n=await gu(e,t);if(r===void 0)throw new Error(De.DESTINATION_PATH_REQUIRED);try{await bt.access(Vt.dirname(r))}catch(i){throw i.code==="ENOENT"?new Error(De.INVALID_DESTINATION_PATH):i}await n.backup(r,s)}a(hy,"copyEnvironment");async function gu(e,t,r=!1){pu(e,t),t=t.toString();let s=Iu(e,t,r);if(global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null)),global.lmdb_map[s]!==void 0)return global.lmdb_map[s];let n=await Nu(e,t),i=Vt.join(e,t+Jn),o=n!=i,c=new US(n,MS,PS,BS,o,yS,DS),_=Au.open(c);_.dbis=Object.create(null);let u=GS(_);for(let l=0;l<u.length;l++)Ct(_,u[l]);return _[Br.ENVIRONMENT_NAME_KEY]=s,global.lmdb_map[s]=_,_}a(gu,"openEnvironment");async function Sy(e,t,r=!1){pu(e,t),t=t.toString();let s=Vt.join(e,t+Jn),n=await Nu(e,t);if(global.lmdb_map!==void 0){let i=Iu(e,t,r);if(global.lmdb_map[i]){let o=global.lmdb_map[i];await HS(o),delete global.lmdb_map[i]}}await bt.remove(n),await bt.remove(n===s?n+Ey:Vt.join(Vt.dirname(n),ly))}a(Sy,"deleteEnvironment");async function HS(e){Ba.validateEnv(e);let t=e[Br.ENVIRONMENT_NAME_KEY];await e.close(),t!==void 0&&global.lmdb_map!==void 0&&delete global.lmdb_map[t]}a(HS,"closeEnvironment");function Iu(e,t,r=!1){let n=`${Vt.basename(e)}.${t}`;return r===!0&&(n=`txn.${n}`),n}a(Iu,"getCachedEnvironmentName");function fy(e){Ba.validateEnv(e);let t=Object.create(null),r=Ct(e,kt);for(let{key:s,value:n}of r.getRange({start:!1}))if(s!==kt)try{t[s]=Object.assign(new va,n)}catch{LS.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return t}a(fy,"listDBIDefinitions");function GS(e){Ba.validateEnv(e);let t=[],r=Ct(e,kt);for(let{key:s}of r.getRange({start:!1}))s!==kt&&t.push(s);return t}a(GS,"listDBIs");function Ty(e,t){let s=Ct(e,kt).getEntry(t),n=new va;if(s!==void 0){try{n=Object.assign(n,s.value)}catch{LS.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return n}}a(Ty,"getDBIDefinition");function qS(e,t,r,s=!1){if(Ha(e,t),t=t.toString(),t===kt)throw new Error(De.CANNOT_CREATE_INTERNAL_DBIS_NAME);try{return Ct(e,t)}catch(n){if(n.message===De.DBI_DOES_NOT_EXIST){let i=new Ou(r,s===!0),o=e.openDB(t,i),c=new va(r===!0,s);return o[vS]=c,Ct(e,kt).putSync(t,c),e.dbis[t]=o,o}throw n}}a(qS,"createDBI");function Ct(e,t){if(Ha(e,t),t=t.toString(),e.dbis[t]!==void 0)return e.dbis[t];let r;if(t!==kt?r=Ty(e,t):r=new va,r===void 0)throw new Error(De.DBI_DOES_NOT_EXIST);let s;try{let n=new Ou(r.dup_sort,r.useVersions);if(s=e.openDB(t,n),s.db===void 0)throw new Error("MDB_NOTFOUND")}catch(n){throw n.message.includes("MDB_NOTFOUND")===!0?new Error(De.DBI_DOES_NOT_EXIST):n}return s[vS]=r,e.dbis[t]=s,s}a(Ct,"openDBI");function my(e,t){Ha(e,t),t=t.toString();let r=Ct(e,t),s=r.getStats();return r[Br.DBI_DEFINITION_NAME].is_hash_attribute&&s.entryCount>0&&s.entryCount--,s}a(my,"statDBI");async function Ry(e,t){try{let r=Vt.join(e,t+Jn);return(await bt.stat(r)).size}catch{throw new Error(De.INVALID_ENVIRONMENT)}}a(Ry,"environmentDataSize");function Ay(e,t){if(Ha(e,t),t=t.toString(),t===kt)throw new Error(De.CANNOT_DROP_INTERNAL_DBIS_NAME);Ct(e,t).dropSync(),e.dbis!==void 0&&delete e.dbis[t],Ct(e,kt).removeSync(t)}a(Ay,"dropDBI");function Oy(e,t,r){for(let s=0;s<r.length;s++){let n=r[s];if(!e.dbis[n])try{Ct(e,n)}catch(i){if(i.message===De.DBI_DOES_NOT_EXIST)qS(e,n,n!==t,n===t);else throw i}}}a(Oy,"initializeDBIs");FS.exports={openDBI:Ct,openEnvironment:gu,createEnvironment:dy,listDBIs:GS,listDBIDefinitions:fy,createDBI:qS,dropDBI:Ay,statDBI:my,deleteEnvironment:Sy,initializeDBIs:Oy,TransactionCursor:Pa,environmentDataSize:Ry,copyEnvironment:hy,closeEnvironment:HS}});var kS=S((iJ,VS)=>{"use strict";var Ga=class{constructor(t=[],r=[],s=void 0){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s}};a(Ga,"InsertRecordsResponseObject");VS.exports=Ga});var $S=S((aJ,xS)=>{"use strict";var qa=class{constructor(t=[],r=[],s=void 0,n=[]){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s,this.original_records=n}};a(qa,"UpdateRecordsResponseObject");xS.exports=qa});var KS=S((oJ,YS)=>{"use strict";var Fa=class{constructor(t=[],r=void 0,s=[]){this.written_hashes=t,this.txn_time=r,this.original_records=s}};a(Fa,"UpsertRecordsResponseObject");YS.exports=Fa});var Xs=S((lJ,WS)=>{"use strict";var py=Z(),Ny=kS(),gy=$S(),Iy=KS(),Xn=_s(),Zn=Ke().LMDB_ERRORS_ENUM,by=Ye(),vr=T(),Cy=b(),wy=require("uuid"),cJ=require("lmdb"),{handleHDBError:Ly,hdb_errors:Uy}=D(),{OVERFLOW_MARKER:_J,MAX_SEARCH_KEY_LENGTH:uJ}=by,bu=vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME,ls=vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function yy(e,t,r,s,n=!0){Uu(e,t,r,s),Cu(e,t,r);let i=new Ny,o=[],c=[];for(let _=0;_<s.length;_++){let u=s[_];QS(u,!0,n);let l=Dy(e,t,r,u),E=u[t];o.push(l),c.push(E)}return wu(o,c,s,i)}a(yy,"insertRecords");function Dy(e,t,r,s){let n=s[t];return e.dbis[t].ifNoExists(n,()=>{for(let i=0;i<r.length;i++){let o=r[i];if(o===t||s.hasOwnProperty(o)===!1)continue;let c=s[o];if(typeof c=="function"){let u=c([[{}]]);Array.isArray(u)&&(c=u[0][vr.FUNC_VAL],s[o]=c)}let _=Xn.getIndexedValues(c);if(_)for(let u=0,l=_.length;u<l;u++)e.dbis[o].put(_[u],n)}e.dbis[t].put(n,s,s[ls])})}a(Dy,"insertRecord");function My(e,t=[]){let r=0;for(let s=0;s<t.length;s++){let n=t[s];e.splice(n-r,1),r++}}a(My,"removeSkippedRecords");function QS(e,t,r=!0){let s=Date.now();(r===!0||!Number.isInteger(e[ls]))&&(e[ls]=s),t===!0?(r===!0||!Number.isInteger(e[bu]))&&(e[bu]=s):delete e[bu]}a(QS,"setTimestamps");function Cu(e,t,r){r.indexOf(vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME)<0&&r.push(vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.indexOf(vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)<0&&r.push(vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME),py.initializeDBIs(e,t,r)}a(Cu,"initializeTransaction");async function Py(e,t,r,s,n=!0){Uu(e,t,r,s),Cu(e,t,r);let i=new gy,o=[],c=[],_=[];for(let u=0;u<s.length;u++){let l=s[u],E=l[t],d;try{d=Lu(e,t,l,E,i,!0,n)}catch{i.skipped_hashes.push(E),o.push(u);continue}c.push(d),_.push(E)}return wu(c,_,s,i,o)}a(Py,"updateRecords");async function By(e,t,r,s,n=!0){try{Uu(e,t,r,s)}catch(_){throw Ly(_,_.message,Uy.HTTP_STATUS_CODES.BAD_REQUEST)}Cu(e,t,r);let i=new Iy,o=[],c=[];for(let _=0;_<s.length;_++){let u=s[_],l;Cy.isEmpty(u[t])?(l=wy.v4(),u[t]=l):l=u[t];let E=Lu(e,t,u,l,i,!1,n);o.push(E),c.push(l)}return wu(o,c,s,i)}a(By,"upsertRecords");async function wu(e,t,r,s,n=[]){let i=await Promise.all(e);for(let o=0,c=i.length;o<c;o++)i[o]===!0?s.written_hashes.push(t[o]):(s.skipped_hashes.push(t[o]),n.push(o));return s.txn_time=Xn.getMicroTime(),My(r,n),s}a(wu,"finalizeWrite");function Lu(e,t,r,s,n,i=!1,o=!0){let c=e.dbis[t],_=c.getEntry(s),u=_?.value,l=u;if(!u){if(i)return!1;u={}}if(QS(r,!l,o),Number.isInteger(r[ls])&&u[ls]>r[ls])return!1;l&&n.original_records.push(u);let E,d=a(()=>{for(let m in r){if(!r.hasOwnProperty(m)||m===t)continue;let R=r[m],w=e.dbis[m];if(w===void 0)continue;let L=u[m];if(typeof R=="function"){let z=R([[u]]);Array.isArray(z)&&(R=z[0][vr.FUNC_VAL],r[m]=R)}if(R===L)continue;let B=Xn.getIndexedValues(L);if(B)for(let z=0,V=B.length;z<V;z++)w.remove(B[z],s);if(B=Xn.getIndexedValues(R),B)for(let z=0,V=B.length;z<V;z++)w.put(B[z],s)}let h=Object.assign({},u,r);c.put(s,h,h[ls])},"do_put");return _?E=c.ifVersion(s,_.version,d):E=c.ifNoExists(s,d),E.then(h=>h?!0:Lu(e,t,r,s,n,i,o))}a(Lu,"updateUpsertRecord");function vy(e,t,r){if(Xn.validateEnv(e),t===void 0)throw new Error(Zn.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Zn.WRITE_ATTRIBUTES_REQUIRED):new Error(Zn.WRITE_ATTRIBUTES_MUST_BE_ARRAY)}a(vy,"validateBasic");function Uu(e,t,r,s){if(vy(e,t,r),!Array.isArray(s))throw s===void 0?new Error(Zn.RECORDS_REQUIRED):new Error(Zn.RECORDS_MUST_BE_ARRAY)}a(Uu,"validateWrite");WS.exports={insertRecords:yy,updateRecords:Py,upsertRecords:By}});var te=S((EJ,ZS)=>{"use strict";var yu=T(),zs=Y(),Du=require("path");zs.initSync();var Va,ka,xa;function JS(){if(Va!==void 0)return Va;if(zs.getHdbBasePath()!==void 0)return Va=Du.join(zs.getHdbBasePath(),yu.SCHEMA_DIR_NAME),Va}a(JS,"getBaseSchemaPath");function Hy(){if(ka!==void 0)return ka;if(zs.getHdbBasePath()!==void 0)return ka=Du.join(JS(),yu.SYSTEM_SCHEMA_NAME),ka}a(Hy,"getSystemSchemaPath");function Gy(){if(xa!==void 0)return xa;if(zs.getHdbBasePath()!==void 0)return xa=Du.join(zs.getHdbBasePath(),yu.TRANSACTIONS_DIR_NAME),xa}a(Gy,"getTransactionAuditStorePath");ZS.exports={getBaseSchemaPath:JS,getSystemSchemaPath:Hy,getTransactionAuditStorePath:Gy}});var Tr=S((dJ,jS)=>{"use strict";var zS=b(),XS=T(),Ya=/^[\x20-\x2E|\x30-\x5F|\x61-\x7E]*$/,Mu=require("joi"),$a={schema_format:{pattern:Ya,message:"names cannot include backticks or forward slashes"},schema_length:{maximum:250,tooLong:"cannot exceed 250 characters"}},qy=Mu.alternatives(Mu.string().min(1).max($a.schema_length.maximum).pattern(Ya).messages({"string.pattern.base":"{:#label} "+$a.schema_format.message}),Mu.number()).required();function Fy(e,t){return t?typeof t!="string"?`'${e}' must be a string`:t.length?t.length>$a.schema_length.maximum?`'${e}' maximum of 250 characters`:Ya.test(t)?"":`'${e}' has illegal characters`:`'${e}' must be at least one character`:`'${e}' is required`}a(Fy,"checkValidTable");function Vy(e,t){return zS.doesSchemaExist(e)?e:t.message(`Schema '${e}' does not exist`)}a(Vy,"validateSchemaExists");function ky(e,t){let r=t.state.ancestors[0].schema;return zS.doesTableExist(r,e)?e:t.message(`Table '${e}' does not exist`)}a(ky,"validateTableExists");function xy(e,t){return e.toLowerCase()===XS.SYSTEM_SCHEMA_NAME?t.message(`'subscriptions[${t.state.path[1]}]' invalid schema name, '${XS.SYSTEM_SCHEMA_NAME}' name is reserved`):e}a(xy,"validateSchemaName");jS.exports={common_validators:$a,schema_regex:Ya,hdb_schema_table:qy,validateSchemaExists:Vy,validateTableExists:ky,validateSchemaName:xy,checkValidTable:Fy}});var Ka=S((hJ,ef)=>{var{common_validators:Hr}=Tr(),zn=he(),xt="is required",X={schema:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},table:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},attribute:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},hash_attribute:{presence:!0,format:Hr.schema_format,length:Hr.schema_length}};function jn(e){for(let t in e)e[t]=e[t]===null||e[t]===void 0||typeof e[t]=="object"?e[t]:e[t].toString();return e}a(jn,"makeAttributesStrings");function $y(e){return e=jn(e),X.schema.presence={message:xt},X.table.presence=!1,X.attribute.presence=!1,X.hash_attribute.presence=!1,zn.validateObject(e,X)}a($y,"schema_object");function Yy(e){return e=jn(e),X.schema.presence={message:xt},X.table.presence={message:xt},X.attribute.presence=!1,X.hash_attribute.presence=!1,zn.validateObject(e,X)}a(Yy,"table_object");function Ky(e){return e=jn(e),X.schema.presence={message:xt},X.table.presence={message:xt},X.attribute.presence=!1,X.hash_attribute.presence={message:xt},zn.validateObject(e,X)}a(Ky,"create_table_object");function Qy(e){return e=jn(e),X.schema.presence={message:xt},X.table.presence={message:xt},X.attribute.presence={message:xt},X.hash_attribute.presence=!1,zn.validateObject(e,X)}a(Qy,"attribute_object");function Wy(e){return e=jn(e),X.schema.presence={message:xt},X.table.presence={message:xt},X.attribute.presence=!1,X.hash_attribute.presence=!1,zn.validateObject(e,X)}a(Wy,"describe_table");function Jy(e){if(!!e){if(!Array.isArray(e))throw new Error("residence must be a string array");if(e.length===0)throw new Error("residence cannot be an empty array");for(let t=0;t<e.length;t++)if(typeof e[t]!="string")throw new Error(`residence must be a string array, item '${e[t]}' is not a string`)}}a(Jy,"validateTableResidence");ef.exports={schema_object:$y,create_table_object:Ky,table_object:Yy,attribute_object:Qy,describe_table:Wy,validateTableResidence:Jy}});var rf=S((SJ,tf)=>{"use strict";var Zy=require("uuid"),Qa=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.attribute=s,this.id=n||Zy.v4(),this.schema_table=`${this.schema}.${this.table}`}};a(Qa,"CreateAttributeObject");tf.exports=Qa});var Ja=S((fJ,sf)=>{"use strict";var Xy=rf(),Wa=class extends Xy{constructor(t,r,s,n,i=!0,o=!1){super(t,r,s,n),this.dup_sort=i,this.is_hash_attribute=o}};a(Wa,"LMDBCreateAttributeObject");sf.exports=Wa});var af=S((TJ,nf)=>{"use strict";nf.exports=jy;var zy="inserted";function jy(e,t,r,s){let n={message:`${e} ${t.length} of ${r.records.length} records`,skipped_hashes:s};return e===zy?(n.inserted_hashes=t,n):(n.update_hashes=t,n)}a(jy,"returnObject")});var Za=S((mJ,cf)=>{"use strict";var eD=T(),Pu=Z(),tD=Xs(),{getSystemSchemaPath:rD,getBaseSchemaPath:sD}=te(),nD=require("path"),iD=is(),aD=Ka(),oD=Ja(),cD=af(),{handleHDBError:_D,hdb_errors:uD}=D(),lD=b(),Bu=iD.hdb_attribute,of=[];for(let e=0;e<Bu.attributes.length;e++)of.push(Bu.attributes[e].attribute);var ED="inserted";cf.exports=dD;async function dD(e){let t=aD.attribute_object(e);if(t)throw _D(new Error,t.message,uD.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);e.is_hash_attribute=e.is_hash_attribute=="true",e.dup_sort=lD.isEmpty(e.dup_sort)||e.dup_sort=="true";let r=[];if(global.hdb_schema[e.schema]&&global.hdb_schema[e.schema][e.table]&&(r=global.hdb_schema[e.schema][e.table].attributes),Array.isArray(r)&&r.length>0){for(let n of r)if(n.attribute===e.attribute)throw new Error(`attribute '${n.attribute}' already exists in ${e.schema}.${e.table}`)}let s=new oD(e.schema,e.table,e.attribute,e.id);try{let n=await Pu.openEnvironment(nD.join(sD(),e.schema.toString()),e.table);if(n.dbis[e.attribute]!==void 0)throw new Error(`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`);Pu.createDBI(n,e.attribute,e.dup_sort,e.is_hash_attribute);let i=await Pu.openEnvironment(rD(),eD.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),{written_hashes:o,skipped_hashes:c}=await tD.insertRecords(i,Bu.hash_attribute,of,[s]);return cD(ED,o,{records:[s]},c)}catch(n){throw n}}a(dD,"lmdbCreateAttribute")});var Hu=S((RJ,uf)=>{var{hdb_schema_table:_f}=Tr(),hD=he(),vu=require("joi"),SD={undefined:"undefined",null:"null"},fD=a((e,t)=>{let r=Object.keys(e),s=r.length,n;for(let i=0;i<s;i++){let o=r[i];(!o||o.length===0||SD[o]!==void 0)&&(n===void 0?n=`Invalid attribute name: '${o}'`:n+=`. Invalid attribute name: '${o}'`)}return n?t.message(n):e},"custom_records_val"),TD=vu.object({schema:_f,table:_f,records:vu.array().items(vu.object().custom(fD)).required()});uf.exports=function(e){return hD.validateBySchema(e,TD)}});var Xa=S((OJ,Ef)=>{"use strict";var mr=b(),lf=I(),AJ=Hu();Ef.exports=mD;function mD(e){if(mr.isEmpty(e))throw new Error("invalid update parameters defined.");if(mr.isEmptyOrZeroLength(e.schema))throw new Error("invalid schema specified.");if(mr.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");if(!Array.isArray(e.records))throw new Error("records must be an array");let t=global.hdb_schema[e.schema][e.table];if(mr.isEmpty(t))throw new Error(`could not retrieve schema:${e.schema} and table ${e.table}`);let r=t.hash_attribute,s=new Set,n={},i=!1;return e.operation==="update"&&(i=!0),e.records.forEach(o=>{if(i&&mr.isEmptyOrZeroLength(o[r]))throw lf.error("a valid hash attribute must be provided with update record:",o),new Error("a valid hash attribute must be provided with update record, check log for more info");if(!mr.isEmptyOrZeroLength(o[r])&&(o[r]==="null"||o[r]==="undefined"))throw lf.error(`a valid hash value must be provided with ${e.operation} record:`,o),new Error(`Invalid hash value: '${o[r]}' is not a valid hash attribute value, check log for more info`);!mr.isEmpty(o[r])&&o[r]!==""&&s.has(mr.autoCast(o[r]))&&(o.skip=!0),s.add(mr.autoCast(o[r]));for(let c in o)n[c]=1}),n[r]=1,{schema_table:t,hashes:Array.from(s),attributes:Object.keys(n)}}a(mD,"insertUpdateValidate")});var ei=S((pJ,df)=>{"use strict";var RD=T().OPERATIONS_ENUM,za=class{constructor(t,r,s,n,i=void 0){this.operation=RD.INSERT,this.schema=t,this.table=r,this.hash_attribute=s,this.records=n,this.__origin=i}};a(za,"InsertObject");df.exports=za});var eo=S((gJ,hf)=>{"use strict";var NJ=ei(),ja=T(),qu=b(),Gu=I(),AD=require("uuid"),{handleHDBError:ti,hdb_errors:OD}=D(),{HDB_ERROR_MSGS:ri,HTTP_STATUS_CODES:si}=OD;hf.exports=pD;function pD(e,t,r){for(let n=0;n<t.length;n++)ND(t[n]);let{records:s}=e;for(let n=0;n<s.length;n++){let i=s[n];gD(i,r,e.operation)}}a(pD,"processRows");function ND(e){if(Buffer.byteLength(String(e))>ja.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw ti(new Error,ri.ATTR_NAME_LENGTH_ERR(e),si.BAD_REQUEST,void 0,void 0,!0);if(qu.isEmptyOrZeroLength(e)||qu.isEmpty(e.trim()))throw ti(new Error,ri.ATTR_NAME_NULLISH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}a(ND,"validateAttribute");function gD(e,t,r){if(!e.hasOwnProperty(t)||qu.isEmptyOrZeroLength(e[t])){if(r===ja.OPERATIONS_ENUM.INSERT||r===ja.OPERATIONS_ENUM.UPSERT){e[t]=AD.v4();return}throw Gu.error("Update transaction aborted due to record with no hash value:",e),ti(new Error,ri.RECORD_MISSING_HASH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}if(Buffer.byteLength(String(e[t]))>ja.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Gu.error(e),ti(new Error,ri.HASH_VAL_LENGTH_ERR,si.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e[t])&&e[t].includes("/"))throw Gu.error(e),ti(new Error,ri.INVALID_FORWARD_SLASH_IN_HASH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}a(gD,"validateHash")});var ff=S((IJ,Sf)=>{"use strict";var to=class{constructor(t,r){this.type=t,this.message=r}};a(to,"IPCEventObject");Sf.exports=to});var Gr=S((bJ,Tf)=>{"use strict";var ID=I(),Fu=b(),bD=T(),{IPC_ERRORS:ni}=Ke();Tf.exports={sendIpcEvent:CD,validateEvent:wD,SchemaEventMsg:LD,UserEventMsg:UD};function CD(e){global.hdb_ipc?global.hdb_ipc.emitToServer(e):ID.warn("Tried to send event:",e,"to HDB IPC client but it does not exist")}a(CD,"sendIpcEvent");function wD(e){if(typeof e!="object")return ni.INVALID_IPC_DATA_TYPE;if(!e.hasOwnProperty("type")||Fu.isEmpty(e.type))return ni.MISSING_TYPE;if(!e.hasOwnProperty("message")||Fu.isEmpty(e.message))return ni.MISSING_MSG;if(!e.message.hasOwnProperty("originator")||Fu.isEmpty(e.message.originator))return ni.MISSING_ORIGIN;if(bD.IPC_EVENT_TYPES[e.type.toUpperCase()]===void 0)return ni.INVALID_EVENT(e.type)}a(wD,"validateEvent");function LD(e,t,r,s=void 0,n=void 0){this.originator=e,this.operation=t,this.schema=r,this.table=s,this.attribute=n}a(LD,"SchemaEventMsg");function UD(e){this.originator=e}a(UD,"UserEventMsg")});var js=S((wJ,Of)=>{"use strict";var mf=T(),CJ=b(),ro=I(),Rf=ff(),{sendIpcEvent:Af}=Gr();function yD(e){try{ro.trace("signalSchemaChange called with message:",e);let t=new Rf(mf.IPC_EVENT_TYPES.SCHEMA,e);Af(t)}catch(t){ro.error(t)}}a(yD,"signalSchemaChange");function DD(e){try{ro.trace("signalUserChange called with message:",e);let t=new Rf(mf.IPC_EVENT_TYPES.USER,e);Af(t)}catch(t){ro.error(t)}}a(DD,"signalUserChange");Of.exports={signalSchemaChange:yD,signalUserChange:DD}});var so=S((LJ,Nf)=>{"use strict";var pf=b(),MD=T(),PD=I(),BD=Za(),vD=Ja(),HD=js(),{SchemaEventMsg:GD}=Gr(),qD="already exists in";Nf.exports=FD;async function FD(e,t,r){try{if(pf.isEmptyOrZeroLength(r))return r;let s=[];pf.isEmptyOrZeroLength(t.attributes)||t.attributes.forEach(i=>{s.push(i.attribute)});let n=r.filter(i=>s.indexOf(i)<0);return n.length===0||await Promise.all(n.map(async i=>{await VD(e,t.schema,t.name,i)})),n}catch(s){throw s}}a(FD,"lmdbCheckForNewAttributes");async function VD(e,t,r,s){let n=new vD(t,r,s,void 0,!0);e&&(n.hdb_auth_header=e);try{await kD(n)}catch(i){if(typeof i=="object"&&i.message!==void 0&&i.message.includes(qD))PD.warn(`attribute ${t}.${r}.${s} already exists`);else throw i}}a(VD,"createNewAttribute");async function kD(e){let t;try{return t=await BD(e),HD.signalSchemaChange(new GD(process.pid,MD.OPERATIONS_ENUM.CREATE_ATTRIBUTE,e.schema,e.table,e.attribute)),t}catch(r){throw r}}a(kD,"createAttribute")});var en=S((UJ,gf)=>{"use strict";var no=class{constructor(t,r,s,n,i=void 0){this.operation=t,this.user_name=r,this.timestamp=s,this.hash_values=n,this.origin=i}};a(no,"LMDBTransactionObject");gf.exports=no});var bf=S((yJ,If)=>{"use strict";var xD=en(),$D=T().OPERATIONS_ENUM,io=class extends xD{constructor(t,r,s,n,i=void 0){super($D.INSERT,r,s,n,i),this.records=t}};a(io,"LMDBInsertTransactionObject");If.exports=io});var wf=S((DJ,Cf)=>{"use strict";var YD=en(),KD=T().OPERATIONS_ENUM,ao=class extends YD{constructor(t,r,s,n,i,o=void 0){super(KD.UPDATE,s,n,i,o),this.records=t,this.original_records=r}};a(ao,"LMDBUpdateTransactionObject");Cf.exports=ao});var Uf=S((MJ,Lf)=>{"use strict";var QD=en(),WD=T().OPERATIONS_ENUM,oo=class extends QD{constructor(t,r,s,n,i,o=void 0){super(WD.UPSERT,s,n,i,o),this.records=t,this.original_records=r}};a(oo,"LMDBUpsertTransactionObject");Lf.exports=oo});var Df=S((PJ,yf)=>{"use strict";var JD=en(),ZD=T().OPERATIONS_ENUM,co=class extends JD{constructor(t,r,s,n,i=void 0){super(ZD.DELETE,s,n,t,i),this.original_records=r}};a(co,"LMDBDeleteTransactionObject");yf.exports=co});var ii=S((BJ,vf)=>{"use strict";var XD=require("path"),Mf=Z(),zD=bf(),jD=wf(),eM=Uf(),tM=Df(),tn=Ye(),Pf=b(),{CONFIG_PARAMS:rM}=T(),Bf=Y();Bf.initSync();var _o=T().OPERATIONS_ENUM,{getTransactionAuditStorePath:sM}=te();vf.exports=nM;async function nM(e,t){if(Bf.get(rM.LOGGING_AUDITLOG)===!1)return;let r=XD.join(sM(),e.schema.toString()),s=await Mf.openEnvironment(r,e.table,!0),n=iM(e,t);if(!(n===void 0||n.hash_values.length===0)&&s!==void 0){Mf.initializeDBIs(s,tn.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,tn.TRANSACTIONS_DBIS);try{let i=n.timestamp;return await s.dbis[tn.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].ifNoExists(i,()=>{s.dbis[tn.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].put(i,n),Pf.isEmpty(n.user_name)||s.dbis[tn.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].put(n.user_name,i);for(let o=0;o<n.hash_values.length;o++)s.dbis[tn.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].put(n.hash_values[o],i)})}catch(i){throw i}}}a(nM,"writeTransaction");function iM(e,t){let r=Pf.isEmpty(e.hdb_user)?void 0:e.hdb_user.username;if(e.operation===_o.INSERT)return new zD(e.records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.UPDATE)return new jD(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.UPSERT)return new eM(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.DELETE)return new tM(t.deleted,t.original_records,r,t.txn_time,e.__origin)}a(iM,"createTransactionObject")});var Vu=S((HJ,Hf)=>{"use strict";var aM=Xa(),vJ=ei(),rn=T(),oM=eo(),cM=Xs().insertRecords,_M=Z(),uM=require("path"),lM=I(),EM=so(),{getBaseSchemaPath:dM}=te(),hM=ii();Hf.exports=SM;async function SM(e){try{let{schema_table:t,attributes:r}=aM(e);oM(e,r,t.hash_attribute),e.schema!==rn.SYSTEM_SCHEMA_NAME&&(r.includes(rn.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(rn.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(rn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(rn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await EM(e.hdb_auth_header,t,r),n=uM.join(dM(),e.schema.toString()),i=await _M.openEnvironment(n,e.table),o=await cM(i,t.hash_attribute,r,e.records,e[rn.CLUSTERING_FLAG]!==!0);try{await hM(e,o)}catch(c){lM.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(SM,"lmdbCreateRecords")});var Ff=S((GJ,qf)=>{"use strict";var Gf=T(),fM=Vu(),TM=ei(),mM=require("fs-extra"),RM=require("path"),{getBaseSchemaPath:AM}=te();qf.exports=OM;async function OM(e){let t=[{name:e.schema,createddate:Date.now()}],r=new TM(Gf.SYSTEM_SCHEMA_NAME,Gf.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,void 0,t);await fM(r),await mM.mkdirp(RM.join(AM(),e.schema.toString()))}a(OM,"lmdbCreateSchema")});var kf=S((qJ,Vf)=>{"use strict";var uo=class{constructor(t=[],r=[],s=void 0,n=[]){this.deleted=t,this.skipped=r,this.txn_time=s,this.original_records=n}};a(uo,"DeleteRecordsResponseObject");Vf.exports=uo});var $u=S((xJ,Yf)=>{"use strict";var xf=Z(),ku=_s(),xu=Ke().LMDB_ERRORS_ENUM,pM=Ye(),$f=I(),FJ=b(),NM=require("lmdb"),gM=kf(),{OVERFLOW_MARKER:VJ,MAX_SEARCH_KEY_LENGTH:kJ}=pM;async function IM(e,t,r){if(ku.validateEnv(e),t===void 0)throw new Error(xu.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(xu.IDS_REQUIRED):new Error(xu.IDS_MUST_BE_ARRAY);try{let s=xf.listDBIs(e);xf.initializeDBIs(e,t,s);let n=new gM,i,o=[],c=[];for(let E=0,d=r.length;E<d;E++)try{i=r[E];let h=e.dbis[t].get(i);if(!h){n.skipped.push(i);continue}let m=e.dbis[t].ifVersion(i,NM.IF_EXISTS,()=>{e.dbis[t].remove(i);for(let R=0;R<s.length;R++){let w=s[R];if(!h.hasOwnProperty(w)||w===t)continue;let L=e.dbis[w],B=h[w];if(B!=null)try{let z=ku.getIndexedValues(B);if(z)for(let V=0,W=z.length;V<W;V++)L.remove(z[V],i)}catch{$f.warn(`cannot delete from attribute: ${w}, ${B}:${i}`)}}});o.push(m),c.push(i),n.original_records.push(h)}catch(h){$f.warn(h),n.skipped.push(i)}let _=[],u=await Promise.all(o);for(let E=0,d=u.length;E<d;E++)u[E]===!0?n.deleted.push(c[E]):(n.skipped.push(c[E]),_.push(E));let l=0;for(let E=0;E<_.length;E++){let d=_[E];n.original_records.splice(d-l,1),l++}return n.txn_time=ku.getMicroTime(),n}catch(s){throw s}}a(IM,"deleteRecords");Yf.exports={deleteRecords:IM}});var ai=S(($J,Qf)=>{"use strict";var sn=b(),bM=$u(),CM=Z(),wM=require("path"),{getBaseSchemaPath:LM}=te(),UM=ii(),yM=I();Qf.exports=DM;async function DM(e,t=!0){let s=global.hdb_schema[e.schema][e.table].hash_attribute;if(sn.isEmpty(s))throw new Error(`could not retrieve hash attribute for schema:${e.schema} and table ${e.table}`);try{if(sn.isEmptyOrZeroLength(e.hash_values)&&!sn.isEmptyOrZeroLength(e.records)){e.hash_values=[];for(let c=0;c<e.records.length;c++){let _=e.records[c][s];sn.isEmpty(_)||e.hash_values.push(_)}}if(sn.isEmptyOrZeroLength(e.hash_values))return Kf([],[]);if(!Array.isArray(e.hash_values))throw new Error("hash_values must be an array");if(sn.isEmptyOrZeroLength(e.records)){e.records=[];for(let c=0;c<e.hash_values.length;c++)e.records[c]={[s]:e.hash_values[c]}}let n=wM.join(LM(),e.schema.toString()),i=await CM.openEnvironment(n,e.table),o=await bM.deleteRecords(i,s,e.hash_values);try{t===!0&&await UM(e,o)}catch(c){yM.error(`unable to write transaction due to ${c.message}`)}return Kf(o.deleted,o.skipped,o.txn_time)}catch(n){throw n}}a(DM,"lmdbDeleteRecords");function Kf(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}a(Kf,"createDeleteResponse")});var Ku=S((KJ,Wf)=>{"use strict";var MM=T(),YJ=_s();function Yu(e,t){let r=Object.create(null);if(t.length===1&&MM.SEARCH_WILDCARDS.indexOf(t[0])>=0)Object.assign(r,e);else for(let s=0;s<t.length;s++){let n=t[s],i=e[n];r[n]=i===void 0?null:i}return r}a(Yu,"parseRow");function PM(e,t,r,s){let n=Yu(r,e);s.push(n)}a(PM,"searchAll");function BM(e,t,r,s){let n=Yu(r,e);s[t]=n}a(BM,"searchAllToMap");function vM(e,t,r){r[e]===void 0&&(r[e]=[]),r[e].push(t)}a(vM,"iterateDBI");function Es(e,t,r,s,n){let i=Object.create(null);i[n]=e;let o;s===n?o=e:(o=t,s!==void 0&&(i[s]=o)),r[0].push(o),r[1].push(i)}a(Es,"pushResults");function HM(e,t,r,s,n,i){t.toString().endsWith(e)&&Es(t,r,s,n,i)}a(HM,"endsWith");function GM(e,t,r,s,n,i){t.toString().includes(e)&&Es(t,r,s,n,i)}a(GM,"contains");function qM(e,t,r,s,n,i){t>e&&Es(t,r,s,n,i)}a(qM,"greaterThanCompare");function FM(e,t,r,s,n,i){t>=e&&Es(t,r,s,n,i)}a(FM,"greaterThanEqualCompare");function VM(e,t,r,s,n,i){t<e&&Es(t,r,s,n,i)}a(VM,"lessThanCompare");function kM(e,t,r,s,n,i){t<=e&&Es(t,r,s,n,i)}a(kM,"lessThanEqualCompare");Wf.exports={parseRow:Yu,searchAll:PM,searchAllToMap:BM,iterateDBI:vM,endsWith:HM,contains:GM,greaterThanCompare:qM,greaterThanEqualCompare:FM,lessThanCompare:VM,lessThanEqualCompare:kM,pushResults:Es}});var nn=S((JJ,eT)=>{"use strict";var wt=Z(),xM=I(),ft=_s(),qr=Ye(),ce=Ke().LMDB_ERRORS_ENUM,QJ=b(),$M=T(),$t=Ku(),WJ=require("lmdb"),{OVERFLOW_MARKER:Jf,MAX_SEARCH_KEY_LENGTH:YM}=qr,oi={lazy:!0};function Zf(e,t,r,s,n=!1,i=void 0,o=void 0){let c=Object.create(null),_=wt.openDBI(e,r);_[qr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let u=Qu(e,t,r);for(let{key:l,value:E}of _.getRange({start:n?void 0:!1,end:n?!1:void 0,limit:i,offset:o,reverse:n}))s(u(l,E),E,c,t,r);return c}a(Zf,"iterateFullIndex");function ci(e,t,r,s,n,i=!1,o=void 0,c=void 0,_=!1,u=!1){let l=[[],[]],E=wt.openDBI(e,r),d=Qu(e,t,r);E[qr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let h=i===!0?s:n,m=i===!0?n:s,R=i===!0?!_:!u,w=i===!0?u:_;for(let{key:L,value:B}of E.getRange({start:m,end:h,reverse:i,limit:o,offset:c,inclusiveEnd:R,exclusiveStart:w}))$t.pushResults(d(L,B),B,l,t,r);return l}a(ci,"iterateRangeBetween");function Qu(e,t,r){let s;return function(n,i){if(typeof n=="string"&&n.endsWith(Jf)){if(!s)if(t)s=wt.openDBI(e,t);else{let c=wt.listDBIs(e);for(let _=0,u=c.length;_<u&&(s=wt.openDBI(e,c[_]),!s[qr.DBI_DEFINITION_NAME].is_hash_attribute);_++);}n=s.get(i,oi)[r]}return n}}a(Qu,"getOverflowCheck");function KM(e,t,r,s=!1,n=void 0,i=void 0){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);lo(r),r=_i(e,r);let o=[],c=wt.openDBI(e,t);for(let{key:_,value:u}of c.getRange({start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}))$t.searchAll(r,_,u,o);return o}a(KM,"searchAll");function QM(e,t,r,s=!1,n=void 0,i=void 0){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);return lo(r),r=_i(e,r),Zf(e,t,t,$t.searchAllToMap.bind(null,r),s,n,i)}a(QM,"searchAllToMap");function WM(e,t,r=!1,s=void 0,n=void 0){if(ft.validateEnv(e),t===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);return Zf(e,void 0,t,$t.iterateDBI,r,s,n)}a(WM,"iterateDBI");function JM(e,t){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);return wt.statDBI(e,t).entryCount}a(JM,"countAll");function ZM(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=wt.openDBI(e,r);s=ft.convertKeyValueToWrite(s);let _=[[],[]];if(c[qr.DBI_DEFINITION_NAME].is_hash_attribute){t=r;let u=c.get(s,oi);u!==void 0&&$t.pushResults(s,u,_,t,r)}else for(let u of c.getValues(s,{reverse:n,limit:i,offset:o}))$t.pushResults(s,u,_,t,r);return _}a(ZM,"equals");function XM(e,t,r){return Fr(e,t,r),wt.openDBI(e,t).getValuesCount(r)}a(XM,"count");function zM(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=[[],[]],_=wt.openDBI(e,r);_[qr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r),s=ft.convertKeyValueToWrite(s);let u=!0;if(typeof s=="number"&&(u=!1),n===!0){let l;for(let E of _.getKeys({start:s}))if(!E.startsWith(s)){l=E;break}l!==void 0&&(Number.isInteger(o)?o++:i++);for(let{key:E,value:d}of _.getRange({start:l,end:void 0,reverse:n,limit:i,offset:o}))if(E!==l){if(E.toString().startsWith(s))$t.pushResults(E,d,c,t,r);else if(u===!0)break}}else for(let{key:l,value:E}of _.getRange({start:s,reverse:n,limit:i,offset:o}))if(l.toString().startsWith(s))$t.pushResults(l,E,c,t,r);else if(u===!0)break;return c}a(zM,"startsWith");function jM(e,t,r,s,n=!1,i=void 0,o=void 0){return Xf(e,t,r,s,n,i,o,!0)}a(jM,"endsWith");function Xf(e,t,r,s,n=!1,i=void 0,o=void 0,c=!1){Fr(e,r,s);let _=[[],[]],u=wt.openDBI(e,r);u[qr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let l=Qu(e,t,r);o=Number.isInteger(o)?o:0;for(let d of u.getKeys({end:n?!1:void 0,reverse:n})){if(i===0)break;let h=d.toString();if(h.endsWith(Jf))for(let m of u.getValues(d)){let R=l(d,m);(c?R.endsWith(s):R.includes(s))&&E(R,m)}else if(c?h.endsWith(s):h.includes(s))if(u[qr.DBI_DEFINITION_NAME].is_hash_attribute)E(d,d);else for(let m of u.getValues(d))E(d,m)}function E(d,h){if(o>0){o--;return}i!==0&&($t.pushResults(d,h,_,t,r),i--)}return a(E,"found_match"),_}a(Xf,"contains");function eP(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=typeof s,_;return c==="string"?_="\uFFFF":c==="number"?_=1/0:c==="boolean"&&(_=!0),ci(e,t,r,s,_,n,i,o,!0,!1)}a(eP,"greaterThan");function tP(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=typeof s,_;return c==="string"?_="\uFFFF":c==="number"?_=1/0:c==="boolean"&&(_=!0),ci(e,t,r,s,_,n,i,o,!1,!1)}a(tP,"greaterThanEqual");function rP(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=typeof s,_;return c==="string"?_="\0":c==="number"?_=-1/0:c==="boolean"&&(_=!1),ci(e,t,r,_,s,n,i,o,!1,!0)}a(rP,"lessThan");function sP(e,t,r,s,n=!1,i=void 0,o=void 0){Fr(e,r,s);let c=typeof s,_;return c==="string"?_="\0":c==="number"?_=-1/0:c==="boolean"&&(_=!1),ci(e,t,r,_,s,n,i,o,!1,!1)}a(sP,"lessThanEqual");function nP(e,t,r,s,n,i=!1,o=void 0,c=void 0){if(ft.validateEnv(e),r===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);if(s===void 0)throw new Error(ce.START_VALUE_REQUIRED);if(n===void 0)throw new Error(ce.END_VALUE_REQUIRED);if(s=ft.convertKeyValueToWrite(s),n=ft.convertKeyValueToWrite(n),s>n)throw new Error(ce.END_VALUE_MUST_BE_GREATER_THAN_START_VALUE);return ci(e,t,r,s,n,i,o,c)}a(nP,"between");function iP(e,t,r,s){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(lo(r),r=_i(e,r),s===void 0)throw new Error(ce.ID_REQUIRED);let n=null,i=e.dbis[t].get(s,r.length<3?oi:void 0);return i&&(n=$t.parseRow(i,r)),n}a(iP,"searchByHash");function aP(e,t,r){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(ce.ID_REQUIRED);let s=!0;return e.dbis[t].get(r,oi)===void 0&&(s=!1),s}a(aP,"checkHashExists");function oP(e,t,r,s,n=[]){jf(e,t,r,s,n);let i=zf(e,t,r,s,n);return Object.values(i)}a(oP,"batchSearchByHash");function cP(e,t,r,s,n=[]){return jf(e,t,r,s,n),zf(e,t,r,s,n)}a(cP,"batchSearchByHashToMap");function zf(e,t,r,s,n=[]){r=_i(e,r);let i=Object.create(null),o=r.length<3?oi:void 0;for(let c=0;c<s.length;c++){let _=s[c];try{let u=e.dbis[t].get(_,o);if(u){let l=$t.parseRow(u,r);i[_]=l}else n.push(_)}catch(u){throw xM.warn(u),u}}return i}a(zf,"batchHashSearch");function jf(e,t,r,s,n){if(ft.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(lo(r),!Array.isArray(s))throw s===void 0?new Error(ce.IDS_REQUIRED):new Error(ce.IDS_MUST_BE_ARRAY);Array.isArray(n)||(n=[])}a(jf,"initializeBatchSearchByHash");function lo(e){if(!Array.isArray(e))throw e===void 0?new Error(ce.FETCH_ATTRIBUTES_REQUIRED):new Error(ce.FETCH_ATTRIBUTES_MUST_BE_ARRAY)}a(lo,"validateFetchAttributes");function Fr(e,t,r){if(ft.validateEnv(e),t===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(ce.SEARCH_VALUE_REQUIRED);if(r?.length>YM)throw new Error(ce.SEARCH_VALUE_TOO_LARGE)}a(Fr,"validateComparisonFunctions");function _i(e,t){return t.length===1&&$M.SEARCH_WILDCARDS.indexOf(t[0])>=0&&(t=wt.listDBIs(e)),t}a(_i,"setGetWholeRowAttributes");eT.exports={searchAll:KM,searchAllToMap:QM,count:XM,countAll:JM,equals:ZM,startsWith:zM,endsWith:jM,contains:Xf,searchByHash:iP,setGetWholeRowAttributes:_i,batchSearchByHash:oP,batchSearchByHashToMap:cP,checkHashExists:aP,iterateDBI:WM,greaterThan:eP,greaterThanEqual:tP,lessThan:rP,lessThanEqual:sP,between:nP}});var ui=S((XJ,nT)=>{var tT=require("lodash"),rT=he(),Q=require("joi"),_P=b(),{hdb_schema_table:Yt,checkValidTable:sT}=Tr(),{handleHDBError:uP,hdb_errors:lP}=D(),{HTTP_STATUS_CODES:EP}=lP,ZJ=Q.object({schema:Yt,table:Yt,hash_values:Q.array().min(1).items(Q.alternatives(Q.string(),Q.number())).required(),get_attributes:Q.array().min(1).items(Yt).required()}),dP=Q.object({schema:Yt,table:Yt,search_attribute:Yt,search_value:Q.any().required(),get_attributes:Q.array().min(1).items(Yt).required(),desc:Q.bool(),limit:Q.number().integer().min(1),offset:Q.number().integer().min(0)}),hP=Q.object({schema:Yt,table:Yt,operator:Q.string().valid("and","or").default("and").lowercase(),offset:Q.number().integer().min(0),limit:Q.number().integer().min(1),get_attributes:Q.array().min(1).items(Yt).required(),conditions:Q.array().min(1).items(Q.object({search_attribute:Yt,search_type:Q.string().valid("equals","contains","starts_with","ends_with","greater_than","greater_than_equal","less_than","less_than_equal","between").required(),search_value:Q.when("search_type",{switch:[{is:"equals",then:Q.any()},{is:"between",then:Q.array().items(Q.alternatives([Q.string(),Q.number()])).length(2)}],otherwise:Q.alternatives(Q.string(),Q.number())}).required()})).required()});nT.exports=function(e,t){let r=null;switch(t){case"value":r=rT.validateBySchema(e,dP);break;case"hashes":let i=function(o){n?n+=". "+o:n=o};var s=i;a(i,"addError");let n;i(sT("schema",e.schema)),i(sT("table",e.table)),e.hash_values?Array.isArray(e.hash_values)?e.hash_values.every(o=>typeof o=="string"||typeof o=="number")||i("'hash_values' must be strings or numbers"):i("'hash_values' must be an array"):i("'hash_values' is required"),e.get_attributes?Array.isArray(e.get_attributes)?e.get_attributes.length===0?i("'get_attributes' must contain at least 1 item"):e.get_attributes.every(o=>typeof o=="string"||typeof o=="number")||i("'get_attributes' must be strings or numbers"):i("'get_attributes' must be an array"):i("'get_attributes' is required"),n&&(r=new Error(n.trim()));break;case"conditions":r=rT.validateBySchema(e,hP);break;default:throw new Error(`Error validating search, unknown type: ${t}`)}if(!r&&e.schema!=="system"){let n=_P.checkGlobalSchemaTable(e.schema,e.table);if(n)return uP(new Error,n,EP.NOT_FOUND);let o=global.hdb_schema[e.schema][e.table].attributes,c=[...e.get_attributes];if(t==="value"&&c.push(e.search_attribute),t==="conditions")for(let u=0,l=e.conditions.length;u<l;u++){let E=e.conditions[u];c.push(E.search_attribute)}let _=tT.filter(c,u=>u!=="*"&&u.attribute!=="*"&&!tT.some(o,l=>l===u||l.attribute===u||l.attribute===u.attribute));if(_&&_.length>0){let u=_.join(", ");return u=u.replace(/,([^,]*)$/," and$1"),new Error(`unknown attribute '${u}'`)}}return r}});var Wu=S((zJ,iT)=>{"use strict";var SP=Z(),fP=ui(),TP=require("path"),{getBaseSchemaPath:mP}=te();iT.exports=RP;function RP(e){let t=fP(e,"hashes");if(t)throw t;let r=TP.join(mP(),e.schema.toString());return SP.openEnvironment(r,e.table)}a(RP,"initialize")});var Ju=S((jJ,aT)=>{"use strict";var AP=nn(),OP=Wu();aT.exports=pP;async function pP(e){try{let t=await OP(e),r=global.hdb_schema[e.schema][e.table];return AP.batchSearchByHashToMap(t,r.hash_attribute,e.get_attributes,e.hash_values)}catch(t){throw t}}a(pP,"lmdbGetDataByHash")});var ds=S((eZ,oT)=>{"use strict";var Eo=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.hash_values=s,this.get_attributes=n}};a(Eo,"SearchByHashObject");oT.exports=Eo});var _T=S((rZ,cT)=>{"use strict";var tZ=ds(),NP=nn(),gP=Wu();cT.exports=IP;async function IP(e){try{let t=await gP(e),r=global.hdb_schema[e.schema][e.table];return NP.batchSearchByHash(t,r.hash_attribute,e.get_attributes,e.hash_values)}catch(t){throw t}}a(IP,"lmdbSearchByHash")});var Kt=S((sZ,uT)=>{"use strict";var ho=class{constructor(t,r,s,n,i,o,c,_=!1,u=void 0,l=void 0){this.schema=t,this.table=r,this.search_attribute=s,this.search_value=n,this.hash_attribute=i,this.get_attributes=o,this.end_value=c,this.reverse=_,this.limit=u,this.offset=l}};a(ho,"SearchObject");uT.exports=ho});var So=S((nZ,ST)=>{"use strict";var We=nn(),bP=Z(),CP=require("path"),wP=b(),U=Ye(),hs=T(),{getBaseSchemaPath:LP}=te(),UP=is(),lT=Ke().LMDB_ERRORS_ENUM,{compareKeys:an}=require("ordered-binary"),Rr=hs.SEARCH_WILDCARDS;async function yP(e,t,r){let s;e.schema===hs.SYSTEM_SCHEMA_NAME?s=UP[e.table]:s=global.hdb_schema[e.schema][e.table];let n=hT(e,s.hash_attribute,r,t);return ET(e,n,s.hash_attribute,r)}a(yP,"prepSearch");async function ET(e,t,r,s){let n=CP.join(LP(),e.schema.toString()),i=await bP.openEnvironment(n,e.table),o=dT(i,e,t,r);if([U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH,U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP,U.SEARCH_TYPES.SEARCH_ALL,U.SEARCH_TYPES.SEARCH_ALL_TO_MAP].indexOf(t)>=0)return o;if(PP(e,r)===!1)return s===!0?MP(o):o[1];let _=o[0];return s===!0?We.batchSearchByHashToMap(i,r,e.get_attributes,_):We.batchSearchByHash(i,r,e.get_attributes,_)}a(ET,"executeSearch");function dT(e,t,r,s){let n,i=s;t.get_attributes.indexOf(s)<0&&(i=void 0);let{reverse:o,limit:c,offset:_}=t;switch(o=typeof o=="boolean"?o:!1,c=Number.isInteger(c)?c:void 0,_=Number.isInteger(_)?_:void 0,r){case U.SEARCH_TYPES.EQUALS:n=We.equals(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.CONTAINS:n=We.contains(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.ENDS_WITH:case U.SEARCH_TYPES._ENDS_WITH:n=We.endsWith(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.STARTS_WITH:case U.SEARCH_TYPES._STARTS_WITH:n=We.startsWith(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:return We.batchSearchByHash(e,t.search_attribute,t.get_attributes,[t.search_value]);case U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:return We.batchSearchByHashToMap(e,t.search_attribute,t.get_attributes,[t.search_value]);case U.SEARCH_TYPES.SEARCH_ALL:return We.searchAll(e,s,t.get_attributes,o,c,_);case U.SEARCH_TYPES.SEARCH_ALL_TO_MAP:return We.searchAllToMap(e,s,t.get_attributes,o,c,_);case U.SEARCH_TYPES.BETWEEN:n=We.between(e,i,t.search_attribute,t.search_value,t.end_value,o,c,_);break;case U.SEARCH_TYPES.GREATER_THAN:case U.SEARCH_TYPES._GREATER_THAN:n=We.greaterThan(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.GREATER_THAN_EQUAL:case U.SEARCH_TYPES._GREATER_THAN_EQUAL:n=We.greaterThanEqual(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.LESS_THAN:case U.SEARCH_TYPES._LESS_THAN:n=We.lessThan(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.LESS_THAN_EQUAL:case U.SEARCH_TYPES._LESS_THAN_EQUAL:n=We.lessThanEqual(e,i,t.search_attribute,t.search_value,o,c,_);break;default:return Object.create(null)}return n}a(dT,"searchByType");function DP(e){let t=e.search_type,r=e.search_attribute,s=e.search_value;switch(t){case U.SEARCH_TYPES.EQUALS:return n=>n[r]===s;case U.SEARCH_TYPES.CONTAINS:return n=>typeof n[r]=="string"&&n[r].includes(s);case U.SEARCH_TYPES.ENDS_WITH:case U.SEARCH_TYPES._ENDS_WITH:return n=>typeof n[r]=="string"&&n[r].endsWith(s);case U.SEARCH_TYPES.STARTS_WITH:case U.SEARCH_TYPES._STARTS_WITH:return n=>typeof n[r]=="string"&&n[r].startsWith(s);case U.SEARCH_TYPES.BETWEEN:return n=>{let i=n[r];return an(i,s[0])>=0&&an(i,s[1])<=0};case U.SEARCH_TYPES.GREATER_THAN:case U.SEARCH_TYPES._GREATER_THAN:return n=>an(n[r],s)>0;case U.SEARCH_TYPES.GREATER_THAN_EQUAL:case U.SEARCH_TYPES._GREATER_THAN_EQUAL:return n=>an(n[r],s)>=0;case U.SEARCH_TYPES.LESS_THAN:case U.SEARCH_TYPES._LESS_THAN:return n=>an(n[r],s)<0;case U.SEARCH_TYPES.LESS_THAN_EQUAL:case U.SEARCH_TYPES._LESS_THAN_EQUAL:return n=>an(n[r],s)<=0;default:return Object.create(null)}}a(DP,"filterByType");function MP(e){let t=Object.create(null);for(let r=0,s=e[0].length;r<s;r++)t[e[0][r]]=e[1][r];return t}a(MP,"createMapFromArrays");function PP(e,t){if(e.get_attributes.length===1&&e.get_attributes[0]==="*")return!0;let r=[e.search_attribute];e.get_attributes.indexOf(t)>=0&&r.push(t);let s=!1;for(let n=0;n<e.get_attributes.length;n++)if(r.indexOf(e.get_attributes[n])<0){s=!0;break}return s}a(PP,"checkToFetchMore");function hT(e,t,r,s){if(wP.isEmpty(s)){let n=e.search_value;typeof n=="object"?n=JSON.stringify(n):n=n.toString();let i=n.charAt(0),o=n.charAt(n.length-1),c=!1;if(e.search_attribute===t&&(c=!0),Rr.indexOf(n)>-1)return r===!0?U.SEARCH_TYPES.SEARCH_ALL_TO_MAP:U.SEARCH_TYPES.SEARCH_ALL;if(n.indexOf(Rr[0])<0&&n.indexOf(Rr[1])<0)return c===!0?r===!0?U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:U.SEARCH_TYPES.EQUALS;if(Rr.indexOf(i)>=0&&Rr.indexOf(o)>=0)return e.search_value=e.search_value.slice(1,-1),U.SEARCH_TYPES.CONTAINS;if(Rr.indexOf(i)>=0)return e.search_value=e.search_value.substr(1),U.SEARCH_TYPES.ENDS_WITH;if(Rr.indexOf(o)>=0)return e.search_value=e.search_value.slice(0,-1),U.SEARCH_TYPES.STARTS_WITH;if(n.includes(Rr[0])||n.includes(Rr[1]))return U.SEARCH_TYPES.EQUALS;throw new Error(lT.UNKNOWN_SEARCH_TYPE)}else switch(s){case hs.VALUE_SEARCH_COMPARATORS.BETWEEN:return U.SEARCH_TYPES.BETWEEN;case hs.VALUE_SEARCH_COMPARATORS.GREATER:return U.SEARCH_TYPES.GREATER_THAN;case hs.VALUE_SEARCH_COMPARATORS.GREATER_OR_EQ:return U.SEARCH_TYPES.GREATER_THAN_EQUAL;case hs.VALUE_SEARCH_COMPARATORS.LESS:return U.SEARCH_TYPES.LESS_THAN;case hs.VALUE_SEARCH_COMPARATORS.LESS_OR_EQ:return U.SEARCH_TYPES.LESS_THAN_EQUAL;default:throw new Error(lT.UNKNOWN_SEARCH_TYPE)}}a(hT,"createSearchTypeFromSearchObject");ST.exports={executeSearch:ET,createSearchTypeFromSearchObject:hT,prepSearch:yP,searchByType:dT,filterByType:DP}});var TT=S((aZ,fT)=>{"use strict";var iZ=Kt(),BP=ui(),vP=b(),HP=T(),GP=So();fT.exports=qP;async function qP(e,t){if(!vP.isEmpty(t)&&HP.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=BP(e,"value");if(s)throw s;let n=!0;try{return await GP.prepSearch(e,t,n)}catch(i){throw i}}a(qP,"lmdbGetDataByValue")});var on=S((cZ,mT)=>{"use strict";var oZ=Kt(),FP=ui(),VP=b(),kP=T(),xP=So();mT.exports=$P;async function $P(e,t){if(!VP.isEmpty(t)&&kP.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=FP(e,"value");if(s)throw s;let n=!1;try{return await xP.prepSearch(e,t,n)}catch(i){throw i}}a($P,"lmdbSearchByValue")});var AT=S((uZ,RT)=>{"use strict";var _Z=Ye(),fo=class{constructor(t,r,s,n,i=void 0,o=void 0,c="and"){this.schema=t,this.table=r,this.get_attributes=s,this.limit=i,this.offset=o,this.conditions=n,this.operator=c}};a(fo,"SearchByConditionsObject");var To=class{constructor(t,r,s){this.search_attribute=t,this.search_type=r,this.search_value=s}};a(To,"SearchCondition");var mo=class{constructor(t,r){this.attribute=t,this.desc=r}};a(mo,"SortAttribute");RT.exports={SearchByConditionsObject:fo,SearchCondition:To,SortAttribute:mo}});var bT=S((EZ,IT)=>{"use strict";var lZ=AT().SearchByConditionsObject,YP=Kt(),KP=ui(),Zu=nn(),Ro=Ye(),gT=So(),QP=Ku(),OT=require("lodash"),{getBaseSchemaPath:WP}=te(),JP=require("path"),ZP=Z(),{handleHDBError:pT,hdb_errors:XP}=D(),{HTTP_STATUS_CODES:zP}=XP,jP=1e8,eB={lazy:!0};IT.exports=tB;async function tB(e){try{let t=KP(e,"conditions");if(t)throw pT(t,t.message,zP.BAD_REQUEST,void 0,void 0,!0);e.operator=e.operator?e.operator.toLowerCase():void 0,e.offset=Number.isInteger(e.offset)?e.offset:0;let r=JP.join(WP(),e.schema.toString()),s=await ZP.openEnvironment(r,e.table),n=global.hdb_schema[e.schema][e.table],i=OT.sortBy(e.conditions,o=>{if(o.estimated_count===void 0){let c=o.search_type;c===Ro.SEARCH_TYPES.EQUALS?o.estimated_count=Zu.count(s,o.search_attribute,o.search_value):c===Ro.SEARCH_TYPES.CONTAINS||c===Ro.SEARCH_TYPES.ENDS_WITH?o.estimated_count=1/0:o.estimated_count=jP}return o.estimated_count});if(!e.operator||e.operator.toLowerCase()==="and"){let[o]=await NT(s,e,i[0],n.hash_attribute),c=s.dbis[n.hash_attribute],_=i.slice(1).map(gT.filterByType),u=_.length,l=[],E=Zu.setGetWholeRowAttributes(s,e.get_attributes),d=e.offset>-1?e.offset:0,h=e.limit>-1?e.limit:1/0;e:for(let m of o){let R=c.get(m,eB);for(let w=0;w<u;w++)if(!_[w](R))continue e;if(d>0){d--;continue}if(h<=0)break;h--,l.push(QP.parseRow(R,E))}return l}else{let o=[],c=[];for(let _ of i){let[u]=await NT(s,e,_,n.hash_attribute);c.push(u)}if(o=OT.union(...c),e.limit>0||e.offset>0){let _=Number.isInteger(e.limit)?e.limit:o.length;o=o.splice(e.offset,_)}return Zu.batchSearchByHash(s,n.hash_attribute,e.get_attributes,o)}}catch(t){throw pT(t)}}a(tB,"lmdbSearchByConditions");async function NT(e,t,r,s){let n=new YP(t.schema,t.table,void 0,void 0,s,t.get_attributes),i=r.search_type;return n.search_attribute=r.search_attribute,i===Ro.SEARCH_TYPES.BETWEEN?(n.search_value=r.search_value[0],n.end_value=r.search_value[1]):n.search_value=r.search_value,gT.searchByType(e,n,i,s)}a(NT,"executeConditionSearch")});var li=S((dZ,CT)=>{"use strict";var rB=T().OPERATIONS_ENUM,Ao=class{constructor(t,r,s,n=void 0){this.operation=rB.DELETE,this.schema=t,this.table=r,this.hash_values=s,this.__origin=n}};a(Ao,"DeleteObject");CT.exports=Ao});var Xu=S((hZ,wT)=>{"use strict";var Oo=class{constructor(t,r,s){this.schema=t,this.table=r,this.attribute=s}};a(Oo,"DropAttributeObject");wT.exports=Oo});var ju=S((fZ,LT)=>{"use strict";var sB=Kt(),nB=li(),SZ=Xu(),er=T(),iB=b(),zu=Z(),aB=is(),oB=on(),cB=ai(),{getBaseSchemaPath:_B}=te(),uB=require("path");LT.exports=lB;async function lB(e,t=!0){let r;e.schema===er.SYSTEM_SCHEMA_NAME?r=aB[e.table]:r=global.hdb_schema[e.schema][e.table];let s=await dB(e),n=uB.join(_B(),e.schema.toString()),i=await zu.openEnvironment(n,e.table);return t===!0&&await EB(e,i,r.hash_attribute),zu.dropDBI(i,e.attribute),s}a(lB,"lmdbDropAttribute");async function EB(e,t,r){let s=zu.openDBI(t,r),n,i=e.attribute;for(let{key:o,value:c,version:_}of s.getRange({start:!1,versions:!0})){let u={};for(let l in c)l!==i&&(u[l]=c[l]);n=t.dbis[r].put(o,u,_)}await n}a(EB,"removeAttributeFromAllObjects");async function dB(e){let t=new sB(er.SYSTEM_SCHEMA_NAME,er.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY,er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]),s=(await oB(t)).filter(o=>o[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]===e.attribute);if(iB.isEmptyOrZeroLength(s))throw new Error(`Attribute '${e.attribute}' was not found in '${e.schema}.${e.table}'`);let n=s.map(o=>o[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),i=new nB(er.SYSTEM_SCHEMA_NAME,er.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,n);return cB(i)}a(dB,"dropAttributeFromSystem")});var MT=S((TZ,DT)=>{"use strict";var hB=ju(),SB=Xu(),UT=b(),yT=I(),fB=Ke().LMDB_ERRORS_ENUM;DT.exports=TB;async function TB(e){if(UT.isEmpty(global.hdb_schema[e.schema])||UT.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);let t=global.hdb_schema[e.schema][e.table],r;try{for(let s=0;s<t.attributes.length;s++){r=t.attributes[s].attribute;let n=new SB(e.schema,e.table,r);try{await hB(n,!1)}catch(i){i.message!==fB.DBI_DOES_NOT_EXIST&&yT.error(`unable to drop attribute ${e.schema}.${e.table}.${r}:`+i)}}}catch(s){throw yT.error(`Error dropping attribute ${r}`),s}}a(TB,"lmdbDropAllAttributes")});var el=S((RZ,kT)=>{"use strict";var GT=Kt(),qT=li(),FT=on(),VT=ai(),mZ=MT(),ot=T(),PT=b(),BT=Z(),{getBaseSchemaPath:mB,getTransactionAuditStorePath:RB}=te(),vT=require("path"),HT=I();kT.exports=AB;async function AB(e){try{if(PT.isEmpty(global.hdb_schema[e.schema])||PT.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);await OB(e),await pB(e);let t=vT.join(mB(),e.schema.toString());try{await BT.deleteEnvironment(t,e.table)}catch(r){if(r.message==="invalid environment")HT.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}try{let r=vT.join(RB(),e.schema.toString());await BT.deleteEnvironment(r,e.table,!0)}catch(r){if(r.message==="invalid environment")HT.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}}catch(t){throw t}}a(AB,"lmdbDropTable");async function OB(e){let t=new GT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r=await FT(t),s=[];for(let i=0;i<r.length;i++){let o=r[i];s.push(o.id)}if(s.length===0)return;let n=new qT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,s);await VT(n)}a(OB,"deleteAttributesFromSystem");async function pB(e){let t=new GT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,e.table,void 0,[ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r,s;try{r=await FT(t)}catch(i){throw i}for(let i=0;i<r.length;i++){let o=r[i];o.name===e.table&&o.schema===e.schema&&(s=o)}if(!s)throw new Error(`${e.schema}.${e.table} was not found`);let n=new qT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,[s.id]);try{await VT(n)}catch(i){throw i}}a(pB,"dropTableFromSystem")});var $T=S((OZ,xT)=>{"use strict";var NB=require("fs-extra"),gB=Kt(),IB=ds(),bB=li(),CB=el(),wB=ai(),LB=Ju(),UB=on(),Ar=T(),AZ=b(),yB=require("path"),{getBaseSchemaPath:DB}=te(),{handleHDBError:MB,hdb_errors:PB}=D(),{HDB_ERROR_MSGS:BB,HTTP_STATUS_CODES:vB}=PB;xT.exports=HB;async function HB(e){let t;try{t=await GB(e.schema);let r=new gB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,t,void 0,[Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),s=await UB(r);for(let o=0;o<s.length;o++){let c={schema:t,table:s[o].name};try{await CB(c)}catch(_){if(_.message!=="invalid environment")throw _}}let n=new bB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[t]);await wB(n);let i=yB.join(DB(),t.toString());await NB.remove(i)}catch(r){throw r}}a(HB,"lmdbDropSchema");async function GB(e){let t=new IB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[e],[Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),r,s;try{r=await LB(t)}catch(n){throw n}for(let n in r)r[n].name===e&&(s=e);if(!s)throw MB(new Error,BB.SCHEMA_NOT_FOUND(e),vB.NOT_FOUND,void 0,void 0,!0);return s}a(GB,"validateDropSchema")});var tl=S((pZ,YT)=>{"use strict";var po=class{constructor(t,r,s){this.schema=t,this.table=r,this.hash_attribute=s}};a(po,"CreateTableObject");YT.exports=po});var QT=S((gZ,KT)=>{"use strict";var qB=require("path"),FB=require("fs-extra"),No=Z(),{getTransactionAuditStorePath:VB}=te(),rl=Ye(),NZ=tl();KT.exports=kB;async function kB(e){let t;try{let r=qB.join(VB(),e.schema.toString());await FB.mkdirp(r),t=await No.createEnvironment(r,e.table,!0)}catch(r){throw r.message=`unable to create transactions audit environment for ${e.schema}.${e.table} due to: ${r.message}`,r}try{No.createDBI(t,rl.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,!1,!0),No.createDBI(t,rl.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,!0,!1),No.createDBI(t,rl.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME,!0,!1)}catch(r){throw r.message=`unable to create dbi for ${e.schema}.${e.table} due to: ${r.message}`,r}return t}a(kB,"createTransactionsAuditEnvironment")});var XT=S((IZ,ZT)=>{"use strict";var sl=T(),WT=Z(),xB=Xs(),$B=require("path"),{getSystemSchemaPath:YB,getBaseSchemaPath:KB}=te(),QB=is(),WB=Za(),nl=Ja(),JB=I(),ZB=QT(),al=QB.hdb_table,JT=[];for(let e=0;e<al.attributes.length;e++)JT.push(al.attributes[e].attribute);ZT.exports=XB;async function XB(e,t){let r=$B.join(KB(),t.schema.toString()),s=new nl(t.schema,t.table,sl.TIME_STAMP_NAMES_ENUM.CREATED_TIME,void 0,!0),n=new nl(t.schema,t.table,sl.TIME_STAMP_NAMES_ENUM.UPDATED_TIME,void 0,!0),i=new nl(t.schema,t.table,t.hash_attribute,void 0,!1,!0);try{if(await WT.createEnvironment(r,t.table),e!==void 0){let o=await WT.openEnvironment(YB(),sl.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME);await xB.insertRecords(o,al.hash_attribute,JT,[e]),await il(s),await il(n),await il(i)}await ZB(t)}catch(o){throw o}}a(XB,"lmdbCreateTable");async function il(e){try{await WB(e)}catch(t){JB.warn(`failed to create attribute ${e.attribute} due to ${t.message}`)}}a(il,"createAttribute")});var jT=S((bZ,zT)=>{"use strict";var zB=Xa(),jB=eo(),ev=so(),cn=T(),tv=Xs().updateRecords,rv=Z(),sv=require("path"),{getBaseSchemaPath:nv}=te(),iv=ii(),av=I();zT.exports=ov;async function ov(e){try{let{schema_table:t,attributes:r}=zB(e);jB(e,r,t.hash_attribute),e.schema!==cn.SYSTEM_SCHEMA_NAME&&(r.includes(cn.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(cn.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(cn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(cn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await ev(e.hdb_auth_header,t,r),n=sv.join(nv(),e.schema.toString()),i=await rv.openEnvironment(n,e.table),o=await tv(i,t.hash_attribute,r,e.records,e[cn.CLUSTERING_FLAG]!==!0);try{await iv(e,o)}catch(c){av.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(ov,"lmdbUpdateRecords")});var tm=S((CZ,em)=>{"use strict";var cv=T().OPERATIONS_ENUM,go=class{constructor(t,r,s,n=void 0){this.operation=cv.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(go,"UpsertObject");em.exports=go});var sm=S((LZ,rm)=>{"use strict";var wZ=tm(),_v=Xa(),uv=eo(),lv=so(),_n=T(),Ev=Xs().upsertRecords,dv=Z(),hv=require("path"),{getBaseSchemaPath:Sv}=te(),fv=ii(),Tv=I(),{handleHDBError:mv,hdb_errors:Rv}=D();rm.exports=Av;async function Av(e){let t;try{t=_v(e)}catch(_){throw mv(_,_.message,Rv.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}let{schema_table:r,attributes:s}=t;uv(e,s,r.hash_attribute),e.schema!==_n.SYSTEM_SCHEMA_NAME&&(s.includes(_n.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||s.push(_n.TIME_STAMP_NAMES_ENUM.CREATED_TIME),s.includes(_n.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||s.push(_n.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let n=await lv(e.hdb_auth_header,r,s),i=hv.join(Sv(),e.schema.toString()),o=await dv.openEnvironment(i,e.table),c=await Ev(o,r.hash_attribute,s,e.records,e[_n.CLUSTERING_FLAG]!==!0);try{await fv(e,c)}catch(_){Tv.error(`unable to write transaction due to ${_.message}`)}return{written_hashes:c.written_hashes,schema_table:r,new_attributes:n,txn_time:c.txn_time}}a(Av,"lmdbUpsertRecords")});var _m=S((UZ,cm)=>{"use strict";var Ov=Kt(),nm=b(),im=I(),pv=on(),am=T(),Nv=$u().deleteRecords,gv=Z(),Iv=require("path"),{getBaseSchemaPath:bv}=te(),{promisify:Cv}=require("util"),wv=Cv(setTimeout),om=1e4,Lv=10;cm.exports=Uv;async function Uv(e){let t=global.hdb_schema[e.schema][e.table].hash_attribute;if(nm.isEmptyOrZeroLength(t))throw new Error(`Could not retrieve hash attribute for schema: ${e.schema} table: ${e.table}`);let r=Date.parse(e.date),s;try{let n=new Ov(e.schema,e.table,am.TIME_STAMP_NAMES_ENUM.CREATED_TIME,r,void 0,[t]);s=await pv(n,am.VALUE_SEARCH_COMPARATORS.LESS)}catch(n){throw im.error(`Error searching for date: ${e.date} in schema: ${e.schema} table: ${e.table}`),n}return nm.isEmptyOrZeroLength(s)?(im.trace("No records found to delete"),{message:"No records found to delete"}):await yv(e,s,t)}a(Uv,"lmdbDeleteRecordsBefore");async function yv(e,t,r){let s=Iv.join(bv(),e.schema.toString()),n=await gv.openEnvironment(s,e.table),i={message:"",deleted_hashes:[],skipped_hashes:[]};for(let o=0,c=t.length;o<c;o+=om){let _=t.slice(o,o+om),u=[];for(let l=0,E=_.length;l<E;l++)u.push(_[l][r]);try{let l=await Nv(n,r,u);i.deleted_hashes=i.deleted_hashes.concat(l.deleted),i.skipped_hashes=i.skipped_hashes.concat(l.skipped)}catch(l){throw l}await wv(Lv)}return i.message=`${i.deleted_hashes.length} of ${i.deleted_hashes.length+i.skipped_hashes.length} records successfully deleted`,i}a(yv,"chunkDeletes")});var lm=S((yZ,um)=>{"use strict";var Io=class{constructor(t,r,s){this.schema=t,this.table=r,this.timestamp=s}};a(Io,"DeleteBeforeObject");um.exports=Io});var dm=S((DZ,Em)=>{"use strict";var bo=class{constructor(t=void 0,r=void 0,s=0){this.start_timestamp=t,this.end_timestamp=r,this.transactions_deleted=s}};a(bo,"DeleteAuditLogsBeforeResults");Em.exports=bo});var fm=S((PZ,Sm)=>{"use strict";var ol=Z(),{getTransactionAuditStorePath:Dv}=te(),MZ=lm(),Mv=require("path"),Ei=Ye(),Pv=b(),hm=dm(),Bv=require("util").promisify,vv=Bv(setTimeout),Hv=1e4,Gv=100;Sm.exports=qv;async function qv(e){let t=Mv.join(Dv(),e.schema),r=await ol.openEnvironment(t,e.table,!0),s=ol.listDBIs(r);ol.initializeDBIs(r,Ei.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n,i=new hm;do n=await Fv(r,e.timestamp),i.start_timestamp===void 0&&(i.start_timestamp=n.start_timestamp),n.end_timestamp!==void 0&&(i.end_timestamp=n.end_timestamp),i.transactions_deleted+=n.transactions_deleted,await vv(Gv);while(n.transactions_deleted>0);return i}a(qv,"deleteAuditLogsBefore");async function Fv(e,t){let r=new hm;try{let s=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let{key:i,value:o}of s.getRange({start:!1})){if(i>=t)break;r.start_timestamp===void 0&&(r.start_timestamp=i),n=s.remove(i);let c=o[Ei.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME];Pv.isEmpty(c)||(n=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].remove(c,i));for(let _=0;_<o.hash_values.length;_++)n=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].remove(o.hash_values[_],i);if(r.transactions_deleted++,r.end_timestamp=i,r.transactions_deleted>Hv)break}return await n,r}catch(s){throw s}}a(Fv,"deleteTransactions")});var Nm=S((BZ,pm)=>{"use strict";var cl=Z(),un=Ye(),Tm=_s(),_l=T(),mm=b(),{getTransactionAuditStorePath:Vv}=te(),kv=require("path"),xv=nn(),Co=en(),$v=I();pm.exports=Yv;async function Yv(e){let t=kv.join(Vv(),e.schema),r=await cl.openEnvironment(t,e.table,!0),s=cl.listDBIs(r);cl.initializeDBIs(r,un.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n;switch(e.search_type){case _l.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.TIMESTAMP:return Rm(r,e.search_values);case _l.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:return n=global.hdb_schema[e.schema][e.table].hash_attribute,Qv(r,e.search_values,n);case _l.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:return Kv(r,e.search_values);default:return Rm(r)}}a(Yv,"readAuditLog");function Rm(e,t=[0,Tm.getMicroTime()]){mm.isEmpty(t[0])&&(t[0]=0),mm.isEmpty(t[1])&&(t[1]=Tm.getMicroTime());let r=[];try{let s=e.dbis[un.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let i of s.getKeys({start:t[1]}))if(i!==t[1]){n=i;break}for(let{value:i}of s.getRange({start:t[0],end:n})){let o=Object.assign(new Co,i);r.push(o)}return r}catch(s){throw s}}a(Rm,"searchTransactionsByTimestamp");function Kv(e,t=[]){let r=new Map;for(let s=0;s<t.length;s++){let n=t[s],i=[];for(let o of e.dbis[un.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].getValues(n))i.push(o);r.set(n,Om(e,i))}return Object.fromEntries(r)}a(Kv,"searchTransactionsByUsername");function Qv(e,t,r){let s=new Map;for(let c=0,_=t.length;c<_;c++){let u=t[c],l=xv.equals(e,un.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,un.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,u);for(let E=0,d=l[0].length;E<d;E++){let h=l[0][E],m=Number(h);s.has(m)?s.get(m).push(u.toString()):s.set(m,[u.toString()])}}let n=Array.from(s.keys()),i=Om(e,n),o=new Map;for(let c=0;c<i.length;c++){let _=i[c],u=_.timestamp,l=s.get(u);Am(_,"records",r,l,o),Am(_,"original_records",r,l,o)}return Object.fromEntries(o)}a(Qv,"searchTransactionsByHashValues");function Am(e,t,r,s,n){let i=e.timestamp;if(e[t])for(let o=0;o<e[t].length;o++){let c=e[t][o],_=c[r].toString();if(s.indexOf(_)>=0)if(n.has(_)){let u=n.get(_),l=u[u.length-1];if(l.timestamp===i)l[t]=[c];else{let E=new Co(e.operation,e.user_name,i,void 0);E[t]=[c],u.push(E)}}else{let u=new Co(e.operation,e.user_name,i,void 0);u[t]=[c],n.set(_,[u])}}}a(Am,"loopRecords");function Om(e,t){let r=[];try{let s=e.dbis[un.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP];for(let n=0;n<t.length;n++)try{let i=s.get(t[n]);if(i){let o=Object.assign(new Co,i);r.push(o)}}catch(i){$v.warn(i)}return r}catch(s){throw s}}a(Om,"batchSearchTransactions")});var Im=S((vZ,gm)=>{"use strict";var Wv=require("path"),{getBaseSchemaPath:Jv}=te(),Zv=Z();gm.exports={writeTransaction:Xv};async function Xv(e,t,r){let s=Wv.join(Jv(),e);return(await Zv.openEnvironment(s,t)).transaction(r)}a(Xv,"writeTransaction")});var Cm=S((HZ,bm)=>{"use strict";var zv=require("path"),{getBaseSchemaPath:jv}=te(),eH=Z();bm.exports={flush:tH};async function tH(e,t){let r=zv.join(jv(),e.toString());return(await eH.openEnvironment(r,t.toString())).flushed}a(tH,"flush")});var Lm=S((GZ,wm)=>{"use strict";var Ae=I(),{handleHDBError:rH}=D(),sH=du(),nH=Za(),iH=Vu(),aH=Ff(),oH=ai(),cH=Ju(),_H=_T(),uH=TT(),lH=on(),EH=bT(),dH=$T(),hH=XT(),SH=jT(),fH=sm(),TH=_m(),mH=fm(),RH=el(),AH=ju(),OH=Nm(),pH=Im(),NH=Cm(),wo=class extends sH{async searchByConditions(t){try{return EH(t)}catch(r){throw Ae.error(r),r}}async getDataByHash(t){try{return await cH(t)}catch(r){throw Ae.error(r),r}}async searchByHash(t){try{return await _H(t)}catch(r){throw Ae.error(r),r}}async getDataByValue(t,r){try{return await uH(t,r)}catch(s){throw Ae.error(s),s}}async searchByValue(t){try{return await lH(t)}catch(r){throw Ae.error(r),r}}async createSchema(t){try{return await aH(t)}catch(r){throw Ae.error(r),r}}async dropSchema(t){try{return await dH(t)}catch(r){throw Ae.error(r),r}}async createTable(t,r){try{return await hH(t,r)}catch(s){throw Ae.error(s),s}}async dropTable(t){try{return await RH(t)}catch(r){throw Ae.error(r),r}}async createAttribute(t){try{return await nH(t)}catch(r){throw Ae.error(r),r}}async createRecords(t){try{return await iH(t)}catch(r){throw Ae.error(r),r}}async updateRecords(t){try{return await SH(t)}catch(r){throw Ae.error(r),r}}async upsertRecords(t){try{return await fH(t)}catch(r){throw rH(r,null,null,Ae.ERR,r)}}async deleteRecords(t){try{return await oH(t)}catch(r){throw Ae.error(r),r}}async deleteRecordsBefore(t){try{return await TH(t)}catch(r){throw Ae.error(r),r}}async dropAttribute(t){try{return await AH(t)}catch(r){throw Ae.error(r),r}}async deleteAuditLogsBefore(t){try{return await mH(t)}catch(r){throw Ae.error(r),r}}async readAuditLog(t){try{return await OH(t)}catch(r){throw Ae.error(r),r}}writeTransaction(t,r,s){return pH.writeTransaction(t,r,s)}flush(t,r){return NH.flush(t,r)}};a(wo,"LMDBBridge");wm.exports=wo});var Or=S((qZ,ym)=>{"use strict";var gH=Lm(),IH=du(),bH=Y();bH.initSync();var Um;function CH(){return Um instanceof IH?Um:new gH}a(CH,"getBridge");ym.exports=CH()});var Bm=S((FZ,Pm)=>{"use strict";var Dm=require("lodash"),di=require("mathjs"),wH=require("jsonata"),Mm=b();Pm.exports={distinct_array:e=>Array.isArray(e)&&e.length>1?Dm.uniqWith(e,Dm.isEqual):e,searchJSON:LH,mad:hi.bind(null,di.mad),mean:hi.bind(null,di.mean),mode:hi.bind(null,di.mode),prod:hi.bind(null,di.prod),median:hi.bind(null,di.median)};function hi(e,t,r,s){return s===1?t==null?[]:[t]:s===2?(t!=null&&r.push(t),r):r!=null&&r.length>0?e(r):null}a(hi,"aggregateFunction");function LH(e,t){if(typeof e!="string"||e.length===0)throw new Error("search json expression must be a non-empty string");let r="__"+e+"__";if(Mm.isEmpty(this.__ala__.res)&&(this.__ala__.res={}),Mm.isEmpty(this.__ala__.res[r])){let s=wH(e);this.__ala__.res[r]=s}return this.__ala__.res[r].evaluate(t)}a(LH,"searchJSON")});var Hm=S((VZ,vm)=>{"use strict";var Se=require("moment"),ul="YYYY-MM-DDTHH:mm:ss.SSSZZ";Se.suppressDeprecationWarnings=!0;vm.exports={current_date:()=>Se().utc().format("YYYY-MM-DD"),current_time:()=>Se().utc().format("HH:mm:ss.SSS"),extract:(e,t)=>{switch(t.toLowerCase()){case"year":return Se(e).utc().format("YYYY");case"month":return Se(e).utc().format("MM");case"day":return Se(e).utc().format("DD");case"hour":return Se(e).utc().format("HH");case"minute":return Se(e).utc().format("mm");case"second":return Se(e).utc().format("ss");case"millisecond":return Se(e).utc().format("SSS");default:break}},date:e=>Se(e).utc().format(ul),date_format:(e,t)=>Se(e).utc().format(t),date_add:(e,t,r)=>Se(e).utc().add(t,r).valueOf(),date_sub:(e,t,r)=>Se(e).utc().subtract(t,r).valueOf(),date_diff:(e,t,r)=>{let s=Se(e).utc(),n=Se(t).utc();return r?s.diff(n,r,!0):s.diff(n)},now:()=>Se().utc().valueOf(),get_server_time:()=>Se().format(ul),offset_utc:(e,t)=>Se(e).utc().utcOffset(t).format(ul)}});var Vm=S((kZ,Fm)=>{"use strict";var UH=require("@turf/area"),yH=require("@turf/length"),DH=require("@turf/circle"),MH=require("@turf/difference"),PH=require("@turf/distance"),BH=require("@turf/boolean-contains"),vH=require("@turf/boolean-equal"),HH=require("@turf/boolean-disjoint"),GH=require("@turf/helpers"),Gm=T(),k=b();Fm.exports={geoArea:qH,geoLength:FH,geoCircle:VH,geoDifference:kH,geoDistance:qm,geoNear:xH,geoContains:$H,geoEqual:YH,geoCrosses:KH,geoConvert:QH};var ll="geo1 is required",El="geo2 is required";function qH(e){if(k.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=k.autoCast(e)),UH.default(e)}a(qH,"geoArea");function FH(e,t){if(k.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=k.autoCast(e)),yH.default(e,{units:t||"kilometers"})}a(FH,"geoLength");function VH(e,t,r){if(k.isEmpty(e))throw new Error("point is required");if(k.isEmpty(t))throw new Error("radius is required");return typeof e=="string"&&(e=k.autoCast(e)),DH.default(e,t,{units:r||"kilometers"})}a(VH,"geoCircle");function kH(e,t){if(k.isEmpty(e))throw new Error("poly1 is required");if(k.isEmpty(t))throw new Error("poly2 is required");return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),MH(e,t)}a(kH,"geoDifference");function qm(e,t,r){if(k.isEmpty(e))throw new Error("point1 is required");if(k.isEmpty(t))throw new Error("point2 is required");return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),PH.default(e,t,{units:r||"kilometers"})}a(qm,"geoDistance");function xH(e,t,r,s){if(k.isEmpty(e))throw new Error("point1 is required");if(k.isEmpty(t))throw new Error("point2 is required");if(k.isEmpty(r))throw new Error("distance is required");if(typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),isNaN(r))throw new Error("distance must be a number");return qm(e,t,s)<=r}a(xH,"geoNear");function $H(e,t){if(k.isEmpty(e))throw new Error(ll);if(k.isEmpty(e))throw new Error(El);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),BH.default(e,t)}a($H,"geoContains");function YH(e,t){if(k.isEmpty(e))throw new Error(ll);if(k.isEmpty(e))throw new Error(El);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),vH.default(e,t)}a(YH,"geoEqual");function KH(e,t){if(k.isEmpty(e))throw new Error(ll);if(k.isEmpty(e))throw new Error(El);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),!HH.default(e,t)}a(KH,"geoCrosses");function QH(e,t,r){if(k.isEmptyOrZeroLength(e))throw new Error("coordinates is required");if(k.isEmpty(t))throw new Error("geo_type is required");if(k.isEmpty(Gm.GEO_CONVERSION_ENUM[t]))throw new Error(`geo_type of ${t} is invalid please use one of the following types: ${Object.keys(Gm.GEO_CONVERSION_ENUM).join(",")}`);return GH[t](e,r)}a(QH,"geoConvert")});var Lo=S((xZ,km)=>{var Ss=Bm(),Tt=Hm(),tr=Vm();km.exports=e=>{e.aggr.mad=e.aggr.MAD=Ss.mad,e.aggr.mean=e.aggr.MEAN=Ss.mean,e.aggr.mode=e.aggr.MODE=Ss.mode,e.aggr.prod=e.aggr.PROD=Ss.prod,e.aggr.median=e.aggr.MEDIAN=Ss.median,e.fn.distinct_array=e.fn.DISTINCT_ARRAY=Ss.distinct_array,e.fn.search_json=e.fn.SEARCH_JSON=Ss.searchJSON,e.fn.__ala__=e,e.fn.current_date=e.fn.CURRENT_DATE=Tt.current_date,e.fn.current_time=e.fn.CURRENT_TIME=Tt.current_time,e.fn.extract=e.fn.EXTRACT=Tt.extract,e.fn.date=e.fn.DATE=Tt.date,e.fn.date_format=e.fn.DATE_FORMAT=Tt.date_format,e.fn.date_add=e.fn.DATE_ADD=Tt.date_add,e.fn.date_sub=e.fn.DATE_SUB=Tt.date_sub,e.fn.date_diff=e.fn.DATE_DIFF=e.fn.datediff=e.fn.DATEDIFF=Tt.date_diff,e.fn.now=e.fn.NOW=Tt.now,e.fn.offset_utc=e.fn.OFFSET_UTC=Tt.offset_utc,e.fn.get_server_time=e.fn.GET_SERVER_TIME=Tt.get_server_time,e.fn.getdate=e.fn.GETDATE=Tt.now,e.fn.current_timestamp=e.fn.CURRENT_TIMESTAMP=Tt.now,e.fn.geoarea=e.fn.GEOAREA=e.fn.geoArea=tr.geoArea,e.fn.geocircle=e.fn.GEOCIRCLE=e.fn.geoCircle=tr.geoCircle,e.fn.geocontains=e.fn.GEOCONTAINS=e.fn.geoContains=tr.geoContains,e.fn.geoconvert=e.fn.GEOCONVERT=e.fn.geoConvert=tr.geoConvert,e.fn.geocrosses=e.fn.GEOCROSSES=e.fn.geoCrosses=tr.geoCrosses,e.fn.geodifference=e.fn.GEODIFFERENCE=e.fn.geoDifference=tr.geoDifference,e.fn.geodistance=e.fn.GEODISTANCE=e.fn.geoDistance=tr.geoDistance,e.fn.geoequal=e.fn.GEOEQUAL=e.fn.geoEqual=tr.geoEqual,e.fn.geolength=e.fn.GEOLENGTH=e.fn.geoLength=tr.geoLength,e.fn.geonear=e.fn.GEONEAR=e.fn.geoNear=tr.geoNear}});var Ym=S(($Z,$m)=>{"use strict";var Si=require("lodash"),Me=require("alasql");Me.options.cache=!1;var WH=Lo(),xm=require("clone"),Uo=require("recursive-iterator"),v=I(),G=b(),ln=Or(),JH=T(),{hdb_errors:ZH}=D(),XH="IS NULL",fi="There was a problem performing this search. Please check the logs and try again.";WH(Me);var yo=class{constructor(t,r){if(G.isEmpty(t))throw v.error("AST statement for SQL select process cannot be empty"),"statement cannot be null";this.statement=t,this.columns={},this.all_table_attributes=r,this.fetch_attributes=[],this.exact_search_values={},this.comparator_search_values={},this.tables=[],this.data={},this.has_aggregator=!1,this.has_ordinal=!1,this.has_outer_join=!1,this._getColumns(),this._getTables(),this._conditionsToFetchAttributeValues(),this._setAliasesForColumns(),G.backtickASTSchemaItems(this.statement)}async search(){let t;try{let s=await this._checkEmptySQL();if(!G.isEmptyOrZeroLength(s))return v.trace("No results returned from checkEmptySQL SQLSearch method."),s}catch(s){throw v.error("Error thrown from checkEmptySQL in SQLSearch class method search."),v.error(s),new Error(fi)}try{let s=await this._getFetchAttributeValues();if(s)return s}catch(s){throw v.error("Error thrown from getFetchAttributeValues in SQLSearch class method search."),v.error(s),new Error(fi)}if(Object.keys(this.data).length===0)return v.trace('SQLSearch class field: "data" is empty.'),[];let r;try{r=await this._processJoins()}catch(s){throw v.error("Error thrown from processJoins in SQLSearch class method search."),v.error(s),new Error(fi)}try{await this._getFinalAttributeData(r.existing_attributes,r.joined_length)}catch(s){throw v.error("Error thrown from getFinalAttributeData in SQLSearch class method search."),v.error(s),new Error(fi)}try{return t=await this._finalSQL(),t}catch(s){throw v.error("Error thrown from finalSQL in SQLSearch class method search."),v.error(s),new Error(fi)}}_getColumns(){let t=new Uo(this.statement);for(let{node:r,path:s}of t)r&&r.columnid&&(this.columns[s[0]]||(this.columns[s[0]]=[]),this.columns[s[0]].push(xm(r)))}_getTables(){let t=[];this.all_table_attributes.forEach(r=>{t.push(r.table)}),this.tables=Si.uniqBy(t,r=>[r.databaseid,r.tableid,r.as].join()),this.tables.forEach(r=>{let s=`${r.databaseid}_${r.as?r.as:r.tableid}`;this.data[s]={},this.data[s].__hash_name=global.hdb_schema[r.databaseid][r.tableid].hash_attribute,this.data[s].__merged_data={},this.data[s].__merged_attributes=[],this.data[s].__merged_attr_map={}})}_conditionsToFetchAttributeValues(){if(G.isEmpty(this.statement.where)){v.trace('AST "where" statement is empty.');return}let t=!1;for(let{node:r}of new Uo(this.statement.where))if(r&&r.op&&r.op==="OR"&&(t=!0),!G.isEmpty(r)&&r.right)if(G.isNotEmptyAndHasValue(r.right.value)){let s=G.autoCast(r.right.value);[!0,!1].indexOf(s)>=0?r.right=new Me.yy.LogicValue({value:s}):r.right instanceof Me.yy.StringValue&&!G.isEmpty(s)&&G.autoCasterIsNumberCheck(s.toString())&&(r.right=new Me.yy.NumValue({value:s}))}else Array.isArray(r.right)&&r.right.forEach((s,n)=>{let i=G.autoCast(s.value);[!0,!1].indexOf(i)>=0?r.right[n]=new Me.yy.LogicValue({value:i}):s instanceof Me.yy.StringValue&&G.autoCasterIsNumberCheck(i.toString())&&(r.right[n]=new Me.yy.NumValue({value:i}))});if(t){v.trace('Where clause contains "OR", exact match search not performed on attributes.');return}for(let{node:r}of new Uo(this.statement.where))if(r&&r.left&&r.right&&(r.left.columnid||r.right.value)&&r.op){let s=new Set,n=r.left.columnid?r.left:r.right,i=this._findColumn(n);if(!i)continue;let o=[i.table.databaseid,i.table.tableid,i.attribute].join("/");if(!G.isEmpty(JH.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r.op])){if(G.isEmpty(this.comparator_search_values[o])&&(this.comparator_search_values[o]={ignore:!1,comparators:[]}),!this.comparator_search_values[o].ignore){if(G.isEmptyOrZeroLength(r.left.columnid)||G.isEmptyOrZeroLength(r.right.value)){this.comparator_search_values[o].ignore=!0,this.comparator_search_values[o].comparators=[];continue}this.comparator_search_values[o].comparators.push({attribute:r.left.columnid,operation:r.op,search_value:r.right.value})}continue}if(G.isEmpty(this.exact_search_values[o])&&(this.exact_search_values[o]={ignore:!1,values:new Set}),!this.exact_search_values[o].ignore){let c=!1;switch(r.op){case"=":!G.isEmpty(r.right.value)||!G.isEmpty(r.left.value)?s.add(G.isEmpty(r.right.value)?r.left.value:r.right.value):c=!0;break;case"IN":let _=Array.isArray(r.right)?r.right:r.left;for(let u=0;u<_.length;u++)if(_[u].value)s.add(_[u].value);else{c=!0;break}break;default:c=!0;break}this.exact_search_values[o].ignore=c,c?this.exact_search_values[o].values=new Set:this.exact_search_values[o].values=new Set([...this.exact_search_values[o].values,...s])}}}_setAliasesForColumns(){if(G.isEmptyOrZeroLength(this.all_table_attributes)&&G.isEmptyOrZeroLength(this.statement.from)&&G.isEmptyOrZeroLength(this.columns.columns))return;let t=[],r={};this.statement.columns.forEach((s,n)=>{if(s.columnid==="*"){t.push(n);return}if(s.aggregatorid&&(this.has_aggregator=!0),!s.aggregatorid&&!s.funcid)if(s.as_orig=s.as?s.as:s.columnid,this.statement.joins)if(r[s.as_orig]>=0){let i=r[s.as_orig]+1;s.as=`[${s.as_orig+i}]`,r[s.as_orig]=i}else s.as=`[${s.as_orig}]`,r[s.as_orig]=0;else s.as=`[${s.as_orig}]`;!s.aggregatorid&&s.funcid&&s.args&&(s.as_orig=s.as?s.as:s.toString().replace(/'/g,'"'),s.as=`[${s.as_orig}]`),s.aggregatorid&&s.expression.columnid!=="*"&&(s.as_orig=s.as?s.as:s.expression.tableid?`${s.aggregatorid}(${s.expression.tableid}.${s.expression.columnid})`:`${s.aggregatorid}(${s.expression.columnid})`,s.as=`[${s.as_orig}]`)}),this.statement.columns.length>1&&t.length>0&&Si.pullAt(this.statement.columns,t)}_findColumn(t){let r=this.all_table_attributes.filter(s=>{if(t.columnid_orig&&t.tableid_orig)return(s.table.as===t.tableid_orig||s.table.tableid===t.tableid_orig)&&s.attribute===t.columnid_orig;if(t.tableid)return(s.table.as===t.tableid||s.table.tableid===t.tableid)&&s.attribute===t.columnid;let n=t.columnid_orig?t.columnid_orig:t.columnid;return s.attribute===n});if(G.isEmptyOrZeroLength(r)){let s=this.columns.columns.filter(n=>n.as?t.columnid===n.as:!1);G.isEmptyOrZeroLength(s)||(r=this.all_table_attributes.filter(n=>n.attribute===s[0].columnid&&s[0].tableid&&s[0].tableid===(n.table.as?n.table.as:n.table.tableid)))}return r[0]}async _checkEmptySQL(){let t=[];if(G.isEmptyOrZeroLength(this.all_table_attributes)&&!G.isEmptyOrZeroLength(this.columns.columns))return t;if(G.isEmptyOrZeroLength(this.all_table_attributes)&&G.isEmptyOrZeroLength(this.statement.from))try{let r=this._buildSQL(!1);t=await Me.promise(r)}catch(r){throw v.error("Error thrown from AlaSQL in SQLSearch class method checkEmptySQL."),v.error(r),new Error("There was a problem with the SQL statement")}return t}_addFetchColumns(t){t&&t.length>0&&t.forEach(r=>{let s=this._findColumn(r);s&&this.fetch_attributes.push(xm(s))})}_addColumnToMergedAttributes(t,r){this.data[t].__merged_attributes.push(r),this.data[t].__merged_attr_map[r]=this.data[t].__merged_attributes.length-1}_setMergedHashAttribute(t,r){this.data[t].__merged_data[r].splice(0,1,r)}_updateMergedAttribute(t,r,s,n){let i=this.data[t].__merged_attr_map[s];this.data[t].__merged_data[r].splice(i,1,n)}async _getFetchAttributeValues(){if(G.isEmptyOrZeroLength(Object.keys(this.columns)))return[];this._addFetchColumns(this.columns.joins);let t=null;try{t=this.statement.where?this.statement.where.toString():""}catch{throw new Error("Could not generate proper where clause")}this.columns.where&&this._addFetchColumns(this.columns.where);let r=this._isSimpleSelect();if(r?this._addFetchColumns(this.columns.columns):(!this.columns.where&&this.fetch_attributes.length===0)|t.indexOf(XH)>-1&&this.tables.forEach(n=>{let i={columnid:global.hdb_schema[n.databaseid][n.tableid].hash_attribute,tableid:n.tableid};this._addFetchColumns([i])}),this.statement.order&&(this._updateOrderByToAliases(),this._addNonAggregatorsToFetchColumns()),this.fetch_attributes=Si.uniqBy(this.fetch_attributes,n=>[n.table.databaseid,n.table.as?n.table.as:n.table.tableid,n.attribute].join()),r)return await this._simpleSQLQuery();let s=this.fetch_attributes.reduce((n,i)=>{let o=`${i.table.databaseid}_${i.table.as?i.table.as:i.table.tableid}`,c=this.data[o].__hash_name;return n[o]||(n[o]=[],n[o].push(null),this._addColumnToMergedAttributes(o,c)),i.attribute!==c&&(n[o].push(null),this._addColumnToMergedAttributes(o,i.attribute)),n},{});for(let n of this.fetch_attributes){let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`,o=this.data[i].__hash_name,c={schema:n.table.databaseid,table:n.table.tableid,get_attributes:[n.attribute]},_=!1,u=[n.table.databaseid,n.table.tableid,n.attribute].join("/");if(n.attribute===o&&(_=!0),!G.isEmpty(this.exact_search_values[u])&&!this.exact_search_values[u].ignore&&!G.isEmptyOrZeroLength(this.exact_search_values[u].values))if(_)try{c.hash_values=Array.from(this.exact_search_values[u].values);let l=await ln.getDataByHash(c);for(let E of c.hash_values)E in l&&!this.data[i].__merged_data[E]&&(this.data[i].__merged_data[E]=[...s[i]],this._setMergedHashAttribute(i,E))}catch(l){v.error("Error thrown from getDataByHash function in SQLSearch class method getFetchAttributeValues exact match."),v.error(l)}else try{c.search_attribute=n.attribute,await Promise.all(Array.from(this.exact_search_values[u].values).map(async l=>{let E=Object.assign({},c);E.search_value=l;let d=await ln.getDataByValue(E);for(let h in d)this.data[i].__merged_data[h]?this._updateMergedAttribute(i,h,n.attribute,d[h][n.attribute]):(this.data[i].__merged_data[h]=[...s[i]],this._updateMergedAttribute(i,h,n.attribute,d[h][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(h)))}))}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues exact match."),v.error(l)}else if(!G.isEmpty(this.comparator_search_values[u])&&!this.comparator_search_values[u].ignore&&!G.isEmptyOrZeroLength(this.comparator_search_values[u].comparators))try{let l=this.comparator_search_values[u].comparators;for(let E=0,d=l.length;E<d;E++){let h=l[E];c.search_attribute=h.attribute,c.search_value=h.search_value;let m=await ln.getDataByValue(c,h.operation);if(_)for(let R in m)this.data[i].__merged_data[R]||(this.data[i].__merged_data[R]=[...s[i]],this._setMergedHashAttribute(i,G.autoCast(R)));else for(let R in m)this.data[i].__merged_data[R]?this._updateMergedAttribute(i,R,n.attribute,m[R][n.attribute]):(this.data[i].__merged_data[R]=[...s[i]],this._updateMergedAttribute(i,R,n.attribute,m[R][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(R)))}}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues comparator search values."),v.error(l)}else try{c.search_attribute=n.attribute,c.search_value="*";let l=await ln.getDataByValue(c);if(_)for(let E in l)this.data[i].__merged_data[E]||(this.data[i].__merged_data[E]=[...s[i]],this._setMergedHashAttribute(i,G.autoCast(E)));else for(let E in l)this.data[i].__merged_data[E]?this._updateMergedAttribute(i,E,n.attribute,l[E][n.attribute]):(this.data[i].__merged_data[E]=[...s[i]],this._updateMergedAttribute(i,E,n.attribute,l[E][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(E)))}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues no comparator search values."),v.error(l)}}}_isSimpleSelect(){let t=!0;return Object.keys(this.statement).length!==2||!this.statement.columns||!this.statement.from||this.statement.from.length!==1?(t=!1,t):(this.statement.columns.forEach(r=>{r instanceof Me.yy.Column||(t=!1)}),t)}_updateOrderByToAliases(){this.statement.order.forEach(t=>{if(t.expression.aggregatorid){t.is_aggregator=!0;return}if(t.expression.value){t.is_ordinal=!0,this.has_ordinal=!0;return}else t.is_ordinal=!1;let r=this.statement.columns.filter(n=>{let i=n.aggregatorid?n.expression:n,o=n.aggregatorid?n.as_orig:i.as_orig;return t.expression.tableid?i.columnid_orig===t.expression.columnid_orig&&i.tableid_orig===t.expression.tableid_orig:i.columnid_orig===t.expression.columnid_orig||t.expression.columnid_orig===o});r[0]||r.push(this._findColumn(t.expression));let s=r[0];if(t.is_func=!!s.funcid,t.is_aggregator=!!s.aggregatorid,s.as)if(s.as&&!t.expression.tableid)t.expression.columnid=s.as,t.expression.columnid_orig=s.as_orig;else{let n=new Me.yy.Column;n.columnid=s.as,n.columnid_orig=s.as_orig,t.expression=n}else{t.initial_select_column=Object.assign(new Me.yy.Column,t.expression),t.initial_select_column.as=`[${t.expression.columnid_orig}]`,t.expression.columnid=t.initial_select_column.as;return}if(!t.is_aggregator){let n=t.is_func?new Me.yy.FuncValue:new Me.yy.Column;t.initial_select_column=Object.assign(n,s)}})}_addNonAggregatorsToFetchColumns(){let r=this.statement.order.filter(s=>!s.is_aggregator&&!s.is_ordinal).map(s=>s.is_func?{columnid:s.initial_select_column.args.filter(i=>!!i.columnid_orig)[0].columnid_orig}:{columnid:s.expression.columnid_orig});this._addFetchColumns(r)}async _processJoins(){let t=[],r=[],s=this.statement.from[0],n=[s],i=["? "+(s.as?" AS "+s.as:s.tableid)];t.push(Object.values(this.data[`${s.databaseid_orig}_${s.as?s.as_orig:s.tableid_orig}`].__merged_data)),this.statement.joins&&this.statement.joins.forEach(h=>{h.joinmode&&h.joinmode!=="INNER"&&(this.has_outer_join=!0),n.push(h.table);let m=h.joinmode+" JOIN ? AS "+(h.as?h.as:h.table.tableid);h.on&&(m+=" ON "+h.on.toString()),i.push(m),t.push(Object.values(this.data[`${h.table.databaseid_orig}_${h.table.as?h.table.as_orig:h.table.tableid_orig}`].__merged_data))});let o=[],c={};n.forEach(h=>{let m=this.data[`${h.databaseid_orig}_${h.as?h.as_orig:h.tableid_orig}`].__hash_name,R=h.as?h.as_orig:h.tableid_orig;o.push({key:`'${R}.${m}'`,schema:h.databaseid_orig,table:h.as?h.as_orig:h.tableid_orig,keys:new Set}),r.push(`${h.as?h.as:h.tableid}.\`${m}\` AS "${R}.${m}"`),c[h.as?h.as_orig:h.tableid_orig]=this.data[`${h.databaseid_orig}_${h.as?h.as_orig:h.tableid_orig}`].__merged_attributes});let _=this.statement.where?"WHERE "+this.statement.where:"",u="";this.statement.order&&!this.has_ordinal&&!this.has_aggregator&&!this.statement.group&&this.statement.limit&&(u="ORDER BY "+this.statement.order.toString(),this.statement.order.forEach(h=>{h.is_func?r.push(h.initial_select_column.toString()):h.initial_select_column.tableid?r.push(`${h.initial_select_column.tableid}.${h.initial_select_column.columnid} AS ${h.expression.columnid}`):r.push(`${h.initial_select_column.columnid} AS ${h.expression.columnid}`)}));let l="",E="";!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(l=this.statement.limit?"LIMIT "+this.statement.limit:"",E=this.statement.offset?"OFFSET "+this.statement.offset:"");let d=[];try{let h=`SELECT ${r.join(", ")} FROM ${i.join(" ")} ${_} ${u} ${l} ${E}`,m=this._convertColumnsToIndexes(h,n);d=await Me.promise(m,t),t=null}catch(h){throw v.error("Error thrown from AlaSQL in SQLSearch class method processJoins."),v.error(h),new Error("There was a problem processing the data.")}if(d&&d.length>0){for(let h=0,m=d.length;h<m;h++){let R=d[h];o.forEach(w=>{R[w.key]!==null&&R[w.key]!==void 0&&w.keys.add(R[w.key])})}o.forEach(h=>{let m=Object.keys(this.data[`${h.schema}_${h.table}`].__merged_data),R=Si.difference(m,[...h.keys].map(w=>w.toString()));for(let w=0,L=R.length;w<L;w++){let B=R[w];delete this.data[`${h.schema}_${h.table}`].__merged_data[B]}})}return{existing_attributes:c,joined_length:d?d.length:0}}async _getFinalAttributeData(t,r){if(r===0)return;let s=[],n=new Uo(this.columns);for(let{node:i}of n)if(i&&i.columnid){let o=this._findColumn(i);if(o){let c=o.table.as?o.table.as:o.table.tableid;(!t[c]||t[c].indexOf(o.attribute)<0)&&s.push(o)}}s=Si.uniqBy(s,i=>[i.table.databaseid,i.table.as?i.table.as:i.table.tableid,i.attribute].join());try{await this._getData(s)}catch(i){v.error("Error thrown from getData in SQLSearch class method getFinalAttributeData."),v.error(i)}}async _getData(t){try{let r=t.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]?s[i].columns.push(n.attribute):s[i]={schema:n.table.databaseid,table:n.table.tableid,columns:[n.attribute]},s},{});for(let s in r){let n=r[s],i=this.data[s].__merged_data,o=[];for(let l in i)o.push(i[l][0]);this.data[s].__merged_attributes.push(...n.columns);let c={schema:n.schema,table:n.table,hash_values:o,get_attributes:n.columns},_=await ln.getDataByHash(c),u=n.columns.length;for(let l=0,E=o.length;l<E;l++){let d=o[l],h=_[d];for(let m=0;m<u;m++){let R=n.columns[m],w=h[R]===void 0?null:h[R];this.data[s].__merged_data[d].push(w)}}}}catch(r){throw v.error("Error thrown from getDataByHash function in SQLSearch class method getData."),v.error(r),r}}async _finalSQL(){let t=[],r=this.statement.from[0];t.push(Object.values(this.data[`${r.databaseid_orig}_${r.as?r.as_orig:r.tableid_orig}`].__merged_data)),r.as=r.as?r.as:r.tableid,r.databaseid="",r.tableid="?",this.statement.joins&&this.statement.joins.forEach(n=>{n.as=n.as?n.as:n.table.tableid,t.push(Object.values(this.data[`${n.table.databaseid_orig}_${n.table.as?n.table.as_orig:n.table.tableid_orig}`].__merged_data)),n.table.databaseid="",n.table.tableid="?"}),this.statement.order&&this.statement.order.forEach(n=>{if(n.is_ordinal)return;this.statement.columns.filter(o=>{let c=o.aggregatorid?o.expression:o,_=o.aggregatorid?o.as_orig:c.as_orig;return n.expression.tableid?c.columnid_orig===n.expression.columnid_orig&&c.tableid_orig===n.expression.tableid_orig:c.columnid_orig===n.expression.columnid_orig||n.expression.columnid_orig===_}).length===0&&(n.expression.columnid=n.initial_select_column.columnid)}),!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(this.statement.limit&&delete this.statement.limit,this.statement.offset&&delete this.statement.offset);let s;try{let n=this._buildSQL();v.trace(`Final SQL: ${n}`),s=await Me.promise(n,t),this.has_outer_join&&(s=this._translateUndefinedValues(s)),v.trace(`Final AlaSQL results data included ${s.length} rows`)}catch(n){throw v.error("Error thrown from AlaSQL in SQLSearch class method finalSQL."),v.error(n),new Error("There was a problem running the generated sql.")}return s}_translateUndefinedValues(t){try{let r=[];for(let s of t){let n=Object.create(null);Object.keys(s).forEach(i=>{s[i]===void 0?n[i]=null:n[i]=s[i]}),r.push(n)}return r}catch(r){return v.error(ZH.HDB_ERROR_MSGS.OUTER_JOIN_TRANSLATION_ERROR),v.trace(r.stack),t}}_buildSQL(t=!0){let r=this.statement.toString();return this.statement.columns.forEach(s=>{if(s.funcid&&s.as){let n=s.toString().replace(" AS "+s.as,"");r=r.replace(s.toString(),n)}}),t===!0?this._convertColumnsToIndexes(r,this.tables):r}_convertColumnsToIndexes(t,r){let s=t,n={};r.forEach(i=>{i.databaseid_orig?n[`${i.databaseid_orig}_${i.as?i.as_orig:i.tableid_orig}`]=i.as?i.as:i.tableid:n[`${i.databaseid}_${i.as?i.as:i.tableid}`]=`\`${i.as?i.as:i.tableid}\``});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let _=n[i],u=new RegExp(`${_}.\`${o}\``,"g"),l=`${_}.[${c}]`;s=s.replace(u,l)});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let _=new RegExp(`\`${o}\``,"g"),u=`[${c}]`;s=s.replace(_,u)});return s}async _simpleSQLQuery(){let t=this.statement.columns.reduce((s,n)=>(n.as_orig&&n.as_orig!=n.columnid_orig?s[n.columnid_orig]=n.as_orig:s[n.columnid_orig]||(s[n.columnid_orig]=n.columnid_orig),s),{}),r=this.fetch_attributes.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]||(s[i]={}),s[i][t[n.attribute]]=null,s},{});for(let s of this.fetch_attributes){let n=`${s.table.databaseid}_${s.table.as?s.table.as:s.table.tableid}`,i={schema:s.table.databaseid,table:s.table.tableid,get_attributes:[s.attribute]};try{i.search_attribute=s.attribute,i.search_value="*";let o=await ln.getDataByValue(i);for(let c in o)this.data[n].__merged_data[c]||(this.data[n].__merged_data[c]=Object.assign({},r[n])),this.data[n].__merged_data[c][t[s.attribute]]=o[c][s.attribute]}catch(o){v.error("There was an error when processing this SQL operation.  Check your logs"),v.error(o)}}return Object.values(Object.values(this.data)[0].__merged_data)}};a(yo,"SQLSearch");$m.exports=yo});var mt=S((YZ,Qm)=>{"use strict";var zH=sS();Qm.exports={searchByConditions:rG,searchByHash:sG,searchByValue:nG,search:iG};var dl=Or(),Km=require("util"),jH=Km.callbackify(dl.searchByHash),eG=Km.callbackify(dl.searchByValue),tG=Ym();async function rG(e){return dl.searchByConditions(e)}a(rG,"searchByConditions");function sG(e,t){try{jH(e,(r,s)=>{if(r){t(r);return}t(null,s)})}catch(r){return t(r)}}a(sG,"searchByHash");function nG(e,t){try{e.hasOwnProperty("desc")===!0&&(e.reverse=e.desc),eG(e,(r,s)=>{if(r){t(r);return}t(null,s)})}catch(r){return t(r)}}a(nG,"searchByValue");function iG(e,t){try{let r=new zH(e);r.validate(),new tG(r.statement,r.attributes).search().then(n=>{t(null,n)}).catch(n=>{t(n,null)})}catch(r){return t(r)}}a(iG,"search")});var Vr=S((KZ,Xm)=>{"use strict";var Ti=require("crypto"),Jm="aes-256-cbc",aG=32,oG=16,hl=64,Zm=32,cG=hl+Zm,Wm=new Map;Xm.exports={encrypt:_G,decrypt:uG,createNatsTableStreamName:lG};function _G(e){let t=Ti.randomBytes(aG),r=Ti.randomBytes(oG),s=Ti.createCipheriv(Jm,Buffer.from(t),r),n=s.update(e);n=Buffer.concat([n,s.final()]);let i=t.toString("hex"),o=r.toString("hex"),c=n.toString("hex");return i+o+c}a(_G,"encrypt");function uG(e){let t=e.substr(0,hl),r=e.substr(hl,Zm),s=e.substr(cG,e.length),n=Buffer.from(r,"hex"),i=Buffer.from(s,"hex"),o=Ti.createDecipheriv(Jm,Buffer.from(t,"hex"),n),c=o.update(i);return c=Buffer.concat([c,o.final()]),c.toString()}a(uG,"decrypt");function lG(e,t){let r=`${e}.${t}`,s=Wm.get(r);return s||(s=Ti.createHash("md5").update(`${e}.${t}`).digest("hex"),Wm.set(r,s)),s}a(lG,"createNatsTableStreamName")});var fs=S((QZ,nR)=>{"use strict";var jm=mt(),kr=I(),eR=Ka(),EG=require("lodash"),dG=require("path"),hG=Vr(),Sl=b(),{promisify:tR}=require("util"),j=T(),{handleHDBError:Do,hdb_errors:SG}=D(),{HDB_ERROR_MSGS:Mo,HTTP_STATUS_CODES:rR}=SG,fG=Y();fG.initSync();var zm=Z(),TG=te(),mi=tR(jm.searchByValue),mG=tR(jm.searchByHash),En="name",sR="hash_attribute",fl="schema",RG="schema_table",AG="attribute";nR.exports={describeAll:OG,describeTable:Po,describeSchema:NG};async function OG(e){try{let t=Sl.isEmptyOrZeroLength(e),r,s;t||(r=e.hdb_user.role.permission,s=r.super_user||r.cluster_user);let n={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,search_attribute:En,search_value:j.WILDCARD_SEARCH_VALUE,get_attributes:[En]},i=await mi(n);if(Sl.isEmptyOrZeroLength(i))return{};let o={},c={};for(let d in i)o[i[d].name]=!0,!t&&!s&&(c[i[d].name]=r[i[d].name].describe);let _={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,search_attribute:j.ID_ATTRIBUTE_STRING,search_value:j.WILDCARD_SEARCH_VALUE,get_attributes:[sR,j.ID_ATTRIBUTE_STRING,En,fl]},u=await mi(_),l=[];for(let d of u)try{let h;if(t||s)h=await Po({schema:d.schema,table:d.name});else if(r&&r[d.schema].describe&&r[d.schema].tables[d.name].describe){let m=r[d.schema].tables[d.name].attribute_permissions;h=await Po({schema:d.schema,table:d.name},m)}h&&l.push(h)}catch(h){kr.error(h)}let E={};for(let d in l)t||s?(E[l[d].schema]==null&&(E[l[d].schema]={}),E[l[d].schema][l[d].name]=l[d],o[l[d].schema]&&delete o[l[d].schema]):c[l[d].schema]&&(E[l[d].schema]==null&&(E[l[d].schema]={}),E[l[d].schema][l[d].name]=l[d],o[l[d].schema]&&delete o[l[d].schema]);for(let d in o)t||s?E[d]={}:c[d]&&(E[d]={});return E}catch(t){return kr.error("Got an error in describeAll"),kr.error(t),Do(new Error,Mo.DESCRIBE_ALL_ERR)}}a(OG,"describeAll");async function Po(e,t){let{schema:r,table:s}=e;r=r.toString(),s=s.toString();let n=t;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(n=e.hdb_user.role.permission[r].tables[s].attribute_permissions);let i={},o=eR.describe_table(e);if(o)throw o;if(r===j.SYSTEM_SCHEMA_NAME)return global.hdb_schema[j.SYSTEM_SCHEMA_NAME][s];let c={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.TABLE_TABLE_HASH_ATTRIBUTE,search_attribute:En,search_value:s,hash_values:[],get_attributes:[j.WILDCARD_SEARCH_VALUE]},_=await mi(c);if(!_||_.length===0)throw Do(new Error,Mo.TABLE_NOT_FOUND(e.schema,e.table),rR.NOT_FOUND);for await(let u of _)try{if(u.schema!==r)continue;if(i=u,!i.hash_attribute)throw Do(new Error,Mo.INVALID_TABLE_ERR(i));let l={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.ATTRIBUTE_TABLE_HASH_ATTRIBUTE,search_attribute:RG,search_value:r+"."+s,get_attributes:[AG]},E=await mi(l);E=EG.uniqBy(E,d=>d.attribute),n&&n.length>0&&(E=pG(n)),i.attributes=E,i.clustering_stream_name=hG.createNatsTableStreamName(u.schema,u.name);try{let d=dG.join(TG.getBaseSchemaPath(),i.schema.toString()),h=await zm.openEnvironment(d,i.name),m=zm.statDBI(h,i.hash_attribute);i.record_count=m.entryCount}catch(d){kr.warn(`unable to stat table dbi due to ${d}`)}}catch(l){kr.error(`There was an error getting attributes for table '${u.name}'`),kr.error(l)}return i}a(Po,"descTable");function pG(e){return e.reduce((t,r)=>(r.describe&&t.push({attribute:r.attribute_name}),t),[])}a(pG,"getAttrsByPerms");async function NG(e){let t=eR.schema_object(e);if(t)throw t;let r;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(r=e.hdb_user.role.permission[e.schema]);let s=e.schema.toString(),n={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.TABLE_TABLE_HASH_ATTRIBUTE,search_attribute:fl,search_value:s,hash_values:[],get_attributes:[sR,j.ID_ATTRIBUTE_STRING,En,fl]},i=await mi(n);if(i&&i.length<1){let o={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.SCHEMA_TABLE_HASH_ATTRIBUTE,hash_values:[s],get_attributes:[En]},c=await mG(o);if(c&&c.length<1)throw Do(new Error,Mo.SCHEMA_NOT_FOUND(e.schema),rR.NOT_FOUND);return{}}else{let o={};return await Promise.all(i.map(async c=>{try{let _;if(r&&r.tables[c.name]&&(_=r.tables[c.name]),Sl.isEmpty(_)||_.describe){let u=await Po({schema:e.schema,table:c.name},_?_.attribute_permissions:null);u&&(o[u.name]=u)}}catch(_){kr.error(`Error describing schema table '${e.schema}.${c}'`),kr.error(_)}})),o}}a(NG,"describeSchema")});var xr=S((ZZ,_R)=>{var WZ=require("async"),dn=is(),JZ=I(),{callbackify:oR,promisify:gG}=require("util");_R.exports={setSchemaDataToGlobal:iR,getTableSchema:CG,getSystemSchema:LG,setSchemaDataToGlobalAsync:gG(iR)};var cR=fs(),IG=oR(cR.describeAll),bG=oR(cR.describeTable);function iR(e){IG(null,(t,r)=>{if(t){e(t);return}r.system||(r.system=dn),global.hdb_schema=r,e(null,null)})}a(iR,"setSchemaDataToGlobal");function aR(e,t){return e==="system"?dn[t]:global.hdb_schema[e][t]}a(aR,"returnSchema");function CG(e,t,r){!global.hdb_schema||!global.hdb_schema[e]||!global.hdb_schema[e][t]?wG(e,t,s=>{if(s)return r(s);if(!global.hdb_schema[e])return r(`schema ${e} does not exist`);if(!global.hdb_schema[e]||!global.hdb_schema[e][t])return r(`table ${e}.${t} does not exist`);r(null,aR(e,t))}):r(null,aR(e,t))}a(CG,"getTableSchema");function wG(e,t,r){let s={table:t,schema:e};if(e==="system"){global.hdb_schema?global.hdb_schema.system=dn:global.hdb_schema={system:dn},r();return}bG(s,(n,i)=>{if(n){r(n);return}if(!i.schema&&!i.name){r();return}global.hdb_schema||(global.hdb_schema={system:dn}),global.hdb_schema[e]||(global.hdb_schema[e]={}),global.hdb_schema[e][t]=i,r()})}a(wG,"setTableDataToGlobal");function LG(){return dn}a(LG,"getSystemSchema")});var ER=S((XZ,lR)=>{"use strict";var Tl=Z(),UG=I(),uR=Ke().LMDB_ERRORS_ENUM;lR.exports=yG;async function yG(e){try{if(global.lmdb_map!==void 0&&e.operation!==void 0){let t=Object.keys(global.lmdb_map),r;switch(e.operation){case"drop_schema":for(let i=0;i<t.length;i++){let o=t[i];if(o.startsWith(`${e.schema}.`)||o.startsWith(`txn.${e.schema}.`))try{await Tl.closeEnvironment(global.lmdb_map[o])}catch(c){if(c.message!==uR.ENV_REQUIRED)throw c}}break;case"drop_table":let s=`${e.schema}.${e.table}`,n=`txn.${s}`;try{await Tl.closeEnvironment(global.lmdb_map[s]),await Tl.closeEnvironment(global.lmdb_map[n])}catch(i){if(i.message!==uR.ENV_REQUIRED)throw i}break;case"drop_attribute":r=global.lmdb_map[`${e.schema}.${e.table}`],r!==void 0&&typeof r.dbis=="object"&&r.dbis[`${e.attribute}`]!==void 0&&delete r.dbis[`${e.attribute}`];break;default:break}}}catch(t){UG.error(t)}}a(yG,"cleanLMDBMap")});var Ut=S((zZ,SR)=>{"use strict";var vo=Hu(),Lt=b(),DG=require("util"),Ho=Or(),MG=xr(),ml=I(),{handleHDBError:$r,hdb_errors:PG}=D(),{HTTP_STATUS_CODES:Ts}=PG,BG=DG.promisify(MG.getTableSchema),vG="updated",dR="inserted",hR="upserted";SR.exports={insert:GG,update:qG,upsert:FG,validation:HG,flush:VG};async function HG(e){if(Lt.isEmpty(e))throw new Error("invalid update parameters defined.");if(Lt.isEmptyOrZeroLength(e.schema))throw new Error("invalid schema specified.");if(Lt.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");let t=await BG(e.schema,e.table),r=vo(e);if(r)throw r;if(!Array.isArray(e.records))throw new Error("records must be an array");let s=t.hash_attribute,n=new Set,i={},o=!1;return e.operation==="update"&&(o=!0),e.records.forEach(c=>{if(o&&Lt.isEmptyOrZeroLength(c[s]))throw ml.error("a valid hash attribute must be provided with update record:",c),new Error("a valid hash attribute must be provided with update record");if(!Lt.isEmptyOrZeroLength(c[s])&&(c[s]==="null"||c[s]==="undefined"))throw ml.error(`a valid hash value must be provided with ${e.operation} record:`,c),new Error(`"${c[s]}" is not a valid hash attribute value`);!Lt.isEmpty(c[s])&&c[s]!==""&&n.has(Lt.autoCast(c[s]))&&(c.skip=!0),n.add(Lt.autoCast(c[s]));for(let _ in c)i[_]=1}),i[s]=1,{schema_table:t,hashes:Array.from(n),attributes:Object.keys(i)}}a(HG,"validation");async function GG(e){if(e.operation!=="insert")throw new Error("invalid operation, must be insert");let t=vo(e);if(t)throw $r(new Error,t.message,Ts.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw $r(new Error,r,Ts.BAD_REQUEST);try{let s=await Ho.createRecords(e);return Bo(dR,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time)}catch(s){throw s}}a(GG,"insertData");async function qG(e){if(e.operation!=="update")throw new Error("invalid operation, must be update");let t=vo(e);if(t)throw $r(new Error,t.message,Ts.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw $r(new Error,r,Ts.BAD_REQUEST);try{let s=await Ho.updateRecords(e);return Lt.isEmpty(s.existing_rows)?Bo(vG,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time):Bo(s.update_action,[],e,s.hashes,void 0,s.txn_time)}catch(s){throw s}}a(qG,"updateData");async function FG(e){if(e.operation!=="upsert")throw $r(new Error,"invalid operation, must be upsert",Ts.INTERNAL_SERVER_ERROR);let t=vo(e);if(t)throw $r(new Error,t.message,Ts.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw $r(new Error,r,Ts.BAD_REQUEST);try{let s=await Ho.upsertRecords(e);return Bo(hR,s.written_hashes,e,[],s.new_attributes,s.txn_time)}catch(s){let n=`There was an error during an upsert op: ${s}`;throw $r(s,null,null,ml.ERR,n)}}a(FG,"upsertData");function Bo(e,t,r,s,n,i){let o={message:`${e} ${t.length} of ${t.length+s.length} records`,new_attributes:n,txn_time:i};return e===dR?(o.inserted_hashes=t,o.skipped_hashes=s,o):e===hR?(o.upserted_hashes=t,o):(o.update_hashes=t,o.skipped_hashes=s,o)}a(Bo,"returnObject");function VG(e){return Ho.flush(e.schema,e.table)}a(VG,"flush")});var Al=S((jZ,mR)=>{var kG=he(),Rl=require("joi"),{hdb_schema_table:fR}=Tr(),TR={schema:fR,table:fR},xG={date:Rl.date().iso().required()},$G={timestamp:Rl.date().timestamp().required().messages({"date.format":"'timestamp' is invalid"})};mR.exports=function(e,t){let r=t==="timestamp"?{...TR,...$G}:{...TR,...xG},s=Rl.object(r);return kG.validateBySchema(e,s)}});var pR=S((eX,OR)=>{var YG=he(),RR=require("joi"),{hdb_schema_table:AR}=Tr(),KG=RR.object({schema:AR,table:AR,hash_values:RR.array().required()});OR.exports=function(e){return YG.validateBySchema(e,KG)}});var gR=S((tX,NR)=>{"use strict";var Go=class{constructor(t,r,s,n,i){this.operation=t,this.schema=r,this.table=s,this.hash_attribute=n,this.records=i}};a(Go,"InsertObject");var qo=class{constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.search_attribute=s,this.hash_attribute=n,this.get_attributes=i,this.search_value=o}};a(qo,"NoSQLSeachObject");var Fo=class{constructor(){this.message=void 0,this.deleted_hashes=[],this.skipped_hashes=[]}};a(Fo,"DeleteResponseObject");NR.exports={InsertObject:Go,NoSQLSeachObject:qo,DeleteResponseObject:Fo}});var Rs=S((rX,LR)=>{"use strict";var bR=Al(),QG=pR(),Vo=b(),IR=require("moment"),CR=I(),{promisify:WG,callbackify:JG}=require("util"),ms=T(),ZG=xr(),Ol=WG(ZG.getTableSchema),pl=Or(),{DeleteResponseObject:XG}=gR(),{handleHDBError:Yr,hdb_errors:zG}=D(),{HDB_ERROR_MSGS:ko,HTTP_STATUS_CODES:Kr}=zG,jG="records successfully deleted",eq=JG(wR);LR.exports={delete:eq,deleteRecord:wR,deleteFilesBefore:tq,deleteAuditLogsBefore:rq};async function tq(e){let t=bR(e,"date");if(t)throw Yr(t,t.message,Kr.BAD_REQUEST,void 0,void 0,!0);if(!IR(e.date,IR.ISO_8601).isValid())throw Yr(new Error,ko.INVALID_DATE,Kr.BAD_REQUEST,ms.LOG_LEVELS.ERROR,ko.INVALID_DATE,!0);let s=Vo.checkSchemaTableExist(e.schema,e.table);if(s)throw Yr(new Error,s,Kr.NOT_FOUND,ms.LOG_LEVELS.ERROR,s,!0);try{let n=await pl.deleteRecordsBefore(e);if(await Ol(e.schema,e.table),CR.info(`Finished deleting files before ${e.date}`),n&&n.message)return n.message}catch(n){throw n}}a(tq,"deleteFilesBefore");async function rq(e){let t=bR(e,"timestamp");if(t)throw Yr(t,t.message,Kr.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e.timestamp))throw Yr(new Error,ko.INVALID_VALUE("Timestamp"),Kr.BAD_REQUEST,ms.LOG_LEVELS.ERROR,ko.INVALID_VALUE("Timestamp"),!0);let r=Vo.checkSchemaTableExist(e.schema,e.table);if(r)throw Yr(new Error,r,Kr.NOT_FOUND,ms.LOG_LEVELS.ERROR,r,!0);try{let s=await pl.deleteAuditLogsBefore(e);return await Ol(e.schema,e.table),CR.info(`Finished deleting audit logs before ${e.timestamp}`),s}catch(s){throw s}}a(rq,"deleteAuditLogsBefore");async function wR(e){let t=QG(e);if(t)throw Yr(t,t.message,Kr.BAD_REQUEST,void 0,void 0,!0);let r=Vo.checkSchemaTableExist(e.schema,e.table);if(r)throw Yr(new Error,r,Kr.NOT_FOUND,ms.LOG_LEVELS.ERROR,r,!0);try{await Ol(e.schema,e.table);let s=await pl.deleteRecords(e);return Vo.isEmptyOrZeroLength(s.message)&&(s.message=`${s.deleted_hashes.length} of ${e.hash_values.length} ${jG}`),s}catch(s){if(s.message===ms.SEARCH_NOT_FOUND_MESSAGE){let n=new XG;return n.message=ms.SEARCH_NOT_FOUND_MESSAGE,n.skipped_hashes=e.hash_values.length,n.deleted_hashes=0,n}throw s}}a(wR,"deleteRecord")});var xo=S((sX,DR)=>{var sq=require("crypto"),UR=9;function nq(e){let t=aq(UR),r=yR(e+t);return t+r}a(nq,"createHash");function iq(e,t){let r=e.substr(0,UR),s=r+yR(t+r);return e===s}a(iq,"validateHash");function aq(e){let t="0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ",r=t.length,s="";for(let n=0;n<e;n++){let i=Math.floor(Math.random()*r);s+=t[i]}return s}a(aq,"generateSalt");function yR(e){return sq.createHash("md5").update(e).digest("hex")}a(yR,"md5");DR.exports={hash:nq,validate:iq}});var PR=S((nX,MR)=>{var Nl=he(),Je={username:{presence:!0,format:"[\\w\\-\\_]+",exclusion:{within:["system"],message:"You cannot create tables within the system schema"}},password:{presence:!0},role:{presence:!0,format:"[\\w\\-\\_]+"},active:{presence:!0,inclusion:{within:[!0,!1],message:"must be a boolean"}}};function oq(e){return Je.password.presence=!0,Je.username.presence=!0,Je.role.presence=!0,Je.active.presence=!0,Nl.validateObject(e,Je)}a(oq,"addUserValidation");function cq(e){return Je.password.presence=!1,Je.username.presence=!0,Je.role.presence=!1,Je.active.presence=!1,Nl.validateObject(e,Je)}a(cq,"alterUserValidation");function _q(e){return Je.password.presence=!1,Je.username.presence=!0,Je.role.presence=!1,Je.active.presence=!1,Nl.validateObject(e,Je)}a(_q,"dropUserValidation");MR.exports={addUserValidation:oq,alterUserValidation:cq,dropUserValidation:_q}});var _e=S((aX,vR)=>{"use strict";var{platform:iX}=require("os"),uq="nats-server.zip",gl="nats-server",lq=process.platform==="win32"?`${gl}.exe`:gl,Il="HDB",Eq=/^[^\s.,*>]+$/,BR="__request__",dq=a(e=>`${e}.${BR}`,"REQUEST_SUBJECT"),hq={HUB_SERVER:"hub.json",LEAF_SERVER:"leaf.json"},Sq={HUB:"hub.pid",LEAF:"leaf.pid"},fq={HUB:"-hub",LEAF:"-leaf",ADMIN:"-admin"},Tq={stream_name:"__HARPERDB_WORK_QUEUE__",durable_name:"HDB_WORK_QUEUE",deliver_group:Il,deliver_subject:"__HDB__.WORKQUEUE"},mq={stream_name:"__HARPERDB_SCHEMA_QUEUE__",durable_name:"HDB_SCHEMA_QUEUE",deliver_group:Il,deliver_subject:"HDB.SCHEMAQUEUE"},Rq={stream_name:"__HARPERDB_USER_QUEUE__",durable_name:"HDB_USER_QUEUE",deliver_group:Il,deliver_subject:"HDB.USERQUEUE"},Aq={SUCCESS:"success",ERROR:"error"},Oq={OPEN:"open",CLOSED:"closed",NO_RESPONDERS:"NoResponders",TIMEOUT:"Timeout"},pq={TXN:"txn",MSGID:"msgid"};vR.exports={NATS_SERVER_ZIP:uq,NATS_SERVER_NAME:gl,NATS_BINARY_NAME:lq,PID_FILES:Sq,NATS_CONFIG_FILES:hq,SERVER_SUFFIX:fq,WORK_QUEUE_CONSUMER_NAMES:Tq,SCHEMA_QUEUE_CONSUMER_NAMES:mq,USER_QUEUE_CONSUMER_NAMES:Rq,NATS_TERM_CONSTRAINTS_RX:Eq,REQUEST_SUFFIX:BR,UPDATE_REMOTE_RESPONSE_STATUSES:Aq,CLUSTER_STATUS_STATUSES:Oq,REQUEST_SUBJECT:dq,SUBJECT_PREFIXES:pq}});var GR=S((oX,HR)=>{"use strict";var Qr=T(),Ri=class{constructor(t=0,r=Qr.STORAGE_TYPES_ENUM.LMDB,s=Qr.LICENSE_VALUES.API_CALL_DEFAULT,n=Qr.RAM_ALLOCATION_ENUM.DEFAULT,i=Qr.LICENSE_VALUES.VERSION_DEFAULT,o){this.exp_date=t,this.storage_type=r,this.api_call=s,this.ram_allocation=n,this.version=i,this.fingerprint=o}};a(Ri,"BaseLicense");var $o=class extends Ri{constructor(t=0,r=Qr.STORAGE_TYPES_ENUM.LMDB,s=Qr.LICENSE_VALUES.API_CALL_DEFAULT,n=Qr.RAM_ALLOCATION_ENUM.DEFAULT,i=Qr.LICENSE_VALUES.VERSION_DEFAULT,o,c=!1){super(t,r,s,n,i,o),this.enterprise=c}};a($o,"ExtendedLicense");HR.exports={BaseLicense:Ri,ExtendedLicense:$o}});var Ai=S((cX,$R)=>{"use strict";var Sn=require("fs-extra"),qR=xo(),FR=require("crypto"),Nq=require("moment"),gq=require("uuid").v4,Ze=I(),Cl=require("path"),Iq=b(),Rt=T(),bq=GR().ExtendedLicense,hn="invalid license key format",Cq="061183",wq="mofi25",Lq="aes-256-cbc",Uq=16,yq=32,VR=Y();VR.initSync();var bl;$R.exports={validateLicense:kR,generateFingerPrint:Mq,licenseSearch:xR,getLicense:vq};function wl(){return Cl.join(VR.getHdbBasePath(),Rt.LICENSE_KEY_DIR_NAME,Rt.LICENSE_FILE_NAME)}a(wl,"getLicenseDirPath");function Dq(){let e=wl();return Cl.join(e,Rt.LICENSE_FILE_NAME)}a(Dq,"getLicenseFilePath");function Ll(){let e=wl();return Cl.join(e,Rt.REG_KEY_FILE_NAME)}a(Ll,"getFingerPrintFilePath");async function Mq(){let e=Ll();try{return await Sn.readFile(e,"utf8")}catch(t){if(t.code==="ENOENT")return await Pq();throw Ze.error(`Error writing fingerprint file to ${e}`),Ze.error(t),new Error("There was an error generating the fingerprint")}}a(Mq,"generateFingerPrint");async function Pq(){let e=gq(),t=qR.hash(e),r=Ll();try{await Sn.mkdirp(wl()),await Sn.writeFile(r,t)}catch(s){if(s.code==="EEXIST")return t;throw Ze.error(`Error writing fingerprint file to ${r}`),Ze.error(s),new Error("There was an error generating the fingerprint")}return t}a(Pq,"writeFingerprint");function kR(e,t){let r={valid_license:!1,valid_date:!1,valid_machine:!1,exp_date:null,storage_type:Rt.STORAGE_TYPES_ENUM.LMDB,api_call:Rt.LICENSE_VALUES.API_CALL_DEFAULT,ram_allocation:Rt.RAM_ALLOCATION_ENUM.DEFAULT,version:Rt.LICENSE_VALUES.VERSION_DEFAULT};if(!e)return Ze.error("empty license key passed to validate."),r;let s=Ll(),n=!1;try{n=Sn.statSync(s)}catch(i){Ze.error(i)}if(n){let i;try{i=Sn.readFileSync(s,"utf8")}catch{Ze.error("error validating this machine in the license"),r.valid_machine=!1;return}let o=e.split(wq),c=o[1];c=Buffer.concat([Buffer.from(c)],Uq);let _=Buffer.concat([Buffer.from(i)],yq),u=FR.createDecipheriv(Lq,_,c);r.valid_date=!0,r.valid_license=!0,r.valid_machine=!0;let l=null;try{l=u.update(o[0],"hex","utf8"),l.trim(),l+=u.final("utf8")}catch{let h=Bq(o[0],i);if(h)l=h;else throw r.valid_license=!1,r.valid_machine=!1,console.error(hn),Ze.error(hn),new Error(hn)}let E;if(isNaN(l))try{E=JSON.parse(l),r.api_call=E.api_call,r.version=E.version,r.storage_type=E.storage_type,r.exp_date=E.exp_date,isNaN(r.exp_date)&&(r.exp_date=new Date(r.exp_date).getTime()),E.ram_allocation&&(r.ram_allocation=E.ram_allocation)}catch{throw console.error(hn),Ze.error(hn),new Error(hn)}else r.exp_date=l;r.exp_date<Nq().valueOf()&&(r.valid_date=!1),qR.validate(o[1],`${Cq}${i}${t}`)||(r.valid_license=!1)}else r.valid_license=!1,r.valid_machine=!1;return r.valid_license&&r.valid_machine&&r.valid_date||Ze.error("Invalid licence"),r}a(kR,"validateLicense");function Bq(e,t){try{let r=FR.createDecipher("aes192",t),s=r.update(e,"hex","utf8");return s.trim(),s+=r.final("utf8"),s}catch{Ze.warn("Check old license failed")}}a(Bq,"checkOldLicense");function xR(){let e=new bq;e.api_call=0;let t=[];try{t=Sn.readFileSync(Dq(),"utf-8").split(Rt.NEW_LINE)}catch(r){r.code==="ENOENT"?Ze.info("no license file found"):Ze.error(`could not search for licenses due to: '${r.message}`)}for(let r=0;r<t.length;++r){let s=t[r];try{if(Iq.isEmptyOrZeroLength(s))continue;let n=JSON.parse(s),i=kR(n.license_key,n.company);i.valid_machine===!0&&i.valid_date===!0&&i.valid_machine===!0&&(e.exp_date=i.exp_date>e.exp_date?i.exp_date:e.exp_date,e.api_call+=i.api_call,e.ram_allocation=i.ram_allocation,e.storage_type=i.storage_type,e.enterprise=!0)}catch(n){Ze.error("There was an error parsing the license string."),Ze.error(n),e.api_call=Rt.LICENSE_VALUES.API_CALL_DEFAULT,e.ram_allocation=Rt.RAM_ALLOCATION_ENUM.DEFAULT,e.storage_type=Rt.STORAGE_TYPES_ENUM.LMDB,e.enterprise=!1}}return e.api_call===0&&(e.api_call=Rt.LICENSE_VALUES.API_CALL_DEFAULT),bl=e,e}a(xR,"licenseSearch");async function vq(){return bl||await xR(),bl}a(vq,"getLicense")});var Wr=S((_X,nA)=>{"use strict";var WR="username is required",JR="nothing to update, must supply active, role or password to update",ZR="password cannot be an empty string",XR="If role is specified, it cannot be empty.",zR="active must be true or false";nA.exports={addUser:$q,alterUser:Yq,dropUser:Qq,userInfo:Wq,listUsers:Ko,listUsersExternal:Jq,setUsersToGlobal:Oi,findAndValidateUser:zq,getClusterUser:jq,USERNAME_REQUIRED:WR,ALTERUSER_NOTHING_TO_UPDATE:JR,EMPTY_PASSWORD:ZR,EMPTY_ROLE:XR,ACTIVE_BOOLEAN:zR};var jR=Ut(),Hq=Rs(),yl=xo(),eA=PR(),tA=mt(),Dl=js(),Ce=b(),rA=require("validate.js"),H=I(),{promisify:Ml}=require("util"),Pl=Vr(),As=T(),YR=_e(),Gq=Sr(),Bl=Y(),qq=Ai(),Fq=is(),{handleHDBError:rr,hdb_errors:Vq}=D(),{HTTP_STATUS_CODES:sr,AUTHENTICATION_ERROR_MSGS:Ul,HDB_ERROR_MSGS:fn}=Vq,{UserEventMsg:vl}=Gr(),KR=require("lodash"),sA={username:!0,active:!0,role:!0,password:!0},QR=new Map,Yo=Ml(tA.searchByValue),kq=Ml(tA.searchByHash),xq=Ml(Hq.delete);async function $q(e){let t=rA.cleanAttributes(e,sA),r=eA.addUserValidation(t);if(r)throw rr(new Error,r.message,sr.BAD_REQUEST,void 0,void 0,!0);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["id","permission","role"]},n;try{n=await Yo(s)}catch(u){throw H.error("There was an error searching for a role in add user"),H.error(u),u}if(!n||n.length<1)throw rr(new Error,fn.ROLE_NAME_NOT_FOUND(t.role),sr.NOT_FOUND,void 0,void 0,!0);if(n.length>1)throw rr(new Error,fn.DUP_ROLES_FOUND(t.role),sr.CONFLICT,void 0,void 0,!0);n[0].permission.cluster_user===!0&&(t.hash=Pl.encrypt(t.password)),t.password=yl.hash(t.password),t.role=n[0].id;let i={operation:"insert",schema:"system",table:"hdb_user",records:[t]},o;try{o=await jR.insert(i)}catch(u){throw H.error("There was an error searching for a user."),H.error(u),u}H.debug(o);try{await Oi()}catch(u){throw H.error("Got an error setting users to global"),H.error(u),u}if(o.skipped_hashes.length===1)throw rr(new Error,fn.USER_ALREADY_EXISTS(t.username),sr.CONFLICT,void 0,void 0,!0);let c=Object.assign({},t);c.role=n[0];let _={user:null};return _.user=c,Ce.sendTransactionToSocketCluster(As.INTERNAL_SC_CHANNELS.ADD_USER,_,Bl.get(As.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),Dl.signalUserChange(new vl(process.pid)),`${c.username} successfully added`}a($q,"addUser");async function Yq(e){let t=rA.cleanAttributes(e,sA);if(Ce.isEmptyOrZeroLength(t.username))throw new Error(WR);if(Ce.isEmptyOrZeroLength(t.password)&&Ce.isEmptyOrZeroLength(t.role)&&Ce.isEmptyOrZeroLength(t.active))throw new Error(JR);if(!Ce.isEmpty(t.password)&&Ce.isEmptyOrZeroLength(t.password.trim()))throw new Error(ZR);if(!Ce.isEmpty(t.active)&&!Ce.isBoolean(t.active))throw new Error(zR);let r=Kq(t.username);if(!Ce.isEmpty(t.password)&&!Ce.isEmptyOrZeroLength(t.password.trim())&&(r&&(t.hash=Pl.encrypt(t.password)),t.password=yl.hash(t.password)),t.role==="")throw new Error(XR);if(t.role){let o={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["*"]},c;try{c=await Yo(o)}catch(_){throw H.error("Got an error searching for a role."),H.error(_),_}if(!c||c.length===0){let _=fn.ALTER_USER_ROLE_NOT_FOUND(t.role);throw H.error(_),rr(new Error,_,sr.NOT_FOUND,void 0,void 0,!0)}if(c.length>1){let _=fn.ALTER_USER_DUP_ROLES(t.role);throw H.error(_),rr(new Error,_,sr.CONFLICT,void 0,void 0,!0)}t.role=c[0].id}let s={operation:"update",schema:"system",table:"hdb_user",records:[t]},n;try{n=await jR.update(s)}catch(o){throw H.error("Error during update."),H.error(o),o}try{await Oi()}catch(o){throw H.error("Got an error setting users to global"),H.error(o),o}let i={user:null};return i.user=t,Ce.sendTransactionToSocketCluster(As.INTERNAL_SC_CHANNELS.ALTER_USER,i,Bl.get(As.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),Dl.signalUserChange(new vl(process.pid)),n}a(Yq,"alterUser");function Kq(e){let t=!1,r=global.hdb_users.get(e);return r&&r.role.permission.cluster_user===!0&&(t=!0),t}a(Kq,"isClusterUser");async function Qq(e){try{let t=eA.dropUserValidation(e);if(t)throw new Error(t);let r={table:"hdb_user",schema:"system",hash_values:[e.username]};if(Ce.isEmpty(global.hdb_users.get(e.username)))throw rr(new Error,fn.USER_NOT_EXIST(e.username),sr.NOT_FOUND,void 0,void 0,!0);let s;try{s=await xq(r)}catch(i){throw H.error("Got an error deleting a user."),H.error(i),i}H.debug(s);try{await Oi()}catch(i){throw H.error("Got an error setting users to global."),H.error(i),i}let n={user:null};return n.user=e,Ce.sendTransactionToSocketCluster(As.INTERNAL_SC_CHANNELS.DROP_USER,n,Bl.get(As.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),Dl.signalUserChange(new vl(process.pid)),`${e.username} successfully deleted`}catch(t){throw t}}a(Qq,"dropUser");async function Wq(e){let t={};try{if(!e||!e.hdb_user)return"There was no user info in the body";t=e.hdb_user;let r={schema:"system",table:"hdb_role",hash_values:[t.role.id],get_attributes:["*"]},s;try{s=await kq(r)}catch(n){throw H.error("Got an error searching for a role."),H.error(n),n}t.role=s[0],delete t.password,delete t.refresh_token,delete t.hash}catch(r){throw H.error(r),r}return t}a(Wq,"userInfo");async function Jq(){let e;try{e=await Ko()}catch(t){throw H.error("Got an error listing users."),H.error(t),t}try{e.forEach(t=>{delete t.password,delete t.hash,delete t.refresh_token})}catch{throw new Error("there was an error massaging the user data")}return[...e.values()]}a(Jq,"listUsersExternal");async function Ko(){try{let e={schema:"system",table:"hdb_role",search_value:"*",search_attribute:"role",get_attributes:["*"]},t;try{t=KR.cloneDeep(await Yo(e))}catch(r){throw H.error("Got an error searching for roles."),H.error(r),r}if(!Ce.isEmptyOrZeroLength(t)){let r={};for(let o in t)r[t[o].id]=t[o];let s={schema:"system",table:"hdb_user",search_value:"*",search_attribute:"username",get_attributes:["*"]},n;try{n=KR.cloneDeep(await Yo(s))}catch(o){throw H.error("Got an error searching for users."),H.error(o),o}let i=new Map;for(let o in n){let c=n[o];c.role=r[n[o].role],Zq(c.role),i.set(c.username,c)}return(await qq.getLicense()).enterprise?i:Xq(i)}}catch(e){throw H.error("got an error listing users"),H.error(e),Ce.errorizeMessage(e)}return null}a(Ko,"listUsers");function Zq(e){try{if(!e){H.error("invalid user role found.");return}e.permission.system||(e.permission.system={}),e.permission.system.tables||(e.permission.system.tables={});for(let t of Object.keys(Fq)){let r={read:!!e.permission.super_user,insert:!1,update:!1,delete:!1,attribute_permissions:[]};e.permission.system.tables[t]=r}}catch(t){H.error("Got an error trying to set system permissions."),H.error(t)}}a(Zq,"appendSystemTablesToRole");function Xq(e){try{if(H.info("No enterprise license found.  System is limited to 1 clustering role and 1 user role"),!e)return new Map;let t=Object.create(null),r=new Map;e.forEach((n,i)=>{n.role.permission.cluster_user===void 0||n.role.permission.cluster_user===!1?n.role.permission.super_user===!0&&(t[n.role.id]||(t[n.role.id]=new Map),t[n.role.id].set(i,n)):r.set(i,n)});let s={role:void 0,count:0};return Object.keys(t).forEach(n=>{let i=t[n];i.size>=s.count&&(s.role=n,s.count=i.size)}),s.role===void 0?(H.error("No roles found with active users.  This is bad."),new Map):(r=new Map([...r,...t[s.role]]),r)}catch(t){return H.error("error filtering users."),H.error(t),new Map}}a(Xq,"nonEnterpriseFilter");async function Oi(){try{let e=await Ko();global.hdb_users=e}catch(e){throw H.error(e),e}}a(Oi,"setUsersToGlobal");async function zq(e,t,r=!0){global.hdb_users||await Oi();let s=global.hdb_users.get(e);if(!s)throw rr(new Error,Ul.GENERIC_AUTH_FAIL,sr.UNAUTHORIZED,void 0,void 0,!0);if(s&&!s.active)throw rr(new Error,Ul.USER_INACTIVE,sr.UNAUTHORIZED,void 0,void 0,!0);let n={active:s.active,username:s.username};if(s.refresh_token&&(n.refresh_token=s.refresh_token),s.role&&(n.role=s.role),r===!0){if(QR.get(t)===s.password)return n;if(yl.validate(s.password,t))QR.set(t,s.password);else throw rr(new Error,Ul.GENERIC_AUTH_FAIL,sr.UNAUTHORIZED,void 0,void 0,!0)}return n}a(zq,"findAndValidateUser");async function jq(){let e=await Ko(),t=Gq.getConfigFromFile(As.CONFIG_PARAMS.CLUSTERING_USER),r=e.get(t);if(!Ce.isEmpty(r))return r.decrypt_hash=Pl.decrypt(r.hash),r.uri_encoded_d_hash=encodeURIComponent(r.decrypt_hash),r.uri_encoded_name=encodeURIComponent(r.username),r.sys_name=r.username+YR.SERVER_SUFFIX.ADMIN,r.sys_name_encoded=r.uri_encoded_name+YR.SERVER_SUFFIX.ADMIN,r}a(jq,"getClusterUser")});var _A=S((uX,cA)=>{"use strict";var Os=I(),Qo=T(),eF=ER(),iA=xr(),tF=fs(),rF=Wr(),{validateEvent:oA}=Gr(),sF={[Qo.IPC_EVENT_TYPES.SCHEMA]:nF,[Qo.IPC_EVENT_TYPES.USER]:aF};async function nF(e){let t=oA(e);if(t){Os.error(t);return}Os.trace(`IPC schemaHandler ${Qo.HDB_IPC_CLIENT_PREFIX}${process.pid} received schema event:`,e),await eF(e.message),await iF(e.message)}a(nF,"schemaHandler");async function iF(e){try{if(global.hdb_schema!==void 0&&typeof global.hdb_schema=="object"&&e.operation!==void 0)switch(e.operation){case"drop_schema":delete global.hdb_schema[e.schema];break;case"drop_table":global.hdb_schema[e.schema]!==void 0&&delete global.hdb_schema[e.schema][e.table];break;case"create_schema":global.hdb_schema[e.schema]===void 0&&(global.hdb_schema[e.schema]={});break;case"create_table":case"create_attribute":global.hdb_schema[e.schema]===void 0&&(global.hdb_schema[e.schema]={}),global.hdb_schema[e.schema][e.table]=await tF.describeTable({schema:e.schema,table:e.table});break;default:iA.setSchemaDataToGlobal(aA);break}else iA.setSchemaDataToGlobal(aA)}catch(t){Os.error(t)}}a(iF,"syncSchemaMetadata");function aA(e){e&&Os.error(e)}a(aA,"handleErrorCallback");async function aF(e){try{let t=oA(e);if(t){Os.error(t);return}Os.trace(`IPC userHandler ${Qo.HDB_IPC_CLIENT_PREFIX}${process.pid} received user event:`,e),await rF.setUsersToGlobal()}catch(t){Os.error(t)}}a(aF,"userHandler");cA.exports=sF});var Wo=S((lX,uA)=>{"use strict";var oF=Or();uA.exports={writeTransaction:cF};function cF(e,t,r){return oF.writeTransaction(e,t,r)}a(cF,"writeTransaction")});var Hl=S((EX,_F)=>{_F.exports={name:"harperdb",version:"4.0.0",description:"HarperDB is a distributed SQL & NoSQL data platform focused on speed, flexibility, and ease of use.",keywords:["database","sql","nosql","api","distributed","cloud","enterprise","Fastify","NATS"],main:"harperdb.js",bin:{harperdb:"./bin/harperdb.js"},engines:{node:">=14.0.0","preferred-node":"18.13.0","go-lang":"1.19.3","nats-server":"2.9.8"},homepage:"https://www.harperdb.io/",bugs:"support@harperdb.io",author:{name:"HarperDB",email:"support@harperdb.io"},license:"See License in ./license/Community+Edition+and+Evaluation+End+User+License+Agreement.pdf",scripts:{submodules:"git submodule update --init --recursive",build:"eslint -c ./.eslintbuild bin/ data_layer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",pretty:"eslint --fix bin/ data_layer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",test:"rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license --storage_type=lmdb && npm run cover:upgrade && npm run cover:nats && npm run cover:cfserver && npm run cover:lmdbbridge && npm run cover:lmdbutility && npm run cover:hdbserver &&  npm run cover:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license --storage_type=lmdb","cover:main":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --config '../unitTests/.mocharc-main.json'","cover:lmdbbridge":"cd bin/ && nyc --no-clean --reporter=lcovonly --retries 3 ../node_modules/mocha/bin/_mocha '../unitTests/data_layer/harperBridge/lmdbBridge/**/*.js' --parallel --config '../unitTests/.mocharc.json'","cover:lmdbutility":"cd bin/ && nyc --no-clean --reporter=lcovonly --retries 3 ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --config '../unitTests/.mocharc.json'","cover:hdbserver":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --config '../unitTests/.mocharc.json'","cover:cfserver":"npm run submodules && cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --config '../unitTests/.mocharc.json'","cover:nats":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json'","cover:upgrade":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --config '../unitTests/.mocharc.json'","test:ci":" cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --retries 3 --config '../unitTests/.mocharc-main.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/data_layer/harperBridge/lmdbBridge/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter","hdb-check":"./utility/devops/hdb-check.sh","download-prebuilds":"node ./utility/devops/build/download-prebuilds.js",prebuild:"date",postinstall:"node ./launchServiceScripts/launchInstallNATSServer.js",build_nats_dependency:"node ./utility/devops/nats/builder.js",coverage:"nyc --reporter=lcov npm test"},dependencies:{"@fastify/accepts-serializer":"5.1.0","@fastify/autoload":"5.4.0","@fastify/compress":"6.1.1","@fastify/cors":"8.1.0","@fastify/static":"6.5.0","@turf/area":"6.5.0","@turf/boolean-contains":"6.5.0","@turf/boolean-disjoint":"6.5.0","@turf/boolean-equal":"6.5.0","@turf/circle":"6.5.0","@turf/difference":"6.5.0","@turf/distance":"6.5.0","@turf/helpers":"6.5.0","@turf/length":"6.5.0",alasql:"1.7.4",async:"3.2.3","aws-sdk":"2.1096.0",chalk:"4.1.2","cli-progress":"3.10.0",clone:"2.1.2",esbuild:"^0.14.49","fast-glob":"3.2.11",fastify:"4.8.1","fastify-plugin":"4.2.1","fill-range":"7.0.1","fs-extra":"10.0.1","human-readable-ids":"1.0.4",inquirer:"8.2.2","is-number":"7.0.0",joi:"17.6.0",json2csv:"5.0.7",jsonata:"1.8.6",jsonwebtoken:"8.5.1",lmdb:"2.7.3",lodash:"4.17.21",mathjs:"10.4.0",microtime:"3.1.1",minimist:"1.2.6",mkcert:"1.5.0",moment:"2.29.4",msgpackr:"1.7.0",nats:"2.9.2",needle:"3.1.0","node-ipc":"9.1.4","node-stream-zip":"1.15.0","normalize-path":"^3.0.0",ora:"5.4.1","ordered-binary":"1.3.0",papaparse:"5.3.2",passport:"0.6.0","passport-http":"0.3.0","passport-local":"1.0.0",pino:"8.3.1",pm2:"5.2.0",prompt:"1.2.2","properties-reader":"2.2.0","recursive-iterator":"3.3.0",semver:"7.3.5","stream-chain":"2.2.5","stream-json":"1.7.4",systeminformation:"5.12.4","tar-fs":"2.1.1","truncate-utf8-bytes":"1.0.2",ulidx:"0.3.0",uuid:"9.0.0","validate.js":"0.11.1",yaml:"1.10.2"},devDependencies:{axios:"0.27.2",chai:"4.3.4","chai-integer":"0.1.0",eslint:"8.22.0","eslint-config-prettier":"8.3.0","eslint-plugin-prettier":"3.4.1","eslint-plugin-radar":"0.2.1","hook-std":"2.0.0","intercept-stdout":"0.1.2",mocha:"8.3.2","mocha-teamcity-reporter":"3.0.0","mock-require":"3.0.3","mock-stdin":"1.0.0",newman:"5.2.3","newman-reporter-html":"1.0.5","newman-reporter-htmlextra":"1.21.0","newman-reporter-teamcity":"0.1.11","node-fetch":"2.6.7",nyc:"15.1.0",prettier:"2.3.2",rewire:"5.0.0",rimraf:"3.0.2",sinon:"10.0.0","sinon-chai":"3.7.0"},overrides:{"eslint-plugin-radar":{eslint:"8.22.0"},"newman-reporter-html":{newman:"5.2.3"}}}});var ct=S((NX,UA)=>{"use strict";var nr=Y();nr.initSync();var uF=require("fs-extra"),lF=require("semver"),bi=require("path"),{monotonicFactory:EF}=require("ulidx"),dF=EF(),EA=require("util"),dA=require("child_process"),hF=EA.promisify(dA.exec),SF=dA.spawn,ee=_e(),se=T(),xl=b(),pr=I(),Jo=Vr(),fF=Wo(),pi=Sr(),{encode:Fl,decode:hA}=require("msgpackr"),{isEmpty:ps}=xl,SA=Wr(),dX=ds(),TF=mt(),hX=EA.promisify(TF.searchByHash),{connect:mF,StorageType:fA,RetentionPolicy:TA,AckPolicy:mA,DeliverPolicy:Vl,NatsConnection:SX,JetStreamManager:fX,JetStreamClient:TX,StringCodec:mX,JSONCodec:RF,createInbox:$l,StreamSource:RX,headers:AF,toJsMsg:OF,nuid:AX,JetStreamOptions:OX,ErrorCode:lA,nanos:pX}=require("nats"),{PACKAGE_ROOT:pF}=T(),NF=Hl(),RA=RF(),gF="clustering",IF=NF.engines[ee.NATS_SERVER_NAME],bF=bi.join(pF,"dependencies"),kl=bi.join(bF,`${process.platform}-${process.arch}`,ee.NATS_BINARY_NAME),Gl,ql,Ni,gi,Ii,Qt;UA.exports={runCommand:AA,checkNATSServerInstalled:CF,createConnection:Yl,getConnection:Zo,getJetStreamManager:Tn,getJetStream:OA,getNATSReferences:yt,getServerList:LF,createLocalStream:Kl,listStreams:pA,deleteLocalStream:UF,getServerConfig:Ci,listRemoteStreams:yF,viewStream:DF,publishToStream:MF,createWorkQueueStream:PF,addSourceToWorkStream:NA,request:BF,removeSourceFromWorkStream:IA,reloadNATS:Ql,reloadNATSHub:vF,reloadNATSLeaf:HF,extractServerName:gA,requestErrorHandler:GF,updateWorkStream:qF,createLocalTableStream:CA,createTableStreams:FF,purgeTableStream:wA,purgeSchemaTableStreams:VF,getStreamInfo:kF,updateNodeNameLocalStreams:xF,closeConnection:wF};async function AA(e,t=void 0){let{stdout:r,stderr:s}=await hF(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(AA,"runCommand");async function CF(){try{await uF.access(kl)}catch{return!1}let e=await AA(`${kl} --version`,void 0),t=e.substring(e.lastIndexOf("v")+1,e.length);return lF.eq(t,IF)}a(CF,"checkNATSServerInstalled");async function Yl(e,t,r,s=!0,n="127.0.0.1"){return mF({name:n,port:e,user:t,pass:r,maxReconnectAttempts:-1,waitOnFirstConnect:s,tls:{keyFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_PRIVATEKEY),certFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_CERTIFICATE),caFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_CERT_AUTH),insecure:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_INSECURE)}})}a(Yl,"createConnection");async function wF(){Qt&&(await Qt.close(),Qt=void 0)}a(wF,"closeConnection");async function Zo(){if(!Qt){let e=await SA.getClusterUser();if(ps(e))throw new Error("Unable to get nats connection. Cluster user is undefined.");let t=nr.get(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT);Qt=await Yl(t,e.username,e.decrypt_hash)}return Qt}a(Zo,"getConnection");async function Tn(){if(gi)return gi;ps(Qt)&&await Zo();let{domain:e}=Ci(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(ps(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return gi=await Qt.jetstreamManager({domain:e}),gi}a(Tn,"getJetStreamManager");async function OA(){if(Ii)return Ii;ps(Qt)&&await Zo();let{domain:e}=Ci(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(ps(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Ii=Qt.jetstream({domain:e}),Ii}a(OA,"getJetStream");async function yt(){let e=Qt||await Zo(),t=gi||await Tn(),r=Ii||await OA();return{connection:e,jsm:t,js:r}}a(yt,"getNATSReferences");async function LF(){let e=nr.get(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),{sys_name:t,decrypt_hash:r}=await SA.getClusterUser(),s=await Yl(e,t,r),n=$l(),i=s.subscribe(n),o=[],c=(async()=>{for await(let _ of i)o.push(RA.decode(_.data))})();return await s.publish("$SYS.REQ.SERVER.PING.VARZ",void 0,{reply:n}),await s.flush(),await xl.async_set_timeout(50),await i.drain(),await s.close(),await c,o}a(LF,"getServerList");async function Kl(e,t){let{jsm:r}=await yt();await r.streams.add({name:e,storage:fA.File,retention:TA.Limits,subjects:t})}a(Kl,"createLocalStream");async function pA(){let{jsm:e}=await yt(),t=await e.streams.list().next(),r=[];return t.forEach(s=>{r.push(s)}),r}a(pA,"listStreams");async function UF(e){let{jsm:t}=await yt();await t.streams.delete(e)}a(UF,"deleteLocalStream");async function yF(e){let{connection:t}=await yt(),r=[],s=$l(),n=t.subscribe(s),i=(async()=>{for await(let o of n)r.push(RA.decode(o.data))})();return await t.publish(`$JS.${e}.API.STREAM.LIST`,void 0,{reply:s}),await t.flush(),await n.drain(),await i,r}a(yF,"listRemoteStreams");async function DF(e,t=void 0,r=void 0){let{jsm:s,connection:n}=await yt(),i=dF(),o=[],c={ack_policy:mA.None,durable_name:i,deliver_subject:i,deliver_policy:Vl.All};t&&(c.deliver_policy=Vl.StartTime,c.opt_start_time=new Date(t).toISOString());try{await s.consumers.add(e,c);let _={timeout:2e3};r&&(_.max=r);let u=await n.subscribe(i,_);for await(let l of u){let E=OF(l),d=hA(E.data),h={nats_timestamp:E.info.timestampNanos,nats_sequence:E.info.streamSequence,entry:d,originators:[]},m=[];if(E.headers){let R=E.headers.get("originators");R&&(m=R.split(","),h.originators=m)}o.push(h),u.getPending()===1&&E.info.pending===0&&u.stop()}return await s.consumers.delete(e,i),o}catch(_){if(await s.consumers.delete(e,i),_.code==="TIMEOUT")return o;throw _}}a(DF,"viewStream");async function MF(e,t,r=[],s=[]){pr.trace(`publishToStream called with subject: ${e}, stream: ${t}, entries:`,r,"originators:",s);let{connection:n,js:i}=await yt(),o=await Xo(),c=`${e}.${o}`,_=AF();s.push(o),_.append("originators",s.join());for(let u=0,l=r.length;u<l;u++)try{pr.trace(`publishToStream publishing to subject: ${c}, data:`,r[u]),await i.publish(c,Fl(r[u]),{headers:_})}catch(E){if(E.code&&E.code.toString()==="503")pr.trace(`publishToStream creating stream: ${t}`),await Kl(t,[c]),await i.publish(c,Fl(r[u]),{headers:_});else throw E}}a(MF,"publishToStream");function Ci(e){e=e.toLowerCase();let t=bi.join(nr.get(se.CONFIG_PARAMS.ROOTPATH),gF);if(e===se.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())return ps(ql)&&(ql={port:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),server_name:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.HUB,config_file:ee.NATS_CONFIG_FILES.HUB_SERVER,pid_file_path:bi.join(t,ee.PID_FILES.HUB),hdb_nats_path:t}),ql;if(e===se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())return ps(Gl)&&(Gl={port:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),server_name:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.LEAF,config_file:ee.NATS_CONFIG_FILES.LEAF_SERVER,domain:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.LEAF,pid_file_path:bi.join(t,ee.PID_FILES.LEAF),hdb_nats_path:t}),Gl;pr.error(`Unable to get Nats server config. Unrecognized process: ${e}`)}a(Ci,"getServerConfig");async function PF(e){let{jsm:t}=await yt(),r=await Xo();try{await t.streams.add({name:e.stream_name,storage:fA.File,retention:TA.Workqueue,subjects:[`${ee.SUBJECT_PREFIXES.MSGID}.${r}`,`${ee.SUBJECT_PREFIXES.TXN}.${e.stream_name}.${r}`]})}catch(s){if(s.code!=="400")throw s}try{await t.consumers.info(e.stream_name,e.durable_name)}catch(s){if(s.code.toString()==="404")await t.consumers.add(e.stream_name,{ack_policy:mA.Explicit,deliver_subject:`${e.deliver_subject}.${r}`,durable_name:e.durable_name,deliver_policy:Vl.All,max_ack_pending:1e4,deliver_group:e.deliver_group,filter_subject:`${ee.SUBJECT_PREFIXES.TXN}.>`});else throw s}}a(PF,"createWorkQueueStream");async function NA(e,t,r){let{jsm:s}=await yt(),n=await s.streams.info(t),i=gA(s.prefix),o=r.start_time?r.start_time:new Date(Date.now()).toISOString(),{schema:c,table:_}=r,u=Jo.createNatsTableStreamName(c,_),l=i===e,E,d,h=!1;if(!Array.isArray(n.config.sources)||n.config.sources.length===0)n.config.sources=[];else for(let R=0,w=n.config.sources.length;R<w;R++)if(E=n.config.sources[R],d=R,l&&E.name===u||!l&&E.name===u&&E.external&&E.external.api===`$JS.${e}.API`){h=!0;break}if(h===!0){if(E.opt_start_time===o)return;await bA(c,_,E,t),n.config.sources.splice(d,1),await s.streams.update(t,n.config)}let m={name:u,opt_start_time:o,filter_subject:`${ee.SUBJECT_PREFIXES.TXN}.>`};l||(m.external={api:`$JS.${e}.API`,deliver:""}),n.config.sources.push(m),await s.streams.update(t,n.config)}a(NA,"addSourceToWorkStream");function gA(e){return e.split(".")[1]}a(gA,"extractServerName");async function IA(e,t,r){let{schema:s,table:n}=r,i=Jo.createNatsTableStreamName(s,n),{jsm:o}=await yt(),c=await o.streams.info(t);if(!Array.isArray(c.config.sources)||c.config.sources.length===0)return;let _=c.config.sources.length,u;for(;_--;)if(u=c.config.sources[_],u.name===i&&u.external.api===`$JS.${e}.API`){c.config.sources.splice(_,1);break}await o.streams.update(t,c.config),await bA(s,n,u,t)}a(IA,"removeSourceFromWorkStream");async function bA(e,t,r,s){let n=await Tn(),i;try{i=LA(e,t,r.external.api.split(".")[1]),await n.streams.purge(s,{filter:i})}catch{pr.error("Error purging source subject",i,"from work stream",s)}}a(bA,"purgeSourceFromWorkStream");async function BF(e,t,r=2e3,s=$l()){if(!xl.isObject(t))throw new Error("data param must be an object");let n=Fl(t),{connection:i}=await yt(),o={timeout:r};s&&(o.reply=s,o.noMux=!0);let c=await i.request(e,n,o);return hA(c.data)}a(BF,"request");function Ql(e){return new Promise(async(t,r)=>{let s=SF(kl,["--signal",`reload=${e}`],{cwd:__dirname}),n,i;s.on("error",o=>{r(o)}),s.stdout.on("data",o=>{i+=o.toString()}),s.stderr.on("data",o=>{n+=o.toString()}),s.stderr.on("close",o=>{n&&r(n),t(i)})})}a(Ql,"reloadNATS");async function vF(){let{pid_file_path:e}=Ci(se.PROCESS_DESCRIPTORS.CLUSTERING_HUB);await Ql(e)}a(vF,"reloadNATSHub");async function HF(){let{pid_file_path:e}=Ci(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);await Ql(e)}a(HF,"reloadNATSLeaf");function GF(e,t,r){let s;switch(e.code){case lA.NoResponders:s=`Unable to ${t}, node '${r}' is not listening.`;break;case lA.Timeout:s=`Unable to ${t}, node '${r}' is listening but did not respond.`;break;default:s=e.message;break}return s}a(GF,"requestErrorHandler");async function qF(e,t){let r=t+ee.SERVER_SUFFIX.LEAF;await fF.writeTransaction(se.SYSTEM_SCHEMA_NAME,se.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,async()=>{e.subscribe===!0?await NA(r,ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,e):await IA(r,ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,e)})}a(qF,"updateWorkStream");async function CA(e,t){let r=Jo.createNatsTableStreamName(e,t),s=await Xo(),n=LA(e,t,s);await Kl(r,[n])}a(CA,"createLocalTableStream");async function FF(e){for(let t=0,r=e.length;t<r;t++){let s=e[t].schema,n=e[t].table;await CA(s,n)}}a(FF,"createTableStreams");async function wA(e,t){if(nr.get(se.CONFIG_PARAMS.CLUSTERING_ENABLED))try{let r=Jo.createNatsTableStreamName(e,t),{jsm:s}=await yt();await s.streams.purge(r)}catch(r){if(r.message==="stream not found")pr.warn(r);else throw r}}a(wA,"purgeTableStream");async function VF(e,t){if(nr.get(se.CONFIG_PARAMS.CLUSTERING_ENABLED))for(let r=0,s=t.length;r<s;r++)await wA(e,t[r])}a(VF,"purgeSchemaTableStreams");async function kF(e){return(await Tn()).streams.info(e)}a(kF,"getStreamInfo");function LA(e,t,r){return`${ee.SUBJECT_PREFIXES.TXN}.${e}.${t}.${r}`}a(LA,"createSubjectName");async function Xo(){if(Ni)return Ni;if(Ni=(await Tn())?.nc?.info?.server_name,Ni===void 0)throw new Error("Unable to get jetstream manager server name");return Ni}a(Xo,"getJsmServerName");async function xF(){let e=await Tn(),t=await Xo(),r=await pA();for(let s of r){let n=s.config,i=n.subjects[0];if(!i)continue;let o=i.split(".");if(o[o.length-1]!==t){if(n.name===ee.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name){let _=`${ee.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`;pr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else if(n.name===ee.WORK_QUEUE_CONSUMER_NAMES.stream_name){let _=`${ee.WORK_QUEUE_CONSUMER_NAMES.stream_name}.${t}`;pr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_,await e.consumers.update(ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,ee.WORK_QUEUE_CONSUMER_NAMES.durable_name,{deliver_subject:`${ee.WORK_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`})}else{let _=i.split(".");_[_.length-1]=t;let u=_.join(".");pr.trace(`Updating stream subject name from: ${i} to: ${u}`),n.subjects[0]=u}await e.streams.update(n.name,n)}}}a(xF,"updateNodeNameLocalStreams")});var Wl=S((gX,yA)=>{"use strict";var zo=class{constructor(t,r,s){this.timestamp=t,this.user=r,this.node_name=s}};a(zo,"ClusteringOriginObject");yA.exports=zo});var Ns=S((IX,PA)=>{"use strict";var DA=b(),Li=Y(),ue=T(),Jl=_e(),mn=ct(),fe=I(),MA=Wl(),$F=Vr();Li.initSync();var Rn=Jl.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name,wi=Jl.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject;PA.exports={sendAttributeTransaction:ec,postOperationHandler:KF};async function ec(e,t,r=[]){if(!!Li.get(ue.CONFIG_PARAMS.CLUSTERING_ENABLED)&&!DA.isEmptyOrZeroLength(e.new_attributes)&&t.schema!==ue.SYSTEM_SCHEMA_NAME){let s=t.hdb_user?.username,n=Li.get(ue.CONFIG_PARAMS.CLUSTERING_NODENAME);for(let i of e.new_attributes){let o={operation:ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE,schema:t.schema,table:t.table,attribute:i,__origin:new MA(e.txn_time,s,n)};fe.trace(`sendAttributeTransaction publishing ${Rn}`,o),await mn.publishToStream(wi,Rn,[o],r)}}}a(ec,"sendAttributeTransaction");async function jo(e,t,r,s=[]){if(e.schema===ue.SYSTEM_SCHEMA_NAME)return;let n=YF(e,t,r);n&&(fe.trace(`sendOperationTransaction publishing to schema ${e.schema} table ${e.table} following transaction:`,n),await mn.publishToStream(`${Jl.SUBJECT_PREFIXES.TXN}.${e.schema}.${e.table}`,$F.createNatsTableStreamName(e.schema,e.table),[n],s))}a(jo,"sendOperationTransaction");function YF(e,t,r){if(DA.isEmptyOrZeroLength(t))return null;let s={operation:e.operation,schema:e.schema,table:e.table,__origin:r};return e.operation===ue.OPERATIONS_ENUM.DELETE?s.hash_values=t:s.records=e.records,s}a(YF,"convertCRUDOperationToTransaction");async function KF(e,t,r=[]){if(!Li.get(ue.CONFIG_PARAMS.CLUSTERING_ENABLED))return;fe.trace(`postOperationHandler called for operation ${e.operation} on schema.table: ${e.schema}.${e.table}`);let s=e.hdb_user?.username,n=Li.get(ue.CONFIG_PARAMS.CLUSTERING_NODENAME),i=new MA(t.txn_time,s,n);switch(e.operation){case ue.OPERATIONS_ENUM.INSERT:try{await jo(e,t.inserted_hashes,i,r),await ec(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for insert."),fe.error(o)}break;case ue.OPERATIONS_ENUM.DELETE:try{await jo(e,t.deleted_hashes,i,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for delete."),fe.error(o)}break;case ue.OPERATIONS_ENUM.UPDATE:try{await jo(e,t.update_hashes,i,r),await ec(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for update."),fe.error(o)}break;case ue.OPERATIONS_ENUM.UPSERT:try{await jo(e,t.upserted_hashes,i,r),await ec(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for upsert."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_SCHEMA:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_SCHEMA,schema:e.schema,__origin:i};await mn.publishToStream(wi,Rn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_schema."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_TABLE:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_TABLE,schema:e.schema,table:e.table,hash_attribute:e.hash_attribute,__origin:i};await mn.publishToStream(wi,Rn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_table."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE,schema:e.schema,table:e.table,attribute:e.attribute,__origin:i};await mn.publishToStream(wi,Rn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_attribute."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CSV_DATA_LOAD:try{let o={operation:ue.OPERATIONS_ENUM.CSV_DATA_LOAD,schema:e.schema,table:e.table,attribute:e.attribute};await mn.publishToStream(wi,Rn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for csv_data_load."),fe.error(o)}break;default:break}return t}a(KF,"postOperationHandler")});var qA=S((bX,GA)=>{"use strict";var QF=mt(),WF=xr(),BA=I(),vA=Ut(),JF=Wo(),ZF=require("clone"),Xl=require("alasql"),XF=Lo(),HA=require("util"),zF=HA.promisify(WF.getTableSchema),jF=HA.promisify(QF.search),e0=T(),Zl=b(),t0=Ns();XF(Xl);GA.exports={update:s0};var r0="There was a problem performing this update. Please check the logs and try again.";async function s0({statement:e,hdb_user:t}){let r=await zF(e.table.databaseid,e.table.tableid),s=n0(e.columns);Zl.backtickASTSchemaItems(e);let{table:n,where:i}=e,o=ZF(n),c=Zl.isEmpty(i)?"":` WHERE ${i.toString()}`,_=`SELECT ${r.hash_attribute} FROM ${n.toString()} ${c}`,u=Xl.parse(_).statements[0],l=await JF.writeTransaction(r.schema,r.name,async()=>{let E=await jF(u),d=i0(s,E);return a0(o,d,t)});return await vA.flush({schema:r.schema,table:r.name}),l}a(s0,"update");function n0(e){try{let t={};return e.forEach(r=>{"value"in r.expression?t[r.column.columnid]=r.expression.value:t[r.column.columnid]=Xl.compile(`SELECT ${r.expression.toString()} AS [${e0.FUNC_VAL}] FROM ?`)}),t}catch(t){throw BA.error(t),new Error(r0)}}a(n0,"createUpdateRecord");function i0(e,t){return Zl.isEmptyOrZeroLength(t)?[]:t.map(r=>Object.assign(r,e))}a(i0,"buildUpdateRecords");async function a0(e,t,r){let s={operation:"update",schema:e.databaseid_orig,table:e.tableid_orig,records:t,hdb_user:r};try{let n=await vA.update(s);await t0.postOperationHandler(s,n);try{delete n.new_attributes,delete n.txn_time}catch(i){BA.error(`Error delete new_attributes from update response: ${i}`)}return n}catch(n){throw n}}a(a0,"updateRecords")});var VA=S((CX,FA)=>{var o0=require("alasql"),c0=mt(),_0=I(),u0=Or(),jl=require("util"),zl=b(),l0=T(),E0=xr(),d0=Wo(),h0=Ns(),S0=Ut(),f0="record",T0="successfully deleted",m0=jl.callbackify(p0),R0=jl.promisify(c0.search),A0=jl.promisify(E0.getTableSchema);FA.exports={convertDelete:m0};function O0(e){return`${e.deleted_hashes.length} ${f0}${e.deleted_hashes.length===1?"":"s"} ${T0}`}a(O0,"generateReturnMessage");async function p0({statement:e,hdb_user:t}){let r=await A0(e.table.databaseid,e.table.tableid);zl.backtickASTSchemaItems(e);let{table:s,where:n}=e,i=zl.isEmpty(n)?"":` WHERE  ${n.toString()}`,o=`SELECT ${r.hash_attribute} FROM ${s.toString()} ${i}`,c=o0.parse(o).statements[0],_={operation:l0.OPERATIONS_ENUM.DELETE,schema:s.databaseid_orig,table:s.tableid_orig,hdb_user:t};try{let u=await d0.writeTransaction(r.schema,r.name,async()=>(_.records=await R0(c),u0.deleteRecords(_)));return await S0.flush({schema:r.schema,table:r.name}),u.deleted_hashes.length>0&&await h0.postOperationHandler(_,u),zl.isEmptyOrZeroLength(u.message)&&(u.message=O0(u)),delete u.txn_time,u}catch(u){throw _0.error(u),u.hdb_code?u.message:u}}a(p0,"convertDelete")});var $A=S((wX,xA)=>{"use strict";var tE=fs(),{hdb_errors:eE}=D();xA.exports={checkSchemaExists:kA,checkSchemaTableExists:N0,schema_describe:tE};async function kA(e){if(!global.hdb_schema[e])try{let t=await tE.describeSchema({schema:e});global.hdb_schema[e]=t}catch{return eE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}}a(kA,"checkSchemaExists");async function N0(e,t){let r=await kA(e);if(r)return r;if(!global.hdb_schema[e][t])try{let s=await tE.describeTable({schema:e,table:t});if(!s||Object.keys(s).length===0)return eE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t);global.hdb_schema[e][t]=s}catch{return eE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}}a(N0,"checkSchemaTableExists")});var tc=S((UX,JA)=>{"use strict";var An=Ka(),gs=$A(),YA=I(),g0=require("uuid").v4,LX=require("clone"),pn=js(),Is=T(),I0=require("util"),bs=Or(),{handleHDBError:Pe,hdb_errors:b0}=D(),{HDB_ERROR_MSGS:On,HTTP_STATUS_CODES:Be}=b0,{SchemaEventMsg:Nn}=Gr(),KA=ct();JA.exports={createSchema:C0,createSchemaStructure:QA,createTable:w0,createTableStructure:WA,createAttribute:M0,dropSchema:L0,dropTable:U0,dropAttribute:y0};async function C0(e){try{let t=await QA(e);return pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema)),t}catch(t){throw t}}a(C0,"createSchema");async function QA(e){let t=An.schema_object(e);if(t)throw Pe(t,t.message,Be.BAD_REQUEST,void 0,void 0,!0);if(!await gs.checkSchemaExists(e.schema))throw Pe(new Error,On.SCHEMA_EXISTS_ERR(e.schema),Be.BAD_REQUEST,Is.LOG_LEVELS.ERROR,On.SCHEMA_EXISTS_ERR(e.schema),!0);try{return await bs.createSchema(e),`schema '${e.schema}' successfully created`}catch(r){throw r}}a(QA,"createSchemaStructure");async function w0(e){try{let t=await WA(e);return pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema,e.table)),t}catch(t){throw t}}a(w0,"createTable");async function WA(e){let t=An.create_table_object(e);if(t)throw Pe(t,t.message,Be.BAD_REQUEST,void 0,void 0,!0);An.validateTableResidence(e.residence);let r=await gs.checkSchemaExists(e.schema);if(r)throw Pe(new Error,r,Be.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);if(!await gs.checkSchemaTableExists(e.schema,e.table))throw Pe(new Error,On.TABLE_EXISTS_ERR(e.schema,e.table),Be.BAD_REQUEST,Is.LOG_LEVELS.ERROR,On.TABLE_EXISTS_ERR(e.schema,e.table),!0);let n={name:e.table,schema:e.schema,id:g0(),hash_attribute:e.hash_attribute};try{if(e.residence)if(global.clustering_on)n.residence=e.residence,await bs.createTable(n,e);else throw Pe(new Error,"Clustering does not appear to be enabled. Cannot insert table with property 'residence'.",Be.BAD_REQUEST);else await bs.createTable(n,e);return`table '${e.schema}.${e.table}' successfully created.`}catch(i){throw i}}a(WA,"createTableStructure");async function L0(e){let t=An.schema_object(e);if(t)throw Pe(t,t.message,Be.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaExists(e.schema);if(r)throw Pe(new Error,r,Be.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);let s=await gs.schema_describe.describeSchema({schema:e.schema});global.hdb_schema[e.schema]=s;let n=Object.keys(global.hdb_schema[e.schema]);return await bs.dropSchema(e),pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema)),delete global.hdb_schema[e.schema],await KA.purgeSchemaTableStreams(e.schema,n),`successfully deleted schema '${e.schema}'`}a(L0,"dropSchema");async function U0(e){let t=An.table_object(e);if(t)throw Pe(t,t.message,Be.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaTableExists(e.schema,e.table);if(r)throw Pe(new Error,r,Be.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);return await bs.dropTable(e),pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema,e.table)),await KA.purgeTableStream(e.schema,e.table),`successfully deleted table '${e.schema}.${e.table}'`}a(U0,"dropTable");async function y0(e){let t=An.attribute_object(e);if(t)throw Pe(t,t.message,Be.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaTableExists(e.schema,e.table);if(r)throw Pe(new Error,r,Be.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);if(e.attribute===global.hdb_schema[e.schema][e.table].hash_attribute)throw Pe(new Error,"You cannot drop a hash attribute",Be.BAD_REQUEST,void 0,void 0,!0);if(Is.TIME_STAMP_NAMES.indexOf(e.attribute)>=0)throw Pe(new Error,`cannot drop internal timestamp attribute: ${e.attribute}`,Be.BAD_REQUEST,void 0,void 0,!0);try{return await bs.dropAttribute(e),D0(e),pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema,e.table,e.attribute)),`successfully deleted attribute '${e.attribute}'`}catch(s){throw YA.error(`Got an error deleting attribute ${I0.inspect(e)}.`),s}}a(y0,"dropAttribute");function D0(e){let t=Object.values(global.hdb_schema[e.schema][e.table].attributes);for(let r=0;r<t.length;r++)t[r].attribute===e.attribute&&global.hdb_schema[e.schema][e.table].attributes.splice(r,1)}a(D0,"dropAttributeFromGlobal");async function M0(e){if(!global.hdb_schema[e.schema])throw Pe(new Error,On.SCHEMA_NOT_FOUND(e.schema),Be.NOT_FOUND,void 0,void 0,!0);if(!global.hdb_schema[e.schema][e.table])throw Pe(new Error,On.TABLE_NOT_FOUND(e.schema,e.table),Be.NOT_FOUND,void 0,void 0,!0);try{return await bs.createAttribute(e),pn.signalSchemaChange(new Nn(process.pid,e.operation,e.schema,e.table,e.attribute)),`attribute '${e.schema}.${e.table}.${e.attribute}' successfully created.`}catch(t){throw YA.error(t),t}}a(M0,"createAttribute")});var XA=S((yX,ZA)=>{"use strict";var{OPERATIONS_ENUM:P0}=T(),rc=class{constructor(t,r,s=void 0,n=void 0){this.operation=P0.READ_AUDIT_LOG,this.schema=t,this.table=r,this.search_type=s,this.search_values=n}};a(rc,"ReadAuditLogObject");ZA.exports=rc});var rE=S((MX,rO)=>{"use strict";var B0=Or(),DX=XA(),sc=b(),nc=T(),v0=Y(),{handleHDBError:zA,hdb_errors:H0}=D(),{HDB_ERROR_MSGS:jA,HTTP_STATUS_CODES:eO}=H0,G0=Object.values(nc.READ_AUDIT_LOG_SEARCH_TYPES_ENUM),tO="To use this operation audit log must be enabled in harperdb-config.yaml";rO.exports=q0;async function q0(e){if(sc.isEmpty(e.schema))throw new Error(jA.SCHEMA_REQUIRED_ERR);if(sc.isEmpty(e.table))throw new Error(jA.TABLE_REQUIRED_ERR);if(!v0.get(nc.CONFIG_PARAMS.LOGGING_AUDITLOG))throw zA(new Error,tO,eO.BAD_REQUEST,nc.LOG_LEVELS.ERROR,tO,!0);let t=sc.checkSchemaTableExist(e.schema,e.table);if(t)throw zA(new Error,t,eO.NOT_FOUND,nc.LOG_LEVELS.ERROR,t,!0);if(!sc.isEmpty(e.search_type)&&G0.indexOf(e.search_type)<0)throw new Error(`Invalid search_type '${e.search_type}'`);return await B0.readAuditLog(e)}a(q0,"readAuditLog")});var cO=S((PX,oO)=>{var Jr=require("validate.js"),nO=he(),gn=T(),{handleHDBError:F0,hdb_errors:V0}=D(),{HDB_ERROR_MSGS:le,HTTP_STATUS_CODES:k0}=V0,sE=a(()=>({role:{presence:!0,format:"[\\w\\-\\_]+"},id:{presence:!0,format:"[\\w\\-\\_]+"},permission:{presence:!0}}),"constraintsTemplate"),x0={STRUCTURE_USER:"structure_user"},sO=Object.values(gn.ROLE_TYPES_ENUM),$0="attribute_permissions",Y0="attribute_name",{PERMS_CRUD_ENUM:In}=gn,K0=[$0,...Object.values(In)],iO=[In.READ,In.INSERT,In.UPDATE],Q0=[Y0,...iO];function W0(e){let t=sE();return t.role.presence=!0,t.id.presence=!1,t.permission.presence=!0,aO(e,t)}a(W0,"addRoleValidation");function J0(e){let t=sE();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!0,aO(e,t)}a(J0,"alterRoleValidation");function Z0(e){let t=sE();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!1,nO.validateObject(e,t)}a(Z0,"dropRoleValidation");var X0=["operation","role","id","permission","hdb_user","hdb_auth_header"];function aO(e,t){let r={main_permissions:[],schema_permissions:{}},s=Object.keys(e),n=[];for(let o=0,c=s.length;o<c;o++)X0.includes(s[o])||n.push(s[o]);n.length>0&&Te(le.INVALID_ROLE_JSON_KEYS(n),r);let i=nO.validateObject(e,t);if(i&&i.message.split(",").forEach(o=>{Te(o,r)}),e.permission){let o=z0(e);o&&Te(o,r),sO.forEach(c=>{e.permission[c]&&!Jr.isBoolean(e.permission[c])&&Te(le.SU_CU_ROLE_BOOLEAN_ERROR(c),r)})}for(let o in e.permission)if(sO.indexOf(o)<0){if(o===x0.STRUCTURE_USER){let _=e.permission[o];if(typeof _=="boolean")continue;if(Array.isArray(_)){for(let u=0,l=_.length;u<l;u++){let E=_[u];global.hdb_schema[E]||Te(le.SCHEMA_NOT_FOUND(E),r)}continue}Te(le.STRUCTURE_USER_ROLE_TYPE_ERROR(o),r);continue}let c=e.permission[o];if(!o||!global.hdb_schema[o]){Te(le.SCHEMA_NOT_FOUND(o),r);continue}if(c.tables)for(let _ in c.tables){let u=c.tables[_];if(!_||!global.hdb_schema[o][_]){Te(le.TABLE_NOT_FOUND(o,_),r);continue}if(Object.keys(u).forEach(l=>{K0.includes(l)||Te(le.INVALID_PERM_KEY(l),r,o,_)}),Object.values(In).forEach(l=>{Jr.isDefined(u[l])?Jr.isBoolean(u[l])||Te(le.TABLE_PERM_NOT_BOOLEAN(l),r,o,_):Te(le.TABLE_PERM_MISSING(l),r,o,_)}),Jr.isDefined(u.attribute_permissions)){if(!Jr.isArray(u.attribute_permissions)){Te(le.ATTR_PERMS_NOT_ARRAY,r,o,_);continue}}else{Te(le.ATTR_PERMS_ARRAY_MISSING,r,o,_);continue}if(u.attribute_permissions){let l=global.hdb_schema[o][_].attributes.map(({attribute:d})=>d),E={read:!1,insert:!1,update:!1};for(let d in u.attribute_permissions){let h=u.attribute_permissions[d];if(Object.keys(h).forEach(R=>{!Q0.includes(R)&&R!==In.DELETE&&Te(le.INVALID_ATTR_PERM_KEY(R),r,o,_)}),!Jr.isDefined(h.attribute_name)){Te(le.ATTR_PERM_MISSING_NAME,r,o,_);continue}let m=h.attribute_name;if(!l.includes(m)){Te(le.INVALID_ATTRIBUTE_IN_PERMS(m),r,o,_);continue}iO.forEach(R=>{Jr.isDefined(h[R])?Jr.isBoolean(h[R])||Te(le.ATTR_PERM_NOT_BOOLEAN(R,m),r,o,_):Te(le.ATTR_PERM_MISSING(R,m),r,o,_)}),!E.read&&h.read===!0&&(E.read=!0),!E.insert&&h.insert===!0&&(E.insert=!0),!E.update&&h.update===!0&&(E.update=!0)}if(u.read===!1&&E.read===!0||u.insert===!1&&E.insert===!0||u.update===!1&&E.update===!0){let d=`${o}.${_}`;Te(le.MISMATCHED_TABLE_ATTR_PERMS(d),r,o,_)}}}}return j0(r)}a(aO,"customValidate");oO.exports={addRoleValidation:W0,alterRoleValidation:J0,dropRoleValidation:Z0};function z0(e){let{operation:t,permission:r}=e;if(t===gn.OPERATIONS_ENUM.ADD_ROLE||t===gn.OPERATIONS_ENUM.ALTER_ROLE){let s=r.super_user===!0,n=r.cluster_user===!0;if(Object.keys(r).length>1&&(s||n)){if(n&&s)return le.SU_CU_ROLE_COMBINED_ERROR;{let o=r.super_user?gn.ROLE_TYPES_ENUM.SUPER_USER:gn.ROLE_TYPES_ENUM.CLUSTER_USER;return le.SU_CU_ROLE_NO_PERMS_ALLOWED(o)}}}return null}a(z0,"validateNoSUPerms");function j0(e){let{main_permissions:t,schema_permissions:r}=e;if(t.length>0||Object.keys(r).length>0){let s={error:le.ROLE_PERMS_ERROR,...e};return F0(new Error,s,k0.BAD_REQUEST)}else return null}a(j0,"generateRolePermResponse");function Te(e,t,r,s){if(!r)t.main_permissions.push(e);else{let n=s?r+"_"+s:r;t.schema_permissions[n]?t.schema_permissions[n].push(e):t.schema_permissions[n]=[e]}}a(Te,"addPermError")});var lE=S((BX,hO)=>{"use strict";var _O=Ut(),uO=mt(),eV=Rs(),aE=cO(),oE=js(),tV=require("uuid").v4,cE=require("util"),rV=Ai(),Nr=T(),lO=b(),_E=cE.promisify(uO.searchByValue),sV=cE.promisify(uO.searchByHash),nV=cE.promisify(eV.delete),iV=Kt(),aV=ds(),{hdb_errors:oV,handleHDBError:Ui}=D(),{HDB_ERROR_MSGS:EO,HTTP_STATUS_CODES:nE}=oV,{UserEventMsg:uE}=Gr();hO.exports={addRole:cV,alterRole:uV,dropRole:lV,listRoles:dO};function iE(e){try{e.hdb_auth_header&&delete e.hdb_auth_header,e.HDB_INTERNAL_PATH&&delete e.HDB_INTERNAL_PATH,e.operation&&delete e.operation,e.hdb_user&&delete e.hdb_user}catch{}return e}a(iE,"scrubRoleDetails");async function cV(e){let t=aE.addRoleValidation(e);if(t)throw t;if(!(await rV.getLicense()).enterprise){let o=await dO();if(_V(e,o))throw new Error(`Your current license only supports ${Nr.BASIC_LICENSE_MAX_CLUSTER_USER_ROLES} cluster_user role. ${Nr.SUPPORT_HELP_MSG}`);if(o.length>=2)throw new Error(`Your current license only supports ${Nr.BASIC_LICENSE_MAX_NON_CU_ROLES+Nr.BASIC_LICENSE_MAX_CLUSTER_USER_ROLES} roles.  ${Nr.SUPPORT_HELP_MSG}`)}e=iE(e);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:e.role,hash_attribute:"id",get_attributes:["*"]},n;try{n=await _E(s)}catch(o){throw Ui(o)}if(n&&n.length>0)throw Ui(new Error,EO.ROLE_ALREADY_EXISTS(e.role),nE.CONFLICT,void 0,void 0,!0);e.id||(e.id=tV());let i={operation:"insert",schema:"system",table:"hdb_role",hash_attribute:"id",records:[e]};return await _O.insert(i),oE.signalUserChange(new uE(process.pid)),e=iE(e),e}a(cV,"addRole");function _V(e,t){let r=!1;if(e.permission.cluster_user===!0)for(let s=0;s<t.length;s++){let i=t[s].permission;if(!lO.isEmpty(i)&&i.cluster_user===!0)return!0}return r}a(_V,"checkClusterUserRole");async function uV(e){let t=aE.alterRoleValidation(e);if(t)throw t;e=iE(e);let r={operation:"update",schema:"system",table:"hdb_role",hash_attribute:"rolename",records:[e]};try{await _O.update(r)}catch(s){throw Ui(s)}return oE.signalUserChange(new uE(process.pid)),e}a(uV,"alterRole");async function lV(e){let t=aE.dropRoleValidation(e);if(t)throw Ui(new Error,t,nE.BAD_REQUEST,void 0,void 0,!0);let r=new aV(Nr.SYSTEM_SCHEMA_NAME,Nr.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME,[e.id],["role"]),s=await sV(r);if(s.length===0)throw Ui(new Error,EO.ROLE_NOT_FOUND,nE.NOT_FOUND,void 0,void 0,!0);let n=new iV(Nr.SYSTEM_SCHEMA_NAME,Nr.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,"role",e.id,void 0,["username","active"]),i=await _E(n),o=!1;if(lO.isEmptyOrZeroLength(i)===!1){for(let _=0;_<i.length;_++)if(i[_].active===!0){o=!0;break}}if(o===!0)throw new Error(`Cannot drop role ${s[0].role} as it has active user(s) tied to this role`);let c={table:"hdb_role",schema:"system",hash_values:[e.id]};return await nV(c),oE.signalUserChange(new uE(process.pid)),`${s[0].role} successfully deleted`}a(lV,"dropRole");async function dO(){return _E({table:"hdb_role",schema:"system",hash_attribute:"id",search_attribute:"id",search_value:"*",get_attributes:["*"]})}a(dO,"listRoles")});var mO=S((vX,TO)=>{"use strict";var EV=Y(),Zr=require("joi"),dV=he(),SO=require("moment"),hV=require("fs-extra"),EE=require("path"),SV=require("lodash"),yi=T(),{LOG_LEVELS:Cs}=T(),fV="YYYY-MM-DD hh:mm:ss",TV=EE.resolve(__dirname,"../logs");TO.exports=function(e){return dV.validateBySchema(e,mV)};var mV=Zr.object({from:Zr.custom(fO),until:Zr.custom(fO),level:Zr.valid(Cs.NOTIFY,Cs.FATAL,Cs.ERROR,Cs.WARN,Cs.INFO,Cs.DEBUG,Cs.TRACE),order:Zr.valid("asc","desc"),limit:Zr.number().min(1),start:Zr.number().min(0),log_name:Zr.custom(RV)});function fO(e,t){if(SO(e,SO.ISO_8601).format(fV)==="Invalid date")return t.message(`'${t.state.path[0]}' date '${e}' is invalid.`)}a(fO,"validateDatetime");function RV(e,t){if(SV.invert(yi.PROCESS_LOG_NAMES)[e]===void 0)return t.message(`'log_name' '${e}' is invalid.`);let s=EV.get(yi.HDB_SETTINGS_NAMES.LOG_PATH_KEY),n=e===void 0?yi.PROCESS_LOG_NAMES.HDB:e,i=n===yi.PROCESS_LOG_NAMES.INSTALL?EE.join(TV,yi.PROCESS_LOG_NAMES.INSTALL):EE.join(s,n);return hV.existsSync(i)?null:t.message(`'log_name' '${e}' does not exist.`)}a(RV,"validateReadLogPath")});var hE=S((HX,AO)=>{"use strict";var ic=T(),RO=I(),AV=Y(),OV=mO(),dE=require("path"),pV=require("fs-extra"),NV=require("readline"),{once:gV}=require("events"),{handleHDBError:IV,hdb_errors:bV}=D(),{PACKAGE_ROOT:CV}=T(),wV=dE.join(CV,"logs"),LV=1e3;AO.exports=UV;async function UV(e){let t=OV(e);if(t)throw IV(t,t.message,bV.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=AV.get(ic.HDB_SETTINGS_NAMES.LOG_PATH_KEY),s=e.log_name===void 0?ic.PROCESS_LOG_NAMES.HDB:e.log_name,n=s===ic.PROCESS_LOG_NAMES.INSTALL?dE.join(wV,ic.PROCESS_LOG_NAMES.INSTALL):dE.join(r,s),i=pV.createReadStream(n);i.on("error",z=>{RO.error(z)});let o=NV.createInterface({input:i,crlfDelay:1/0}),c=e.level!==void 0,_=c?e.level:void 0,u=e.from!==void 0,l=u?new Date(e.from):void 0,E=e.until!==void 0,d=E?new Date(e.until):void 0,h=e.limit===void 0?LV:e.limit,m=e.order===void 0?void 0:e.order,R=e.start===void 0?0:e.start,w=R+h,L=0,B=[];return o.on("line",z=>{let V,W,ke,xe;try{V=JSON.parse(z)}catch(ua){RO.warn(ua.message);return}switch(!0){case(c&&u&&E):W=new Date(V.timestamp),ke=new Date(l),xe=new Date(d),V.level===_&&W>=ke&&W<=xe&&L<R?L++:V.level===_&&W>=ke&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(c&&u):W=new Date(V.timestamp),ke=new Date(l),V.level===_&&W>=ke&&L<R?L++:V.level===_&&W>=ke&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(c&&E):W=new Date(V.timestamp),xe=new Date(d),V.level===_&&W<=xe&&L<R?L++:V.level===_&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(u&&E):W=new Date(V.timestamp),ke=new Date(l),xe=new Date(d),W>=ke&&W<=xe&&L<R?L++:W>=ke&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case c:V.level===_&&L<R?L++:V.level===_&&(zr(V,m,B),L++,L===w&&Xr(o));break;case u:W=new Date(V.timestamp),ke=new Date(l),W>=ke&&L<R?L++:W>=ke&&L>=R&&(zr(V,m,B),L++,L===w&&Xr(o));break;case E:W=new Date(V.timestamp),xe=new Date(d),W<=xe&&L<R?L++:W<=xe&&L>=R&&(zr(V,m,B),L++,L===w&&Xr(o));break;default:L<R?L++:(zr(V,m,B),L++,L===w&&Xr(o))}}),await gV(o,"close"),B}a(UV,"readLog");function Xr(e){e.close(),e.removeAllListeners()}a(Xr,"endReadLine");function zr(e,t,r){t==="desc"?yV(e,r):t==="asc"?DV(e,r):r.push(e)}a(zr,"pushLineToResult");function yV(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)>r?s=i+1:n=i}t.splice(s,0,e)}a(yV,"insertDescending");function DV(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)<r?s=i+1:n=i}t.splice(s,0,e)}a(DV,"insertAscending")});var oc=S((FX,NO)=>{"use strict";var SE=require("joi"),{string:ac,boolean:OO,date:MV}=SE.types(),PV=he(),{validateSchemaExists:GX,validateTableExists:qX,validateSchemaName:BV}=Tr(),vV=T(),HV=_e(),GV=Y(),qV=ac.invalid(GV.get(vV.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(HV.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null).required(),pO={operation:ac.valid("add_node","update_node"),node_name:qV,subscriptions:SE.array().items({table:ac.required(),schema:ac.custom(BV).required(),subscribe:OO.required(),publish:OO.required().custom(VV),start_time:MV.iso()}).min(1).required()};function FV(e){return PV.validateBySchema(e,SE.object(pO))}a(FV,"addUpdateNodeValidator");function VV(e,t){if(t.state.ancestors[2].operation==="add_node"&&e===!1&&t.state.ancestors[0].subscribe===!1)return t.message(`'subscriptions[${t.state.path[1]}]' subscribe and/or publish must be set to true when adding a node`)}a(VV,"checkForFalsy");NO.exports={addUpdateNodeValidator:FV,validation_schema:pO}});var IO=S((VX,gO)=>{var kV=he(),xV={user:{presence:!0},schema:{presence:!0},table:{presence:!0},operation:{presence:!0}};gO.exports=function(e){return kV.validateObject(e,xV)}});var fE=S((kX,bO)=>{"use strict";var $V=T().OPERATIONS_ENUM,cc=class{constructor(t,r,s,n=void 0){this.operation=$V.UPDATE,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(cc,"UpdateObject");bO.exports=cc});var wO=S((xX,CO)=>{"use strict";var YV={OPERATION:"operation",REFRESH:"refresh"},_c=class{constructor(t,r){this.operation_token=t,this.refresh_token=r}};a(_c,"JWTTokens");var uc=class{constructor(t,r,s){this.public_key=t,this.private_key=r,this.passphrase=s}};a(uc,"JWTRSAKeys");CO.exports={JWTTokens:_c,TOKEN_TYPE_ENUM:YV,JWTRSAKeys:uc}});var hc=S(($X,DO)=>{"use strict";var Mi=require("jsonwebtoken"),TE=require("fs-extra"),mE=b(),Dt=T(),{handleHDBError:_t,hdb_errors:KV}=D(),{HTTP_STATUS_CODES:ut,AUTHENTICATION_ERROR_MSGS:lt}=KV,Di=I(),LO=xo(),OE=Wr(),QV=Ut().update,WV=fE(),JV=js(),{UserEventMsg:ZV}=Gr(),jr=Y();jr.initSync();var RE=require("path"),{JWTTokens:XV,JWTRSAKeys:zV,TOKEN_TYPE_ENUM:lc}=wO(),jV=jr.get(Dt.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY)?jr.get(Dt.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY):"1d",ek=jr.get(Dt.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY)?jr.get(Dt.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY):"30d",Ec="RS256",AE;DO.exports={createTokens:tk,validateOperationToken:sk,refreshOperationToken:rk,validateRefreshToken:yO};async function tk(e){if(mE.isEmpty(e)||typeof e!="object")throw _t(new Error,lt.INVALID_AUTH_OBJECT,ut.BAD_REQUEST,void 0,void 0,!0);if(mE.isEmpty(e.username))throw _t(new Error,lt.USERNAME_REQUIRED,ut.BAD_REQUEST,void 0,void 0,!0);if(mE.isEmpty(e.password))throw _t(new Error,lt.PASSWORD_REQUIRED,ut.BAD_REQUEST,void 0,void 0,!0);let t;try{if(t=await OE.findAndValidateUser(e.username,e.password),!t)throw _t(new Error,lt.INVALID_CREDENTIALS,ut.UNAUTHORIZED,void 0,void 0,!0)}catch(d){throw Di.error(d),_t(new Error,lt.INVALID_CREDENTIALS,ut.UNAUTHORIZED,void 0,void 0,!0)}let r=await dc(),s=!1,n=!1;t.role&&t.role.permission&&(s=t.role.permission.super_user===!0,n=t.role.permission.cluster_user===!0);let i={username:e.username,super_user:s,cluster_user:n},o=await UO(i,r.private_key,r.passphrase),c=await Mi.sign(i,{key:r.private_key,passphrase:r.passphrase},{expiresIn:ek,algorithm:Ec,subject:lc.REFRESH}),_=LO.hash(c),u=new WV(Dt.SYSTEM_SCHEMA_NAME,Dt.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,[{username:e.username,refresh_token:_}]),l,E;try{l=await QV(u)}catch(d){Di.error(d),E=d}if(E!==void 0||l.skipped_hashes.length>0)throw _t(new Error,lt.REFRESH_TOKEN_SAVE_FAILED,ut.INTERNAL_SERVER_ERROR);return JV.signalUserChange(new ZV(process.pid)),new XV(o,c)}a(tk,"createTokens");async function UO(e,t,r){return await Mi.sign(e,{key:t,passphrase:r},{expiresIn:jV,algorithm:Ec,subject:lc.OPERATION})}a(UO,"signOperationToken");async function dc(){if(AE===void 0)try{let e=RE.join(jr.getHdbBasePath(),Dt.LICENSE_KEY_DIR_NAME,Dt.JWT_ENUM.JWT_PASSPHRASE_NAME),t=RE.join(jr.getHdbBasePath(),Dt.LICENSE_KEY_DIR_NAME,Dt.JWT_ENUM.JWT_PRIVATE_KEY_NAME),r=RE.join(jr.getHdbBasePath(),Dt.LICENSE_KEY_DIR_NAME,Dt.JWT_ENUM.JWT_PUBLIC_KEY_NAME),s=(await TE.readFile(e)).toString(),n=(await TE.readFile(t)).toString(),i=(await TE.readFile(r)).toString();AE=new zV(i,n,s)}catch(e){throw Di.error(e),_t(new Error,lt.NO_ENCRYPTION_KEYS,ut.INTERNAL_SERVER_ERROR)}return AE}a(dc,"getJWTRSAKeys");async function rk(e){if(!e)throw _t(new Error,lt.INVALID_BODY,ut.BAD_REQUEST,void 0,void 0,!0);if(!e.refresh_token)throw _t(new Error,lt.REFRESH_TOKEN_REQUIRED,ut.BAD_REQUEST,void 0,void 0,!0);await yO(e.refresh_token);let t=await dc(),r=await Mi.decode(e.refresh_token);return{operation_token:await UO({username:r.username,super_user:r.super_user,cluster_user:r.cluster_user},t.private_key,t.passphrase)}}a(rk,"refreshOperationToken");async function sk(e){try{let t=await dc(),r=await Mi.verify(e,t.public_key,{algorithms:Ec,subject:lc.OPERATION});return await OE.findAndValidateUser(r.username,void 0,!1)}catch(t){throw Di.warn(t),t.name&&t.name==="TokenExpiredError"?_t(new Error,lt.TOKEN_EXPIRED,ut.FORBIDDEN):_t(new Error,lt.INVALID_TOKEN,ut.UNAUTHORIZED)}}a(sk,"validateOperationToken");async function yO(e){let t;try{let r=await dc(),s=await Mi.verify(e,r.public_key,{algorithms:Ec,subject:lc.REFRESH});t=await OE.findAndValidateUser(s.username,void 0,!1)}catch(r){throw Di.warn(r),r.name&&r.name==="TokenExpiredError"?_t(new Error,lt.TOKEN_EXPIRED,ut.FORBIDDEN):_t(new Error,lt.INVALID_TOKEN,ut.UNAUTHORIZED)}if(!LO.validate(t.refresh_token,e))throw _t(new Error,lt.INVALID_TOKEN,ut.UNAUTHORIZED);return t}a(yO,"validateRefreshToken")});var vO=S((KX,BO)=>{"use strict";var nk=IO(),bn=require("passport"),ik=require("passport-local").Strategy,ak=require("passport-http").BasicStrategy,ok=require("util"),ck=Wr(),PO=ok.callbackify(ck.findAndValidateUser),YX=Ke(),_k=T(),MO=hc();bn.use(new ik(function(e,t,r){PO(e,t,r)}));bn.use(new ak(function(e,t,r){PO(e,t,r)}));bn.serializeUser(function(e,t){t(null,e)});bn.deserializeUser(function(e,t){t(null,e)});function uk(e,t,r){let s,n;if(e.headers&&e.headers.authorization){let o=e.headers.authorization.split(" ");s=o[0],n=o[1]}function i(o,c){return o?r(o):c?r(null,c):r("User not found")}switch(a(i,"handleResponse"),s){case"Basic":bn.authenticate("basic",{session:!1},(o,c)=>{i(o,c)})(e,t,r);break;case"Bearer":e.body&&e.body.operation&&e.body.operation===_k.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN?MO.validateRefreshToken(n).then(o=>{e.body.refresh_token=n,r(null,o)}).catch(o=>{r(o)}):MO.validateOperationToken(n).then(o=>{r(null,o)}).catch(o=>{r(o)});break;default:bn.authenticate("local",{session:!1},function(o,c){i(o,c)})(e,t,r);break}}a(uk,"authorize");function lk(e,t){let r=nk(e);if(r){t(r);return}let s={authorized:!0,messages:[]},n=e.user.role;if(!n||!n.permission)return t("Invalid role");let i=JSON.parse(n.permission);if(i.super_user)return t(null,s);if(!i[e.schema])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.schema} schema`),t(null,s);if(!i[e.schema].tables[e.table])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.table} table`),t(null,s);if(!i[e.schema].tables[e.table][e.operation])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.operation} on ${e.table} table`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&!e.attributes)return s.authorized=!1,s.messages.push(`${e.schema}.${e.table} has attribute permissions. Missing attributes to validate`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&e.attributes){let o=i[e.schema].tables[e.table].attribute_permissions;for(let c in o)e.attributes.indexOf(o[c].attribute_name)>-1&&!o[c][e.operation]&&(s.authorized=!1,s.messages.push(`Not authorized to ${e.operation} ${o[c].attribute_name} `))}return t(null,s)}a(lk,"checkPermissions");BO.exports={authorize:uk,checkPermissions:lk}});var Cn=S((QX,HO)=>{"use strict";var Sc=class{constructor(t,r,s){this.name=t,this.subscriptions=r,this.system_info=s}};a(Sc,"Node");var fc=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.publish=s,this.subscribe=n}};a(fc,"NodeSubscription");HO.exports={Node:Sc,NodeSubscription:fc}});var qO=S((WX,GO)=>{"use strict";var Ek=T().OPERATIONS_ENUM,Tc=class{constructor(t,r,s,n=void 0){this.operation=Ek.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(Tc,"UpsertObject");GO.exports=Tc});var Pi=S((JX,FO)=>{"use strict";var mc=class{constructor(t,r,s,n){this.operation=t,this.node_name=r,this.subscriptions=s,this.system_info=n}};a(mc,"RemotePayloadObject");var Rc=class{constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.hash_attribute=s,this.publish=n,this.subscribe=i,this.start_time=o}};a(Rc,"RemotePayloadSubscription");FO.exports={RemotePayloadObject:mc,RemotePayloadSubscription:Rc}});var kO=S((ZX,VO)=>{"use strict";var Ac=class{constructor(t,r,s=0,n=0,i=0,o=0){this.schema=t,this.table=r,this.table_size=s,this.record_count=n,this.transaction_log_size=i,this.transaction_log_record_count=o}};a(Ac,"TableSizeObject");VO.exports=Ac});var KO=S((XX,YO)=>{"use strict";var dk=kO(),xO=require("path"),$O=te(),hk=Ye(),wn=Z(),Sk=I();YO.exports=fk;async function fk(e){let t=new dk;try{let r=xO.join($O.getBaseSchemaPath(),e.schema.toString()),s=await wn.openEnvironment(r,e.name),n=wn.statDBI(s,e.hash_attribute),i=xO.join($O.getTransactionAuditStorePath(),e.schema.toString()),o=await wn.openEnvironment(i,e.name,!0),c=wn.statDBI(o,hk.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP),_=await wn.environmentDataSize(r,e.name),u=await wn.environmentDataSize(i,e.name);t.schema=e.schema,t.table=e.name,t.table_size=_,t.record_count=n.entryCount,t.transaction_log_size=u,t.transaction_log_record_count=c.entryCount}catch(r){Sk.warn(`unable to stat table dbi due to ${r}`)}return t}a(fk,"lmdbGetTableSize")});var WO=S((zX,QO)=>{"use strict";var Tk=T(),Oc=class{constructor(t){this.operator=Tk.OPERATIONS_ENUM.SYSTEM_INFORMATION,this.attributes=t}};a(Oc,"SystemInformationOperation");QO.exports=Oc});var ZO=S((jX,JO)=>{"use strict";var pc=class{constructor(t,r,s,n,i,o,c){this.system=t,this.time=r,this.cpu=s,this.memory=n,this.disk=i,this.network=o,this.harperdb_processes=c}};a(pc,"SystemInformationObject");JO.exports=pc});var gc=S((t3,XO)=>{"use strict";var ve=require("systeminformation"),Ln=I(),mk=T(),Rk=KO(),Ak=fs(),Ok=Y();Ok.initSync();var e3=WO(),pk=ZO(),Nc;XO.exports={getHDBProcessInfo:IE,getNetworkInfo:CE,getDiskInfo:bE,getMemoryInfo:gE,getCPUInfo:NE,getTimeInfo:pE,getSystemInformation:wE,systemInformation:Nk,getTableSize:LE};function pE(){return ve.time()}a(pE,"getTimeInfo");async function NE(){try{let{family:e,model:t,stepping:r,revision:s,voltage:n,speedmin:i,speedmax:o,governor:c,socket:_,cache:u,...l}=await ve.cpu();l.cpu_speed=await ve.cpuCurrentSpeed();let{raw_currentload:E,raw_currentload_idle:d,raw_currentload_irq:h,raw_currentload_nice:m,raw_currentload_system:R,raw_currentload_user:w,cpus:L,...B}=await ve.currentLoad();return B.cpus=[],L.forEach(z=>{let{raw_load:V,raw_load_idle:W,raw_load_irq:ke,raw_load_nice:xe,raw_load_system:ua,raw_load_user:la,...yr}=z;B.cpus.push(yr)}),l.current_load=B,l}catch(e){return Ln.error(`error in getCPUInfo: ${e}`),{}}}a(NE,"getCPUInfo");async function gE(){try{let{buffers:e,cached:t,slab:r,buffcache:s,...n}=await ve.mem();return n}catch(e){return Ln.error(`error in getMemoryInfo: ${e}`),{}}}a(gE,"getMemoryInfo");async function IE(){let e={core:[],clustering:[]};try{return(await ve.processes()).list.forEach(r=>{r.params.includes(mk.HDB_PROC_NAME)?e.core.push(r):r.params.includes("socketcluster")&&e.clustering.push(r)}),e}catch(t){return Ln.error(`error in getHDBProcessInfo: ${t}`),e}}a(IE,"getHDBProcessInfo");async function bE(){let e={};try{let{rIO_sec:t,wIO_sec:r,tIO_sec:s,ms:n,...i}=await ve.disksIO();e.io=i;let{rx_sec:o,tx_sec:c,wx_sec:_,...u}=await ve.fsStats();return e.read_write=u,e.size=await ve.fsSize(),e}catch(t){return Ln.error(`error in getDiskInfo: ${t}`),e}}a(bE,"getDiskInfo");async function CE(){let e={default_interface:null,latency:{},interfaces:[],stats:[],connections:[]};try{return e.default_interface=await ve.networkInterfaceDefault(),e.latency=await ve.inetChecksite("google.com"),(await ve.networkInterfaces()).forEach(s=>{let{internal:n,virtual:i,mtu:o,dhcp:c,dnsSuffix:_,ieee8021xAuth:u,ieee8021xState:l,carrier_changes:E,...d}=s;e.interfaces.push(d)}),(await ve.networkStats()).forEach(s=>{let{rx_sec:n,tx_sec:i,ms:o,...c}=s;e.stats.push(c)}),e.connections=await ve.networkConnections(),e}catch(t){return Ln.error(`error in getNetworkInfo: ${t}`),e}}a(CE,"getNetworkInfo");async function wE(){if(Nc!==void 0)return Nc;let e={};try{let{codepage:t,logofile:r,serial:s,build:n,servicepack:i,uefi:o,...c}=await ve.osInfo();e=c;let _=await ve.versions("node, npm");return e.node_version=_.node,e.npm_version=_.npm,Nc=e,Nc}catch(t){return Ln.error(`error in getSystemInformation: ${t}`),e}}a(wE,"getSystemInformation");async function LE(){let e=[],t=await Ak.describeAll();for(let r of Object.values(t))for(let s of Object.values(r))e.push(await Rk(s));return e}a(LE,"getTableSize");async function Nk(e){let t=new pk;if(!Array.isArray(e.attributes)||e.attributes.length===0)return t.system=await wE(),t.time=pE(),t.cpu=await NE(),t.memory=await gE(),t.disk=await bE(),t.network=await CE(),t.harperdb_processes=await IE(),t.table_size=await LE(),t;for(let r=0;r<e.attributes.length;r++)switch(e.attributes[r]){case"system":t.system=await wE();break;case"time":t.time=pE();break;case"cpu":t.cpu=await NE();break;case"memory":t.memory=await gE();break;case"disk":t.disk=await bE();break;case"network":t.network=await CE();break;case"harperdb_processes":t.harperdb_processes=await IE();break;case"table_size":t.table_size=await LE();break;default:break}return t}a(Nk,"systemInformation")});var UE=S((n3,zO)=>{"use strict";var r3=require("fs-extra"),s3=I();zO.exports={version:gk,printVersion:bk,nodeVersion:Ik};var es=Hl();function gk(){if(es)return es.version}a(gk,"version");function Ik(){if(es&&es.engines&&es.engines["preferred-node"])return es.engines["preferred-node"]}a(Ik,"nodeVersion");function bk(){es&&console.log(`HarperDB Version ${es.version}`)}a(bk,"printVersion")});var Ls=S((o3,rp)=>{"use strict";var Ck=Ut(),yE=b(),DE=require("util"),ws=T(),jO=Y();jO.initSync();var wk=vO(),ep=mt(),{Node:i3,NodeSubscription:a3}=Cn(),Lk=ds(),Uk=qO(),{RemotePayloadObject:yk,RemotePayloadSubscription:Dk}=Pi(),{handleHDBError:Mk,hdb_errors:Pk}=D(),{HTTP_STATUS_CODES:Bk,HDB_ERROR_MSGS:vk}=Pk,Hk=Kt(),Gk=gc(),qk=UE(),Fk=DE.promisify(wk.authorize),Vk=DE.promisify(ep.searchByHash),kk=DE.promisify(ep.searchByValue);rp.exports={authHeaderToUser:xk,isEmpty:$k,getNodeRecord:Yk,upsertNodeRecord:Kk,buildNodePayloads:Qk,checkClusteringEnabled:Wk,getAllNodeRecords:Jk,getSystemInfo:Zk,reverseSubscription:tp};async function xk(e){let t={headers:{authorization:e.hdb_auth_header}};return e.hdb_user=await Fk(t,null),e}a(xk,"authHeaderToUser");function $k(e){return e==null}a($k,"isEmpty");async function Yk(e){let t=new Lk(ws.SYSTEM_SCHEMA_NAME,ws.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e],["*"]);return Vk(t)}a(Yk,"getNodeRecord");async function Kk(e){let t=new Uk(ws.SYSTEM_SCHEMA_NAME,ws.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e]);return Ck.upsert(t)}a(Kk,"upsertNodeRecord");function tp(e){if(yE.isEmpty(e.subscribe)||yE.isEmpty(e.publish))throw new Error("Received invalid subscription object");let{schema:t,table:r,hash_attribute:s}=e,n={schema:t,table:r,hash_attribute:s};return e.subscribe===!0&&e.publish===!1?(n.subscribe=!1,n.publish=!0):e.subscribe===!1&&e.publish===!0?(n.subscribe=!0,n.publish=!1):(n.subscribe=e.subscribe,n.publish=e.publish),n}a(tp,"reverseSubscription");function Qk(e,t,r,s){let n=[];for(let i=0,o=e.length;i<o;i++){let c=e[i],{schema:_,table:u}=c,l=yE.getTableHashAttribute(_,u),{subscribe:E,publish:d}=tp(c),h=new Dk(_,u,l,d,E,c.start_time);n.push(h)}return new yk(r,t,n,s)}a(Qk,"buildNodePayloads");function Wk(){if(!jO.get(ws.CONFIG_PARAMS.CLUSTERING_ENABLED))throw Mk(new Error,vk.CLUSTERING_NOT_ENABLED,Bk.BAD_REQUEST,void 0,void 0,!0)}a(Wk,"checkClusteringEnabled");async function Jk(){let e=new Hk(ws.SYSTEM_SCHEMA_NAME,ws.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,"name","*",void 0,["*"]);return kk(e)}a(Jk,"getAllNodeRecords");async function Zk(){let e=await Gk.getSystemInformation();return{hdb_version:qk.version(),node_version:e.node_version,platform:e.platform}}a(Zk,"getSystemInfo")});var PE=S((c3,cp)=>{"use strict";var ME=ct(),sp=b(),np=_e(),Xk=T(),Ic=I(),ip=tc(),zk=tl(),{RemotePayloadObject:jk}=Pi(),{handleHDBError:ap,hdb_errors:ex}=D(),{HTTP_STATUS_CODES:op}=ex,{NodeSubscription:tx}=Cn();cp.exports=rx;async function rx(e,t){let r;try{r=await ME.request(`${t}.${np.REQUEST_SUFFIX}`,new jk(Xk.OPERATIONS_ENUM.DESCRIBE_ALL,t,void 0,void 0)),Ic.trace("Response from remote describe all request:",r)}catch(o){Ic.error(`addNode received error from describe all request to remote node: ${o}`);let c=ME.requestErrorHandler(o,"add_node",t);throw ap(new Error,c,op.INTERNAL_SERVER_ERROR,"error",c)}if(r.status===np.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let o=`Error returned from remote node ${t}: ${r.message}`;throw ap(new Error,o,op.INTERNAL_SERVER_ERROR,"error",o)}let s=r.message,n=[],i=[];for(let o of e){let{schema:c,table:_}=o,u=sp.doesSchemaExist(c),l=s[c]!==void 0,E=sp.doesTableExist(c,_),d=s?.[c]?.[_]!==void 0;if(!u&&!l||!E&&!d){n.push(o);continue}if(!u&&l&&(Ic.trace(`addNode creating schema: ${c}`),await ip.createSchema({operation:"create_schema",schema:c})),!E&&d){Ic.trace(`addNode creating table: ${_} in schema: ${c}`);let m=new zk(c,_,s[c][_].hash_attribute);await ip.createTable(m)}await ME.createLocalTableStream(c,_);let h=new tx(c,_,o.publish,o.subscribe);h.start_time=o.start_time,i.push(h)}return{added:i,skipped:n}}a(rx,"reviewSubscriptions")});var wc=S((_3,lp)=>{"use strict";var{handleHDBError:bc,hdb_errors:sx}=D(),{HTTP_STATUS_CODES:Cc}=sx,{addUpdateNodeValidator:nx}=oc(),Bi=I(),up=T(),_p=_e(),ix=b(),BE=ct(),vi=Ls(),ax=Y(),ox=PE(),{Node:cx,NodeSubscription:_x}=Cn(),ux="Unable to create subscriptions due to schema and/or tables not existing on the local or remote node",lx="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",Ex=ax.get(up.CONFIG_PARAMS.CLUSTERING_NODENAME);lp.exports=dx;async function dx(e,t=!1){Bi.trace("addNode called with:",e),vi.checkClusteringEnabled();let r=nx(e);if(r)throw bc(r,r.message,Cc.BAD_REQUEST,void 0,void 0,!0);let s=e.node_name;if(!t){let E=await vi.getNodeRecord(s);if(!ix.isEmptyOrZeroLength(E))throw bc(new Error,`Node '${s}' has already been added, perform update_node to proceed.`,Cc.BAD_REQUEST,void 0,void 0,!0)}let{added:n,skipped:i}=await ox(e.subscriptions,s),o={message:void 0,added:n,skipped:i};if(n.length===0)return o.message=ux,o;let c=vi.buildNodePayloads(n,Ex,up.OPERATIONS_ENUM.ADD_NODE,await vi.getSystemInfo());Bi.trace("addNode sending remote payload:",c);let _;try{_=await BE.request(`${s}.${_p.REQUEST_SUFFIX}`,c)}catch(E){Bi.error(`addNode received error from request: ${E}`);let d=BE.requestErrorHandler(E,"add_node",s);throw bc(new Error,d,Cc.INTERNAL_SERVER_ERROR,"error",d)}if(_.status===_p.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let E=`Error returned from remote node ${s}: ${_.message}`;throw bc(new Error,E,Cc.INTERNAL_SERVER_ERROR,"error",E)}Bi.trace(_);let u=[];for(let E=0,d=n.length;E<d;E++){let h=n[E];Bi.trace("Add node updating work stream for node:",s,"subscriptions:",h),await BE.updateWorkStream(h,s),n[E].start_time===void 0&&delete n[E].start_time,u.push(new _x(h.schema,h.table,h.publish,h.subscribe))}let l=new cx(s,u,_.system_info);return await vi.upsertNodeRecord(l),i.length>0?o.message=lx:o.message=`Successfully added '${s}' to manifest`,o}a(dx,"addNode")});var HE=S((u3,hp)=>{"use strict";var{handleHDBError:Lc,hdb_errors:hx}=D(),{HTTP_STATUS_CODES:Uc}=hx,{addUpdateNodeValidator:Sx}=oc(),Hi=I(),dp=T(),Ep=_e(),fx=b(),vE=ct(),Gi=Ls(),Tx=Y(),{cloneDeep:mx}=require("lodash"),Rx=PE(),{NodeSubscription:Ax}=Cn(),Ox="Unable to update subscriptions due to schema and/or tables not existing on the local or remote node",px="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",Nx=Tx.get(dp.CONFIG_PARAMS.CLUSTERING_NODENAME);hp.exports=gx;async function gx(e){Hi.trace("updateNode called with:",e),Gi.checkClusteringEnabled();let t=Sx(e);if(t)throw Lc(t,t.message,Uc.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=mx(await Gi.getNodeRecord(r));if(fx.isEmptyOrZeroLength(s))throw Lc(new Error,`Node '${r}' has not been added, perform add_node to proceed.`,Uc.BAD_REQUEST,void 0,void 0,!0);let{added:n,skipped:i}=await Rx(e.subscriptions,r),o={message:void 0,updated:n,skipped:i};if(n.length===0)return o.message=Ox,o;let c=Gi.buildNodePayloads(n,Nx,dp.OPERATIONS_ENUM.UPDATE_NODE,await Gi.getSystemInfo());Hi.trace("updateNode sending remote payload:",c);let _;try{_=await vE.request(`${r}.${Ep.REQUEST_SUFFIX}`,c)}catch(u){Hi.error(`updateNode received error from request: ${u}`);let l=vE.requestErrorHandler(u,"update_node",r);throw Lc(new Error,l,Uc.INTERNAL_SERVER_ERROR,"error",l)}if(_.status===Ep.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let u=`Error returned from remote node ${r}: ${_.message}`;throw Lc(new Error,u,Uc.INTERNAL_SERVER_ERROR,"error",u)}Hi.trace(_);for(let u=0,l=n.length;u<l;u++){let E=n[u];Hi.trace(`updateNode updating work stream for node: ${r} subscription:`,E),await vE.updateWorkStream(E,r),n[u].start_time===void 0&&delete n[u].start_time}return await Ix(s[0],n,_.system_info),i.length>0?o.message=px:o.message=`Successfully updated '${r}'`,o}a(gx,"updateNode");async function Ix(e,t,r){let s=e;for(let n=0,i=t.length;n<i;n++){let o=t[n],c=!1;for(let _=0,u=e.subscriptions.length;_<u;_++){let l=s.subscriptions[_];if(l.schema===o.schema&&l.table===o.table){l.publish=o.publish,l.subscribe=o.subscribe,c=!0;break}}c||s.subscriptions.push(new Ax(o.schema,o.table,o.publish,o.subscribe))}s.system_info=r,await Gi.upsertNodeRecord(s)}a(Ix,"updateNodeTable")});var Rp=S((l3,mp)=>{"use strict";var Tp=require("joi"),{string:Sp}=Tp.types(),bx=he(),fp=T(),Cx=Y(),wx=_e();mp.exports=Lx;function Lx(e){let t=Sp.invalid(Cx.get(fp.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(wx.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null),r=Tp.object({operation:Sp.valid(fp.OPERATIONS_ENUM.REMOVE_NODE).required(),node_name:t});return bx.validateBySchema(e,r)}a(Lx,"removeNodeValidator")});var Dc=S((E3,Ip)=>{"use strict";var{handleHDBError:Ap,hdb_errors:Ux}=D(),{HTTP_STATUS_CODES:Op}=Ux,yx=Rp(),qi=I(),pp=Ls(),Dx=b(),yc=T(),Np=_e(),gp=ct(),Mx=Y(),{RemotePayloadObject:Px}=Pi(),{NodeSubscription:Bx}=Cn(),vx=li(),Hx=Rs(),Gx=Mx.get(yc.CONFIG_PARAMS.CLUSTERING_NODENAME);Ip.exports=qx;async function qx(e){qi.trace("removeNode called with:",e),pp.checkClusteringEnabled();let t=yx(e);if(t)throw Ap(t,t.message,Op.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=await pp.getNodeRecord(r);if(Dx.isEmptyOrZeroLength(s))throw Ap(new Error,`Node '${r}' was not found.`,Op.BAD_REQUEST,void 0,void 0,!0);s=s[0];let n=new Px(yc.OPERATIONS_ENUM.REMOVE_NODE,Gx,[]),i,o=!1;try{i=await gp.request(`${r}.${Np.REQUEST_SUFFIX}`,n),qi.trace("Remove node reply from remote node:",r,i)}catch(_){qi.error("removeNode received error from request:",_),o=!0}for(let _=0,u=s.subscriptions.length;_<u;_++){let l=s.subscriptions[_];qi.trace(`Remove node removing subscription: ${l.schema}.${l.table} for node: ${r}`);let E=new Bx(l.schema,l.table,!1,!1);await gp.updateWorkStream(E,r)}let c=new vx(yc.SYSTEM_SCHEMA_NAME,yc.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[r]);return await Hx.deleteRecord(c),i?.status===Np.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR||o?(qi.error("Error returned from remote node:",r,i?.message),`Successfully removed '${r}' from local manifest, however there was an error reaching remote node. Check the logs for more details.`):`Successfully removed '${r}' from manifest`}a(qx,"removeNode")});var wp=S((d3,Cp)=>{"use strict";var bp=require("joi"),{string:Fx,array:Vx}=bp.types(),kx=he(),xx=oc();Cp.exports=$x;function $x(e){let t=bp.object({operation:Fx.valid("configure_cluster").required(),connections:Vx.items(xx.validation_schema).required()});return kx.validateBySchema(e,t)}a($x,"configureClusterValidator")});var GE=S((h3,Mp)=>{"use strict";var Yx=T(),Mc=I(),Kx=b(),Qx=Dc(),Wx=wc(),Lp=Ls(),Jx=wp(),{handleHDBError:Up,hdb_errors:Zx}=D(),{HTTP_STATUS_CODES:yp}=Zx,Xx="Configure cluster complete.",zx="Failed to configure the cluster. Check the logs for more details.",jx="Configure cluster was partially successful. Errors occurred when attempting to configure the following nodes. Check the logs for more details.";Mp.exports=e$;async function e$(e){Mc.trace("configure cluster called with:",e),Lp.checkClusteringEnabled();let t=Jx(e);if(t)throw Up(t,t.message,yp.BAD_REQUEST,void 0,void 0,!0);let r=await Lp.getAllNodeRecords(),s=[];for(let d=0,h=r.length;d<h;d++)s.push(Dp(Qx,{operation:Yx.OPERATIONS_ENUM.REMOVE_NODE,node_name:r[d].name},r[d].name));let n=await Promise.allSettled(s);Mc.trace("All results from configure_cluster remove node:",n);let i=[],o=e.connections.length;for(let d=0;d<o;d++){let h=e.connections[d];i.push(Dp(Wx,h,h.node_name))}let c=await Promise.allSettled(i);Mc.trace("All results from configure_cluster add node:",c);let _=[],u=[],l=!1,E=n.concat(c);for(let d=0,h=E.length;d<h;d++){let m=E[d];m.status==="rejected"&&(Mc.error(m.reason),_.includes(m.reason.node_name)||_.push(m.reason.node_name)),m.status==="fulfilled"&&(l=!0);let R=m?.value?.result;typeof R=="string"&&R.includes("Successfully removed")||m.status==="rejected"||u.push({node_name:m?.value?.node_name,subscriptions:m?.value?.result})}if(Kx.isEmptyOrZeroLength(_))return{message:Xx,connections:u};if(l)return{message:jx,failed_nodes:_,connections:u};throw Up(new Error,zx,yp.INTERNAL_SERVER_ERROR,void 0,void 0,!0)}a(e$,"configureCluster");async function Dp(e,t,r){try{return{node_name:r,result:await e(t)}}catch(s){throw{node_name:r,error:s}}}a(Dp,"functionWrapper")});var VE=S((S3,qp)=>{"use strict";var FE=Ls(),t$=ct(),vp=Y(),Pc=T(),Us=_e(),r$=b(),qE=I(),{RemotePayloadObject:s$}=Pi(),{ErrorCode:Pp}=require("nats"),Bp=vp.get(Pc.CONFIG_PARAMS.CLUSTERING_ENABLED),Hp=vp.get(Pc.CONFIG_PARAMS.CLUSTERING_NODENAME);qp.exports={clusterStatus:n$,buildNodeStatus:Gp};async function n$(){let e={node_name:Hp,is_enabled:Bp,connections:[]};if(!Bp)return e;let t=await FE.getAllNodeRecords();if(r$.isEmptyOrZeroLength(t))return e;let r=[];for(let s=0,n=t.length;s<n;s++)r.push(Gp(t[s],e.connections));return await Promise.allSettled(r),e}a(n$,"clusterStatus");async function Gp(e,t){let r=e.name,s=new s$(Pc.OPERATIONS_ENUM.CLUSTER_STATUS,Hp,void 0,await FE.getSystemInfo()),n,i,o=Us.CLUSTER_STATUS_STATUSES.OPEN;try{let _=Date.now();n=await t$.request(Us.REQUEST_SUBJECT(r),s),i=Date.now()-_,n.status===Us.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR&&(o=Us.CLUSTER_STATUS_STATUSES.CLOSED,qE.error(`Error getting node status from ${r} `,n))}catch(_){qE.warn(`Error getting node status from ${r}`,_),_.code===Pp.NoResponders?o=Us.CLUSTER_STATUS_STATUSES.NO_RESPONDERS:_.code===Pp.Timeout?o=Us.CLUSTER_STATUS_STATUSES.TIMEOUT:o=Us.CLUSTER_STATUS_STATUSES.CLOSED}let c=new i$(r,o,n?.message?.ports?.clustering,n?.message?.ports?.operations_api,i,n?.message?.uptime,e.subscriptions,n?.message?.system_info);try{let _={name:r,system_info:n?.message?.system_info};e.system_info?.hdb_version!==Pc.PRE_4_0_0_VERSION&&await FE.upsertNodeRecord(_)}catch(_){qE.error("Cluster status encountered an error updating system info for node:",r,_)}t.push(c)}a(Gp,"buildNodeStatus");function i$(e,t,r,s,n,i,o,c){this.node_name=e,this.status=t,this.ports={clustering:r,operations_api:s},this.latency_ms=n,this.uptime=i,this.subscriptions=o,this.system_info=c}a(i$,"NodeStatusObject")});var xp=S((f3,kp)=>{"use strict";var kE=require("joi"),Fp=he(),{route_constraints:Vp}=Su();kp.exports={setRoutesValidator:a$,deleteRoutesValidator:o$};function a$(e){let t=kE.object({server:kE.valid("hub","leaf").required(),routes:Vp.required()});return Fp.validateBySchema(e,t)}a(a$,"setRoutesValidator");function o$(e){let t=kE.object({routes:Vp.required()});return Fp.validateBySchema(e,t)}a(o$,"deleteRoutesValidator")});var $E=S((T3,Qp)=>{"use strict";var ys=Sr(),xE=b(),Bc=T(),$p=xp(),{handleHDBError:Yp,hdb_errors:c$}=D(),{HTTP_STATUS_CODES:Kp}=c$,_$="cluster routes successfully set",u$="cluster routes successfully deleted";Qp.exports={setRoutes:l$,getRoutes:E$,deleteRoutes:d$};function l$(e){let t=$p.setRoutesValidator(e);if(t)throw Yp(t,t.message,Kp.BAD_REQUEST,void 0,void 0,!0);let r=ys.getClusteringRoutes(),s=e.server==="hub"?r.hub_routes:r.leaf_routes,n=e.server==="hub"?r.leaf_routes:r.hub_routes,i=[],o=[];for(let c=0,_=e.routes.length;c<_;c++){let u=e.routes[c];u.port=xE.autoCast(u.port);let l=s.some(d=>d.host===u.host&&d.port===u.port),E=n.some(d=>d.host===u.host&&d.port===u.port);l||E?i.push(u):(s.push(u),o.push(u))}return e.server==="hub"?ys.updateConfigValue(Bc.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s):ys.updateConfigValue(Bc.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,s),{message:_$,set:o,skipped:i}}a(l$,"setRoutes");function E$(){let e=ys.getClusteringRoutes();return{hub:e.hub_routes,leaf:e.leaf_routes}}a(E$,"getRoutes");function d$(e){let t=$p.deleteRoutesValidator(e);if(t)throw Yp(t,t.message,Kp.BAD_REQUEST,void 0,void 0,!0);let r=ys.getClusteringRoutes(),s=r.hub_routes,n=r.leaf_routes,i=[],o=[],c=!1,_=!1;for(let u=0,l=e.routes.length;u<l;u++){let E=e.routes[u],d=!1;for(let h=0,m=s.length;h<m;h++){let R=s[h];if(E.host===R.host&&E.port===R.port){s.splice(h,1),d=!0,c=!0,i.push(E);break}}if(!d){let h=!0;for(let m=0,R=n.length;m<R;m++){let w=n[m];if(E.host===w.host&&E.port===w.port){n.splice(m,1),_=!0,h=!1,i.push(E);break}}h&&o.push(E)}}return c&&(s=xE.isEmptyOrZeroLength(s)?null:s,ys.updateConfigValue(Bc.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s)),_&&(n=xE.isEmptyOrZeroLength(n)?null:n,ys.updateConfigValue(Bc.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,n)),{message:u$,deleted:i,skipped:o}}a(d$,"deleteRoutes")});var Jp=S((m3,Wp)=>{"use strict";var Fi=require("alasql"),Ds=require("recursive-iterator"),Wt=I(),h$=b(),Vi=T(),vc=class{constructor(t){this.ast=t,this.affected_attributes=new Map,this.table_lookup=new Map,this.schema_lookup=new Map,this.table_to_schema_lookup=new Map,f$(this.ast,this.affected_attributes,this.table_lookup,this.schema_lookup,this.table_to_schema_lookup)}getAttributesBySchemaTableName(t,r){if(!t||!r||!this.affected_attributes)return[];if(this.affected_attributes.has(t))return!this.affected_attributes.get(t).has(r)&&(r=this.table_lookup.get(r),!r)?[]:this.affected_attributes.get(t).get(r)}getAllTables(){let t=[];if(!this.affected_attributes)return t;for(let r of this.affected_attributes.keys())t.push(Array.from(this.affected_attributes.get(r).keys()));return t}getTablesBySchemaName(t){return!t||!this.affected_attributes?[]:Array.from(this.affected_attributes.get(t).keys())}getSchemas(){return this.affected_attributes?Array.from(this.affected_attributes.keys()):[]}getAst(){return this.ast}updateAttributeWildcardsForRolePerms(t){let r=this.ast.columns.filter(n=>Vi.SEARCH_WILDCARDS.includes(n.columnid));if(r.length===0)return this.ast;let s=this.ast.from[0].databaseid;return this.ast.columns=this.ast.columns.filter(n=>!Vi.SEARCH_WILDCARDS.includes(n.columnid)),r.forEach(n=>{let i=this.table_to_schema_lookup.has(n.tableid)?this.table_to_schema_lookup.get(n.tableid):s,o=this.table_lookup.has(n.tableid)?this.table_lookup.get(n.tableid):this.ast.from[0].tableid;if(t[i]&&t[i].tables[o]&&t[i].tables[o][Vi.PERMS_CRUD_ENUM.READ]){let c;t[i].tables[o].attribute_permissions.length>0?c=S$(t[i].tables[o].attribute_permissions):c=global.hdb_schema[i][o].attributes.map(u=>({attribute_name:u.attribute}));let _=this.affected_attributes.get(i).get(o).filter(u=>!Vi.SEARCH_WILDCARDS.includes(u));c.forEach(({attribute_name:u})=>{let l=new Fi.yy.Column({columnid:u});n.tableid&&(l.tableid=n.tableid),this.ast.columns.push(l),_.includes(u)||_.push(u)}),this.affected_attributes.get(i).set(o,_)}}),this.ast}};a(vc,"sql_statement_bucket");function S$(e){return e.filter(t=>t[Vi.PERMS_CRUD_ENUM.READ])}a(S$,"filterReadRestrictedAttrs");function f$(e,t,r,s,n){T$(e,t,r,s,n)}a(f$,"interpretAST");function ki(e,t,r,s,n){if(!(!e||!e.databaseid)&&(t.has(e.databaseid)||t.set(e.databaseid,new Map),t.get(e.databaseid).has(e.tableid)||t.get(e.databaseid).set(e.tableid,[]),e.as&&(r.has(e.as)||r.set(e.as,e.tableid),s&&!s.has(e.as)&&s.set(e.as,e.databaseid)),n)){let i=e.databaseid,o=e.tableid;e.as&&(o=e.as),n.set(o,i)}}a(ki,"addSchemaTableToMap");function T$(e,t,r,s,n){if(!e){Wt.info("getRecordAttributesAST: invalid SQL syntax tree");return}e instanceof Fi.yy.Insert?O$(e,t,r):e instanceof Fi.yy.Select?m$(e,t,r,s,n):e instanceof Fi.yy.Update?R$(e,t,r):e instanceof Fi.yy.Delete?A$(e,t,r):Wt.error("AST in getRecordAttributesAST() is not a valid SQL type.")}a(T$,"getRecordAttributesAST");function m$(e,t,r,s,n){if(!e){Wt.info("getSelectAttributes: invalid SQL syntax tree");return}if(!e.from||e.from[0]===void 0)return;let i=e.from[0].databaseid;if(h$.isEmptyOrZeroLength(i)){Wt.error("No schema specified");return}e.from.forEach(c=>{ki(c,t,r,s,n)}),e.joins&&e.joins.forEach(c=>{c.as&&(c.table.as=c.as),ki(c.table,t,r,s,n)});let o=new Ds(e.columns);for(let{node:c}of o)if(c&&c.columnid){let _=c.tableid,u=s.has(_)?s.get(_):i;if(_||(_=e.from[0].tableid),!t.get(u).has(_))if(r.has(_))_=r.get(_);else{Wt.info(`table specified as ${_} not found.`);return}t.get(u).get(_).indexOf(c.columnid)<0&&t.get(u).get(_).push(c.columnid)}if(e.where){let c=new Ds(e.where),_=e.from[0].tableid;for(let{node:u}of c)if(u&&u.columnid){let l=u.tableid?u.tableid:_;if(!t.get(i).has(l))if(r.has(l))l=r.get(l);else{Wt.info(`table specified as ${l} not found.`);continue}t.get(i).get(l).indexOf(u.columnid)<0&&t.get(i).get(l).push(u.columnid)}}if(e.joins&&e.joins.forEach(c=>{let _=new Ds(c.on);for(let{node:u}of _)if(u&&u.columnid){let l=u.tableid,E=n.get(l);if(!t.get(E).has(l))if(r.has(l))l=r.get(l);else{Wt.info(`table specified as ${l} not found.`);continue}t.get(E).get(l).indexOf(u.columnid)<0&&t.get(E).get(l).push(u.columnid)}}),e.order){let c=new Ds(e.order);for(let{node:_}of c)if(_&&_.columnid){let u=_.tableid,l=s.has(u)?s.get(u):i;if(u||(u=e.from[0].tableid),!t.get(l).has(u))if(r.has(u))u=r.get(u);else{Wt.info(`table specified as ${u} not found.`);return}t.get(l).get(u).indexOf(_.columnid)<0&&t.get(l).get(u).push(_.columnid)}}}a(m$,"getSelectAttributes");function R$(e,t,r){if(!e){Wt.info("getUpdateAttributes: invalid SQL syntax tree");return}let s=new Ds(e.columns),n=e.table.databaseid;ki(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&YE(e.table.tableid,n,i.columnid,t,r)}a(R$,"getUpdateAttributes");function A$(e,t,r){if(!e){Wt.info("getDeleteAttributes: invalid SQL syntax tree");return}let s=new Ds(e.where),n=e.table.databaseid;ki(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&YE(e.table.tableid,n,i.columnid,t,r)}a(A$,"getDeleteAttributes");function O$(e,t,r){if(!e){Wt.info("getInsertAttributes: invalid SQL syntax tree");return}let s=new Ds(e.columns),n=e.into.databaseid;ki(e.into,t,r);for(let{node:i}of s)i&&i.columnid&&YE(e.into.tableid,n,i.columnid,t,r)}a(O$,"getInsertAttributes");function YE(e,t,r,s,n){if(!s.get(t))return;let i=e;s.get(t).has(i)||(i=n.get(i)),s.get(t).get(i).push(r)}a(YE,"pushAttribute");Wp.exports=vc});var zp=S((R3,Xp)=>{var p$=require("os"),Zp=Y();Xp.exports={checkPermission:N$};function N$(){if(p$.userInfo().username!==Zp.get("install_user"))throw new Error(`Error: Must execute as ${Zp.get("install_user")}`)}a(N$,"checkPermission")});var QE=S((A3,sN)=>{var Gc=Ai(),jp=require("chalk"),ir=I(),eN=zp(),tN=require("prompt"),{promisify:g$}=require("util"),Hc=T(),I$=require("fs-extra"),b$=require("path"),C$=b(),w$=UE(),rN=Y();rN.initSync();var L$=require("moment"),U$=g$(tN.get),y$=b$.join(rN.getHdbBasePath(),Hc.LICENSE_KEY_DIR_NAME,Hc.LICENSE_FILE_NAME,Hc.LICENSE_FILE_NAME);sN.exports={getFingerprint:M$,setLicense:D$,parseLicense:KE,register:P$,getRegistrationInfo:v$};async function D$(e){if(e&&e.key&&e.company){try{ir.info(`parsing license key: ${e.key} and `);let t=e.company.toString();await KE(e.key.trim(),t.trim())}catch(t){let r="There was an error parsing the license key.";throw ir.error(r),ir.error(t),new Error(r)}return"Wrote license key file.  Registration successful."}throw new Error("Invalid key or company specified for license file.")}a(D$,"setLicense");async function M$(){try{eN.checkPermission()}catch(t){throw ir.error(t),new Error("You do not have permission to generate a fingerprint.")}let e={};try{e=await Gc.generateFingerPrint()}catch(t){let r="Error generating fingerprint.";throw ir.error(r),ir.error(t),new Error(r)}return e}a(M$,"getFingerprint");async function KE(e,t){if(!e||!t)throw new Error("Invalid entries for License Key and Customer Company");console.log("Validating license input...");let r=Gc.validateLicense(e,t);if(console.log("checking for valid license..."),!r.valid_license)throw new Error("Invalid license found.");if(console.log("checking valid license date..."),!r.valid_date)throw new Error("This License has expired.");if(console.log(`checking for valid machine license ${r.valid_machine}`),!r.valid_machine)throw new Error("This license is in use on another machine.");try{ir.info("writing license to disk"),await I$.writeFile(y$,JSON.stringify({license_key:e,company:t}))}catch(s){throw ir.error("Failed to write License"),s}return"Registration successful."}a(KE,"parseLicense");async function P$(){let e=await B$();return KE(e.HDB_LICENSE,e.CUSTOMER_COMPANY)}a(P$,"register");async function B$(){try{eN.checkPermission()}catch(s){return console.error(s.message)}let e=await Gc.generateFingerPrint(),t={properties:{CUSTOMER_COMPANY:{description:jp.magenta("[COMPANY] Please enter your company name"),required:!0},HDB_LICENSE:{description:jp.magenta(`[HDB_LICENSE] Your fingerprint is ${e} Please enter your license key`),required:!0}}};try{tN.start()}catch(s){ir.error(s)}let r;try{r=await U$(t)}catch(s){throw console.error("There was a problem prompting for registration input.  Exiting."),s}return r}a(B$,"promptForRegistration");async function v$(){let e={registered:!1,version:null,storage_type:null,ram_allocation:null,license_expiration_date:null},t;try{t=await Gc.getLicense()}catch(r){throw ir.error(`There was an error when searching licenses due to: ${r.message}`),r}if(C$.isEmptyOrZeroLength(t))throw new Error("There were no licenses found.");if(e.registered=t.enterprise,e.version=w$.version(),e.storage_type=Hc.STORAGE_TYPES_ENUM.LMDB,e.ram_allocation=t.ram_allocation,isNaN(t.exp_date))e.license_expiration_date=t.enterprise?t.exp_date:null;else{let r=L$.utc(t.exp_date).format("YYYY-MM-DD");e.license_expiration_date=t.enterprise?r:null}return e}a(v$,"getRegistrationInfo")});var iN=S((O3,nN)=>{"use strict";var H$=_e(),qc=class{constructor(t,r,s,n,i,o,c,_,u,l,E,d,h){this.port=t,this.server_name=r+H$.SERVER_SUFFIX.HUB,this.pid_file=s,this.max_payload=1e7,this.jetstream={enabled:!1},this.tls={cert_file:n,key_file:i,ca_file:o,insecure:c},this.leafnodes={port:_,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.cluster={name:u,port:l,routes:E,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.accounts={SYS:{users:d},HDB:{users:h}},this.system_account="SYS"}};a(qc,"HubConfigObject");nN.exports=qc});var cN=S((p3,oN)=>{"use strict";var aN=_e(),Fc=class{constructor(t,r,s,n,i,o,c,_,u,l,E,d){this.port=t,this.server_name=r+aN.SERVER_SUFFIX.LEAF,this.pid_file=s,this.max_payload=1e7,this.jetstream={enabled:!0,store_dir:n,domain:r+aN.SERVER_SUFFIX.LEAF},this.tls={cert_file:u,key_file:l,ca_file:E,insecure:d},this.leafnodes={remotes:[{tls:{ca_file:E,insecure:d},urls:i,account:"SYS"},{tls:{ca_file:E,insecure:d},urls:o,account:"HDB"}]},this.accounts={SYS:{users:c},HDB:{users:_,jetstream:"enabled"}},this.system_account="SYS"}};a(Fc,"LeafConfigObject");oN.exports=Fc});var uN=S((N3,_N)=>{"use strict";var Vc=class{constructor(t,r){this.user=t,this.password=r}};a(Vc,"HdbUserObject");_N.exports=Vc});var EN=S((g3,lN)=>{"use strict";var G$=_e(),kc=class{constructor(t,r){this.user=t+G$.SERVER_SUFFIX.ADMIN,this.password=r}};a(kc,"SysUserObject");lN.exports=kc});var ZE=S((I3,SN)=>{"use strict";var Un=require("path"),Kc=require("fs-extra"),q$=iN(),F$=cN(),V$=uN(),k$=EN(),WE=Wr(),Dn=b(),Mt=Sr(),Yc=T(),xc=_e(),{CONFIG_PARAMS:we}=Yc,Qc=I(),Wc=Y(),dN=Vr(),JE=ct(),yn="clustering",x$=1e4,hN=5;SN.exports={generateNatsConfig:$$,removeNatsConfig:Y$};async function $$(e=!1,t=void 0){Wc.initSync();let r=Wc.get(we.ROOTPATH),s=Un.join(r,yn,xc.PID_FILES.HUB),n=Un.join(r,yn,xc.PID_FILES.LEAF),i=Un.join(r,yn,"leaf"),o=Un.join(r,yn,xc.NATS_CONFIG_FILES.HUB_SERVER),c=Un.join(r,yn,xc.NATS_CONFIG_FILES.LEAF_SERVER),_=Mt.getConfigFromFile(we.CLUSTERING_TLS_CERTIFICATE),u=Mt.getConfigFromFile(we.CLUSTERING_TLS_PRIVATEKEY),l=Mt.getConfigFromFile(we.CLUSTERING_TLS_CERT_AUTH),E=Mt.getConfigFromFile(we.CLUSTERING_TLS_INSECURE),d=Mt.getConfigFromFile(we.CLUSTERING_NODENAME),h=Mt.getConfigFromFile(we.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT);await JE.checkNATSServerInstalled()||Jc("nats-server dependency is either missing or the wrong version. Run 'npm install' to fix");let m=await WE.listUsers(),R=Mt.getConfigFromFile(we.CLUSTERING_USER),w=await WE.getClusterUser();(Dn.isEmpty(w)||w.active!==!0)&&Jc(`invalid cluster user '${R}'`),e||(await $c(we.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),await $c(we.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT),await $c(we.CLUSTERING_HUBSERVER_NETWORK_PORT),await $c(we.CLUSTERING_LEAFSERVER_NETWORK_PORT));let L=[],B=[];for(let[la,yr]of m.entries())yr.role.role===Yc.ROLE_TYPES_ENUM.CLUSTER_USER&&yr.active&&(L.push(new k$(yr.username,dN.decrypt(yr.hash))),B.push(new V$(yr.username,dN.decrypt(yr.hash))));let z=[],{hub_routes:V}=Mt.getClusteringRoutes();if(!Dn.isEmptyOrZeroLength(V))for(let la of V)z.push(`tls://${w.sys_name_encoded}:${w.uri_encoded_d_hash}@${la.host}:${la.port}`);let W=new q$(Mt.getConfigFromFile(we.CLUSTERING_HUBSERVER_NETWORK_PORT),d,s,_,u,l,E,h,Mt.getConfigFromFile(we.CLUSTERING_HUBSERVER_CLUSTER_NAME),Mt.getConfigFromFile(we.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),z,L,B);t=Dn.isEmpty(t)?void 0:t.toLowerCase(),(t===void 0||t===Yc.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())&&(await Kc.writeJson(o,W),Qc.trace(`Hub server config written to ${o}`));let ke=`tls://${w.sys_name_encoded}:${w.uri_encoded_d_hash}@0.0.0.0:${h}`,xe=`tls://${w.uri_encoded_name}:${w.uri_encoded_d_hash}@0.0.0.0:${h}`,ua=new F$(Mt.getConfigFromFile(we.CLUSTERING_LEAFSERVER_NETWORK_PORT),d,n,i,[ke],[xe],L,B,_,u,l,E);(t===void 0||t===Yc.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())&&(await Kc.writeJson(c,ua),Qc.trace(`Leaf server config written to ${c}`))}a($$,"generateNatsConfig");async function $c(e){let t=Wc.get(e);Dn.isEmpty(t)&&Jc(`port undefined for '${e}'`),await Dn.isPortTaken(t)&&Jc(`'${e}' port '${t}' is unavailable`)}a($c,"isPortAvailable");function Jc(e){let t=`Error generating clustering config: ${e}`;Qc.error(t),console.error(t),process.exit(1)}a(Jc,"generateNatsConfigError");async function Y$(e){let{port:t,config_file:r}=JE.getServerConfig(e),{username:s,decrypt_hash:n}=await WE.getClusterUser(),i=0,o=500;for(;i<hN;){try{let u=await JE.createConnection(t,s,n,!1);if(u.protocol.connected===!0){u.close();break}}catch(u){Qc.trace(`removeNatsConfig waiting for ${e}. Caught and swallowed error ${u}`)}if(i++,i>=hN)throw new Error(`removeNatsConfig timed out waiting to connect to ${e}`);await Dn.async_set_timeout(o*i)}let c="0".repeat(x$),_=Un.join(Wc.get(we.ROOTPATH),yn,r);await Kc.writeFile(_,c),await Kc.remove(_)}a(Y$,"removeNatsConfig")});var Xc=S((b3,pN)=>{"use strict";var ne=Y(),fN=Ai(),C=T(),XE=_e(),Oe=require("path"),{PACKAGE_ROOT:Zc}=T(),Ee="/dev/null",Mn=Oe.join(Zc,"launchServiceScripts"),TN=Oe.join(Zc,"utility/scripts"),K$=Oe.join(TN,C.HDB_RESTART_SCRIPT),mN=Oe.resolve(Zc,"dependencies",`${process.platform}-${process.arch}`,XE.NATS_BINARY_NAME),He,Ge;function ar(){(He===void 0||Ge===void 0)&&(ne.initSync(),He=ne.get(C.HDB_SETTINGS_NAMES.LOG_TO_FILE),Ge=ne.get(C.HDB_SETTINGS_NAMES.LOG_PATH_KEY))}a(ar,"initLogConfig");function RN(){ar();let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.IPC),t={name:C.PROCESS_DESCRIPTORS.IPC,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.IPC},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:C.SERVICE_SERVERS_CWD.IPC};return He||(t.out_file=Ee,t.error_file=Ee),{...t,script:C.SERVICE_SERVERS.IPC}}a(RN,"generateIPCServerConfig");function AN(){ar(),ne.initSync(),He=ne.get(C.HDB_SETTINGS_NAMES.LOG_TO_FILE),Ge=ne.get(C.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.HDB),t=fN.licenseSearch(),r=t.ram_allocation?C.MEM_SETTING_KEY+t.ram_allocation:C.MEM_SETTING_KEY+C.RAM_ALLOCATION_ENUM.DEFAULT,s={name:C.PROCESS_DESCRIPTORS.HDB,script:C.LAUNCH_SERVICE_SCRIPTS.HDB,exec_mode:"cluster",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.HDB},merge_logs:!0,out_file:e,error_file:e,instances:ne.get(C.CONFIG_PARAMS.HTTP_THREADS),node_args:r,cwd:Mn};return He||(s.out_file=Ee,s.error_file=Ee),s}a(AN,"generateHDBServerConfig");function ON(){ar(),ne.initSync(),He=ne.get(C.HDB_SETTINGS_NAMES.LOG_TO_FILE),Ge=ne.get(C.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.CUSTOM_FUNCTIONS),t=fN.licenseSearch(),r=t.ram_allocation?C.MEM_SETTING_KEY+t.ram_allocation:C.MEM_SETTING_KEY+C.RAM_ALLOCATION_ENUM.DEFAULT,s={name:C.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS,script:C.LAUNCH_SERVICE_SCRIPTS.CUSTOM_FUNCTIONS,exec_mode:"cluster",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS},merge_logs:!0,out_file:e,error_file:e,instances:ne.get(C.CONFIG_PARAMS.HTTP_THREADS),node_args:r,cwd:Mn};return He||(s.out_file=Ee,s.error_file=Ee),s}a(ON,"generateCFServerConfig");function Q$(){ar(),ne.initSync(),He=ne.get(C.HDB_SETTINGS_NAMES.LOG_TO_FILE),Ge=ne.get(C.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=ne.get(C.CONFIG_PARAMS.ROOTPATH),t=Oe.join(e,"clustering",XE.NATS_CONFIG_FILES.HUB_SERVER),r=Oe.join(Ge,C.PROCESS_LOG_NAMES.CLUSTERING_HUB),s={name:C.PROCESS_DESCRIPTORS.CLUSTERING_HUB,script:mN,args:`-c ${t}`,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CLUSTERING_HUB},merge_logs:!0,out_file:r,error_file:r,instances:1};return He||(s.out_file=Ee,s.error_file=Ee),s}a(Q$,"generateNatsHubServerConfig");function W$(){ar(),ne.initSync(),He=ne.get(C.HDB_SETTINGS_NAMES.LOG_TO_FILE),Ge=ne.get(C.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=ne.get(C.CONFIG_PARAMS.ROOTPATH),t=Oe.join(e,"clustering",XE.NATS_CONFIG_FILES.LEAF_SERVER),r=Oe.join(Ge,C.PROCESS_LOG_NAMES.CLUSTERING_LEAF),s={name:C.PROCESS_DESCRIPTORS.CLUSTERING_LEAF,script:mN,args:`-c ${t}`,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CLUSTERING_LEAF},merge_logs:!0,out_file:r,error_file:r,instances:1};return He||(s.out_file=Ee,s.error_file=Ee),s}a(W$,"generateNatsLeafServerConfig");function J$(){ar(),ne.initSync();let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.CLUSTERING_INGEST_SERVICE),t={name:C.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE,script:C.LAUNCH_SERVICE_SCRIPTS.NATS_INGEST_SERVICE,exec_mode:"cluster",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Mn};return He||(t.out_file=Ee,t.error_file=Ee),t}a(J$,"generateNatsIngestServiceConfig");function Z$(){ar(),ne.initSync();let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.CLUSTERING_REPLY_SERVICE),t={name:C.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE,script:C.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE,exec_mode:"cluster",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Mn};return He||(t.out_file=Ee,t.error_file=Ee),t}a(Z$,"generateNatsReplyServiceConfig");function X$(){ar(),ne.initSync();let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.CLUSTERING_UPGRADE),t={name:C.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0,script:C.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Mn,autorestart:!1};return He||(t.out_file=Ee,t.error_file=Ee),t}a(X$,"generateClusteringUpgradeV4ServiceConfig");function z$(){ar();let e=Oe.join(Ge,C.PROCESS_LOG_NAMES.PM2),t={name:C.PROCESS_DESCRIPTORS.RESTART_HDB,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:C.PROCESS_DESCRIPTORS.RESTART_HDB},merge_logs:!0,out_file:e,error_file:e,instances:1,autorestart:!1,cwd:TN};return He||(t.out_file=Ee,t.error_file=Ee),{...t,script:K$}}a(z$,"generateRestart");function j$(e){ar();let t=Oe.join(Ge,C.PROCESS_LOG_NAMES.JOBS),r=Oe.join(Zc,"server/jobs"),s={name:`JOB-${e}`,exec_mode:"fork",env:{[C.PROCESS_NAME_ENV_PROP]:`JOB-${e}`},merge_logs:!0,out_file:t,error_file:t,instances:1,cwd:Mn,autorestart:!1};return He||(s.out_file=Ee,s.error_file=Ee),{...s,script:Oe.join(r,"jobProcess.js")}}a(j$,"generateJobConfig");function eY(){return{apps:[RN(),AN(),ON()]}}a(eY,"generateAllServiceConfigs");pN.exports={generateAllServiceConfigs:eY,generateIPCServerConfig:RN,generateHDBServerConfig:AN,generateCFServerConfig:ON,generateRestart:z$,generateNatsHubServerConfig:Q$,generateNatsLeafServerConfig:W$,generateNatsIngestServiceConfig:J$,generateNatsReplyServiceConfig:Z$,generateClusteringUpgradeV4ServiceConfig:X$,generateJobConfig:j$}});var $i=S((C3,MN)=>{"use strict";var P=T(),zc=b(),xi=ZE(),jc=ct(),tY=_e(),x=require("pm2"),rY=require("fs-extra"),gr=Xc(),Et=Y(),Ir=I(),sY=Xc(),nY=Ls(),iY=require("util"),gN=iY.promisify(require("child_process").exec),IN=require("path");MN.exports={start:Ms,stop:t_,reload:CN,restart:wN,list:jE,describe:r_,connect:or,kill:UN,startAllServices:SY,startService:e_,getUniqueServicesList:ed,restartAllServices:fY,stopAllServices:TY,isServiceRegistered:yN,reloadStopStart:zE,restartHdb:LN,deleteProcess:dY,configureLogRotate:AY,startClustering:DN,isHdbRestartRunning:hY,isClusteringRunning:pY,stopClustering:OY,reloadClustering:NY};var{PACKAGE_ROOT:aY}=T(),oY="2.7.0",bN=IN.join(aY,"node_modules/pm2/bin/pm2"),cY="Log rotate installed.",_Y="Error installing log rotate.",uY="Log rotate updated.",lY="Error updating log rotate.",EY="The number of HarperDB processes running is different from the settings value. To restart and update the number HarperDB processes running you must stop and then start HarperDB";function or(){return new Promise((e,t)=>{x.connect((r,s)=>{r&&t(r),e(s)})})}a(or,"connect");function Ms(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.start(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(Ms,"start");function t_(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.stop(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.delete(e,(i,o)=>{i&&(x.disconnect(),r(s)),x.disconnect(),t(o)})})})}a(t_,"stop");function CN(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.reload(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(CN,"reload");function wN(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.restart(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(wN,"restart");function dY(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.delete(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(dY,"deleteProcess");async function LN(){await Ms(sY.generateRestart())}a(LN,"restartHdb");async function hY(){let e=await jE();for(let t in e)if(e[t].name===P.PROCESS_DESCRIPTORS.RESTART_HDB)return!0;return!1}a(hY,"isHdbRestartRunning");function jE(){return new Promise(async(e,t)=>{try{await or()}catch(r){t(r)}x.list((r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(jE,"list");function r_(e){return new Promise(async(t,r)=>{try{await or()}catch(s){r(s)}x.describe(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(r_,"describe");function UN(){return new Promise(async(e,t)=>{try{await or()}catch(r){t(r)}x.killDaemon((r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(UN,"kill");async function SY(){try{await DN(),await Ms(gr.generateAllServiceConfigs())}catch(e){throw x.disconnect(),e}}a(SY,"startAllServices");async function e_(e){try{let t;switch(e=e.toLowerCase(),e){case P.PROCESS_DESCRIPTORS.IPC.toLowerCase():t=gr.generateIPCServerConfig();break;case P.PROCESS_DESCRIPTORS.HDB.toLowerCase():t=gr.generateHDBServerConfig();break;case P.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS.toLowerCase():t=gr.generateCFServerConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE.toLowerCase():t=gr.generateNatsIngestServiceConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE.toLowerCase():t=gr.generateNatsReplyServiceConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase():t=gr.generateNatsHubServerConfig(),await Ms(t),await xi.removeNatsConfig(e);return;case P.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase():t=gr.generateNatsLeafServerConfig(),await Ms(t),await xi.removeNatsConfig(e);return;case P.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0.toLowerCase():t=gr.generateClusteringUpgradeV4ServiceConfig();break;default:throw new Error(`Start service called with unknown service config: ${e}`)}await Ms(t)}catch(t){throw x.disconnect(),t}}a(e_,"startService");async function ed(){try{let e=await jE(),t={};for(let r=0,s=e.length;r<s;r++){let n=e[r];t[n.name]===void 0&&(t[n.name]={name:n.name,exec_mode:n.pm2_env.exec_mode})}return t}catch(e){throw x.disconnect(),e}}a(ed,"getUniqueServicesList");async function fY(e=[]){try{let t=!1,r=await ed();for(let s=0,n=Object.values(r).length;s<n;s++){let i=Object.values(r)[s],o=i.name;e.includes(o)||(i.exec_mode==="cluster_mode"?o===P.PROCESS_DESCRIPTORS.HDB?t=!0:await zE(o):await wN(o))}t&&await zE(P.PROCESS_DESCRIPTORS.HDB)}catch(t){throw x.disconnect(),t}}a(fY,"restartAllServices");async function TY(){try{let e=await ed();for(let t=0,r=Object.values(e).length;t<r;t++){let s=Object.values(e)[t];await t_(s.name)}if(await UN(),Et.get(P.CONFIG_PARAMS.OPERATIONSAPI_FOREGROUND)===!0){let t=(await rY.readFile(IN.join(Et.get(P.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),P.FOREGROUND_PID_FILE))).toString();try{process.kill(t,"SIGTERM")}catch(r){Ir.warn(`Error terminating foreground process: ${r}`)}}}catch(e){throw x.disconnect(),e}}a(TY,"stopAllServices");async function yN(e){return!zc.isEmptyOrZeroLength(await r_(e))}a(yN,"isServiceRegistered");async function zE(e){let t=e===P.PROCESS_DESCRIPTORS.HDB?Et.get(P.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES):Et.get(P.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES),r=await r_(e),s=zc.isEmptyOrZeroLength(r)?0:r.length;t!==s?e===P.PROCESS_DESCRIPTORS.HDB?Ir.error(EY):(await t_(e),await e_(e)):e===P.PROCESS_DESCRIPTORS.HDB?await LN():await CN(e)}a(zE,"reloadStopStart");function mY(){return new Promise(async(e,t)=>{try{await or()}catch(r){t(r)}x.stop(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE,(r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(mY,"stopLogrotate");async function RY(){let{stdout:e,stderr:t}=await gN(`${process.platform==="win32"?"node":""} ${bN} install pm2-logrotate@${oY}`);if(Ir.debug(`loadLogRotate stdout: ${e}`),t)throw Ir.error(_Y),t;Ir.info(cY)}a(RY,"installLogRotate");async function NN(){let e={max_size:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_MAX_SIZE),retain:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_RETAIN),compress:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_COMPRESS),dateFormat:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_DATE_FORMAT),rotateModule:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_ROTATE_MODULE),workerInterval:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_WORKER_INTERVAL),rotateInterval:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_ROTATE_INTERVAL),TZ:Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_TIMEZONE)},t="";for(let n in e)t+=`${process.platform==="win32"?"node":""} ${bN} set pm2-logrotate:${n} ${e[n]}`,n!=="TZ"&&(t+=" && ");let{stdout:r,stderr:s}=await gN(t);if(Ir.debug(`updateLogRotateConfig stdout: ${r}`),s)throw Ir.error(lY),s;Ir.info(uY)}a(NN,"updateLogRotateConfig");async function AY(){Et.initSync();let e=zc.autoCastBoolean(Et.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE)),t=await r_(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE),r,s=!1;if(zc.isEmptyOrZeroLength(t)||(s=!0,r=t[0].pm2_env.status),e&&!s){await RY(),await NN();return}if(e&&s){await Ms(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE),await NN();return}!e&&r===P.PM2_PROCESS_STATUSES.ONLINE&&await mY()}a(AY,"configureLogRotate");async function DN(){for(let t in P.CLUSTERING_PROCESSES){let r=P.CLUSTERING_PROCESSES[t];await e_(r)}await jc.createWorkQueueStream(tY.WORK_QUEUE_CONSUMER_NAMES),await jc.updateNodeNameLocalStreams();let e=await nY.getAllNodeRecords();for(let t=0,r=e.length;t<r;t++)if(e[t].system_info?.hdb_version===P.PRE_4_0_0_VERSION){Ir.info("Starting clustering upgrade 4.0.0 process"),await e_(P.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0);break}}a(DN,"startClustering");async function OY(){for(let e in P.CLUSTERING_PROCESSES){let t=P.CLUSTERING_PROCESSES[e];await t_(t)}}a(OY,"stopClustering");async function pY(){for(let e in P.CLUSTERING_PROCESSES){let t=P.CLUSTERING_PROCESSES[e];if(await yN(t)===!1)return!1}return!0}a(pY,"isClusteringRunning");async function NY(){await xi.generateNatsConfig(!0),await jc.reloadNATSHub(),await jc.reloadNATSLeaf(),await xi.removeNatsConfig(P.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase()),await xi.removeNatsConfig(P.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())}a(NY,"reloadClustering")});var id=S((w3,GN)=>{"use strict";var y=T(),K=I(),s_=b(),gY=tu(),td=ZE(),nd=ct(),IY=_e(),BN=require("minimist"),{handleHDBError:rd,hdb_errors:bY}=D(),Yi=Sr(),{HTTP_STATUS_CODES:sd}=bY,q,PN=`Restarting HarperDB. This may take up to ${y.RESTART_TIMEOUT_MS/1e3} seconds.`,Ps="HarperDB is currently restarting and must complete before another HarperDB restart can be initialized.",CY="Invalid service",wY="'service' is required",LY="Restarting all services",UY="Clustering is not enabled so cannot be restarted";GN.exports={stop:DY,restartProcesses:yY,restartService:vN};async function yY(){K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP);try{q===void 0&&(q=$i());let e=gY(Object.keys(y.CONFIG_PARAM_MAP),!0);s_.isEmptyOrZeroLength(Object.keys(e))||Yi.updateConfigValue(void 0,void 0,e,!0,!0);let t=Yi.getConfigFromFile(y.CONFIG_PARAMS.CLUSTERING_ENABLED),r=Yi.getConfigFromFile(y.CONFIG_PARAMS.CUSTOMFUNCTIONS_ENABLED),s=BN(process.argv);if(!s_.isEmpty(s.service)){if(typeof s.service!="string"){let c=`Restart service argument expected a string but received: ${s.service}`;return K.error(c),c}let o=s.service.split(",");for(let c of o){let _=c.toLowerCase();if(_===y.HDB_PROC_DESCRIPTOR.toLowerCase()&&await q.isHdbRestartRunning()===!0){K.notify(Ps),console.error(Ps);continue}if(y.PROCESS_DESCRIPTORS_VALIDATE[_]===void 0){console.error(`Restart received unrecognized service command argument: ${_}`),K.error(`Restart received unrecognized service command argument: ${_}`);continue}let u=y.PROCESS_DESCRIPTORS_VALIDATE[_];if(console.log(`Restarting ${u}`),K.trace(`Restarting ${u}`),u===y.PROCESS_DESCRIPTORS.PM2_LOGROTATE)await q.configureLogRotate();else if(_.toLowerCase().includes("clustering"))await Pn(_);else if(await q.isServiceRegistered(u))u===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS&&!r?(await q.stop(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Stopping ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`)):await vN({service:u});else if(u===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS)if(r)await q.startService(u),K.trace(`Starting ${u}`);else{let l=`${u} is not enabled in harperdb-config.yaml and cannot be restarted.`;K.error(l),console.log(l)}else await q.startService(u);K.notify(`${u} successfully restarted.`)}return}if(await q.isHdbRestartRunning()===!0)return K.notify(Ps),console.error(Ps),Ps;console.log(PN),t&&await HN();let n=await q.isServiceRegistered(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS);r&&!n&&(await q.startService(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Starting ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`));let i=[y.PROCESS_DESCRIPTORS.CLUSTERING_HUB,y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF,y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE,y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE];return!r&&n&&(i.push(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),await q.stop(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Stopping ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`)),await q.configureLogRotate(),K.notify(LY),await q.restartAllServices(i),PN}catch(e){let t=`There was an error restarting HarperDB. ${e}`;return K.error(t),t}}a(yY,"restartProcesses");async function vN(e){if(K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP),q===void 0&&(q=$i()),s_.isEmpty(e.service))throw rd(new Error,wY,sd.BAD_REQUEST,void 0,void 0,!0);let t=e.service.toLowerCase();if(y.PROCESS_DESCRIPTORS_VALIDATE[t]===void 0)throw rd(new Error,CY,sd.BAD_REQUEST,void 0,void 0,!0);let r=Yi.getConfigFromFile(y.CONFIG_PARAMS.CUSTOMFUNCTIONS_ENABLED),s=y.PROCESS_DESCRIPTORS_VALIDATE[t];if(s===y.PROCESS_DESCRIPTORS.HDB){if(await q.isHdbRestartRunning()===!0)return K.notify(Ps),Ps;await q.reloadStopStart(s)}else if(s===y.PROCESS_DESCRIPTORS.PM2_LOGROTATE)await q.configureLogRotate();else if(s.toLowerCase().includes("clustering"))await Pn(s);else if(s===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS||s===y.SERVICES.CUSTOM_FUNCTIONS){let i=await q.isServiceRegistered(s);if(r)i?(await q.reloadStopStart(s),K.trace(`Reloading ${s}`)):(await q.startService(s),K.trace(`Starting ${s}`));else if(!r&&i)await q.stop(s),K.trace(`Stopping ${s}`);else{let o=`${s} is not enabled in harperdb-config.yaml and cannot be restarted.`;throw K.error(o),rd(new Error,o,sd.BAD_REQUEST,void 0,void 0,!0)}}else await q.restart(s);let n=`Restarting ${s}`;return K.notify(n),n}a(vN,"restartService");async function DY(){K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP);try{q===void 0&&(q=$i());let e=BN(process.argv);if(s_.isEmpty(e.service))console.log("Stopping HarperDB."),await q.stopAllServices(),K.notify("HarperDB has stopped");else{if(typeof e.service!="string"){let r=`Stop service argument expected a string but received: ${e.service}`;K.error(r),console.log(r)}let t=e.service.split(",");for(let r of t){let s=r.toLowerCase();if(y.PROCESS_DESCRIPTORS_VALIDATE[s]===void 0){K.error(`Stop received unrecognized service command argument: ${s}`);continue}s==="clustering"?await q.stopClustering():await q.stop(y.PROCESS_DESCRIPTORS_VALIDATE[s]);let n=`${y.PROCESS_DESCRIPTORS_VALIDATE[s]} successfully stopped.`;K.notify(n),console.log(n)}}}catch(e){throw console.error(e),e}}a(DY,"stop");async function HN(){await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE),await nd.updateNodeNameLocalStreams(),await nd.closeConnection()}a(HN,"restartAllClusteringServices");async function Pn(e){e=y.PROCESS_DESCRIPTORS_VALIDATE[e.toLowerCase()];let t=Yi.getConfigFromFile(y.CONFIG_PARAMS.CLUSTERING_ENABLED),r=e==="clustering",s=e==="clustering config",n=r?void 0:await q.isServiceRegistered(e),i=r||s?await q.isClusteringRunning():void 0;switch(!0){case s:if(!i){K.error(UY);break}await q.reloadClustering();break;case(r&&i&&!t):await q.stopClustering();break;case(r&&!i&&t):await q.startClustering();break;case(r&&i&&t):await HN();break;case(r&&!i&&!t):K.error(`${e} is not enabled in harperdb-config.yaml and cannot be restarted.`);break;case(n&&!t):await q.stop(e),K.trace(`Stopping ${e}`);break;case(!n&&t):e!==y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE&&e!==y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE&&await td.generateNatsConfig(!0,e),await q.startService(e),K.trace(`Starting ${e}`),e===y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF&&await nd.createWorkQueueStream(IY.WORK_QUEUE_CONSUMER_NAMES);break;case(!n&&!t):K.error(`${e} is not enabled in harperdb-config.yaml and cannot be restarted.`);break;case(n&&t):e===y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE||e===y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE?await q.reload(e):(await td.generateNatsConfig(!0,e),await q.restart(e),await td.removeNatsConfig(e));break;default:K.error(`Error restarting ${e}`)}}a(Pn,"restartClustering")});var JN=S((U3,WN)=>{"use strict";var L3=require("lodash"),Xe=T(),{handleHDBError:qN,hdb_errors:MY}=D(),{HDB_ERROR_MSGS:PY,HTTP_STATUS_CODES:BY}=MY,ad=I();WN.exports={getRolePermissions:HY};var Bs=Object.create(null),vY=a(e=>({key:e,perms:{}}),"perms_template_obj"),xN=a((e=!1)=>({describe:e,tables:{}}),"schema_perms_template"),$N=a((e=!1,t=!1,r=!1,s=!1)=>({[Xe.PERMS_CRUD_ENUM.READ]:e,[Xe.PERMS_CRUD_ENUM.INSERT]:t,[Xe.PERMS_CRUD_ENUM.UPDATE]:r,[Xe.PERMS_CRUD_ENUM.DELETE]:s}),"permissions_template"),od=a((e=!1,t=!1,r=!1,s=!1,n=!1)=>({attribute_permissions:[],describe:e,...$N(t,r,s,n)}),"table_perms_template"),FN=a((e,t=$N())=>({attribute_name:e,describe:QN(t),[Ki]:t[Ki],[cd]:t[cd],[_d]:t[_d]}),"attr_perms_template"),VN=a((e,t=!1)=>({attribute_name:e,describe:t,[Ki]:t}),"timestamp_attr_perms_template"),{READ:Ki,INSERT:cd,UPDATE:_d}=Xe.PERMS_CRUD_ENUM,YN=Object.values(Xe.PERMS_CRUD_ENUM),KN=[Ki,cd,_d];function HY(e){let t;try{if(e.permission.super_user||e.permission.cluster_user)return e.permission;let r=Object.assign({},global.hdb_schema);delete r[Xe.SYSTEM_SCHEMA_NAME],t=e.role;let s=JSON.stringify([e.__updatedtime__,r]);if(Bs[t]&&Bs[t].key===s)return Bs[t].perms;let n=GY(e,r);return Bs[t]?Bs[t].key=s:Bs[t]=vY(s),Bs[t].perms=n,n}catch(r){if(!e[Xe.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]||e[Xe.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]<Xe.PERMS_UPDATE_RELEASE_TIMESTAMP){let s=`Role permissions for role '${t}' must be updated to align with new structure from the 2.2.0 release.`;throw ad.error(s),ad.debug(r),qN(new Error,PY.OUTDATED_PERMS_TRANSLATION_ERROR,BY.BAD_REQUEST)}else{let s=`There was an error while translating role permissions for role: ${t}.
 ${r.stack}`;throw ad.error(s),qN(new Error)}}}a(HY,"getRolePermissions");function GY(e,t){let r=Object.create(null);r.super_user=!1;let s=e.permission;r[Xe.SYSTEM_SCHEMA_NAME]=s[Xe.SYSTEM_SCHEMA_NAME],r.structure_user=s.structure_user;let n=Array.isArray(e.permission.structure_user)||e.permission.structure_user===!0?e.permission.structure_user:[];return Object.keys(t).forEach(i=>{if(n===!0||n.indexOf(i)>-1){r[i]=qY(t[i]);return}r[i]=xN(),s[i]?Object.keys(t[i]).forEach(o=>{if(s[i].tables[o]){let c=s[i].tables[o],_=t[i][o],u=FY(c,_);r[i].describe||YN.forEach(l=>{u[l]&&(r[i].describe=!0)}),r[i].tables[o]=u}else r[i].tables[o]=od()}):Object.keys(t[i]).forEach(o=>{r[i].tables[o]=od()})}),r}a(GY,"translateRolePermissions");function qY(e){let t=xN(!0);return Object.keys(e).forEach(r=>{t.tables[r]=od(!0,!0,!0,!0,!0)}),t}a(qY,"createStructureUserPermissions");function FY(e,t){let{attribute_permissions:r}=e;if(r.length>0){let n=Object.assign({},e);n.attribute_permissions=[];let i=r.reduce((u,l)=>{let{attribute_name:E}=l,d=l;return Xe.TIME_STAMP_NAMES.includes(E)&&(d=VN(E,l[Ki])),u[E]=d,u},{}),o=t[Xe.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_HASH_ATTRIBUTE_KEY],c=!!i[o],_=FN(o);return t.attributes.forEach(({attribute:u})=>{if(i[u]){let l=i[u];l.describe=QN(l),n.attribute_permissions.push(l),c||VY(l,_)}else if(u!==o){let l;Xe.TIME_STAMP_NAMES.includes(u)?l=VN(u):l=FN(u),n.attribute_permissions.push(l)}}),c||n.attribute_permissions.push(_),n.describe=kN(n),n}else return e.describe=kN(e),e}a(FY,"getTableAttrPerms");function kN(e){return YN.filter(t=>e[t]).length>0}a(kN,"getSchemaTableDescribePerm");function QN(e){return KN.filter(t=>e[t]).length>0}a(QN,"getAttributeDescribePerm");function VY(e,t){KN.forEach(r=>{e[r]&&!t[r]&&(t[r]=!0,t.describe=!0)})}a(VY,"checkForHashPerms")});var rg=S((y3,tg)=>{"use strict";var de=require("joi"),ZN=require("fs-extra"),XN=require("path"),Bn=he(),zN=Y(),jN=T(),eg=I(),{hdb_errors:kY}=D(),{HDB_ERROR_MSGS:ze}=kY,ts=/^[a-zA-Z0-9-_]+$/;tg.exports={getDropCustomFunctionValidator:$Y,setCustomFunctionValidator:YY,addCustomFunctionProjectValidator:KY,dropCustomFunctionProjectValidator:QY,packageCustomFunctionProjectValidator:WY,deployCustomFunctionProjectValidator:JY};function Qi(e,t,r){try{let s=zN.get(jN.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),n=XN.join(s,t);return ZN.existsSync(n)?e?t:r.message(ze.PROJECT_EXISTS):e?r.message(ze.NO_PROJECT):t}catch(s){return eg.error(s),r.message(ze.VALIDATION_ERR)}}a(Qi,"checkProjectExists");function xY(e,t,r,s){try{let n=zN.get(jN.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),i=XN.join(n,e,t,r+".js");return ZN.existsSync(i)?r:s.message(ze.NO_FILE)}catch(n){return eg.error(n),s.message(ze.VALIDATION_ERR)}}a(xY,"checkFileExists");function $Y(e){let t=de.object({project:de.string().pattern(ts).custom(Qi.bind(null,!0)).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME}),type:de.string().valid("helpers","routes").required(),file:de.string().pattern(ts).custom(xY.bind(null,e.project,e.type)).required().messages({"string.pattern.base":ze.BAD_FILE_NAME})});return Bn.validateBySchema(e,t)}a($Y,"getDropCustomFunctionValidator");function YY(e){let t=de.object({project:de.string().pattern(ts).custom(Qi.bind(null,!0)).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME}),type:de.string().valid("helpers","routes").required(),file:de.string().pattern(ts).required().messages({"string.pattern.base":ze.BAD_FILE_NAME}),function_content:de.string().required()});return Bn.validateBySchema(e,t)}a(YY,"setCustomFunctionValidator");function KY(e){let t=de.object({project:de.string().pattern(ts).custom(Qi.bind(null,!1)).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME})});return Bn.validateBySchema(e,t)}a(KY,"addCustomFunctionProjectValidator");function QY(e){let t=de.object({project:de.string().pattern(ts).custom(Qi.bind(null,!0)).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME})});return Bn.validateBySchema(e,t)}a(QY,"dropCustomFunctionProjectValidator");function WY(e){let t=de.object({project:de.string().pattern(ts).custom(Qi.bind(null,!0)).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME}),skip_node_modules:de.boolean()});return Bn.validateBySchema(e,t)}a(WY,"packageCustomFunctionProjectValidator");function JY(e){let t=de.object({project:de.string().pattern(ts).required().messages({"string.pattern.base":ze.BAD_PROJECT_NAME}),payload:de.string().required().messages({"string.pattern.base":ze.BAD_PACKAGE}),file:de.string().required().messages({"string.pattern.base":ze.BAD_FILE_PATH})});return Bn.validateBySchema(e,t)}a(JY,"deployCustomFunctionProjectValidator")});var ld=S((D3,ng)=>{"use strict";var me=require("fs-extra"),n_=require("fast-glob"),ie=require("path"),sg=require("tar-fs"),ZY=require("uuid").v4,Wi=require("normalize-path"),vs=rg(),Le=I(),At=T(),Ot=Y(),{PACKAGE_ROOT:XY}=T(),{handleHDBError:je,hdb_errors:zY}=D(),{HDB_ERROR_MSGS:rs,HTTP_STATUS_CODES:et}=zY,jY=ie.join(XY,"custom_function_template"),i_=ie.join(Ot.get(At.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),"tmp");function ud(){let e=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY);if(!(e==="true"||e===!0||e==="TRUE"))throw je(new Error,rs.NOT_ENABLED,et.BAD_REQUEST,void 0,void 0,!0)}a(ud,"isCFEnabled");function eK(){Le.trace("getting custom api status");let e={};try{e={is_enabled:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY),port:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY),directory:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY)}}catch(t){throw je(new Error,rs.FUNCTION_STATUS,et.INTERNAL_SERVER_ERROR,Le.ERR,t)}return e}a(eK,"customFunctionsStatus");function tK(){Le.trace("getting custom api endpoints");let e={},t=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY);try{n_.sync(Wi(`${t}/*`),{onlyDirectories:!0}).forEach(s=>{let n=s.split("/").pop();e[n]={routes:n_.sync(Wi(`${s}/routes/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),helpers:n_.sync(Wi(`${s}/helpers/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),static:me.existsSync(Wi(`${s}/static`))&&n_.sync(Wi(`${s}/static/**/*`)).length}})}catch(r){throw je(new Error,rs.GET_FUNCTIONS,et.INTERNAL_SERVER_ERROR,Le.ERR,r)}return e}a(tK,"getCustomFunctions");function rK(e){e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=vs.getDropCustomFunctionValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("getting custom api endpoint file content");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i}=e,o=ie.join(r,s,n,i+".js");try{return me.readFileSync(o,{encoding:"utf8"})}catch(c){throw je(new Error,rs.GET_FUNCTION,et.INTERNAL_SERVER_ERROR,Le.ERR,c)}}a(rK,"getCustomFunction");function sK(e){ud(),e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=vs.setCustomFunctionValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("setting custom function file content");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i,function_content:o}=e;try{return me.outputFileSync(ie.join(r,s,n,i+".js"),o),`Successfully updated custom function: ${i}.js`}catch(c){throw je(new Error,rs.SET_FUNCTION,et.INTERNAL_SERVER_ERROR,Le.ERR,c)}}a(sK,"setCustomFunction");function nK(e){e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=vs.getDropCustomFunctionValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("dropping custom function file");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i}=e;try{return me.unlinkSync(ie.join(r,s,n,i+".js")),`Successfully deleted custom function: ${i}.js`}catch(o){throw je(new Error,rs.DROP_FUNCTION,et.INTERNAL_SERVER_ERROR,Le.ERR,o)}}a(nK,"dropCustomFunction");function iK(e){ud(),e.project&&(e.project=ie.parse(e.project).name);let t=vs.addCustomFunctionProjectValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("adding custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e;try{let n=ie.join(r,s);return me.mkdirSync(n,{recursive:!0}),me.copySync(jY,n),`Successfully created custom function project: ${s}`}catch(n){throw je(new Error,rs.ADD_FUNCTION,et.INTERNAL_SERVER_ERROR,Le.ERR,n)}}a(iK,"addCustomFunctionProject");function aK(e){e.project&&(e.project=ie.parse(e.project).name);let t=vs.dropCustomFunctionProjectValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("dropping custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e;try{let n=ie.join(r,s);return me.rmSync(n,{recursive:!0}),`Successfully deleted project: ${s}`}catch(n){throw je(new Error,rs.DROP_FUNCTION_PROJECT,et.INTERNAL_SERVER_ERROR,Le.ERR,n)}}a(aK,"dropCustomFunctionProject");async function oK(e){e.project&&(e.project=ie.parse(e.project).name);let t=vs.packageCustomFunctionProjectValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("packaging custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e,n=ie.join(r,s),i=ZY();if(!me.existsSync(n)){let l=`Unable to locate custom function project: ${s}`;throw Le.error(l),l}me.ensureDirSync(i_);let c=ie.join(i_,`${i}.tar`),_={};(e.skip_node_modules===!0||e.skip_node_modules==="true")&&(_={ignore:l=>l.includes(ie.join(n,"node_modules"))}),sg.pack(n,_).pipe(me.createWriteStream(c)),await new Promise(l=>setTimeout(l,2e3));let u=me.readFileSync(c,{encoding:"base64"});return me.unlinkSync(c),{project:s,payload:u,file:c}}a(oK,"packageCustomFunctionProject");async function cK(e){ud(),e.project&&(e.project=ie.parse(e.project).name);let t=vs.deployCustomFunctionProjectValidator(e);if(t)throw je(t,t.message,et.BAD_REQUEST);Le.trace("deploying custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,payload:n,file:i}=e,o=ie.join(r,s);return me.existsSync(o)||me.mkdirSync(o,{recursive:!0}),me.existsSync(i_)||me.mkdirSync(i_),me.writeFileSync(i,n,{encoding:"base64"}),await new Promise(_=>setTimeout(_,2e3)),me.createReadStream(i).pipe(sg.extract(o)),me.unlinkSync(i),`Successfully deployed project: ${s}`}a(cK,"deployCustomFunctionProject");ng.exports={customFunctionsStatus:eK,getCustomFunctions:tK,getCustomFunction:rK,setCustomFunction:sK,dropCustomFunction:nK,addCustomFunctionProject:iK,dropCustomFunctionProject:aK,packageCustomFunctionProject:oK,deployCustomFunctionProject:cK}});var Ed=S((M3,ag)=>{"use strict";var cr=require("joi"),ig=he();ag.exports={readTransactionLogValidator:_K,deleteTransactionLogsBeforeValidator:uK};function _K(e){let t=cr.object({schema:cr.string().required(),table:cr.string().required(),from:cr.date().timestamp(),to:cr.date().timestamp(),limit:cr.number().min(1)});return ig.validateBySchema(e,t)}a(_K,"readTransactionLogValidator");function uK(e){let t=cr.object({schema:cr.string().required(),table:cr.string().required(),timestamp:cr.date().timestamp().required()});return ig.validateBySchema(e,t)}a(uK,"deleteTransactionLogsBeforeValidator")});var o_=S((P3,lg)=>{"use strict";var dd=T(),a_=ct(),og=b(),cg=Y(),_g=Vr(),{handleHDBError:vn,hdb_errors:lK}=D(),{HTTP_STATUS_CODES:Hn}=lK,{readTransactionLogValidator:EK,deleteTransactionLogsBeforeValidator:dK}=Ed(),ug="This operation relies on clustering and cannot run with it disable.",hK="Logs successfully deleted from transaction log.",SK="All logs successfully deleted from transaction log.";lg.exports={readTransactionLog:fK,deleteTransactionLogsBefore:TK};async function fK(e){let t=EK(e);if(t)throw vn(t,t.message,Hn.BAD_REQUEST,void 0,void 0,!0);if(!cg.get(dd.CONFIG_PARAMS.CLUSTERING_ENABLED))throw vn(new Error,ug,Hn.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s}=e,n=og.checkSchemaTableExist(r,s);if(n)throw vn(new Error,n,Hn.NOT_FOUND,void 0,void 0,!0);let i=_g.createNatsTableStreamName(r,s),o=await a_.viewStream(i,parseInt(e.from),e.limit),c=[];for(let _=0,u=o.length;_<u;_++){let l=o[_],E=Math.floor(l?.nats_timestamp/1e6);if(e.to&&E>e.to)break;let d={operation:l?.entry?.operation,user:l?.entry?.__origin?.user,timestamp:E,records:l?.entry?.records};l?.entry?.operation===dd.OPERATIONS_ENUM.DELETE&&(d.hash_values=l?.entry?.hash_values),c.push(d)}return c}a(fK,"readTransactionLog");async function TK(e){let t=dK(e);if(t)throw vn(t,t.message,Hn.BAD_REQUEST,void 0,void 0,!0);if(!cg.get(dd.CONFIG_PARAMS.CLUSTERING_ENABLED))throw vn(new Error,ug,Hn.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s,timestamp:n}=e,i=og.checkSchemaTableExist(r,s);if(i)throw vn(new Error,i,Hn.NOT_FOUND,void 0,void 0,!0);let o=_g.createNatsTableStreamName(r,s),{jsm:c}=await a_.getNATSReferences(),_=await a_.getStreamInfo(o),u=new Date(_.state.first_ts).getTime();if(n<=u)return`No transactions exist before: ${n}`;let l=hK,E,d=new Date(_.state.last_ts).getTime();return n>d?(E=_.state.last_seq+1,l=SK):E=(await a_.viewStream(o,parseInt(n),1))[0].nats_sequence,await c.streams.purge(o,{seq:E}),l}a(TK,"deleteTransactionLogsBefore")});var Sd=S((B3,Og)=>{"use strict";var c_=require("joi"),__=require("path"),Eg=require("fs-extra"),{exec:mK}=require("child_process"),RK=require("util"),dg=RK.promisify(mK),AK=T(),{handleHDBError:Gn,hdb_errors:OK}=D(),{HTTP_STATUS_CODES:qn}=OK,hg=Y(),pK=he(),u_=I();hg.initSync();var hd=hg.get(AK.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),Sg="npm install --omit=dev --json",NK=`${Sg} --dry-run`;Og.exports={installModules:gK,auditModules:IK};async function fg(e,t=void 0){let{stdout:r,stderr:s}=await dg(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(fg,"runCommand");async function gK(e){u_.info(`starting installModules for request: ${e}`);let t=Ag(e);if(t)throw Gn(t,t.message,qn.BAD_REQUEST);let{projects:r,dry_run:s}=e,n=s===!0?NK:Sg;await mg(),await Rg(r);let i={};for(let o=0,c=r.length;o<c;o++){let _=r[o];i[_]={npm_output:null,npm_error:null};let u=__.join(hd,_),l,E=null;try{let{stdout:d,stderr:h}=await dg(n,{cwd:u});l=d?d.replace(`
`,""):null,E=h?h.replace(`
`,""):null}catch(d){d.stderr?i[_].npm_error=Tg(d.stderr):i[_].npm_error=d.message;continue}try{i[_].npm_output=JSON.parse(l)}catch{i[_].npm_output=l}try{i[_].npm_error=JSON.parse(E)}catch{i[_].npm_error=E}}return u_.info(`finished installModules with response ${i}`),i}a(gK,"installModules");function Tg(e){let t='"error": {',r=e.indexOf('"error": {'),s=e.indexOf(`}
`);return r>-1&&s>-1?JSON.parse(e.substring(r+t.length-1,s+1)):e}a(Tg,"parseNPMStdErr");async function IK(e){u_.info(`starting auditModules for request: ${e}`);let t=Ag(e);if(t)throw Gn(t,t.message,qn.BAD_REQUEST);let{projects:r}=e;await mg(),await Rg(r);let s={};for(let n=0,i=r.length;n<i;n++){let o=r[n],c=__.join(hd,o);s[o]={npm_output:null,npm_error:null};try{let _=await fg("npm audit --json",c);s[o].npm_output=JSON.parse(_)}catch(_){s[o].npm_error=Tg(_.stderr)}}return u_.info(`finished auditModules with response ${s}`),s}a(IK,"auditModules");async function mg(){try{return await fg("npm -v"),!0}catch{throw Gn(new Error,"Unable to install project dependencies: npm is not installed on this instance of HarperDB.",qn.BAD_REQUEST,void 0,void 0,!0)}}a(mg,"checkNPMInstalled");async function Rg(e){if(!Array.isArray(e)||e.length===0)throw Gn(new Error,"projects argument must be an array with at least 1 element",qn.BAD_REQUEST,void 0,void 0,!0);let t=[],r=[];for(let s=0,n=e.length;s<n;s++){let i=e[s],o=__.join(hd,i.toString());if(!await Eg.pathExists(o)){t.push(i);continue}let _=__.join(o,"package.json");await Eg.pathExists(_)||r.push(i)}if(t.length>0)throw Gn(new Error,`Unable to install project dependencies: custom function projects '${t.join(",")}' does not exist.`,qn.BAD_REQUEST,void 0,void 0,!0);if(r.length>0)throw Gn(new Error,`Unable to install project dependencies: custom function projects '${r.join(",")}' do not have a package.json file.`,qn.BAD_REQUEST,void 0,void 0,!0)}a(Rg,"checkProjectPaths");function Ag(e){let t=c_.object({projects:c_.array().min(1).items(c_.string()).required(),dry_run:c_.boolean().default(!1)});return pK.validateBySchema(e,t)}a(Ag,"modulesValidator")});var Ng=S((v3,pg)=>{"use strict";var l_=class{constructor(t,r,s=[],n=[]){this.schema=t,this.table=r,this.required_table_permissions=s,this.required_attribute_permissions=n}};a(l_,"PermissionTableResponseObject");pg.exports=l_});var Ig=S((H3,gg)=>{"use strict";var E_=class{constructor(t,r=[]){this.attribute_name=t,this.required_permissions=r}};a(E_,"PermissionAttributeResponseObject");gg.exports=E_});var fd=S((G3,Cg)=>{"use strict";var bg=Ng(),bK=Ig(),{HDB_ERROR_MSGS:CK}=Ke(),d_=class{constructor(){this.error=CK.OP_AUTH_PERMS_ERROR,this.unauthorized_access={},this.invalid_schema_items=[]}handleUnauthorizedItem(t){return this.invalid_schema_items=[],this.unauthorized_access=[t],this}handleInvalidItem(t){return this.invalid_schema_items=[t],this.unauthorized_access=[],this}addInvalidItem(t,r,s){if(r&&s){let n=`${r}_${s}`;if(this.unauthorized_access[n])return}this.invalid_schema_items.push(t)}addUnauthorizedTable(t,r,s){let n=new bg(t,r,s),i=`${t}_${r}`;this.unauthorized_access[i]=n}addUnauthorizedAttributes(t,r,s,n){let i=[];t.forEach(c=>{let _=new bK(c,n[c]);i.push(_)});let o=`${r}_${s}`;if(this.unauthorized_access[o])this.unauthorized_access[o].required_attribute_permissions=i;else{let c=new bg(r,s,[],i);this.unauthorized_access[o]=c}}getPermsResponse(){let t=Object.values(this.unauthorized_access);return t.length>0||this.invalid_schema_items.length>0?(this.unauthorized_access=t,this):null}};a(d_,"PermissionResponseObject");Cg.exports=d_});var T_=S((q3,kg)=>{"use strict";var Td=Ut(),h_=mt(),Bt=tc(),Xi=fs(),md=Rs(),wK=rE(),zi=Wr(),S_=lE(),pe=I(),LK=hE(),UK=wc(),yK=HE(),DK=Dc(),MK=GE(),PK=VE(),Rd=$E(),br=b(),BK=Jp(),Ad=QE(),Ug=id(),Pt=T(),yg=JN(),vK=gc(),Dg=hc(),Mg=Sr(),Cr=ld(),HK=require("alasql"),Pg=o_(),Bg=Sd(),vg=fd(),{handleHDBError:dt,hdb_errors:Hg}=D(),{HDB_ERROR_MSGS:qe,HTTP_STATUS_CODES:Ji}=Hg,O=new Map,Gg="delete",ss="insert",_r="read",Hs="update",Zi="describe",wg=Xi.describeSchema.name,Lg=Xi.describeTable.name,qg={delete:!0,deleteRecord:!0,update:!0,updateData:!0,dropAttribute:!0,dropTable:!0,dropSchema:!0,upsert:!0,upsertData:!0},GK="catchup",qK="handleGetJob",FK="handleGetJobsByStartDate",f_={CSV_DATA_LOAD:"csvDataLoad",CSV_URL_LOAD:"csvURLLoad",CSV_FILE_LOAD:"csvFileLoad",IMPORT_FROM_S3:"importFromS3"},VK=[Bt.createTable.name,Bt.createAttribute.name,Bt.dropTable.name,Bt.dropAttribute.name],Fg={EXPORT_TO_S3:"export_to_s3",EXPORT_LOCAL:"export_local"},p=class{constructor(t,r){this.requires_su=t,this.perms=r}};a(p,"permission");O.set(Td.insert.name,new p(!1,[ss]));O.set(Td.update.name,new p(!1,[Hs]));O.set(Td.upsert.name,new p(!1,[ss,Hs]));O.set(h_.searchByConditions.name,new p(!1,[_r]));O.set(h_.searchByHash.name,new p(!1,[_r]));O.set(h_.searchByValue.name,new p(!1,[_r]));O.set(h_.search.name,new p(!1,[_r]));O.set(Bt.createSchema.name,new p(!0,[]));O.set(Bt.createTable.name,new p(!0,[]));O.set(Bt.createAttribute.name,new p(!1,[ss]));O.set(Bt.dropSchema.name,new p(!0,[]));O.set(Bt.dropTable.name,new p(!0,[]));O.set(Bt.dropAttribute.name,new p(!0,[]));O.set(Xi.describeSchema.name,new p(!1,[_r]));O.set(Xi.describeTable.name,new p(!1,[_r]));O.set(md.deleteRecord.name,new p(!1,[Gg]));O.set(zi.addUser.name,new p(!0,[]));O.set(zi.alterUser.name,new p(!0,[]));O.set(zi.dropUser.name,new p(!0,[]));O.set(zi.listUsersExternal.name,new p(!0,[]));O.set(S_.listRoles.name,new p(!0,[]));O.set(S_.addRole.name,new p(!0,[]));O.set(S_.alterRole.name,new p(!0,[]));O.set(S_.dropRole.name,new p(!0,[]));O.set(LK.name,new p(!0,[]));O.set(UK.name,new p(!0,[]));O.set(yK.name,new p(!0,[]));O.set(DK.name,new p(!0,[]));O.set(MK.name,new p(!0,[]));O.set(Rd.setRoutes.name,new p(!0,[]));O.set(Rd.getRoutes.name,new p(!0,[]));O.set(Rd.deleteRoutes.name,new p(!0,[]));O.set(Mg.setConfiguration.name,new p(!0,[]));O.set(PK.clusterStatus.name,new p(!0,[]));O.set(Ad.getFingerprint.name,new p(!0,[]));O.set(Ad.setLicense.name,new p(!0,[]));O.set(md.deleteFilesBefore.name,new p(!0,[]));O.set(md.deleteAuditLogsBefore.name,new p(!0,[]));O.set(Ug.restartProcesses.name,new p(!0,[]));O.set(Ug.restartService.name,new p(!0,[]));O.set(wK.name,new p(!0,[]));O.set(vK.systemInformation.name,new p(!0,[]));O.set(Mg.getConfiguration.name,new p(!0,[]));O.set(Pg.readTransactionLog.name,new p(!0,[]));O.set(Pg.deleteTransactionLogsBefore.name,new p(!0,[]));O.set(Bg.installModules.name,new p(!0,[]));O.set(Bg.auditModules.name,new p(!0,[]));O.set(Dg.createTokens.name,new p(!1,[]));O.set(Dg.refreshOperationToken.name,new p(!1,[]));O.set(Cr.customFunctionsStatus.name,new p(!0,[]));O.set(Cr.getCustomFunctions.name,new p(!0,[]));O.set(Cr.getCustomFunction.name,new p(!0,[]));O.set(Cr.setCustomFunction.name,new p(!0,[]));O.set(Cr.dropCustomFunction.name,new p(!0,[]));O.set(Cr.addCustomFunctionProject.name,new p(!0,[]));O.set(Cr.dropCustomFunctionProject.name,new p(!0,[]));O.set(Cr.packageCustomFunctionProject.name,new p(!0,[]));O.set(Cr.deployCustomFunctionProject.name,new p(!0,[]));O.set(Ad.getRegistrationInfo.name,new p(!1,[]));O.set(zi.userInfo.name,new p(!1,[]));O.set(Xi.describeAll.name,new p(!1,[]));O.set(qK,new p(!1,[]));O.set(FK,new p(!0,[]));O.set(GK,new p(!0,[]));O.set(f_.CSV_DATA_LOAD,new p(!1,[ss,Hs]));O.set(f_.CSV_URL_LOAD,new p(!1,[ss,Hs]));O.set(f_.CSV_FILE_LOAD,new p(!1,[ss,Hs]));O.set(f_.IMPORT_FROM_S3,new p(!1,[ss,Hs]));O.set(Fg.EXPORT_TO_S3,new p(!1,[_r]));O.set(Fg.EXPORT_LOCAL,new p(!1,[_r]));O.set(Pt.VALID_SQL_OPS_ENUM.DELETE,new p(!1,[Gg]));O.set(Pt.VALID_SQL_OPS_ENUM.SELECT,new p(!1,[_r]));O.set(Pt.VALID_SQL_OPS_ENUM.INSERT,new p(!1,[ss]));O.set(Pt.VALID_SQL_OPS_ENUM.UPDATE,new p(!1,[Hs]));kg.exports={verifyPerms:xK,verifyPermsAst:kK,verifyBulkLoadAttributePerms:YK};function kK(e,t,r){if(br.isEmptyOrZeroLength(e))throw pe.info("verify_perms_ast has an empty user parameter"),dt(new Error);if(br.isEmptyOrZeroLength(t))throw pe.info("verify_perms_ast has an empty user parameter"),dt(new Error);if(br.isEmptyOrZeroLength(r))throw pe.info("verify_perms_ast has a null operation parameter"),dt(new Error);try{let s=new vg,n=new BK(e),i=n.getSchemas(),o=new Map;if((!i||i.length===0)&&n.affected_attributes&&n.affected_attributes.size>0)throw pe.info("No schemas defined in verifyPermsAst(), will not continue."),dt(new Error);let c=!!t.role.permission.super_user,_=i.includes("system");if(_&&qg[r])throw dt(new Error,qe.DROP_SYSTEM,Ji.FORBIDDEN);if(c&&!_)return null;let u=yg.getRolePermissions(t.role);t.role.permission=u,!c&&e instanceof HK.yy.Select&&(e=n.updateAttributeWildcardsForRolePerms(u));for(let E=0;E<i.length;E++){let d=n.getTablesBySchemaName(i[E]);d&&o.set(i[E],d)}let l=Vg(t,r,o,s);return l||(o.forEach((E,d)=>{for(let h=0;h<E.length;h++){let m=n.getAttributesBySchemaTableName(d,E[h]),R=pd(t.role.permission,d,E[h]);Od(m,R,r,E[h],d,s)}}),s.getPermsResponse())}catch(s){throw dt(s)}}a(kK,"verifyPermsAst");function xK(e,t){if(e===null||t===null||e.hdb_user===void 0||e.hdb_user===null)throw pe.info("null required parameter in verifyPerms"),dt(new Error,qe.DEFAULT_INVALID_REQUEST,Ji.BAD_REQUEST);let r;t instanceof Function?r=t.name:r=t;let s=e.action,n=e.schema,i=e.table,o=new Map;n&&i&&o.set(n,[i]);let c=new vg;if(br.isEmptyOrZeroLength(e.hdb_user.role)||br.isEmptyOrZeroLength(e.hdb_user.role.permission))return pe.info(`User ${e.hdb_user.username} has no role or permissions.  Please assign the user a valid role.`),c.handleUnauthorizedItem(qe.USER_HAS_NO_PERMS(e.hdb_user.username));let _=!!e.hdb_user.role.permission.super_user,u=e.hdb_user.role.permission.structure_user,l=o.has(Pt.SYSTEM_SCHEMA_NAME)||n===Pt.SYSTEM_SCHEMA_NAME;if(l&&qg[r])throw dt(new Error,qe.DROP_SYSTEM,Ji.FORBIDDEN);if(_&&!l||u===!0&&(r===Bt.createSchema.name||r===Bt.dropSchema.name))return null;if(VK.indexOf(r)>=0&&(u===!0||Array.isArray(u)))return u===!0||u.indexOf(n)>=0?null:c.handleUnauthorizedItem(`User does not have access to perform '${e.operation}' against schema '${n}'`);let E=yg.getRolePermissions(e.hdb_user.role);if(e.hdb_user.role.permission=E,r===wg||r===Lg){if(n===Pt.SYSTEM_SCHEMA_NAME)return c.handleUnauthorizedItem(qe.SCHEMA_PERM_ERROR(n));if(!E.super_user){if(r===wg&&(!E[n]||!E[n][Zi]))return c.handleInvalidItem(qe.SCHEMA_NOT_FOUND(n));if(r===Lg&&(!E[n]||!E[n].tables[i]||!E[n].tables[i][Zi]))return c.handleInvalidItem(qe.TABLE_NOT_FOUND(n,i))}}let d=Vg(e.hdb_user,r,o,c,s);if(d)return d;if(O.get(r)&&O.get(r).perms.length===0)return null;if(!_&&e.get_attributes&&Pt.SEARCH_WILDCARDS.includes(e.get_attributes[0])){let R=[],w=E[n].tables[i];w[Pt.PERMS_CRUD_ENUM.READ]&&(w.attribute_permissions.length>0?w.attribute_permissions.filter(B=>B[Pt.PERMS_CRUD_ENUM.READ]).forEach(B=>{R.push(B.attribute_name)}):R=global.hdb_schema[n][i].attributes.map(L=>L.attribute),e.get_attributes=R)}let h=$K(e),m=pd(e.hdb_user.role.permission,n,i);return Od(h,m,r,i,n,c,s),c.getPermsResponse()}a(xK,"verifyPerms");function Vg(e,t,r,s,n){if(br.arrayHasEmptyValues([e,t,r]))throw pe.info("hasPermissions has an invalid parameter"),dt(new Error);let i=r.has("system"),o=e.role.permission;if(o.super_user&&!i)return null;if(!O.get(t))throw pe.info(`operation ${t} not found.`),dt(new Error,qe.OP_NOT_FOUND(t),Ji.BAD_REQUEST);if(O.get(t)&&O.get(t).requires_su)return pe.info(`operation ${t} requires SU permissions.`),s.handleUnauthorizedItem(qe.OP_IS_SU_ONLY(t));let c=r.keys();for(let _ of c){try{if(_&&!o[_]||o[_][Zi]===!1){s.addInvalidItem(qe.SCHEMA_NOT_FOUND(_));continue}}catch{s.addInvalidItem(qe.SCHEMA_NOT_FOUND(_));continue}let u=r.get(_);for(let l of u){let E=o[_].tables[l];if(!E||E[Zi]===!1)s.addInvalidItem(qe.TABLE_NOT_FOUND(_,l));else try{let d=[],h=O.get(t).perms;!br.isEmpty(n)&&h.includes(n)&&(h=[n]);for(let m=0;m<h.length;m++){let R=h[m],w=E[R];(w==null||w===!1)&&(pe.info(`Required ${R} permission not found for ${t} ${n?`${n} `:""}operation in role ${e.role.id}`),d.push(R))}d.length>0&&s.addUnauthorizedTable(_,l,d)}catch(d){let h=qe.UNKNOWN_OP_AUTH_ERROR(t,_,l);throw pe.error(h),pe.error(d),dt(Hg.CHECK_LOGS_WRAPPER(h))}}}return r.size<2?s.getPermsResponse():null}a(Vg,"hasPermissions");function Od(e,t,r,s,n,i,o){if(!e||!t)throw pe.info("no attributes specified in checkAttributePerms."),dt(new Error);let c=O.get(r).perms;if(!c||c==="")throw pe.info(`no permissions found for ${r} in checkAttributePerms().`),dt(new Error);if(br.isEmptyOrZeroLength(t))return pe.info("No role permissions set (this is OK)."),null;o&&c.includes(o)&&(c=[o]);let _={};for(let l of e){let E=t.get(l);if(E){if(E[Zi]===!1){i.addInvalidItem(qe.ATTR_NOT_FOUND(n,s,l),n,s);continue}if(c)for(let d of c){if(Pt.TIME_STAMP_NAMES.includes(E.attribute_name)&&d!==_r)throw dt(new Error,qe.SYSTEM_TIMESTAMP_PERMS_ERR,Ji.FORBIDDEN);E[d]===!1&&(_[E.attribute_name]?_[E.attribute_name].push(d):_[E.attribute_name]=[d])}}else i.addInvalidItem(qe.ATTR_NOT_FOUND(n,s,l),n,s)}let u=Object.keys(_);u.length>0&&i.addUnauthorizedAttributes(u,n,s,_)}a(Od,"checkAttributePerms");function $K(e){let t=new Set;try{if(e.action)return t;if(e.operation===Pt.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS&&e.conditions.forEach(r=>{t.add(r.search_attribute)}),e&&e.search_attribute&&t.add(e.search_attribute),!e.records||e.records.length===0){if(!e.get_attributes||!e.get_attributes.length===0)return t;for(let r=0;r<e.get_attributes.length;r++)t.add(e.get_attributes[r])}else for(let r=0;r<e.records.length;r++){let s=Object.keys(e.records[r]);for(let n=0;n<s.length;n++)t.add(s[n])}}catch(r){pe.info(r)}return t}a($K,"getRecordAttributes");function pd(e,t,r){let s=new Map;if(br.isEmpty(e))return pe.info("no hdb_user specified in getAttributePermissions"),s;if(e.super_user||!t||!r)return s;try{e[t].tables[r].attribute_permissions.forEach(n=>{s.has(n.attribute_name)||s.set(n.attribute_name,n)})}catch{pe.info(`No attribute permissions found for schema ${t} and table ${r}.`)}return s}a(pd,"getAttributePermissions");function YK(e,t,r,s,n,i,o){let c=new Set(i),_=pd(e,s,n);Od(c,_,t,n,s,o,r)}a(YK,"verifyBulkLoadAttributePerms")});var R_=S((F3,Qg)=>{"use strict";Qg.exports={evaluateSQL:aQ,processAST:Kg,convertSQLToAST:Yg,checkASTPermissions:$g};var xg=Ut(),Id=require("util"),KK=Id.callbackify(xg.insert),QK=mt().search,WK=qA().update,JK=Id.callbackify(WK),ZK=VA().convertDelete,ns=require("alasql"),XK=T_(),ea=I(),zK=Lo(),jK=b(),ji=T(),{hdb_errors:eQ,handleHDBError:Nd}=D(),{HTTP_STATUS_CODES:gd}=eQ,tQ=Ns();function rQ(e,t,r){return Promise.all([tQ.postOperationHandler(e,t,r),xg.flush(e)])}a(rQ,"postWrite");var sQ=Id.callbackify(rQ);zK(ns);var nQ=403,iQ="There was a problem performing this insert. Please check the logs and try again.",m_=class{constructor(){this.ast=void 0,this.variant=void 0,this.permissions_checked=!1}};a(m_,"ParsedSQLObject");function aQ(e,t){let r=e.parsed_sql_object;if(!r){r=Yg(e.sql);let s,n=r.ast.statements[0];if(n instanceof ns.yy.Insert?s=n.into.databaseid:n instanceof ns.yy.Select?s=n.from?n.from[0].databaseid:null:n instanceof ns.yy.Update||n instanceof ns.yy.Delete?s=n.table.databaseid:ea.error("AST in evaluateSQL is not a valid SQL type."),!(n instanceof ns.yy.Select)&&jK.isEmptyOrZeroLength(s))return t("No schema specified",null)}Kg(e,r,(s,n)=>{if(s)return t(s);t(null,n)})}a(aQ,"evaluateSQL");function $g(e,t){let r;try{r=XK.verifyPermsAst(t.ast.statements[0],e.hdb_user,t.variant),t.permissions_checked=!0}catch(s){throw s}return r||null}a($g,"checkASTPermissions");function Yg(e){let t=new m_;if(!e)throw Nd(new Error,"The 'sql' parameter is missing from the request body",gd.BAD_REQUEST);try{let r=e.trim(),s=ns.parse(r),n=r.split(" ")[0].toLowerCase();t.ast=s,t.variant=n}catch(r){let s=r.message.split(`
`);throw s[1]?Nd(r,`Invalid SQL at: ${s[1]}. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.`,gd.BAD_REQUEST):Nd(r,"We had trouble parsing your request. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.",gd.BAD_REQUEST)}return t}a(Yg,"convertSQLToAST");function Kg(e,t,r){try{let s=oQ;if(!e.bypass_auth&&!t.permissions_checked){let i=$g(e,t);if(i&&i.length>0)return r(nQ,i)}let n={statement:t.ast.statements[0],hdb_user:e.hdb_user};switch(t.variant){case ji.VALID_SQL_OPS_ENUM.SELECT:s=QK,n=t.ast.statements[0];break;case ji.VALID_SQL_OPS_ENUM.INSERT:s=cQ;break;case ji.VALID_SQL_OPS_ENUM.UPDATE:s=JK;break;case ji.VALID_SQL_OPS_ENUM.DELETE:s=ZK;break;default:throw new Error(`unsupported SQL type ${t.variant} in SQL: ${e}`)}s(n,(i,o)=>{if(i){r(i);return}r(null,o)})}catch(s){return r(s)}}a(Kg,"processAST");function oQ(e,t){ea.info(e),t("unknown sql statement")}a(oQ,"nullFunction");function cQ({statement:e,hdb_user:t},r){let s=e.into,n={schema:s.databaseid,table:s.tableid,operation:"insert",hdb_user:t},i=e.columns.map(o=>o.columnid);try{n.records=_Q(i,e.values)}catch(o){return r(o)}KK(n,(o,c)=>{if(o)return r(o);sQ(n,c,_=>{_&&ea.error(_)});try{delete c.new_attributes,delete c.txn_time}catch(_){ea.error(`Error delete new_attributes from insert response: ${_}`)}r(null,c)})}a(cQ,"convertInsert");function _Q(e,t){try{return t.map(r=>{if(e.length!==r.length)throw"number of values do not match number of columns in insert";let s={};return r.forEach((n,i)=>{if(n.columnid)throw"cannot use a column in insert value";"value"in n?s[e[i]]=n.value:s[e[i]]=ns.compile(`SELECT ${n.toString()} AS [${ji.FUNC_VAL}] FROM ?`)}),s})}catch(r){throw ea.error(r),new Error(iQ)}}a(_Q,"createDataObjects")});var Cd=S((V3,zg)=>{var g_=require("clone"),I_=he(),uQ=b(),N_=T(),lQ=I(),A_=require("fs"),{hdb_errors:EQ,handleHDBError:ta}=D(),{HDB_ERROR_MSGS:dQ,HTTP_STATUS_CODES:O_}=EQ,{common_validators:p_}=Tr(),Wg=1e9,bd=" is required",hQ=["insert","update","upsert"],b_={schema:{presence:!0,format:p_.schema_format,length:p_.schema_length},table:{presence:!0,format:p_.schema_format,length:p_.schema_length},action:{inclusion:{within:hQ,message:"is required and must be either insert, update, or upsert"}},file_path:{},csv_url:{url:{allowLocal:!0}},data:{}},{AWS_ACCESS_KEY:SQ,AWS_SECRET:fQ,AWS_BUCKET:TQ,AWS_FILE_KEY:mQ}=N_.S3_BUCKET_AUTH_KEYS,RQ={s3:{presence:!0},[`s3.${SQ}`]:{presence:!0,type:"String"},[`s3.${fQ}`]:{presence:!0,type:"String"},[`s3.${TQ}`]:{presence:!0,type:"String"},[`s3.${mQ}`]:{presence:!0,type:"String",hasValidFileExt:[".csv",".json"]}},Jg=g_(b_);Jg.data.presence={message:bd};var Zg=g_(b_);Zg.file_path.presence={message:bd};var AQ=Object.assign(g_(b_),RQ),Xg=g_(b_);Xg.csv_url.presence={message:bd};function OQ(e){let t=I_.validateObject(e,Jg);return C_(e,t)}a(OQ,"dataObject");function pQ(e){let t=I_.validateObject(e,Xg);return C_(e,t)}a(pQ,"urlObject");function NQ(e){let t=I_.validateObject(e,Zg);return C_(e,t)}a(NQ,"fileObject");function gQ(e){let t=I_.validateObject(e,AQ);return C_(e,t)}a(gQ,"s3FileObject");function C_(e,t){if(!t){let r=uQ.checkGlobalSchemaTable(e.schema,e.table);if(r)return ta(new Error,r,O_.BAD_REQUEST);if(e.operation===N_.OPERATIONS_ENUM.CSV_FILE_LOAD){try{A_.accessSync(e.file_path,A_.constants.R_OK|A_.constants.F_OK)}catch(s){return s.code===N_.NODE_ERROR_CODES.ENOENT?ta(s,`No such file or directory ${s.path}`,O_.BAD_REQUEST):s.code===N_.NODE_ERROR_CODES.EACCES?ta(s,`Permission denied ${s.path}`,O_.BAD_REQUEST):ta(s)}try{let s=A_.statSync(e.file_path).size;if(s>Wg)return ta(new Error,dQ.MAX_FILE_SIZE_ERR(s,Wg),O_.BAD_REQUEST)}catch(s){lQ.error(s),console.error(s)}}}return t}a(C_,"postValidateChecks");zg.exports={dataObject:OQ,urlObject:pQ,fileObject:NQ,s3FileObject:gQ}});var L_=S((k3,jg)=>{"use strict";var ra=I(),w_=T();async function IQ(e,t,r,s=[]){if(!e||typeof e!="function")throw new Error("Invalid function parameter");let n;try{return n=await e(t),r&&await r(t,n,s),t.operation===w_.OPERATIONS_ENUM.INSERT||t.operation===w_.OPERATIONS_ENUM.UPDATE||t.operation===w_.OPERATIONS_ENUM.UPSERT?(delete n.new_attributes,delete n.txn_time):t.operation===w_.OPERATIONS_ENUM.DELETE&&delete n.txn_time,n}catch(i){throw i.message&&typeof i.message=="string"&&i.message.includes("already exists")?(ra.info(i.message),i):i.http_resp_msg?(ra.error(`Error calling operation: ${e.name}`),ra.error(i.http_resp_msg),i):(ra.error(`Error calling operation: ${e.name}`),ra.error(i),i)}}a(IQ,"callOperationFunctionAsAwait");jg.exports={callOperationFunctionAsAwait:IQ}});var wd=S((x3,tI)=>{"use strict";var bQ=require("aws-sdk/clients/s3");tI.exports={getFileStreamFromS3:CQ,getS3AuthObj:eI};function CQ(e){let{s3:t}=e,r={Bucket:t.bucket,Key:t.key};return eI(t.aws_access_key_id,t.aws_secret_access_key).getObject(r).createReadStream()}a(CQ,"getFileStreamFromS3");function eI(e,t){return new bQ({accessKeyId:e,secretAccessKey:t})}a(eI,"getS3AuthObj")});var sI=S(($3,rI)=>{"use strict";var U_=class{constructor(t,r,s,n,i,o,c=null){this.op=t,this.action=r,this.schema=s,this.table=n,this.file_path=i,this.file_type=o,this.role_perms=c}};a(U_,"BulkLoadFileObject");var y_=class{constructor(t,r,s,n){this.action=t,this.schema=r,this.table=s,this.data=n}};a(y_,"BulkLoadDataObject");rI.exports={BulkLoadFileObject:U_,BulkLoadDataObject:y_}});var Md=S((Y3,AI)=>{"use strict";var D_=Ut(),B_=Cd(),wQ=require("needle"),pt=T(),LQ=_e(),sa=b(),{handleHDBError:ae,hdb_errors:EI}=D(),{HTTP_STATUS_CODES:Fe,HDB_ERROR_MSGS:Ne,CHECK_LOGS_WRAPPER:Fs}=EI,qs=I(),M_=require("papaparse");sa.promisifyPapaParse();var Jt=require("fs-extra"),UQ=require("path"),{chain:nI}=require("stream-chain"),iI=require("stream-json/streamers/StreamArray"),aI=require("stream-json/utils/Batch"),oI=require("stream-chain/utils/comp"),{finished:cI}=require("stream"),Ld=Y(),yQ=Ns(),dI=L_(),DQ=wd(),{BulkLoadFileObject:Ud,BulkLoadDataObject:MQ}=sI(),yd=fd(),{verifyBulkLoadAttributePerms:hI}=T_(),PQ=Wl(),BQ=ct(),vQ=Vr(),_I="No records parsed from csv file.",Gs=`${Ld.get("HDB_ROOT")}/tmp`,{schema_regex:HQ}=Tr(),uI=1024*1024*5,lI=5e3,GQ={"text/csv":!0,"application/octet-stream":!0,"text/plain":!0,"application/vnd.ms-excel":!0};AI.exports={csvDataLoad:qQ,csvURLLoad:FQ,csvFileLoad:VQ,importFromS3:kQ};async function qQ(e,t=[]){let r=B_.dataObject(e);if(r)throw ae(r,r.message,Fe.BAD_REQUEST,void 0,void 0,!0);let s={};try{let n=M_.parse(e.data,{header:!0,skipEmptyLines:!0,dynamicTyping:!0}),i=new yd;e.hdb_user&&e.hdb_user.role&&e.hdb_user.role.permission&&e.hdb_user.role.permission.super_user!==!0&&hI(e.hdb_user.role.permission,this.job_operation_function.name,e.action,e.schema,e.table,n.meta.fields,i);let o=i.getPermsResponse();if(o)throw ae(new Error,o,Fe.BAD_REQUEST,void 0,void 0,!0);let c=new MQ(e.action,e.schema,e.table,n.data);return s=await dI.callOperationFunctionAsAwait(TI,c,mI.bind(null,n.meta.fields),t),s.message===_I?_I:RI(s.records,s.number_written)}catch(n){throw Vs(n)}}a(qQ,"csvDataLoad");async function FQ(e){let t=B_.urlObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r=`${Date.now()}.csv`,s=`${Gs}/${r}`;try{await xQ(e.csv_url,r)}catch(n){throw qs.error(Ne.DOWNLOAD_FILE_ERR(r)+" - "+n),ae(n,Fs(Ne.DOWNLOAD_FILE_ERR(r)))}try{let n=new Ud(this.job_operation_function.name,e.action,e.schema,e.table,s,pt.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission),i=await Dd(n);return await P_(s),i}catch(n){throw await P_(s),Vs(n)}}a(FQ,"csvURLLoad");async function VQ(e){let t=B_.fileObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r=new Ud(this.job_operation_function.name,e.action,e.schema,e.table,e.file_path,pt.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission);try{return await Dd(r)}catch(s){throw Vs(s)}}a(VQ,"csvFileLoad");async function kQ(e){let t=B_.s3FileObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r;try{let s=UQ.extname(e.s3.key),n=`${Date.now()}${s}`;r=`${Gs}/${n}`;let i=new Ud(this.job_operation_function.name,e.action,e.schema,e.table,r,s,e.hdb_user.role.permission);await $Q(n,e);let o=await Dd(i);return await P_(r),o}catch(s){throw await P_(r),Vs(s)}}a(kQ,"importFromS3");async function xQ(e,t){let r;try{r=await wQ("get",e)}catch(s){let n=`Error downloading CSV file from ${e}, status code: ${s.statusCode}. Check the log for more information.`;throw ae(s,n,s.statusCode,pt.LOG_LEVELS.ERROR,"Error downloading CSV file - "+s)}KQ(r,e),await YQ(t,r.raw)}a(xQ,"downloadCSVFile");async function $Q(e,t){try{let r=`${Gs}/${e}`;await Jt.mkdirp(Gs),await Jt.writeFile(`${Gs}/${e}`,"",{flag:"a+"});let s=await Jt.createWriteStream(r),n=DQ.getFileStreamFromS3(t);await new Promise((i,o)=>{n.on("error",function(c){o(c)}),n.pipe(s).on("error",function(c){o(c)}).on("close",function(){qs.info(`${t.s3.key} successfully downloaded to ${r}`),i()})})}catch(r){throw qs.error(Ne.S3_DOWNLOAD_ERR+" - "+r),ae(r,Fs(Ne.S3_DOWNLOAD_ERR))}}a($Q,"downloadFileFromS3");async function YQ(e,t){try{await Jt.mkdirp(Gs),await Jt.writeFile(`${Gs}/${e}`,t)}catch(r){throw qs.error(Ne.WRITE_TEMP_FILE_ERR),ae(r,Fs(Ne.DEFAULT_BULK_LOAD_ERR))}}a(YQ,"writeFileToTempFolder");async function P_(e){if(e)try{await Jt.access(e),await Jt.unlink(e)}catch{qs.warn(`could not delete temp csv file at ${e}, file does not exist`)}}a(P_,"deleteTempFile");function KQ(e,t){if(e.statusCode!==EI.HTTP_STATUS_CODES.OK)throw ae(new Error,`CSV Load failed from URL: ${t}, status code: ${e.statusCode}, message: ${e.statusMessage}`,Fe.BAD_REQUEST);if(!GQ[e.headers["content-type"]])throw ae(new Error,`CSV Load failed from URL: ${t}, unsupported content type: ${e.headers["content-type"]}`,Fe.BAD_REQUEST);if(!e.raw)throw ae(new Error,`CSV Load failed from URL: ${t}, no csv found at url`,Fe.BAD_REQUEST)}a(KQ,"validateURLResponse");async function Dd(e){try{let t;switch(e.file_type){case pt.VALID_S3_FILE_TYPES.CSV:t=await QQ(e);break;case pt.VALID_S3_FILE_TYPES.JSON:t=await WQ(e);break;default:throw ae(new Error,Ne.DEFAULT_BULK_LOAD_ERR,Fe.BAD_REQUEST,pt.LOG_LEVELS.ERROR,Ne.INVALID_FILE_EXT_ERR(e))}return RI(t.records,t.number_written)}catch(t){throw Vs(t)}}a(Dd,"fileLoad");async function SI(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;n&&n.pause();let o={operation:e.action,schema:e.schema,table:e.table,records:i};try{let{attributes:c}=await D_.validation(o);e.role_perms&&e.role_perms.super_user!==!0&&hI(e.role_perms,e.op,e.action,e.schema,e.table,c,t),n&&n.resume()}catch(c){let _=ae(c);r(_)}}a(SI,"validateChunk");async function fI(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;sa.autoCastJSONDeep(i),n&&n.pause();let o=s.meta?s.meta.fields:null;if(o)i.forEach(c=>{!sa.isEmpty(c)&&!sa.isEmpty(c.__parsed_extra)&&delete c.__parsed_extra});else{let c=new Set;i.forEach(_=>{Object.keys(_).forEach(u=>c.add(u))}),o=[...c]}try{let c={schema:e.schema,table:e.table,action:e.action,data:i},_=await dI.callOperationFunctionAsAwait(TI,c,mI.bind(null,o));t.records+=_.records,t.number_written+=_.number_written,n&&n.resume()}catch(c){let _=ae(c,Fs(Ne.INSERT_CSV_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.INSERT_CSV_ERR+" - "+c);r(_)}}a(fI,"insertChunk");async function QQ(e){let t={records:0,number_written:0};try{let r=new yd,s=Jt.createReadStream(e.file_path,{highWaterMark:uI});s.setEncoding("utf8"),await M_.parsePromise(s,SI.bind(null,e,r));let n=r.getPermsResponse();if(n)throw ae(new Error,n,Fe.BAD_REQUEST);return s=Jt.createReadStream(e.file_path,{highWaterMark:uI}),s.setEncoding("utf8"),await M_.parsePromise(s,fI.bind(null,e,t)),s.destroy(),t}catch(r){throw ae(r,Fs(Ne.PAPA_PARSE_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.PAPA_PARSE_ERR+r)}}a(QQ,"callPapaParse");async function WQ(e){let t={records:0,number_written:0},r=a(s=>{throw s},"throwErr");try{let s=new yd,n=nI([Jt.createReadStream(e.file_path,{encoding:"utf-8"}),iI.withParser(),c=>c.value,new aI({batchSize:lI}),oI(async c=>{await SI(e,s,r,c)})]);await new Promise((c,_)=>{cI(n,u=>{u?_(u):c()}),n.resume()});let i=s.getPermsResponse();if(i)throw ae(new Error,i,Fe.BAD_REQUEST);let o=nI([Jt.createReadStream(e.file_path,{encoding:"utf-8"}),iI.withParser(),c=>c.value,new aI({batchSize:lI}),oI(async c=>{await fI(e,t,r,c)})]);return await new Promise((c,_)=>{cI(o,u=>{u?_(u):c()}),o.resume()}),t}catch(s){throw ae(s,Fs(Ne.INSERT_JSON_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.INSERT_JSON_ERR+s)}}a(WQ,"insertJson");async function TI(e){let t={};try{e.data&&e.data.length>0&&JQ(e.data[0])?t=await ZQ(e.data,e.schema,e.table,e.action):(t.message="No records parsed from csv file.",qs.info(t.message))}catch(r){throw Vs(r)}return t}a(TI,"callBulkFileLoad");function JQ(e){let t=Object.keys(e);for(let r of t)if(!HQ.test(r))throw new Error(`Invalid column name '${r}', cancelling load operation`);return!0}a(JQ,"validateColumnNames");async function ZQ(e,t,r,s){s||(s="insert");let n={operation:s,schema:t,table:r,records:e},i;switch(s){case"insert":i=D_.insert;break;case"update":i=D_.update;break;case"upsert":i=D_.upsert;break;default:throw ae(new Error,Ne.INVALID_ACTION_PARAM_ERR(s),Fe.BAD_REQUEST,pt.LOG_LEVELS.ERROR,Ne.INVALID_ACTION_PARAM_ERR(s))}try{let o=await i(n),c;switch(s){case"insert":c=o.inserted_hashes;break;case"update":c=o.update_hashes;break;case"upsert":c=o.upserted_hashes;break;default:break}if(Array.isArray(o.skipped_hashes)&&o.skipped_hashes.length>0){let l=global.hdb_schema[t][r].hash_attribute,E=e.length;for(;E--;)o.skipped_hashes.indexOf(e[E][l])>=0&&e.splice(E,1)}let _=sa.isEmptyOrZeroLength(c)?0:c.length;return{records:e.length,number_written:_,new_attributes:o.new_attributes}}catch(o){throw Vs(o)}}a(ZQ,"bulkFileLoad");async function mI(e,t,r,s=[]){try{if(t.data.length===0||!Ld.get(pt.CONFIG_PARAMS.CLUSTERING_ENABLED))return;let n=M_.unparse(t.data,{header:!0,skipEmptyLines:!0,columns:e}),i;t.hdb_user&&t.hdb_user.username&&(i=t.hdb_user.username);let o={operation:"csv_data_load",action:t.action?t.action:"insert",schema:t.schema,table:t.table,data:n,__origin:new PQ(r.txn_time,i,Ld.get(pt.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY))};await BQ.publishToStream(`${LQ.SUBJECT_PREFIXES.TXN}.${t.schema}.${t.table}`,vQ.createNatsTableStreamName(t.schema,t.table),[o],s),await yQ.sendAttributeTransaction(r,t,s),delete r.new_attributes}catch(n){qs.error(n)}}a(mI,"postCSVLoadFunction");function RI(e,t){return`successfully loaded ${t} of ${e} records`}a(RI,"buildResponseMsg");function Vs(e){return ae(e,Fs(Ne.DEFAULT_BULK_LOAD_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.DEFAULT_BULK_LOAD_ERR+" - "+e)}a(Vs,"buildTopLevelErrMsg")});var Bd=S((K3,wI)=>{"use strict";var NI=mt(),XQ=R_(),zQ=wd(),{AsyncParser:jQ,Transform:eW}=require("json2csv"),na=require("stream"),tW=require("events"),vt=b(),Pd=require("fs-extra"),rW=require("path"),tt=I(),{promisify:v_}=require("util"),ia=b(),{handleHDBError:ge,hdb_errors:sW}=D(),{HDB_ERROR_MSGS:Nt,HTTP_STATUS_CODES:Ie}=sW,OI=["search_by_value","search_by_hash","sql"],pI=["json","csv"],gI="json",II="csv",nW="Successfully exported JSON locally.",iW="Successfully exported CSV locally.",aW=1e3,oW=1e3,cW=v_(NI.searchByHash),_W=v_(NI.searchByValue),uW=v_(XQ.evaluateSQL),lW=v_(na.finished);wI.exports={export_to_s3:SW,export_local:EW};async function EW(e){tt.trace(`export_local request to path: ${e.path}, filename: ${e.filename}, format: ${e.format}`);let t=bI(e);if(!vt.isEmpty(t))throw tt.error(t),ge(new Error,t,Ie.BAD_REQUEST,void 0,void 0,!0);if(vt.isEmpty(e.path))throw tt.error(Nt.MISSING_VALUE("path")),ge(new Error,Nt.MISSING_VALUE("path"),Ie.BAD_REQUEST,void 0,void 0,!0);let r=(vt.isEmpty(e.filename)?new Date().getTime():e.filename)+"."+e.format;e.path.endsWith(rW.sep)&&(e.path=e.path.substring(0,e.path.length-1));let s=vt.buildFolderPath(e.path,r);try{await dW(e.path);let n=await CI(e);return await hW(s,e.format,n)}catch(n){throw tt.error(n),new Error(n)}}a(EW,"export_local");async function dW(e){if(tt.trace("in confirmPath"),vt.isEmptyOrZeroLength(e))throw ge(new Error,`Invalid path: ${e}`,Ie.BAD_REQUEST,void 0,void 0,!0);let t;try{t=await Pd.stat(e)}catch(r){let s;throw r.code==="ENOENT"?s=`path '${e}' does not exist`:r.code==="EACCES"?s=`access to path '${e}' is denied`:s=r.message,tt.error(s),ge(new Error,s,Ie.BAD_REQUEST,void 0,void 0,!0)}if(!t.isDirectory()){let r=`path '${e}' is not a directory, please supply a valid folder path`;throw tt.error(r),ge(new Error,r,Ie.BAD_REQUEST,void 0,void 0,!0)}return!0}a(dW,"confirmPath");async function hW(e,t,r){if(tt.trace("in saveToLocal"),ia.isEmptyOrZeroLength(e))throw ge(new Error,Nt.INVALID_VALUE("file_path"),Ie.BAD_REQUEST,void 0,void 0,!0);if(ia.isEmptyOrZeroLength(t))throw ge(new Error,Nt.INVALID_VALUE("Source format"),Ie.BAD_REQUEST,void 0,void 0,!0);if(ia.isEmpty(r))throw ge(new Error,Nt.NOT_FOUND("Data"),Ie.BAD_REQUEST,void 0,void 0,!0);if(t===gI){let s=Pd.createWriteStream(e),n=r.length;s.write("[");let i="";for await(let[o,c]of r.entries())i+=o===n-1?JSON.stringify(c):JSON.stringify(c)+",",o!==0&&o%oW===0&&(s.write(i)||await tW.once(s,"drain"),i="");return i.length!==0&&s.write(i),s.write("]"),s.end(),await lW(s),nW}else if(t===II){let s=Pd.createWriteStream(e),n=na.Readable.from(r),i={},o={objectMode:!0};return await new jQ(i,o).fromInput(n).toOutput(s).promise(!1),iW}throw ge(new Error,Nt.INVALID_VALUE("format"),Ie.BAD_REQUEST)}a(hW,"saveToLocal");async function SW(e){if(!e.s3||Object.keys(e.s3).length===0)throw ge(new Error,Nt.MISSING_VALUE("S3 object"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.aws_access_key_id))throw ge(new Error,Nt.MISSING_VALUE("aws_access_key_id"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.aws_secret_access_key))throw ge(new Error,Nt.MISSING_VALUE("aws_secret_access_key"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.bucket))throw ge(new Error,Nt.MISSING_VALUE("bucket"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.key))throw ge(new Error,Nt.MISSING_VALUE("key"),Ie.BAD_REQUEST);let t=bI(e);if(!vt.isEmpty(t))throw ge(new Error,t,Ie.BAD_REQUEST);tt.trace(`called export_to_s3 to bucket: ${e.s3.bucket} and query ${e.search_operation.sql}`);let r;try{r=await CI(e)}catch(c){throw tt.error(c),c}let s,n=zQ.getS3AuthObj(e.s3.aws_access_key_id,e.s3.aws_secret_access_key),i,o=new na.PassThrough;if(e.format===II){i=e.s3.key+".csv";let c=na.Readable.from(r),_={},u={objectMode:!0},l=new eW(_,u);l.on("error",E=>{throw E}),c.pipe(l).pipe(o)}else if(e.format===gI){i=e.s3.key+".json";let c=new na.Readable;c.pipe(o),c.on("error",l=>{throw l}),c.push("[");let _=r.length,u="";for(let[l,E]of r.entries())u+=l===_-1?JSON.stringify(E):JSON.stringify(E)+",",l!==0&&l%aW===0&&(c.push(u),u="");u.length!==0&&c.push(u),c.push("]"),c.push(null)}else throw ge(new Error,Nt.INVALID_VALUE("format"),Ie.BAD_REQUEST);try{s=await n.upload({Bucket:e.s3.bucket,Key:i,Body:o}).promise()}catch(c){throw tt.error(c),c}return s}a(SW,"export_to_s3");function bI(e){if(tt.trace("in exportCoreValidation"),vt.isEmpty(e.format))return"format missing";if(pI.indexOf(e.format)<0)return`format invalid. must be one of the following values: ${pI.join(", ")}`;let t=e.search_operation.operation;if(vt.isEmpty(t))return"search_operation.operation missing";if(OI.indexOf(t)<0)return`search_operation.operation must be one of the following values: ${OI.join(", ")}`}a(bI,"exportCoreValidation");async function CI(e){tt.trace("in getRecords");let t,r;if(ia.isEmpty(e.search_operation)||ia.isEmptyOrZeroLength(e.search_operation.operation))throw ge(new Error,Nt.INVALID_VALUE("Search operation"),Ie.BAD_REQUEST);switch(e.search_operation.operation){case"search_by_value":t=_W;break;case"search_by_hash":t=cW;break;case"sql":t=uW;break;default:throw r=`Operation ${e.search_operation.operation} is not support by export.`,tt.error(r),ge(new Error,r,Ie.BAD_REQUEST)}e.search_operation.hdb_user=e.hdb_user;try{return t(e.search_operation)}catch(s){throw tt.error(s),s}}a(CI,"getRecords")});var UI=S((Q3,LI)=>{"use strict";var H_=class{constructor(t,r){this.operation="sql",this.sql=t,this.hdb_user=r}};a(H_,"SqlSearchObject");LI.exports=H_});var MI=S((W3,DI)=>{"use strict";var fW=T(),yI=require("moment"),TW=require("uuid").v4,G_=class{constructor(){this.id=TW(),this.type=void 0,this.start_datetime=yI().valueOf(),this.created_datetime=yI().valueOf(),this.end_datetime=void 0,this.status=fW.JOB_STATUS_ENUM.CREATED,this.message=void 0,this.user=void 0,this.request=void 0}};a(G_,"JobObject");DI.exports=G_});var Hd=S((J3,qI)=>{"use strict";var mW=require("uuid").v4,vI=Ut(),HI=mt(),RW=Kt(),AW=ds(),OW=UI(),oe=T(),pW=MI(),NW=fE(),Ht=I(),gW=ei(),Fn=b(),{promisify:vd}=require("util"),ks=require("moment"),IW=R_(),q_=Cd(),PI=Al(),{deleteTransactionLogsBeforeValidator:bW}=Ed(),{handleHDBError:CW,hdb_errors:wW}=D(),{HTTP_STATUS_CODES:LW}=wW,BI=vd(HI.searchByValue),UW=vd(HI.searchByHash),yW=vI.insert,DW=vd(IW.evaluateSQL),MW=vI.update;qI.exports={addJob:vW,updateJob:GW,handleGetJob:PW,handleGetJobsByStartDate:BW,getJobById:GI};async function PW(e){try{let t=await GI(e.id);return Fn.isEmptyOrZeroLength(t)||(t[0].request!==void 0&&delete t[0].request,delete t[0].__createdtime__,delete t[0].__updatedtime__),t}catch(t){let r=`There was an error getting job: ${t}`;throw Ht.error(r),new Error(r)}}a(PW,"handleGetJob");async function BW(e){try{let t=await HW(e);if(Ht.trace(`Searching for jobs from ${e.from_date} to ${e.to_date}`),t&&t.length>0)for(let r of t)r.start_datetime&&(r.start_datetime_converted=ks(r.start_datetime)),r.end_datetime&&(r.end_datetime_converted=ks(r.end_datetime)),r.request!==void 0&&delete r.request,delete r.__createdtime__,delete r.__updatedtime__;return t}catch(t){let r=`There was an error searching jobs by date: ${t}`;throw Ht.error(r),new Error(r)}}a(BW,"handleGetJobsByStartDate");async function vW(e){let t={message:"",error:"",success:!1,createdJob:void 0};if(!e||Object.keys(e).length===0||Fn.isEmptyOrZeroLength(e.operation)){let l="job parameter is invalid";return Ht.info(l),t.error=l,t}if(!oe.JOB_TYPE_ENUM[e.operation])return Ht.info(`invalid job type specified: ${e.operation}.`),t;let r=e.operation,s;switch(r){case oe.OPERATIONS_ENUM.CSV_FILE_LOAD:s=q_.fileObject(e);break;case oe.OPERATIONS_ENUM.CSV_URL_LOAD:s=q_.urlObject(e);break;case oe.OPERATIONS_ENUM.CSV_DATA_LOAD:s=q_.dataObject(e);break;case oe.OPERATIONS_ENUM.IMPORT_FROM_S3:s=q_.s3FileObject(e);break;case oe.OPERATIONS_ENUM.DELETE_FILES_BEFORE:case oe.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE:s=PI(e,"date");break;case oe.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE:s=PI(e,"timestamp");break;case oe.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE:s=bW(e);break;default:break}if(s)throw CW(s,s.message,LW.BAD_REQUEST,void 0,void 0,!0);let n=new pW;n.type=e.operation===oe.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE?oe.OPERATIONS_ENUM.DELETE_FILES_BEFORE:e.operation,n.type=e.operation,n.user=e.hdb_user.username;let i=new RW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",n.id,"id",["id"]),o;try{o=await BI(i)}catch(l){let E=`There was an error inserting a new job: ${l}`;return Ht.error(E),t}let c=Array.isArray(o)?o:Object.keys(o);if(c&&c.length>0){n.id=mW();try{o=await BI(i)}catch(l){let E=`There was an error inserting a new job: ${l}`;return Ht.error(E),t}if(c=Array.isArray(o)?o:Object.keys(o),c&&c.length>0)return Ht.error("Error creating a job, could not find a unique job id."),t}n.request=e;let _=new gW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",[n]),u;try{u=await yW(_)}catch(l){return Ht.error(`There was an error inserting a job for job type: ${e.operation} -- ${l}`),t.success=!1,t}if(u.inserted_hashes.length===0)t.message=`Had a problem creating a job with type ${n.operation} and id ${n.id}`;else{let l=`Created a job with type ${n.type} and id ${n.id}`;t.message=l,t.createdJob=n,t.success=!0,Ht.trace(l)}return t}a(vW,"addJob");async function HW(e){let t=ks(e.from_date,ks.ISO_8601),r=ks(e.to_date,ks.ISO_8601);if(!t.isValid())throw new Error("Invalid 'from' date, must be in ISO-8601 format (YYYY-MM-DD).");if(!r.isValid())throw new Error("Invalid 'to' date, must be in ISO-8601 format (YYYY-MM-DD)");let s=`select * from system.hdb_job where start_datetime > '${t.valueOf()}' and start_datetime < '${r.valueOf()}'`,n=new OW(s,e.hdb_user);try{return await DW(n)}catch(i){throw Ht.error(`there was a problem searching for jobs from date ${e.from_date} to date ${e.to_date} ${i}`),new Error("there was an error searching for jobs.  Please check the log for details.")}}a(HW,"getJobsInDateRange");async function GI(e){if(Fn.isEmptyOrZeroLength(e))return Fn.errorizeMessage("Invalid job ID specified.");let t=new AW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e],["*"]);try{return await UW(t)}catch(r){let s=`There was an error searching for a job by id: ${e} ${r}`;return Ht.error(s),Fn.errorizeMessage("there was an error searching for jobs.  Please check the log for details.")}}a(GI,"getJobById");async function GW(e){if(Object.keys(e).length===0)throw new Error("invalid job object passed to updateJob");if(Fn.isEmptyOrZeroLength(e.id))throw new Error("invalid ID passed to updateJob");(e.status===oe.JOB_STATUS_ENUM.COMPLETE||e.status===oe.JOB_STATUS_ENUM.ERROR)&&(e.end_datetime=ks().valueOf());let t=new NW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e]),r;try{r=await MW(t)}catch(s){throw new Error(s)}return r}a(GW,"updateJob")});var YI=S((Z3,$I)=>{"use strict";var FI=b(),gt=T(),qW=require("moment"),F_=Md(),V_=I(),VI=Hd(),kI=Bd(),xI=Rs(),FW=Xc(),VW=$i(),kW=o_(),k_=class{constructor(t,r){this.job=t,this.json=r}};a(k_,"RunnerMessage");async function xW(e){if(!e||Object.keys(e).length===0)throw new Error("Empty runner passed to parseMessage");if(!e.json||Object.keys(e.json).length===0)throw new Error("Empty JSON passed to parseMessage");if(!e.job||Object.keys(e.job).length===0)throw new Error("Empty job passed to parseMessage");if(FI.isEmptyOrZeroLength(e.json.operation))throw new Error("Invalid operation");if(FI.isEmptyOrZeroLength(e.job.id))throw new Error("Empty job id specified");switch(e.json.operation){case gt.JOB_TYPE_ENUM.csv_file_load:await wr(e,F_.csvFileLoad);break;case gt.JOB_TYPE_ENUM.csv_url_load:await wr(e,F_.csvURLLoad);break;case gt.JOB_TYPE_ENUM.csv_data_load:await wr(e,F_.csvDataLoad);break;case gt.JOB_TYPE_ENUM.import_from_s3:await wr(e,F_.importFromS3);break;case gt.JOB_TYPE_ENUM.empty_trash:break;case gt.JOB_TYPE_ENUM.export_local:await wr(e,kI.export_local);break;case gt.JOB_TYPE_ENUM.export_to_s3:await wr(e,kI.export_to_s3);break;case gt.JOB_TYPE_ENUM.delete_files_before:case gt.JOB_TYPE_ENUM.delete_records_before:await wr(e,xI.deleteFilesBefore);break;case gt.JOB_TYPE_ENUM.delete_audit_logs_before:await wr(e,xI.deleteAuditLogsBefore);break;case gt.JOB_TYPE_ENUM.delete_transaction_logs_before:await wr(e,kW.deleteTransactionLogsBefore);break;default:return`Invalid operation ${e.json.operation} specified`}}a(xW,"parseMessage");async function wr(e,t){try{e.job.status=gt.JOB_STATUS_ENUM.IN_PROGRESS,e.job.start_datetime=qW().valueOf(),await VI.updateJob(e.job),await $W(e.job.id)}catch(r){let s=r.message!==void 0?r.message:r;typeof s=="string"?(s=`There was an error running ${t.name} job with id ${e.job.id} - ${s}`,r.message=s):V_.error(`There was an error running ${t.name} job with id ${e.job.id}`),V_.error(s),e.job.message=s,e.job.status=gt.JOB_STATUS_ENUM.ERROR;try{await VI.updateJob(e.job)}catch(n){throw V_.error(`Unable to update job with id ${e.job.id}`),n}throw r}}a(wr,"runJob");async function $W(e){let t=FW.generateJobConfig(e);V_.trace("launching job process:",e),await VW.start(t)}a($W,"launchJobProcess");$I.exports={parseMessage:xW,RunnerMessage:k_}});var QI=S((X3,KI)=>{"use strict";var x_=class{constructor(t,r=void 0){this.operation_function=t,this.job_operation_function=r}};a(x_,"OperationFunctionObject");KI.exports=x_});var ab=S((z3,ib)=>{"use strict";var K_=mt(),Vd=R_(),$_=Md(),Vn=tc(),Gd=fs(),oa=Rs(),YW=rE(),aa=Wr(),Y_=lE(),Lr=ld(),Ve=I(),KW=hE(),QW=wc(),WW=HE(),JW=Dc(),ZW=GE(),XW=VE(),qd=$E(),WI=Bd(),zW=T_(),kd=Hd(),A=T(),{hdb_errors:_a,handleHDBError:ca}=D(),{HTTP_STATUS_CODES:JI}=_a,Fd=QE(),ZI=id(),Q_=require("util"),xs=Ut(),jW=xr(),e1=gc(),sb=Ns(),XI=YI(),zI=hc(),jI=Sr(),eb=o_(),tb=Sd(),t1=L_(),r1=Q_.promisify(K_.searchByHash),s1=Q_.promisify(K_.searchByValue),n1=Q_.promisify(K_.search),i1=Q_.promisify(Vd.evaluateSQL),a1={[A.OPERATIONS_ENUM.CREATE_ATTRIBUTE]:!0,[A.OPERATIONS_ENUM.CREATE_TABLE]:!0,[A.OPERATIONS_ENUM.CREATE_SCHEMA]:!0,[A.OPERATIONS_ENUM.DROP_ATTRIBUTE]:!0,[A.OPERATIONS_ENUM.DROP_TABLE]:!0,[A.OPERATIONS_ENUM.DROP_SCHEMA]:!0},N=QI();function o1(e,t,r){return Promise.all([sb.postOperationHandler(e,t,r),e.table?xs.flush(e):null])}a(o1,"postWrite");async function c1(e,t){try{if(e.body.operation!=="read_log"&&(Ve.log_level===A.LOG_LEVELS.INFO||Ve.log_level===A.LOG_LEVELS.DEBUG||Ve.log_level===A.LOG_LEVELS.TRACE)){let{hdb_user:s,hdb_auth_header:n,password:i,...o}=e.body;Ve.info(o)}}catch(s){Ve.error(s)}let r=A.CLUSTER_OPERATIONS[e.body.operation]===void 0?null:o1;try{let s=await t1.callOperationFunctionAsAwait(t,e.body,r);if(typeof s!="object"&&(s={message:s}),s instanceof Error)throw s;return a1[e.body.operation]&&jW.setSchemaDataToGlobal(n=>{n&&Ve.error(n)}),s}catch(s){throw Ve.info(s),s}}a(c1,"processLocalTransaction");var rb=l1();ib.exports={chooseOperation:_1,getOperationFunction:nb,processLocalTransaction:c1};function _1(e){let t;try{t=nb(e)}catch(n){throw Ve.error(`Error when selecting operation function - ${n}`),n}let{operation_function:r,job_operation_function:s}=t;try{if(e.operation==="sql"||e.search_operation&&e.search_operation.operation==="sql"){let n=e.operation==="sql"?e.sql:e.search_operation.sql,i=Vd.convertSQLToAST(n);if(e.parsed_sql_object=i,!e.bypass_auth){let o=Vd.checkASTPermissions(e,i);if(o)throw Ve.error(`${JI.FORBIDDEN} from operation ${e.search_operation}`),ca(new Error,o,_a.HTTP_STATUS_CODES.FORBIDDEN)}}else if(!e.bypass_auth&&e.operation!==A.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS){let n=s===void 0?r:s,i=e.search_operation?e.search_operation:e;i.hdb_user||(i.hdb_user=e.hdb_user);let o=zW.verifyPerms(i,n);if(o)throw Ve.error(`${JI.FORBIDDEN} from operation ${e.operation}`),ca(new Error,o,_a.HTTP_STATUS_CODES.FORBIDDEN)}}catch(n){throw ca(n,"There was an error when trying to choose an operation path")}return r}a(_1,"chooseOperation");function nb(e){if(Ve.trace(`getOperationFunction with operation: ${e.operation}`),rb.has(e.operation))return rb.get(e.operation);throw ca(new Error,_a.HDB_ERROR_MSGS.OP_NOT_FOUND(e.operation),_a.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}a(nb,"getOperationFunction");async function u1(e){Ve.trace("In serverUtils.catchup");let t=e.transaction,r=t.channel.split(":"),s=r[0],n=r[1];for(let i of t.transactions)try{i.schema=s,i.table=n,i[A.CLUSTERING_FLAG]=!0;let o;switch(i.operation){case A.OPERATIONS_ENUM.INSERT:o=await xs.insert(i);break;case A.OPERATIONS_ENUM.UPDATE:o=await xs.update(i);break;case A.OPERATIONS_ENUM.UPSERT:o=await xs.upsert(i);break;case A.OPERATIONS_ENUM.DELETE:o=await oa.deleteRecord(i);break;default:Ve.warn("invalid operation in catchup");break}await sb.postOperationHandler(i,o,e)}catch(o){Ve.info("Invalid operation in transaction"),Ve.error(o)}}a(u1,"catchup");async function ur(e){let t,r;try{r=await kd.addJob(e),t=r.createdJob;let s=new XI.RunnerMessage(t,e);return await XI.parseMessage(s),`Starting job with id ${t.id}`}catch(s){let n=`There was an error executing job: ${s.http_resp_msg?s.http_resp_msg:s}`;throw Ve.error(n),ca(s,n)}}a(ur,"executeJob");function l1(){let e=new Map;return e.set(A.OPERATIONS_ENUM.INSERT,new N(xs.insert)),e.set(A.OPERATIONS_ENUM.UPDATE,new N(xs.update)),e.set(A.OPERATIONS_ENUM.UPSERT,new N(xs.upsert)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS,new N(K_.searchByConditions)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_HASH,new N(r1)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_VALUE,new N(s1)),e.set(A.OPERATIONS_ENUM.SEARCH,new N(n1)),e.set(A.OPERATIONS_ENUM.SQL,new N(i1)),e.set(A.OPERATIONS_ENUM.CSV_DATA_LOAD,new N(ur,$_.csvDataLoad)),e.set(A.OPERATIONS_ENUM.CSV_FILE_LOAD,new N(ur,$_.csvFileLoad)),e.set(A.OPERATIONS_ENUM.CSV_URL_LOAD,new N(ur,$_.csvURLLoad)),e.set(A.OPERATIONS_ENUM.IMPORT_FROM_S3,new N(ur,$_.importFromS3)),e.set(A.OPERATIONS_ENUM.CREATE_SCHEMA,new N(Vn.createSchema)),e.set(A.OPERATIONS_ENUM.CREATE_TABLE,new N(Vn.createTable)),e.set(A.OPERATIONS_ENUM.CREATE_ATTRIBUTE,new N(Vn.createAttribute)),e.set(A.OPERATIONS_ENUM.DROP_SCHEMA,new N(Vn.dropSchema)),e.set(A.OPERATIONS_ENUM.DROP_TABLE,new N(Vn.dropTable)),e.set(A.OPERATIONS_ENUM.DROP_ATTRIBUTE,new N(Vn.dropAttribute)),e.set(A.OPERATIONS_ENUM.DESCRIBE_SCHEMA,new N(Gd.describeSchema)),e.set(A.OPERATIONS_ENUM.DESCRIBE_TABLE,new N(Gd.describeTable)),e.set(A.OPERATIONS_ENUM.DESCRIBE_ALL,new N(Gd.describeAll)),e.set(A.OPERATIONS_ENUM.DELETE,new N(oa.deleteRecord)),e.set(A.OPERATIONS_ENUM.ADD_USER,new N(aa.addUser)),e.set(A.OPERATIONS_ENUM.ALTER_USER,new N(aa.alterUser)),e.set(A.OPERATIONS_ENUM.DROP_USER,new N(aa.dropUser)),e.set(A.OPERATIONS_ENUM.LIST_USERS,new N(aa.listUsersExternal)),e.set(A.OPERATIONS_ENUM.LIST_ROLES,new N(Y_.listRoles)),e.set(A.OPERATIONS_ENUM.ADD_ROLE,new N(Y_.addRole)),e.set(A.OPERATIONS_ENUM.ALTER_ROLE,new N(Y_.alterRole)),e.set(A.OPERATIONS_ENUM.DROP_ROLE,new N(Y_.dropRole)),e.set(A.OPERATIONS_ENUM.USER_INFO,new N(aa.userInfo)),e.set(A.OPERATIONS_ENUM.READ_LOG,new N(KW)),e.set(A.OPERATIONS_ENUM.ADD_NODE,new N(QW)),e.set(A.OPERATIONS_ENUM.UPDATE_NODE,new N(WW)),e.set(A.OPERATIONS_ENUM.REMOVE_NODE,new N(JW)),e.set(A.OPERATIONS_ENUM.CONFIGURE_CLUSTER,new N(ZW)),e.set(A.OPERATIONS_ENUM.SET_CONFIGURATION,new N(jI.setConfiguration)),e.set(A.OPERATIONS_ENUM.CLUSTER_STATUS,new N(XW.clusterStatus)),e.set(A.OPERATIONS_ENUM.CLUSTER_SET_ROUTES,new N(qd.setRoutes)),e.set(A.OPERATIONS_ENUM.CLUSTER_GET_ROUTES,new N(qd.getRoutes)),e.set(A.OPERATIONS_ENUM.CLUSTER_DELETE_ROUTES,new N(qd.deleteRoutes)),e.set(A.OPERATIONS_ENUM.EXPORT_TO_S3,new N(ur,WI.export_to_s3)),e.set(A.OPERATIONS_ENUM.DELETE_FILES_BEFORE,new N(ur,oa.deleteFilesBefore)),e.set(A.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE,new N(ur,oa.deleteFilesBefore)),e.set(A.OPERATIONS_ENUM.EXPORT_LOCAL,new N(ur,WI.export_local)),e.set(A.OPERATIONS_ENUM.SEARCH_JOBS_BY_START_DATE,new N(kd.handleGetJobsByStartDate)),e.set(A.OPERATIONS_ENUM.GET_JOB,new N(kd.handleGetJob)),e.set(A.OPERATIONS_ENUM.GET_FINGERPRINT,new N(Fd.getFingerprint)),e.set(A.OPERATIONS_ENUM.SET_LICENSE,new N(Fd.setLicense)),e.set(A.OPERATIONS_ENUM.GET_REGISTRATION_INFO,new N(Fd.getRegistrationInfo)),e.set(A.OPERATIONS_ENUM.RESTART,new N(ZI.restartProcesses)),e.set(A.OPERATIONS_ENUM.RESTART_SERVICE,new N(ZI.restartService)),e.set(A.OPERATIONS_ENUM.CATCHUP,new N(u1)),e.set(A.OPERATIONS_ENUM.SYSTEM_INFORMATION,new N(e1.systemInformation)),e.set(A.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE,new N(ur,oa.deleteAuditLogsBefore)),e.set(A.OPERATIONS_ENUM.READ_AUDIT_LOG,new N(YW)),e.set(A.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS,new N(zI.createTokens)),e.set(A.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN,new N(zI.refreshOperationToken)),e.set(A.OPERATIONS_ENUM.GET_CONFIGURATION,new N(jI.getConfiguration)),e.set(A.OPERATIONS_ENUM.CUSTOM_FUNCTIONS_STATUS,new N(Lr.customFunctionsStatus)),e.set(A.OPERATIONS_ENUM.GET_CUSTOM_FUNCTIONS,new N(Lr.getCustomFunctions)),e.set(A.OPERATIONS_ENUM.GET_CUSTOM_FUNCTION,new N(Lr.getCustomFunction)),e.set(A.OPERATIONS_ENUM.SET_CUSTOM_FUNCTION,new N(Lr.setCustomFunction)),e.set(A.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION,new N(Lr.dropCustomFunction)),e.set(A.OPERATIONS_ENUM.ADD_CUSTOM_FUNCTION_PROJECT,new N(Lr.addCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION_PROJECT,new N(Lr.dropCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.PACKAGE_CUSTOM_FUNCTION_PROJECT,new N(Lr.packageCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.DEPLOY_CUSTOM_FUNCTION_PROJECT,new N(Lr.deployCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.READ_TRANSACTION_LOG,new N(eb.readTransactionLog)),e.set(A.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE,new N(ur,eb.deleteTransactionLogsBefore)),e.set(A.OPERATIONS_ENUM.INSTALL_NODE_MODULES,new N(tb.installModules)),e.set(A.OPERATIONS_ENUM.AUDIT_NODE_MODULES,new N(tb.auditModules)),e}a(l1,"initializeOperationFunctionMap")});var ub=S((j3,_b)=>{"use strict";var E1=require("node-ipc").IPC,ob=b(),cb=T(),Ur=I(),{IPC_ERRORS:kn}=Ke(),d1=require("os"),W_=class{constructor(t,r){this.ipc=new E1,this.server_name=cb.HDB_IPC_SERVER,this.ipc.config.retry=d1.platform()=="win32"?6e5:100,this.ipc.config.id=cb.HDB_IPC_CLIENT_PREFIX+t,this.ipc.config.silent=!0,this.event_handlers=r,this.connect()}connect(){this.ipc.connectTo(this.server_name,()=>{this.generateEventHandlers(this.event_handlers)})}addEventHandler(t,r){this.ipc.of[this.server_name].on(t,r)}generateEventHandlers(t){this.ipc.of[this.server_name].on("connect",()=>{Ur.info(`IPC client ${this.ipc.config.id} connected to ${this.server_name}`)}),this.ipc.of[this.server_name].on("disconnect",()=>{Ur.info(`IPC client ${this.ipc.config.id} disconnected from ${this.server_name}`)}),this.ipc.of[this.server_name].on("error",r=>{r.code==="ECONNREFUSED"&&Ur.warn("Error connecting to HDB IPC server. Confirm that the server is running."),Ur.warn(`Error with IPC client ${this.ipc.config.id}`),Ur.warn(r)});for(let[r,s]of Object.entries(t))this.addEventHandler(r,s)}emitToServer(t){if(typeof t!="object")throw Ur.warn(kn.INVALID_IPC_DATA_TYPE),new Error(kn.INVALID_IPC_DATA_TYPE);if(ob.isEmpty(t.type))throw Ur.warn(kn.MISSING_TYPE),new Error(kn.MISSING_TYPE);if(ob.isEmpty(t.message))throw Ur.warn(kn.MISSING_MSG),new Error(kn.MISSING_MSG);Ur.trace(`IPC client ${this.ipc.config.id} emitting`,t),this.ipc.of[this.server_name].emit("message",t)}};a(W_,"IPCClient");_b.exports=W_});var hb=S((e2,db)=>{"use strict";var h1=require("util"),{toJsMsg:S1}=require("nats"),{decode:f1}=require("msgpackr"),T1=xr(),m1=_A(),R1=ct(),Z_=_e(),A1=T(),$s=I(),O1=ab(),p1=ub(),N1=L_(),g1=Ns(),I1=h1.promisify(T1.setSchemaDataToGlobal),b1={durable:Z_.WORK_QUEUE_CONSUMER_NAMES.durable_name,queue:Z_.WORK_QUEUE_CONSUMER_NAMES.deliver_group,filterSubject:`${Z_.SUBJECT_PREFIXES.TXN}.>`},xd,$d,C1,w1;db.exports={initialize:L1,workQueueListener:U1};async function L1(){$s.notify("Starting clustering ingest service."),await I1();try{global.hdb_ipc=new p1(process.pid,m1)}catch(s){throw $s.error("Error instantiating new instance of IPC client in natsIngestService"),s}let{connection:e,jsm:t,js:r}=await R1.getNATSReferences();xd=e,$d=e.info.server_name,C1=t,w1=r}a(L1,"initialize");var Eb=100,lb=new Array(Eb),J_=0;async function U1(){let e=xd.subscribe(`${Z_.WORK_QUEUE_CONSUMER_NAMES.deliver_subject}.${xd.info.server_name}`,b1);for await(let t of e)await lb[J_],lb[J_]=y1(t).catch(r=>{$s.error(r)}),++J_>=Eb&&(J_=0)}a(U1,"workQueueListener");async function y1(e){let t=S1(e);t.working();let r=f1(t.data);$s.trace("processing message:",r);let s=[],n=[];if(t.headers){let o=t.headers.get("originators");o&&(n=o.split(","),s=n)}let i;if($s.trace(`messageProcessor originators: ${s} on server: ${$d}`),s.indexOf($d)<0){let o,c=O1.getOperationFunction(r);o=c.job_operation_function?c.job_operation_function:c.operation_function;try{c.job_operation_function?i=await o(r,s):(r[A1.CLUSTERING_FLAG]=!0,i=await N1.callOperationFunctionAsAwait(o,r,g1.postOperationHandler,s)),$s.debug(i)}catch(_){$s.error(_)}}return t.ack(),i}a(y1,"messageProcessor")});var Sb=hb();(async()=>{try{await Sb.initialize(),await Sb.workQueueListener()}catch(e){console.error("Error launching Nats ingest service."),console.error(e)}})();
