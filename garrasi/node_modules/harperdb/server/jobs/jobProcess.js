"use strict";var rC=Object.defineProperty;var a=(e,t)=>rC(e,"name",{value:t,configurable:!0});var h=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var T=h((e1,zd)=>{"use strict";var $e=require("path"),sC=require("fs");function nC(){let e=__dirname;for(;!sC.existsSync($e.join(e,"package.json"));){let t=$e.dirname(e);if(t===e)throw new Error("Could not find package root");e=t}return e}a(nC,"getHDBPackageRoot");var Gt=nC(),Fd="js",xn=Fd,iC="harperdb-config.yaml",aC="defaultConfig.yaml",oC="hdb",Vd=`hdbServer.${xn}`,kd=`customFunctionsServer.${xn}`,xd=`hdbIpcServer.${xn}`,cC=`restartHdb.${xn}`,J_="HarperDB",da="Custom Functions",Sa="Clustering Hub",ha="Clustering Leaf",Z_="Clustering Ingest Service",X_="Clustering Reply Service",_C="foreground.pid",W_={HDB:J_,IPC:"IPC",CLUSTERING_HUB:Sa,CLUSTERING_LEAF:ha,CLUSTERING_INGEST_SERVICE:Z_,CLUSTERING_REPLY_SERVICE:X_,CUSTOM_FUNCTIONS:da,RESTART_HDB:"Restart HDB",INSTALL:"Install",RUN:"Run",STOP:"Stop",UPGRADE:"Upgrade",REGISTER:"Register",JOB:"Job",PM2_LOGROTATE:"pm2-logrotate",CLUSTERING_UPGRADE_4_0_0:"Upgrade-4-0-0"},uC={HDB:"hdb.log",IPC:"ipc.log",CLUSTERING_HUB:"clustering_hub.log",CLUSTERING_LEAF:"clustering_leaf.log",CLUSTERING_INGEST_SERVICE:"clustering_ingest_service.log",CLUSTERING_REPLY_SERVICE:"clustering_reply_service.log",CUSTOM_FUNCTIONS:"custom_functions.log",INSTALL:"install.log",CLI:"cli.log",PM2:"pm2.log",CLUSTERING_UPGRADE:"clustering_upgrade.log",JOBS:"jobs.log"},lC={NOTIFY:"notify",FATAL:"fatal",ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug",TRACE:"trace"},EC={harperdb:J_,ipc:"IPC","clustering hub":Sa,"clustering leaf":ha,"clustering ingest service":Z_,"clustering reply service":X_,"custom functions":da,custom_functions:da,"pm2-logrotate":W_.PM2_LOGROTATE,logrotate:W_.PM2_LOGROTATE,clustering:"clustering","clustering config":"clustering config"},dC={CLUSTERING_HUB_PROC_DESCRIPTOR:Sa,CLUSTERING_LEAF_PROC_DESCRIPTOR:ha,CLUSTERING_INGEST_PROC_DESCRIPTOR:Z_,CLUSTERING_REPLY_SERVICE_DESCRIPTOR:X_},Ea={HDB:$e.join(Gt,"server/harperdb"),IPC:$e.join(Gt,"server/ipc"),CUSTOM_FUNCTIONS:$e.join(Gt,"server/customFunctions"),CLUSTERING_HUB:$e.join(Gt,"server/nats"),CLUSTERING_LEAF:$e.join(Gt,"server/nats")},SC={HDB:$e.join(Ea.HDB,Vd),IPC:$e.join(Ea.IPC,xd),CUSTOM_FUNCTIONS:$e.join(Ea.CUSTOM_FUNCTIONS,kd)},hC={HDB:$e.join(Gt,"launchServiceScripts/launchHarperDB.js"),CUSTOM_FUNCTIONS:$e.join(Gt,"launchServiceScripts/launchCustomFunctions.js"),NATS_INGEST_SERVICE:$e.join(Gt,"launchServiceScripts/launchNatsIngestService.js"),NATS_REPLY_SERVICE:$e.join(Gt,"launchServiceScripts/launchNatsReplyService.js"),NODES_UPGRADE_4_0_0:$e.resolve(Gt,"launchServiceScripts/launchUpdateNodes4-0-0.js")},fC={SUPER_USER:"super_user",CLUSTER_USER:"cluster_user"},$d="support@harperdb.io",TC="customer-success@harperdb.io",Yd=1,mC=4141,Kd="https://harperdbhelp.zendesk.com/hc/en-us/requests/new",RC="https://www.harperdb.io/product",AC=`For support, please submit a request at ${Kd} or contact ${$d}`,Qd=`For license support, please contact ${TC}`,OC="None of the specified records were found.",pC="hash attribute not found",NC=`Your current license only supports ${Yd} role.  ${Qd}`,gC="Your current license only supports 3 connections to a node.",IC="127.0.0.1",CC=1,bC=/^\.$/,wC=/^\.\.$/,LC="U+002E",UC=/\//g,yC="U+002F",DC=/U\+002F/g,MC=/^U\+002E$/,PC=/^U\+002EU\+002E$/,BC="d",vC=999999,HC="*",GC="--max-old-space-size=",qC="system",FC="__hdb_hash",VC=".harperdb",kC=".hdb",xC="keys",$C="hdb_boot_properties.file",YC=".updateConfig.json",KC="SIGTSTP",QC=24,WC=6e4,JC=448,ZC="blob",XC="trash",zC="schema",jC="transactions",eb=".count",tb="id",rb="install_log.log",sb="run_log.log",nb="PROCESS_NAME",ib={SETTINGS_PATH_KEY:"settings_path"},Wd=require("lodash"),ab={TC_AGREEMENT:"TC_AGREEMENT",CLUSTERING_USER:"CLUSTERING_USER",CLUSTERING_PASSWORD:"CLUSTERING_PASSWORD",HDB_ADMIN_USERNAME:"HDB_ADMIN_USERNAME",HDB_ADMIN_PASSWORD:"HDB_ADMIN_PASSWORD",OPERATIONSAPI_ROOT:"OPERATIONSAPI_ROOT",ROOTPATH:"ROOTPATH",OPERATIONSAPI_NETWORK_PORT:"OPERATIONSAPI_NETWORK_PORT",CLUSTERING_NODENAME:"CLUSTERING_NODENAME",CLUSTERING_ENABLED:"CLUSTERING_ENABLED",CLUSTERING_PORT:"CLUSTERING_PORT",HDB_ROOT:"HDB_ROOT",SERVER_PORT:"SERVER_PORT",NODE_NAME:"NODE_NAME",CLUSTERING:"CLUSTERING"},ob={HDB_PATH_KEY:"HDB_INTERNAL_PATH",HDB_AUTH_HEADER:"hdb_auth_header",HDB_USER_DATA_KEY:"hdb_user",CHUNK_SIZE:1e3,MAX_CHARACTER_SIZE:250},cb={DATA_VERSION:"data_version",UPGRADE_VERSION:"upgrade_version"},_b={JOB_TABLE_NAME:"hdb_job",NODE_TABLE_NAME:"hdb_nodes",ATTRIBUTE_TABLE_NAME:"hdb_attribute",LICENSE_TABLE_NAME:"hdb_license",ROLE_TABLE_NAME:"hdb_role",SCHEMA_TABLE_NAME:"hdb_schema",TABLE_TABLE_NAME:"hdb_table",USER_TABLE_NAME:"hdb_user",INFO_TABLE_NAME:"hdb_info"},ub={JOB_TABLE_HASH_ATTRIBUTE:"id",NODE_TABLE_HASH_ATTRIBUTE:"name",ATTRIBUTE_TABLE_HASH_ATTRIBUTE:"id",LICENSE_TABLE_HASH_ATTRIBUTE:"license_key",ROLE_TABLE_HASH_ATTRIBUTE:"id",SCHEMA_TABLE_HASH_ATTRIBUTE:"name",TABLE_TABLE_HASH_ATTRIBUTE:"id",USER_TABLE_HASH_ATTRIBUTE:"username",INFO_TABLE_ATTRIBUTE:"info_id"},dt="hdb_internal:",lb={CREATE_SCHEMA:dt+"create_schema",CREATE_TABLE:dt+"create_table",CREATE_ATTRIBUTE:dt+"create_attribute",ADD_USER:dt+"add_user",ALTER_USER:dt+"alter_user",DROP_USER:dt+"drop_user",HDB_NODES:dt+"hdb_nodes",HDB_USERS:dt+"hdb_users",HDB_WORKERS:dt+"hdb_workers",CATCHUP:dt+"catchup",SCHEMA_CATCHUP:dt+"schema_catchup",WORKER_ROOM:dt+"cluster_workers"},Eb={ATTR_ATTRIBUTE_KEY:"attribute",ATTR_CREATEDDATE_KEY:"createddate",ATTR_HASH_ATTRIBUTE_KEY:"hash_attribute",ATTR_ID_KEY:"id",ATTR_NAME_KEY:"name",ATTR_PASSWORD_KEY:"password",ATTR_RESIDENCE_KEY:"residence",ATTR_ROLE_KEY:"role",ATTR_SCHEMA_KEY:"schema",ATTR_SCHEMA_TABLE_KEY:"schema_table",ATTR_TABLE_KEY:"table",ATTR_USERNAME_KEY:"username"},db="060493.ks",Sb=".license",hb={CREATED:"CREATED",IN_PROGRESS:"IN_PROGRESS",COMPLETE:"COMPLETE",ERROR:"ERROR"},g={INSERT:"insert",UPDATE:"update",UPSERT:"upsert",SEARCH_BY_CONDITIONS:"search_by_conditions",SEARCH_BY_HASH:"search_by_hash",SEARCH_BY_VALUE:"search_by_value",SEARCH:"search",SQL:"sql",CSV_DATA_LOAD:"csv_data_load",CSV_FILE_LOAD:"csv_file_load",CSV_URL_LOAD:"csv_url_load",CREATE_SCHEMA:"create_schema",CREATE_TABLE:"create_table",CREATE_ATTRIBUTE:"create_attribute",DROP_SCHEMA:"drop_schema",DROP_TABLE:"drop_table",DESCRIBE_SCHEMA:"describe_schema",DESCRIBE_TABLE:"describe_table",DESCRIBE_ALL:"describe_all",DELETE:"delete",ADD_USER:"add_user",ALTER_USER:"alter_user",DROP_USER:"drop_user",LIST_USERS:"list_users",LIST_ROLES:"list_roles",ADD_ROLE:"add_role",ALTER_ROLE:"alter_role",DROP_ROLE:"drop_role",USER_INFO:"user_info",READ_LOG:"read_log",ADD_NODE:"add_node",UPDATE_NODE:"update_node",EXPORT_TO_S3:"export_to_s3",IMPORT_FROM_S3:"import_from_s3",DELETE_FILES_BEFORE:"delete_files_before",DELETE_RECORDS_BEFORE:"delete_records_before",EXPORT_LOCAL:"export_local",SEARCH_JOBS_BY_START_DATE:"search_jobs_by_start_date",GET_JOB:"get_job",DELETE_JOB:"delete_job",UPDATE_JOB:"update_job",GET_FINGERPRINT:"get_fingerprint",SET_LICENSE:"set_license",GET_REGISTRATION_INFO:"registration_info",CONFIGURE_CLUSTER:"configure_cluster",SET_CONFIGURATION:"set_configuration",CLUSTER_STATUS:"cluster_status",DROP_ATTRIBUTE:"drop_attribute",REMOVE_NODE:"remove_node",RESTART:"restart",RESTART_SERVICE:"restart_service",CATCHUP:"catchup",SYSTEM_INFORMATION:"system_information",DELETE_AUDIT_LOGS_BEFORE:"delete_audit_logs_before",READ_AUDIT_LOG:"read_audit_log",CREATE_AUTHENTICATION_TOKENS:"create_authentication_tokens",REFRESH_OPERATION_TOKEN:"refresh_operation_token",GET_CONFIGURATION:"get_configuration",CUSTOM_FUNCTIONS_STATUS:"custom_functions_status",GET_CUSTOM_FUNCTIONS:"get_custom_functions",GET_CUSTOM_FUNCTION:"get_custom_function",SET_CUSTOM_FUNCTION:"set_custom_function",DROP_CUSTOM_FUNCTION:"drop_custom_function",ADD_CUSTOM_FUNCTION_PROJECT:"add_custom_function_project",DROP_CUSTOM_FUNCTION_PROJECT:"drop_custom_function_project",PACKAGE_CUSTOM_FUNCTION_PROJECT:"package_custom_function_project",DEPLOY_CUSTOM_FUNCTION_PROJECT:"deploy_custom_function_project",CLUSTER_SET_ROUTES:"cluster_set_routes",CLUSTER_DELETE_ROUTES:"cluster_delete_routes",CLUSTER_GET_ROUTES:"cluster_get_routes",READ_TRANSACTION_LOG:"read_transaction_log",DELETE_TRANSACTION_LOGS_BEFORE:"delete_transaction_logs_before",INSTALL_NODE_MODULES:"install_node_modules",AUDIT_NODE_MODULES:"audit_node_modules"},fb={CSV:".csv",JSON:".json"},Tb={AWS_ACCESS_KEY:"aws_access_key_id",AWS_SECRET:"aws_secret_access_key",AWS_BUCKET:"bucket",AWS_FILE_KEY:"key"},mb={SELECT:"select",INSERT:"insert",UPDATE:"update",DELETE:"delete"},Dr={};Dr[g.CREATE_SCHEMA]=g.CREATE_SCHEMA;Dr[g.CREATE_TABLE]=g.CREATE_TABLE;Dr[g.CREATE_ATTRIBUTE]=g.CREATE_ATTRIBUTE;Dr[g.INSERT]=g.INSERT;Dr[g.UPDATE]=g.UPDATE;Dr[g.UPSERT]=g.UPSERT;Dr[g.DELETE]=g.DELETE;var J=Object.create(null);J[g.DESCRIBE_ALL]=g.DESCRIBE_ALL;J[g.DESCRIBE_TABLE]=g.DESCRIBE_TABLE;J[g.DESCRIBE_SCHEMA]=g.DESCRIBE_SCHEMA;J[g.READ_LOG]=g.READ_LOG;J[g.ADD_NODE]=g.ADD_NODE;J[g.LIST_USERS]=g.LIST_USERS;J[g.LIST_ROLES]=g.LIST_ROLES;J[g.USER_INFO]=g.USER_INFO;J[g.SQL]=g.SQL;J[g.GET_JOB]=g.GET_JOB;J[g.SEARCH_JOBS_BY_START_DATE]=g.SEARCH_JOBS_BY_START_DATE;J[g.DELETE_FILES_BEFORE]=g.DELETE_FILES_BEFORE;J[g.EXPORT_LOCAL]=g.EXPORT_LOCAL;J[g.EXPORT_TO_S3]=g.EXPORT_TO_S3;J[g.CLUSTER_STATUS]=g.CLUSTER_STATUS;J[g.REMOVE_NODE]=g.REMOVE_NODE;J[g.RESTART]=g.RESTART;J[g.CUSTOM_FUNCTIONS_STATUS]=g.CUSTOM_FUNCTIONS_STATUS;J[g.GET_CUSTOM_FUNCTIONS]=g.GET_CUSTOM_FUNCTIONS;J[g.GET_CUSTOM_FUNCTION]=g.GET_CUSTOM_FUNCTION;J[g.SET_CUSTOM_FUNCTION]=g.SET_CUSTOM_FUNCTION;J[g.DROP_CUSTOM_FUNCTION]=g.DROP_CUSTOM_FUNCTION;J[g.ADD_CUSTOM_FUNCTION_PROJECT]=g.ADD_CUSTOM_FUNCTION_PROJECT;J[g.DROP_CUSTOM_FUNCTION_PROJECT]=g.DROP_CUSTOM_FUNCTION_PROJECT;J[g.PACKAGE_CUSTOM_FUNCTION_PROJECT]=g.PACKAGE_CUSTOM_FUNCTION_PROJECT;J[g.DEPLOY_CUSTOM_FUNCTION_PROJECT]=g.DEPLOY_CUSTOM_FUNCTION_PROJECT;var Rb={RUN:"run",INSTALL:"install",REGISTER:"register",STOP:"stop",RESTART:"restart",VERSION:"version",UPGRADE:"upgrade"},Ab={point:"point",lineString:"lineString",multiLineString:"multiLineString",multiPoint:"multiPoint",multiPolygon:"multiPolygon",polygon:"polygon"},Jd={HDB_ROOT_KEY:"HDB_ROOT",SERVER_PORT_KEY:"SERVER_PORT",CERT_KEY:"CERTIFICATE",PRIVATE_KEY_KEY:"PRIVATE_KEY",HTTP_SECURE_ENABLED_KEY:"HTTPS_ON",CORS_ENABLED_KEY:"CORS_ON",CORS_WHITELIST_KEY:"CORS_WHITELIST",LOG_LEVEL_KEY:"LOG_LEVEL",LOGGER_KEY:"LOGGER",LOG_PATH_KEY:"LOG_PATH",LOG_ROTATE:"LOG_ROTATE",LOG_ROTATE_MAX_SIZE:"LOG_ROTATE_MAX_SIZE",LOG_ROTATE_RETAIN:"LOG_ROTATE_RETAIN",LOG_ROTATE_COMPRESS:"LOG_ROTATE_COMPRESS",LOG_ROTATE_DATE_FORMAT:"LOG_ROTATE_DATE_FORMAT",LOG_ROTATE_ROTATE_MODULE:"LOG_ROTATE_ROTATE_MODULE",LOG_ROTATE_WORKER_INTERVAL:"LOG_ROTATE_WORKER_INTERVAL",LOG_ROTATE_ROTATE_INTERVAL:"LOG_ROTATE_ROTATE_INTERVAL",LOG_ROTATE_TIMEZONE:"LOG_ROTATE_TIMEZONE",LOG_DAILY_ROTATE_KEY:"LOG_DAILY_ROTATE",LOG_MAX_DAILY_FILES_KEY:"LOG_MAX_DAILY_FILES",PROPS_ENV_KEY:"NODE_ENV",SETTINGS_PATH_KEY:"settings_path",CLUSTERING_PORT_KEY:"CLUSTERING_PORT",CLUSTERING_NODE_NAME_KEY:"NODE_NAME",CLUSTERING_ENABLED_KEY:"CLUSTERING",ALLOW_SELF_SIGNED_SSL_CERTS:"ALLOW_SELF_SIGNED_SSL_CERTS",MAX_HDB_PROCESSES:"MAX_HDB_PROCESSES",INSTALL_USER:"install_user",CLUSTERING_USER_KEY:"CLUSTERING_USER",MAX_CLUSTERING_PROCESSES:"MAX_CLUSTERING_PROCESSES",SERVER_TIMEOUT_KEY:"SERVER_TIMEOUT_MS",SERVER_KEEP_ALIVE_TIMEOUT_KEY:"SERVER_KEEP_ALIVE_TIMEOUT",SERVER_HEADERS_TIMEOUT_KEY:"SERVER_HEADERS_TIMEOUT",DISABLE_TRANSACTION_LOG_KEY:"DISABLE_TRANSACTION_LOG",OPERATION_TOKEN_TIMEOUT_KEY:"OPERATION_TOKEN_TIMEOUT",REFRESH_TOKEN_TIMEOUT_KEY:"REFRESH_TOKEN_TIMEOUT",IPC_SERVER_PORT:"IPC_SERVER_PORT",CUSTOM_FUNCTIONS_ENABLED_KEY:"CUSTOM_FUNCTIONS",CUSTOM_FUNCTIONS_PORT_KEY:"CUSTOM_FUNCTIONS_PORT",CUSTOM_FUNCTIONS_DIRECTORY_KEY:"CUSTOM_FUNCTIONS_DIRECTORY",MAX_CUSTOM_FUNCTION_PROCESSES:"MAX_CUSTOM_FUNCTION_PROCESSES",LOG_TO_FILE:"LOG_TO_FILE",LOG_TO_STDSTREAMS:"LOG_TO_STDSTREAMS",RUN_IN_FOREGROUND:"RUN_IN_FOREGROUND",LOCAL_STUDIO_ON:"LOCAL_STUDIO_ON",STORAGE_WRITE_ASYNC:"STORAGE_WRITE_ASYNC"},Ob=Wd.invert(Jd),f={CLUSTERING_USER:"clustering_user",CLUSTERING_ENABLED:"clustering_enabled",CLUSTERING_HUBSERVER_CLUSTER_NAME:"clustering_hubServer_cluster_name",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT:"clustering_hubServer_cluster_network_port",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES:"clustering_hubServer_cluster_network_routes",CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT:"clustering_hubServer_leafNodes_network_port",CLUSTERING_HUBSERVER_NETWORK_PORT:"clustering_hubServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_PORT:"clustering_leafServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_ROUTES:"clustering_leafServer_network_routes",CLUSTERING_NODENAME:"clustering_nodeName",CLUSTERING_TLS_CERTIFICATE:"clustering_tls_certificate",CLUSTERING_TLS_PRIVATEKEY:"clustering_tls_privateKey",CLUSTERING_TLS_CERT_AUTH:"clustering_tls_certificateAuthority",CLUSTERING_TLS_INSECURE:"clustering_tls_insecure",CUSTOMFUNCTIONS_ENABLED:"customFunctions_enabled",CUSTOMFUNCTIONS_NETWORK_PORT:"customFunctions_network_port",CUSTOMFUNCTIONS_TLS_CERTIFICATE:"customFunctions_tls_certificate",CUSTOMFUNCTIONS_NETWORK_CORS:"customFunctions_network_cors",CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST:"customFunctions_network_corsAccessList",CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT:"customFunctions_network_headersTimeout",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT:"customFunctions_network_keepAliveTimeout",CUSTOMFUNCTIONS_TLS_PRIVATEKEY:"customFunctions_tls_privateKey",CUSTOMFUNCTIONS_TLS_CERT_AUTH:"customFunctions_tls_certificateAuthority",CUSTOMFUNCTIONS_NETWORK_TIMEOUT:"customFunctions_network_timeout",CUSTOMFUNCTIONS_NODEENV:"customFunctions_nodeEnv",CUSTOMFUNCTIONS_ROOT:"customFunctions_root",HTTP_THREADS:"http_threads",IPC_NETWORK_PORT:"ipc_network_port",LOCALSTUDIO_ENABLED:"localStudio_enabled",LOGGING_FILE:"logging_file",LOGGING_LEVEL:"logging_level",LOGGING_ROOT:"logging_root",LOGGING_ROTATION_COMPRESS:"logging_rotation_compress",LOGGING_ROTATION_DATEFORMAT:"logging_rotation_dateFormat",LOGGING_ROTATION_MAXSIZE:"logging_rotation_maxSize",LOGGING_ROTATION_RETAIN:"logging_rotation_retain",LOGGING_ROTATION_ROTATE:"logging_rotation_rotate",LOGGING_ROTATION_ROTATEINTERVAL:"logging_rotation_rotateInterval",LOGGING_ROTATION_ROTATEMODULE:"logging_rotation_rotateModule",LOGGING_ROTATION_TIMEZONE:"logging_rotation_timezone",LOGGING_ROTATION_WORKERINTERVAL:"logging_rotation_workerInterval",LOGGING_STDSTREAMS:"logging_stdStreams",LOGGING_AUDITLOG:"logging_auditLog",OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT:"operationsApi_authentication_operationTokenTimeout",OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT:"operationsApi_authentication_refreshTokenTimeout",OPERATIONSAPI_FOREGROUND:"operationsApi_foreground",OPERATIONSAPI_TLS_CERTIFICATE:"operationsApi_tls_certificate",OPERATIONSAPI_NETWORK_CORS:"operationsApi_network_cors",OPERATIONSAPI_NETWORK_CORSACCESSLIST:"operationsApi_network_corsAccessList",OPERATIONSAPI_NETWORK_HEADERSTIMEOUT:"operationsApi_network_headersTimeout",OPERATIONSAPI_NETWORK_HTTPS:"operationsApi_network_https",OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT:"operationsApi_network_keepAliveTimeout",OPERATIONSAPI_NETWORK_PORT:"operationsApi_network_port",OPERATIONSAPI_TLS_PRIVATEKEY:"operationsApi_tls_privateKey",OPERATIONSAPI_TLS_CERT_AUTH:"operationsApi_tls_certificateAuthority",OPERATIONSAPI_NETWORK_TIMEOUT:"operationsApi_network_timeout",OPERATIONSAPI_NODEENV:"operationsApi_nodeEnv",ROOTPATH:"rootPath",STORAGE_WRITEASYNC:"storage_writeAsync",STORAGE_OVERLAPPINGSYNC:"storage_overlappingSync"},pb={hdb_root_key:f.ROOTPATH,hdb_root:f.ROOTPATH,server_port_key:f.OPERATIONSAPI_NETWORK_PORT,server_port:f.OPERATIONSAPI_NETWORK_PORT,cert_key:f.OPERATIONSAPI_TLS_CERTIFICATE,certificate:f.OPERATIONSAPI_TLS_CERTIFICATE,private_key_key:f.OPERATIONSAPI_TLS_PRIVATEKEY,private_key:f.OPERATIONSAPI_TLS_PRIVATEKEY,http_secure_enabled_key:f.OPERATIONSAPI_NETWORK_HTTPS,https_on:f.OPERATIONSAPI_NETWORK_HTTPS,cors_enabled_key:f.OPERATIONSAPI_NETWORK_CORS,cors_on:f.OPERATIONSAPI_NETWORK_CORS,cors_whitelist_key:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_whitelist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist_key:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,log_level_key:f.LOGGING_LEVEL,log_level:f.LOGGING_LEVEL,log_path_key:f.LOGGING_ROOT,log_path:f.LOGGING_ROOT,log_daily_rotate:f.LOGGING_ROTATION_ROTATE,log_rotate:f.LOGGING_ROTATION_ROTATE,log_rotate_max_size:f.LOGGING_ROTATION_MAXSIZE,log_rotate_retain:f.LOGGING_ROTATION_RETAIN,log_rotate_compress:f.LOGGING_ROTATION_COMPRESS,log_rotate_date_format:f.LOGGING_ROTATION_DATEFORMAT,log_rotate_rotate_module:f.LOGGING_ROTATION_ROTATEMODULE,log_rotate_worker_interval:f.LOGGING_ROTATION_WORKERINTERVAL,log_rotate_rotate_interval:f.LOGGING_ROTATION_ROTATEINTERVAL,log_rotate_timezone:f.LOGGING_ROTATION_TIMEZONE,props_env_key:f.OPERATIONSAPI_NODEENV,node_env:f.OPERATIONSAPI_NODEENV,clustering_node_name_key:f.CLUSTERING_NODENAME,node_name:f.CLUSTERING_NODENAME,clustering_enabled_key:f.CLUSTERING_ENABLED,clustering:f.CLUSTERING_ENABLED,max_http_threads:f.HTTP_THREADS,max_hdb_processes:f.HTTP_THREADS,server_timeout_key:f.OPERATIONSAPI_NETWORK_TIMEOUT,server_timeout_ms:f.OPERATIONSAPI_NETWORK_TIMEOUT,server_keep_alive_timeout_key:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_keep_alive_timeout:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_headers_timeout_key:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,server_headers_timeout:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,disable_transaction_log_key:f.LOGGING_AUDITLOG,disable_transaction_log:f.LOGGING_AUDITLOG,operation_token_timeout_key:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,operation_token_timeout:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,refresh_token_timeout_key:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,refresh_token_timeout:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,ipc_server_port:f.IPC_NETWORK_PORT,custom_functions_enabled_key:f.CUSTOMFUNCTIONS_ENABLED,custom_functions:f.CUSTOMFUNCTIONS_ENABLED,custom_functions_port_key:f.CUSTOMFUNCTIONS_NETWORK_PORT,custom_functions_port:f.CUSTOMFUNCTIONS_NETWORK_PORT,custom_functions_directory_key:f.CUSTOMFUNCTIONS_ROOT,custom_functions_directory:f.CUSTOMFUNCTIONS_ROOT,max_custom_function_processes:f.HTTP_THREADS,log_to_file:f.LOGGING_FILE,log_to_stdstreams:f.LOGGING_STDSTREAMS,run_in_foreground:f.OPERATIONSAPI_FOREGROUND,local_studio_on:f.LOCALSTUDIO_ENABLED,clustering_port:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_user:f.CLUSTERING_USER,clustering_enabled:f.CLUSTERING_ENABLED,clustering_hubserver_cluster_name:f.CLUSTERING_HUBSERVER_CLUSTER_NAME,clustering_hubserver_cluster_network_port:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_hubserver_cluster_network_routes:f.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,clustering_hubserver_leafnodes_network_port:f.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT,clustering_hubserver_network_port:f.CLUSTERING_HUBSERVER_NETWORK_PORT,clustering_leafserver_network_port:f.CLUSTERING_LEAFSERVER_NETWORK_PORT,clustering_leafserver_network_routes:f.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,clustering_nodename:f.CLUSTERING_NODENAME,clustering_tls_certificate:f.CLUSTERING_TLS_CERTIFICATE,clustering_tls_privatekey:f.CLUSTERING_TLS_PRIVATEKEY,clustering_tls_certificateauthority:f.CLUSTERING_TLS_CERT_AUTH,clustering_tls_insecure:f.CLUSTERING_TLS_INSECURE,customfunctions_enabled:f.CUSTOMFUNCTIONS_ENABLED,customfunctions_network_port:f.CUSTOMFUNCTIONS_NETWORK_PORT,customfunctions_tls_certificate:f.CUSTOMFUNCTIONS_TLS_CERTIFICATE,customfunctions_network_cors:f.CUSTOMFUNCTIONS_NETWORK_CORS,customfunctions_network_corsaccesslist:f.CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST,customfunctions_network_headerstimeout:f.CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT,customfunctions_network_https:f.CUSTOMFUNCTIONS_NETWORK_HTTPS,customfunctions_network_keepalivetimeout:f.CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT,customfunctions_tls_privatekey:f.CUSTOMFUNCTIONS_TLS_PRIVATEKEY,customfunctions_tls_certificateauthority:f.CUSTOMFUNCTIONS_TLS_CERT_AUTH,customfunctions_network_timeout:f.CUSTOMFUNCTIONS_NETWORK_TIMEOUT,customfunctions_nodeenv:f.CUSTOMFUNCTIONS_NODEENV,http_threads:f.HTTP_THREADS,customfunctions_processes:f.HTTP_THREADS,customfunctions_root:f.CUSTOMFUNCTIONS_ROOT,ipc_network_port:f.IPC_NETWORK_PORT,localstudio_enabled:f.LOCALSTUDIO_ENABLED,logging_file:f.LOGGING_FILE,logging_level:f.LOGGING_LEVEL,logging_root:f.LOGGING_ROOT,logging_rotation_compress:f.LOGGING_ROTATION_COMPRESS,logging_rotation_dateformat:f.LOGGING_ROTATION_DATEFORMAT,logging_rotation_maxsize:f.LOGGING_ROTATION_MAXSIZE,logging_rotation_retain:f.LOGGING_ROTATION_RETAIN,logging_rotation_rotate:f.LOGGING_ROTATION_ROTATE,logging_rotation_rotateinterval:f.LOGGING_ROTATION_ROTATEINTERVAL,logging_rotation_rotatemodule:f.LOGGING_ROTATION_ROTATEMODULE,logging_rotation_timezone:f.LOGGING_ROTATION_TIMEZONE,logging_rotation_workerinterval:f.LOGGING_ROTATION_WORKERINTERVAL,logging_stdstreams:f.LOGGING_STDSTREAMS,logging_auditlog:f.LOGGING_AUDITLOG,operationsapi_authentication_operationtokentimeout:f.OPERATIONSAPI_AUTHENTICATION_OPERATIONTOKENTIMEOUT,operationsapi_authentication_refreshtokentimeout:f.OPERATIONSAPI_AUTHENTICATION_REFRESHTOKENTIMEOUT,operationsapi_foreground:f.OPERATIONSAPI_FOREGROUND,operationsapi_tls_certificate:f.OPERATIONSAPI_TLS_CERTIFICATE,operationsapi_network_cors:f.OPERATIONSAPI_NETWORK_CORS,operationsapi_network_corsaccesslist:f.OPERATIONSAPI_NETWORK_CORSACCESSLIST,operationsapi_network_headerstimeout:f.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,operationsapi_network_https:f.OPERATIONSAPI_NETWORK_HTTPS,operationsapi_network_keepalivetimeout:f.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,operationsapi_network_port:f.OPERATIONSAPI_NETWORK_PORT,operationsapi_tls_privatekey:f.OPERATIONSAPI_TLS_PRIVATEKEY,operationsapi_network_timeout:f.OPERATIONSAPI_NETWORK_TIMEOUT,operationsapi_nodeenv:f.OPERATIONSAPI_NODEENV,operationsapi_root:f.ROOTPATH,rootpath:f.ROOTPATH,storage_writeasync:f.STORAGE_WRITEASYNC,storage_overlappingsync:f.STORAGE_OVERLAPPINGSYNC},Nb={csv_file_load:"csv_file_load",csv_data_load:g.CSV_DATA_LOAD,csv_url_load:g.CSV_URL_LOAD,delete_files_before:"delete_files_before",delete_records_before:"delete_records_before",delete_audit_logs_before:"delete_audit_logs_before",delete_transaction_logs_before:"delete_transaction_logs_before",empty_trash:"empty_trash",export_local:"export_local",export_to_s3:"export_to_s3",import_from_s3:"import_from_s3"},gb={CLUSTERING_PAYLOAD:"clustering_payload",DELEGATE_THREAD_RESPONSE:"delegate_thread_response",CLUSTERING:"clustering",SCHEMA:"schema",CLUSTER_STATUS:"cluster_status",JOB:"job",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",USER:"user",RESTART:"restart"},Ib={BIDIRECTIONAL:"BIDIRECTIONAL",OUTBOUND:"OUTBOUND",INBOUND:"INBOUND"},Cb={FILE_SYSTEM:"fs",LMDB:"lmdb"},bb={API_CALL_DEFAULT:1e4,VERSION_DEFAULT:"2.2.0"},wb={DEVELOPMENT:8192,DEFAULT:512},Lb={IDENTIFY:"identify",AUTHENTICATE:"authenticate",AUTHENTICATE_OK:"authenticated",AUTHENTICATE_FAIL:"authenticate_fail",CONNECTION:"connection",CONNECT:"connect",CATCHUP_REQUEST:"catchup_request",CATCHUP_RESPONSE:"catchup",CONFIRM_MSG:"confirm_msg",ERROR:"error",DISCONNECT:"disconnect",SCHEMA_UPDATE_REQ:"schema_update_request",SCHEMA_UPDATE_RES:"schema_update_response",RECONNECT_ATTEMPT:"reconnect_attempt",CONNECT_ERROR:"connect_error",MESSAGE:"msg",VERSION_MISMATCH:"version_mismatch",DIRECTION_CHANGE:"direction_change"},Ub={1e3:"SUCCESSFUL_SHUTDOWN",1001:"CLOSE_GOING_AWAY",1002:"CLOSE_PROTOCOL_ERROR",1003:"CLOSE_UNSUPPORTED",1005:"CLOSE_NO_STATUS",1006:"CLOSE_ABNORMAL",1007:"UNSUPPORTED_PAYLOAD",1008:"POLICY_VIOLATION",1009:"CLOSE_TOO_LARGE",1010:"MANDATORY_EXTENSION",1011:"SERVER_ERROR",1012:"SERVICE_RESTART",1013:"SERVER_BUSY",1014:"BAD_GATEWAY",1015:"HANDSHAKE_FAIL",4141:"LICENSE_LIMIT_REACHED"},yb={ENOENT:"ENOENT",EACCES:"EACCES"},Zd={CREATED_TIME:"__createdtime__",UPDATED_TIME:"__updatedtime__"},Db="__clustering__",Mb=Object.values(Zd),Pb=15984864e5,Xd={LESS:"<",LESS_OR_EQ:"<=",GREATER:">",GREATER_OR_EQ:">=",BETWEEN:"..."},Bb=Wd.invert(Xd),vb={GET_CLUSTER_STATUS:"GET_CLUSTER_STATUS",CLUSTER_STATUS_RESPONSE:"CLUSTER_STATUS_RESPONSE",ERROR_RESPONSE:"ERROR",ADD_USER:"ADD_USER",ALTER_USER:"ALTER_USER",DROP_USER:"DROP_USER",HDB_OPERATION:"HDB_OPERATION",ADD_NODE:"ADD_NODE",UPDATE_NODE:"UPDATE_NODE",REMOVE_NODE:"REMOVE_NODE",HDB_USERS_MSG:"HDB_USERS_MSG",HDB_WORKERS:"HDB_WORKERS",HDB_TRANSACTION:"HDB_TRANSACTION"},Hb=111,Gb=`\r
`,qb={READ:"read",INSERT:"insert",UPDATE:"update",DELETE:"delete"},Fb=["*","%"],Vb="unauthorized_access",kb="func_val",xb={HASH_VALUE:"hash_value",TIMESTAMP:"timestamp",USERNAME:"username"},$b={JWT_PRIVATE_KEY_NAME:".jwtPrivate.key",JWT_PUBLIC_KEY_NAME:".jwtPublic.key",JWT_PASSPHRASE_NAME:".jwtPass"},Yb="hdb_ipc_server",Kb="hdb_ipc_client_",Qb={RESTART:"restart",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",SCHEMA:"schema",USER:"user",CLUSTER_STATUS_RESPONSE:"cluster_status_response",CLUSTER_STATUS_REQUEST:"cluster_status_request"},Wb={HDB_CORE:"hdb_core",CUSTOM_FUNCTIONS:"custom_functions"},Jb={STOPPED:"stopped",ONLINE:"online"},Zb="3.x.x";zd.exports={LOCAL_HARPERDB_OPERATIONS:J,HDB_SUPPORT_ADDRESS:$d,HDB_SUPPORT_URL:Kd,HDB_PRICING_URL:RC,SUPPORT_HELP_MSG:AC,LICENSE_HELP_MSG:Qd,HDB_PROC_NAME:Vd,HDB_PROC_DESCRIPTOR:J_,CLUSTERING_LEAF_PROC_DESCRIPTOR:ha,CLUSTERING_HUB_PROC_DESCRIPTOR:Sa,SYSTEM_SCHEMA_NAME:qC,HASH_FOLDER_NAME:FC,HDB_HOME_DIR_NAME:VC,UPDATE_FILE_NAME:YC,LICENSE_KEY_DIR_NAME:xC,BOOT_PROPS_FILE_NAME:$C,JOB_TYPE_ENUM:Nb,JOB_STATUS_ENUM:hb,SYSTEM_TABLE_NAMES:_b,SYSTEM_TABLE_HASH_ATTRIBUTES:ub,OPERATIONS_ENUM:g,VALID_S3_FILE_TYPES:fb,S3_BUCKET_AUTH_KEYS:Tb,VALID_SQL_OPS_ENUM:mb,GEO_CONVERSION_ENUM:Ab,HDB_SETTINGS_NAMES:Jd,HDB_SETTINGS_NAMES_REVERSE_LOOKUP:Ob,SERVICE_ACTIONS_ENUM:Rb,CLUSTER_MESSAGE_TYPE_ENUM:gb,CLUSTER_CONNECTION_DIRECTION_ENUM:Ib,CLUSTER_EVENTS_DEFS_ENUM:Lb,PERIOD_REGEX:bC,DOUBLE_PERIOD_REGEX:wC,UNICODE_PERIOD:LC,FORWARD_SLASH_REGEX:UC,UNICODE_FORWARD_SLASH:yC,ESCAPED_FORWARD_SLASH_REGEX:DC,ESCAPED_PERIOD_REGEX:MC,ESCAPED_DOUBLE_PERIOD_REGEX:PC,REG_KEY_FILE_NAME:db,RESTART_TIMEOUT_MS:WC,HDB_FILE_PERMISSIONS:JC,SCHEMA_DIR_NAME:zC,TRANSACTIONS_DIR_NAME:jC,LIMIT_COUNT_NAME:eb,ID_ATTRIBUTE_STRING:tb,INSERT_MODULE_ENUM:ob,UPGRADE_JSON_FIELD_NAMES_ENUM:cb,RESTART_CODE:KC,RESTART_CODE_NUM:QC,CLUSTER_OPERATIONS:Dr,SYSTEM_DEFAULT_ATTRIBUTE_NAMES:Eb,HDB_INTERNAL_SC_CHANNEL_PREFIX:dt,INTERNAL_SC_CHANNELS:lb,CLUSTERING_MESSAGE_TYPES:vb,HDB_FILE_SUFFIX:kC,BLOB_FOLDER_NAME:ZC,HDB_TRASH_DIR:XC,ORIGINATOR_SET_VALUE:Hb,LICENSE_VALUES:bb,RAM_ALLOCATION_ENUM:wb,STORAGE_TYPES_ENUM:Cb,TIME_STAMP_NAMES_ENUM:Zd,TIME_STAMP_NAMES:Mb,PERMS_UPDATE_RELEASE_TIMESTAMP:Pb,SEARCH_NOT_FOUND_MESSAGE:OC,SEARCH_ATTRIBUTE_NOT_FOUND:pC,LICENSE_ROLE_DENIED_RESPONSE:NC,LICENSE_MAX_CONNS_REACHED:gC,BASIC_LICENSE_MAX_NON_CU_ROLES:Yd,BASIC_LICENSE_CLUSTER_CONNECTION_LIMIT_WS_ERROR_CODE:mC,VALUE_SEARCH_COMPARATORS:Xd,VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP:Bb,LICENSE_FILE_NAME:Sb,WEBSOCKET_CLOSE_CODE_DESCRIPTION_LOOKUP:Ub,NEW_LINE:Gb,BASIC_LICENSE_MAX_CLUSTER_USER_ROLES:CC,MOMENT_DAYS_TAG:BC,API_TURNOVER_SEC:vC,LOOPBACK:IC,CODE_EXTENSION:xn,WILDCARD_SEARCH_VALUE:HC,NODE_ERROR_CODES:yb,JAVASCRIPT_EXTENSION:Fd,PERMS_CRUD_ENUM:qb,UNAUTHORIZED_PERMISSION_NAME:Vb,SEARCH_WILDCARDS:Fb,FUNC_VAL:kb,READ_AUDIT_LOG_SEARCH_TYPES_ENUM:xb,JWT_ENUM:$b,CLUSTERING_FLAG:Db,RUN_LOG:sb,INSTALL_LOG:rb,IPC_SERVER_MODULE:xd,HDB_IPC_SERVER:Yb,IPC_EVENT_TYPES:Qb,HDB_IPC_CLIENT_PREFIX:Kb,CUSTOM_FUNCTION_PROC_NAME:kd,CUSTOM_FUNCTION_PROC_DESCRIPTOR:da,SERVICES:Wb,MEM_SETTING_KEY:GC,HDB_RESTART_SCRIPT:cC,PROCESS_DESCRIPTORS:W_,SERVICE_SERVERS:SC,SERVICE_SERVERS_CWD:Ea,PROCESS_DESCRIPTORS_VALIDATE:EC,LAUNCH_SERVICE_SCRIPTS:hC,LOG_LEVELS:lC,PROCESS_NAME_ENV_PROP:nb,PROCESS_LOG_NAMES:uC,PM2_PROCESS_STATUSES:Jb,CONFIG_PARAM_MAP:pb,CONFIG_PARAMS:f,HDB_CONFIG_FILE:iC,HDB_DEFAULT_CONFIG_FILE:aC,ROLE_TYPES_ENUM:fC,BOOT_PROP_PARAMS:ib,INSTALL_PROMPTS:ab,HDB_ROOT_DIR_NAME:oC,CLUSTERING_PROCESSES:dC,FOREGROUND_PID_FILE:_C,PACKAGE_ROOT:Gt,PRE_4_0_0_VERSION:Zb}});var z_=h((t1,tS)=>{"use strict";var jd=require("minimist");tS.exports=Xb;function Xb(e=[],t=!1){if(!Array.isArray(e))return{};let r,s;t?(r=eS(process.env),s=eS(jd(process.argv))):(r=process.env,s=jd(process.argv));let n={};for(let i=0,o=e.length;i<o;i++){let c=e[i];s[c]!==void 0?n[c]=s[c].toString().trim():r[c]!==void 0&&(n[c]=r[c].toString().trim())}return n}a(Xb,"assignCMDENVVariables");function eS(e){let t,r=Object.keys(e),s=r.length,n={};for(;s--;)t=r[s],n[t.toLowerCase()]=e[t];return n}a(eS,"objKeysToLowerCase")});var I=h((r1,cS)=>{"use strict";var ss=require("fs-extra"),ns=require("path"),sS=require("yaml"),nS=require("properties-reader"),Re=T(),zb=z_(),jb=require("os"),{PACKAGE_ROOT:tu}=T(),rt={notify:7,fatal:6,error:5,warn:4,info:3,debug:2,trace:1},fa=ns.join(tu,"logs"),Mr=process.env.pm_id===void 0,ew=ns.join(tu,"config/yaml/",Re.HDB_DEFAULT_CONFIG_FILE),ru=process.env.PROCESS_NAME===void 0?Re.PROCESS_DESCRIPTORS.INSTALL:process.env.PROCESS_NAME,ks,Zt,lr,tt,j_,xs;xs===void 0&&iS();cS.exports={createLogFile:tw,notify:nw,fatal:iw,error:eu,warn:aw,info:rw,debug:sw,trace:oS,setLogLevel:cw,log_level:tt};function iS(){try{if(xs===void 0){let e=ow();xs=nS(e),{level:tt,config_log_path:j_,to_file:Zt,to_stream:lr}=_w(xs.get("settings_path"))}}catch(e){if(xs=void 0,e.code===Re.NODE_ERROR_CODES.ENOENT){let t=zb(Object.keys(Re.CONFIG_PARAM_MAP),!0);for(let i in t){let o=Re.CONFIG_PARAM_MAP[i];o&&o.toLowerCase();let c=t[i];if(o===Re.CONFIG_PARAMS.LOGGING_LEVEL){tt=c;continue}if(o===Re.CONFIG_PARAMS.LOGGING_STDSTREAMS){lr=c;continue}o===Re.CONFIG_PARAMS.LOGGING_FILE&&(Zt=o)}let{default_level:r,default_to_file:s,default_to_stream:n}=uw();Zt=Zt===void 0?s:Zt,Zt=rS(Zt),lr=lr===void 0?n:lr,lr=rS(lr),tt=tt===void 0?r:tt,j_=fa;return}throw eu("Error initializing log settings"),eu(e),e}}a(iS,"initLogSettings");function tw(e,t){if(!Mr){oS("createLogFile should only be used if the process is not being managed by pm2");return}xs===void 0&&iS(),ru=t;let r;e===Re.PROCESS_LOG_NAMES.INSTALL?r=fa:r=j_,Zt&&(ks=ns.join(r,e),ss.ensureFileSync(ks))}a(tw,"createLogFile");function is(e,t){let r=new Date(Date.now()).toISOString(),s="",n=t.length,i=n-1;for(let o=0;o<n;o++){let c=t[o];c instanceof Error&&c.stack?s+=c.stack:typeof c=="object"?s+=JSON.stringify(c):s+=c,o<i&&(s+=" ")}return`{"process_name": "${ru}", "level": "${e}", "timestamp": "${r}", "message": "${s}"}
`}a(is,"createLogRecord");function aS(e){ks===void 0&&(ru=Re.PROCESS_DESCRIPTORS.INSTALL,ss.ensureDirSync(fa),ks=ns.join(fa,Re.PROCESS_LOG_NAMES.INSTALL),ss.ensureFileSync(ks)),ss.appendFileSync(ks,e)}a(aS,"writeToLogFile");function Ta(e){Zt&&aS(e),lr&&process.stdout.write(e)}a(Ta,"nonPm2LogStdOut");function su(e){Zt&&aS(e),lr&&process.stderr.write(e)}a(su,"nonPm2LogStdErr");function rw(...e){if(rt[tt]<=rt.info){let t=is("info",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(rw,"info");function oS(...e){if(rt[tt]<=rt.trace){let t=is("trace",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(oS,"trace");function eu(...e){if(rt[tt]<=rt.error){let t=is("error",e);if(Mr){su(t);return}process.stderr.write(t)}}a(eu,"error");function sw(...e){if(rt[tt]<=rt.debug){let t=is("debug",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(sw,"debug");function nw(...e){if(rt[tt]<=rt.notify){let t=is("notify",e);if(Mr){Ta(t);return}process.stdout.write(t)}}a(nw,"notify");function iw(...e){if(rt[tt]<=rt.fatal){let t=is("fatal",e);if(Mr){su(t);return}process.stderr.write(t)}}a(iw,"fatal");function aw(...e){if(rt[tt]<=rt.warn){let t=is("warn",e);if(Mr){su(t);return}process.stderr.write(t)}}a(aw,"warn");function ow(){let e;try{e=jb.homedir()}catch{e=process.env.HOME}e||(e="~/");let t=ns.join(e,Re.HDB_HOME_DIR_NAME,Re.BOOT_PROPS_FILE_NAME);return ss.existsSync(t)||(t=ns.join(tu,"utility/hdb_boot_properties.file")),t}a(ow,"getPropsFilePath");function cw(e){tt=e}a(cw,"setLogLevel");function rS(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(rS,"autoCastBoolean");function _w(e){try{if(e.includes("config/settings.js")){let o=nS(e);return{level:o.get(Re.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY),config_log_path:ns.dirname(o.get(Re.HDB_SETTINGS_NAMES.LOG_PATH_KEY)),to_file:o.get(Re.HDB_SETTINGS_NAMES.LOG_TO_FILE),to_stream:o.get(Re.HDB_SETTINGS_NAMES.LOG_TO_STDSTREAMS)}}let t=sS.parseDocument(ss.readFileSync(e,"utf8")),r=t.getIn(["logging","level"]),s=t.getIn(["logging","root"]),n=t.getIn(["logging","file"]),i=t.getIn(["logging","stdStreams"]);return{level:r,config_log_path:s,to_file:n,to_stream:i}}catch(t){if(t.code===Re.NODE_ERROR_CODES.ENOENT)throw t;console.error("Error accessing config file for logging"),console.error(t)}}a(_w,"getLogConfig");function uw(){try{let e=sS.parseDocument(ss.readFileSync(ew,"utf8")),t=e.getIn(["logging","level"]),r=e.getIn(["logging","file"]),s=e.getIn(["logging","stdStreams"]);return{default_level:t,default_to_file:r,default_to_stream:s}}catch(e){console.error("Error accessing default config file for logging"),console.error(e)}}a(uw,"getDefaultConfig")});var uS=h((s1,_S)=>{"use strict";var lw=require("util"),Ew=require("path"),dw=require("child_process"),Sw=lw.promisify(dw.execFile),hw=1e3*1e3*10;_S.exports={findPs:fw};async function fw(e){let t={};try{await Promise.all(["comm","args","ppid","uid","%cpu","%mem"].map(async r=>{let{stdout:s}=await Sw("ps",["wwxo",`pid,${r}`],{maxBuffer:hw});for(let n of s.trim().split(`
`).slice(1)){n=n.trim();let[i]=n.split(" ",1),o=n.slice(i.length+1).trim();t[i]===void 0&&(t[i]={}),t[i][r]=o}}))}catch(r){throw r}return Object.entries(t).filter(([,r])=>r.comm&&r.args&&r.ppid&&r.uid&&r["%cpu"]&&r["%mem"]&&r.args.includes(e)).map(([r,s])=>({pid:Number.parseInt(r,10),name:Ew.basename(s.comm),cmd:s.args,ppid:Number.parseInt(s.ppid,10),uid:Number.parseInt(s.uid,10),cpu:Number.parseFloat(s["%cpu"]),memory:Number.parseFloat(s["%mem"])}))}a(fw,"findPs")});var Ye=h((n1,ES)=>{"use strict";var Tw="__dbis__",mw="__environment_name__",Rw="__dbi_defintion__",Aw={EQUALS:"equals",STARTS_WITH:"startsWith",_STARTS_WITH:"starts_with",ENDS_WITH:"endsWith",_ENDS_WITH:"ends_with",CONTAINS:"contains",SEARCH_ALL:"searchAll",SEARCH_ALL_TO_MAP:"searchAllToMap",BATCH_SEARCH_BY_HASH:"batchSearchByHash",BATCH_SEARCH_BY_HASH_TO_MAP:"batchSearchByHashToMap",GREATER_THAN:"greaterThan",_GREATER_THAN:"greater_than",GREATER_THAN_EQUAL:"greaterThanEqual",_GREATER_THAN_EQUAL:"greater_than_equal",LESS_THAN:"lessThan",_LESS_THAN:"less_than",LESS_THAN_EQUAL:"lessThanEqual",_LESS_THAN_EQUAL:"less_than_equal",BETWEEN:"between"},Ow=["__createdtime__","__updatedtime__"],pw="\uFFFF",lS={TIMESTAMP:"timestamp",HASH_VALUE:"hash_value",USER_NAME:"user_name"},Nw=Object.values(lS);ES.exports={INTERNAL_DBIS_NAME:Tw,DBI_DEFINITION_NAME:Rw,SEARCH_TYPES:Aw,TIMESTAMP_NAMES:Ow,MAX_SEARCH_KEY_LENGTH:256,ENVIRONMENT_NAME_KEY:mw,TRANSACTIONS_DBI_NAMES_ENUM:lS,TRANSACTIONS_DBIS:Nw,OVERFLOW_MARKER:pw}});var st=h((i1,OS)=>{"use strict";var dS=T(),SS=Ye(),hS={CONTINUE:100,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,REQUEST_TIMEOUT:408,CONFLICT:409,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,INSUFFICIENT_STORAGE:507,NETWORK_AUTHENTICATION_REQUIRED:511},fS=a(e=>`${e} Check logs and try again.`,"CHECK_LOGS_WRAPPER"),TS={500:fS("There was an error processing your request."),400:"Invalid request"},gw=TS[hS.INTERNAL_SERVER_ERROR],Iw={OP_NOT_SUPPORTED_FOR_FS:e=>`${e} is not available for this instance because it uses the File System data store.`,MISSING_VALUE:e=>`${e} is missing.`,INVALID_VALUE:e=>`${e} is invalid.`,NOT_FOUND:e=>`${e} not found.`},Cw={CONFIG_VALIDATION:e=>`HarperDB config file validation error: ${e}`},bw={DEFAULT_BULK_LOAD_ERR:"There was an error during your bulk load into HarperDB.",DOWNLOAD_FILE_ERR:e=>`There was an error downloading '${e}'.`,INSERT_JSON_ERR:"There was an error inserting the downloaded JSON data.",INSERT_CSV_ERR:"There was an error inserting the downloaded CSV data.",INVALID_ACTION_PARAM_ERR:e=>`Bulk load operation failed - ${e} is not a valid 'action' parameter`,INVALID_FILE_EXT_ERR:e=>`Error selecting correct parser - valid file type not found in json - ${e}`,MAX_FILE_SIZE_ERR:(e,t)=>`File size is ${e} bytes, which exceeded the maximum size allowed of: ${t} bytes`,PAPA_PARSE_ERR:"There was an error parsing the downloaded CSV data.",S3_DOWNLOAD_ERR:e=>`There was an error downloading '${e}' from AWS.`,WRITE_TEMP_FILE_ERR:"Error writing temporary file to storage"},ww={BASE_PATH_REQUIRED:"base_path is required",DESTINATION_PATH_REQUIRED:"destination_path is required",ENV_NAME_REQUIRED:"env_name is required",INVALID_BASE_PATH:"invalid base_path",INVALID_DESTINATION_PATH:"invalid destination_path",INVALID_ENVIRONMENT:"invalid environment",ENV_REQUIRED:"env is required",DBI_NAME_REQUIRED:"dbi_name is required",DBI_DOES_NOT_EXIST:"dbi does not exist",HASH_ATTRIBUTE_REQUIRED:"hash_attribute is required",ID_REQUIRED:"id is required",IDS_REQUIRED:"ids is required",IDS_MUST_BE_ARRAY:"ids must be an array",FETCH_ATTRIBUTES_REQUIRED:"fetch_attributes is required",FETCH_ATTRIBUTES_MUST_BE_ARRAY:"fetch_attributes must be an array",ATTRIBUTE_REQUIRED:"attribute is required",SEARCH_VALUE_REQUIRED:"search_value is required",SEARCH_VALUE_TOO_LARGE:"search_value is too long",WRITE_ATTRIBUTES_REQUIRED:"write_attributes is required",WRITE_ATTRIBUTES_MUST_BE_ARRAY:"write_attributes must be an array",RECORDS_REQUIRED:"records is required",RECORDS_MUST_BE_ARRAY:"records must be an array",CANNOT_CREATE_INTERNAL_DBIS_NAME:`cannot create a dbi named ${SS.INTERNAL_DBIS_NAME}`,CANNOT_DROP_INTERNAL_DBIS_NAME:`cannot drop a dbi named ${SS.INTERNAL_DBIS_NAME}`,START_VALUE_REQUIRED:"start_value is required",END_VALUE_REQUIRED:"end_value is required",CANNOT_COMPARE_STRING_TO_NUMERIC_KEYS:"cannot compare a string to numeric keys",END_VALUE_MUST_BE_GREATER_THAN_START_VALUE:"end_value must be greater than or equal to start_value",UNKNOWN_SEARCH_TYPE:"unknown search type",CANNOT_DROP_TABLE_HASH_ATTRIBUTE:"cannot drop a table's hash attribute"},Lw={ATTR_NAME_LENGTH_ERR:e=>`transaction aborted due to attribute name ${e} being too long. Attribute names cannot be longer than ${dS.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes.`,ATTR_NAME_NULLISH_ERR:"transaction aborted due to record(s) with an attribute name that is null, undefined or empty string",HASH_VAL_LENGTH_ERR:`transaction aborted due to record(s) with a hash value that exceeds ${dS.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes, check log for more info`,INVALID_FORWARD_SLASH_IN_HASH_ERR:"transaction aborted due to record(s) with a hash value that contains a forward slash, check log for more info",RECORD_MISSING_HASH_ERR:"transaction aborted due to record(s) with no hash value, check log for more info"},mS={GENERIC_AUTH_FAIL:"Login failed",USER_INACTIVE:"Cannot complete request: User is inactive",INVALID_TOKEN:"invalid token",NO_ENCRYPTION_KEYS:"unable to generate JWT as there are no encryption keys.  please contact your administrator",INVALID_CREDENTIALS:"invalid credentials",PASSWORD_REQUIRED:"password is required",USERNAME_REQUIRED:"username is required",REFRESH_TOKEN_REQUIRED:"refresh_token is required",INVALID_AUTH_OBJECT:"invalid auth_object",INVALID_BODY:"invalid body",TOKEN_EXPIRED:"token expired",REFRESH_TOKEN_SAVE_FAILED:"unable to store refresh_token"},Uw={DEFAULT_INVALID_REQUEST:"Invalid request",OP_AUTH_PERMS_ERROR:"This operation is not authorized due to role restrictions and/or invalid schema items",OP_IS_SU_ONLY:e=>`Operation '${e}' is restricted to 'super_user' roles`,OP_NOT_FOUND:e=>`Operation '${e}' not found`,SYSTEM_TIMESTAMP_PERMS_ERR:"Internal timestamp attributes - '__createdtime_' and '__updatedtime__' - cannot be inserted to or updated by HDB users.",UNKNOWN_OP_AUTH_ERROR:(e,t,r)=>`There was an error authorizing ${e} op on table '${t}.${r}'`,USER_HAS_NO_PERMS:e=>`User ${e} has no role or permissions.  Please assign the user a valid role.`,DROP_SYSTEM:"The 'system' schema, tables and records are used internally by HarperDB and cannot be updated or removed."},yw={ATTR_PERM_MISSING:(e,t)=>`${e.toUpperCase()} attribute permission missing for '${t}'`,ATTR_PERM_MISSING_NAME:"Permission object in 'attribute_permission' missing an 'attribute_name'",ATTR_PERM_NOT_BOOLEAN:(e,t)=>`${e.toUpperCase()} attribute permission for '${t}' must be a boolean`,ATTR_PERMS_ARRAY_MISSING:"Missing 'attribute_permissions' array",ATTR_PERMS_NOT_ARRAY:"Value for 'attribute_permissions' must be an array",INVALID_ATTRIBUTE_IN_PERMS:e=>`Invalid attribute '${e}' in 'attribute_permissions'`,INVALID_PERM_KEY:e=>`Invalid table permission key value '${e}'`,INVALID_ATTR_PERM_KEY:e=>`Invalid attribute permission key value '${e}'`,INVALID_ROLE_JSON_KEYS:e=>`Invalid ${e.length>1?"keys":"key"} in JSON body - '${e.join("', '")}'`,MISMATCHED_TABLE_ATTR_PERMS:e=>`You have a conflict with TABLE permissions for '${e}' being false and ATTRIBUTE permissions being true`,OUTDATED_PERMS_TRANSLATION_ERROR:"This instance was recently upgraded and uses our new role permissions structure. Please login to this instance in HarperDB Studio, go to 'Roles', and click 'Update Role Permission' for all standard roles to migrate them to the new structure.",ROLE_ALREADY_EXISTS:e=>`A role with name '${e}' already exists`,ROLE_NOT_FOUND:"Role not found",ROLE_PERMS_ERROR:"Errors in the role permissions JSON provided",SCHEMA_PERM_ERROR:e=>`Your role does not have permission to view schema metadata for '${e}'`,SCHEMA_TABLE_PERM_ERROR:(e,t)=>`Your role does not have permission to view schema.table metadata for '${e}.${t}'`,SU_ROLE_MISSING_ERROR:"Missing 'super_user' key/value in permission set",SU_CU_ROLE_BOOLEAN_ERROR:e=>`Value for '${e}' permission must be a boolean`,STRUCTURE_USER_ROLE_TYPE_ERROR:e=>`Value for '${e}' permission must be a boolean or Array`,SU_CU_ROLE_NO_PERMS_ALLOWED:e=>`Roles with '${e}' set to true cannot have other permissions set.`,SU_CU_ROLE_COMBINED_ERROR:"Roles cannot have both 'super_user' and 'cluster_user' values included in their permissions set.",TABLE_PERM_MISSING:e=>`Missing table ${e.toUpperCase()} permission`,TABLE_PERM_NOT_BOOLEAN:e=>`Table ${e.toUpperCase()} permission must be a boolean`},Dw={ATTR_NOT_FOUND:(e,t,r)=>`Attribute '${r}' does not exist on '${e}.${t}'`,ATTR_EXISTS_ERR:(e,t,r)=>`Attribute '${r}' already exists in ${e}.${t}'`,DESCRIBE_ALL_ERR:"There was an error during describeAll.  Please check the logs and try again.",INVALID_TABLE_ERR:e=>`Invalid table ${JSON.stringify(e)}`,SCHEMA_NOT_FOUND:e=>`Schema '${e}' does not exist`,SCHEMA_EXISTS_ERR:e=>`Schema '${e}' already exists`,TABLE_EXISTS_ERR:(e,t)=>`Table '${t}' already exists in schema '${e}'`,SCHEMA_REQUIRED_ERR:"schema is required",TABLE_NOT_FOUND:(e,t)=>`Table '${e}.${t}' does not exist`,TABLE_REQUIRED_ERR:"table is required"},Mw={OUTER_JOIN_TRANSLATION_ERROR:"There was an error translating the final SQL outer join data."},Pw={ALTER_USER_DUP_ROLES:e=>`Update failed.  There are duplicates for the '${e}' role which is not allowed. Update your roles and try again.`,ALTER_USER_ROLE_NOT_FOUND:e=>`Update failed.  Requested '${e}' role not found.`,DUP_ROLES_FOUND:e=>`Multiple ${e} roles found.  Roles must have unique 'role' value. Please update and try again.`,ROLE_NAME_NOT_FOUND:e=>`${e} role not found`,USER_ALREADY_EXISTS:e=>`User ${e} already exists`,USER_NOT_EXIST:e=>`User ${e} does not exist`},RS={INVALID_DATE:"Invalid date, must be in ISO-8601 format (YYYY-MM-DD).",SEARCH_CONDITIONS_INVALID_SORT_ATTRIBUTE:e=>`invalid sort attribute '${e}', the attribute must either be the table's hash attribute or an attribute used in conditions.`},AS={INVALID_IPC_DATA_TYPE:"Invalid IPC event data type, must be an object",MISSING_TYPE:"IPC event missing 'type'",MISSING_MSG:"IPC event missing 'message'",MISSING_ORIGIN:"IPC event message missing 'originator' property",INVALID_EVENT:e=>`IPC server received invalid event type: ${e}`},Bw={FUNCTION_STATUS:"Error getting custom function status, check the log for more details",GET_FUNCTIONS:"Error getting custom functions, check the log for more details",GET_FUNCTION:"Error getting custom function, check the log for more details",SET_FUNCTION:"Error setting custom function, check the log for more details",NO_PROJECT:"Project does not exist. Create one using 'add_custom_function_project'",PROJECT_EXISTS:"Project already exists",VALIDATION_ERR:"Error validating request, check the log for more details",NO_FILE:"File does not exist",BAD_FILE_NAME:"File name can only contain alphanumeric, dash and underscore characters",BAD_PROJECT_NAME:"Project name can only contain alphanumeric, dash and underscores characters",BAD_PACKAGE:"Packaged project must be base64-encoded tar file of project directory",DROP_FUNCTION:"Error dropping custom function, check the log for more details",ADD_FUNCTION:"Error adding custom function project, check the log for more details",DROP_FUNCTION_PROJECT:"Error dropping custom function project, check the log for more details",BAD_FILE_PATH:"Filepath must be valid, and contain the name of the tarball you wish to write",NOT_ENABLED:"Custom functions is not enabled, to enable set customFunctions enabled to true in hdb/harperdb-config.yaml file."},vw={CLUSTERING_NOT_ENABLED:"Clustering must be enabled to perform this operation."},Hw={...mS,...bw,...Iw,...Uw,...yw,...Dw,...Mw,...Pw,...Lw,...RS,...AS,...Bw,...vw,...Cw};OS.exports={CHECK_LOGS_WRAPPER:fS,HDB_ERROR_MSGS:Hw,DEFAULT_ERROR_MSGS:TS,DEFAULT_ERROR_RESP:gw,HTTP_STATUS_CODES:hS,LMDB_ERRORS_ENUM:ww,AUTHENTICATION_ERROR_MSGS:mS,VALIDATION_ERROR_MSGS:RS,IPC_ERRORS:AS}});var D=h((a1,gS)=>{"use strict";var $s=st(),Gw=I(),qw=T(),$n=class extends Error{constructor(t,r,s,n,i){super(),Error.captureStackTrace(this,pS),this.http_resp_code=s||$s.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,this.http_resp_msg=r||($s.DEFAULT_ERROR_MSGS[s]?$s.DEFAULT_ERROR_MSGS[s]:$s.DEFAULT_ERROR_MSGS[$s.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR]),this.message=t.message?t.message:this.http_resp_msg,this.type=t.name,typeof this.message!="string"&&(this.stack=t.stack),i&&Gw[n](i)}};a($n,"HdbError");function pS(e,t,r,s=qw.LOG_LEVELS.ERROR,n=null,i=!1){if(NS(e))return e;let o=new $n(e,t,r,s,n);return i&&delete o.stack,o}a(pS,"handleHDBError");function NS(e){return e.__proto__.constructor.name===$n.name}a(NS,"isHDBError");gS.exports={isHDBError:NS,handleHDBError:pS,hdb_errors:$s}});var C=h((c1,qS)=>{"use strict";var nu=require("path"),Fw=require("fs-extra"),Ce=I(),IS=require("fs-extra"),Vw=require("truncate-utf8-bytes"),Yn=require("os"),kw=require("net"),xw=require("recursive-iterator"),Ue=T(),US=uS(),CS=require("papaparse"),ma=require("moment"),{inspect:$w}=require("util"),bS=require("is-number"),o1=require("lodash"),{hdb_errors:Ra}=D(),yS=require("util").promisify(setTimeout),Yw=100,Kw=5,Qw="",Ww=4,wS=255,LS={true:!0,false:!1,undefined:null,null:null,NaN:NaN};qS.exports={isEmpty:St,isEmptyOrZeroLength:Xt,arrayHasEmptyValues:Xw,arrayHasEmptyOrZeroLengthValues:zw,buildFolderPath:jw,isBoolean:DS,errorizeMessage:Jw,stripFileExtension:tL,autoCast:rL,autoCastJSONDeep:iu,removeDir:nL,compareVersions:iL,isCompatibleDataVersion:aL,escapeRawValue:PS,unescapeValue:oL,stringifyProps:cL,valueConverter:_L,timeoutPromise:lL,isClusterOperation:dL,getClusterUser:fL,sendTransactionToSocketCluster:SL,checkGlobalSchemaTable:hL,getHomeDir:BS,getPropsFilePath:uL,promisifyPapaParse:TL,removeBOM:vS,createEventPromise:mL,checkProcessRunning:RL,checkSchemaTableExist:AL,checkSchemaExists:HS,checkTableExists:GS,getStartOfTomorrowInSeconds:OL,getLimitKey:pL,isObject:eL,isNotEmptyAndHasValue:Zw,autoCasterIsNumberCheck:MS,backtickASTSchemaItems:NL,isPortTaken:EL,stopProcess:gL,createForkArgs:IL,autoCastBoolean:CL,async_set_timeout:yS,getTableHashAttribute:bL,doesSchemaExist:wL,doesTableExist:LL,stringifyObj:UL,ms_to_time:yL,PACKAGE_ROOT:Ue.PACKAGE_ROOT};function Jw(e){return e instanceof Error?e:new Error(e)}a(Jw,"errorizeMessage");function St(e){return e==null}a(St,"isEmpty");function Zw(e){return!St(e)&&(e||e===0||e===""||DS(e))}a(Zw,"isNotEmptyAndHasValue");function Xt(e){return St(e)||e.length===0||e.size===0}a(Xt,"isEmptyOrZeroLength");function Xw(e){if(St(e))return!0;for(let t=0;t<e.length;t++)if(St(e[t]))return!0;return!1}a(Xw,"arrayHasEmptyValues");function zw(e){if(Xt(e))return!0;for(let t=0;t<e.length;t++)if(Xt(e[t]))return!0;return!1}a(zw,"arrayHasEmptyOrZeroLengthValues");function jw(...e){try{return e.join(nu.sep)}catch{console.error(e)}}a(jw,"buildFolderPath");function DS(e){return St(e)?!1:e===!0||e===!1}a(DS,"isBoolean");function eL(e){return St(e)?!1:typeof e=="object"}a(eL,"isObject");function tL(e){return Xt(e)?Qw:e.slice(0,-Ww)}a(tL,"stripFileExtension");function rL(e){return St(e)||e===""||typeof e!="string"?e:LS[e]!==void 0?LS[e]:MS(e)===!0?Number(e):e}a(rL,"autoCast");function sL(e){if(typeof e=="string"&&(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]")))try{return JSON.parse(e)}catch{}return e}a(sL,"autoCastJSON");function iu(e){if(e&&typeof e=="object"){if(Array.isArray(e))for(let t=0,r=e.length;t<r;t++){let s=e[t],n=iu(s);n!==s&&(e[t]=n)}else for(let t in e){let r=e[t],s=iu(r);s!==r&&(e[t]=s)}return e}else return sL(e)}a(iu,"autoCastJSONDeep");function MS(e){if(e.startsWith("0.")&&bS(e))return!0;let t=e.toUpperCase().includes("E");return!!((e!=="0"&&e.startsWith("0"))===!1&&t===!1&&bS(e))}a(MS,"autoCasterIsNumberCheck");async function nL(e){if(Xt(e))throw new Error(`Directory path: ${e} does not exist`);try{await IS.emptyDir(e),await IS.remove(e)}catch(t){throw Ce.error(`Error removing files in ${e} -- ${t}`),t}}a(nL,"removeDir");function iL(e,t){if(Xt(e)){Ce.info("Invalid current version sent as parameter.");return}if(Xt(t)){Ce.info("Invalid upgrade version sent as parameter.");return}let r,s=/(\.0+)+$/,n=e.version?e.version:e,i=t.version?t.version:t,o=n.replace(s,"").split("."),c=i.replace(s,"").split("."),_=Math.min(o.length,c.length);for(let u=0;u<_;u++)if(r=parseInt(o[u],10)-parseInt(c[u],10),r)return r;return o.length-c.length}a(iL,"compareVersions");function aL(e,t,r=!1){let s=e.toString().split("."),n=t.toString().split(".");return s[0]===n[0]&&(!r||s[1]===n[1])}a(aL,"isCompatibleDataVersion");function PS(e){if(St(e))return e;let t=String(e);return t==="."?Ue.UNICODE_PERIOD:t===".."?Ue.UNICODE_PERIOD+Ue.UNICODE_PERIOD:t.replace(Ue.FORWARD_SLASH_REGEX,Ue.UNICODE_FORWARD_SLASH)}a(PS,"escapeRawValue");function oL(e){if(St(e))return e;let t=String(e);return t===Ue.UNICODE_PERIOD?".":t===Ue.UNICODE_PERIOD+Ue.UNICODE_PERIOD?"..":String(e).replace(Ue.ESCAPED_FORWARD_SLASH_REGEX,"/")}a(oL,"unescapeValue");function cL(e,t){if(St(e))return Ce.info("Properties object is null"),"";let r="";return e.each(function(s,n){try{if(t&&t[s]){let i=t[s];for(let o of i)r+=";"+o+Yn.EOL}!Xt(s)&&s[0]===";"?r+="	"+s+n+Yn.EOL:Xt(s)||(r+=s+"="+n+Yn.EOL)}catch{Ce.error(`Found bad property during upgrade with key ${s} and value: ${n}`)}}),r}a(cL,"stringifyProps");function _L(e){let t;try{t=typeof e=="object"?JSON.stringify(e):e}catch(n){Ce.error(n),t=e}let r=String(PS(t)),s=Buffer.byteLength(r)>wS?Vw(r,wS)+"/blob":r;return{value:t,value_stripped:r,value_path:s}}a(_L,"valueConverter");function BS(){let e;try{e=Yn.homedir()}catch{e=process.env.HOME}return e||(e="~/"),e}a(BS,"getHomeDir");function uL(){let e=nu.join(BS(),Ue.HDB_HOME_DIR_NAME,Ue.BOOT_PROPS_FILE_NAME);return Fw.existsSync(e)||(e=nu.join(__dirname,"../","hdb_boot_properties.file")),e}a(uL,"getPropsFilePath");function lL(e,t){let r,s;return s=new Promise(function(n){r=setTimeout(function(){n(t)},e)}),{promise:s,cancel:function(){clearTimeout(r)}}}a(lL,"timeoutPromise");async function EL(e){if(!e)throw new Error("Invalid port passed as parameter");return new Promise((t,r)=>{let s=kw.createServer().once("error",n=>{n.code==="EADDRINUSE"?t(!0):r(n)}).once("listening",()=>s.once("close",()=>t(!1)).close()).listen(e)})}a(EL,"isPortTaken");function dL(e){try{return Ue.CLUSTER_OPERATIONS[e.toLowerCase()]!==void 0}catch(t){Ce.error(`Error checking operation against cluster ops ${t}`)}return!1}a(dL,"isClusterOperation");function SL(e,t,r){if(global.hdb_socket_client!==void 0){Ce.trace(`Sending transaction to channel: ${e}`);let{hdb_user:s,hdb_auth_header:n,...i}=t;i.__originator||(i.__originator={}),i.__transacted=!0,r&&(i.__originator[r]=Ue.ORIGINATOR_SET_VALUE),global.hdb_socket_client.publish(e,i)}}a(SL,"sendTransactionToSocketCluster");function hL(e,t){if(!global.hdb_schema[e])return Ra.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e);if(!global.hdb_schema[e]||!global.hdb_schema[e][t])return Ra.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(hL,"checkGlobalSchemaTable");function fL(e,t){if(St(t)){Ce.warn("No CLUSTERING_USER defined, clustering disabled");return}if(St(e)||Xt(e)){Ce.warn("No users to search.");return}let r;try{let s=e.get(t);s&&s.role.permission.cluster_user===!0&&s.active===!0&&(r=s)}catch(s){Ce.error(`unable to find cluster_user due to: ${s.message}`);return}if(r===void 0){Ce.warn(`CLUSTERING_USER: ${t} not found or is not active.`);return}return r}a(fL,"getClusterUser");function TL(){CS.parsePromise=function(e,t){return new Promise(function(r,s){CS.parse(e,{header:!0,transformHeader:vS,chunk:t.bind(null,s),skipEmptyLines:!0,dynamicTyping:!0,error:s,complete:r})})}}a(TL,"promisifyPapaParse");function vS(e){if(typeof e!="string")throw new TypeError(`Expected a string, got ${typeof e}`);return e.charCodeAt(0)===65279?e.slice(1):e}a(vS,"removeBOM");function mL(e,t,r){return new Promise(s=>{t.once(e,n=>{let i=r;Ce.info(`Got cluster status event response: ${$w(n)}`);try{i.cancel()}catch{Ce.error("Error trying to cancel timeout.")}s(n)})})}a(mL,"createEventPromise");async function RL(e){let t=!0,r=0;do await yS(Yw*r++),(await US.findPs(e)).length>0&&(t=!1);while(t&&r<Kw);if(t)throw new Error(`process ${e} was not started`)}a(RL,"checkProcessRunning");function AL(e,t){let r=HS(e);if(r)return r;let s=GS(e,t);if(s)return s}a(AL,"checkSchemaTableExist");function HS(e){if(!global.hdb_schema[e])return Ra.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(HS,"checkSchemaExists");function GS(e,t){if(!global.hdb_schema[e][t])return Ra.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(GS,"checkTableExists");function OL(){let e=ma().utc().add(1,Ue.MOMENT_DAYS_TAG).startOf(Ue.MOMENT_DAYS_TAG).unix(),t=ma().utc().unix();return e-t}a(OL,"getStartOfTomorrowInSeconds");function pL(){return ma().utc().format("DD-MM-YYYY")}a(pL,"getLimitKey");function NL(e){try{let t=new xw(e);for(let{node:r}of t)r&&(r.columnid&&typeof r.columnid!="string"&&(r.columnid=r.columnid.toString()),r.columnid&&!r.columnid.startsWith("`")&&(r.columnid_orig=r.columnid,r.columnid=`\`${r.columnid}\``),r.tableid&&!r.tableid.startsWith("`")&&(r.tableid_orig=r.tableid,r.tableid=`\`${r.tableid}\``),r.databaseid&&!r.databaseid.startsWith("`")&&(r.databaseid_orig=r.databaseid,r.databaseid=`\`${r.databaseid}\``),r.as&&typeof r.as=="string"&&!r.as.startsWith("[")&&(r.as_orig=r.as,r.as=`\`${r.as}\``))}catch(t){Ce.error("Got an error back ticking items."),Ce.error(t)}}a(NL,"backtickASTSchemaItems");async function gL(e){let t=Yn.userInfo();(await US.findPs(e)).forEach(s=>{(t.uid==0||s.uid==t.uid)&&(process.kill(s.pid),Ce.trace(`Following process was killed by stopProcess: ${s.cmd}`))})}a(gL,"stopProcess");function IL(e){return[e]}a(IL,"createForkArgs");function CL(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(CL,"autoCastBoolean");function bL(e,t){return global.hdb_schema?.[e]?.[t]?.hash_attribute}a(bL,"getTableHashAttribute");function wL(e){return global?.hdb_schema?.[e]!==void 0}a(wL,"doesSchemaExist");function LL(e,t){return global?.hdb_schema?.[e]?.[t]!==void 0}a(LL,"doesTableExist");function UL(e){try{return JSON.stringify(e)}catch{return e}}a(UL,"stringifyObj");function yL(e){let t=ma.duration(e),r=t.seconds()>0?t.seconds()+"s":"",s=t.minutes()>0?t.minutes()+"m ":"",n=t.hours()>0?t.hours()+"h ":"",i=t.days()>0?t.days()+"d ":"";return(t.years()>0?t.years()+"y ":"")+i+n+s+r}a(yL,"ms_to_time")});var as=h((_1,DL)=>{DL.exports={hdb_table:{hash_attribute:"id",name:"hdb_table",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"name"},{attribute:"hash_attribute"},{attribute:"schema"},{attribute:"residence"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_attribute:{hash_attribute:"id",name:"hdb_attribute",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"schema"},{attribute:"table"},{attribute:"attribute"},{attribute:"schema_table"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_schema:{hash_attribute:"name",name:"hdb_schema",schema:"system",residence:["*"],attributes:[{attribute:"name"},{attribute:"createddate"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_user:{hash_attribute:"username",name:"hdb_user",schema:"system",residence:["*"],attributes:[{attribute:"username"},{attribute:"password"},{attribute:"role"},{attribute:"active"},{attribute:"hash"},{attribute:"refresh_token"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_role:{hash_attribute:"id",name:"hdb_role",schema:"system",attributes:[{attribute:"id"},{attribute:"role"},{attribute:"permission"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}],residence:["*"]},hdb_job:{hash_attribute:"id",name:"hdb_job",schema:"system",attributes:[{attribute:"id"},{attribute:"user"},{attribute:"type"},{attribute:"status"},{attribute:"start_datetime"},{attribute:"end_datetime"},{attribute:"message"},{attribute:"created_datetime"},{attribute:"request"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_license:{hash_attribute:"license_key",name:"hdb_license",schema:"system",attributes:[{attribute:"license_key"},{attribute:"company"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_info:{hash_attribute:"info_id",name:"hdb_info",schema:"system",attributes:[{attribute:"info_id"},{attribute:"data_version_num"},{attribute:"hdb_version_num"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_nodes:{hash_attribute:"name",name:"hdb_nodes",schema:"system",attributes:[{attribute:"name"},{attribute:"subscriptions"},{attribute:"system_info"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_temp:{hash_attribute:"id",name:"hdb_temp",schema:"system",attributes:[{attribute:"id"}]}}});var zS=h((l1,XS)=>{"use strict";var au=require("recursive-iterator"),ML=require("alasql"),ou=require("clone"),FS=C(),{handleHDBError:VS,hdb_errors:PL}=D(),{HDB_ERROR_MSGS:kS,HTTP_STATUS_CODES:xS}=PL,BL=["DISTINCT_ARRAY"],$S=Symbol("validateTables"),cu=Symbol("validateTable"),u1=Symbol("getAllColumns"),YS=Symbol("validateAllColumns"),Aa=Symbol("findColumn"),KS=Symbol("validateOrderBy"),Kn=Symbol("validateSegment"),_u=Symbol("validateColumn"),QS=Symbol("setColumnsForTable"),WS=Symbol("checkColumnsForAsterisk"),JS=Symbol("validateGroupBy"),ZS=Symbol("hasColumns"),Oa=class{constructor(t){this.statement=t,this.attributes=[]}validate(){if(!this.statement)throw new Error("invalid sql statement");this[$S](),this[WS](),this[YS]()}[$S](){if(this[ZS]()){if(!this.statement.from||this.statement.from.length===0)throw"no from clause";this.statement.from.forEach(t=>{this[cu](t)}),this.statement.joins&&this.statement.joins.forEach(t=>{t.table.as=t.as,this[cu](t.table)})}}[ZS](){let t=!1,r=new au(this.statement);for(let{node:s,path:n}of r)if(s&&s.columnid){t=!0;break}return t}[cu](t){if(!t.databaseid)throw`schema not defined for table ${t.tableid}`;if(!global.hdb_schema[t.databaseid])throw VS(new Error,kS.SCHEMA_NOT_FOUND(t.databaseid),xS.NOT_FOUND);if(!global.hdb_schema[t.databaseid][t.tableid])throw VS(new Error,kS.TABLE_NOT_FOUND(t.databaseid,t.tableid),xS.NOT_FOUND);global.hdb_schema[t.databaseid][t.tableid].attributes.forEach(s=>{let n=ou(s);n.table=ou(t),this.attributes.push(n)})}[Aa](t){return this.attributes.filter(r=>t.tableid?(r.table.as===t.tableid||r.table.tableid===t.tableid)&&r.attribute===t.columnid:r.attribute===t.columnid)}[WS](){let t=new au(this.statement.columns);for(let{node:r,path:s}of t)r&&r.columnid==="*"&&s.indexOf("expression")<0&&this[QS](r.tableid)}[QS](t){this.attributes.forEach(r=>{(!t||t&&(r.table.tableid===t||r.table.as===t))&&this.statement.columns.push(new ML.yy.Column({columnid:r.attribute,tableid:r.table.as?r.table.as:r.table.tableid}))})}[YS](){this[Kn](this.statement.columns,!1),this[Kn](this.statement.joins,!1),this[Kn](this.statement.where,!1),this[JS](this.statement.group,!1),this[Kn](this.statement.order,!0)}[Kn](t,r){if(!t)return;let s=new au(t),n=[];for(let{node:i,path:o}of s)!FS.isEmpty(i)&&!FS.isEmpty(i.columnid)&&i.columnid!=="*"&&(r?this[KS](i):n.push(this[_u](i)));return n}[JS](t){if(!t)return;let r=[];if(this.statement.columns.forEach(s=>{if(!(s.funcid&&BL.indexOf(s.funcid.toUpperCase())>=0)){if(!s.aggregatorid&&!s.columnid){let n=ou(s);delete n.as,r.push(n)}else if(s.columnid){let n=this[Aa](s)[0];n&&r.push(n)}}}),this.statement.group.forEach(s=>{let n=null;if(!s.columnid)r.forEach((i,o)=>{if(i.toString()===s.toString()){n=i,r.splice(o,1);return}});else{let i=this[Aa](s);if(!i||i.length===0)throw`unknown column '${s.toString()}' in group by`;if(i.length>1)throw`ambiguously defined column '${s.toString()}' in group by`;r.forEach((o,c)=>{if(o.attribute===i[0].attribute&&o.table.tableid===i[0].table.tableid){n=o,r.splice(c,1);return}})}if(!n)throw`group by column '${s.toString()}' must be in select`}),r.length>0)throw`select column '${r[0].attribute?r[0].attribute:r[0].toString()}' must be in group by`}[KS](t){let r=this.statement.columns.filter(s=>s.as===t.columnid);if(r.length>1)throw`ambiguous column reference ${(t.tableid?t.tableid+".":"")+t.columnid} in order by`;r.length===0&&this[_u](t)}[_u](t){let r=this[Aa](t),s=(t.tableid?t.tableid+".":"")+t.columnid;if(r.length===0)throw`unknown column ${s}`;if(r.length>1)throw`ambiguous column reference ${s}`;return r[0]}};a(Oa,"SelectValidator");XS.exports=Oa});var uu=h((E1,jS)=>{"use strict";var pa=class{createSchema(){throw new Error("createSchema bridge method is not defined")}dropSchema(){throw new Error("dropSchema bridge method is not defined")}createTable(){throw new Error("createTable bridge method is not defined")}dropTable(){throw new Error("dropTable bridge method is not defined")}createRecords(){throw new Error("createRecords bridge method is not defined")}updateRecords(){throw new Error("updateRecords bridge method is not defined")}async upsertRecords(){throw new Error("upsertRecords bridge method is not defined")}deleteRecords(){throw new Error("deleteRecords bridge method is not defined")}createAttribute(){throw new Error("createAttribute bridge method is not defined")}dropAttribute(){throw new Error("dropAttribute bridge method is not defined")}searchByConditions(){throw new Error("searchByConditions bridge method is not defined")}searchByHash(){throw new Error("searchByHash bridge method is not defined")}searchByValue(){throw new Error("searchByValue bridge method is not defined")}getDataByHash(){throw new Error("getDataByHash bridge method is not defined")}getDataByValue(){throw new Error("getDataByValue bridge method is not defined")}deleteRecordsBefore(){throw new Error("deleteRecordsBefore bridge method is not defined")}deleteAuditLogsBefore(){throw new Error("deleteAuditLogsBefore bridge method is not defined")}async readAuditLog(){throw new Error("readAuditLog bridge method is not defined")}};a(pa,"BridgeMethods");jS.exports=pa});var os=h((h1,sh)=>{"use strict";var eh=st().LMDB_ERRORS_ENUM,d1=require("lmdb"),vL=Ye(),S1=require("buffer").Buffer,HL=require("microtime"),{OVERFLOW_MARKER:th,MAX_SEARCH_KEY_LENGTH:Na}=vL,rh=["number","string","symbol","boolean","bigint"];function GL(e){if(!e)throw new Error(eh.ENV_REQUIRED);if(e.constructor.name!=="LMDBStore")throw new Error(eh.INVALID_ENVIRONMENT)}a(GL,"validateEnv");function qL(e){if(e==null)return null;let t;try{t=typeof e=="object"?JSON.stringify(e):e.toString()}catch{t=e.toString()}return t}a(qL,"stringifyData");function FL(e){return e instanceof Date?e.valueOf():e}a(FL,"convertKeyValueToWrite");function VL(e){if(e==null)return;if(rh.includes(typeof e))return e.length>Na?[e.slice(0,Na)+th]:[e];let t;if(Array.isArray(e)){t=[];for(let r=0,s=e.length;r<s;r++){let n=e[r];rh.includes(typeof n)&&(n.length>Na?t.push(n.slice(0,Na)+th):t.push(n))}}return t}a(VL,"getIndexedValues");function kL(){let e=HL.now().toString(),t=e.length-3;return Number(e.slice(0,t)+"."+e.slice(t))}a(kL,"getMicroTime");sh.exports={validateEnv:GL,stringifyData:qL,convertKeyValueToWrite:FL,getMicroTime:kL,getIndexedValues:VL}});var ih=h((f1,nh)=>{"use strict";var ga=class{constructor(t=!1,r=!1){this.dup_sort=t,this.is_hash_attribute=r,this.useVersions=r}};a(ga,"DBIDefinition");nh.exports=ga});var oh=h((T1,ah)=>{"use strict";var Ia=class{constructor(t,r=!1){this.dupSort=t===!0,this.encoding=t?"ordered-binary":"msgpack",this.useVersions=r,this.sharedStructuresKey=Symbol.for("structures"),r&&(this.cache={validated:!0},this.randomAccessStructure=!0,this.freezeData=!0)}};a(Ia,"OpenDBIObject");ah.exports=Ia});var _h=h((m1,ch)=>{"use strict";var Ca=class{constructor(t,r,s,n,i=!1,o=!1,c=void 0){this.path=t,this.mapSize=r,this.maxDbs=s,this.maxReaders=n,this.sharedStructuresKey=Symbol.for("structures"),this.readOnly=i,this.trackMetrics=!0,this.noSync=o,c!==void 0&&(this.overlappingSync=c)}};a(Ca,"OpenEnvironmentObject");ch.exports=Ca});var lh=h((R1,uh)=>{"use strict";var xL={key:"-----BEGIN RSA PRIVATE KEY-----\rMIIEowIBAAKCAQEArBFJQRfFiJku/KwhV1Ssp7cX61vvuKmd4Rp6A9jB2QLgx8nj\r/+Xhp2hPRkISnOA8BuAxr4dMD9syGJwX4kNy9mbZ5Q0fWZCiEGBpVcU1J+k+N5K4\rSuZ2SqgxeN2IN2RLzt3GyQY4imcdHgNv7aHoXUrEwBx0MeYEw3IIDXtrYKCR2D8I\rvWBfwMUgWa24G8lpWILWA5hd9srRz9NxlAiHSjhbgT7B0xruEpHRCHSyKjvaIJVt\rWBR+amejYsAKVrD/hgrqjsA1123Y6++YqvU6vwg64xhS2kz5r3dkNKhvwbWgpZdI\rIaRvsiB77f4kLGo0vi8RFgJ1ZRjGg3RRK2w1LQIDAQABAoIBAQCEOmh78EOpnGZC\rYBjjHrvrysVD5gvLcfVUtl8Ls7gMB60re1eOIF+PoZZCHKZnDd6zPfiQtj1adg0C\rYnnsM/8VoaZS4gm0b3RLd3ubIQifWhuo40RissY2yxfxlPSH9LhZCY8ojnJG0cTL\resK579E8WCfopjUY33XLqEbN7Ylv39J+DSqInjqV3efJZUa+HqUJ98VxxzodcKMD\rP3bwUU4gHoSSp4pAsOFH5sQhaIWH1IcNjrAwpee2cJQuh4G157RRIuuUpagtaEG/\rXJIiAyBguJyu3JQFnIBQF01N5+omJgXYJ1L0m54543/iIRThmF3zDCDgCyUzmOk+\rH6As9fv1AoGBANOpOtOZLSAScjGsgJamT3ceJ2wCa86g2j8Oxu8lJUmUp5s3tA0v\rBFW5O3S4KR1EXwkLMBUMrfFM8YvzHWxsXBI6XV8azGLvyqPHxr65OhmpGYkGZMXu\rn9okgjkqlewnY2I073gvyK7ppX51UL5y9fF1vlsk+UlW+Rgx/vMHbdcjAoGBANAc\rxRUsxs4QJpbS4zD3JOkHjr24a97TrS3kCybAHUMpR2NrEHPZw9zex0/aphOJUHfL\rIMkOZdpfDqMfxWy4FAEmqBEMkO2SB+h0Wp4P+qp81ax4vGFiB0cD3wtixr11U1tt\rlZ/ZTdv4VDpDFNK1KaplhTDeyuCjeYfS3/GJia9vAoGAcOsAgjBevZR5rXx84WH6\rVO8WUu37u7FenXNxt9VWTinrPMh72uixZFY8nOk+rely1e1NCn3IMko9Ns9NbDFm\r8SaH95vhXArXTYbfxZIlp9jp0YtCqcHDL+p4Oq04bFMbFyJseu7rHj1x18QYfnHw\rOY/6LL/N6k1m+Hx7qgXVmIcCgYB/w0nTCBw84XlvWqSTqQaF8VfWbWP79mP5KmkW\rLxdH5g2noVEGbohqDnK6OXd/wusdwByukiJBf94Skyy25AOT+VFwthA7aU1ljhkb\rtJ+lDuJ28eBkwLPLCzthWBC+u0qjdJFJAzVjd/7tjcU43nNn4s90AzL12iaAFhvZ\rwyA+DQKBgGc/4cdyGJ3YkcA8150gQBawgJZ7q8V1JND87ggWA8wnK3cHn7rMZQl2\r3emDp9HEFXFex5dbGDDqZFAoesZCDxjknIn9oNfW4PvaWS8q7b6ZKLZG1p03Pu7/\rtYaD0kPbo0kysfFT/co+NgHbdykvIyboomfGdNLTUjYuy6lpwpvs\r-----END RSA PRIVATE KEY-----\r".replace(/\r/g,String.fromCharCode(13,10)),cert:"-----BEGIN CERTIFICATE-----\rMIIDXDCCAkSgAwIBAgIFNTE4MzQwDQYJKoZIhvcNAQELBQAwXTEXMBUGA1UEAxMO\rSGFycGVyREIsIEluYy4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDTzEPMA0GA1UE\rBxMGRGVudmVyMRcwFQYDVQQKEw5IYXJwZXJEQiwgSW5jLjAeFw0yMjAzMTEyMzAz\rNDlaFw0yNzAzMTAyMzAzNDlaMF0xFzAVBgNVBAMTDkhhcnBlckRCLCBJbmMuMQsw\rCQYDVQQGEwJVUzELMAkGA1UECBMCQ08xDzANBgNVBAcTBkRlbnZlcjEXMBUGA1UE\rChMOSGFycGVyREIsIEluYy4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB\rAQCsEUlBF8WImS78rCFXVKyntxfrW++4qZ3hGnoD2MHZAuDHyeP/5eGnaE9GQhKc\r4DwG4DGvh0wP2zIYnBfiQ3L2ZtnlDR9ZkKIQYGlVxTUn6T43krhK5nZKqDF43Yg3\rZEvO3cbJBjiKZx0eA2/toehdSsTAHHQx5gTDcggNe2tgoJHYPwi9YF/AxSBZrbgb\ryWlYgtYDmF32ytHP03GUCIdKOFuBPsHTGu4SkdEIdLIqO9oglW1YFH5qZ6NiwApW\rsP+GCuqOwDXXbdjr75iq9Tq/CDrjGFLaTPmvd2Q0qG/BtaCll0ghpG+yIHvt/iQs\rajS+LxEWAnVlGMaDdFErbDUtAgMBAAGjIzAhMA8GA1UdEwEB/wQFMAMBAf8wDgYD\rVR0PAQH/BAQDAgIEMA0GCSqGSIb3DQEBCwUAA4IBAQASR4YW/rPK7PNArHVe9zzM\rb0rKNX/2T9/0nybRhmE/+hdlSgliTAeebmwkUS2APckmekYt/q2ZY2NS65Fo/jjp\rG8TJrtcF4h+ylVqUp0ZXQLFtIsr7r2JZA7hJ6njW6G4DHSZ0gxtECLi4CBlTjzm5\rNmnmIDObvGRTuqmcdAZmXeObbta/He2XIzietukPAYX062pNM+G5XT5UM1eG/Vlp\rN86vjhpyI+ffKy+C60SJqxmKM3ydgN7oLscE7+2wLPN25XqN4W99OwGsp5dTdu/f\r5lPtFayXdJ55e/sNQKmGN+UGLrL05c2MWgjb8U/LFilnupUianceoeSERZmVjzKX\r-----END CERTIFICATE-----\r".replace(/\r/g,String.fromCharCode(13,10))},$L="certificate.pem",YL="privateKey.pem",KL="ca.pem";uh.exports={CERTIFICATE_VALUES:xL,CERTIFICATE_PEM_NAME:$L,PRIVATEKEY_PEM_NAME:YL,CA_PEM_NAME:KL}});var de=h((A1,Eh)=>{"use strict";var nt=require("validate.js");nt.validators.type=function(e,t,r,s){return e===null||typeof e>"u"||nt.validators.type.checks[t](e)?null:` must be a '${t}' value`};nt.validators.type.checks={Object:function(e){return nt.isObject(e)&&!nt.isArray(e)},Array:nt.isArray,Integer:nt.isInteger,Number:nt.isNumber,String:nt.isString,Date:nt.isDate,Boolean:function(e){return typeof e=="boolean"}};nt.validators.hasValidFileExt=function(e,t){return!nt.isString(e)||e===""||t.filter(r=>e.endsWith(r)).length>0?null:`must include one of the following valid file extensions - '${t.join("', '")}'`};Eh.exports={validateObject:QL,validateObjectAsync:WL,validateBySchema:JL};function QL(e,t){if(!e||!t)return new Error("validateObject parameters were null");let r=nt(e,t,{format:"flat"});return r?new Error(r):null}a(QL,"validateObject");async function WL(e,t){if(!e||!t)return new Error("validateObject parameters were null");try{await nt.async(e,t,{format:"flat"})}catch(r){let s=r.join(",");return new Error(s)}return null}a(WL,"validateObjectAsync");function JL(e,t){let r=t.validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}});if(r.error)return new Error(r.error.message)}a(JL,"validateBySchema")});var Eu=h((O1,Sh)=>{"use strict";var ZL=require("fs-extra"),F=require("joi"),XL=require("os"),{boolean:ye,string:dr,number:zt,array:lu}=F.types(),qt=require("path"),zL=I(),ba=C(),Sr=lh(),jL=de(),Er="keys",eU=Sr.CERTIFICATE_PEM_NAME,tU=Sr.PRIVATEKEY_PEM_NAME,rU=Sr.CA_PEM_NAME,sU=Sr.CERTIFICATE_PEM_NAME,nU=Sr.PRIVATEKEY_PEM_NAME,iU=Sr.CA_PEM_NAME,aU=Sr.CERTIFICATE_PEM_NAME,oU=Sr.PRIVATEKEY_PEM_NAME,cU=Sr.CA_PEM_NAME,_U="log",uU="custom_functions",lU="Invalid logging.rotation.maxSize unit. Available units are G, M or K",EU="Invalid logging.rotation.maxSize value. Value should be a number followed by unit e.g. '10M'",dU="rootPath config parameter is undefined",SU="clustering.enabled config parameter is undefined",Pr=zt.min(0).required(),wa=lu.items({host:dr.required(),port:Pr}).empty(null),it;Sh.exports={configValidator:hU,routesValidator:AU,route_constraints:wa};function hU(e){if(it=e.rootPath,ba.isEmpty(it))throw dU;let t=ye.required(),r=F.valid("production","development").required(),s=zt.min(1).max(1e3).empty(null).default(RU),n=dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").empty(null).default(dh),i=F.custom(TU).messages({"any.custom":"{:#label} {:#error}"}).empty(null).default(dh),o=dr.pattern(/^[^\s.,*>]+$/).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >"}).empty(null),c=e.clustering?.enabled;if(ba.isEmpty(c))throw SU;let _;return c===!0?_=F.object({enabled:t,hubServer:F.object({cluster:F.object({name:F.required().empty(null),network:F.object({port:Pr,routes:wa}).required()}).required(),leafNodes:F.object({network:F.object({port:Pr}).required()}).required(),network:F.object({port:Pr}).required()}).required(),leafServer:F.object({network:F.object({port:Pr,routes:wa}).required()}).required(),nodeName:o,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i,insecure:ye.required()}),user:F.string().required()}).required():_=F.object({enabled:t,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i,insecure:ye.required()})}).required(),F.object({clustering:_,customFunctions:F.object({enabled:t,network:F.object({cors:ye.required(),corsAccessList:lu.required(),headersTimeout:zt.min(1).required(),https:ye.required(),keepAliveTimeout:zt.min(1).required(),port:Pr,timeout:zt.min(1).required()}),nodeEnv:r,root:n,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i})}).required(),ipc:F.object({network:F.object({port:Pr})}).required(),localStudio:F.object({enabled:t}).required(),logging:F.object({file:ye.required(),level:F.valid("notify","fatal","error","warn","info","debug","trace"),rotation:F.object({compress:ye.required(),dateFormat:dr.required(),maxSize:dr.custom(mU).required(),retain:zt.min(0).required(),rotate:ye.required(),rotateInterval:dr.required(),rotateModule:ye.required(),timezone:dr.required(),workerInterval:zt.min(1).required()}).required(),root:n,stdStreams:ye.required(),auditLog:ye.required()}).required(),operationsApi:F.object({authentication:F.object({operationTokenTimeout:F.required(),refreshTokenTimeout:F.required()}).required(),foreground:ye.required(),network:F.object({cors:ye.required(),corsAccessList:lu.required(),headersTimeout:zt.min(1).required(),https:ye.required(),keepAliveTimeout:zt.min(1).required(),port:Pr,timeout:zt.min(1).required()}).required(),nodeEnv:r,tls:F.object({certificate:i,certificateAuthority:i,privateKey:i})}).required(),rootPath:dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").required(),http:F.object({threads:s}).required(),storage:F.object({writeAsync:ye.required(),overlappingSync:ye.optional()}).required()}).validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}})}a(hU,"configValidator");function fU(e){return ZL.existsSync(e)?null:`Specified path ${e} does not exist.`}a(fU,"doesPathExist");function TU(e,t){F.assert(e,dr.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+\.pem+$/).messages({"string.pattern.base":"must be a valid directory path and specify a .pem file"}));let r=fU(e);if(r)return t.message(r)}a(TU,"validatePemFile");function mU(e,t){let r=e.slice(-1);if(r!=="G"&&r!=="M"&&r!=="K")return t.message(lU);let s=e.slice(0,-1);if(isNaN(parseInt(s)))return t.message(EU)}a(mU,"validateRotationMaxSize");function RU(e,t){let r=t.state.path.join("."),s=XL.cpus().length,n=s-1;return n===1&&s===2&&(n=s),zL.info(`Detected ${s} cores on this machine, defaulting ${r} to ${n}`),n}a(RU,"setDefaultThreads");function dh(e,t){if(!ba.isEmpty(t.original))return t.original;let r=t.state.path.join(".");if(ba.isEmpty(it))throw new Error(`Error setting default root for: ${r}. HDB root is not defined`);switch(r){case"customFunctions.root":return qt.join(it,uU);case"logging.root":return qt.join(it,_U);case"operationsApi.tls.certificate":return qt.join(it,Er,eU);case"operationsApi.tls.privateKey":return qt.join(it,Er,tU);case"operationsApi.tls.certificateAuthority":return qt.join(it,Er,rU);case"customFunctions.tls.certificate":return qt.join(it,Er,sU);case"customFunctions.tls.privateKey":return qt.join(it,Er,nU);case"customFunctions.tls.certificateAuthority":return qt.join(it,Er,iU);case"clustering.tls.certificate":return qt.join(it,Er,aU);case"clustering.tls.privateKey":return qt.join(it,Er,oU);case"clustering.tls.certificateAuthority":return qt.join(it,Er,cU);default:throw new Error(`Error setting default root for config parameter: ${r}. Unrecognized config parameter`)}}a(dh,"setDefaultRoot");function AU(e){let t=F.object({routes:wa});return jL.validateBySchema({routes:e},t)}a(AU,"routesValidator")});var hr=h((p1,Oh)=>{"use strict";var re=T(),It=C(),Ke=I(),{configValidator:OU,routesValidator:hh}=Eu(),Ft=require("fs-extra"),pU=require("yaml"),Ys=require("path"),NU=require("is-number"),ya=require("properties-reader"),gU=require("lodash"),{handleHDBError:IU}=D(),{HTTP_STATUS_CODES:CU,HDB_ERROR_MSGS:La}=st(),{PACKAGE_ROOT:bU}=T(),wU="Unable to get config value because config is uninitialized",LU="Config successfully initialized",UU="Error backing up config file",yU="Empty parameter sent to getConfigValue",fh=Ys.join(bU,"config","yaml",re.HDB_DEFAULT_CONFIG_FILE),DU="Configuration successfully set. You must restart HarperDB for new config settings to take effect.",Ua,at;Oh.exports={createConfigFile:MU,getDefaultConfig:PU,getConfigValue:Th,initConfig:mh,flattenConfig:cs,updateConfigValue:Rh,updateConfigObject:BU,getConfiguration:vU,setConfiguration:HU,readConfigFile:hu,getClusteringRoutes:GU,initOldConfig:Ah,getConfigFromFile:qU};function MU(e){let t=Ks(fh);Ua=cs(t.toJSON());for(let i in e){let o=re.CONFIG_PARAM_MAP[i.toLowerCase()];if(o!==void 0){let c=o.split("_"),_=du(o,e[i]);try{t.setIn([...c],_)}catch(u){Ke.error(u)}}}Su(t);let r=t.toJSON();at=cs(r);let s=t.getIn(["rootPath"]),n=Ys.join(s,re.HDB_CONFIG_FILE);Ft.createFileSync(n),Ft.writeFileSync(n,String(t)),Ke.trace(`Config file written to ${n}`)}a(MU,"createConfigFile");function PU(e){if(Ua===void 0){let r=Ks(fh);Ua=cs(r.toJSON())}let t=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(t!==void 0)return Ua[t.toLowerCase()]}a(PU,"getDefaultConfig");function Th(e){if(It.isEmpty(e)){Ke.error(yU);return}if(at===void 0){Ke.trace(wU);return}let t=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(t!==void 0)return at[t.toLowerCase()]}a(Th,"getConfigValue");function mh(e=!1){if(at===void 0||e){let t=It.getPropsFilePath();try{Ft.accessSync(t,Ft.constants.F_OK|Ft.constants.R_OK)}catch(o){throw Ke.error(o),new Error(`HarperDB properties file at path ${t} does not exist`)}let s=ya(t).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),n;if(s.includes("config/settings.js"))try{Ah(s);return}catch(o){if(o.code!==re.NODE_ERROR_CODES.ENOENT)throw o}try{n=Ks(s)}catch(o){if(o.code===re.NODE_ERROR_CODES.ENOENT){Ke.trace(`HarperDB config file not found at ${s}. 
				This can occur during early stages of install where the config file has not yet been created`);return}else throw Ke.error(o),new Error(`Error reading HarperDB config file at ${s}`)}Su(n);let i=n.toJSON();at=cs(i),Ke.trace(LU)}}a(mh,"initConfig");function Su(e){let t=e.toJSON(),r=OU(t);if(r.error)throw La.CONFIG_VALIDATION(r.error.message);e.setIn(["http","threads"],r.value.http.threads),e.setIn(["customFunctions","root"],r.value.customFunctions.root),e.setIn(["logging","root"],r.value.logging.root),e.setIn(["operationsApi","tls","certificate"],r.value.operationsApi.tls.certificate),e.setIn(["operationsApi","tls","privateKey"],r.value.operationsApi.tls.privateKey),e.setIn(["operationsApi","tls","certificateAuthority"],r.value.operationsApi.tls.certificateAuthority),e.setIn(["customFunctions","tls","certificate"],r.value.customFunctions.tls.certificate),e.setIn(["customFunctions","tls","privateKey"],r.value.customFunctions.tls.privateKey),e.setIn(["customFunctions","tls","certificateAuthority"],r.value.customFunctions.tls.certificateAuthority),e.setIn(["clustering","tls","certificate"],r.value.clustering.tls.certificate),e.setIn(["clustering","tls","privateKey"],r.value.clustering.tls.privateKey),e.setIn(["clustering","tls","certificateAuthority"],r.value.clustering.tls.certificateAuthority)}a(Su,"validateConfig");function BU(e,t){at===void 0&&(at={});let r=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(r===void 0){Ke.trace(`Unable to update config object because config param '${e}' does not exist`);return}at[r.toLowerCase()]=t}a(BU,"updateConfigObject");function Rh(e,t,r=void 0,s=!1,n=!1){at===void 0&&mh();let i=Th(re.CONFIG_PARAM_MAP.hdb_root),o=Ys.join(i,re.HDB_CONFIG_FILE),c=Ks(o);if(r===void 0){let l=re.CONFIG_PARAM_MAP[e.toLowerCase()];if(l===void 0)throw new Error(`Unable to update config, unrecognized config parameter: ${e}`);let E=l.split("_"),d=du(l,t);c.setIn([...E],d)}else for(let l in r){let E=re.CONFIG_PARAM_MAP[l.toLowerCase()];if(E!==void 0){let d=E.split("_"),S=du(E,r[l]);try{c.setIn([...d],S)}catch(m){Ke.error(m)}}}Su(c);let _=c.getIn(["rootPath"]),u=Ys.join(_,re.HDB_CONFIG_FILE);if(s===!0)try{let l=Ys.join(_,"backup",`${re.HDB_CONFIG_FILE}.bak`);Ft.copySync(o,l),Ke.trace(`Config file: ${o} backed up to: ${l}`)}catch(l){Ke.error(UU),Ke.error(l)}Ft.writeFileSync(u,String(c)),n&&(at=cs(c.toJSON())),Ke.trace(`Config parameter: ${e} updated with value: ${t}`)}a(Rh,"updateConfigValue");function cs(e){let t={};for(let r in e)if(!!e.hasOwnProperty(r))if(typeof e[r]=="object"&&e[r]!==null&&!Array.isArray(e[r])){let s=cs(e[r]);for(let n in s)!s.hasOwnProperty(n)||(t[r.toLowerCase()+"_"+n]=s[n])}else t[r.toLowerCase()]=e[r];return t}a(cs,"flattenConfig");function du(e,t){if(e===re.CONFIG_PARAMS.CLUSTERING_NODENAME||e===re.CONFIG_PARAMS.CLUSTERING_USER){if(!isNaN(t))return t.toString();if(typeof t=="string"&&t.toLowerCase()==="true"||typeof t=="string"&&t.toLowerCase()==="false")return t}else{if(NU(t))return parseFloat(t);if(t===!0||t===!1||Array.isArray(t)||It.isObject(t)||t===null)return t;if(typeof t=="string"&&t.toLowerCase()==="true")return!0;if(typeof t=="string"&&t.toLowerCase()==="false")return!1}if(t===void 0||t.toLowerCase()==="undefined")return null;if(typeof t=="string"&&(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")))try{return JSON.parse(t)}catch{}return It.autoCast(t)}a(du,"castConfigValue");function vU(){let e=It.getPropsFilePath(),r=ya(e).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY);return Ks(r).toJSON()}a(vU,"getConfiguration");async function HU(e){let{operation:t,hdb_user:r,hdb_auth_header:s,...n}=e;try{return Rh(void 0,void 0,n,!0),DU}catch(i){throw typeof i=="string"||i instanceof String?IU(i,i,CU.BAD_REQUEST,void 0,void 0,!0):i}}a(HU,"setConfiguration");function hu(){let e=It.getPropsFilePath();try{Ft.accessSync(e,Ft.constants.F_OK|Ft.constants.R_OK)}catch(n){throw Ke.error(n),new Error(`HarperDB properties file at path ${e} does not exist`)}let r=ya(e).get(re.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY);return Ks(r).toJSON()}a(hu,"readConfigFile");function Ks(e){return pU.parseDocument(Ft.readFileSync(e,"utf8"),{simpleKeys:!0})}a(Ks,"parseYamlDoc");function GU(){let e=hu(),t=e?.clustering?.hubServer?.cluster?.network?.routes;t=It.isEmptyOrZeroLength(t)?[]:t;let r=hh(t);if(r)throw La.CONFIG_VALIDATION(r.message);let s=e?.clustering?.leafServer?.network?.routes;s=It.isEmptyOrZeroLength(s)?[]:s;let n=hh(s);if(n)throw La.CONFIG_VALIDATION(n.message);if(!It.isEmptyOrZeroLength(s)&&!It.isEmptyOrZeroLength(t)){let i=t.filter(o=>s.some(c=>c.host===o.host&&c.port===o.port));if(!It.isEmptyOrZeroLength(i)){let o=`Duplicate hub and leaf routes found ${JSON.stringify(i)}`;throw La.CONFIG_VALIDATION(o)}}return{hub_routes:t,leaf_routes:s}}a(GU,"getClusteringRoutes");function Ah(e){let t=ya(e);at={};for(let r in re.CONFIG_PARAM_MAP){let s=t.get(r.toUpperCase());if(It.isEmpty(s)||typeof s=="string"&&s.trim().length===0)continue;let n=re.CONFIG_PARAM_MAP[r].toLowerCase();n===re.CONFIG_PARAMS.LOGGING_ROOT?at[n]=Ys.dirname(s):at[n]=s}return at}a(Ah,"initOldConfig");function qU(e){let t=hu();return gU.get(t,e.replaceAll("_","."))}a(qU,"getConfigFromFile")});var Y=h((N1,Nh)=>{"use strict";var fu=require("fs-extra"),jt=require("path"),FU=require("os"),VU=require("properties-reader"),Qn=I(),Qs=C(),M=T(),Da=hr(),kU="Error initializing environment manager",Ma="BOOT_PROPS_FILE_PATH",ph=!1,xU={[M.HDB_SETTINGS_NAMES.INSTALL_USER]:!0,[M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]:!0,[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]:!0,BOOT_PROPS_FILE_PATH:!0},fr={};Nh.exports={BOOT_PROPS_FILE_PATH:Ma,getHdbBasePath:$U,setHdbBasePath:YU,get:KU,initSync:WU,setProperty:$,initTestEnvironment:JU};function $U(){return fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]}a($U,"getHdbBasePath");function YU(e){fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=e}a(YU,"setHdbBasePath");function KU(e){let t=Da.getConfigValue(e);return t===void 0?fr[e]:t}a(KU,"get");function $(e,t){xU[e]&&(fr[e]=t),Da.updateConfigObject(e,t)}a($,"setProperty");function QU(){let e;try{e=Qs.getPropsFilePath(),fu.accessSync(e,fu.constants.F_OK|fu.constants.R_OK),ph=!0;let t=VU(e);return fr[M.HDB_SETTINGS_NAMES.INSTALL_USER]=t.get(M.HDB_SETTINGS_NAMES.INSTALL_USER),fr[M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]=t.get(M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),fr[Ma]=e,!0}catch{return Qn.trace(`Environment manager found no properties file at ${e}`),!1}}a(QU,"doesPropFileExist");function WU(e=!1){try{(ph||QU())&&(Da.initConfig(e),fr[M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=Da.getConfigValue(M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY))}catch(t){Qn.error(kU),Qn.error(t),console.error(t),process.exit(1)}}a(WU,"initSync");function JU(e={}){try{let{keep_alive_timeout:t,headers_timeout:r,server_timeout:s,https_enabled:n,cors_enabled:i,cors_accesslist:o,local_studio_on:c}=e,_=jt.join(__dirname,"../../","unitTests");fr[Ma]=jt.join(_,"hdb_boot_properties.file"),$(M.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY,jt.join(_,"settings.test")),$(M.HDB_SETTINGS_NAMES.INSTALL_USER,FU.userInfo().username),$(M.HDB_SETTINGS_NAMES.PRIVATE_KEY_KEY,jt.join(_,"envDir","utility","keys","privateKey.pem")),$(M.HDB_SETTINGS_NAMES.CERT_KEY,jt.join(_,"envDir","utility","keys","certificate.pem")),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_TLS_PRIVATEKEY,jt.join(_,"envDir","utility","keys","privateKey.pem")),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_TLS_CERTIFICATE,jt.join(_,"envDir","utility","keys","certificate.pem")),$(M.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY,"debug"),$(M.HDB_SETTINGS_NAMES.LOG_PATH_KEY,jt.join(_,"envDir","log")),$(M.HDB_SETTINGS_NAMES.LOG_DAILY_ROTATE_KEY,!1),$(M.HDB_SETTINGS_NAMES.CLUSTERING_ENABLED_KEY,!0),$(M.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY,"1231412de213"),$(M.HDB_SETTINGS_NAMES.HDB_ROOT_KEY,jt.join(_,"envDir")),$(M.HDB_SETTINGS_NAMES.HTTP_SECURE_ENABLED_KEY,Qs.isEmpty(n)?!0:n),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS,Qs.isEmpty(n)?!0:n),$(M.HDB_SETTINGS_NAMES.SERVER_PORT_KEY,9925),$(M.HDB_SETTINGS_NAMES.CORS_ENABLED_KEY,Qs.isEmpty(i)?!1:i),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_CORS,Qs.isEmpty(i)?!1:i),$(M.HDB_SETTINGS_NAMES.IPC_SERVER_PORT,9383),$(M.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES,2),$(M.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES,4),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY,9926),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY,!0),$(M.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY,jt.resolve(__dirname,"../../unitTests/server/customFunctions/custom_functions")),$(M.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON,Qs.isEmpty(c)?!1:c),o&&($("CORS_ACCESSLIST",o),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST,o)),s&&($(M.HDB_SETTINGS_NAMES.SERVER_TIMEOUT_KEY,s),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_TIMEOUT,s)),t&&($(M.HDB_SETTINGS_NAMES.SERVER_KEEP_ALIVE_TIMEOUT_KEY,t),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT,t)),r&&($(M.HDB_SETTINGS_NAMES.SERVER_HEADERS_TIMEOUT_KEY,r),$(M.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT,r))}catch(t){let r=`Error reading in HDB environment variables from path ${Ma}.  Please check your boot props and settings files`;Qn.fatal(r),Qn.error(t)}}a(JU,"initTestEnvironment")});var z=h((I1,Bh)=>{"use strict";var Tu=require("lmdb"),Ct=require("fs-extra"),Vt=require("path"),Ba=os(),gh=I(),De=st().LMDB_ERRORS_ENUM,va=ih(),mu=oh(),Ih=_h(),Br=Ye(),g1=T(),Wn=Y();Wn.initSync();var Ch=Wn.get("STORAGE_WRITEASYNC")===!0||Wn.get("STORAGE_WRITEASYNC")==="true"||Wn.get("STORAGE_WRITEASYNC")==="TRUE",bh=Wn.get("STORAGE_OVERLAPPINGSYNC"),wh=1024*1024*1024,Lh=1e4,Uh=1e3,kt=Br.INTERNAL_DBIS_NAME,yh=Br.DBI_DEFINITION_NAME,ZU="data.mdb",XU="lock.mdb",Jn=".mdb",zU="-lock",Pa=class{constructor(t,r,s=!1){this.dbi=bt(t,r),this.key_type=this.dbi[Br.DBI_DEFINITION_NAME].key_type,this.is_hash_attribute=this.dbi[Br.DBI_DEFINITION_NAME].is_hash_attribute,this.txn=t.beginTxn({readOnly:s===!1}),this.cursor=new Tu.Cursor(this.txn,this.dbi)}close(){this.cursor.close(),this.txn.abort()}commit(){this.cursor.close(),this.txn.commit()}};a(Pa,"TransactionCursor");function Ru(e,t){if(e===void 0)throw new Error(De.BASE_PATH_REQUIRED);if(t===void 0)throw new Error(De.ENV_NAME_REQUIRED)}a(Ru,"pathEnvNameValidation");async function Au(e,t,r=!0){try{await Ct.access(e)}catch(s){throw s.code==="ENOENT"?new Error(De.INVALID_BASE_PATH):s}try{let s=Vt.join(e,t+Jn);return await Ct.access(s,Ct.constants.R_OK|Ct.constants.F_OK),s}catch(s){if(s.code==="ENOENT")if(r)try{return await Ct.access(Vt.join(e,t,ZU),Ct.constants.R_OK|Ct.constants.F_OK),Vt.join(e,t)}catch(n){if(n.code==="ENOENT")throw new Error(De.INVALID_ENVIRONMENT)}else throw new Error(De.INVALID_ENVIRONMENT);throw s}}a(Au,"validateEnvironmentPath");function Ha(e,t){if(Ba.validateEnv(e),t===void 0)throw new Error(De.DBI_NAME_REQUIRED)}a(Ha,"validateEnvDBIName");async function jU(e,t,r=!1,s=!1){Ru(e,t),t=t.toString();try{return await Au(e,t,s),Ou(e,t,r)}catch(n){if(n.message===De.INVALID_ENVIRONMENT){let i=Vt.join(e,t);await Ct.mkdirp(s?i:e);let o=new Ih(s?i:i+Jn,wh,Lh,Uh,!1,Ch,bh),c=Tu.open(o);c.dbis=Object.create(null);let _=new mu(!1);c.openDB(kt,_),global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null));let u=pu(e,t,r);return c[Br.ENVIRONMENT_NAME_KEY]=u,global.lmdb_map[u]=c,c}throw n}}a(jU,"createEnvironment");async function ey(e,t,r,s=!0){let n=await Ou(e,t);if(r===void 0)throw new Error(De.DESTINATION_PATH_REQUIRED);try{await Ct.access(Vt.dirname(r))}catch(i){throw i.code==="ENOENT"?new Error(De.INVALID_DESTINATION_PATH):i}await n.backup(r,s)}a(ey,"copyEnvironment");async function Ou(e,t,r=!1){Ru(e,t),t=t.toString();let s=pu(e,t,r);if(global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null)),global.lmdb_map[s]!==void 0)return global.lmdb_map[s];let n=await Au(e,t),i=Vt.join(e,t+Jn),o=n!=i,c=new Ih(n,wh,Lh,Uh,o,Ch,bh),_=Tu.open(c);_.dbis=Object.create(null);let u=Mh(_);for(let l=0;l<u.length;l++)bt(_,u[l]);return _[Br.ENVIRONMENT_NAME_KEY]=s,global.lmdb_map[s]=_,_}a(Ou,"openEnvironment");async function ty(e,t,r=!1){Ru(e,t),t=t.toString();let s=Vt.join(e,t+Jn),n=await Au(e,t);if(global.lmdb_map!==void 0){let i=pu(e,t,r);if(global.lmdb_map[i]){let o=global.lmdb_map[i];await Dh(o),delete global.lmdb_map[i]}}await Ct.remove(n),await Ct.remove(n===s?n+zU:Vt.join(Vt.dirname(n),XU))}a(ty,"deleteEnvironment");async function Dh(e){Ba.validateEnv(e);let t=e[Br.ENVIRONMENT_NAME_KEY];await e.close(),t!==void 0&&global.lmdb_map!==void 0&&delete global.lmdb_map[t]}a(Dh,"closeEnvironment");function pu(e,t,r=!1){let n=`${Vt.basename(e)}.${t}`;return r===!0&&(n=`txn.${n}`),n}a(pu,"getCachedEnvironmentName");function ry(e){Ba.validateEnv(e);let t=Object.create(null),r=bt(e,kt);for(let{key:s,value:n}of r.getRange({start:!1}))if(s!==kt)try{t[s]=Object.assign(new va,n)}catch{gh.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return t}a(ry,"listDBIDefinitions");function Mh(e){Ba.validateEnv(e);let t=[],r=bt(e,kt);for(let{key:s}of r.getRange({start:!1}))s!==kt&&t.push(s);return t}a(Mh,"listDBIs");function sy(e,t){let s=bt(e,kt).getEntry(t),n=new va;if(s!==void 0){try{n=Object.assign(n,s.value)}catch{gh.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return n}}a(sy,"getDBIDefinition");function Ph(e,t,r,s=!1){if(Ha(e,t),t=t.toString(),t===kt)throw new Error(De.CANNOT_CREATE_INTERNAL_DBIS_NAME);try{return bt(e,t)}catch(n){if(n.message===De.DBI_DOES_NOT_EXIST){let i=new mu(r,s===!0),o=e.openDB(t,i),c=new va(r===!0,s);return o[yh]=c,bt(e,kt).putSync(t,c),e.dbis[t]=o,o}throw n}}a(Ph,"createDBI");function bt(e,t){if(Ha(e,t),t=t.toString(),e.dbis[t]!==void 0)return e.dbis[t];let r;if(t!==kt?r=sy(e,t):r=new va,r===void 0)throw new Error(De.DBI_DOES_NOT_EXIST);let s;try{let n=new mu(r.dup_sort,r.useVersions);if(s=e.openDB(t,n),s.db===void 0)throw new Error("MDB_NOTFOUND")}catch(n){throw n.message.includes("MDB_NOTFOUND")===!0?new Error(De.DBI_DOES_NOT_EXIST):n}return s[yh]=r,e.dbis[t]=s,s}a(bt,"openDBI");function ny(e,t){Ha(e,t),t=t.toString();let r=bt(e,t),s=r.getStats();return r[Br.DBI_DEFINITION_NAME].is_hash_attribute&&s.entryCount>0&&s.entryCount--,s}a(ny,"statDBI");async function iy(e,t){try{let r=Vt.join(e,t+Jn);return(await Ct.stat(r)).size}catch{throw new Error(De.INVALID_ENVIRONMENT)}}a(iy,"environmentDataSize");function ay(e,t){if(Ha(e,t),t=t.toString(),t===kt)throw new Error(De.CANNOT_DROP_INTERNAL_DBIS_NAME);bt(e,t).dropSync(),e.dbis!==void 0&&delete e.dbis[t],bt(e,kt).removeSync(t)}a(ay,"dropDBI");function oy(e,t,r){for(let s=0;s<r.length;s++){let n=r[s];if(!e.dbis[n])try{bt(e,n)}catch(i){if(i.message===De.DBI_DOES_NOT_EXIST)Ph(e,n,n!==t,n===t);else throw i}}}a(oy,"initializeDBIs");Bh.exports={openDBI:bt,openEnvironment:Ou,createEnvironment:jU,listDBIs:Mh,listDBIDefinitions:ry,createDBI:Ph,dropDBI:ay,statDBI:ny,deleteEnvironment:ty,initializeDBIs:oy,TransactionCursor:Pa,environmentDataSize:iy,copyEnvironment:ey,closeEnvironment:Dh}});var Hh=h((C1,vh)=>{"use strict";var Ga=class{constructor(t=[],r=[],s=void 0){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s}};a(Ga,"InsertRecordsResponseObject");vh.exports=Ga});var qh=h((b1,Gh)=>{"use strict";var qa=class{constructor(t=[],r=[],s=void 0,n=[]){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s,this.original_records=n}};a(qa,"UpdateRecordsResponseObject");Gh.exports=qa});var Vh=h((w1,Fh)=>{"use strict";var Fa=class{constructor(t=[],r=void 0,s=[]){this.written_hashes=t,this.txn_time=r,this.original_records=s}};a(Fa,"UpsertRecordsResponseObject");Fh.exports=Fa});var Ws=h((D1,xh)=>{"use strict";var cy=z(),_y=Hh(),uy=qh(),ly=Vh(),Xn=os(),Zn=st().LMDB_ERRORS_ENUM,Ey=Ye(),vr=T(),dy=C(),Sy=require("uuid"),L1=require("lmdb"),{handleHDBError:hy,hdb_errors:fy}=D(),{OVERFLOW_MARKER:U1,MAX_SEARCH_KEY_LENGTH:y1}=Ey,Nu=vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME,_s=vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function Ty(e,t,r,s,n=!0){bu(e,t,r,s),gu(e,t,r);let i=new _y,o=[],c=[];for(let _=0;_<s.length;_++){let u=s[_];kh(u,!0,n);let l=my(e,t,r,u),E=u[t];o.push(l),c.push(E)}return Iu(o,c,s,i)}a(Ty,"insertRecords");function my(e,t,r,s){let n=s[t];return e.dbis[t].ifNoExists(n,()=>{for(let i=0;i<r.length;i++){let o=r[i];if(o===t||s.hasOwnProperty(o)===!1)continue;let c=s[o];if(typeof c=="function"){let u=c([[{}]]);Array.isArray(u)&&(c=u[0][vr.FUNC_VAL],s[o]=c)}let _=Xn.getIndexedValues(c);if(_)for(let u=0,l=_.length;u<l;u++)e.dbis[o].put(_[u],n)}e.dbis[t].put(n,s,s[_s])})}a(my,"insertRecord");function Ry(e,t=[]){let r=0;for(let s=0;s<t.length;s++){let n=t[s];e.splice(n-r,1),r++}}a(Ry,"removeSkippedRecords");function kh(e,t,r=!0){let s=Date.now();(r===!0||!Number.isInteger(e[_s]))&&(e[_s]=s),t===!0?(r===!0||!Number.isInteger(e[Nu]))&&(e[Nu]=s):delete e[Nu]}a(kh,"setTimestamps");function gu(e,t,r){r.indexOf(vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME)<0&&r.push(vr.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.indexOf(vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)<0&&r.push(vr.TIME_STAMP_NAMES_ENUM.UPDATED_TIME),cy.initializeDBIs(e,t,r)}a(gu,"initializeTransaction");async function Ay(e,t,r,s,n=!0){bu(e,t,r,s),gu(e,t,r);let i=new uy,o=[],c=[],_=[];for(let u=0;u<s.length;u++){let l=s[u],E=l[t],d;try{d=Cu(e,t,l,E,i,!0,n)}catch{i.skipped_hashes.push(E),o.push(u);continue}c.push(d),_.push(E)}return Iu(c,_,s,i,o)}a(Ay,"updateRecords");async function Oy(e,t,r,s,n=!0){try{bu(e,t,r,s)}catch(_){throw hy(_,_.message,fy.HTTP_STATUS_CODES.BAD_REQUEST)}gu(e,t,r);let i=new ly,o=[],c=[];for(let _=0;_<s.length;_++){let u=s[_],l;dy.isEmpty(u[t])?(l=Sy.v4(),u[t]=l):l=u[t];let E=Cu(e,t,u,l,i,!1,n);o.push(E),c.push(l)}return Iu(o,c,s,i)}a(Oy,"upsertRecords");async function Iu(e,t,r,s,n=[]){let i=await Promise.all(e);for(let o=0,c=i.length;o<c;o++)i[o]===!0?s.written_hashes.push(t[o]):(s.skipped_hashes.push(t[o]),n.push(o));return s.txn_time=Xn.getMicroTime(),Ry(r,n),s}a(Iu,"finalizeWrite");function Cu(e,t,r,s,n,i=!1,o=!0){let c=e.dbis[t],_=c.getEntry(s),u=_?.value,l=u;if(!u){if(i)return!1;u={}}if(kh(r,!l,o),Number.isInteger(r[_s])&&u[_s]>r[_s])return!1;l&&n.original_records.push(u);let E,d=a(()=>{for(let m in r){if(!r.hasOwnProperty(m)||m===t)continue;let R=r[m],w=e.dbis[m];if(w===void 0)continue;let L=u[m];if(typeof R=="function"){let X=R([[u]]);Array.isArray(X)&&(R=X[0][vr.FUNC_VAL],r[m]=R)}if(R===L)continue;let B=Xn.getIndexedValues(L);if(B)for(let X=0,V=B.length;X<V;X++)w.remove(B[X],s);if(B=Xn.getIndexedValues(R),B)for(let X=0,V=B.length;X<V;X++)w.put(B[X],s)}let S=Object.assign({},u,r);c.put(s,S,S[_s])},"do_put");return _?E=c.ifVersion(s,_.version,d):E=c.ifNoExists(s,d),E.then(S=>S?!0:Cu(e,t,r,s,n,i,o))}a(Cu,"updateUpsertRecord");function py(e,t,r){if(Xn.validateEnv(e),t===void 0)throw new Error(Zn.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Zn.WRITE_ATTRIBUTES_REQUIRED):new Error(Zn.WRITE_ATTRIBUTES_MUST_BE_ARRAY)}a(py,"validateBasic");function bu(e,t,r,s){if(py(e,t,r),!Array.isArray(s))throw s===void 0?new Error(Zn.RECORDS_REQUIRED):new Error(Zn.RECORDS_MUST_BE_ARRAY)}a(bu,"validateWrite");xh.exports={insertRecords:Ty,updateRecords:Ay,upsertRecords:Oy}});var te=h((M1,Yh)=>{"use strict";var wu=T(),Js=Y(),Lu=require("path");Js.initSync();var Va,ka,xa;function $h(){if(Va!==void 0)return Va;if(Js.getHdbBasePath()!==void 0)return Va=Lu.join(Js.getHdbBasePath(),wu.SCHEMA_DIR_NAME),Va}a($h,"getBaseSchemaPath");function Ny(){if(ka!==void 0)return ka;if(Js.getHdbBasePath()!==void 0)return ka=Lu.join($h(),wu.SYSTEM_SCHEMA_NAME),ka}a(Ny,"getSystemSchemaPath");function gy(){if(xa!==void 0)return xa;if(Js.getHdbBasePath()!==void 0)return xa=Lu.join(Js.getHdbBasePath(),wu.TRANSACTIONS_DIR_NAME),xa}a(gy,"getTransactionAuditStorePath");Yh.exports={getBaseSchemaPath:$h,getSystemSchemaPath:Ny,getTransactionAuditStorePath:gy}});var Tr=h((P1,Wh)=>{"use strict";var Qh=C(),Kh=T(),Ya=/^[\x20-\x2E|\x30-\x5F|\x61-\x7E]*$/,Uu=require("joi"),$a={schema_format:{pattern:Ya,message:"names cannot include backticks or forward slashes"},schema_length:{maximum:250,tooLong:"cannot exceed 250 characters"}},Iy=Uu.alternatives(Uu.string().min(1).max($a.schema_length.maximum).pattern(Ya).messages({"string.pattern.base":"{:#label} "+$a.schema_format.message}),Uu.number()).required();function Cy(e,t){return t?typeof t!="string"?`'${e}' must be a string`:t.length?t.length>$a.schema_length.maximum?`'${e}' maximum of 250 characters`:Ya.test(t)?"":`'${e}' has illegal characters`:`'${e}' must be at least one character`:`'${e}' is required`}a(Cy,"checkValidTable");function by(e,t){return Qh.doesSchemaExist(e)?e:t.message(`Schema '${e}' does not exist`)}a(by,"validateSchemaExists");function wy(e,t){let r=t.state.ancestors[0].schema;return Qh.doesTableExist(r,e)?e:t.message(`Table '${e}' does not exist`)}a(wy,"validateTableExists");function Ly(e,t){return e.toLowerCase()===Kh.SYSTEM_SCHEMA_NAME?t.message(`'subscriptions[${t.state.path[1]}]' invalid schema name, '${Kh.SYSTEM_SCHEMA_NAME}' name is reserved`):e}a(Ly,"validateSchemaName");Wh.exports={common_validators:$a,schema_regex:Ya,hdb_schema_table:Iy,validateSchemaExists:by,validateTableExists:wy,validateSchemaName:Ly,checkValidTable:Cy}});var Ka=h((B1,Jh)=>{var{common_validators:Hr}=Tr(),zn=de(),xt="is required",Z={schema:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},table:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},attribute:{presence:!0,format:Hr.schema_format,length:Hr.schema_length},hash_attribute:{presence:!0,format:Hr.schema_format,length:Hr.schema_length}};function jn(e){for(let t in e)e[t]=e[t]===null||e[t]===void 0||typeof e[t]=="object"?e[t]:e[t].toString();return e}a(jn,"makeAttributesStrings");function Uy(e){return e=jn(e),Z.schema.presence={message:xt},Z.table.presence=!1,Z.attribute.presence=!1,Z.hash_attribute.presence=!1,zn.validateObject(e,Z)}a(Uy,"schema_object");function yy(e){return e=jn(e),Z.schema.presence={message:xt},Z.table.presence={message:xt},Z.attribute.presence=!1,Z.hash_attribute.presence=!1,zn.validateObject(e,Z)}a(yy,"table_object");function Dy(e){return e=jn(e),Z.schema.presence={message:xt},Z.table.presence={message:xt},Z.attribute.presence=!1,Z.hash_attribute.presence={message:xt},zn.validateObject(e,Z)}a(Dy,"create_table_object");function My(e){return e=jn(e),Z.schema.presence={message:xt},Z.table.presence={message:xt},Z.attribute.presence={message:xt},Z.hash_attribute.presence=!1,zn.validateObject(e,Z)}a(My,"attribute_object");function Py(e){return e=jn(e),Z.schema.presence={message:xt},Z.table.presence={message:xt},Z.attribute.presence=!1,Z.hash_attribute.presence=!1,zn.validateObject(e,Z)}a(Py,"describe_table");function By(e){if(!!e){if(!Array.isArray(e))throw new Error("residence must be a string array");if(e.length===0)throw new Error("residence cannot be an empty array");for(let t=0;t<e.length;t++)if(typeof e[t]!="string")throw new Error(`residence must be a string array, item '${e[t]}' is not a string`)}}a(By,"validateTableResidence");Jh.exports={schema_object:Uy,create_table_object:Dy,table_object:yy,attribute_object:My,describe_table:Py,validateTableResidence:By}});var Xh=h((v1,Zh)=>{"use strict";var vy=require("uuid"),Qa=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.attribute=s,this.id=n||vy.v4(),this.schema_table=`${this.schema}.${this.table}`}};a(Qa,"CreateAttributeObject");Zh.exports=Qa});var Ja=h((H1,zh)=>{"use strict";var Hy=Xh(),Wa=class extends Hy{constructor(t,r,s,n,i=!0,o=!1){super(t,r,s,n),this.dup_sort=i,this.is_hash_attribute=o}};a(Wa,"LMDBCreateAttributeObject");zh.exports=Wa});var ef=h((G1,jh)=>{"use strict";jh.exports=qy;var Gy="inserted";function qy(e,t,r,s){let n={message:`${e} ${t.length} of ${r.records.length} records`,skipped_hashes:s};return e===Gy?(n.inserted_hashes=t,n):(n.update_hashes=t,n)}a(qy,"returnObject")});var Za=h((q1,rf)=>{"use strict";var Fy=T(),yu=z(),Vy=Ws(),{getSystemSchemaPath:ky,getBaseSchemaPath:xy}=te(),$y=require("path"),Yy=as(),Ky=Ka(),Qy=Ja(),Wy=ef(),{handleHDBError:Jy,hdb_errors:Zy}=D(),Xy=C(),Du=Yy.hdb_attribute,tf=[];for(let e=0;e<Du.attributes.length;e++)tf.push(Du.attributes[e].attribute);var zy="inserted";rf.exports=jy;async function jy(e){let t=Ky.attribute_object(e);if(t)throw Jy(new Error,t.message,Zy.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);e.is_hash_attribute=e.is_hash_attribute=="true",e.dup_sort=Xy.isEmpty(e.dup_sort)||e.dup_sort=="true";let r=[];if(global.hdb_schema[e.schema]&&global.hdb_schema[e.schema][e.table]&&(r=global.hdb_schema[e.schema][e.table].attributes),Array.isArray(r)&&r.length>0){for(let n of r)if(n.attribute===e.attribute)throw new Error(`attribute '${n.attribute}' already exists in ${e.schema}.${e.table}`)}let s=new Qy(e.schema,e.table,e.attribute,e.id);try{let n=await yu.openEnvironment($y.join(xy(),e.schema.toString()),e.table);if(n.dbis[e.attribute]!==void 0)throw new Error(`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`);yu.createDBI(n,e.attribute,e.dup_sort,e.is_hash_attribute);let i=await yu.openEnvironment(ky(),Fy.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),{written_hashes:o,skipped_hashes:c}=await Vy.insertRecords(i,Du.hash_attribute,tf,[s]);return Wy(zy,o,{records:[s]},c)}catch(n){throw n}}a(jy,"lmdbCreateAttribute")});var Pu=h((F1,nf)=>{var{hdb_schema_table:sf}=Tr(),eD=de(),Mu=require("joi"),tD={undefined:"undefined",null:"null"},rD=a((e,t)=>{let r=Object.keys(e),s=r.length,n;for(let i=0;i<s;i++){let o=r[i];(!o||o.length===0||tD[o]!==void 0)&&(n===void 0?n=`Invalid attribute name: '${o}'`:n+=`. Invalid attribute name: '${o}'`)}return n?t.message(n):e},"custom_records_val"),sD=Mu.object({schema:sf,table:sf,records:Mu.array().items(Mu.object().custom(rD)).required()});nf.exports=function(e){return eD.validateBySchema(e,sD)}});var Xa=h((k1,of)=>{"use strict";var mr=C(),af=I(),V1=Pu();of.exports=nD;function nD(e){if(mr.isEmpty(e))throw new Error("invalid update parameters defined.");if(mr.isEmptyOrZeroLength(e.schema))throw new Error("invalid schema specified.");if(mr.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");if(!Array.isArray(e.records))throw new Error("records must be an array");let t=global.hdb_schema[e.schema][e.table];if(mr.isEmpty(t))throw new Error(`could not retrieve schema:${e.schema} and table ${e.table}`);let r=t.hash_attribute,s=new Set,n={},i=!1;return e.operation==="update"&&(i=!0),e.records.forEach(o=>{if(i&&mr.isEmptyOrZeroLength(o[r]))throw af.error("a valid hash attribute must be provided with update record:",o),new Error("a valid hash attribute must be provided with update record, check log for more info");if(!mr.isEmptyOrZeroLength(o[r])&&(o[r]==="null"||o[r]==="undefined"))throw af.error(`a valid hash value must be provided with ${e.operation} record:`,o),new Error(`Invalid hash value: '${o[r]}' is not a valid hash attribute value, check log for more info`);!mr.isEmpty(o[r])&&o[r]!==""&&s.has(mr.autoCast(o[r]))&&(o.skip=!0),s.add(mr.autoCast(o[r]));for(let c in o)n[c]=1}),n[r]=1,{schema_table:t,hashes:Array.from(s),attributes:Object.keys(n)}}a(nD,"insertUpdateValidate")});var ei=h((x1,cf)=>{"use strict";var iD=T().OPERATIONS_ENUM,za=class{constructor(t,r,s,n,i=void 0){this.operation=iD.INSERT,this.schema=t,this.table=r,this.hash_attribute=s,this.records=n,this.__origin=i}};a(za,"InsertObject");cf.exports=za});var eo=h((Y1,_f)=>{"use strict";var $1=ei(),ja=T(),vu=C(),Bu=I(),aD=require("uuid"),{handleHDBError:ti,hdb_errors:oD}=D(),{HDB_ERROR_MSGS:ri,HTTP_STATUS_CODES:si}=oD;_f.exports=cD;function cD(e,t,r){for(let n=0;n<t.length;n++)_D(t[n]);let{records:s}=e;for(let n=0;n<s.length;n++){let i=s[n];uD(i,r,e.operation)}}a(cD,"processRows");function _D(e){if(Buffer.byteLength(String(e))>ja.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw ti(new Error,ri.ATTR_NAME_LENGTH_ERR(e),si.BAD_REQUEST,void 0,void 0,!0);if(vu.isEmptyOrZeroLength(e)||vu.isEmpty(e.trim()))throw ti(new Error,ri.ATTR_NAME_NULLISH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}a(_D,"validateAttribute");function uD(e,t,r){if(!e.hasOwnProperty(t)||vu.isEmptyOrZeroLength(e[t])){if(r===ja.OPERATIONS_ENUM.INSERT||r===ja.OPERATIONS_ENUM.UPSERT){e[t]=aD.v4();return}throw Bu.error("Update transaction aborted due to record with no hash value:",e),ti(new Error,ri.RECORD_MISSING_HASH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}if(Buffer.byteLength(String(e[t]))>ja.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Bu.error(e),ti(new Error,ri.HASH_VAL_LENGTH_ERR,si.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e[t])&&e[t].includes("/"))throw Bu.error(e),ti(new Error,ri.INVALID_FORWARD_SLASH_IN_HASH_ERR,si.BAD_REQUEST,void 0,void 0,!0)}a(uD,"validateHash")});var lf=h((K1,uf)=>{"use strict";var to=class{constructor(t,r){this.type=t,this.message=r}};a(to,"IPCEventObject");uf.exports=to});var us=h((Q1,Ef)=>{"use strict";var lD=I(),Hu=C(),ED=T(),{IPC_ERRORS:ni}=st();Ef.exports={sendIpcEvent:dD,validateEvent:SD,SchemaEventMsg:hD,UserEventMsg:fD};function dD(e){global.hdb_ipc?global.hdb_ipc.emitToServer(e):lD.warn("Tried to send event:",e,"to HDB IPC client but it does not exist")}a(dD,"sendIpcEvent");function SD(e){if(typeof e!="object")return ni.INVALID_IPC_DATA_TYPE;if(!e.hasOwnProperty("type")||Hu.isEmpty(e.type))return ni.MISSING_TYPE;if(!e.hasOwnProperty("message")||Hu.isEmpty(e.message))return ni.MISSING_MSG;if(!e.message.hasOwnProperty("originator")||Hu.isEmpty(e.message.originator))return ni.MISSING_ORIGIN;if(ED.IPC_EVENT_TYPES[e.type.toUpperCase()]===void 0)return ni.INVALID_EVENT(e.type)}a(SD,"validateEvent");function hD(e,t,r,s=void 0,n=void 0){this.originator=e,this.operation=t,this.schema=r,this.table=s,this.attribute=n}a(hD,"SchemaEventMsg");function fD(e){this.originator=e}a(fD,"UserEventMsg")});var Zs=h((J1,ff)=>{"use strict";var df=T(),W1=C(),ro=I(),Sf=lf(),{sendIpcEvent:hf}=us();function TD(e){try{ro.trace("signalSchemaChange called with message:",e);let t=new Sf(df.IPC_EVENT_TYPES.SCHEMA,e);hf(t)}catch(t){ro.error(t)}}a(TD,"signalSchemaChange");function mD(e){try{ro.trace("signalUserChange called with message:",e);let t=new Sf(df.IPC_EVENT_TYPES.USER,e);hf(t)}catch(t){ro.error(t)}}a(mD,"signalUserChange");ff.exports={signalSchemaChange:TD,signalUserChange:mD}});var so=h((Z1,mf)=>{"use strict";var Tf=C(),RD=T(),AD=I(),OD=Za(),pD=Ja(),ND=Zs(),{SchemaEventMsg:gD}=us(),ID="already exists in";mf.exports=CD;async function CD(e,t,r){try{if(Tf.isEmptyOrZeroLength(r))return r;let s=[];Tf.isEmptyOrZeroLength(t.attributes)||t.attributes.forEach(i=>{s.push(i.attribute)});let n=r.filter(i=>s.indexOf(i)<0);return n.length===0||await Promise.all(n.map(async i=>{await bD(e,t.schema,t.name,i)})),n}catch(s){throw s}}a(CD,"lmdbCheckForNewAttributes");async function bD(e,t,r,s){let n=new pD(t,r,s,void 0,!0);e&&(n.hdb_auth_header=e);try{await wD(n)}catch(i){if(typeof i=="object"&&i.message!==void 0&&i.message.includes(ID))AD.warn(`attribute ${t}.${r}.${s} already exists`);else throw i}}a(bD,"createNewAttribute");async function wD(e){let t;try{return t=await OD(e),ND.signalSchemaChange(new gD(process.pid,RD.OPERATIONS_ENUM.CREATE_ATTRIBUTE,e.schema,e.table,e.attribute)),t}catch(r){throw r}}a(wD,"createAttribute")});var Xs=h((X1,Rf)=>{"use strict";var no=class{constructor(t,r,s,n,i=void 0){this.operation=t,this.user_name=r,this.timestamp=s,this.hash_values=n,this.origin=i}};a(no,"LMDBTransactionObject");Rf.exports=no});var Of=h((z1,Af)=>{"use strict";var LD=Xs(),UD=T().OPERATIONS_ENUM,io=class extends LD{constructor(t,r,s,n,i=void 0){super(UD.INSERT,r,s,n,i),this.records=t}};a(io,"LMDBInsertTransactionObject");Af.exports=io});var Nf=h((j1,pf)=>{"use strict";var yD=Xs(),DD=T().OPERATIONS_ENUM,ao=class extends yD{constructor(t,r,s,n,i,o=void 0){super(DD.UPDATE,s,n,i,o),this.records=t,this.original_records=r}};a(ao,"LMDBUpdateTransactionObject");pf.exports=ao});var If=h((eJ,gf)=>{"use strict";var MD=Xs(),PD=T().OPERATIONS_ENUM,oo=class extends MD{constructor(t,r,s,n,i,o=void 0){super(PD.UPSERT,s,n,i,o),this.records=t,this.original_records=r}};a(oo,"LMDBUpsertTransactionObject");gf.exports=oo});var bf=h((tJ,Cf)=>{"use strict";var BD=Xs(),vD=T().OPERATIONS_ENUM,co=class extends BD{constructor(t,r,s,n,i=void 0){super(vD.DELETE,s,n,t,i),this.original_records=r}};a(co,"LMDBDeleteTransactionObject");Cf.exports=co});var ii=h((rJ,yf)=>{"use strict";var HD=require("path"),wf=z(),GD=Of(),qD=Nf(),FD=If(),VD=bf(),zs=Ye(),Lf=C(),{CONFIG_PARAMS:kD}=T(),Uf=Y();Uf.initSync();var _o=T().OPERATIONS_ENUM,{getTransactionAuditStorePath:xD}=te();yf.exports=$D;async function $D(e,t){if(Uf.get(kD.LOGGING_AUDITLOG)===!1)return;let r=HD.join(xD(),e.schema.toString()),s=await wf.openEnvironment(r,e.table,!0),n=YD(e,t);if(!(n===void 0||n.hash_values.length===0)&&s!==void 0){wf.initializeDBIs(s,zs.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,zs.TRANSACTIONS_DBIS);try{let i=n.timestamp;return await s.dbis[zs.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].ifNoExists(i,()=>{s.dbis[zs.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].put(i,n),Lf.isEmpty(n.user_name)||s.dbis[zs.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].put(n.user_name,i);for(let o=0;o<n.hash_values.length;o++)s.dbis[zs.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].put(n.hash_values[o],i)})}catch(i){throw i}}}a($D,"writeTransaction");function YD(e,t){let r=Lf.isEmpty(e.hdb_user)?void 0:e.hdb_user.username;if(e.operation===_o.INSERT)return new GD(e.records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.UPDATE)return new qD(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.UPSERT)return new FD(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===_o.DELETE)return new VD(t.deleted,t.original_records,r,t.txn_time,e.__origin)}a(YD,"createTransactionObject")});var Gu=h((nJ,Df)=>{"use strict";var KD=Xa(),sJ=ei(),js=T(),QD=eo(),WD=Ws().insertRecords,JD=z(),ZD=require("path"),XD=I(),zD=so(),{getBaseSchemaPath:jD}=te(),eM=ii();Df.exports=tM;async function tM(e){try{let{schema_table:t,attributes:r}=KD(e);QD(e,r,t.hash_attribute),e.schema!==js.SYSTEM_SCHEMA_NAME&&(r.includes(js.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(js.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(js.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(js.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await zD(e.hdb_auth_header,t,r),n=ZD.join(jD(),e.schema.toString()),i=await JD.openEnvironment(n,e.table),o=await WD(i,t.hash_attribute,r,e.records,e[js.CLUSTERING_FLAG]!==!0);try{await eM(e,o)}catch(c){XD.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(tM,"lmdbCreateRecords")});var Bf=h((iJ,Pf)=>{"use strict";var Mf=T(),rM=Gu(),sM=ei(),nM=require("fs-extra"),iM=require("path"),{getBaseSchemaPath:aM}=te();Pf.exports=oM;async function oM(e){let t=[{name:e.schema,createddate:Date.now()}],r=new sM(Mf.SYSTEM_SCHEMA_NAME,Mf.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,void 0,t);await rM(r),await nM.mkdirp(iM.join(aM(),e.schema.toString()))}a(oM,"lmdbCreateSchema")});var Hf=h((aJ,vf)=>{"use strict";var uo=class{constructor(t=[],r=[],s=void 0,n=[]){this.deleted=t,this.skipped=r,this.txn_time=s,this.original_records=n}};a(uo,"DeleteRecordsResponseObject");vf.exports=uo});var Vu=h((uJ,Ff)=>{"use strict";var Gf=z(),qu=os(),Fu=st().LMDB_ERRORS_ENUM,cM=Ye(),qf=I(),oJ=C(),_M=require("lmdb"),uM=Hf(),{OVERFLOW_MARKER:cJ,MAX_SEARCH_KEY_LENGTH:_J}=cM;async function lM(e,t,r){if(qu.validateEnv(e),t===void 0)throw new Error(Fu.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Fu.IDS_REQUIRED):new Error(Fu.IDS_MUST_BE_ARRAY);try{let s=Gf.listDBIs(e);Gf.initializeDBIs(e,t,s);let n=new uM,i,o=[],c=[];for(let E=0,d=r.length;E<d;E++)try{i=r[E];let S=e.dbis[t].get(i);if(!S){n.skipped.push(i);continue}let m=e.dbis[t].ifVersion(i,_M.IF_EXISTS,()=>{e.dbis[t].remove(i);for(let R=0;R<s.length;R++){let w=s[R];if(!S.hasOwnProperty(w)||w===t)continue;let L=e.dbis[w],B=S[w];if(B!=null)try{let X=qu.getIndexedValues(B);if(X)for(let V=0,W=X.length;V<W;V++)L.remove(X[V],i)}catch{qf.warn(`cannot delete from attribute: ${w}, ${B}:${i}`)}}});o.push(m),c.push(i),n.original_records.push(S)}catch(S){qf.warn(S),n.skipped.push(i)}let _=[],u=await Promise.all(o);for(let E=0,d=u.length;E<d;E++)u[E]===!0?n.deleted.push(c[E]):(n.skipped.push(c[E]),_.push(E));let l=0;for(let E=0;E<_.length;E++){let d=_[E];n.original_records.splice(d-l,1),l++}return n.txn_time=qu.getMicroTime(),n}catch(s){throw s}}a(lM,"deleteRecords");Ff.exports={deleteRecords:lM}});var ai=h((lJ,kf)=>{"use strict";var en=C(),EM=Vu(),dM=z(),SM=require("path"),{getBaseSchemaPath:hM}=te(),fM=ii(),TM=I();kf.exports=mM;async function mM(e,t=!0){let s=global.hdb_schema[e.schema][e.table].hash_attribute;if(en.isEmpty(s))throw new Error(`could not retrieve hash attribute for schema:${e.schema} and table ${e.table}`);try{if(en.isEmptyOrZeroLength(e.hash_values)&&!en.isEmptyOrZeroLength(e.records)){e.hash_values=[];for(let c=0;c<e.records.length;c++){let _=e.records[c][s];en.isEmpty(_)||e.hash_values.push(_)}}if(en.isEmptyOrZeroLength(e.hash_values))return Vf([],[]);if(!Array.isArray(e.hash_values))throw new Error("hash_values must be an array");if(en.isEmptyOrZeroLength(e.records)){e.records=[];for(let c=0;c<e.hash_values.length;c++)e.records[c]={[s]:e.hash_values[c]}}let n=SM.join(hM(),e.schema.toString()),i=await dM.openEnvironment(n,e.table),o=await EM.deleteRecords(i,s,e.hash_values);try{t===!0&&await fM(e,o)}catch(c){TM.error(`unable to write transaction due to ${c.message}`)}return Vf(o.deleted,o.skipped,o.txn_time)}catch(n){throw n}}a(mM,"lmdbDeleteRecords");function Vf(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}a(Vf,"createDeleteResponse")});var xu=h((dJ,xf)=>{"use strict";var RM=T(),EJ=os();function ku(e,t){let r=Object.create(null);if(t.length===1&&RM.SEARCH_WILDCARDS.indexOf(t[0])>=0)Object.assign(r,e);else for(let s=0;s<t.length;s++){let n=t[s],i=e[n];r[n]=i===void 0?null:i}return r}a(ku,"parseRow");function AM(e,t,r,s){let n=ku(r,e);s.push(n)}a(AM,"searchAll");function OM(e,t,r,s){let n=ku(r,e);s[t]=n}a(OM,"searchAllToMap");function pM(e,t,r){r[e]===void 0&&(r[e]=[]),r[e].push(t)}a(pM,"iterateDBI");function ls(e,t,r,s,n){let i=Object.create(null);i[n]=e;let o;s===n?o=e:(o=t,s!==void 0&&(i[s]=o)),r[0].push(o),r[1].push(i)}a(ls,"pushResults");function NM(e,t,r,s,n,i){t.toString().endsWith(e)&&ls(t,r,s,n,i)}a(NM,"endsWith");function gM(e,t,r,s,n,i){t.toString().includes(e)&&ls(t,r,s,n,i)}a(gM,"contains");function IM(e,t,r,s,n,i){t>e&&ls(t,r,s,n,i)}a(IM,"greaterThanCompare");function CM(e,t,r,s,n,i){t>=e&&ls(t,r,s,n,i)}a(CM,"greaterThanEqualCompare");function bM(e,t,r,s,n,i){t<e&&ls(t,r,s,n,i)}a(bM,"lessThanCompare");function wM(e,t,r,s,n,i){t<=e&&ls(t,r,s,n,i)}a(wM,"lessThanEqualCompare");xf.exports={parseRow:ku,searchAll:AM,searchAllToMap:OM,iterateDBI:pM,endsWith:NM,contains:gM,greaterThanCompare:IM,greaterThanEqualCompare:CM,lessThanCompare:bM,lessThanEqualCompare:wM,pushResults:ls}});var tn=h((fJ,Jf)=>{"use strict";var wt=z(),LM=I(),ht=os(),Gr=Ye(),ce=st().LMDB_ERRORS_ENUM,SJ=C(),UM=T(),$t=xu(),hJ=require("lmdb"),{OVERFLOW_MARKER:$f,MAX_SEARCH_KEY_LENGTH:yM}=Gr,oi={lazy:!0};function Yf(e,t,r,s,n=!1,i=void 0,o=void 0){let c=Object.create(null),_=wt.openDBI(e,r);_[Gr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let u=$u(e,t,r);for(let{key:l,value:E}of _.getRange({start:n?void 0:!1,end:n?!1:void 0,limit:i,offset:o,reverse:n}))s(u(l,E),E,c,t,r);return c}a(Yf,"iterateFullIndex");function ci(e,t,r,s,n,i=!1,o=void 0,c=void 0,_=!1,u=!1){let l=[[],[]],E=wt.openDBI(e,r),d=$u(e,t,r);E[Gr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let S=i===!0?s:n,m=i===!0?n:s,R=i===!0?!_:!u,w=i===!0?u:_;for(let{key:L,value:B}of E.getRange({start:m,end:S,reverse:i,limit:o,offset:c,inclusiveEnd:R,exclusiveStart:w}))$t.pushResults(d(L,B),B,l,t,r);return l}a(ci,"iterateRangeBetween");function $u(e,t,r){let s;return function(n,i){if(typeof n=="string"&&n.endsWith($f)){if(!s)if(t)s=wt.openDBI(e,t);else{let c=wt.listDBIs(e);for(let _=0,u=c.length;_<u&&(s=wt.openDBI(e,c[_]),!s[Gr.DBI_DEFINITION_NAME].is_hash_attribute);_++);}n=s.get(i,oi)[r]}return n}}a($u,"getOverflowCheck");function DM(e,t,r,s=!1,n=void 0,i=void 0){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);lo(r),r=_i(e,r);let o=[],c=wt.openDBI(e,t);for(let{key:_,value:u}of c.getRange({start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}))$t.searchAll(r,_,u,o);return o}a(DM,"searchAll");function MM(e,t,r,s=!1,n=void 0,i=void 0){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);return lo(r),r=_i(e,r),Yf(e,t,t,$t.searchAllToMap.bind(null,r),s,n,i)}a(MM,"searchAllToMap");function PM(e,t,r=!1,s=void 0,n=void 0){if(ht.validateEnv(e),t===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);return Yf(e,void 0,t,$t.iterateDBI,r,s,n)}a(PM,"iterateDBI");function BM(e,t){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);return wt.statDBI(e,t).entryCount}a(BM,"countAll");function vM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=wt.openDBI(e,r);s=ht.convertKeyValueToWrite(s);let _=[[],[]];if(c[Gr.DBI_DEFINITION_NAME].is_hash_attribute){t=r;let u=c.get(s,oi);u!==void 0&&$t.pushResults(s,u,_,t,r)}else for(let u of c.getValues(s,{reverse:n,limit:i,offset:o}))$t.pushResults(s,u,_,t,r);return _}a(vM,"equals");function HM(e,t,r){return qr(e,t,r),wt.openDBI(e,t).getValuesCount(r)}a(HM,"count");function GM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=[[],[]],_=wt.openDBI(e,r);_[Gr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r),s=ht.convertKeyValueToWrite(s);let u=!0;if(typeof s=="number"&&(u=!1),n===!0){let l;for(let E of _.getKeys({start:s}))if(!E.startsWith(s)){l=E;break}l!==void 0&&(Number.isInteger(o)?o++:i++);for(let{key:E,value:d}of _.getRange({start:l,end:void 0,reverse:n,limit:i,offset:o}))if(E!==l){if(E.toString().startsWith(s))$t.pushResults(E,d,c,t,r);else if(u===!0)break}}else for(let{key:l,value:E}of _.getRange({start:s,reverse:n,limit:i,offset:o}))if(l.toString().startsWith(s))$t.pushResults(l,E,c,t,r);else if(u===!0)break;return c}a(GM,"startsWith");function qM(e,t,r,s,n=!1,i=void 0,o=void 0){return Kf(e,t,r,s,n,i,o,!0)}a(qM,"endsWith");function Kf(e,t,r,s,n=!1,i=void 0,o=void 0,c=!1){qr(e,r,s);let _=[[],[]],u=wt.openDBI(e,r);u[Gr.DBI_DEFINITION_NAME].is_hash_attribute&&(t=r);let l=$u(e,t,r);o=Number.isInteger(o)?o:0;for(let d of u.getKeys({end:n?!1:void 0,reverse:n})){if(i===0)break;let S=d.toString();if(S.endsWith($f))for(let m of u.getValues(d)){let R=l(d,m);(c?R.endsWith(s):R.includes(s))&&E(R,m)}else if(c?S.endsWith(s):S.includes(s))if(u[Gr.DBI_DEFINITION_NAME].is_hash_attribute)E(d,d);else for(let m of u.getValues(d))E(d,m)}function E(d,S){if(o>0){o--;return}i!==0&&($t.pushResults(d,S,_,t,r),i--)}return a(E,"found_match"),_}a(Kf,"contains");function FM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=typeof s,_;return c==="string"?_="\uFFFF":c==="number"?_=1/0:c==="boolean"&&(_=!0),ci(e,t,r,s,_,n,i,o,!0,!1)}a(FM,"greaterThan");function VM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=typeof s,_;return c==="string"?_="\uFFFF":c==="number"?_=1/0:c==="boolean"&&(_=!0),ci(e,t,r,s,_,n,i,o,!1,!1)}a(VM,"greaterThanEqual");function kM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=typeof s,_;return c==="string"?_="\0":c==="number"?_=-1/0:c==="boolean"&&(_=!1),ci(e,t,r,_,s,n,i,o,!1,!0)}a(kM,"lessThan");function xM(e,t,r,s,n=!1,i=void 0,o=void 0){qr(e,r,s);let c=typeof s,_;return c==="string"?_="\0":c==="number"?_=-1/0:c==="boolean"&&(_=!1),ci(e,t,r,_,s,n,i,o,!1,!1)}a(xM,"lessThanEqual");function $M(e,t,r,s,n,i=!1,o=void 0,c=void 0){if(ht.validateEnv(e),r===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);if(s===void 0)throw new Error(ce.START_VALUE_REQUIRED);if(n===void 0)throw new Error(ce.END_VALUE_REQUIRED);if(s=ht.convertKeyValueToWrite(s),n=ht.convertKeyValueToWrite(n),s>n)throw new Error(ce.END_VALUE_MUST_BE_GREATER_THAN_START_VALUE);return ci(e,t,r,s,n,i,o,c)}a($M,"between");function YM(e,t,r,s){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(lo(r),r=_i(e,r),s===void 0)throw new Error(ce.ID_REQUIRED);let n=null,i=e.dbis[t].get(s,r.length<3?oi:void 0);return i&&(n=$t.parseRow(i,r)),n}a(YM,"searchByHash");function KM(e,t,r){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(ce.ID_REQUIRED);let s=!0;return e.dbis[t].get(r,oi)===void 0&&(s=!1),s}a(KM,"checkHashExists");function QM(e,t,r,s,n=[]){Wf(e,t,r,s,n);let i=Qf(e,t,r,s,n);return Object.values(i)}a(QM,"batchSearchByHash");function WM(e,t,r,s,n=[]){return Wf(e,t,r,s,n),Qf(e,t,r,s,n)}a(WM,"batchSearchByHashToMap");function Qf(e,t,r,s,n=[]){r=_i(e,r);let i=Object.create(null),o=r.length<3?oi:void 0;for(let c=0;c<s.length;c++){let _=s[c];try{let u=e.dbis[t].get(_,o);if(u){let l=$t.parseRow(u,r);i[_]=l}else n.push(_)}catch(u){throw LM.warn(u),u}}return i}a(Qf,"batchHashSearch");function Wf(e,t,r,s,n){if(ht.validateEnv(e),t===void 0)throw new Error(ce.HASH_ATTRIBUTE_REQUIRED);if(lo(r),!Array.isArray(s))throw s===void 0?new Error(ce.IDS_REQUIRED):new Error(ce.IDS_MUST_BE_ARRAY);Array.isArray(n)||(n=[])}a(Wf,"initializeBatchSearchByHash");function lo(e){if(!Array.isArray(e))throw e===void 0?new Error(ce.FETCH_ATTRIBUTES_REQUIRED):new Error(ce.FETCH_ATTRIBUTES_MUST_BE_ARRAY)}a(lo,"validateFetchAttributes");function qr(e,t,r){if(ht.validateEnv(e),t===void 0)throw new Error(ce.ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(ce.SEARCH_VALUE_REQUIRED);if(r?.length>yM)throw new Error(ce.SEARCH_VALUE_TOO_LARGE)}a(qr,"validateComparisonFunctions");function _i(e,t){return t.length===1&&UM.SEARCH_WILDCARDS.indexOf(t[0])>=0&&(t=wt.listDBIs(e)),t}a(_i,"setGetWholeRowAttributes");Jf.exports={searchAll:DM,searchAllToMap:MM,count:HM,countAll:BM,equals:vM,startsWith:GM,endsWith:qM,contains:Kf,searchByHash:YM,setGetWholeRowAttributes:_i,batchSearchByHash:QM,batchSearchByHashToMap:WM,checkHashExists:KM,iterateDBI:PM,greaterThan:FM,greaterThanEqual:VM,lessThan:kM,lessThanEqual:xM,between:$M}});var ui=h((mJ,jf)=>{var Zf=require("lodash"),Xf=de(),Q=require("joi"),JM=C(),{hdb_schema_table:Yt,checkValidTable:zf}=Tr(),{handleHDBError:ZM,hdb_errors:XM}=D(),{HTTP_STATUS_CODES:zM}=XM,TJ=Q.object({schema:Yt,table:Yt,hash_values:Q.array().min(1).items(Q.alternatives(Q.string(),Q.number())).required(),get_attributes:Q.array().min(1).items(Yt).required()}),jM=Q.object({schema:Yt,table:Yt,search_attribute:Yt,search_value:Q.any().required(),get_attributes:Q.array().min(1).items(Yt).required(),desc:Q.bool(),limit:Q.number().integer().min(1),offset:Q.number().integer().min(0)}),eP=Q.object({schema:Yt,table:Yt,operator:Q.string().valid("and","or").default("and").lowercase(),offset:Q.number().integer().min(0),limit:Q.number().integer().min(1),get_attributes:Q.array().min(1).items(Yt).required(),conditions:Q.array().min(1).items(Q.object({search_attribute:Yt,search_type:Q.string().valid("equals","contains","starts_with","ends_with","greater_than","greater_than_equal","less_than","less_than_equal","between").required(),search_value:Q.when("search_type",{switch:[{is:"equals",then:Q.any()},{is:"between",then:Q.array().items(Q.alternatives([Q.string(),Q.number()])).length(2)}],otherwise:Q.alternatives(Q.string(),Q.number())}).required()})).required()});jf.exports=function(e,t){let r=null;switch(t){case"value":r=Xf.validateBySchema(e,jM);break;case"hashes":let i=function(o){n?n+=". "+o:n=o};var s=i;a(i,"addError");let n;i(zf("schema",e.schema)),i(zf("table",e.table)),e.hash_values?Array.isArray(e.hash_values)?e.hash_values.every(o=>typeof o=="string"||typeof o=="number")||i("'hash_values' must be strings or numbers"):i("'hash_values' must be an array"):i("'hash_values' is required"),e.get_attributes?Array.isArray(e.get_attributes)?e.get_attributes.length===0?i("'get_attributes' must contain at least 1 item"):e.get_attributes.every(o=>typeof o=="string"||typeof o=="number")||i("'get_attributes' must be strings or numbers"):i("'get_attributes' must be an array"):i("'get_attributes' is required"),n&&(r=new Error(n.trim()));break;case"conditions":r=Xf.validateBySchema(e,eP);break;default:throw new Error(`Error validating search, unknown type: ${t}`)}if(!r&&e.schema!=="system"){let n=JM.checkGlobalSchemaTable(e.schema,e.table);if(n)return ZM(new Error,n,zM.NOT_FOUND);let o=global.hdb_schema[e.schema][e.table].attributes,c=[...e.get_attributes];if(t==="value"&&c.push(e.search_attribute),t==="conditions")for(let u=0,l=e.conditions.length;u<l;u++){let E=e.conditions[u];c.push(E.search_attribute)}let _=Zf.filter(c,u=>u!=="*"&&u.attribute!=="*"&&!Zf.some(o,l=>l===u||l.attribute===u||l.attribute===u.attribute));if(_&&_.length>0){let u=_.join(", ");return u=u.replace(/,([^,]*)$/," and$1"),new Error(`unknown attribute '${u}'`)}}return r}});var Yu=h((RJ,eT)=>{"use strict";var tP=z(),rP=ui(),sP=require("path"),{getBaseSchemaPath:nP}=te();eT.exports=iP;function iP(e){let t=rP(e,"hashes");if(t)throw t;let r=sP.join(nP(),e.schema.toString());return tP.openEnvironment(r,e.table)}a(iP,"initialize")});var Ku=h((AJ,tT)=>{"use strict";var aP=tn(),oP=Yu();tT.exports=cP;async function cP(e){try{let t=await oP(e),r=global.hdb_schema[e.schema][e.table];return aP.batchSearchByHashToMap(t,r.hash_attribute,e.get_attributes,e.hash_values)}catch(t){throw t}}a(cP,"lmdbGetDataByHash")});var Es=h((OJ,rT)=>{"use strict";var Eo=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.hash_values=s,this.get_attributes=n}};a(Eo,"SearchByHashObject");rT.exports=Eo});var nT=h((NJ,sT)=>{"use strict";var pJ=Es(),_P=tn(),uP=Yu();sT.exports=lP;async function lP(e){try{let t=await uP(e),r=global.hdb_schema[e.schema][e.table];return _P.batchSearchByHash(t,r.hash_attribute,e.get_attributes,e.hash_values)}catch(t){throw t}}a(lP,"lmdbSearchByHash")});var Kt=h((gJ,iT)=>{"use strict";var So=class{constructor(t,r,s,n,i,o,c,_=!1,u=void 0,l=void 0){this.schema=t,this.table=r,this.search_attribute=s,this.search_value=n,this.hash_attribute=i,this.get_attributes=o,this.end_value=c,this.reverse=_,this.limit=u,this.offset=l}};a(So,"SearchObject");iT.exports=So});var ho=h((IJ,uT)=>{"use strict";var Qe=tn(),EP=z(),dP=require("path"),SP=C(),U=Ye(),ds=T(),{getBaseSchemaPath:hP}=te(),fP=as(),aT=st().LMDB_ERRORS_ENUM,{compareKeys:rn}=require("ordered-binary"),Rr=ds.SEARCH_WILDCARDS;async function TP(e,t,r){let s;e.schema===ds.SYSTEM_SCHEMA_NAME?s=fP[e.table]:s=global.hdb_schema[e.schema][e.table];let n=_T(e,s.hash_attribute,r,t);return oT(e,n,s.hash_attribute,r)}a(TP,"prepSearch");async function oT(e,t,r,s){let n=dP.join(hP(),e.schema.toString()),i=await EP.openEnvironment(n,e.table),o=cT(i,e,t,r);if([U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH,U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP,U.SEARCH_TYPES.SEARCH_ALL,U.SEARCH_TYPES.SEARCH_ALL_TO_MAP].indexOf(t)>=0)return o;if(AP(e,r)===!1)return s===!0?RP(o):o[1];let _=o[0];return s===!0?Qe.batchSearchByHashToMap(i,r,e.get_attributes,_):Qe.batchSearchByHash(i,r,e.get_attributes,_)}a(oT,"executeSearch");function cT(e,t,r,s){let n,i=s;t.get_attributes.indexOf(s)<0&&(i=void 0);let{reverse:o,limit:c,offset:_}=t;switch(o=typeof o=="boolean"?o:!1,c=Number.isInteger(c)?c:void 0,_=Number.isInteger(_)?_:void 0,r){case U.SEARCH_TYPES.EQUALS:n=Qe.equals(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.CONTAINS:n=Qe.contains(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.ENDS_WITH:case U.SEARCH_TYPES._ENDS_WITH:n=Qe.endsWith(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.STARTS_WITH:case U.SEARCH_TYPES._STARTS_WITH:n=Qe.startsWith(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:return Qe.batchSearchByHash(e,t.search_attribute,t.get_attributes,[t.search_value]);case U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:return Qe.batchSearchByHashToMap(e,t.search_attribute,t.get_attributes,[t.search_value]);case U.SEARCH_TYPES.SEARCH_ALL:return Qe.searchAll(e,s,t.get_attributes,o,c,_);case U.SEARCH_TYPES.SEARCH_ALL_TO_MAP:return Qe.searchAllToMap(e,s,t.get_attributes,o,c,_);case U.SEARCH_TYPES.BETWEEN:n=Qe.between(e,i,t.search_attribute,t.search_value,t.end_value,o,c,_);break;case U.SEARCH_TYPES.GREATER_THAN:case U.SEARCH_TYPES._GREATER_THAN:n=Qe.greaterThan(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.GREATER_THAN_EQUAL:case U.SEARCH_TYPES._GREATER_THAN_EQUAL:n=Qe.greaterThanEqual(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.LESS_THAN:case U.SEARCH_TYPES._LESS_THAN:n=Qe.lessThan(e,i,t.search_attribute,t.search_value,o,c,_);break;case U.SEARCH_TYPES.LESS_THAN_EQUAL:case U.SEARCH_TYPES._LESS_THAN_EQUAL:n=Qe.lessThanEqual(e,i,t.search_attribute,t.search_value,o,c,_);break;default:return Object.create(null)}return n}a(cT,"searchByType");function mP(e){let t=e.search_type,r=e.search_attribute,s=e.search_value;switch(t){case U.SEARCH_TYPES.EQUALS:return n=>n[r]===s;case U.SEARCH_TYPES.CONTAINS:return n=>typeof n[r]=="string"&&n[r].includes(s);case U.SEARCH_TYPES.ENDS_WITH:case U.SEARCH_TYPES._ENDS_WITH:return n=>typeof n[r]=="string"&&n[r].endsWith(s);case U.SEARCH_TYPES.STARTS_WITH:case U.SEARCH_TYPES._STARTS_WITH:return n=>typeof n[r]=="string"&&n[r].startsWith(s);case U.SEARCH_TYPES.BETWEEN:return n=>{let i=n[r];return rn(i,s[0])>=0&&rn(i,s[1])<=0};case U.SEARCH_TYPES.GREATER_THAN:case U.SEARCH_TYPES._GREATER_THAN:return n=>rn(n[r],s)>0;case U.SEARCH_TYPES.GREATER_THAN_EQUAL:case U.SEARCH_TYPES._GREATER_THAN_EQUAL:return n=>rn(n[r],s)>=0;case U.SEARCH_TYPES.LESS_THAN:case U.SEARCH_TYPES._LESS_THAN:return n=>rn(n[r],s)<0;case U.SEARCH_TYPES.LESS_THAN_EQUAL:case U.SEARCH_TYPES._LESS_THAN_EQUAL:return n=>rn(n[r],s)<=0;default:return Object.create(null)}}a(mP,"filterByType");function RP(e){let t=Object.create(null);for(let r=0,s=e[0].length;r<s;r++)t[e[0][r]]=e[1][r];return t}a(RP,"createMapFromArrays");function AP(e,t){if(e.get_attributes.length===1&&e.get_attributes[0]==="*")return!0;let r=[e.search_attribute];e.get_attributes.indexOf(t)>=0&&r.push(t);let s=!1;for(let n=0;n<e.get_attributes.length;n++)if(r.indexOf(e.get_attributes[n])<0){s=!0;break}return s}a(AP,"checkToFetchMore");function _T(e,t,r,s){if(SP.isEmpty(s)){let n=e.search_value;typeof n=="object"?n=JSON.stringify(n):n=n.toString();let i=n.charAt(0),o=n.charAt(n.length-1),c=!1;if(e.search_attribute===t&&(c=!0),Rr.indexOf(n)>-1)return r===!0?U.SEARCH_TYPES.SEARCH_ALL_TO_MAP:U.SEARCH_TYPES.SEARCH_ALL;if(n.indexOf(Rr[0])<0&&n.indexOf(Rr[1])<0)return c===!0?r===!0?U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:U.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:U.SEARCH_TYPES.EQUALS;if(Rr.indexOf(i)>=0&&Rr.indexOf(o)>=0)return e.search_value=e.search_value.slice(1,-1),U.SEARCH_TYPES.CONTAINS;if(Rr.indexOf(i)>=0)return e.search_value=e.search_value.substr(1),U.SEARCH_TYPES.ENDS_WITH;if(Rr.indexOf(o)>=0)return e.search_value=e.search_value.slice(0,-1),U.SEARCH_TYPES.STARTS_WITH;if(n.includes(Rr[0])||n.includes(Rr[1]))return U.SEARCH_TYPES.EQUALS;throw new Error(aT.UNKNOWN_SEARCH_TYPE)}else switch(s){case ds.VALUE_SEARCH_COMPARATORS.BETWEEN:return U.SEARCH_TYPES.BETWEEN;case ds.VALUE_SEARCH_COMPARATORS.GREATER:return U.SEARCH_TYPES.GREATER_THAN;case ds.VALUE_SEARCH_COMPARATORS.GREATER_OR_EQ:return U.SEARCH_TYPES.GREATER_THAN_EQUAL;case ds.VALUE_SEARCH_COMPARATORS.LESS:return U.SEARCH_TYPES.LESS_THAN;case ds.VALUE_SEARCH_COMPARATORS.LESS_OR_EQ:return U.SEARCH_TYPES.LESS_THAN_EQUAL;default:throw new Error(aT.UNKNOWN_SEARCH_TYPE)}}a(_T,"createSearchTypeFromSearchObject");uT.exports={executeSearch:oT,createSearchTypeFromSearchObject:_T,prepSearch:TP,searchByType:cT,filterByType:mP}});var ET=h((bJ,lT)=>{"use strict";var CJ=Kt(),OP=ui(),pP=C(),NP=T(),gP=ho();lT.exports=IP;async function IP(e,t){if(!pP.isEmpty(t)&&NP.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=OP(e,"value");if(s)throw s;let n=!0;try{return await gP.prepSearch(e,t,n)}catch(i){throw i}}a(IP,"lmdbGetDataByValue")});var sn=h((LJ,dT)=>{"use strict";var wJ=Kt(),CP=ui(),bP=C(),wP=T(),LP=ho();dT.exports=UP;async function UP(e,t){if(!bP.isEmpty(t)&&wP.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=CP(e,"value");if(s)throw s;let n=!1;try{return await LP.prepSearch(e,t,n)}catch(i){throw i}}a(UP,"lmdbSearchByValue")});var hT=h((yJ,ST)=>{"use strict";var UJ=Ye(),fo=class{constructor(t,r,s,n,i=void 0,o=void 0,c="and"){this.schema=t,this.table=r,this.get_attributes=s,this.limit=i,this.offset=o,this.conditions=n,this.operator=c}};a(fo,"SearchByConditionsObject");var To=class{constructor(t,r,s){this.search_attribute=t,this.search_type=r,this.search_value=s}};a(To,"SearchCondition");var mo=class{constructor(t,r){this.attribute=t,this.desc=r}};a(mo,"SortAttribute");ST.exports={SearchByConditionsObject:fo,SearchCondition:To,SortAttribute:mo}});var OT=h((MJ,AT)=>{"use strict";var DJ=hT().SearchByConditionsObject,yP=Kt(),DP=ui(),Qu=tn(),Ro=Ye(),RT=ho(),MP=xu(),fT=require("lodash"),{getBaseSchemaPath:PP}=te(),BP=require("path"),vP=z(),{handleHDBError:TT,hdb_errors:HP}=D(),{HTTP_STATUS_CODES:GP}=HP,qP=1e8,FP={lazy:!0};AT.exports=VP;async function VP(e){try{let t=DP(e,"conditions");if(t)throw TT(t,t.message,GP.BAD_REQUEST,void 0,void 0,!0);e.operator=e.operator?e.operator.toLowerCase():void 0,e.offset=Number.isInteger(e.offset)?e.offset:0;let r=BP.join(PP(),e.schema.toString()),s=await vP.openEnvironment(r,e.table),n=global.hdb_schema[e.schema][e.table],i=fT.sortBy(e.conditions,o=>{if(o.estimated_count===void 0){let c=o.search_type;c===Ro.SEARCH_TYPES.EQUALS?o.estimated_count=Qu.count(s,o.search_attribute,o.search_value):c===Ro.SEARCH_TYPES.CONTAINS||c===Ro.SEARCH_TYPES.ENDS_WITH?o.estimated_count=1/0:o.estimated_count=qP}return o.estimated_count});if(!e.operator||e.operator.toLowerCase()==="and"){let[o]=await mT(s,e,i[0],n.hash_attribute),c=s.dbis[n.hash_attribute],_=i.slice(1).map(RT.filterByType),u=_.length,l=[],E=Qu.setGetWholeRowAttributes(s,e.get_attributes),d=e.offset>-1?e.offset:0,S=e.limit>-1?e.limit:1/0;e:for(let m of o){let R=c.get(m,FP);for(let w=0;w<u;w++)if(!_[w](R))continue e;if(d>0){d--;continue}if(S<=0)break;S--,l.push(MP.parseRow(R,E))}return l}else{let o=[],c=[];for(let _ of i){let[u]=await mT(s,e,_,n.hash_attribute);c.push(u)}if(o=fT.union(...c),e.limit>0||e.offset>0){let _=Number.isInteger(e.limit)?e.limit:o.length;o=o.splice(e.offset,_)}return Qu.batchSearchByHash(s,n.hash_attribute,e.get_attributes,o)}}catch(t){throw TT(t)}}a(VP,"lmdbSearchByConditions");async function mT(e,t,r,s){let n=new yP(t.schema,t.table,void 0,void 0,s,t.get_attributes),i=r.search_type;return n.search_attribute=r.search_attribute,i===Ro.SEARCH_TYPES.BETWEEN?(n.search_value=r.search_value[0],n.end_value=r.search_value[1]):n.search_value=r.search_value,RT.searchByType(e,n,i,s)}a(mT,"executeConditionSearch")});var li=h((PJ,pT)=>{"use strict";var kP=T().OPERATIONS_ENUM,Ao=class{constructor(t,r,s,n=void 0){this.operation=kP.DELETE,this.schema=t,this.table=r,this.hash_values=s,this.__origin=n}};a(Ao,"DeleteObject");pT.exports=Ao});var Wu=h((BJ,NT)=>{"use strict";var Oo=class{constructor(t,r,s){this.schema=t,this.table=r,this.attribute=s}};a(Oo,"DropAttributeObject");NT.exports=Oo});var Zu=h((HJ,gT)=>{"use strict";var xP=Kt(),$P=li(),vJ=Wu(),er=T(),YP=C(),Ju=z(),KP=as(),QP=sn(),WP=ai(),{getBaseSchemaPath:JP}=te(),ZP=require("path");gT.exports=XP;async function XP(e,t=!0){let r;e.schema===er.SYSTEM_SCHEMA_NAME?r=KP[e.table]:r=global.hdb_schema[e.schema][e.table];let s=await jP(e),n=ZP.join(JP(),e.schema.toString()),i=await Ju.openEnvironment(n,e.table);return t===!0&&await zP(e,i,r.hash_attribute),Ju.dropDBI(i,e.attribute),s}a(XP,"lmdbDropAttribute");async function zP(e,t,r){let s=Ju.openDBI(t,r),n,i=e.attribute;for(let{key:o,value:c,version:_}of s.getRange({start:!1,versions:!0})){let u={};for(let l in c)l!==i&&(u[l]=c[l]);n=t.dbis[r].put(o,u,_)}await n}a(zP,"removeAttributeFromAllObjects");async function jP(e){let t=new xP(er.SYSTEM_SCHEMA_NAME,er.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY,er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]),s=(await QP(t)).filter(o=>o[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]===e.attribute);if(YP.isEmptyOrZeroLength(s))throw new Error(`Attribute '${e.attribute}' was not found in '${e.schema}.${e.table}'`);let n=s.map(o=>o[er.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),i=new $P(er.SYSTEM_SCHEMA_NAME,er.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,n);return WP(i)}a(jP,"dropAttributeFromSystem")});var wT=h((GJ,bT)=>{"use strict";var eB=Zu(),tB=Wu(),IT=C(),CT=I(),rB=st().LMDB_ERRORS_ENUM;bT.exports=sB;async function sB(e){if(IT.isEmpty(global.hdb_schema[e.schema])||IT.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);let t=global.hdb_schema[e.schema][e.table],r;try{for(let s=0;s<t.attributes.length;s++){r=t.attributes[s].attribute;let n=new tB(e.schema,e.table,r);try{await eB(n,!1)}catch(i){i.message!==rB.DBI_DOES_NOT_EXIST&&CT.error(`unable to drop attribute ${e.schema}.${e.table}.${r}:`+i)}}}catch(s){throw CT.error(`Error dropping attribute ${r}`),s}}a(sB,"lmdbDropAllAttributes")});var Xu=h((FJ,HT)=>{"use strict";var MT=Kt(),PT=li(),BT=sn(),vT=ai(),qJ=wT(),ot=T(),LT=C(),UT=z(),{getBaseSchemaPath:nB,getTransactionAuditStorePath:iB}=te(),yT=require("path"),DT=I();HT.exports=aB;async function aB(e){try{if(LT.isEmpty(global.hdb_schema[e.schema])||LT.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);await oB(e),await cB(e);let t=yT.join(nB(),e.schema.toString());try{await UT.deleteEnvironment(t,e.table)}catch(r){if(r.message==="invalid environment")DT.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}try{let r=yT.join(iB(),e.schema.toString());await UT.deleteEnvironment(r,e.table,!0)}catch(r){if(r.message==="invalid environment")DT.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}}catch(t){throw t}}a(aB,"lmdbDropTable");async function oB(e){let t=new MT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r=await BT(t),s=[];for(let i=0;i<r.length;i++){let o=r[i];s.push(o.id)}if(s.length===0)return;let n=new PT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,s);await vT(n)}a(oB,"deleteAttributesFromSystem");async function cB(e){let t=new MT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,e.table,void 0,[ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,ot.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r,s;try{r=await BT(t)}catch(i){throw i}for(let i=0;i<r.length;i++){let o=r[i];o.name===e.table&&o.schema===e.schema&&(s=o)}if(!s)throw new Error(`${e.schema}.${e.table} was not found`);let n=new PT(ot.SYSTEM_SCHEMA_NAME,ot.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,[s.id]);try{await vT(n)}catch(i){throw i}}a(cB,"dropTableFromSystem")});var qT=h((kJ,GT)=>{"use strict";var _B=require("fs-extra"),uB=Kt(),lB=Es(),EB=li(),dB=Xu(),SB=ai(),hB=Ku(),fB=sn(),Ar=T(),VJ=C(),TB=require("path"),{getBaseSchemaPath:mB}=te(),{handleHDBError:RB,hdb_errors:AB}=D(),{HDB_ERROR_MSGS:OB,HTTP_STATUS_CODES:pB}=AB;GT.exports=NB;async function NB(e){let t;try{t=await gB(e.schema);let r=new uB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,t,void 0,[Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),s=await fB(r);for(let o=0;o<s.length;o++){let c={schema:t,table:s[o].name};try{await dB(c)}catch(_){if(_.message!=="invalid environment")throw _}}let n=new EB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[t]);await SB(n);let i=TB.join(mB(),t.toString());await _B.remove(i)}catch(r){throw r}}a(NB,"lmdbDropSchema");async function gB(e){let t=new lB(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[e],[Ar.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),r,s;try{r=await hB(t)}catch(n){throw n}for(let n in r)r[n].name===e&&(s=e);if(!s)throw RB(new Error,OB.SCHEMA_NOT_FOUND(e),pB.NOT_FOUND,void 0,void 0,!0);return s}a(gB,"validateDropSchema")});var zu=h((xJ,FT)=>{"use strict";var po=class{constructor(t,r,s){this.schema=t,this.table=r,this.hash_attribute=s}};a(po,"CreateTableObject");FT.exports=po});var kT=h((YJ,VT)=>{"use strict";var IB=require("path"),CB=require("fs-extra"),No=z(),{getTransactionAuditStorePath:bB}=te(),ju=Ye(),$J=zu();VT.exports=wB;async function wB(e){let t;try{let r=IB.join(bB(),e.schema.toString());await CB.mkdirp(r),t=await No.createEnvironment(r,e.table,!0)}catch(r){throw r.message=`unable to create transactions audit environment for ${e.schema}.${e.table} due to: ${r.message}`,r}try{No.createDBI(t,ju.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,!1,!0),No.createDBI(t,ju.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,!0,!1),No.createDBI(t,ju.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME,!0,!1)}catch(r){throw r.message=`unable to create dbi for ${e.schema}.${e.table} due to: ${r.message}`,r}return t}a(wB,"createTransactionsAuditEnvironment")});var KT=h((KJ,YT)=>{"use strict";var el=T(),xT=z(),LB=Ws(),UB=require("path"),{getSystemSchemaPath:yB,getBaseSchemaPath:DB}=te(),MB=as(),PB=Za(),tl=Ja(),BB=I(),vB=kT(),sl=MB.hdb_table,$T=[];for(let e=0;e<sl.attributes.length;e++)$T.push(sl.attributes[e].attribute);YT.exports=HB;async function HB(e,t){let r=UB.join(DB(),t.schema.toString()),s=new tl(t.schema,t.table,el.TIME_STAMP_NAMES_ENUM.CREATED_TIME,void 0,!0),n=new tl(t.schema,t.table,el.TIME_STAMP_NAMES_ENUM.UPDATED_TIME,void 0,!0),i=new tl(t.schema,t.table,t.hash_attribute,void 0,!1,!0);try{if(await xT.createEnvironment(r,t.table),e!==void 0){let o=await xT.openEnvironment(yB(),el.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME);await LB.insertRecords(o,sl.hash_attribute,$T,[e]),await rl(s),await rl(n),await rl(i)}await vB(t)}catch(o){throw o}}a(HB,"lmdbCreateTable");async function rl(e){try{await PB(e)}catch(t){BB.warn(`failed to create attribute ${e.attribute} due to ${t.message}`)}}a(rl,"createAttribute")});var WT=h((QJ,QT)=>{"use strict";var GB=Xa(),qB=eo(),FB=so(),nn=T(),VB=Ws().updateRecords,kB=z(),xB=require("path"),{getBaseSchemaPath:$B}=te(),YB=ii(),KB=I();QT.exports=QB;async function QB(e){try{let{schema_table:t,attributes:r}=GB(e);qB(e,r,t.hash_attribute),e.schema!==nn.SYSTEM_SCHEMA_NAME&&(r.includes(nn.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(nn.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(nn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(nn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await FB(e.hdb_auth_header,t,r),n=xB.join($B(),e.schema.toString()),i=await kB.openEnvironment(n,e.table),o=await VB(i,t.hash_attribute,r,e.records,e[nn.CLUSTERING_FLAG]!==!0);try{await YB(e,o)}catch(c){KB.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(QB,"lmdbUpdateRecords")});var ZT=h((WJ,JT)=>{"use strict";var WB=T().OPERATIONS_ENUM,go=class{constructor(t,r,s,n=void 0){this.operation=WB.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(go,"UpsertObject");JT.exports=go});var zT=h((ZJ,XT)=>{"use strict";var JJ=ZT(),JB=Xa(),ZB=eo(),XB=so(),an=T(),zB=Ws().upsertRecords,jB=z(),ev=require("path"),{getBaseSchemaPath:tv}=te(),rv=ii(),sv=I(),{handleHDBError:nv,hdb_errors:iv}=D();XT.exports=av;async function av(e){let t;try{t=JB(e)}catch(_){throw nv(_,_.message,iv.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}let{schema_table:r,attributes:s}=t;ZB(e,s,r.hash_attribute),e.schema!==an.SYSTEM_SCHEMA_NAME&&(s.includes(an.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||s.push(an.TIME_STAMP_NAMES_ENUM.CREATED_TIME),s.includes(an.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||s.push(an.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let n=await XB(e.hdb_auth_header,r,s),i=ev.join(tv(),e.schema.toString()),o=await jB.openEnvironment(i,e.table),c=await zB(o,r.hash_attribute,s,e.records,e[an.CLUSTERING_FLAG]!==!0);try{await rv(e,c)}catch(_){sv.error(`unable to write transaction due to ${_.message}`)}return{written_hashes:c.written_hashes,schema_table:r,new_attributes:n,txn_time:c.txn_time}}a(av,"lmdbUpsertRecords")});var nm=h((XJ,sm)=>{"use strict";var ov=Kt(),jT=C(),em=I(),cv=sn(),tm=T(),_v=Vu().deleteRecords,uv=z(),lv=require("path"),{getBaseSchemaPath:Ev}=te(),{promisify:dv}=require("util"),Sv=dv(setTimeout),rm=1e4,hv=10;sm.exports=fv;async function fv(e){let t=global.hdb_schema[e.schema][e.table].hash_attribute;if(jT.isEmptyOrZeroLength(t))throw new Error(`Could not retrieve hash attribute for schema: ${e.schema} table: ${e.table}`);let r=Date.parse(e.date),s;try{let n=new ov(e.schema,e.table,tm.TIME_STAMP_NAMES_ENUM.CREATED_TIME,r,void 0,[t]);s=await cv(n,tm.VALUE_SEARCH_COMPARATORS.LESS)}catch(n){throw em.error(`Error searching for date: ${e.date} in schema: ${e.schema} table: ${e.table}`),n}return jT.isEmptyOrZeroLength(s)?(em.trace("No records found to delete"),{message:"No records found to delete"}):await Tv(e,s,t)}a(fv,"lmdbDeleteRecordsBefore");async function Tv(e,t,r){let s=lv.join(Ev(),e.schema.toString()),n=await uv.openEnvironment(s,e.table),i={message:"",deleted_hashes:[],skipped_hashes:[]};for(let o=0,c=t.length;o<c;o+=rm){let _=t.slice(o,o+rm),u=[];for(let l=0,E=_.length;l<E;l++)u.push(_[l][r]);try{let l=await _v(n,r,u);i.deleted_hashes=i.deleted_hashes.concat(l.deleted),i.skipped_hashes=i.skipped_hashes.concat(l.skipped)}catch(l){throw l}await Sv(hv)}return i.message=`${i.deleted_hashes.length} of ${i.deleted_hashes.length+i.skipped_hashes.length} records successfully deleted`,i}a(Tv,"chunkDeletes")});var am=h((zJ,im)=>{"use strict";var Io=class{constructor(t,r,s){this.schema=t,this.table=r,this.timestamp=s}};a(Io,"DeleteBeforeObject");im.exports=Io});var cm=h((jJ,om)=>{"use strict";var Co=class{constructor(t=void 0,r=void 0,s=0){this.start_timestamp=t,this.end_timestamp=r,this.transactions_deleted=s}};a(Co,"DeleteAuditLogsBeforeResults");om.exports=Co});var lm=h((tZ,um)=>{"use strict";var nl=z(),{getTransactionAuditStorePath:mv}=te(),eZ=am(),Rv=require("path"),Ei=Ye(),Av=C(),_m=cm(),Ov=require("util").promisify,pv=Ov(setTimeout),Nv=1e4,gv=100;um.exports=Iv;async function Iv(e){let t=Rv.join(mv(),e.schema),r=await nl.openEnvironment(t,e.table,!0),s=nl.listDBIs(r);nl.initializeDBIs(r,Ei.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n,i=new _m;do n=await Cv(r,e.timestamp),i.start_timestamp===void 0&&(i.start_timestamp=n.start_timestamp),n.end_timestamp!==void 0&&(i.end_timestamp=n.end_timestamp),i.transactions_deleted+=n.transactions_deleted,await pv(gv);while(n.transactions_deleted>0);return i}a(Iv,"deleteAuditLogsBefore");async function Cv(e,t){let r=new _m;try{let s=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let{key:i,value:o}of s.getRange({start:!1})){if(i>=t)break;r.start_timestamp===void 0&&(r.start_timestamp=i),n=s.remove(i);let c=o[Ei.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME];Av.isEmpty(c)||(n=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].remove(c,i));for(let _=0;_<o.hash_values.length;_++)n=e.dbis[Ei.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].remove(o.hash_values[_],i);if(r.transactions_deleted++,r.end_timestamp=i,r.transactions_deleted>Nv)break}return await n,r}catch(s){throw s}}a(Cv,"deleteTransactions")});var mm=h((rZ,Tm)=>{"use strict";var il=z(),on=Ye(),Em=os(),al=T(),dm=C(),{getTransactionAuditStorePath:bv}=te(),wv=require("path"),Lv=tn(),bo=Xs(),Uv=I();Tm.exports=yv;async function yv(e){let t=wv.join(bv(),e.schema),r=await il.openEnvironment(t,e.table,!0),s=il.listDBIs(r);il.initializeDBIs(r,on.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n;switch(e.search_type){case al.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.TIMESTAMP:return Sm(r,e.search_values);case al.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:return n=global.hdb_schema[e.schema][e.table].hash_attribute,Mv(r,e.search_values,n);case al.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:return Dv(r,e.search_values);default:return Sm(r)}}a(yv,"readAuditLog");function Sm(e,t=[0,Em.getMicroTime()]){dm.isEmpty(t[0])&&(t[0]=0),dm.isEmpty(t[1])&&(t[1]=Em.getMicroTime());let r=[];try{let s=e.dbis[on.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let i of s.getKeys({start:t[1]}))if(i!==t[1]){n=i;break}for(let{value:i}of s.getRange({start:t[0],end:n})){let o=Object.assign(new bo,i);r.push(o)}return r}catch(s){throw s}}a(Sm,"searchTransactionsByTimestamp");function Dv(e,t=[]){let r=new Map;for(let s=0;s<t.length;s++){let n=t[s],i=[];for(let o of e.dbis[on.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].getValues(n))i.push(o);r.set(n,fm(e,i))}return Object.fromEntries(r)}a(Dv,"searchTransactionsByUsername");function Mv(e,t,r){let s=new Map;for(let c=0,_=t.length;c<_;c++){let u=t[c],l=Lv.equals(e,on.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,on.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,u);for(let E=0,d=l[0].length;E<d;E++){let S=l[0][E],m=Number(S);s.has(m)?s.get(m).push(u.toString()):s.set(m,[u.toString()])}}let n=Array.from(s.keys()),i=fm(e,n),o=new Map;for(let c=0;c<i.length;c++){let _=i[c],u=_.timestamp,l=s.get(u);hm(_,"records",r,l,o),hm(_,"original_records",r,l,o)}return Object.fromEntries(o)}a(Mv,"searchTransactionsByHashValues");function hm(e,t,r,s,n){let i=e.timestamp;if(e[t])for(let o=0;o<e[t].length;o++){let c=e[t][o],_=c[r].toString();if(s.indexOf(_)>=0)if(n.has(_)){let u=n.get(_),l=u[u.length-1];if(l.timestamp===i)l[t]=[c];else{let E=new bo(e.operation,e.user_name,i,void 0);E[t]=[c],u.push(E)}}else{let u=new bo(e.operation,e.user_name,i,void 0);u[t]=[c],n.set(_,[u])}}}a(hm,"loopRecords");function fm(e,t){let r=[];try{let s=e.dbis[on.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP];for(let n=0;n<t.length;n++)try{let i=s.get(t[n]);if(i){let o=Object.assign(new bo,i);r.push(o)}}catch(i){Uv.warn(i)}return r}catch(s){throw s}}a(fm,"batchSearchTransactions")});var Am=h((sZ,Rm)=>{"use strict";var Pv=require("path"),{getBaseSchemaPath:Bv}=te(),vv=z();Rm.exports={writeTransaction:Hv};async function Hv(e,t,r){let s=Pv.join(Bv(),e);return(await vv.openEnvironment(s,t)).transaction(r)}a(Hv,"writeTransaction")});var pm=h((nZ,Om)=>{"use strict";var Gv=require("path"),{getBaseSchemaPath:qv}=te(),Fv=z();Om.exports={flush:Vv};async function Vv(e,t){let r=Gv.join(qv(),e.toString());return(await Fv.openEnvironment(r,t.toString())).flushed}a(Vv,"flush")});var gm=h((iZ,Nm)=>{"use strict";var Ae=I(),{handleHDBError:kv}=D(),xv=uu(),$v=Za(),Yv=Gu(),Kv=Bf(),Qv=ai(),Wv=Ku(),Jv=nT(),Zv=ET(),Xv=sn(),zv=OT(),jv=qT(),eH=KT(),tH=WT(),rH=zT(),sH=nm(),nH=lm(),iH=Xu(),aH=Zu(),oH=mm(),cH=Am(),_H=pm(),wo=class extends xv{async searchByConditions(t){try{return zv(t)}catch(r){throw Ae.error(r),r}}async getDataByHash(t){try{return await Wv(t)}catch(r){throw Ae.error(r),r}}async searchByHash(t){try{return await Jv(t)}catch(r){throw Ae.error(r),r}}async getDataByValue(t,r){try{return await Zv(t,r)}catch(s){throw Ae.error(s),s}}async searchByValue(t){try{return await Xv(t)}catch(r){throw Ae.error(r),r}}async createSchema(t){try{return await Kv(t)}catch(r){throw Ae.error(r),r}}async dropSchema(t){try{return await jv(t)}catch(r){throw Ae.error(r),r}}async createTable(t,r){try{return await eH(t,r)}catch(s){throw Ae.error(s),s}}async dropTable(t){try{return await iH(t)}catch(r){throw Ae.error(r),r}}async createAttribute(t){try{return await $v(t)}catch(r){throw Ae.error(r),r}}async createRecords(t){try{return await Yv(t)}catch(r){throw Ae.error(r),r}}async updateRecords(t){try{return await tH(t)}catch(r){throw Ae.error(r),r}}async upsertRecords(t){try{return await rH(t)}catch(r){throw kv(r,null,null,Ae.ERR,r)}}async deleteRecords(t){try{return await Qv(t)}catch(r){throw Ae.error(r),r}}async deleteRecordsBefore(t){try{return await sH(t)}catch(r){throw Ae.error(r),r}}async dropAttribute(t){try{return await aH(t)}catch(r){throw Ae.error(r),r}}async deleteAuditLogsBefore(t){try{return await nH(t)}catch(r){throw Ae.error(r),r}}async readAuditLog(t){try{return await oH(t)}catch(r){throw Ae.error(r),r}}writeTransaction(t,r,s){return cH.writeTransaction(t,r,s)}flush(t,r){return _H.flush(t,r)}};a(wo,"LMDBBridge");Nm.exports=wo});var Or=h((aZ,Cm)=>{"use strict";var uH=gm(),lH=uu(),EH=Y();EH.initSync();var Im;function dH(){return Im instanceof lH?Im:new uH}a(dH,"getBridge");Cm.exports=dH()});var Um=h((oZ,Lm)=>{"use strict";var bm=require("lodash"),di=require("mathjs"),SH=require("jsonata"),wm=C();Lm.exports={distinct_array:e=>Array.isArray(e)&&e.length>1?bm.uniqWith(e,bm.isEqual):e,searchJSON:hH,mad:Si.bind(null,di.mad),mean:Si.bind(null,di.mean),mode:Si.bind(null,di.mode),prod:Si.bind(null,di.prod),median:Si.bind(null,di.median)};function Si(e,t,r,s){return s===1?t==null?[]:[t]:s===2?(t!=null&&r.push(t),r):r!=null&&r.length>0?e(r):null}a(Si,"aggregateFunction");function hH(e,t){if(typeof e!="string"||e.length===0)throw new Error("search json expression must be a non-empty string");let r="__"+e+"__";if(wm.isEmpty(this.__ala__.res)&&(this.__ala__.res={}),wm.isEmpty(this.__ala__.res[r])){let s=SH(e);this.__ala__.res[r]=s}return this.__ala__.res[r].evaluate(t)}a(hH,"searchJSON")});var Dm=h((cZ,ym)=>{"use strict";var Se=require("moment"),ol="YYYY-MM-DDTHH:mm:ss.SSSZZ";Se.suppressDeprecationWarnings=!0;ym.exports={current_date:()=>Se().utc().format("YYYY-MM-DD"),current_time:()=>Se().utc().format("HH:mm:ss.SSS"),extract:(e,t)=>{switch(t.toLowerCase()){case"year":return Se(e).utc().format("YYYY");case"month":return Se(e).utc().format("MM");case"day":return Se(e).utc().format("DD");case"hour":return Se(e).utc().format("HH");case"minute":return Se(e).utc().format("mm");case"second":return Se(e).utc().format("ss");case"millisecond":return Se(e).utc().format("SSS");default:break}},date:e=>Se(e).utc().format(ol),date_format:(e,t)=>Se(e).utc().format(t),date_add:(e,t,r)=>Se(e).utc().add(t,r).valueOf(),date_sub:(e,t,r)=>Se(e).utc().subtract(t,r).valueOf(),date_diff:(e,t,r)=>{let s=Se(e).utc(),n=Se(t).utc();return r?s.diff(n,r,!0):s.diff(n)},now:()=>Se().utc().valueOf(),get_server_time:()=>Se().format(ol),offset_utc:(e,t)=>Se(e).utc().utcOffset(t).format(ol)}});var vm=h((_Z,Bm)=>{"use strict";var fH=require("@turf/area"),TH=require("@turf/length"),mH=require("@turf/circle"),RH=require("@turf/difference"),AH=require("@turf/distance"),OH=require("@turf/boolean-contains"),pH=require("@turf/boolean-equal"),NH=require("@turf/boolean-disjoint"),gH=require("@turf/helpers"),Mm=T(),k=C();Bm.exports={geoArea:IH,geoLength:CH,geoCircle:bH,geoDifference:wH,geoDistance:Pm,geoNear:LH,geoContains:UH,geoEqual:yH,geoCrosses:DH,geoConvert:MH};var cl="geo1 is required",_l="geo2 is required";function IH(e){if(k.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=k.autoCast(e)),fH.default(e)}a(IH,"geoArea");function CH(e,t){if(k.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=k.autoCast(e)),TH.default(e,{units:t||"kilometers"})}a(CH,"geoLength");function bH(e,t,r){if(k.isEmpty(e))throw new Error("point is required");if(k.isEmpty(t))throw new Error("radius is required");return typeof e=="string"&&(e=k.autoCast(e)),mH.default(e,t,{units:r||"kilometers"})}a(bH,"geoCircle");function wH(e,t){if(k.isEmpty(e))throw new Error("poly1 is required");if(k.isEmpty(t))throw new Error("poly2 is required");return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),RH(e,t)}a(wH,"geoDifference");function Pm(e,t,r){if(k.isEmpty(e))throw new Error("point1 is required");if(k.isEmpty(t))throw new Error("point2 is required");return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),AH.default(e,t,{units:r||"kilometers"})}a(Pm,"geoDistance");function LH(e,t,r,s){if(k.isEmpty(e))throw new Error("point1 is required");if(k.isEmpty(t))throw new Error("point2 is required");if(k.isEmpty(r))throw new Error("distance is required");if(typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),isNaN(r))throw new Error("distance must be a number");return Pm(e,t,s)<=r}a(LH,"geoNear");function UH(e,t){if(k.isEmpty(e))throw new Error(cl);if(k.isEmpty(e))throw new Error(_l);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),OH.default(e,t)}a(UH,"geoContains");function yH(e,t){if(k.isEmpty(e))throw new Error(cl);if(k.isEmpty(e))throw new Error(_l);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),pH.default(e,t)}a(yH,"geoEqual");function DH(e,t){if(k.isEmpty(e))throw new Error(cl);if(k.isEmpty(e))throw new Error(_l);return typeof e=="string"&&(e=k.autoCast(e)),typeof t=="string"&&(t=k.autoCast(t)),!NH.default(e,t)}a(DH,"geoCrosses");function MH(e,t,r){if(k.isEmptyOrZeroLength(e))throw new Error("coordinates is required");if(k.isEmpty(t))throw new Error("geo_type is required");if(k.isEmpty(Mm.GEO_CONVERSION_ENUM[t]))throw new Error(`geo_type of ${t} is invalid please use one of the following types: ${Object.keys(Mm.GEO_CONVERSION_ENUM).join(",")}`);return gH[t](e,r)}a(MH,"geoConvert")});var Lo=h((uZ,Hm)=>{var Ss=Um(),ft=Dm(),tr=vm();Hm.exports=e=>{e.aggr.mad=e.aggr.MAD=Ss.mad,e.aggr.mean=e.aggr.MEAN=Ss.mean,e.aggr.mode=e.aggr.MODE=Ss.mode,e.aggr.prod=e.aggr.PROD=Ss.prod,e.aggr.median=e.aggr.MEDIAN=Ss.median,e.fn.distinct_array=e.fn.DISTINCT_ARRAY=Ss.distinct_array,e.fn.search_json=e.fn.SEARCH_JSON=Ss.searchJSON,e.fn.__ala__=e,e.fn.current_date=e.fn.CURRENT_DATE=ft.current_date,e.fn.current_time=e.fn.CURRENT_TIME=ft.current_time,e.fn.extract=e.fn.EXTRACT=ft.extract,e.fn.date=e.fn.DATE=ft.date,e.fn.date_format=e.fn.DATE_FORMAT=ft.date_format,e.fn.date_add=e.fn.DATE_ADD=ft.date_add,e.fn.date_sub=e.fn.DATE_SUB=ft.date_sub,e.fn.date_diff=e.fn.DATE_DIFF=e.fn.datediff=e.fn.DATEDIFF=ft.date_diff,e.fn.now=e.fn.NOW=ft.now,e.fn.offset_utc=e.fn.OFFSET_UTC=ft.offset_utc,e.fn.get_server_time=e.fn.GET_SERVER_TIME=ft.get_server_time,e.fn.getdate=e.fn.GETDATE=ft.now,e.fn.current_timestamp=e.fn.CURRENT_TIMESTAMP=ft.now,e.fn.geoarea=e.fn.GEOAREA=e.fn.geoArea=tr.geoArea,e.fn.geocircle=e.fn.GEOCIRCLE=e.fn.geoCircle=tr.geoCircle,e.fn.geocontains=e.fn.GEOCONTAINS=e.fn.geoContains=tr.geoContains,e.fn.geoconvert=e.fn.GEOCONVERT=e.fn.geoConvert=tr.geoConvert,e.fn.geocrosses=e.fn.GEOCROSSES=e.fn.geoCrosses=tr.geoCrosses,e.fn.geodifference=e.fn.GEODIFFERENCE=e.fn.geoDifference=tr.geoDifference,e.fn.geodistance=e.fn.GEODISTANCE=e.fn.geoDistance=tr.geoDistance,e.fn.geoequal=e.fn.GEOEQUAL=e.fn.geoEqual=tr.geoEqual,e.fn.geolength=e.fn.GEOLENGTH=e.fn.geoLength=tr.geoLength,e.fn.geonear=e.fn.GEONEAR=e.fn.geoNear=tr.geoNear}});var Fm=h((lZ,qm)=>{"use strict";var hi=require("lodash"),Me=require("alasql");Me.options.cache=!1;var PH=Lo(),Gm=require("clone"),Uo=require("recursive-iterator"),v=I(),G=C(),cn=Or(),BH=T(),{hdb_errors:vH}=D(),HH="IS NULL",fi="There was a problem performing this search. Please check the logs and try again.";PH(Me);var yo=class{constructor(t,r){if(G.isEmpty(t))throw v.error("AST statement for SQL select process cannot be empty"),"statement cannot be null";this.statement=t,this.columns={},this.all_table_attributes=r,this.fetch_attributes=[],this.exact_search_values={},this.comparator_search_values={},this.tables=[],this.data={},this.has_aggregator=!1,this.has_ordinal=!1,this.has_outer_join=!1,this._getColumns(),this._getTables(),this._conditionsToFetchAttributeValues(),this._setAliasesForColumns(),G.backtickASTSchemaItems(this.statement)}async search(){let t;try{let s=await this._checkEmptySQL();if(!G.isEmptyOrZeroLength(s))return v.trace("No results returned from checkEmptySQL SQLSearch method."),s}catch(s){throw v.error("Error thrown from checkEmptySQL in SQLSearch class method search."),v.error(s),new Error(fi)}try{let s=await this._getFetchAttributeValues();if(s)return s}catch(s){throw v.error("Error thrown from getFetchAttributeValues in SQLSearch class method search."),v.error(s),new Error(fi)}if(Object.keys(this.data).length===0)return v.trace('SQLSearch class field: "data" is empty.'),[];let r;try{r=await this._processJoins()}catch(s){throw v.error("Error thrown from processJoins in SQLSearch class method search."),v.error(s),new Error(fi)}try{await this._getFinalAttributeData(r.existing_attributes,r.joined_length)}catch(s){throw v.error("Error thrown from getFinalAttributeData in SQLSearch class method search."),v.error(s),new Error(fi)}try{return t=await this._finalSQL(),t}catch(s){throw v.error("Error thrown from finalSQL in SQLSearch class method search."),v.error(s),new Error(fi)}}_getColumns(){let t=new Uo(this.statement);for(let{node:r,path:s}of t)r&&r.columnid&&(this.columns[s[0]]||(this.columns[s[0]]=[]),this.columns[s[0]].push(Gm(r)))}_getTables(){let t=[];this.all_table_attributes.forEach(r=>{t.push(r.table)}),this.tables=hi.uniqBy(t,r=>[r.databaseid,r.tableid,r.as].join()),this.tables.forEach(r=>{let s=`${r.databaseid}_${r.as?r.as:r.tableid}`;this.data[s]={},this.data[s].__hash_name=global.hdb_schema[r.databaseid][r.tableid].hash_attribute,this.data[s].__merged_data={},this.data[s].__merged_attributes=[],this.data[s].__merged_attr_map={}})}_conditionsToFetchAttributeValues(){if(G.isEmpty(this.statement.where)){v.trace('AST "where" statement is empty.');return}let t=!1;for(let{node:r}of new Uo(this.statement.where))if(r&&r.op&&r.op==="OR"&&(t=!0),!G.isEmpty(r)&&r.right)if(G.isNotEmptyAndHasValue(r.right.value)){let s=G.autoCast(r.right.value);[!0,!1].indexOf(s)>=0?r.right=new Me.yy.LogicValue({value:s}):r.right instanceof Me.yy.StringValue&&!G.isEmpty(s)&&G.autoCasterIsNumberCheck(s.toString())&&(r.right=new Me.yy.NumValue({value:s}))}else Array.isArray(r.right)&&r.right.forEach((s,n)=>{let i=G.autoCast(s.value);[!0,!1].indexOf(i)>=0?r.right[n]=new Me.yy.LogicValue({value:i}):s instanceof Me.yy.StringValue&&G.autoCasterIsNumberCheck(i.toString())&&(r.right[n]=new Me.yy.NumValue({value:i}))});if(t){v.trace('Where clause contains "OR", exact match search not performed on attributes.');return}for(let{node:r}of new Uo(this.statement.where))if(r&&r.left&&r.right&&(r.left.columnid||r.right.value)&&r.op){let s=new Set,n=r.left.columnid?r.left:r.right,i=this._findColumn(n);if(!i)continue;let o=[i.table.databaseid,i.table.tableid,i.attribute].join("/");if(!G.isEmpty(BH.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r.op])){if(G.isEmpty(this.comparator_search_values[o])&&(this.comparator_search_values[o]={ignore:!1,comparators:[]}),!this.comparator_search_values[o].ignore){if(G.isEmptyOrZeroLength(r.left.columnid)||G.isEmptyOrZeroLength(r.right.value)){this.comparator_search_values[o].ignore=!0,this.comparator_search_values[o].comparators=[];continue}this.comparator_search_values[o].comparators.push({attribute:r.left.columnid,operation:r.op,search_value:r.right.value})}continue}if(G.isEmpty(this.exact_search_values[o])&&(this.exact_search_values[o]={ignore:!1,values:new Set}),!this.exact_search_values[o].ignore){let c=!1;switch(r.op){case"=":!G.isEmpty(r.right.value)||!G.isEmpty(r.left.value)?s.add(G.isEmpty(r.right.value)?r.left.value:r.right.value):c=!0;break;case"IN":let _=Array.isArray(r.right)?r.right:r.left;for(let u=0;u<_.length;u++)if(_[u].value)s.add(_[u].value);else{c=!0;break}break;default:c=!0;break}this.exact_search_values[o].ignore=c,c?this.exact_search_values[o].values=new Set:this.exact_search_values[o].values=new Set([...this.exact_search_values[o].values,...s])}}}_setAliasesForColumns(){if(G.isEmptyOrZeroLength(this.all_table_attributes)&&G.isEmptyOrZeroLength(this.statement.from)&&G.isEmptyOrZeroLength(this.columns.columns))return;let t=[],r={};this.statement.columns.forEach((s,n)=>{if(s.columnid==="*"){t.push(n);return}if(s.aggregatorid&&(this.has_aggregator=!0),!s.aggregatorid&&!s.funcid)if(s.as_orig=s.as?s.as:s.columnid,this.statement.joins)if(r[s.as_orig]>=0){let i=r[s.as_orig]+1;s.as=`[${s.as_orig+i}]`,r[s.as_orig]=i}else s.as=`[${s.as_orig}]`,r[s.as_orig]=0;else s.as=`[${s.as_orig}]`;!s.aggregatorid&&s.funcid&&s.args&&(s.as_orig=s.as?s.as:s.toString().replace(/'/g,'"'),s.as=`[${s.as_orig}]`),s.aggregatorid&&s.expression.columnid!=="*"&&(s.as_orig=s.as?s.as:s.expression.tableid?`${s.aggregatorid}(${s.expression.tableid}.${s.expression.columnid})`:`${s.aggregatorid}(${s.expression.columnid})`,s.as=`[${s.as_orig}]`)}),this.statement.columns.length>1&&t.length>0&&hi.pullAt(this.statement.columns,t)}_findColumn(t){let r=this.all_table_attributes.filter(s=>{if(t.columnid_orig&&t.tableid_orig)return(s.table.as===t.tableid_orig||s.table.tableid===t.tableid_orig)&&s.attribute===t.columnid_orig;if(t.tableid)return(s.table.as===t.tableid||s.table.tableid===t.tableid)&&s.attribute===t.columnid;let n=t.columnid_orig?t.columnid_orig:t.columnid;return s.attribute===n});if(G.isEmptyOrZeroLength(r)){let s=this.columns.columns.filter(n=>n.as?t.columnid===n.as:!1);G.isEmptyOrZeroLength(s)||(r=this.all_table_attributes.filter(n=>n.attribute===s[0].columnid&&s[0].tableid&&s[0].tableid===(n.table.as?n.table.as:n.table.tableid)))}return r[0]}async _checkEmptySQL(){let t=[];if(G.isEmptyOrZeroLength(this.all_table_attributes)&&!G.isEmptyOrZeroLength(this.columns.columns))return t;if(G.isEmptyOrZeroLength(this.all_table_attributes)&&G.isEmptyOrZeroLength(this.statement.from))try{let r=this._buildSQL(!1);t=await Me.promise(r)}catch(r){throw v.error("Error thrown from AlaSQL in SQLSearch class method checkEmptySQL."),v.error(r),new Error("There was a problem with the SQL statement")}return t}_addFetchColumns(t){t&&t.length>0&&t.forEach(r=>{let s=this._findColumn(r);s&&this.fetch_attributes.push(Gm(s))})}_addColumnToMergedAttributes(t,r){this.data[t].__merged_attributes.push(r),this.data[t].__merged_attr_map[r]=this.data[t].__merged_attributes.length-1}_setMergedHashAttribute(t,r){this.data[t].__merged_data[r].splice(0,1,r)}_updateMergedAttribute(t,r,s,n){let i=this.data[t].__merged_attr_map[s];this.data[t].__merged_data[r].splice(i,1,n)}async _getFetchAttributeValues(){if(G.isEmptyOrZeroLength(Object.keys(this.columns)))return[];this._addFetchColumns(this.columns.joins);let t=null;try{t=this.statement.where?this.statement.where.toString():""}catch{throw new Error("Could not generate proper where clause")}this.columns.where&&this._addFetchColumns(this.columns.where);let r=this._isSimpleSelect();if(r?this._addFetchColumns(this.columns.columns):(!this.columns.where&&this.fetch_attributes.length===0)|t.indexOf(HH)>-1&&this.tables.forEach(n=>{let i={columnid:global.hdb_schema[n.databaseid][n.tableid].hash_attribute,tableid:n.tableid};this._addFetchColumns([i])}),this.statement.order&&(this._updateOrderByToAliases(),this._addNonAggregatorsToFetchColumns()),this.fetch_attributes=hi.uniqBy(this.fetch_attributes,n=>[n.table.databaseid,n.table.as?n.table.as:n.table.tableid,n.attribute].join()),r)return await this._simpleSQLQuery();let s=this.fetch_attributes.reduce((n,i)=>{let o=`${i.table.databaseid}_${i.table.as?i.table.as:i.table.tableid}`,c=this.data[o].__hash_name;return n[o]||(n[o]=[],n[o].push(null),this._addColumnToMergedAttributes(o,c)),i.attribute!==c&&(n[o].push(null),this._addColumnToMergedAttributes(o,i.attribute)),n},{});for(let n of this.fetch_attributes){let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`,o=this.data[i].__hash_name,c={schema:n.table.databaseid,table:n.table.tableid,get_attributes:[n.attribute]},_=!1,u=[n.table.databaseid,n.table.tableid,n.attribute].join("/");if(n.attribute===o&&(_=!0),!G.isEmpty(this.exact_search_values[u])&&!this.exact_search_values[u].ignore&&!G.isEmptyOrZeroLength(this.exact_search_values[u].values))if(_)try{c.hash_values=Array.from(this.exact_search_values[u].values);let l=await cn.getDataByHash(c);for(let E of c.hash_values)E in l&&!this.data[i].__merged_data[E]&&(this.data[i].__merged_data[E]=[...s[i]],this._setMergedHashAttribute(i,E))}catch(l){v.error("Error thrown from getDataByHash function in SQLSearch class method getFetchAttributeValues exact match."),v.error(l)}else try{c.search_attribute=n.attribute,await Promise.all(Array.from(this.exact_search_values[u].values).map(async l=>{let E=Object.assign({},c);E.search_value=l;let d=await cn.getDataByValue(E);for(let S in d)this.data[i].__merged_data[S]?this._updateMergedAttribute(i,S,n.attribute,d[S][n.attribute]):(this.data[i].__merged_data[S]=[...s[i]],this._updateMergedAttribute(i,S,n.attribute,d[S][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(S)))}))}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues exact match."),v.error(l)}else if(!G.isEmpty(this.comparator_search_values[u])&&!this.comparator_search_values[u].ignore&&!G.isEmptyOrZeroLength(this.comparator_search_values[u].comparators))try{let l=this.comparator_search_values[u].comparators;for(let E=0,d=l.length;E<d;E++){let S=l[E];c.search_attribute=S.attribute,c.search_value=S.search_value;let m=await cn.getDataByValue(c,S.operation);if(_)for(let R in m)this.data[i].__merged_data[R]||(this.data[i].__merged_data[R]=[...s[i]],this._setMergedHashAttribute(i,G.autoCast(R)));else for(let R in m)this.data[i].__merged_data[R]?this._updateMergedAttribute(i,R,n.attribute,m[R][n.attribute]):(this.data[i].__merged_data[R]=[...s[i]],this._updateMergedAttribute(i,R,n.attribute,m[R][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(R)))}}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues comparator search values."),v.error(l)}else try{c.search_attribute=n.attribute,c.search_value="*";let l=await cn.getDataByValue(c);if(_)for(let E in l)this.data[i].__merged_data[E]||(this.data[i].__merged_data[E]=[...s[i]],this._setMergedHashAttribute(i,G.autoCast(E)));else for(let E in l)this.data[i].__merged_data[E]?this._updateMergedAttribute(i,E,n.attribute,l[E][n.attribute]):(this.data[i].__merged_data[E]=[...s[i]],this._updateMergedAttribute(i,E,n.attribute,l[E][n.attribute]),this._setMergedHashAttribute(i,G.autoCast(E)))}catch(l){v.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues no comparator search values."),v.error(l)}}}_isSimpleSelect(){let t=!0;return Object.keys(this.statement).length!==2||!this.statement.columns||!this.statement.from||this.statement.from.length!==1?(t=!1,t):(this.statement.columns.forEach(r=>{r instanceof Me.yy.Column||(t=!1)}),t)}_updateOrderByToAliases(){this.statement.order.forEach(t=>{if(t.expression.aggregatorid){t.is_aggregator=!0;return}if(t.expression.value){t.is_ordinal=!0,this.has_ordinal=!0;return}else t.is_ordinal=!1;let r=this.statement.columns.filter(n=>{let i=n.aggregatorid?n.expression:n,o=n.aggregatorid?n.as_orig:i.as_orig;return t.expression.tableid?i.columnid_orig===t.expression.columnid_orig&&i.tableid_orig===t.expression.tableid_orig:i.columnid_orig===t.expression.columnid_orig||t.expression.columnid_orig===o});r[0]||r.push(this._findColumn(t.expression));let s=r[0];if(t.is_func=!!s.funcid,t.is_aggregator=!!s.aggregatorid,s.as)if(s.as&&!t.expression.tableid)t.expression.columnid=s.as,t.expression.columnid_orig=s.as_orig;else{let n=new Me.yy.Column;n.columnid=s.as,n.columnid_orig=s.as_orig,t.expression=n}else{t.initial_select_column=Object.assign(new Me.yy.Column,t.expression),t.initial_select_column.as=`[${t.expression.columnid_orig}]`,t.expression.columnid=t.initial_select_column.as;return}if(!t.is_aggregator){let n=t.is_func?new Me.yy.FuncValue:new Me.yy.Column;t.initial_select_column=Object.assign(n,s)}})}_addNonAggregatorsToFetchColumns(){let r=this.statement.order.filter(s=>!s.is_aggregator&&!s.is_ordinal).map(s=>s.is_func?{columnid:s.initial_select_column.args.filter(i=>!!i.columnid_orig)[0].columnid_orig}:{columnid:s.expression.columnid_orig});this._addFetchColumns(r)}async _processJoins(){let t=[],r=[],s=this.statement.from[0],n=[s],i=["? "+(s.as?" AS "+s.as:s.tableid)];t.push(Object.values(this.data[`${s.databaseid_orig}_${s.as?s.as_orig:s.tableid_orig}`].__merged_data)),this.statement.joins&&this.statement.joins.forEach(S=>{S.joinmode&&S.joinmode!=="INNER"&&(this.has_outer_join=!0),n.push(S.table);let m=S.joinmode+" JOIN ? AS "+(S.as?S.as:S.table.tableid);S.on&&(m+=" ON "+S.on.toString()),i.push(m),t.push(Object.values(this.data[`${S.table.databaseid_orig}_${S.table.as?S.table.as_orig:S.table.tableid_orig}`].__merged_data))});let o=[],c={};n.forEach(S=>{let m=this.data[`${S.databaseid_orig}_${S.as?S.as_orig:S.tableid_orig}`].__hash_name,R=S.as?S.as_orig:S.tableid_orig;o.push({key:`'${R}.${m}'`,schema:S.databaseid_orig,table:S.as?S.as_orig:S.tableid_orig,keys:new Set}),r.push(`${S.as?S.as:S.tableid}.\`${m}\` AS "${R}.${m}"`),c[S.as?S.as_orig:S.tableid_orig]=this.data[`${S.databaseid_orig}_${S.as?S.as_orig:S.tableid_orig}`].__merged_attributes});let _=this.statement.where?"WHERE "+this.statement.where:"",u="";this.statement.order&&!this.has_ordinal&&!this.has_aggregator&&!this.statement.group&&this.statement.limit&&(u="ORDER BY "+this.statement.order.toString(),this.statement.order.forEach(S=>{S.is_func?r.push(S.initial_select_column.toString()):S.initial_select_column.tableid?r.push(`${S.initial_select_column.tableid}.${S.initial_select_column.columnid} AS ${S.expression.columnid}`):r.push(`${S.initial_select_column.columnid} AS ${S.expression.columnid}`)}));let l="",E="";!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(l=this.statement.limit?"LIMIT "+this.statement.limit:"",E=this.statement.offset?"OFFSET "+this.statement.offset:"");let d=[];try{let S=`SELECT ${r.join(", ")} FROM ${i.join(" ")} ${_} ${u} ${l} ${E}`,m=this._convertColumnsToIndexes(S,n);d=await Me.promise(m,t),t=null}catch(S){throw v.error("Error thrown from AlaSQL in SQLSearch class method processJoins."),v.error(S),new Error("There was a problem processing the data.")}if(d&&d.length>0){for(let S=0,m=d.length;S<m;S++){let R=d[S];o.forEach(w=>{R[w.key]!==null&&R[w.key]!==void 0&&w.keys.add(R[w.key])})}o.forEach(S=>{let m=Object.keys(this.data[`${S.schema}_${S.table}`].__merged_data),R=hi.difference(m,[...S.keys].map(w=>w.toString()));for(let w=0,L=R.length;w<L;w++){let B=R[w];delete this.data[`${S.schema}_${S.table}`].__merged_data[B]}})}return{existing_attributes:c,joined_length:d?d.length:0}}async _getFinalAttributeData(t,r){if(r===0)return;let s=[],n=new Uo(this.columns);for(let{node:i}of n)if(i&&i.columnid){let o=this._findColumn(i);if(o){let c=o.table.as?o.table.as:o.table.tableid;(!t[c]||t[c].indexOf(o.attribute)<0)&&s.push(o)}}s=hi.uniqBy(s,i=>[i.table.databaseid,i.table.as?i.table.as:i.table.tableid,i.attribute].join());try{await this._getData(s)}catch(i){v.error("Error thrown from getData in SQLSearch class method getFinalAttributeData."),v.error(i)}}async _getData(t){try{let r=t.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]?s[i].columns.push(n.attribute):s[i]={schema:n.table.databaseid,table:n.table.tableid,columns:[n.attribute]},s},{});for(let s in r){let n=r[s],i=this.data[s].__merged_data,o=[];for(let l in i)o.push(i[l][0]);this.data[s].__merged_attributes.push(...n.columns);let c={schema:n.schema,table:n.table,hash_values:o,get_attributes:n.columns},_=await cn.getDataByHash(c),u=n.columns.length;for(let l=0,E=o.length;l<E;l++){let d=o[l],S=_[d];for(let m=0;m<u;m++){let R=n.columns[m],w=S[R]===void 0?null:S[R];this.data[s].__merged_data[d].push(w)}}}}catch(r){throw v.error("Error thrown from getDataByHash function in SQLSearch class method getData."),v.error(r),r}}async _finalSQL(){let t=[],r=this.statement.from[0];t.push(Object.values(this.data[`${r.databaseid_orig}_${r.as?r.as_orig:r.tableid_orig}`].__merged_data)),r.as=r.as?r.as:r.tableid,r.databaseid="",r.tableid="?",this.statement.joins&&this.statement.joins.forEach(n=>{n.as=n.as?n.as:n.table.tableid,t.push(Object.values(this.data[`${n.table.databaseid_orig}_${n.table.as?n.table.as_orig:n.table.tableid_orig}`].__merged_data)),n.table.databaseid="",n.table.tableid="?"}),this.statement.order&&this.statement.order.forEach(n=>{if(n.is_ordinal)return;this.statement.columns.filter(o=>{let c=o.aggregatorid?o.expression:o,_=o.aggregatorid?o.as_orig:c.as_orig;return n.expression.tableid?c.columnid_orig===n.expression.columnid_orig&&c.tableid_orig===n.expression.tableid_orig:c.columnid_orig===n.expression.columnid_orig||n.expression.columnid_orig===_}).length===0&&(n.expression.columnid=n.initial_select_column.columnid)}),!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(this.statement.limit&&delete this.statement.limit,this.statement.offset&&delete this.statement.offset);let s;try{let n=this._buildSQL();v.trace(`Final SQL: ${n}`),s=await Me.promise(n,t),this.has_outer_join&&(s=this._translateUndefinedValues(s)),v.trace(`Final AlaSQL results data included ${s.length} rows`)}catch(n){throw v.error("Error thrown from AlaSQL in SQLSearch class method finalSQL."),v.error(n),new Error("There was a problem running the generated sql.")}return s}_translateUndefinedValues(t){try{let r=[];for(let s of t){let n=Object.create(null);Object.keys(s).forEach(i=>{s[i]===void 0?n[i]=null:n[i]=s[i]}),r.push(n)}return r}catch(r){return v.error(vH.HDB_ERROR_MSGS.OUTER_JOIN_TRANSLATION_ERROR),v.trace(r.stack),t}}_buildSQL(t=!0){let r=this.statement.toString();return this.statement.columns.forEach(s=>{if(s.funcid&&s.as){let n=s.toString().replace(" AS "+s.as,"");r=r.replace(s.toString(),n)}}),t===!0?this._convertColumnsToIndexes(r,this.tables):r}_convertColumnsToIndexes(t,r){let s=t,n={};r.forEach(i=>{i.databaseid_orig?n[`${i.databaseid_orig}_${i.as?i.as_orig:i.tableid_orig}`]=i.as?i.as:i.tableid:n[`${i.databaseid}_${i.as?i.as:i.tableid}`]=`\`${i.as?i.as:i.tableid}\``});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let _=n[i],u=new RegExp(`${_}.\`${o}\``,"g"),l=`${_}.[${c}]`;s=s.replace(u,l)});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let _=new RegExp(`\`${o}\``,"g"),u=`[${c}]`;s=s.replace(_,u)});return s}async _simpleSQLQuery(){let t=this.statement.columns.reduce((s,n)=>(n.as_orig&&n.as_orig!=n.columnid_orig?s[n.columnid_orig]=n.as_orig:s[n.columnid_orig]||(s[n.columnid_orig]=n.columnid_orig),s),{}),r=this.fetch_attributes.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]||(s[i]={}),s[i][t[n.attribute]]=null,s},{});for(let s of this.fetch_attributes){let n=`${s.table.databaseid}_${s.table.as?s.table.as:s.table.tableid}`,i={schema:s.table.databaseid,table:s.table.tableid,get_attributes:[s.attribute]};try{i.search_attribute=s.attribute,i.search_value="*";let o=await cn.getDataByValue(i);for(let c in o)this.data[n].__merged_data[c]||(this.data[n].__merged_data[c]=Object.assign({},r[n])),this.data[n].__merged_data[c][t[s.attribute]]=o[c][s.attribute]}catch(o){v.error("There was an error when processing this SQL operation.  Check your logs"),v.error(o)}}return Object.values(Object.values(this.data)[0].__merged_data)}};a(yo,"SQLSearch");qm.exports=yo});var Tt=h((EZ,km)=>{"use strict";var GH=zS();km.exports={searchByConditions:kH,searchByHash:xH,searchByValue:$H,search:YH};var ul=Or(),Vm=require("util"),qH=Vm.callbackify(ul.searchByHash),FH=Vm.callbackify(ul.searchByValue),VH=Fm();async function kH(e){return ul.searchByConditions(e)}a(kH,"searchByConditions");function xH(e,t){try{qH(e,(r,s)=>{if(r){t(r);return}t(null,s)})}catch(r){return t(r)}}a(xH,"searchByHash");function $H(e,t){try{e.hasOwnProperty("desc")===!0&&(e.reverse=e.desc),FH(e,(r,s)=>{if(r){t(r);return}t(null,s)})}catch(r){return t(r)}}a($H,"searchByValue");function YH(e,t){try{let r=new GH(e);r.validate(),new VH(r.statement,r.attributes).search().then(n=>{t(null,n)}).catch(n=>{t(n,null)})}catch(r){return t(r)}}a(YH,"search")});var Fr=h((dZ,Km)=>{"use strict";var Ti=require("crypto"),$m="aes-256-cbc",KH=32,QH=16,ll=64,Ym=32,WH=ll+Ym,xm=new Map;Km.exports={encrypt:JH,decrypt:ZH,createNatsTableStreamName:XH};function JH(e){let t=Ti.randomBytes(KH),r=Ti.randomBytes(QH),s=Ti.createCipheriv($m,Buffer.from(t),r),n=s.update(e);n=Buffer.concat([n,s.final()]);let i=t.toString("hex"),o=r.toString("hex"),c=n.toString("hex");return i+o+c}a(JH,"encrypt");function ZH(e){let t=e.substr(0,ll),r=e.substr(ll,Ym),s=e.substr(WH,e.length),n=Buffer.from(r,"hex"),i=Buffer.from(s,"hex"),o=Ti.createDecipheriv($m,Buffer.from(t,"hex"),n),c=o.update(i);return c=Buffer.concat([c,o.final()]),c.toString()}a(ZH,"decrypt");function XH(e,t){let r=`${e}.${t}`,s=xm.get(r);return s||(s=Ti.createHash("md5").update(`${e}.${t}`).digest("hex"),xm.set(r,s)),s}a(XH,"createNatsTableStreamName")});var un=h((SZ,jm)=>{"use strict";var Wm=Tt(),Vr=I(),Jm=Ka(),zH=require("lodash"),jH=require("path"),eG=Fr(),El=C(),{promisify:Zm}=require("util"),j=T(),{handleHDBError:Do,hdb_errors:tG}=D(),{HDB_ERROR_MSGS:Mo,HTTP_STATUS_CODES:Xm}=tG,rG=Y();rG.initSync();var Qm=z(),sG=te(),mi=Zm(Wm.searchByValue),nG=Zm(Wm.searchByHash),_n="name",zm="hash_attribute",dl="schema",iG="schema_table",aG="attribute";jm.exports={describeAll:oG,describeTable:Po,describeSchema:_G};async function oG(e){try{let t=El.isEmptyOrZeroLength(e),r,s;t||(r=e.hdb_user.role.permission,s=r.super_user||r.cluster_user);let n={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,search_attribute:_n,search_value:j.WILDCARD_SEARCH_VALUE,get_attributes:[_n]},i=await mi(n);if(El.isEmptyOrZeroLength(i))return{};let o={},c={};for(let d in i)o[i[d].name]=!0,!t&&!s&&(c[i[d].name]=r[i[d].name].describe);let _={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,search_attribute:j.ID_ATTRIBUTE_STRING,search_value:j.WILDCARD_SEARCH_VALUE,get_attributes:[zm,j.ID_ATTRIBUTE_STRING,_n,dl]},u=await mi(_),l=[];for(let d of u)try{let S;if(t||s)S=await Po({schema:d.schema,table:d.name});else if(r&&r[d.schema].describe&&r[d.schema].tables[d.name].describe){let m=r[d.schema].tables[d.name].attribute_permissions;S=await Po({schema:d.schema,table:d.name},m)}S&&l.push(S)}catch(S){Vr.error(S)}let E={};for(let d in l)t||s?(E[l[d].schema]==null&&(E[l[d].schema]={}),E[l[d].schema][l[d].name]=l[d],o[l[d].schema]&&delete o[l[d].schema]):c[l[d].schema]&&(E[l[d].schema]==null&&(E[l[d].schema]={}),E[l[d].schema][l[d].name]=l[d],o[l[d].schema]&&delete o[l[d].schema]);for(let d in o)t||s?E[d]={}:c[d]&&(E[d]={});return E}catch(t){return Vr.error("Got an error in describeAll"),Vr.error(t),Do(new Error,Mo.DESCRIBE_ALL_ERR)}}a(oG,"describeAll");async function Po(e,t){let{schema:r,table:s}=e;r=r.toString(),s=s.toString();let n=t;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(n=e.hdb_user.role.permission[r].tables[s].attribute_permissions);let i={},o=Jm.describe_table(e);if(o)throw o;if(r===j.SYSTEM_SCHEMA_NAME)return global.hdb_schema[j.SYSTEM_SCHEMA_NAME][s];let c={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.TABLE_TABLE_HASH_ATTRIBUTE,search_attribute:_n,search_value:s,hash_values:[],get_attributes:[j.WILDCARD_SEARCH_VALUE]},_=await mi(c);if(!_||_.length===0)throw Do(new Error,Mo.TABLE_NOT_FOUND(e.schema,e.table),Xm.NOT_FOUND);for await(let u of _)try{if(u.schema!==r)continue;if(i=u,!i.hash_attribute)throw Do(new Error,Mo.INVALID_TABLE_ERR(i));let l={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.ATTRIBUTE_TABLE_HASH_ATTRIBUTE,search_attribute:iG,search_value:r+"."+s,get_attributes:[aG]},E=await mi(l);E=zH.uniqBy(E,d=>d.attribute),n&&n.length>0&&(E=cG(n)),i.attributes=E,i.clustering_stream_name=eG.createNatsTableStreamName(u.schema,u.name);try{let d=jH.join(sG.getBaseSchemaPath(),i.schema.toString()),S=await Qm.openEnvironment(d,i.name),m=Qm.statDBI(S,i.hash_attribute);i.record_count=m.entryCount}catch(d){Vr.warn(`unable to stat table dbi due to ${d}`)}}catch(l){Vr.error(`There was an error getting attributes for table '${u.name}'`),Vr.error(l)}return i}a(Po,"descTable");function cG(e){return e.reduce((t,r)=>(r.describe&&t.push({attribute:r.attribute_name}),t),[])}a(cG,"getAttrsByPerms");async function _G(e){let t=Jm.schema_object(e);if(t)throw t;let r;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(r=e.hdb_user.role.permission[e.schema]);let s=e.schema.toString(),n={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.TABLE_TABLE_HASH_ATTRIBUTE,search_attribute:dl,search_value:s,hash_values:[],get_attributes:[zm,j.ID_ATTRIBUTE_STRING,_n,dl]},i=await mi(n);if(i&&i.length<1){let o={schema:j.SYSTEM_SCHEMA_NAME,table:j.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,hash_attribute:j.SYSTEM_TABLE_HASH_ATTRIBUTES.SCHEMA_TABLE_HASH_ATTRIBUTE,hash_values:[s],get_attributes:[_n]},c=await nG(o);if(c&&c.length<1)throw Do(new Error,Mo.SCHEMA_NOT_FOUND(e.schema),Xm.NOT_FOUND);return{}}else{let o={};return await Promise.all(i.map(async c=>{try{let _;if(r&&r.tables[c.name]&&(_=r.tables[c.name]),El.isEmpty(_)||_.describe){let u=await Po({schema:e.schema,table:c.name},_?_.attribute_permissions:null);u&&(o[u.name]=u)}}catch(_){Vr.error(`Error describing schema table '${e.schema}.${c}'`),Vr.error(_)}})),o}}a(_G,"describeSchema")});var hs=h((TZ,nR)=>{var hZ=require("async"),ln=as(),fZ=I(),{callbackify:rR,promisify:uG}=require("util");nR.exports={setSchemaDataToGlobal:eR,getTableSchema:dG,getSystemSchema:hG,setSchemaDataToGlobalAsync:uG(eR)};var sR=un(),lG=rR(sR.describeAll),EG=rR(sR.describeTable);function eR(e){lG(null,(t,r)=>{if(t){e(t);return}r.system||(r.system=ln),global.hdb_schema=r,e(null,null)})}a(eR,"setSchemaDataToGlobal");function tR(e,t){return e==="system"?ln[t]:global.hdb_schema[e][t]}a(tR,"returnSchema");function dG(e,t,r){!global.hdb_schema||!global.hdb_schema[e]||!global.hdb_schema[e][t]?SG(e,t,s=>{if(s)return r(s);if(!global.hdb_schema[e])return r(`schema ${e} does not exist`);if(!global.hdb_schema[e]||!global.hdb_schema[e][t])return r(`table ${e}.${t} does not exist`);r(null,tR(e,t))}):r(null,tR(e,t))}a(dG,"getTableSchema");function SG(e,t,r){let s={table:t,schema:e};if(e==="system"){global.hdb_schema?global.hdb_schema.system=ln:global.hdb_schema={system:ln},r();return}EG(s,(n,i)=>{if(n){r(n);return}if(!i.schema&&!i.name){r();return}global.hdb_schema||(global.hdb_schema={system:ln}),global.hdb_schema[e]||(global.hdb_schema[e]={}),global.hdb_schema[e][t]=i,r()})}a(SG,"setTableDataToGlobal");function hG(){return ln}a(hG,"getSystemSchema")});var he=h((RZ,aR)=>{"use strict";var{platform:mZ}=require("os"),fG="nats-server.zip",Sl="nats-server",TG=process.platform==="win32"?`${Sl}.exe`:Sl,hl="HDB",mG=/^[^\s.,*>]+$/,iR="__request__",RG=a(e=>`${e}.${iR}`,"REQUEST_SUBJECT"),AG={HUB_SERVER:"hub.json",LEAF_SERVER:"leaf.json"},OG={HUB:"hub.pid",LEAF:"leaf.pid"},pG={HUB:"-hub",LEAF:"-leaf",ADMIN:"-admin"},NG={stream_name:"__HARPERDB_WORK_QUEUE__",durable_name:"HDB_WORK_QUEUE",deliver_group:hl,deliver_subject:"__HDB__.WORKQUEUE"},gG={stream_name:"__HARPERDB_SCHEMA_QUEUE__",durable_name:"HDB_SCHEMA_QUEUE",deliver_group:hl,deliver_subject:"HDB.SCHEMAQUEUE"},IG={stream_name:"__HARPERDB_USER_QUEUE__",durable_name:"HDB_USER_QUEUE",deliver_group:hl,deliver_subject:"HDB.USERQUEUE"},CG={SUCCESS:"success",ERROR:"error"},bG={OPEN:"open",CLOSED:"closed",NO_RESPONDERS:"NoResponders",TIMEOUT:"Timeout"},wG={TXN:"txn",MSGID:"msgid"};aR.exports={NATS_SERVER_ZIP:fG,NATS_SERVER_NAME:Sl,NATS_BINARY_NAME:TG,PID_FILES:OG,NATS_CONFIG_FILES:AG,SERVER_SUFFIX:pG,WORK_QUEUE_CONSUMER_NAMES:NG,SCHEMA_QUEUE_CONSUMER_NAMES:gG,USER_QUEUE_CONSUMER_NAMES:IG,NATS_TERM_CONSTRAINTS_RX:mG,REQUEST_SUFFIX:iR,UPDATE_REMOTE_RESPONSE_STATUSES:CG,CLUSTER_STATUS_STATUSES:bG,REQUEST_SUBJECT:RG,SUBJECT_PREFIXES:wG}});var cR=h((AZ,oR)=>{"use strict";var LG=he(),Bo=class{constructor(t,r,s,n,i,o,c,_,u,l,E,d,S){this.port=t,this.server_name=r+LG.SERVER_SUFFIX.HUB,this.pid_file=s,this.max_payload=1e7,this.jetstream={enabled:!1},this.tls={cert_file:n,key_file:i,ca_file:o,insecure:c},this.leafnodes={port:_,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.cluster={name:u,port:l,routes:E,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.accounts={SYS:{users:d},HDB:{users:S}},this.system_account="SYS"}};a(Bo,"HubConfigObject");oR.exports=Bo});var lR=h((OZ,uR)=>{"use strict";var _R=he(),vo=class{constructor(t,r,s,n,i,o,c,_,u,l,E,d){this.port=t,this.server_name=r+_R.SERVER_SUFFIX.LEAF,this.pid_file=s,this.max_payload=1e7,this.jetstream={enabled:!0,store_dir:n,domain:r+_R.SERVER_SUFFIX.LEAF},this.tls={cert_file:u,key_file:l,ca_file:E,insecure:d},this.leafnodes={remotes:[{tls:{ca_file:E,insecure:d},urls:i,account:"SYS"},{tls:{ca_file:E,insecure:d},urls:o,account:"HDB"}]},this.accounts={SYS:{users:c},HDB:{users:_,jetstream:"enabled"}},this.system_account="SYS"}};a(vo,"LeafConfigObject");uR.exports=vo});var dR=h((pZ,ER)=>{"use strict";var Ho=class{constructor(t,r){this.user=t,this.password=r}};a(Ho,"HdbUserObject");ER.exports=Ho});var hR=h((NZ,SR)=>{"use strict";var UG=he(),Go=class{constructor(t,r){this.user=t+UG.SERVER_SUFFIX.ADMIN,this.password=r}};a(Go,"SysUserObject");SR.exports=Go});var Ut=h((gZ,mR)=>{"use strict";var Fo=Pu(),Lt=C(),yG=require("util"),Vo=Or(),DG=hs(),fl=I(),{handleHDBError:kr,hdb_errors:MG}=D(),{HTTP_STATUS_CODES:fs}=MG,PG=yG.promisify(DG.getTableSchema),BG="updated",fR="inserted",TR="upserted";mR.exports={insert:HG,update:GG,upsert:qG,validation:vG,flush:FG};async function vG(e){if(Lt.isEmpty(e))throw new Error("invalid update parameters defined.");if(Lt.isEmptyOrZeroLength(e.schema))throw new Error("invalid schema specified.");if(Lt.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");let t=await PG(e.schema,e.table),r=Fo(e);if(r)throw r;if(!Array.isArray(e.records))throw new Error("records must be an array");let s=t.hash_attribute,n=new Set,i={},o=!1;return e.operation==="update"&&(o=!0),e.records.forEach(c=>{if(o&&Lt.isEmptyOrZeroLength(c[s]))throw fl.error("a valid hash attribute must be provided with update record:",c),new Error("a valid hash attribute must be provided with update record");if(!Lt.isEmptyOrZeroLength(c[s])&&(c[s]==="null"||c[s]==="undefined"))throw fl.error(`a valid hash value must be provided with ${e.operation} record:`,c),new Error(`"${c[s]}" is not a valid hash attribute value`);!Lt.isEmpty(c[s])&&c[s]!==""&&n.has(Lt.autoCast(c[s]))&&(c.skip=!0),n.add(Lt.autoCast(c[s]));for(let _ in c)i[_]=1}),i[s]=1,{schema_table:t,hashes:Array.from(n),attributes:Object.keys(i)}}a(vG,"validation");async function HG(e){if(e.operation!=="insert")throw new Error("invalid operation, must be insert");let t=Fo(e);if(t)throw kr(new Error,t.message,fs.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw kr(new Error,r,fs.BAD_REQUEST);try{let s=await Vo.createRecords(e);return qo(fR,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time)}catch(s){throw s}}a(HG,"insertData");async function GG(e){if(e.operation!=="update")throw new Error("invalid operation, must be update");let t=Fo(e);if(t)throw kr(new Error,t.message,fs.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw kr(new Error,r,fs.BAD_REQUEST);try{let s=await Vo.updateRecords(e);return Lt.isEmpty(s.existing_rows)?qo(BG,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time):qo(s.update_action,[],e,s.hashes,void 0,s.txn_time)}catch(s){throw s}}a(GG,"updateData");async function qG(e){if(e.operation!=="upsert")throw kr(new Error,"invalid operation, must be upsert",fs.INTERNAL_SERVER_ERROR);let t=Fo(e);if(t)throw kr(new Error,t.message,fs.BAD_REQUEST);let r=Lt.checkSchemaTableExist(e.schema,e.table);if(r)throw kr(new Error,r,fs.BAD_REQUEST);try{let s=await Vo.upsertRecords(e);return qo(TR,s.written_hashes,e,[],s.new_attributes,s.txn_time)}catch(s){let n=`There was an error during an upsert op: ${s}`;throw kr(s,null,null,fl.ERR,n)}}a(qG,"upsertData");function qo(e,t,r,s,n,i){let o={message:`${e} ${t.length} of ${t.length+s.length} records`,new_attributes:n,txn_time:i};return e===fR?(o.inserted_hashes=t,o.skipped_hashes=s,o):e===TR?(o.upserted_hashes=t,o):(o.update_hashes=t,o.skipped_hashes=s,o)}a(qo,"returnObject");function FG(e){return Vo.flush(e.schema,e.table)}a(FG,"flush")});var ml=h((IZ,OR)=>{var VG=de(),Tl=require("joi"),{hdb_schema_table:RR}=Tr(),AR={schema:RR,table:RR},kG={date:Tl.date().iso().required()},xG={timestamp:Tl.date().timestamp().required().messages({"date.format":"'timestamp' is invalid"})};OR.exports=function(e,t){let r=t==="timestamp"?{...AR,...xG}:{...AR,...kG},s=Tl.object(r);return VG.validateBySchema(e,s)}});var IR=h((CZ,gR)=>{var $G=de(),pR=require("joi"),{hdb_schema_table:NR}=Tr(),YG=pR.object({schema:NR,table:NR,hash_values:pR.array().required()});gR.exports=function(e){return $G.validateBySchema(e,YG)}});var bR=h((bZ,CR)=>{"use strict";var ko=class{constructor(t,r,s,n,i){this.operation=t,this.schema=r,this.table=s,this.hash_attribute=n,this.records=i}};a(ko,"InsertObject");var xo=class{constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.search_attribute=s,this.hash_attribute=n,this.get_attributes=i,this.search_value=o}};a(xo,"NoSQLSeachObject");var $o=class{constructor(){this.message=void 0,this.deleted_hashes=[],this.skipped_hashes=[]}};a($o,"DeleteResponseObject");CR.exports={InsertObject:ko,NoSQLSeachObject:xo,DeleteResponseObject:$o}});var ms=h((wZ,DR)=>{"use strict";var LR=ml(),KG=IR(),Yo=C(),wR=require("moment"),UR=I(),{promisify:QG,callbackify:WG}=require("util"),Ts=T(),JG=hs(),Rl=QG(JG.getTableSchema),Al=Or(),{DeleteResponseObject:ZG}=bR(),{handleHDBError:xr,hdb_errors:XG}=D(),{HDB_ERROR_MSGS:Ko,HTTP_STATUS_CODES:$r}=XG,zG="records successfully deleted",jG=WG(yR);DR.exports={delete:jG,deleteRecord:yR,deleteFilesBefore:eq,deleteAuditLogsBefore:tq};async function eq(e){let t=LR(e,"date");if(t)throw xr(t,t.message,$r.BAD_REQUEST,void 0,void 0,!0);if(!wR(e.date,wR.ISO_8601).isValid())throw xr(new Error,Ko.INVALID_DATE,$r.BAD_REQUEST,Ts.LOG_LEVELS.ERROR,Ko.INVALID_DATE,!0);let s=Yo.checkSchemaTableExist(e.schema,e.table);if(s)throw xr(new Error,s,$r.NOT_FOUND,Ts.LOG_LEVELS.ERROR,s,!0);try{let n=await Al.deleteRecordsBefore(e);if(await Rl(e.schema,e.table),UR.info(`Finished deleting files before ${e.date}`),n&&n.message)return n.message}catch(n){throw n}}a(eq,"deleteFilesBefore");async function tq(e){let t=LR(e,"timestamp");if(t)throw xr(t,t.message,$r.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e.timestamp))throw xr(new Error,Ko.INVALID_VALUE("Timestamp"),$r.BAD_REQUEST,Ts.LOG_LEVELS.ERROR,Ko.INVALID_VALUE("Timestamp"),!0);let r=Yo.checkSchemaTableExist(e.schema,e.table);if(r)throw xr(new Error,r,$r.NOT_FOUND,Ts.LOG_LEVELS.ERROR,r,!0);try{let s=await Al.deleteAuditLogsBefore(e);return await Rl(e.schema,e.table),UR.info(`Finished deleting audit logs before ${e.timestamp}`),s}catch(s){throw s}}a(tq,"deleteAuditLogsBefore");async function yR(e){let t=KG(e);if(t)throw xr(t,t.message,$r.BAD_REQUEST,void 0,void 0,!0);let r=Yo.checkSchemaTableExist(e.schema,e.table);if(r)throw xr(new Error,r,$r.NOT_FOUND,Ts.LOG_LEVELS.ERROR,r,!0);try{await Rl(e.schema,e.table);let s=await Al.deleteRecords(e);return Yo.isEmptyOrZeroLength(s.message)&&(s.message=`${s.deleted_hashes.length} of ${e.hash_values.length} ${zG}`),s}catch(s){if(s.message===Ts.SEARCH_NOT_FOUND_MESSAGE){let n=new ZG;return n.message=Ts.SEARCH_NOT_FOUND_MESSAGE,n.skipped_hashes=e.hash_values.length,n.deleted_hashes=0,n}throw s}}a(yR,"deleteRecord")});var Qo=h((LZ,BR)=>{var rq=require("crypto"),MR=9;function sq(e){let t=iq(MR),r=PR(e+t);return t+r}a(sq,"createHash");function nq(e,t){let r=e.substr(0,MR),s=r+PR(t+r);return e===s}a(nq,"validateHash");function iq(e){let t="0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ",r=t.length,s="";for(let n=0;n<e;n++){let i=Math.floor(Math.random()*r);s+=t[i]}return s}a(iq,"generateSalt");function PR(e){return rq.createHash("md5").update(e).digest("hex")}a(PR,"md5");BR.exports={hash:sq,validate:nq}});var HR=h((UZ,vR)=>{var Ol=de(),We={username:{presence:!0,format:"[\\w\\-\\_]+",exclusion:{within:["system"],message:"You cannot create tables within the system schema"}},password:{presence:!0},role:{presence:!0,format:"[\\w\\-\\_]+"},active:{presence:!0,inclusion:{within:[!0,!1],message:"must be a boolean"}}};function aq(e){return We.password.presence=!0,We.username.presence=!0,We.role.presence=!0,We.active.presence=!0,Ol.validateObject(e,We)}a(aq,"addUserValidation");function oq(e){return We.password.presence=!1,We.username.presence=!0,We.role.presence=!1,We.active.presence=!1,Ol.validateObject(e,We)}a(oq,"alterUserValidation");function cq(e){return We.password.presence=!1,We.username.presence=!0,We.role.presence=!1,We.active.presence=!1,Ol.validateObject(e,We)}a(cq,"dropUserValidation");vR.exports={addUserValidation:aq,alterUserValidation:oq,dropUserValidation:cq}});var qR=h((yZ,GR)=>{"use strict";var Yr=T(),Ri=class{constructor(t=0,r=Yr.STORAGE_TYPES_ENUM.LMDB,s=Yr.LICENSE_VALUES.API_CALL_DEFAULT,n=Yr.RAM_ALLOCATION_ENUM.DEFAULT,i=Yr.LICENSE_VALUES.VERSION_DEFAULT,o){this.exp_date=t,this.storage_type=r,this.api_call=s,this.ram_allocation=n,this.version=i,this.fingerprint=o}};a(Ri,"BaseLicense");var Wo=class extends Ri{constructor(t=0,r=Yr.STORAGE_TYPES_ENUM.LMDB,s=Yr.LICENSE_VALUES.API_CALL_DEFAULT,n=Yr.RAM_ALLOCATION_ENUM.DEFAULT,i=Yr.LICENSE_VALUES.VERSION_DEFAULT,o,c=!1){super(t,r,s,n,i,o),this.enterprise=c}};a(Wo,"ExtendedLicense");GR.exports={BaseLicense:Ri,ExtendedLicense:Wo}});var Ai=h((DZ,YR)=>{"use strict";var dn=require("fs-extra"),FR=Qo(),VR=require("crypto"),_q=require("moment"),uq=require("uuid").v4,Je=I(),Nl=require("path"),lq=C(),mt=T(),Eq=qR().ExtendedLicense,En="invalid license key format",dq="061183",Sq="mofi25",hq="aes-256-cbc",fq=16,Tq=32,kR=Y();kR.initSync();var pl;YR.exports={validateLicense:xR,generateFingerPrint:Rq,licenseSearch:$R,getLicense:pq};function gl(){return Nl.join(kR.getHdbBasePath(),mt.LICENSE_KEY_DIR_NAME,mt.LICENSE_FILE_NAME)}a(gl,"getLicenseDirPath");function mq(){let e=gl();return Nl.join(e,mt.LICENSE_FILE_NAME)}a(mq,"getLicenseFilePath");function Il(){let e=gl();return Nl.join(e,mt.REG_KEY_FILE_NAME)}a(Il,"getFingerPrintFilePath");async function Rq(){let e=Il();try{return await dn.readFile(e,"utf8")}catch(t){if(t.code==="ENOENT")return await Aq();throw Je.error(`Error writing fingerprint file to ${e}`),Je.error(t),new Error("There was an error generating the fingerprint")}}a(Rq,"generateFingerPrint");async function Aq(){let e=uq(),t=FR.hash(e),r=Il();try{await dn.mkdirp(gl()),await dn.writeFile(r,t)}catch(s){if(s.code==="EEXIST")return t;throw Je.error(`Error writing fingerprint file to ${r}`),Je.error(s),new Error("There was an error generating the fingerprint")}return t}a(Aq,"writeFingerprint");function xR(e,t){let r={valid_license:!1,valid_date:!1,valid_machine:!1,exp_date:null,storage_type:mt.STORAGE_TYPES_ENUM.LMDB,api_call:mt.LICENSE_VALUES.API_CALL_DEFAULT,ram_allocation:mt.RAM_ALLOCATION_ENUM.DEFAULT,version:mt.LICENSE_VALUES.VERSION_DEFAULT};if(!e)return Je.error("empty license key passed to validate."),r;let s=Il(),n=!1;try{n=dn.statSync(s)}catch(i){Je.error(i)}if(n){let i;try{i=dn.readFileSync(s,"utf8")}catch{Je.error("error validating this machine in the license"),r.valid_machine=!1;return}let o=e.split(Sq),c=o[1];c=Buffer.concat([Buffer.from(c)],fq);let _=Buffer.concat([Buffer.from(i)],Tq),u=VR.createDecipheriv(hq,_,c);r.valid_date=!0,r.valid_license=!0,r.valid_machine=!0;let l=null;try{l=u.update(o[0],"hex","utf8"),l.trim(),l+=u.final("utf8")}catch{let S=Oq(o[0],i);if(S)l=S;else throw r.valid_license=!1,r.valid_machine=!1,console.error(En),Je.error(En),new Error(En)}let E;if(isNaN(l))try{E=JSON.parse(l),r.api_call=E.api_call,r.version=E.version,r.storage_type=E.storage_type,r.exp_date=E.exp_date,isNaN(r.exp_date)&&(r.exp_date=new Date(r.exp_date).getTime()),E.ram_allocation&&(r.ram_allocation=E.ram_allocation)}catch{throw console.error(En),Je.error(En),new Error(En)}else r.exp_date=l;r.exp_date<_q().valueOf()&&(r.valid_date=!1),FR.validate(o[1],`${dq}${i}${t}`)||(r.valid_license=!1)}else r.valid_license=!1,r.valid_machine=!1;return r.valid_license&&r.valid_machine&&r.valid_date||Je.error("Invalid licence"),r}a(xR,"validateLicense");function Oq(e,t){try{let r=VR.createDecipher("aes192",t),s=r.update(e,"hex","utf8");return s.trim(),s+=r.final("utf8"),s}catch{Je.warn("Check old license failed")}}a(Oq,"checkOldLicense");function $R(){let e=new Eq;e.api_call=0;let t=[];try{t=dn.readFileSync(mq(),"utf-8").split(mt.NEW_LINE)}catch(r){r.code==="ENOENT"?Je.info("no license file found"):Je.error(`could not search for licenses due to: '${r.message}`)}for(let r=0;r<t.length;++r){let s=t[r];try{if(lq.isEmptyOrZeroLength(s))continue;let n=JSON.parse(s),i=xR(n.license_key,n.company);i.valid_machine===!0&&i.valid_date===!0&&i.valid_machine===!0&&(e.exp_date=i.exp_date>e.exp_date?i.exp_date:e.exp_date,e.api_call+=i.api_call,e.ram_allocation=i.ram_allocation,e.storage_type=i.storage_type,e.enterprise=!0)}catch(n){Je.error("There was an error parsing the license string."),Je.error(n),e.api_call=mt.LICENSE_VALUES.API_CALL_DEFAULT,e.ram_allocation=mt.RAM_ALLOCATION_ENUM.DEFAULT,e.storage_type=mt.STORAGE_TYPES_ENUM.LMDB,e.enterprise=!1}}return e.api_call===0&&(e.api_call=mt.LICENSE_VALUES.API_CALL_DEFAULT),pl=e,e}a($R,"licenseSearch");async function pq(){return pl||await $R(),pl}a(pq,"getLicense")});var Kr=h((MZ,iA)=>{"use strict";var JR="username is required",ZR="nothing to update, must supply active, role or password to update",XR="password cannot be an empty string",zR="If role is specified, it cannot be empty.",jR="active must be true or false";iA.exports={addUser:Uq,alterUser:yq,dropUser:Mq,userInfo:Pq,listUsers:Zo,listUsersExternal:Bq,setUsersToGlobal:Oi,findAndValidateUser:Gq,getClusterUser:qq,USERNAME_REQUIRED:JR,ALTERUSER_NOTHING_TO_UPDATE:ZR,EMPTY_PASSWORD:XR,EMPTY_ROLE:zR,ACTIVE_BOOLEAN:jR};var eA=Ut(),Nq=ms(),bl=Qo(),tA=HR(),rA=Tt(),wl=Zs(),be=C(),sA=require("validate.js"),H=I(),{promisify:Ll}=require("util"),Ul=Fr(),Rs=T(),KR=he(),gq=hr(),yl=Y(),Iq=Ai(),Cq=as(),{handleHDBError:rr,hdb_errors:bq}=D(),{HTTP_STATUS_CODES:sr,AUTHENTICATION_ERROR_MSGS:Cl,HDB_ERROR_MSGS:Sn}=bq,{UserEventMsg:Dl}=us(),QR=require("lodash"),nA={username:!0,active:!0,role:!0,password:!0},WR=new Map,Jo=Ll(rA.searchByValue),wq=Ll(rA.searchByHash),Lq=Ll(Nq.delete);async function Uq(e){let t=sA.cleanAttributes(e,nA),r=tA.addUserValidation(t);if(r)throw rr(new Error,r.message,sr.BAD_REQUEST,void 0,void 0,!0);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["id","permission","role"]},n;try{n=await Jo(s)}catch(u){throw H.error("There was an error searching for a role in add user"),H.error(u),u}if(!n||n.length<1)throw rr(new Error,Sn.ROLE_NAME_NOT_FOUND(t.role),sr.NOT_FOUND,void 0,void 0,!0);if(n.length>1)throw rr(new Error,Sn.DUP_ROLES_FOUND(t.role),sr.CONFLICT,void 0,void 0,!0);n[0].permission.cluster_user===!0&&(t.hash=Ul.encrypt(t.password)),t.password=bl.hash(t.password),t.role=n[0].id;let i={operation:"insert",schema:"system",table:"hdb_user",records:[t]},o;try{o=await eA.insert(i)}catch(u){throw H.error("There was an error searching for a user."),H.error(u),u}H.debug(o);try{await Oi()}catch(u){throw H.error("Got an error setting users to global"),H.error(u),u}if(o.skipped_hashes.length===1)throw rr(new Error,Sn.USER_ALREADY_EXISTS(t.username),sr.CONFLICT,void 0,void 0,!0);let c=Object.assign({},t);c.role=n[0];let _={user:null};return _.user=c,be.sendTransactionToSocketCluster(Rs.INTERNAL_SC_CHANNELS.ADD_USER,_,yl.get(Rs.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),wl.signalUserChange(new Dl(process.pid)),`${c.username} successfully added`}a(Uq,"addUser");async function yq(e){let t=sA.cleanAttributes(e,nA);if(be.isEmptyOrZeroLength(t.username))throw new Error(JR);if(be.isEmptyOrZeroLength(t.password)&&be.isEmptyOrZeroLength(t.role)&&be.isEmptyOrZeroLength(t.active))throw new Error(ZR);if(!be.isEmpty(t.password)&&be.isEmptyOrZeroLength(t.password.trim()))throw new Error(XR);if(!be.isEmpty(t.active)&&!be.isBoolean(t.active))throw new Error(jR);let r=Dq(t.username);if(!be.isEmpty(t.password)&&!be.isEmptyOrZeroLength(t.password.trim())&&(r&&(t.hash=Ul.encrypt(t.password)),t.password=bl.hash(t.password)),t.role==="")throw new Error(zR);if(t.role){let o={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["*"]},c;try{c=await Jo(o)}catch(_){throw H.error("Got an error searching for a role."),H.error(_),_}if(!c||c.length===0){let _=Sn.ALTER_USER_ROLE_NOT_FOUND(t.role);throw H.error(_),rr(new Error,_,sr.NOT_FOUND,void 0,void 0,!0)}if(c.length>1){let _=Sn.ALTER_USER_DUP_ROLES(t.role);throw H.error(_),rr(new Error,_,sr.CONFLICT,void 0,void 0,!0)}t.role=c[0].id}let s={operation:"update",schema:"system",table:"hdb_user",records:[t]},n;try{n=await eA.update(s)}catch(o){throw H.error("Error during update."),H.error(o),o}try{await Oi()}catch(o){throw H.error("Got an error setting users to global"),H.error(o),o}let i={user:null};return i.user=t,be.sendTransactionToSocketCluster(Rs.INTERNAL_SC_CHANNELS.ALTER_USER,i,yl.get(Rs.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),wl.signalUserChange(new Dl(process.pid)),n}a(yq,"alterUser");function Dq(e){let t=!1,r=global.hdb_users.get(e);return r&&r.role.permission.cluster_user===!0&&(t=!0),t}a(Dq,"isClusterUser");async function Mq(e){try{let t=tA.dropUserValidation(e);if(t)throw new Error(t);let r={table:"hdb_user",schema:"system",hash_values:[e.username]};if(be.isEmpty(global.hdb_users.get(e.username)))throw rr(new Error,Sn.USER_NOT_EXIST(e.username),sr.NOT_FOUND,void 0,void 0,!0);let s;try{s=await Lq(r)}catch(i){throw H.error("Got an error deleting a user."),H.error(i),i}H.debug(s);try{await Oi()}catch(i){throw H.error("Got an error setting users to global."),H.error(i),i}let n={user:null};return n.user=e,be.sendTransactionToSocketCluster(Rs.INTERNAL_SC_CHANNELS.DROP_USER,n,yl.get(Rs.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY)),wl.signalUserChange(new Dl(process.pid)),`${e.username} successfully deleted`}catch(t){throw t}}a(Mq,"dropUser");async function Pq(e){let t={};try{if(!e||!e.hdb_user)return"There was no user info in the body";t=e.hdb_user;let r={schema:"system",table:"hdb_role",hash_values:[t.role.id],get_attributes:["*"]},s;try{s=await wq(r)}catch(n){throw H.error("Got an error searching for a role."),H.error(n),n}t.role=s[0],delete t.password,delete t.refresh_token,delete t.hash}catch(r){throw H.error(r),r}return t}a(Pq,"userInfo");async function Bq(){let e;try{e=await Zo()}catch(t){throw H.error("Got an error listing users."),H.error(t),t}try{e.forEach(t=>{delete t.password,delete t.hash,delete t.refresh_token})}catch{throw new Error("there was an error massaging the user data")}return[...e.values()]}a(Bq,"listUsersExternal");async function Zo(){try{let e={schema:"system",table:"hdb_role",search_value:"*",search_attribute:"role",get_attributes:["*"]},t;try{t=QR.cloneDeep(await Jo(e))}catch(r){throw H.error("Got an error searching for roles."),H.error(r),r}if(!be.isEmptyOrZeroLength(t)){let r={};for(let o in t)r[t[o].id]=t[o];let s={schema:"system",table:"hdb_user",search_value:"*",search_attribute:"username",get_attributes:["*"]},n;try{n=QR.cloneDeep(await Jo(s))}catch(o){throw H.error("Got an error searching for users."),H.error(o),o}let i=new Map;for(let o in n){let c=n[o];c.role=r[n[o].role],vq(c.role),i.set(c.username,c)}return(await Iq.getLicense()).enterprise?i:Hq(i)}}catch(e){throw H.error("got an error listing users"),H.error(e),be.errorizeMessage(e)}return null}a(Zo,"listUsers");function vq(e){try{if(!e){H.error("invalid user role found.");return}e.permission.system||(e.permission.system={}),e.permission.system.tables||(e.permission.system.tables={});for(let t of Object.keys(Cq)){let r={read:!!e.permission.super_user,insert:!1,update:!1,delete:!1,attribute_permissions:[]};e.permission.system.tables[t]=r}}catch(t){H.error("Got an error trying to set system permissions."),H.error(t)}}a(vq,"appendSystemTablesToRole");function Hq(e){try{if(H.info("No enterprise license found.  System is limited to 1 clustering role and 1 user role"),!e)return new Map;let t=Object.create(null),r=new Map;e.forEach((n,i)=>{n.role.permission.cluster_user===void 0||n.role.permission.cluster_user===!1?n.role.permission.super_user===!0&&(t[n.role.id]||(t[n.role.id]=new Map),t[n.role.id].set(i,n)):r.set(i,n)});let s={role:void 0,count:0};return Object.keys(t).forEach(n=>{let i=t[n];i.size>=s.count&&(s.role=n,s.count=i.size)}),s.role===void 0?(H.error("No roles found with active users.  This is bad."),new Map):(r=new Map([...r,...t[s.role]]),r)}catch(t){return H.error("error filtering users."),H.error(t),new Map}}a(Hq,"nonEnterpriseFilter");async function Oi(){try{let e=await Zo();global.hdb_users=e}catch(e){throw H.error(e),e}}a(Oi,"setUsersToGlobal");async function Gq(e,t,r=!0){global.hdb_users||await Oi();let s=global.hdb_users.get(e);if(!s)throw rr(new Error,Cl.GENERIC_AUTH_FAIL,sr.UNAUTHORIZED,void 0,void 0,!0);if(s&&!s.active)throw rr(new Error,Cl.USER_INACTIVE,sr.UNAUTHORIZED,void 0,void 0,!0);let n={active:s.active,username:s.username};if(s.refresh_token&&(n.refresh_token=s.refresh_token),s.role&&(n.role=s.role),r===!0){if(WR.get(t)===s.password)return n;if(bl.validate(s.password,t))WR.set(t,s.password);else throw rr(new Error,Cl.GENERIC_AUTH_FAIL,sr.UNAUTHORIZED,void 0,void 0,!0)}return n}a(Gq,"findAndValidateUser");async function qq(){let e=await Zo(),t=gq.getConfigFromFile(Rs.CONFIG_PARAMS.CLUSTERING_USER),r=e.get(t);if(!be.isEmpty(r))return r.decrypt_hash=Ul.decrypt(r.hash),r.uri_encoded_d_hash=encodeURIComponent(r.decrypt_hash),r.uri_encoded_name=encodeURIComponent(r.username),r.sys_name=r.username+KR.SERVER_SUFFIX.ADMIN,r.sys_name_encoded=r.uri_encoded_name+KR.SERVER_SUFFIX.ADMIN,r}a(qq,"getClusterUser")});var Xo=h((PZ,aA)=>{"use strict";var Fq=Or();aA.exports={writeTransaction:Vq};function Vq(e,t,r){return Fq.writeTransaction(e,t,r)}a(Vq,"writeTransaction")});var Ml=h((BZ,kq)=>{kq.exports={name:"harperdb",version:"4.0.0",description:"HarperDB is a distributed SQL & NoSQL data platform focused on speed, flexibility, and ease of use.",keywords:["database","sql","nosql","api","distributed","cloud","enterprise","Fastify","NATS"],main:"harperdb.js",bin:{harperdb:"./bin/harperdb.js"},engines:{node:">=14.0.0","preferred-node":"18.13.0","go-lang":"1.19.3","nats-server":"2.9.8"},homepage:"https://www.harperdb.io/",bugs:"support@harperdb.io",author:{name:"HarperDB",email:"support@harperdb.io"},license:"See License in ./license/Community+Edition+and+Evaluation+End+User+License+Agreement.pdf",scripts:{submodules:"git submodule update --init --recursive",build:"eslint -c ./.eslintbuild bin/ data_layer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",pretty:"eslint --fix bin/ data_layer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",test:"rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license --storage_type=lmdb && npm run cover:upgrade && npm run cover:nats && npm run cover:cfserver && npm run cover:lmdbbridge && npm run cover:lmdbutility && npm run cover:hdbserver &&  npm run cover:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license --storage_type=lmdb","cover:main":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --config '../unitTests/.mocharc-main.json'","cover:lmdbbridge":"cd bin/ && nyc --no-clean --reporter=lcovonly --retries 3 ../node_modules/mocha/bin/_mocha '../unitTests/data_layer/harperBridge/lmdbBridge/**/*.js' --parallel --config '../unitTests/.mocharc.json'","cover:lmdbutility":"cd bin/ && nyc --no-clean --reporter=lcovonly --retries 3 ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --config '../unitTests/.mocharc.json'","cover:hdbserver":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --config '../unitTests/.mocharc.json'","cover:cfserver":"npm run submodules && cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --config '../unitTests/.mocharc.json'","cover:nats":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json'","cover:upgrade":"cd bin/ && nyc --no-clean --reporter=lcovonly ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --config '../unitTests/.mocharc.json'","test:ci":" cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --retries 3 --config '../unitTests/.mocharc-main.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/data_layer/harperBridge/lmdbBridge/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter","hdb-check":"./utility/devops/hdb-check.sh","download-prebuilds":"node ./utility/devops/build/download-prebuilds.js",prebuild:"date",postinstall:"node ./launchServiceScripts/launchInstallNATSServer.js",build_nats_dependency:"node ./utility/devops/nats/builder.js",coverage:"nyc --reporter=lcov npm test"},dependencies:{"@fastify/accepts-serializer":"5.1.0","@fastify/autoload":"5.4.0","@fastify/compress":"6.1.1","@fastify/cors":"8.1.0","@fastify/static":"6.5.0","@turf/area":"6.5.0","@turf/boolean-contains":"6.5.0","@turf/boolean-disjoint":"6.5.0","@turf/boolean-equal":"6.5.0","@turf/circle":"6.5.0","@turf/difference":"6.5.0","@turf/distance":"6.5.0","@turf/helpers":"6.5.0","@turf/length":"6.5.0",alasql:"1.7.4",async:"3.2.3","aws-sdk":"2.1096.0",chalk:"4.1.2","cli-progress":"3.10.0",clone:"2.1.2",esbuild:"^0.14.49","fast-glob":"3.2.11",fastify:"4.8.1","fastify-plugin":"4.2.1","fill-range":"7.0.1","fs-extra":"10.0.1","human-readable-ids":"1.0.4",inquirer:"8.2.2","is-number":"7.0.0",joi:"17.6.0",json2csv:"5.0.7",jsonata:"1.8.6",jsonwebtoken:"8.5.1",lmdb:"2.7.3",lodash:"4.17.21",mathjs:"10.4.0",microtime:"3.1.1",minimist:"1.2.6",mkcert:"1.5.0",moment:"2.29.4",msgpackr:"1.7.0",nats:"2.9.2",needle:"3.1.0","node-ipc":"9.1.4","node-stream-zip":"1.15.0","normalize-path":"^3.0.0",ora:"5.4.1","ordered-binary":"1.3.0",papaparse:"5.3.2",passport:"0.6.0","passport-http":"0.3.0","passport-local":"1.0.0",pino:"8.3.1",pm2:"5.2.0",prompt:"1.2.2","properties-reader":"2.2.0","recursive-iterator":"3.3.0",semver:"7.3.5","stream-chain":"2.2.5","stream-json":"1.7.4",systeminformation:"5.12.4","tar-fs":"2.1.1","truncate-utf8-bytes":"1.0.2",ulidx:"0.3.0",uuid:"9.0.0","validate.js":"0.11.1",yaml:"1.10.2"},devDependencies:{axios:"0.27.2",chai:"4.3.4","chai-integer":"0.1.0",eslint:"8.22.0","eslint-config-prettier":"8.3.0","eslint-plugin-prettier":"3.4.1","eslint-plugin-radar":"0.2.1","hook-std":"2.0.0","intercept-stdout":"0.1.2",mocha:"8.3.2","mocha-teamcity-reporter":"3.0.0","mock-require":"3.0.3","mock-stdin":"1.0.0",newman:"5.2.3","newman-reporter-html":"1.0.5","newman-reporter-htmlextra":"1.21.0","newman-reporter-teamcity":"0.1.11","node-fetch":"2.6.7",nyc:"15.1.0",prettier:"2.3.2",rewire:"5.0.0",rimraf:"3.0.2",sinon:"10.0.0","sinon-chai":"3.7.0"},overrides:{"eslint-plugin-radar":{eslint:"8.22.0"},"newman-reporter-html":{newman:"5.2.3"}}}});var Rt=h((KZ,CA)=>{"use strict";var nr=Y();nr.initSync();var xq=require("fs-extra"),$q=require("semver"),Ci=require("path"),{monotonicFactory:Yq}=require("ulidx"),Kq=Yq(),cA=require("util"),_A=require("child_process"),Qq=cA.promisify(_A.exec),Wq=_A.spawn,ee=he(),se=T(),ql=C(),pr=I(),zo=Fr(),Jq=Xo(),pi=hr(),{encode:vl,decode:uA}=require("msgpackr"),{isEmpty:As}=ql,lA=Kr(),vZ=Es(),Zq=Tt(),HZ=cA.promisify(Zq.searchByHash),{connect:Xq,StorageType:EA,RetentionPolicy:dA,AckPolicy:SA,DeliverPolicy:Hl,NatsConnection:GZ,JetStreamManager:qZ,JetStreamClient:FZ,StringCodec:VZ,JSONCodec:zq,createInbox:Fl,StreamSource:kZ,headers:jq,toJsMsg:eF,nuid:xZ,JetStreamOptions:$Z,ErrorCode:oA,nanos:YZ}=require("nats"),{PACKAGE_ROOT:tF}=T(),rF=Ml(),hA=zq(),sF="clustering",nF=rF.engines[ee.NATS_SERVER_NAME],iF=Ci.join(tF,"dependencies"),Gl=Ci.join(iF,`${process.platform}-${process.arch}`,ee.NATS_BINARY_NAME),Pl,Bl,Ni,gi,Ii,Qt;CA.exports={runCommand:fA,checkNATSServerInstalled:aF,createConnection:Vl,getConnection:jo,getJetStreamManager:hn,getJetStream:TA,getNATSReferences:yt,getServerList:cF,createLocalStream:kl,listStreams:mA,deleteLocalStream:_F,getServerConfig:bi,listRemoteStreams:uF,viewStream:lF,publishToStream:EF,createWorkQueueStream:dF,addSourceToWorkStream:RA,request:SF,removeSourceFromWorkStream:OA,reloadNATS:xl,reloadNATSHub:hF,reloadNATSLeaf:fF,extractServerName:AA,requestErrorHandler:TF,updateWorkStream:mF,createLocalTableStream:NA,createTableStreams:RF,purgeTableStream:gA,purgeSchemaTableStreams:AF,getStreamInfo:OF,updateNodeNameLocalStreams:pF,closeConnection:oF};async function fA(e,t=void 0){let{stdout:r,stderr:s}=await Qq(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(fA,"runCommand");async function aF(){try{await xq.access(Gl)}catch{return!1}let e=await fA(`${Gl} --version`,void 0),t=e.substring(e.lastIndexOf("v")+1,e.length);return $q.eq(t,nF)}a(aF,"checkNATSServerInstalled");async function Vl(e,t,r,s=!0,n="127.0.0.1"){return Xq({name:n,port:e,user:t,pass:r,maxReconnectAttempts:-1,waitOnFirstConnect:s,tls:{keyFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_PRIVATEKEY),certFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_CERTIFICATE),caFile:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_CERT_AUTH),insecure:nr.get(se.CONFIG_PARAMS.CLUSTERING_TLS_INSECURE)}})}a(Vl,"createConnection");async function oF(){Qt&&(await Qt.close(),Qt=void 0)}a(oF,"closeConnection");async function jo(){if(!Qt){let e=await lA.getClusterUser();if(As(e))throw new Error("Unable to get nats connection. Cluster user is undefined.");let t=nr.get(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT);Qt=await Vl(t,e.username,e.decrypt_hash)}return Qt}a(jo,"getConnection");async function hn(){if(gi)return gi;As(Qt)&&await jo();let{domain:e}=bi(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(As(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return gi=await Qt.jetstreamManager({domain:e}),gi}a(hn,"getJetStreamManager");async function TA(){if(Ii)return Ii;As(Qt)&&await jo();let{domain:e}=bi(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(As(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Ii=Qt.jetstream({domain:e}),Ii}a(TA,"getJetStream");async function yt(){let e=Qt||await jo(),t=gi||await hn(),r=Ii||await TA();return{connection:e,jsm:t,js:r}}a(yt,"getNATSReferences");async function cF(){let e=nr.get(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),{sys_name:t,decrypt_hash:r}=await lA.getClusterUser(),s=await Vl(e,t,r),n=Fl(),i=s.subscribe(n),o=[],c=(async()=>{for await(let _ of i)o.push(hA.decode(_.data))})();return await s.publish("$SYS.REQ.SERVER.PING.VARZ",void 0,{reply:n}),await s.flush(),await ql.async_set_timeout(50),await i.drain(),await s.close(),await c,o}a(cF,"getServerList");async function kl(e,t){let{jsm:r}=await yt();await r.streams.add({name:e,storage:EA.File,retention:dA.Limits,subjects:t})}a(kl,"createLocalStream");async function mA(){let{jsm:e}=await yt(),t=await e.streams.list().next(),r=[];return t.forEach(s=>{r.push(s)}),r}a(mA,"listStreams");async function _F(e){let{jsm:t}=await yt();await t.streams.delete(e)}a(_F,"deleteLocalStream");async function uF(e){let{connection:t}=await yt(),r=[],s=Fl(),n=t.subscribe(s),i=(async()=>{for await(let o of n)r.push(hA.decode(o.data))})();return await t.publish(`$JS.${e}.API.STREAM.LIST`,void 0,{reply:s}),await t.flush(),await n.drain(),await i,r}a(uF,"listRemoteStreams");async function lF(e,t=void 0,r=void 0){let{jsm:s,connection:n}=await yt(),i=Kq(),o=[],c={ack_policy:SA.None,durable_name:i,deliver_subject:i,deliver_policy:Hl.All};t&&(c.deliver_policy=Hl.StartTime,c.opt_start_time=new Date(t).toISOString());try{await s.consumers.add(e,c);let _={timeout:2e3};r&&(_.max=r);let u=await n.subscribe(i,_);for await(let l of u){let E=eF(l),d=uA(E.data),S={nats_timestamp:E.info.timestampNanos,nats_sequence:E.info.streamSequence,entry:d,originators:[]},m=[];if(E.headers){let R=E.headers.get("originators");R&&(m=R.split(","),S.originators=m)}o.push(S),u.getPending()===1&&E.info.pending===0&&u.stop()}return await s.consumers.delete(e,i),o}catch(_){if(await s.consumers.delete(e,i),_.code==="TIMEOUT")return o;throw _}}a(lF,"viewStream");async function EF(e,t,r=[],s=[]){pr.trace(`publishToStream called with subject: ${e}, stream: ${t}, entries:`,r,"originators:",s);let{connection:n,js:i}=await yt(),o=await ec(),c=`${e}.${o}`,_=jq();s.push(o),_.append("originators",s.join());for(let u=0,l=r.length;u<l;u++)try{pr.trace(`publishToStream publishing to subject: ${c}, data:`,r[u]),await i.publish(c,vl(r[u]),{headers:_})}catch(E){if(E.code&&E.code.toString()==="503")pr.trace(`publishToStream creating stream: ${t}`),await kl(t,[c]),await i.publish(c,vl(r[u]),{headers:_});else throw E}}a(EF,"publishToStream");function bi(e){e=e.toLowerCase();let t=Ci.join(nr.get(se.CONFIG_PARAMS.ROOTPATH),sF);if(e===se.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())return As(Bl)&&(Bl={port:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),server_name:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.HUB,config_file:ee.NATS_CONFIG_FILES.HUB_SERVER,pid_file_path:Ci.join(t,ee.PID_FILES.HUB),hdb_nats_path:t}),Bl;if(e===se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())return As(Pl)&&(Pl={port:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),server_name:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.LEAF,config_file:ee.NATS_CONFIG_FILES.LEAF_SERVER,domain:pi.getConfigFromFile(se.CONFIG_PARAMS.CLUSTERING_NODENAME)+ee.SERVER_SUFFIX.LEAF,pid_file_path:Ci.join(t,ee.PID_FILES.LEAF),hdb_nats_path:t}),Pl;pr.error(`Unable to get Nats server config. Unrecognized process: ${e}`)}a(bi,"getServerConfig");async function dF(e){let{jsm:t}=await yt(),r=await ec();try{await t.streams.add({name:e.stream_name,storage:EA.File,retention:dA.Workqueue,subjects:[`${ee.SUBJECT_PREFIXES.MSGID}.${r}`,`${ee.SUBJECT_PREFIXES.TXN}.${e.stream_name}.${r}`]})}catch(s){if(s.code!=="400")throw s}try{await t.consumers.info(e.stream_name,e.durable_name)}catch(s){if(s.code.toString()==="404")await t.consumers.add(e.stream_name,{ack_policy:SA.Explicit,deliver_subject:`${e.deliver_subject}.${r}`,durable_name:e.durable_name,deliver_policy:Hl.All,max_ack_pending:1e4,deliver_group:e.deliver_group,filter_subject:`${ee.SUBJECT_PREFIXES.TXN}.>`});else throw s}}a(dF,"createWorkQueueStream");async function RA(e,t,r){let{jsm:s}=await yt(),n=await s.streams.info(t),i=AA(s.prefix),o=r.start_time?r.start_time:new Date(Date.now()).toISOString(),{schema:c,table:_}=r,u=zo.createNatsTableStreamName(c,_),l=i===e,E,d,S=!1;if(!Array.isArray(n.config.sources)||n.config.sources.length===0)n.config.sources=[];else for(let R=0,w=n.config.sources.length;R<w;R++)if(E=n.config.sources[R],d=R,l&&E.name===u||!l&&E.name===u&&E.external&&E.external.api===`$JS.${e}.API`){S=!0;break}if(S===!0){if(E.opt_start_time===o)return;await pA(c,_,E,t),n.config.sources.splice(d,1),await s.streams.update(t,n.config)}let m={name:u,opt_start_time:o,filter_subject:`${ee.SUBJECT_PREFIXES.TXN}.>`};l||(m.external={api:`$JS.${e}.API`,deliver:""}),n.config.sources.push(m),await s.streams.update(t,n.config)}a(RA,"addSourceToWorkStream");function AA(e){return e.split(".")[1]}a(AA,"extractServerName");async function OA(e,t,r){let{schema:s,table:n}=r,i=zo.createNatsTableStreamName(s,n),{jsm:o}=await yt(),c=await o.streams.info(t);if(!Array.isArray(c.config.sources)||c.config.sources.length===0)return;let _=c.config.sources.length,u;for(;_--;)if(u=c.config.sources[_],u.name===i&&u.external.api===`$JS.${e}.API`){c.config.sources.splice(_,1);break}await o.streams.update(t,c.config),await pA(s,n,u,t)}a(OA,"removeSourceFromWorkStream");async function pA(e,t,r,s){let n=await hn(),i;try{i=IA(e,t,r.external.api.split(".")[1]),await n.streams.purge(s,{filter:i})}catch{pr.error("Error purging source subject",i,"from work stream",s)}}a(pA,"purgeSourceFromWorkStream");async function SF(e,t,r=2e3,s=Fl()){if(!ql.isObject(t))throw new Error("data param must be an object");let n=vl(t),{connection:i}=await yt(),o={timeout:r};s&&(o.reply=s,o.noMux=!0);let c=await i.request(e,n,o);return uA(c.data)}a(SF,"request");function xl(e){return new Promise(async(t,r)=>{let s=Wq(Gl,["--signal",`reload=${e}`],{cwd:__dirname}),n,i;s.on("error",o=>{r(o)}),s.stdout.on("data",o=>{i+=o.toString()}),s.stderr.on("data",o=>{n+=o.toString()}),s.stderr.on("close",o=>{n&&r(n),t(i)})})}a(xl,"reloadNATS");async function hF(){let{pid_file_path:e}=bi(se.PROCESS_DESCRIPTORS.CLUSTERING_HUB);await xl(e)}a(hF,"reloadNATSHub");async function fF(){let{pid_file_path:e}=bi(se.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);await xl(e)}a(fF,"reloadNATSLeaf");function TF(e,t,r){let s;switch(e.code){case oA.NoResponders:s=`Unable to ${t}, node '${r}' is not listening.`;break;case oA.Timeout:s=`Unable to ${t}, node '${r}' is listening but did not respond.`;break;default:s=e.message;break}return s}a(TF,"requestErrorHandler");async function mF(e,t){let r=t+ee.SERVER_SUFFIX.LEAF;await Jq.writeTransaction(se.SYSTEM_SCHEMA_NAME,se.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,async()=>{e.subscribe===!0?await RA(r,ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,e):await OA(r,ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,e)})}a(mF,"updateWorkStream");async function NA(e,t){let r=zo.createNatsTableStreamName(e,t),s=await ec(),n=IA(e,t,s);await kl(r,[n])}a(NA,"createLocalTableStream");async function RF(e){for(let t=0,r=e.length;t<r;t++){let s=e[t].schema,n=e[t].table;await NA(s,n)}}a(RF,"createTableStreams");async function gA(e,t){if(nr.get(se.CONFIG_PARAMS.CLUSTERING_ENABLED))try{let r=zo.createNatsTableStreamName(e,t),{jsm:s}=await yt();await s.streams.purge(r)}catch(r){if(r.message==="stream not found")pr.warn(r);else throw r}}a(gA,"purgeTableStream");async function AF(e,t){if(nr.get(se.CONFIG_PARAMS.CLUSTERING_ENABLED))for(let r=0,s=t.length;r<s;r++)await gA(e,t[r])}a(AF,"purgeSchemaTableStreams");async function OF(e){return(await hn()).streams.info(e)}a(OF,"getStreamInfo");function IA(e,t,r){return`${ee.SUBJECT_PREFIXES.TXN}.${e}.${t}.${r}`}a(IA,"createSubjectName");async function ec(){if(Ni)return Ni;if(Ni=(await hn())?.nc?.info?.server_name,Ni===void 0)throw new Error("Unable to get jetstream manager server name");return Ni}a(ec,"getJsmServerName");async function pF(){let e=await hn(),t=await ec(),r=await mA();for(let s of r){let n=s.config,i=n.subjects[0];if(!i)continue;let o=i.split(".");if(o[o.length-1]!==t){if(n.name===ee.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name){let _=`${ee.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`;pr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else if(n.name===ee.WORK_QUEUE_CONSUMER_NAMES.stream_name){let _=`${ee.WORK_QUEUE_CONSUMER_NAMES.stream_name}.${t}`;pr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_,await e.consumers.update(ee.WORK_QUEUE_CONSUMER_NAMES.stream_name,ee.WORK_QUEUE_CONSUMER_NAMES.durable_name,{deliver_subject:`${ee.WORK_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`})}else{let _=i.split(".");_[_.length-1]=t;let u=_.join(".");pr.trace(`Updating stream subject name from: ${i} to: ${u}`),n.subjects[0]=u}await e.streams.update(n.name,n)}}}a(pF,"updateNodeNameLocalStreams")});var Kl=h((QZ,LA)=>{"use strict";var fn=require("path"),nc=require("fs-extra"),NF=cR(),gF=lR(),IF=dR(),CF=hR(),$l=Kr(),mn=C(),Dt=hr(),sc=T(),tc=he(),{CONFIG_PARAMS:we}=sc,ic=I(),ac=Y(),bA=Fr(),Yl=Rt(),Tn="clustering",bF=1e4,wA=5;LA.exports={generateNatsConfig:wF,removeNatsConfig:LF};async function wF(e=!1,t=void 0){ac.initSync();let r=ac.get(we.ROOTPATH),s=fn.join(r,Tn,tc.PID_FILES.HUB),n=fn.join(r,Tn,tc.PID_FILES.LEAF),i=fn.join(r,Tn,"leaf"),o=fn.join(r,Tn,tc.NATS_CONFIG_FILES.HUB_SERVER),c=fn.join(r,Tn,tc.NATS_CONFIG_FILES.LEAF_SERVER),_=Dt.getConfigFromFile(we.CLUSTERING_TLS_CERTIFICATE),u=Dt.getConfigFromFile(we.CLUSTERING_TLS_PRIVATEKEY),l=Dt.getConfigFromFile(we.CLUSTERING_TLS_CERT_AUTH),E=Dt.getConfigFromFile(we.CLUSTERING_TLS_INSECURE),d=Dt.getConfigFromFile(we.CLUSTERING_NODENAME),S=Dt.getConfigFromFile(we.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT);await Yl.checkNATSServerInstalled()||oc("nats-server dependency is either missing or the wrong version. Run 'npm install' to fix");let m=await $l.listUsers(),R=Dt.getConfigFromFile(we.CLUSTERING_USER),w=await $l.getClusterUser();(mn.isEmpty(w)||w.active!==!0)&&oc(`invalid cluster user '${R}'`),e||(await rc(we.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),await rc(we.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT),await rc(we.CLUSTERING_HUBSERVER_NETWORK_PORT),await rc(we.CLUSTERING_LEAFSERVER_NETWORK_PORT));let L=[],B=[];for(let[la,yr]of m.entries())yr.role.role===sc.ROLE_TYPES_ENUM.CLUSTER_USER&&yr.active&&(L.push(new CF(yr.username,bA.decrypt(yr.hash))),B.push(new IF(yr.username,bA.decrypt(yr.hash))));let X=[],{hub_routes:V}=Dt.getClusteringRoutes();if(!mn.isEmptyOrZeroLength(V))for(let la of V)X.push(`tls://${w.sys_name_encoded}:${w.uri_encoded_d_hash}@${la.host}:${la.port}`);let W=new NF(Dt.getConfigFromFile(we.CLUSTERING_HUBSERVER_NETWORK_PORT),d,s,_,u,l,E,S,Dt.getConfigFromFile(we.CLUSTERING_HUBSERVER_CLUSTER_NAME),Dt.getConfigFromFile(we.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),X,L,B);t=mn.isEmpty(t)?void 0:t.toLowerCase(),(t===void 0||t===sc.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())&&(await nc.writeJson(o,W),ic.trace(`Hub server config written to ${o}`));let ke=`tls://${w.sys_name_encoded}:${w.uri_encoded_d_hash}@0.0.0.0:${S}`,xe=`tls://${w.uri_encoded_name}:${w.uri_encoded_d_hash}@0.0.0.0:${S}`,ua=new gF(Dt.getConfigFromFile(we.CLUSTERING_LEAFSERVER_NETWORK_PORT),d,n,i,[ke],[xe],L,B,_,u,l,E);(t===void 0||t===sc.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())&&(await nc.writeJson(c,ua),ic.trace(`Leaf server config written to ${c}`))}a(wF,"generateNatsConfig");async function rc(e){let t=ac.get(e);mn.isEmpty(t)&&oc(`port undefined for '${e}'`),await mn.isPortTaken(t)&&oc(`'${e}' port '${t}' is unavailable`)}a(rc,"isPortAvailable");function oc(e){let t=`Error generating clustering config: ${e}`;ic.error(t),console.error(t),process.exit(1)}a(oc,"generateNatsConfigError");async function LF(e){let{port:t,config_file:r}=Yl.getServerConfig(e),{username:s,decrypt_hash:n}=await $l.getClusterUser(),i=0,o=500;for(;i<wA;){try{let u=await Yl.createConnection(t,s,n,!1);if(u.protocol.connected===!0){u.close();break}}catch(u){ic.trace(`removeNatsConfig waiting for ${e}. Caught and swallowed error ${u}`)}if(i++,i>=wA)throw new Error(`removeNatsConfig timed out waiting to connect to ${e}`);await mn.async_set_timeout(o*i)}let c="0".repeat(bF),_=fn.join(ac.get(we.ROOTPATH),Tn,r);await nc.writeFile(_,c),await nc.remove(_)}a(LF,"removeNatsConfig")});var _c=h((WZ,vA)=>{"use strict";var ne=Y(),UA=Ai(),b=T(),Ql=he(),Oe=require("path"),{PACKAGE_ROOT:cc}=T(),_e="/dev/null",Rn=Oe.join(cc,"launchServiceScripts"),yA=Oe.join(cc,"utility/scripts"),UF=Oe.join(yA,b.HDB_RESTART_SCRIPT),DA=Oe.resolve(cc,"dependencies",`${process.platform}-${process.arch}`,Ql.NATS_BINARY_NAME),Pe,Be;function ir(){(Pe===void 0||Be===void 0)&&(ne.initSync(),Pe=ne.get(b.HDB_SETTINGS_NAMES.LOG_TO_FILE),Be=ne.get(b.HDB_SETTINGS_NAMES.LOG_PATH_KEY))}a(ir,"initLogConfig");function MA(){ir();let e=Oe.join(Be,b.PROCESS_LOG_NAMES.IPC),t={name:b.PROCESS_DESCRIPTORS.IPC,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.IPC},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:b.SERVICE_SERVERS_CWD.IPC};return Pe||(t.out_file=_e,t.error_file=_e),{...t,script:b.SERVICE_SERVERS.IPC}}a(MA,"generateIPCServerConfig");function PA(){ir(),ne.initSync(),Pe=ne.get(b.HDB_SETTINGS_NAMES.LOG_TO_FILE),Be=ne.get(b.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=Oe.join(Be,b.PROCESS_LOG_NAMES.HDB),t=UA.licenseSearch(),r=t.ram_allocation?b.MEM_SETTING_KEY+t.ram_allocation:b.MEM_SETTING_KEY+b.RAM_ALLOCATION_ENUM.DEFAULT,s={name:b.PROCESS_DESCRIPTORS.HDB,script:b.LAUNCH_SERVICE_SCRIPTS.HDB,exec_mode:"cluster",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.HDB},merge_logs:!0,out_file:e,error_file:e,instances:ne.get(b.CONFIG_PARAMS.HTTP_THREADS),node_args:r,cwd:Rn};return Pe||(s.out_file=_e,s.error_file=_e),s}a(PA,"generateHDBServerConfig");function BA(){ir(),ne.initSync(),Pe=ne.get(b.HDB_SETTINGS_NAMES.LOG_TO_FILE),Be=ne.get(b.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=Oe.join(Be,b.PROCESS_LOG_NAMES.CUSTOM_FUNCTIONS),t=UA.licenseSearch(),r=t.ram_allocation?b.MEM_SETTING_KEY+t.ram_allocation:b.MEM_SETTING_KEY+b.RAM_ALLOCATION_ENUM.DEFAULT,s={name:b.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS,script:b.LAUNCH_SERVICE_SCRIPTS.CUSTOM_FUNCTIONS,exec_mode:"cluster",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS},merge_logs:!0,out_file:e,error_file:e,instances:ne.get(b.CONFIG_PARAMS.HTTP_THREADS),node_args:r,cwd:Rn};return Pe||(s.out_file=_e,s.error_file=_e),s}a(BA,"generateCFServerConfig");function yF(){ir(),ne.initSync(),Pe=ne.get(b.HDB_SETTINGS_NAMES.LOG_TO_FILE),Be=ne.get(b.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=ne.get(b.CONFIG_PARAMS.ROOTPATH),t=Oe.join(e,"clustering",Ql.NATS_CONFIG_FILES.HUB_SERVER),r=Oe.join(Be,b.PROCESS_LOG_NAMES.CLUSTERING_HUB),s={name:b.PROCESS_DESCRIPTORS.CLUSTERING_HUB,script:DA,args:`-c ${t}`,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CLUSTERING_HUB},merge_logs:!0,out_file:r,error_file:r,instances:1};return Pe||(s.out_file=_e,s.error_file=_e),s}a(yF,"generateNatsHubServerConfig");function DF(){ir(),ne.initSync(),Pe=ne.get(b.HDB_SETTINGS_NAMES.LOG_TO_FILE),Be=ne.get(b.HDB_SETTINGS_NAMES.LOG_PATH_KEY);let e=ne.get(b.CONFIG_PARAMS.ROOTPATH),t=Oe.join(e,"clustering",Ql.NATS_CONFIG_FILES.LEAF_SERVER),r=Oe.join(Be,b.PROCESS_LOG_NAMES.CLUSTERING_LEAF),s={name:b.PROCESS_DESCRIPTORS.CLUSTERING_LEAF,script:DA,args:`-c ${t}`,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CLUSTERING_LEAF},merge_logs:!0,out_file:r,error_file:r,instances:1};return Pe||(s.out_file=_e,s.error_file=_e),s}a(DF,"generateNatsLeafServerConfig");function MF(){ir(),ne.initSync();let e=Oe.join(Be,b.PROCESS_LOG_NAMES.CLUSTERING_INGEST_SERVICE),t={name:b.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE,script:b.LAUNCH_SERVICE_SCRIPTS.NATS_INGEST_SERVICE,exec_mode:"cluster",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Rn};return Pe||(t.out_file=_e,t.error_file=_e),t}a(MF,"generateNatsIngestServiceConfig");function PF(){ir(),ne.initSync();let e=Oe.join(Be,b.PROCESS_LOG_NAMES.CLUSTERING_REPLY_SERVICE),t={name:b.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE,script:b.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE,exec_mode:"cluster",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Rn};return Pe||(t.out_file=_e,t.error_file=_e),t}a(PF,"generateNatsReplyServiceConfig");function BF(){ir(),ne.initSync();let e=Oe.join(Be,b.PROCESS_LOG_NAMES.CLUSTERING_UPGRADE),t={name:b.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0,script:b.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:Rn,autorestart:!1};return Pe||(t.out_file=_e,t.error_file=_e),t}a(BF,"generateClusteringUpgradeV4ServiceConfig");function vF(){ir();let e=Oe.join(Be,b.PROCESS_LOG_NAMES.PM2),t={name:b.PROCESS_DESCRIPTORS.RESTART_HDB,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:b.PROCESS_DESCRIPTORS.RESTART_HDB},merge_logs:!0,out_file:e,error_file:e,instances:1,autorestart:!1,cwd:yA};return Pe||(t.out_file=_e,t.error_file=_e),{...t,script:UF}}a(vF,"generateRestart");function HF(e){ir();let t=Oe.join(Be,b.PROCESS_LOG_NAMES.JOBS),r=Oe.join(cc,"server/jobs"),s={name:`JOB-${e}`,exec_mode:"fork",env:{[b.PROCESS_NAME_ENV_PROP]:`JOB-${e}`},merge_logs:!0,out_file:t,error_file:t,instances:1,cwd:Rn,autorestart:!1};return Pe||(s.out_file=_e,s.error_file=_e),{...s,script:Oe.join(r,"jobProcess.js")}}a(HF,"generateJobConfig");function GF(){return{apps:[MA(),PA(),BA()]}}a(GF,"generateAllServiceConfigs");vA.exports={generateAllServiceConfigs:GF,generateIPCServerConfig:MA,generateHDBServerConfig:PA,generateCFServerConfig:BA,generateRestart:vF,generateNatsHubServerConfig:yF,generateNatsLeafServerConfig:DF,generateNatsIngestServiceConfig:MF,generateNatsReplyServiceConfig:PF,generateClusteringUpgradeV4ServiceConfig:BF,generateJobConfig:HF}});var GA=h((JZ,HA)=>{var qF=de(),FF={user:{presence:!0},schema:{presence:!0},table:{presence:!0},operation:{presence:!0}};HA.exports=function(e){return qF.validateObject(e,FF)}});var Wl=h((ZZ,qA)=>{"use strict";var VF=T().OPERATIONS_ENUM,uc=class{constructor(t,r,s,n=void 0){this.operation=VF.UPDATE,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(uc,"UpdateObject");qA.exports=uc});var VA=h((XZ,FA)=>{"use strict";var kF={OPERATION:"operation",REFRESH:"refresh"},lc=class{constructor(t,r){this.operation_token=t,this.refresh_token=r}};a(lc,"JWTTokens");var Ec=class{constructor(t,r,s){this.public_key=t,this.private_key=r,this.passphrase=s}};a(Ec,"JWTRSAKeys");FA.exports={JWTTokens:lc,TOKEN_TYPE_ENUM:kF,JWTRSAKeys:Ec}});var fc=h((zZ,YA)=>{"use strict";var Li=require("jsonwebtoken"),Jl=require("fs-extra"),Zl=C(),Mt=T(),{handleHDBError:ct,hdb_errors:xF}=D(),{HTTP_STATUS_CODES:_t,AUTHENTICATION_ERROR_MSGS:ut}=xF,wi=I(),kA=Qo(),jl=Kr(),$F=Ut().update,YF=Wl(),KF=Zs(),{UserEventMsg:QF}=us(),Qr=Y();Qr.initSync();var Xl=require("path"),{JWTTokens:WF,JWTRSAKeys:JF,TOKEN_TYPE_ENUM:dc}=VA(),ZF=Qr.get(Mt.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY)?Qr.get(Mt.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY):"1d",XF=Qr.get(Mt.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY)?Qr.get(Mt.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY):"30d",Sc="RS256",zl;YA.exports={createTokens:zF,validateOperationToken:e0,refreshOperationToken:jF,validateRefreshToken:$A};async function zF(e){if(Zl.isEmpty(e)||typeof e!="object")throw ct(new Error,ut.INVALID_AUTH_OBJECT,_t.BAD_REQUEST,void 0,void 0,!0);if(Zl.isEmpty(e.username))throw ct(new Error,ut.USERNAME_REQUIRED,_t.BAD_REQUEST,void 0,void 0,!0);if(Zl.isEmpty(e.password))throw ct(new Error,ut.PASSWORD_REQUIRED,_t.BAD_REQUEST,void 0,void 0,!0);let t;try{if(t=await jl.findAndValidateUser(e.username,e.password),!t)throw ct(new Error,ut.INVALID_CREDENTIALS,_t.UNAUTHORIZED,void 0,void 0,!0)}catch(d){throw wi.error(d),ct(new Error,ut.INVALID_CREDENTIALS,_t.UNAUTHORIZED,void 0,void 0,!0)}let r=await hc(),s=!1,n=!1;t.role&&t.role.permission&&(s=t.role.permission.super_user===!0,n=t.role.permission.cluster_user===!0);let i={username:e.username,super_user:s,cluster_user:n},o=await xA(i,r.private_key,r.passphrase),c=await Li.sign(i,{key:r.private_key,passphrase:r.passphrase},{expiresIn:XF,algorithm:Sc,subject:dc.REFRESH}),_=kA.hash(c),u=new YF(Mt.SYSTEM_SCHEMA_NAME,Mt.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,[{username:e.username,refresh_token:_}]),l,E;try{l=await $F(u)}catch(d){wi.error(d),E=d}if(E!==void 0||l.skipped_hashes.length>0)throw ct(new Error,ut.REFRESH_TOKEN_SAVE_FAILED,_t.INTERNAL_SERVER_ERROR);return KF.signalUserChange(new QF(process.pid)),new WF(o,c)}a(zF,"createTokens");async function xA(e,t,r){return await Li.sign(e,{key:t,passphrase:r},{expiresIn:ZF,algorithm:Sc,subject:dc.OPERATION})}a(xA,"signOperationToken");async function hc(){if(zl===void 0)try{let e=Xl.join(Qr.getHdbBasePath(),Mt.LICENSE_KEY_DIR_NAME,Mt.JWT_ENUM.JWT_PASSPHRASE_NAME),t=Xl.join(Qr.getHdbBasePath(),Mt.LICENSE_KEY_DIR_NAME,Mt.JWT_ENUM.JWT_PRIVATE_KEY_NAME),r=Xl.join(Qr.getHdbBasePath(),Mt.LICENSE_KEY_DIR_NAME,Mt.JWT_ENUM.JWT_PUBLIC_KEY_NAME),s=(await Jl.readFile(e)).toString(),n=(await Jl.readFile(t)).toString(),i=(await Jl.readFile(r)).toString();zl=new JF(i,n,s)}catch(e){throw wi.error(e),ct(new Error,ut.NO_ENCRYPTION_KEYS,_t.INTERNAL_SERVER_ERROR)}return zl}a(hc,"getJWTRSAKeys");async function jF(e){if(!e)throw ct(new Error,ut.INVALID_BODY,_t.BAD_REQUEST,void 0,void 0,!0);if(!e.refresh_token)throw ct(new Error,ut.REFRESH_TOKEN_REQUIRED,_t.BAD_REQUEST,void 0,void 0,!0);await $A(e.refresh_token);let t=await hc(),r=await Li.decode(e.refresh_token);return{operation_token:await xA({username:r.username,super_user:r.super_user,cluster_user:r.cluster_user},t.private_key,t.passphrase)}}a(jF,"refreshOperationToken");async function e0(e){try{let t=await hc(),r=await Li.verify(e,t.public_key,{algorithms:Sc,subject:dc.OPERATION});return await jl.findAndValidateUser(r.username,void 0,!1)}catch(t){throw wi.warn(t),t.name&&t.name==="TokenExpiredError"?ct(new Error,ut.TOKEN_EXPIRED,_t.FORBIDDEN):ct(new Error,ut.INVALID_TOKEN,_t.UNAUTHORIZED)}}a(e0,"validateOperationToken");async function $A(e){let t;try{let r=await hc(),s=await Li.verify(e,r.public_key,{algorithms:Sc,subject:dc.REFRESH});t=await jl.findAndValidateUser(s.username,void 0,!1)}catch(r){throw wi.warn(r),r.name&&r.name==="TokenExpiredError"?ct(new Error,ut.TOKEN_EXPIRED,_t.FORBIDDEN):ct(new Error,ut.INVALID_TOKEN,_t.UNAUTHORIZED)}if(!kA.validate(t.refresh_token,e))throw ct(new Error,ut.INVALID_TOKEN,_t.UNAUTHORIZED);return t}a($A,"validateRefreshToken")});var JA=h((eX,WA)=>{"use strict";var t0=GA(),An=require("passport"),r0=require("passport-local").Strategy,s0=require("passport-http").BasicStrategy,n0=require("util"),i0=Kr(),QA=n0.callbackify(i0.findAndValidateUser),jZ=st(),a0=T(),KA=fc();An.use(new r0(function(e,t,r){QA(e,t,r)}));An.use(new s0(function(e,t,r){QA(e,t,r)}));An.serializeUser(function(e,t){t(null,e)});An.deserializeUser(function(e,t){t(null,e)});function o0(e,t,r){let s,n;if(e.headers&&e.headers.authorization){let o=e.headers.authorization.split(" ");s=o[0],n=o[1]}function i(o,c){return o?r(o):c?r(null,c):r("User not found")}switch(a(i,"handleResponse"),s){case"Basic":An.authenticate("basic",{session:!1},(o,c)=>{i(o,c)})(e,t,r);break;case"Bearer":e.body&&e.body.operation&&e.body.operation===a0.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN?KA.validateRefreshToken(n).then(o=>{e.body.refresh_token=n,r(null,o)}).catch(o=>{r(o)}):KA.validateOperationToken(n).then(o=>{r(null,o)}).catch(o=>{r(o)});break;default:An.authenticate("local",{session:!1},function(o,c){i(o,c)})(e,t,r);break}}a(o0,"authorize");function c0(e,t){let r=t0(e);if(r){t(r);return}let s={authorized:!0,messages:[]},n=e.user.role;if(!n||!n.permission)return t("Invalid role");let i=JSON.parse(n.permission);if(i.super_user)return t(null,s);if(!i[e.schema])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.schema} schema`),t(null,s);if(!i[e.schema].tables[e.table])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.table} table`),t(null,s);if(!i[e.schema].tables[e.table][e.operation])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.operation} on ${e.table} table`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&!e.attributes)return s.authorized=!1,s.messages.push(`${e.schema}.${e.table} has attribute permissions. Missing attributes to validate`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&e.attributes){let o=i[e.schema].tables[e.table].attribute_permissions;for(let c in o)e.attributes.indexOf(o[c].attribute_name)>-1&&!o[c][e.operation]&&(s.authorized=!1,s.messages.push(`Not authorized to ${e.operation} ${o[c].attribute_name} `))}return t(null,s)}a(c0,"checkPermissions");WA.exports={authorize:o0,checkPermissions:c0}});var On=h((tX,ZA)=>{"use strict";var Tc=class{constructor(t,r,s){this.name=t,this.subscriptions=r,this.system_info=s}};a(Tc,"Node");var mc=class{constructor(t,r,s,n){this.schema=t,this.table=r,this.publish=s,this.subscribe=n}};a(mc,"NodeSubscription");ZA.exports={Node:Tc,NodeSubscription:mc}});var zA=h((rX,XA)=>{"use strict";var _0=T().OPERATIONS_ENUM,Rc=class{constructor(t,r,s,n=void 0){this.operation=_0.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};a(Rc,"UpsertObject");XA.exports=Rc});var Ui=h((sX,jA)=>{"use strict";var Ac=class{constructor(t,r,s,n){this.operation=t,this.node_name=r,this.subscriptions=s,this.system_info=n}};a(Ac,"RemotePayloadObject");var Oc=class{constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.hash_attribute=s,this.publish=n,this.subscribe=i,this.start_time=o}};a(Oc,"RemotePayloadSubscription");jA.exports={RemotePayloadObject:Ac,RemotePayloadSubscription:Oc}});var tO=h((nX,eO)=>{"use strict";var pc=class{constructor(t,r,s=0,n=0,i=0,o=0){this.schema=t,this.table=r,this.table_size=s,this.record_count=n,this.transaction_log_size=i,this.transaction_log_record_count=o}};a(pc,"TableSizeObject");eO.exports=pc});var iO=h((iX,nO)=>{"use strict";var u0=tO(),rO=require("path"),sO=te(),l0=Ye(),pn=z(),E0=I();nO.exports=d0;async function d0(e){let t=new u0;try{let r=rO.join(sO.getBaseSchemaPath(),e.schema.toString()),s=await pn.openEnvironment(r,e.name),n=pn.statDBI(s,e.hash_attribute),i=rO.join(sO.getTransactionAuditStorePath(),e.schema.toString()),o=await pn.openEnvironment(i,e.name,!0),c=pn.statDBI(o,l0.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP),_=await pn.environmentDataSize(r,e.name),u=await pn.environmentDataSize(i,e.name);t.schema=e.schema,t.table=e.name,t.table_size=_,t.record_count=n.entryCount,t.transaction_log_size=u,t.transaction_log_record_count=c.entryCount}catch(r){E0.warn(`unable to stat table dbi due to ${r}`)}return t}a(d0,"lmdbGetTableSize")});var oO=h((aX,aO)=>{"use strict";var S0=T(),Nc=class{constructor(t){this.operator=S0.OPERATIONS_ENUM.SYSTEM_INFORMATION,this.attributes=t}};a(Nc,"SystemInformationOperation");aO.exports=Nc});var _O=h((oX,cO)=>{"use strict";var gc=class{constructor(t,r,s,n,i,o,c){this.system=t,this.time=r,this.cpu=s,this.memory=n,this.disk=i,this.network=o,this.harperdb_processes=c}};a(gc,"SystemInformationObject");cO.exports=gc});var Cc=h((_X,uO)=>{"use strict";var ve=require("systeminformation"),Nn=I(),h0=T(),f0=iO(),T0=un(),m0=Y();m0.initSync();var cX=oO(),R0=_O(),Ic;uO.exports={getHDBProcessInfo:sE,getNetworkInfo:iE,getDiskInfo:nE,getMemoryInfo:rE,getCPUInfo:tE,getTimeInfo:eE,getSystemInformation:aE,systemInformation:A0,getTableSize:oE};function eE(){return ve.time()}a(eE,"getTimeInfo");async function tE(){try{let{family:e,model:t,stepping:r,revision:s,voltage:n,speedmin:i,speedmax:o,governor:c,socket:_,cache:u,...l}=await ve.cpu();l.cpu_speed=await ve.cpuCurrentSpeed();let{raw_currentload:E,raw_currentload_idle:d,raw_currentload_irq:S,raw_currentload_nice:m,raw_currentload_system:R,raw_currentload_user:w,cpus:L,...B}=await ve.currentLoad();return B.cpus=[],L.forEach(X=>{let{raw_load:V,raw_load_idle:W,raw_load_irq:ke,raw_load_nice:xe,raw_load_system:ua,raw_load_user:la,...yr}=X;B.cpus.push(yr)}),l.current_load=B,l}catch(e){return Nn.error(`error in getCPUInfo: ${e}`),{}}}a(tE,"getCPUInfo");async function rE(){try{let{buffers:e,cached:t,slab:r,buffcache:s,...n}=await ve.mem();return n}catch(e){return Nn.error(`error in getMemoryInfo: ${e}`),{}}}a(rE,"getMemoryInfo");async function sE(){let e={core:[],clustering:[]};try{return(await ve.processes()).list.forEach(r=>{r.params.includes(h0.HDB_PROC_NAME)?e.core.push(r):r.params.includes("socketcluster")&&e.clustering.push(r)}),e}catch(t){return Nn.error(`error in getHDBProcessInfo: ${t}`),e}}a(sE,"getHDBProcessInfo");async function nE(){let e={};try{let{rIO_sec:t,wIO_sec:r,tIO_sec:s,ms:n,...i}=await ve.disksIO();e.io=i;let{rx_sec:o,tx_sec:c,wx_sec:_,...u}=await ve.fsStats();return e.read_write=u,e.size=await ve.fsSize(),e}catch(t){return Nn.error(`error in getDiskInfo: ${t}`),e}}a(nE,"getDiskInfo");async function iE(){let e={default_interface:null,latency:{},interfaces:[],stats:[],connections:[]};try{return e.default_interface=await ve.networkInterfaceDefault(),e.latency=await ve.inetChecksite("google.com"),(await ve.networkInterfaces()).forEach(s=>{let{internal:n,virtual:i,mtu:o,dhcp:c,dnsSuffix:_,ieee8021xAuth:u,ieee8021xState:l,carrier_changes:E,...d}=s;e.interfaces.push(d)}),(await ve.networkStats()).forEach(s=>{let{rx_sec:n,tx_sec:i,ms:o,...c}=s;e.stats.push(c)}),e.connections=await ve.networkConnections(),e}catch(t){return Nn.error(`error in getNetworkInfo: ${t}`),e}}a(iE,"getNetworkInfo");async function aE(){if(Ic!==void 0)return Ic;let e={};try{let{codepage:t,logofile:r,serial:s,build:n,servicepack:i,uefi:o,...c}=await ve.osInfo();e=c;let _=await ve.versions("node, npm");return e.node_version=_.node,e.npm_version=_.npm,Ic=e,Ic}catch(t){return Nn.error(`error in getSystemInformation: ${t}`),e}}a(aE,"getSystemInformation");async function oE(){let e=[],t=await T0.describeAll();for(let r of Object.values(t))for(let s of Object.values(r))e.push(await f0(s));return e}a(oE,"getTableSize");async function A0(e){let t=new R0;if(!Array.isArray(e.attributes)||e.attributes.length===0)return t.system=await aE(),t.time=eE(),t.cpu=await tE(),t.memory=await rE(),t.disk=await nE(),t.network=await iE(),t.harperdb_processes=await sE(),t.table_size=await oE(),t;for(let r=0;r<e.attributes.length;r++)switch(e.attributes[r]){case"system":t.system=await aE();break;case"time":t.time=eE();break;case"cpu":t.cpu=await tE();break;case"memory":t.memory=await rE();break;case"disk":t.disk=await nE();break;case"network":t.network=await iE();break;case"harperdb_processes":t.harperdb_processes=await sE();break;case"table_size":t.table_size=await oE();break;default:break}return t}a(A0,"systemInformation")});var cE=h((EX,lO)=>{"use strict";var uX=require("fs-extra"),lX=I();lO.exports={version:O0,printVersion:N0,nodeVersion:p0};var Wr=Ml();function O0(){if(Wr)return Wr.version}a(O0,"version");function p0(){if(Wr&&Wr.engines&&Wr.engines["preferred-node"])return Wr.engines["preferred-node"]}a(p0,"nodeVersion");function N0(){Wr&&console.log(`HarperDB Version ${Wr.version}`)}a(N0,"printVersion")});var ps=h((hX,hO)=>{"use strict";var g0=Ut(),_E=C(),uE=require("util"),Os=T(),EO=Y();EO.initSync();var I0=JA(),dO=Tt(),{Node:dX,NodeSubscription:SX}=On(),C0=Es(),b0=zA(),{RemotePayloadObject:w0,RemotePayloadSubscription:L0}=Ui(),{handleHDBError:U0,hdb_errors:y0}=D(),{HTTP_STATUS_CODES:D0,HDB_ERROR_MSGS:M0}=y0,P0=Kt(),B0=Cc(),v0=cE(),H0=uE.promisify(I0.authorize),G0=uE.promisify(dO.searchByHash),q0=uE.promisify(dO.searchByValue);hO.exports={authHeaderToUser:F0,isEmpty:V0,getNodeRecord:k0,upsertNodeRecord:x0,buildNodePayloads:$0,checkClusteringEnabled:Y0,getAllNodeRecords:K0,getSystemInfo:Q0,reverseSubscription:SO};async function F0(e){let t={headers:{authorization:e.hdb_auth_header}};return e.hdb_user=await H0(t,null),e}a(F0,"authHeaderToUser");function V0(e){return e==null}a(V0,"isEmpty");async function k0(e){let t=new C0(Os.SYSTEM_SCHEMA_NAME,Os.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e],["*"]);return G0(t)}a(k0,"getNodeRecord");async function x0(e){let t=new b0(Os.SYSTEM_SCHEMA_NAME,Os.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e]);return g0.upsert(t)}a(x0,"upsertNodeRecord");function SO(e){if(_E.isEmpty(e.subscribe)||_E.isEmpty(e.publish))throw new Error("Received invalid subscription object");let{schema:t,table:r,hash_attribute:s}=e,n={schema:t,table:r,hash_attribute:s};return e.subscribe===!0&&e.publish===!1?(n.subscribe=!1,n.publish=!0):e.subscribe===!1&&e.publish===!0?(n.subscribe=!0,n.publish=!1):(n.subscribe=e.subscribe,n.publish=e.publish),n}a(SO,"reverseSubscription");function $0(e,t,r,s){let n=[];for(let i=0,o=e.length;i<o;i++){let c=e[i],{schema:_,table:u}=c,l=_E.getTableHashAttribute(_,u),{subscribe:E,publish:d}=SO(c),S=new L0(_,u,l,d,E,c.start_time);n.push(S)}return new w0(r,t,n,s)}a($0,"buildNodePayloads");function Y0(){if(!EO.get(Os.CONFIG_PARAMS.CLUSTERING_ENABLED))throw U0(new Error,M0.CLUSTERING_NOT_ENABLED,D0.BAD_REQUEST,void 0,void 0,!0)}a(Y0,"checkClusteringEnabled");async function K0(){let e=new P0(Os.SYSTEM_SCHEMA_NAME,Os.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,"name","*",void 0,["*"]);return q0(e)}a(K0,"getAllNodeRecords");async function Q0(){let e=await B0.getSystemInformation();return{hdb_version:v0.version(),node_version:e.node_version,platform:e.platform}}a(Q0,"getSystemInfo")});var gn=h((fX,CO)=>{"use strict";var P=T(),bc=C(),yi=Kl(),wc=Rt(),W0=he(),x=require("pm2"),J0=require("fs-extra"),Nr=_c(),lt=Y(),gr=I(),Z0=_c(),X0=ps(),z0=require("util"),TO=z0.promisify(require("child_process").exec),mO=require("path");CO.exports={start:Ns,stop:Uc,reload:AO,restart:OO,list:EE,describe:yc,connect:ar,kill:NO,startAllServices:cV,startService:Lc,getUniqueServicesList:dE,restartAllServices:_V,stopAllServices:uV,isServiceRegistered:gO,reloadStopStart:lE,restartHdb:pO,deleteProcess:aV,configureLogRotate:dV,startClustering:IO,isHdbRestartRunning:oV,isClusteringRunning:hV,stopClustering:SV,reloadClustering:fV};var{PACKAGE_ROOT:j0}=T(),eV="2.7.0",RO=mO.join(j0,"node_modules/pm2/bin/pm2"),tV="Log rotate installed.",rV="Error installing log rotate.",sV="Log rotate updated.",nV="Error updating log rotate.",iV="The number of HarperDB processes running is different from the settings value. To restart and update the number HarperDB processes running you must stop and then start HarperDB";function ar(){return new Promise((e,t)=>{x.connect((r,s)=>{r&&t(r),e(s)})})}a(ar,"connect");function Ns(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.start(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(Ns,"start");function Uc(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.stop(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.delete(e,(i,o)=>{i&&(x.disconnect(),r(s)),x.disconnect(),t(o)})})})}a(Uc,"stop");function AO(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.reload(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(AO,"reload");function OO(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.restart(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(OO,"restart");function aV(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.delete(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(aV,"deleteProcess");async function pO(){await Ns(Z0.generateRestart())}a(pO,"restartHdb");async function oV(){let e=await EE();for(let t in e)if(e[t].name===P.PROCESS_DESCRIPTORS.RESTART_HDB)return!0;return!1}a(oV,"isHdbRestartRunning");function EE(){return new Promise(async(e,t)=>{try{await ar()}catch(r){t(r)}x.list((r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(EE,"list");function yc(e){return new Promise(async(t,r)=>{try{await ar()}catch(s){r(s)}x.describe(e,(s,n)=>{s&&(x.disconnect(),r(s)),x.disconnect(),t(n)})})}a(yc,"describe");function NO(){return new Promise(async(e,t)=>{try{await ar()}catch(r){t(r)}x.killDaemon((r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(NO,"kill");async function cV(){try{await IO(),await Ns(Nr.generateAllServiceConfigs())}catch(e){throw x.disconnect(),e}}a(cV,"startAllServices");async function Lc(e){try{let t;switch(e=e.toLowerCase(),e){case P.PROCESS_DESCRIPTORS.IPC.toLowerCase():t=Nr.generateIPCServerConfig();break;case P.PROCESS_DESCRIPTORS.HDB.toLowerCase():t=Nr.generateHDBServerConfig();break;case P.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS.toLowerCase():t=Nr.generateCFServerConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE.toLowerCase():t=Nr.generateNatsIngestServiceConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE.toLowerCase():t=Nr.generateNatsReplyServiceConfig();break;case P.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase():t=Nr.generateNatsHubServerConfig(),await Ns(t),await yi.removeNatsConfig(e);return;case P.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase():t=Nr.generateNatsLeafServerConfig(),await Ns(t),await yi.removeNatsConfig(e);return;case P.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0.toLowerCase():t=Nr.generateClusteringUpgradeV4ServiceConfig();break;default:throw new Error(`Start service called with unknown service config: ${e}`)}await Ns(t)}catch(t){throw x.disconnect(),t}}a(Lc,"startService");async function dE(){try{let e=await EE(),t={};for(let r=0,s=e.length;r<s;r++){let n=e[r];t[n.name]===void 0&&(t[n.name]={name:n.name,exec_mode:n.pm2_env.exec_mode})}return t}catch(e){throw x.disconnect(),e}}a(dE,"getUniqueServicesList");async function _V(e=[]){try{let t=!1,r=await dE();for(let s=0,n=Object.values(r).length;s<n;s++){let i=Object.values(r)[s],o=i.name;e.includes(o)||(i.exec_mode==="cluster_mode"?o===P.PROCESS_DESCRIPTORS.HDB?t=!0:await lE(o):await OO(o))}t&&await lE(P.PROCESS_DESCRIPTORS.HDB)}catch(t){throw x.disconnect(),t}}a(_V,"restartAllServices");async function uV(){try{let e=await dE();for(let t=0,r=Object.values(e).length;t<r;t++){let s=Object.values(e)[t];await Uc(s.name)}if(await NO(),lt.get(P.CONFIG_PARAMS.OPERATIONSAPI_FOREGROUND)===!0){let t=(await J0.readFile(mO.join(lt.get(P.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),P.FOREGROUND_PID_FILE))).toString();try{process.kill(t,"SIGTERM")}catch(r){gr.warn(`Error terminating foreground process: ${r}`)}}}catch(e){throw x.disconnect(),e}}a(uV,"stopAllServices");async function gO(e){return!bc.isEmptyOrZeroLength(await yc(e))}a(gO,"isServiceRegistered");async function lE(e){let t=e===P.PROCESS_DESCRIPTORS.HDB?lt.get(P.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES):lt.get(P.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES),r=await yc(e),s=bc.isEmptyOrZeroLength(r)?0:r.length;t!==s?e===P.PROCESS_DESCRIPTORS.HDB?gr.error(iV):(await Uc(e),await Lc(e)):e===P.PROCESS_DESCRIPTORS.HDB?await pO():await AO(e)}a(lE,"reloadStopStart");function lV(){return new Promise(async(e,t)=>{try{await ar()}catch(r){t(r)}x.stop(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE,(r,s)=>{r&&(x.disconnect(),t(r)),x.disconnect(),e(s)})})}a(lV,"stopLogrotate");async function EV(){let{stdout:e,stderr:t}=await TO(`${process.platform==="win32"?"node":""} ${RO} install pm2-logrotate@${eV}`);if(gr.debug(`loadLogRotate stdout: ${e}`),t)throw gr.error(rV),t;gr.info(tV)}a(EV,"installLogRotate");async function fO(){let e={max_size:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_MAX_SIZE),retain:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_RETAIN),compress:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_COMPRESS),dateFormat:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_DATE_FORMAT),rotateModule:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_ROTATE_MODULE),workerInterval:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_WORKER_INTERVAL),rotateInterval:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_ROTATE_INTERVAL),TZ:lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE_TIMEZONE)},t="";for(let n in e)t+=`${process.platform==="win32"?"node":""} ${RO} set pm2-logrotate:${n} ${e[n]}`,n!=="TZ"&&(t+=" && ");let{stdout:r,stderr:s}=await TO(t);if(gr.debug(`updateLogRotateConfig stdout: ${r}`),s)throw gr.error(nV),s;gr.info(sV)}a(fO,"updateLogRotateConfig");async function dV(){lt.initSync();let e=bc.autoCastBoolean(lt.get(P.HDB_SETTINGS_NAMES.LOG_ROTATE)),t=await yc(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE),r,s=!1;if(bc.isEmptyOrZeroLength(t)||(s=!0,r=t[0].pm2_env.status),e&&!s){await EV(),await fO();return}if(e&&s){await Ns(P.PROCESS_DESCRIPTORS.PM2_LOGROTATE),await fO();return}!e&&r===P.PM2_PROCESS_STATUSES.ONLINE&&await lV()}a(dV,"configureLogRotate");async function IO(){for(let t in P.CLUSTERING_PROCESSES){let r=P.CLUSTERING_PROCESSES[t];await Lc(r)}await wc.createWorkQueueStream(W0.WORK_QUEUE_CONSUMER_NAMES),await wc.updateNodeNameLocalStreams();let e=await X0.getAllNodeRecords();for(let t=0,r=e.length;t<r;t++)if(e[t].system_info?.hdb_version===P.PRE_4_0_0_VERSION){gr.info("Starting clustering upgrade 4.0.0 process"),await Lc(P.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0);break}}a(IO,"startClustering");async function SV(){for(let e in P.CLUSTERING_PROCESSES){let t=P.CLUSTERING_PROCESSES[e];await Uc(t)}}a(SV,"stopClustering");async function hV(){for(let e in P.CLUSTERING_PROCESSES){let t=P.CLUSTERING_PROCESSES[e];if(await gO(t)===!1)return!1}return!0}a(hV,"isClusteringRunning");async function fV(){await yi.generateNatsConfig(!0),await wc.reloadNATSHub(),await wc.reloadNATSLeaf(),await yi.removeNatsConfig(P.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase()),await yi.removeNatsConfig(P.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())}a(fV,"reloadClustering")});var SE=h((TX,bO)=>{"use strict";var Dc=class{constructor(t,r,s){this.timestamp=t,this.user=r,this.node_name=s}};a(Dc,"ClusteringOriginObject");bO.exports=Dc});var bn=h((mX,UO)=>{"use strict";var wO=C(),Mi=Y(),ue=T(),hE=he(),In=Rt(),fe=I(),LO=SE(),TV=Fr();Mi.initSync();var Cn=hE.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name,Di=hE.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject;UO.exports={sendAttributeTransaction:Pc,postOperationHandler:RV};async function Pc(e,t,r=[]){if(!!Mi.get(ue.CONFIG_PARAMS.CLUSTERING_ENABLED)&&!wO.isEmptyOrZeroLength(e.new_attributes)&&t.schema!==ue.SYSTEM_SCHEMA_NAME){let s=t.hdb_user?.username,n=Mi.get(ue.CONFIG_PARAMS.CLUSTERING_NODENAME);for(let i of e.new_attributes){let o={operation:ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE,schema:t.schema,table:t.table,attribute:i,__origin:new LO(e.txn_time,s,n)};fe.trace(`sendAttributeTransaction publishing ${Cn}`,o),await In.publishToStream(Di,Cn,[o],r)}}}a(Pc,"sendAttributeTransaction");async function Mc(e,t,r,s=[]){if(e.schema===ue.SYSTEM_SCHEMA_NAME)return;let n=mV(e,t,r);n&&(fe.trace(`sendOperationTransaction publishing to schema ${e.schema} table ${e.table} following transaction:`,n),await In.publishToStream(`${hE.SUBJECT_PREFIXES.TXN}.${e.schema}.${e.table}`,TV.createNatsTableStreamName(e.schema,e.table),[n],s))}a(Mc,"sendOperationTransaction");function mV(e,t,r){if(wO.isEmptyOrZeroLength(t))return null;let s={operation:e.operation,schema:e.schema,table:e.table,__origin:r};return e.operation===ue.OPERATIONS_ENUM.DELETE?s.hash_values=t:s.records=e.records,s}a(mV,"convertCRUDOperationToTransaction");async function RV(e,t,r=[]){if(!Mi.get(ue.CONFIG_PARAMS.CLUSTERING_ENABLED))return;fe.trace(`postOperationHandler called for operation ${e.operation} on schema.table: ${e.schema}.${e.table}`);let s=e.hdb_user?.username,n=Mi.get(ue.CONFIG_PARAMS.CLUSTERING_NODENAME),i=new LO(t.txn_time,s,n);switch(e.operation){case ue.OPERATIONS_ENUM.INSERT:try{await Mc(e,t.inserted_hashes,i,r),await Pc(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for insert."),fe.error(o)}break;case ue.OPERATIONS_ENUM.DELETE:try{await Mc(e,t.deleted_hashes,i,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for delete."),fe.error(o)}break;case ue.OPERATIONS_ENUM.UPDATE:try{await Mc(e,t.update_hashes,i,r),await Pc(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for update."),fe.error(o)}break;case ue.OPERATIONS_ENUM.UPSERT:try{await Mc(e,t.upserted_hashes,i,r),await Pc(t,e,r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for upsert."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_SCHEMA:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_SCHEMA,schema:e.schema,__origin:i};await In.publishToStream(Di,Cn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_schema."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_TABLE:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_TABLE,schema:e.schema,table:e.table,hash_attribute:e.hash_attribute,__origin:i};await In.publishToStream(Di,Cn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_table."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE:try{let o={operation:ue.OPERATIONS_ENUM.CREATE_ATTRIBUTE,schema:e.schema,table:e.table,attribute:e.attribute,__origin:i};await In.publishToStream(Di,Cn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for create_attribute."),fe.error(o)}break;case ue.OPERATIONS_ENUM.CSV_DATA_LOAD:try{let o={operation:ue.OPERATIONS_ENUM.CSV_DATA_LOAD,schema:e.schema,table:e.table,attribute:e.attribute};await In.publishToStream(Di,Cn,[o],r)}catch(o){fe.error("There was an error calling clustering postOperationHandler for csv_data_load."),fe.error(o)}break;default:break}return t}a(RV,"postOperationHandler")});var BO=h((RX,PO)=>{"use strict";var AV=Tt(),OV=hs(),yO=I(),DO=Ut(),pV=Xo(),NV=require("clone"),TE=require("alasql"),gV=Lo(),MO=require("util"),IV=MO.promisify(OV.getTableSchema),CV=MO.promisify(AV.search),bV=T(),fE=C(),wV=bn();gV(TE);PO.exports={update:UV};var LV="There was a problem performing this update. Please check the logs and try again.";async function UV({statement:e,hdb_user:t}){let r=await IV(e.table.databaseid,e.table.tableid),s=yV(e.columns);fE.backtickASTSchemaItems(e);let{table:n,where:i}=e,o=NV(n),c=fE.isEmpty(i)?"":` WHERE ${i.toString()}`,_=`SELECT ${r.hash_attribute} FROM ${n.toString()} ${c}`,u=TE.parse(_).statements[0],l=await pV.writeTransaction(r.schema,r.name,async()=>{let E=await CV(u),d=DV(s,E);return MV(o,d,t)});return await DO.flush({schema:r.schema,table:r.name}),l}a(UV,"update");function yV(e){try{let t={};return e.forEach(r=>{"value"in r.expression?t[r.column.columnid]=r.expression.value:t[r.column.columnid]=TE.compile(`SELECT ${r.expression.toString()} AS [${bV.FUNC_VAL}] FROM ?`)}),t}catch(t){throw yO.error(t),new Error(LV)}}a(yV,"createUpdateRecord");function DV(e,t){return fE.isEmptyOrZeroLength(t)?[]:t.map(r=>Object.assign(r,e))}a(DV,"buildUpdateRecords");async function MV(e,t,r){let s={operation:"update",schema:e.databaseid_orig,table:e.tableid_orig,records:t,hdb_user:r};try{let n=await DO.update(s);await wV.postOperationHandler(s,n);try{delete n.new_attributes,delete n.txn_time}catch(i){yO.error(`Error delete new_attributes from update response: ${i}`)}return n}catch(n){throw n}}a(MV,"updateRecords")});var HO=h((AX,vO)=>{var PV=require("alasql"),BV=Tt(),vV=I(),HV=Or(),RE=require("util"),mE=C(),GV=T(),qV=hs(),FV=Xo(),VV=bn(),kV=Ut(),xV="record",$V="successfully deleted",YV=RE.callbackify(JV),KV=RE.promisify(BV.search),QV=RE.promisify(qV.getTableSchema);vO.exports={convertDelete:YV};function WV(e){return`${e.deleted_hashes.length} ${xV}${e.deleted_hashes.length===1?"":"s"} ${$V}`}a(WV,"generateReturnMessage");async function JV({statement:e,hdb_user:t}){let r=await QV(e.table.databaseid,e.table.tableid);mE.backtickASTSchemaItems(e);let{table:s,where:n}=e,i=mE.isEmpty(n)?"":` WHERE  ${n.toString()}`,o=`SELECT ${r.hash_attribute} FROM ${s.toString()} ${i}`,c=PV.parse(o).statements[0],_={operation:GV.OPERATIONS_ENUM.DELETE,schema:s.databaseid_orig,table:s.tableid_orig,hdb_user:t};try{let u=await FV.writeTransaction(r.schema,r.name,async()=>(_.records=await KV(c),HV.deleteRecords(_)));return await kV.flush({schema:r.schema,table:r.name}),u.deleted_hashes.length>0&&await VV.postOperationHandler(_,u),mE.isEmptyOrZeroLength(u.message)&&(u.message=WV(u)),delete u.txn_time,u}catch(u){throw vV.error(u),u.hdb_code?u.message:u}}a(JV,"convertDelete")});var FO=h((OX,qO)=>{"use strict";var OE=un(),{hdb_errors:AE}=D();qO.exports={checkSchemaExists:GO,checkSchemaTableExists:ZV,schema_describe:OE};async function GO(e){if(!global.hdb_schema[e])try{let t=await OE.describeSchema({schema:e});global.hdb_schema[e]=t}catch{return AE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}}a(GO,"checkSchemaExists");async function ZV(e,t){let r=await GO(e);if(r)return r;if(!global.hdb_schema[e][t])try{let s=await OE.describeTable({schema:e,table:t});if(!s||Object.keys(s).length===0)return AE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t);global.hdb_schema[e][t]=s}catch{return AE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}}a(ZV,"checkSchemaTableExists")});var Bc=h((NX,YO)=>{"use strict";var wn=Ka(),gs=FO(),VO=I(),XV=require("uuid").v4,pX=require("clone"),Un=Zs(),Is=T(),zV=require("util"),Cs=Or(),{handleHDBError:He,hdb_errors:jV}=D(),{HDB_ERROR_MSGS:Ln,HTTP_STATUS_CODES:Ge}=jV,{SchemaEventMsg:yn}=us(),kO=Rt();YO.exports={createSchema:ek,createSchemaStructure:xO,createTable:tk,createTableStructure:$O,createAttribute:ak,dropSchema:rk,dropTable:sk,dropAttribute:nk};async function ek(e){try{let t=await xO(e);return Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema)),t}catch(t){throw t}}a(ek,"createSchema");async function xO(e){let t=wn.schema_object(e);if(t)throw He(t,t.message,Ge.BAD_REQUEST,void 0,void 0,!0);if(!await gs.checkSchemaExists(e.schema))throw He(new Error,Ln.SCHEMA_EXISTS_ERR(e.schema),Ge.BAD_REQUEST,Is.LOG_LEVELS.ERROR,Ln.SCHEMA_EXISTS_ERR(e.schema),!0);try{return await Cs.createSchema(e),`schema '${e.schema}' successfully created`}catch(r){throw r}}a(xO,"createSchemaStructure");async function tk(e){try{let t=await $O(e);return Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema,e.table)),t}catch(t){throw t}}a(tk,"createTable");async function $O(e){let t=wn.create_table_object(e);if(t)throw He(t,t.message,Ge.BAD_REQUEST,void 0,void 0,!0);wn.validateTableResidence(e.residence);let r=await gs.checkSchemaExists(e.schema);if(r)throw He(new Error,r,Ge.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);if(!await gs.checkSchemaTableExists(e.schema,e.table))throw He(new Error,Ln.TABLE_EXISTS_ERR(e.schema,e.table),Ge.BAD_REQUEST,Is.LOG_LEVELS.ERROR,Ln.TABLE_EXISTS_ERR(e.schema,e.table),!0);let n={name:e.table,schema:e.schema,id:XV(),hash_attribute:e.hash_attribute};try{if(e.residence)if(global.clustering_on)n.residence=e.residence,await Cs.createTable(n,e);else throw He(new Error,"Clustering does not appear to be enabled. Cannot insert table with property 'residence'.",Ge.BAD_REQUEST);else await Cs.createTable(n,e);return`table '${e.schema}.${e.table}' successfully created.`}catch(i){throw i}}a($O,"createTableStructure");async function rk(e){let t=wn.schema_object(e);if(t)throw He(t,t.message,Ge.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaExists(e.schema);if(r)throw He(new Error,r,Ge.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);let s=await gs.schema_describe.describeSchema({schema:e.schema});global.hdb_schema[e.schema]=s;let n=Object.keys(global.hdb_schema[e.schema]);return await Cs.dropSchema(e),Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema)),delete global.hdb_schema[e.schema],await kO.purgeSchemaTableStreams(e.schema,n),`successfully deleted schema '${e.schema}'`}a(rk,"dropSchema");async function sk(e){let t=wn.table_object(e);if(t)throw He(t,t.message,Ge.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaTableExists(e.schema,e.table);if(r)throw He(new Error,r,Ge.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);return await Cs.dropTable(e),Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema,e.table)),await kO.purgeTableStream(e.schema,e.table),`successfully deleted table '${e.schema}.${e.table}'`}a(sk,"dropTable");async function nk(e){let t=wn.attribute_object(e);if(t)throw He(t,t.message,Ge.BAD_REQUEST,void 0,void 0,!0);let r=await gs.checkSchemaTableExists(e.schema,e.table);if(r)throw He(new Error,r,Ge.NOT_FOUND,Is.LOG_LEVELS.ERROR,r,!0);if(e.attribute===global.hdb_schema[e.schema][e.table].hash_attribute)throw He(new Error,"You cannot drop a hash attribute",Ge.BAD_REQUEST,void 0,void 0,!0);if(Is.TIME_STAMP_NAMES.indexOf(e.attribute)>=0)throw He(new Error,`cannot drop internal timestamp attribute: ${e.attribute}`,Ge.BAD_REQUEST,void 0,void 0,!0);try{return await Cs.dropAttribute(e),ik(e),Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema,e.table,e.attribute)),`successfully deleted attribute '${e.attribute}'`}catch(s){throw VO.error(`Got an error deleting attribute ${zV.inspect(e)}.`),s}}a(nk,"dropAttribute");function ik(e){let t=Object.values(global.hdb_schema[e.schema][e.table].attributes);for(let r=0;r<t.length;r++)t[r].attribute===e.attribute&&global.hdb_schema[e.schema][e.table].attributes.splice(r,1)}a(ik,"dropAttributeFromGlobal");async function ak(e){if(!global.hdb_schema[e.schema])throw He(new Error,Ln.SCHEMA_NOT_FOUND(e.schema),Ge.NOT_FOUND,void 0,void 0,!0);if(!global.hdb_schema[e.schema][e.table])throw He(new Error,Ln.TABLE_NOT_FOUND(e.schema,e.table),Ge.NOT_FOUND,void 0,void 0,!0);try{return await Cs.createAttribute(e),Un.signalSchemaChange(new yn(process.pid,e.operation,e.schema,e.table,e.attribute)),`attribute '${e.schema}.${e.table}.${e.attribute}' successfully created.`}catch(t){throw VO.error(t),t}}a(ak,"createAttribute")});var QO=h((gX,KO)=>{"use strict";var{OPERATIONS_ENUM:ok}=T(),vc=class{constructor(t,r,s=void 0,n=void 0){this.operation=ok.READ_AUDIT_LOG,this.schema=t,this.table=r,this.search_type=s,this.search_values=n}};a(vc,"ReadAuditLogObject");KO.exports=vc});var pE=h((CX,zO)=>{"use strict";var ck=Or(),IX=QO(),Hc=C(),Gc=T(),_k=Y(),{handleHDBError:WO,hdb_errors:uk}=D(),{HDB_ERROR_MSGS:JO,HTTP_STATUS_CODES:ZO}=uk,lk=Object.values(Gc.READ_AUDIT_LOG_SEARCH_TYPES_ENUM),XO="To use this operation audit log must be enabled in harperdb-config.yaml";zO.exports=Ek;async function Ek(e){if(Hc.isEmpty(e.schema))throw new Error(JO.SCHEMA_REQUIRED_ERR);if(Hc.isEmpty(e.table))throw new Error(JO.TABLE_REQUIRED_ERR);if(!_k.get(Gc.CONFIG_PARAMS.LOGGING_AUDITLOG))throw WO(new Error,XO,ZO.BAD_REQUEST,Gc.LOG_LEVELS.ERROR,XO,!0);let t=Hc.checkSchemaTableExist(e.schema,e.table);if(t)throw WO(new Error,t,ZO.NOT_FOUND,Gc.LOG_LEVELS.ERROR,t,!0);if(!Hc.isEmpty(e.search_type)&&lk.indexOf(e.search_type)<0)throw new Error(`Invalid search_type '${e.search_type}'`);return await ck.readAuditLog(e)}a(Ek,"readAuditLog")});var np=h((bX,sp)=>{var Jr=require("validate.js"),ep=de(),Dn=T(),{handleHDBError:dk,hdb_errors:Sk}=D(),{HDB_ERROR_MSGS:le,HTTP_STATUS_CODES:hk}=Sk,NE=a(()=>({role:{presence:!0,format:"[\\w\\-\\_]+"},id:{presence:!0,format:"[\\w\\-\\_]+"},permission:{presence:!0}}),"constraintsTemplate"),fk={STRUCTURE_USER:"structure_user"},jO=Object.values(Dn.ROLE_TYPES_ENUM),Tk="attribute_permissions",mk="attribute_name",{PERMS_CRUD_ENUM:Mn}=Dn,Rk=[Tk,...Object.values(Mn)],tp=[Mn.READ,Mn.INSERT,Mn.UPDATE],Ak=[mk,...tp];function Ok(e){let t=NE();return t.role.presence=!0,t.id.presence=!1,t.permission.presence=!0,rp(e,t)}a(Ok,"addRoleValidation");function pk(e){let t=NE();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!0,rp(e,t)}a(pk,"alterRoleValidation");function Nk(e){let t=NE();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!1,ep.validateObject(e,t)}a(Nk,"dropRoleValidation");var gk=["operation","role","id","permission","hdb_user","hdb_auth_header"];function rp(e,t){let r={main_permissions:[],schema_permissions:{}},s=Object.keys(e),n=[];for(let o=0,c=s.length;o<c;o++)gk.includes(s[o])||n.push(s[o]);n.length>0&&Te(le.INVALID_ROLE_JSON_KEYS(n),r);let i=ep.validateObject(e,t);if(i&&i.message.split(",").forEach(o=>{Te(o,r)}),e.permission){let o=Ik(e);o&&Te(o,r),jO.forEach(c=>{e.permission[c]&&!Jr.isBoolean(e.permission[c])&&Te(le.SU_CU_ROLE_BOOLEAN_ERROR(c),r)})}for(let o in e.permission)if(jO.indexOf(o)<0){if(o===fk.STRUCTURE_USER){let _=e.permission[o];if(typeof _=="boolean")continue;if(Array.isArray(_)){for(let u=0,l=_.length;u<l;u++){let E=_[u];global.hdb_schema[E]||Te(le.SCHEMA_NOT_FOUND(E),r)}continue}Te(le.STRUCTURE_USER_ROLE_TYPE_ERROR(o),r);continue}let c=e.permission[o];if(!o||!global.hdb_schema[o]){Te(le.SCHEMA_NOT_FOUND(o),r);continue}if(c.tables)for(let _ in c.tables){let u=c.tables[_];if(!_||!global.hdb_schema[o][_]){Te(le.TABLE_NOT_FOUND(o,_),r);continue}if(Object.keys(u).forEach(l=>{Rk.includes(l)||Te(le.INVALID_PERM_KEY(l),r,o,_)}),Object.values(Mn).forEach(l=>{Jr.isDefined(u[l])?Jr.isBoolean(u[l])||Te(le.TABLE_PERM_NOT_BOOLEAN(l),r,o,_):Te(le.TABLE_PERM_MISSING(l),r,o,_)}),Jr.isDefined(u.attribute_permissions)){if(!Jr.isArray(u.attribute_permissions)){Te(le.ATTR_PERMS_NOT_ARRAY,r,o,_);continue}}else{Te(le.ATTR_PERMS_ARRAY_MISSING,r,o,_);continue}if(u.attribute_permissions){let l=global.hdb_schema[o][_].attributes.map(({attribute:d})=>d),E={read:!1,insert:!1,update:!1};for(let d in u.attribute_permissions){let S=u.attribute_permissions[d];if(Object.keys(S).forEach(R=>{!Ak.includes(R)&&R!==Mn.DELETE&&Te(le.INVALID_ATTR_PERM_KEY(R),r,o,_)}),!Jr.isDefined(S.attribute_name)){Te(le.ATTR_PERM_MISSING_NAME,r,o,_);continue}let m=S.attribute_name;if(!l.includes(m)){Te(le.INVALID_ATTRIBUTE_IN_PERMS(m),r,o,_);continue}tp.forEach(R=>{Jr.isDefined(S[R])?Jr.isBoolean(S[R])||Te(le.ATTR_PERM_NOT_BOOLEAN(R,m),r,o,_):Te(le.ATTR_PERM_MISSING(R,m),r,o,_)}),!E.read&&S.read===!0&&(E.read=!0),!E.insert&&S.insert===!0&&(E.insert=!0),!E.update&&S.update===!0&&(E.update=!0)}if(u.read===!1&&E.read===!0||u.insert===!1&&E.insert===!0||u.update===!1&&E.update===!0){let d=`${o}.${_}`;Te(le.MISMATCHED_TABLE_ATTR_PERMS(d),r,o,_)}}}}return Ck(r)}a(rp,"customValidate");sp.exports={addRoleValidation:Ok,alterRoleValidation:pk,dropRoleValidation:Nk};function Ik(e){let{operation:t,permission:r}=e;if(t===Dn.OPERATIONS_ENUM.ADD_ROLE||t===Dn.OPERATIONS_ENUM.ALTER_ROLE){let s=r.super_user===!0,n=r.cluster_user===!0;if(Object.keys(r).length>1&&(s||n)){if(n&&s)return le.SU_CU_ROLE_COMBINED_ERROR;{let o=r.super_user?Dn.ROLE_TYPES_ENUM.SUPER_USER:Dn.ROLE_TYPES_ENUM.CLUSTER_USER;return le.SU_CU_ROLE_NO_PERMS_ALLOWED(o)}}}return null}a(Ik,"validateNoSUPerms");function Ck(e){let{main_permissions:t,schema_permissions:r}=e;if(t.length>0||Object.keys(r).length>0){let s={error:le.ROLE_PERMS_ERROR,...e};return dk(new Error,s,hk.BAD_REQUEST)}else return null}a(Ck,"generateRolePermResponse");function Te(e,t,r,s){if(!r)t.main_permissions.push(e);else{let n=s?r+"_"+s:r;t.schema_permissions[n]?t.schema_permissions[n].push(e):t.schema_permissions[n]=[e]}}a(Te,"addPermError")});var yE=h((wX,up)=>{"use strict";var ip=Ut(),ap=Tt(),bk=ms(),CE=np(),bE=Zs(),wk=require("uuid").v4,wE=require("util"),Lk=Ai(),Ir=T(),op=C(),LE=wE.promisify(ap.searchByValue),Uk=wE.promisify(ap.searchByHash),yk=wE.promisify(bk.delete),Dk=Kt(),Mk=Es(),{hdb_errors:Pk,handleHDBError:Pi}=D(),{HDB_ERROR_MSGS:cp,HTTP_STATUS_CODES:gE}=Pk,{UserEventMsg:UE}=us();up.exports={addRole:Bk,alterRole:Hk,dropRole:Gk,listRoles:_p};function IE(e){try{e.hdb_auth_header&&delete e.hdb_auth_header,e.HDB_INTERNAL_PATH&&delete e.HDB_INTERNAL_PATH,e.operation&&delete e.operation,e.hdb_user&&delete e.hdb_user}catch{}return e}a(IE,"scrubRoleDetails");async function Bk(e){let t=CE.addRoleValidation(e);if(t)throw t;if(!(await Lk.getLicense()).enterprise){let o=await _p();if(vk(e,o))throw new Error(`Your current license only supports ${Ir.BASIC_LICENSE_MAX_CLUSTER_USER_ROLES} cluster_user role. ${Ir.SUPPORT_HELP_MSG}`);if(o.length>=2)throw new Error(`Your current license only supports ${Ir.BASIC_LICENSE_MAX_NON_CU_ROLES+Ir.BASIC_LICENSE_MAX_CLUSTER_USER_ROLES} roles.  ${Ir.SUPPORT_HELP_MSG}`)}e=IE(e);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:e.role,hash_attribute:"id",get_attributes:["*"]},n;try{n=await LE(s)}catch(o){throw Pi(o)}if(n&&n.length>0)throw Pi(new Error,cp.ROLE_ALREADY_EXISTS(e.role),gE.CONFLICT,void 0,void 0,!0);e.id||(e.id=wk());let i={operation:"insert",schema:"system",table:"hdb_role",hash_attribute:"id",records:[e]};return await ip.insert(i),bE.signalUserChange(new UE(process.pid)),e=IE(e),e}a(Bk,"addRole");function vk(e,t){let r=!1;if(e.permission.cluster_user===!0)for(let s=0;s<t.length;s++){let i=t[s].permission;if(!op.isEmpty(i)&&i.cluster_user===!0)return!0}return r}a(vk,"checkClusterUserRole");async function Hk(e){let t=CE.alterRoleValidation(e);if(t)throw t;e=IE(e);let r={operation:"update",schema:"system",table:"hdb_role",hash_attribute:"rolename",records:[e]};try{await ip.update(r)}catch(s){throw Pi(s)}return bE.signalUserChange(new UE(process.pid)),e}a(Hk,"alterRole");async function Gk(e){let t=CE.dropRoleValidation(e);if(t)throw Pi(new Error,t,gE.BAD_REQUEST,void 0,void 0,!0);let r=new Mk(Ir.SYSTEM_SCHEMA_NAME,Ir.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME,[e.id],["role"]),s=await Uk(r);if(s.length===0)throw Pi(new Error,cp.ROLE_NOT_FOUND,gE.NOT_FOUND,void 0,void 0,!0);let n=new Dk(Ir.SYSTEM_SCHEMA_NAME,Ir.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,"role",e.id,void 0,["username","active"]),i=await LE(n),o=!1;if(op.isEmptyOrZeroLength(i)===!1){for(let _=0;_<i.length;_++)if(i[_].active===!0){o=!0;break}}if(o===!0)throw new Error(`Cannot drop role ${s[0].role} as it has active user(s) tied to this role`);let c={table:"hdb_role",schema:"system",hash_values:[e.id]};return await yk(c),bE.signalUserChange(new UE(process.pid)),`${s[0].role} successfully deleted`}a(Gk,"dropRole");async function _p(){return LE({table:"hdb_role",schema:"system",hash_attribute:"id",search_attribute:"id",search_value:"*",get_attributes:["*"]})}a(_p,"listRoles")});var Sp=h((LX,dp)=>{"use strict";var qk=Y(),Zr=require("joi"),Fk=de(),lp=require("moment"),Vk=require("fs-extra"),DE=require("path"),kk=require("lodash"),Bi=T(),{LOG_LEVELS:bs}=T(),xk="YYYY-MM-DD hh:mm:ss",$k=DE.resolve(__dirname,"../logs");dp.exports=function(e){return Fk.validateBySchema(e,Yk)};var Yk=Zr.object({from:Zr.custom(Ep),until:Zr.custom(Ep),level:Zr.valid(bs.NOTIFY,bs.FATAL,bs.ERROR,bs.WARN,bs.INFO,bs.DEBUG,bs.TRACE),order:Zr.valid("asc","desc"),limit:Zr.number().min(1),start:Zr.number().min(0),log_name:Zr.custom(Kk)});function Ep(e,t){if(lp(e,lp.ISO_8601).format(xk)==="Invalid date")return t.message(`'${t.state.path[0]}' date '${e}' is invalid.`)}a(Ep,"validateDatetime");function Kk(e,t){if(kk.invert(Bi.PROCESS_LOG_NAMES)[e]===void 0)return t.message(`'log_name' '${e}' is invalid.`);let s=qk.get(Bi.HDB_SETTINGS_NAMES.LOG_PATH_KEY),n=e===void 0?Bi.PROCESS_LOG_NAMES.HDB:e,i=n===Bi.PROCESS_LOG_NAMES.INSTALL?DE.join($k,Bi.PROCESS_LOG_NAMES.INSTALL):DE.join(s,n);return Vk.existsSync(i)?null:t.message(`'log_name' '${e}' does not exist.`)}a(Kk,"validateReadLogPath")});var PE=h((UX,fp)=>{"use strict";var qc=T(),hp=I(),Qk=Y(),Wk=Sp(),ME=require("path"),Jk=require("fs-extra"),Zk=require("readline"),{once:Xk}=require("events"),{handleHDBError:zk,hdb_errors:jk}=D(),{PACKAGE_ROOT:ex}=T(),tx=ME.join(ex,"logs"),rx=1e3;fp.exports=sx;async function sx(e){let t=Wk(e);if(t)throw zk(t,t.message,jk.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=Qk.get(qc.HDB_SETTINGS_NAMES.LOG_PATH_KEY),s=e.log_name===void 0?qc.PROCESS_LOG_NAMES.HDB:e.log_name,n=s===qc.PROCESS_LOG_NAMES.INSTALL?ME.join(tx,qc.PROCESS_LOG_NAMES.INSTALL):ME.join(r,s),i=Jk.createReadStream(n);i.on("error",X=>{hp.error(X)});let o=Zk.createInterface({input:i,crlfDelay:1/0}),c=e.level!==void 0,_=c?e.level:void 0,u=e.from!==void 0,l=u?new Date(e.from):void 0,E=e.until!==void 0,d=E?new Date(e.until):void 0,S=e.limit===void 0?rx:e.limit,m=e.order===void 0?void 0:e.order,R=e.start===void 0?0:e.start,w=R+S,L=0,B=[];return o.on("line",X=>{let V,W,ke,xe;try{V=JSON.parse(X)}catch(ua){hp.warn(ua.message);return}switch(!0){case(c&&u&&E):W=new Date(V.timestamp),ke=new Date(l),xe=new Date(d),V.level===_&&W>=ke&&W<=xe&&L<R?L++:V.level===_&&W>=ke&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(c&&u):W=new Date(V.timestamp),ke=new Date(l),V.level===_&&W>=ke&&L<R?L++:V.level===_&&W>=ke&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(c&&E):W=new Date(V.timestamp),xe=new Date(d),V.level===_&&W<=xe&&L<R?L++:V.level===_&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case(u&&E):W=new Date(V.timestamp),ke=new Date(l),xe=new Date(d),W>=ke&&W<=xe&&L<R?L++:W>=ke&&W<=xe&&(zr(V,m,B),L++,L===w&&Xr(o));break;case c:V.level===_&&L<R?L++:V.level===_&&(zr(V,m,B),L++,L===w&&Xr(o));break;case u:W=new Date(V.timestamp),ke=new Date(l),W>=ke&&L<R?L++:W>=ke&&L>=R&&(zr(V,m,B),L++,L===w&&Xr(o));break;case E:W=new Date(V.timestamp),xe=new Date(d),W<=xe&&L<R?L++:W<=xe&&L>=R&&(zr(V,m,B),L++,L===w&&Xr(o));break;default:L<R?L++:(zr(V,m,B),L++,L===w&&Xr(o))}}),await Xk(o,"close"),B}a(sx,"readLog");function Xr(e){e.close(),e.removeAllListeners()}a(Xr,"endReadLine");function zr(e,t,r){t==="desc"?nx(e,r):t==="asc"?ix(e,r):r.push(e)}a(zr,"pushLineToResult");function nx(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)>r?s=i+1:n=i}t.splice(s,0,e)}a(nx,"insertDescending");function ix(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)<r?s=i+1:n=i}t.splice(s,0,e)}a(ix,"insertAscending")});var Vc=h((MX,Rp)=>{"use strict";var BE=require("joi"),{string:Fc,boolean:Tp,date:ax}=BE.types(),ox=de(),{validateSchemaExists:yX,validateTableExists:DX,validateSchemaName:cx}=Tr(),_x=T(),ux=he(),lx=Y(),Ex=Fc.invalid(lx.get(_x.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(ux.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null).required(),mp={operation:Fc.valid("add_node","update_node"),node_name:Ex,subscriptions:BE.array().items({table:Fc.required(),schema:Fc.custom(cx).required(),subscribe:Tp.required(),publish:Tp.required().custom(Sx),start_time:ax.iso()}).min(1).required()};function dx(e){return ox.validateBySchema(e,BE.object(mp))}a(dx,"addUpdateNodeValidator");function Sx(e,t){if(t.state.ancestors[2].operation==="add_node"&&e===!1&&t.state.ancestors[0].subscribe===!1)return t.message(`'subscriptions[${t.state.path[1]}]' subscribe and/or publish must be set to true when adding a node`)}a(Sx,"checkForFalsy");Rp.exports={addUpdateNodeValidator:dx,validation_schema:mp}});var HE=h((PX,Ip)=>{"use strict";var vE=Rt(),Ap=C(),Op=he(),hx=T(),kc=I(),pp=Bc(),fx=zu(),{RemotePayloadObject:Tx}=Ui(),{handleHDBError:Np,hdb_errors:mx}=D(),{HTTP_STATUS_CODES:gp}=mx,{NodeSubscription:Rx}=On();Ip.exports=Ax;async function Ax(e,t){let r;try{r=await vE.request(`${t}.${Op.REQUEST_SUFFIX}`,new Tx(hx.OPERATIONS_ENUM.DESCRIBE_ALL,t,void 0,void 0)),kc.trace("Response from remote describe all request:",r)}catch(o){kc.error(`addNode received error from describe all request to remote node: ${o}`);let c=vE.requestErrorHandler(o,"add_node",t);throw Np(new Error,c,gp.INTERNAL_SERVER_ERROR,"error",c)}if(r.status===Op.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let o=`Error returned from remote node ${t}: ${r.message}`;throw Np(new Error,o,gp.INTERNAL_SERVER_ERROR,"error",o)}let s=r.message,n=[],i=[];for(let o of e){let{schema:c,table:_}=o,u=Ap.doesSchemaExist(c),l=s[c]!==void 0,E=Ap.doesTableExist(c,_),d=s?.[c]?.[_]!==void 0;if(!u&&!l||!E&&!d){n.push(o);continue}if(!u&&l&&(kc.trace(`addNode creating schema: ${c}`),await pp.createSchema({operation:"create_schema",schema:c})),!E&&d){kc.trace(`addNode creating table: ${_} in schema: ${c}`);let m=new fx(c,_,s[c][_].hash_attribute);await pp.createTable(m)}await vE.createLocalTableStream(c,_);let S=new Rx(c,_,o.publish,o.subscribe);S.start_time=o.start_time,i.push(S)}return{added:i,skipped:n}}a(Ax,"reviewSubscriptions")});var Yc=h((BX,wp)=>{"use strict";var{handleHDBError:xc,hdb_errors:Ox}=D(),{HTTP_STATUS_CODES:$c}=Ox,{addUpdateNodeValidator:px}=Vc(),vi=I(),bp=T(),Cp=he(),Nx=C(),GE=Rt(),Hi=ps(),gx=Y(),Ix=HE(),{Node:Cx,NodeSubscription:bx}=On(),wx="Unable to create subscriptions due to schema and/or tables not existing on the local or remote node",Lx="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",Ux=gx.get(bp.CONFIG_PARAMS.CLUSTERING_NODENAME);wp.exports=yx;async function yx(e,t=!1){vi.trace("addNode called with:",e),Hi.checkClusteringEnabled();let r=px(e);if(r)throw xc(r,r.message,$c.BAD_REQUEST,void 0,void 0,!0);let s=e.node_name;if(!t){let E=await Hi.getNodeRecord(s);if(!Nx.isEmptyOrZeroLength(E))throw xc(new Error,`Node '${s}' has already been added, perform update_node to proceed.`,$c.BAD_REQUEST,void 0,void 0,!0)}let{added:n,skipped:i}=await Ix(e.subscriptions,s),o={message:void 0,added:n,skipped:i};if(n.length===0)return o.message=wx,o;let c=Hi.buildNodePayloads(n,Ux,bp.OPERATIONS_ENUM.ADD_NODE,await Hi.getSystemInfo());vi.trace("addNode sending remote payload:",c);let _;try{_=await GE.request(`${s}.${Cp.REQUEST_SUFFIX}`,c)}catch(E){vi.error(`addNode received error from request: ${E}`);let d=GE.requestErrorHandler(E,"add_node",s);throw xc(new Error,d,$c.INTERNAL_SERVER_ERROR,"error",d)}if(_.status===Cp.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let E=`Error returned from remote node ${s}: ${_.message}`;throw xc(new Error,E,$c.INTERNAL_SERVER_ERROR,"error",E)}vi.trace(_);let u=[];for(let E=0,d=n.length;E<d;E++){let S=n[E];vi.trace("Add node updating work stream for node:",s,"subscriptions:",S),await GE.updateWorkStream(S,s),n[E].start_time===void 0&&delete n[E].start_time,u.push(new bx(S.schema,S.table,S.publish,S.subscribe))}let l=new Cx(s,u,_.system_info);return await Hi.upsertNodeRecord(l),i.length>0?o.message=Lx:o.message=`Successfully added '${s}' to manifest`,o}a(yx,"addNode")});var FE=h((vX,yp)=>{"use strict";var{handleHDBError:Kc,hdb_errors:Dx}=D(),{HTTP_STATUS_CODES:Qc}=Dx,{addUpdateNodeValidator:Mx}=Vc(),Gi=I(),Up=T(),Lp=he(),Px=C(),qE=Rt(),qi=ps(),Bx=Y(),{cloneDeep:vx}=require("lodash"),Hx=HE(),{NodeSubscription:Gx}=On(),qx="Unable to update subscriptions due to schema and/or tables not existing on the local or remote node",Fx="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",Vx=Bx.get(Up.CONFIG_PARAMS.CLUSTERING_NODENAME);yp.exports=kx;async function kx(e){Gi.trace("updateNode called with:",e),qi.checkClusteringEnabled();let t=Mx(e);if(t)throw Kc(t,t.message,Qc.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=vx(await qi.getNodeRecord(r));if(Px.isEmptyOrZeroLength(s))throw Kc(new Error,`Node '${r}' has not been added, perform add_node to proceed.`,Qc.BAD_REQUEST,void 0,void 0,!0);let{added:n,skipped:i}=await Hx(e.subscriptions,r),o={message:void 0,updated:n,skipped:i};if(n.length===0)return o.message=qx,o;let c=qi.buildNodePayloads(n,Vx,Up.OPERATIONS_ENUM.UPDATE_NODE,await qi.getSystemInfo());Gi.trace("updateNode sending remote payload:",c);let _;try{_=await qE.request(`${r}.${Lp.REQUEST_SUFFIX}`,c)}catch(u){Gi.error(`updateNode received error from request: ${u}`);let l=qE.requestErrorHandler(u,"update_node",r);throw Kc(new Error,l,Qc.INTERNAL_SERVER_ERROR,"error",l)}if(_.status===Lp.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let u=`Error returned from remote node ${r}: ${_.message}`;throw Kc(new Error,u,Qc.INTERNAL_SERVER_ERROR,"error",u)}Gi.trace(_);for(let u=0,l=n.length;u<l;u++){let E=n[u];Gi.trace(`updateNode updating work stream for node: ${r} subscription:`,E),await qE.updateWorkStream(E,r),n[u].start_time===void 0&&delete n[u].start_time}return await xx(s[0],n,_.system_info),i.length>0?o.message=Fx:o.message=`Successfully updated '${r}'`,o}a(kx,"updateNode");async function xx(e,t,r){let s=e;for(let n=0,i=t.length;n<i;n++){let o=t[n],c=!1;for(let _=0,u=e.subscriptions.length;_<u;_++){let l=s.subscriptions[_];if(l.schema===o.schema&&l.table===o.table){l.publish=o.publish,l.subscribe=o.subscribe,c=!0;break}}c||s.subscriptions.push(new Gx(o.schema,o.table,o.publish,o.subscribe))}s.system_info=r,await qi.upsertNodeRecord(s)}a(xx,"updateNodeTable")});var vp=h((HX,Bp)=>{"use strict";var Pp=require("joi"),{string:Dp}=Pp.types(),$x=de(),Mp=T(),Yx=Y(),Kx=he();Bp.exports=Qx;function Qx(e){let t=Dp.invalid(Yx.get(Mp.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(Kx.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null),r=Pp.object({operation:Dp.valid(Mp.OPERATIONS_ENUM.REMOVE_NODE).required(),node_name:t});return $x.validateBySchema(e,r)}a(Qx,"removeNodeValidator")});var Jc=h((GX,kp)=>{"use strict";var{handleHDBError:Hp,hdb_errors:Wx}=D(),{HTTP_STATUS_CODES:Gp}=Wx,Jx=vp(),Fi=I(),qp=ps(),Zx=C(),Wc=T(),Fp=he(),Vp=Rt(),Xx=Y(),{RemotePayloadObject:zx}=Ui(),{NodeSubscription:jx}=On(),e$=li(),t$=ms(),r$=Xx.get(Wc.CONFIG_PARAMS.CLUSTERING_NODENAME);kp.exports=s$;async function s$(e){Fi.trace("removeNode called with:",e),qp.checkClusteringEnabled();let t=Jx(e);if(t)throw Hp(t,t.message,Gp.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=await qp.getNodeRecord(r);if(Zx.isEmptyOrZeroLength(s))throw Hp(new Error,`Node '${r}' was not found.`,Gp.BAD_REQUEST,void 0,void 0,!0);s=s[0];let n=new zx(Wc.OPERATIONS_ENUM.REMOVE_NODE,r$,[]),i,o=!1;try{i=await Vp.request(`${r}.${Fp.REQUEST_SUFFIX}`,n),Fi.trace("Remove node reply from remote node:",r,i)}catch(_){Fi.error("removeNode received error from request:",_),o=!0}for(let _=0,u=s.subscriptions.length;_<u;_++){let l=s.subscriptions[_];Fi.trace(`Remove node removing subscription: ${l.schema}.${l.table} for node: ${r}`);let E=new jx(l.schema,l.table,!1,!1);await Vp.updateWorkStream(E,r)}let c=new e$(Wc.SYSTEM_SCHEMA_NAME,Wc.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[r]);return await t$.deleteRecord(c),i?.status===Fp.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR||o?(Fi.error("Error returned from remote node:",r,i?.message),`Successfully removed '${r}' from local manifest, however there was an error reaching remote node. Check the logs for more details.`):`Successfully removed '${r}' from manifest`}a(s$,"removeNode")});var Yp=h((qX,$p)=>{"use strict";var xp=require("joi"),{string:n$,array:i$}=xp.types(),a$=de(),o$=Vc();$p.exports=c$;function c$(e){let t=xp.object({operation:n$.valid("configure_cluster").required(),connections:i$.items(o$.validation_schema).required()});return a$.validateBySchema(e,t)}a(c$,"configureClusterValidator")});var VE=h((FX,Zp)=>{"use strict";var _$=T(),Zc=I(),u$=C(),l$=Jc(),E$=Yc(),Kp=ps(),d$=Yp(),{handleHDBError:Qp,hdb_errors:S$}=D(),{HTTP_STATUS_CODES:Wp}=S$,h$="Configure cluster complete.",f$="Failed to configure the cluster. Check the logs for more details.",T$="Configure cluster was partially successful. Errors occurred when attempting to configure the following nodes. Check the logs for more details.";Zp.exports=m$;async function m$(e){Zc.trace("configure cluster called with:",e),Kp.checkClusteringEnabled();let t=d$(e);if(t)throw Qp(t,t.message,Wp.BAD_REQUEST,void 0,void 0,!0);let r=await Kp.getAllNodeRecords(),s=[];for(let d=0,S=r.length;d<S;d++)s.push(Jp(l$,{operation:_$.OPERATIONS_ENUM.REMOVE_NODE,node_name:r[d].name},r[d].name));let n=await Promise.allSettled(s);Zc.trace("All results from configure_cluster remove node:",n);let i=[],o=e.connections.length;for(let d=0;d<o;d++){let S=e.connections[d];i.push(Jp(E$,S,S.node_name))}let c=await Promise.allSettled(i);Zc.trace("All results from configure_cluster add node:",c);let _=[],u=[],l=!1,E=n.concat(c);for(let d=0,S=E.length;d<S;d++){let m=E[d];m.status==="rejected"&&(Zc.error(m.reason),_.includes(m.reason.node_name)||_.push(m.reason.node_name)),m.status==="fulfilled"&&(l=!0);let R=m?.value?.result;typeof R=="string"&&R.includes("Successfully removed")||m.status==="rejected"||u.push({node_name:m?.value?.node_name,subscriptions:m?.value?.result})}if(u$.isEmptyOrZeroLength(_))return{message:h$,connections:u};if(l)return{message:T$,failed_nodes:_,connections:u};throw Qp(new Error,f$,Wp.INTERNAL_SERVER_ERROR,void 0,void 0,!0)}a(m$,"configureCluster");async function Jp(e,t,r){try{return{node_name:r,result:await e(t)}}catch(s){throw{node_name:r,error:s}}}a(Jp,"functionWrapper")});var $E=h((VX,rN)=>{"use strict";var xE=ps(),R$=Rt(),jp=Y(),Xc=T(),ws=he(),A$=C(),kE=I(),{RemotePayloadObject:O$}=Ui(),{ErrorCode:Xp}=require("nats"),zp=jp.get(Xc.CONFIG_PARAMS.CLUSTERING_ENABLED),eN=jp.get(Xc.CONFIG_PARAMS.CLUSTERING_NODENAME);rN.exports={clusterStatus:p$,buildNodeStatus:tN};async function p$(){let e={node_name:eN,is_enabled:zp,connections:[]};if(!zp)return e;let t=await xE.getAllNodeRecords();if(A$.isEmptyOrZeroLength(t))return e;let r=[];for(let s=0,n=t.length;s<n;s++)r.push(tN(t[s],e.connections));return await Promise.allSettled(r),e}a(p$,"clusterStatus");async function tN(e,t){let r=e.name,s=new O$(Xc.OPERATIONS_ENUM.CLUSTER_STATUS,eN,void 0,await xE.getSystemInfo()),n,i,o=ws.CLUSTER_STATUS_STATUSES.OPEN;try{let _=Date.now();n=await R$.request(ws.REQUEST_SUBJECT(r),s),i=Date.now()-_,n.status===ws.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR&&(o=ws.CLUSTER_STATUS_STATUSES.CLOSED,kE.error(`Error getting node status from ${r} `,n))}catch(_){kE.warn(`Error getting node status from ${r}`,_),_.code===Xp.NoResponders?o=ws.CLUSTER_STATUS_STATUSES.NO_RESPONDERS:_.code===Xp.Timeout?o=ws.CLUSTER_STATUS_STATUSES.TIMEOUT:o=ws.CLUSTER_STATUS_STATUSES.CLOSED}let c=new N$(r,o,n?.message?.ports?.clustering,n?.message?.ports?.operations_api,i,n?.message?.uptime,e.subscriptions,n?.message?.system_info);try{let _={name:r,system_info:n?.message?.system_info};e.system_info?.hdb_version!==Xc.PRE_4_0_0_VERSION&&await xE.upsertNodeRecord(_)}catch(_){kE.error("Cluster status encountered an error updating system info for node:",r,_)}t.push(c)}a(tN,"buildNodeStatus");function N$(e,t,r,s,n,i,o,c){this.node_name=e,this.status=t,this.ports={clustering:r,operations_api:s},this.latency_ms=n,this.uptime=i,this.subscriptions=o,this.system_info=c}a(N$,"NodeStatusObject")});var aN=h((kX,iN)=>{"use strict";var YE=require("joi"),sN=de(),{route_constraints:nN}=Eu();iN.exports={setRoutesValidator:g$,deleteRoutesValidator:I$};function g$(e){let t=YE.object({server:YE.valid("hub","leaf").required(),routes:nN.required()});return sN.validateBySchema(e,t)}a(g$,"setRoutesValidator");function I$(e){let t=YE.object({routes:nN.required()});return sN.validateBySchema(e,t)}a(I$,"deleteRoutesValidator")});var QE=h((xX,uN)=>{"use strict";var Ls=hr(),KE=C(),zc=T(),oN=aN(),{handleHDBError:cN,hdb_errors:C$}=D(),{HTTP_STATUS_CODES:_N}=C$,b$="cluster routes successfully set",w$="cluster routes successfully deleted";uN.exports={setRoutes:L$,getRoutes:U$,deleteRoutes:y$};function L$(e){let t=oN.setRoutesValidator(e);if(t)throw cN(t,t.message,_N.BAD_REQUEST,void 0,void 0,!0);let r=Ls.getClusteringRoutes(),s=e.server==="hub"?r.hub_routes:r.leaf_routes,n=e.server==="hub"?r.leaf_routes:r.hub_routes,i=[],o=[];for(let c=0,_=e.routes.length;c<_;c++){let u=e.routes[c];u.port=KE.autoCast(u.port);let l=s.some(d=>d.host===u.host&&d.port===u.port),E=n.some(d=>d.host===u.host&&d.port===u.port);l||E?i.push(u):(s.push(u),o.push(u))}return e.server==="hub"?Ls.updateConfigValue(zc.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s):Ls.updateConfigValue(zc.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,s),{message:b$,set:o,skipped:i}}a(L$,"setRoutes");function U$(){let e=Ls.getClusteringRoutes();return{hub:e.hub_routes,leaf:e.leaf_routes}}a(U$,"getRoutes");function y$(e){let t=oN.deleteRoutesValidator(e);if(t)throw cN(t,t.message,_N.BAD_REQUEST,void 0,void 0,!0);let r=Ls.getClusteringRoutes(),s=r.hub_routes,n=r.leaf_routes,i=[],o=[],c=!1,_=!1;for(let u=0,l=e.routes.length;u<l;u++){let E=e.routes[u],d=!1;for(let S=0,m=s.length;S<m;S++){let R=s[S];if(E.host===R.host&&E.port===R.port){s.splice(S,1),d=!0,c=!0,i.push(E);break}}if(!d){let S=!0;for(let m=0,R=n.length;m<R;m++){let w=n[m];if(E.host===w.host&&E.port===w.port){n.splice(m,1),_=!0,S=!1,i.push(E);break}}S&&o.push(E)}}return c&&(s=KE.isEmptyOrZeroLength(s)?null:s,Ls.updateConfigValue(zc.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s)),_&&(n=KE.isEmptyOrZeroLength(n)?null:n,Ls.updateConfigValue(zc.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,n)),{message:w$,deleted:i,skipped:o}}a(y$,"deleteRoutes")});var EN=h(($X,lN)=>{"use strict";var Vi=require("alasql"),Us=require("recursive-iterator"),Wt=I(),D$=C(),ki=T(),jc=class{constructor(t){this.ast=t,this.affected_attributes=new Map,this.table_lookup=new Map,this.schema_lookup=new Map,this.table_to_schema_lookup=new Map,P$(this.ast,this.affected_attributes,this.table_lookup,this.schema_lookup,this.table_to_schema_lookup)}getAttributesBySchemaTableName(t,r){if(!t||!r||!this.affected_attributes)return[];if(this.affected_attributes.has(t))return!this.affected_attributes.get(t).has(r)&&(r=this.table_lookup.get(r),!r)?[]:this.affected_attributes.get(t).get(r)}getAllTables(){let t=[];if(!this.affected_attributes)return t;for(let r of this.affected_attributes.keys())t.push(Array.from(this.affected_attributes.get(r).keys()));return t}getTablesBySchemaName(t){return!t||!this.affected_attributes?[]:Array.from(this.affected_attributes.get(t).keys())}getSchemas(){return this.affected_attributes?Array.from(this.affected_attributes.keys()):[]}getAst(){return this.ast}updateAttributeWildcardsForRolePerms(t){let r=this.ast.columns.filter(n=>ki.SEARCH_WILDCARDS.includes(n.columnid));if(r.length===0)return this.ast;let s=this.ast.from[0].databaseid;return this.ast.columns=this.ast.columns.filter(n=>!ki.SEARCH_WILDCARDS.includes(n.columnid)),r.forEach(n=>{let i=this.table_to_schema_lookup.has(n.tableid)?this.table_to_schema_lookup.get(n.tableid):s,o=this.table_lookup.has(n.tableid)?this.table_lookup.get(n.tableid):this.ast.from[0].tableid;if(t[i]&&t[i].tables[o]&&t[i].tables[o][ki.PERMS_CRUD_ENUM.READ]){let c;t[i].tables[o].attribute_permissions.length>0?c=M$(t[i].tables[o].attribute_permissions):c=global.hdb_schema[i][o].attributes.map(u=>({attribute_name:u.attribute}));let _=this.affected_attributes.get(i).get(o).filter(u=>!ki.SEARCH_WILDCARDS.includes(u));c.forEach(({attribute_name:u})=>{let l=new Vi.yy.Column({columnid:u});n.tableid&&(l.tableid=n.tableid),this.ast.columns.push(l),_.includes(u)||_.push(u)}),this.affected_attributes.get(i).set(o,_)}}),this.ast}};a(jc,"sql_statement_bucket");function M$(e){return e.filter(t=>t[ki.PERMS_CRUD_ENUM.READ])}a(M$,"filterReadRestrictedAttrs");function P$(e,t,r,s,n){B$(e,t,r,s,n)}a(P$,"interpretAST");function xi(e,t,r,s,n){if(!(!e||!e.databaseid)&&(t.has(e.databaseid)||t.set(e.databaseid,new Map),t.get(e.databaseid).has(e.tableid)||t.get(e.databaseid).set(e.tableid,[]),e.as&&(r.has(e.as)||r.set(e.as,e.tableid),s&&!s.has(e.as)&&s.set(e.as,e.databaseid)),n)){let i=e.databaseid,o=e.tableid;e.as&&(o=e.as),n.set(o,i)}}a(xi,"addSchemaTableToMap");function B$(e,t,r,s,n){if(!e){Wt.info("getRecordAttributesAST: invalid SQL syntax tree");return}e instanceof Vi.yy.Insert?q$(e,t,r):e instanceof Vi.yy.Select?v$(e,t,r,s,n):e instanceof Vi.yy.Update?H$(e,t,r):e instanceof Vi.yy.Delete?G$(e,t,r):Wt.error("AST in getRecordAttributesAST() is not a valid SQL type.")}a(B$,"getRecordAttributesAST");function v$(e,t,r,s,n){if(!e){Wt.info("getSelectAttributes: invalid SQL syntax tree");return}if(!e.from||e.from[0]===void 0)return;let i=e.from[0].databaseid;if(D$.isEmptyOrZeroLength(i)){Wt.error("No schema specified");return}e.from.forEach(c=>{xi(c,t,r,s,n)}),e.joins&&e.joins.forEach(c=>{c.as&&(c.table.as=c.as),xi(c.table,t,r,s,n)});let o=new Us(e.columns);for(let{node:c}of o)if(c&&c.columnid){let _=c.tableid,u=s.has(_)?s.get(_):i;if(_||(_=e.from[0].tableid),!t.get(u).has(_))if(r.has(_))_=r.get(_);else{Wt.info(`table specified as ${_} not found.`);return}t.get(u).get(_).indexOf(c.columnid)<0&&t.get(u).get(_).push(c.columnid)}if(e.where){let c=new Us(e.where),_=e.from[0].tableid;for(let{node:u}of c)if(u&&u.columnid){let l=u.tableid?u.tableid:_;if(!t.get(i).has(l))if(r.has(l))l=r.get(l);else{Wt.info(`table specified as ${l} not found.`);continue}t.get(i).get(l).indexOf(u.columnid)<0&&t.get(i).get(l).push(u.columnid)}}if(e.joins&&e.joins.forEach(c=>{let _=new Us(c.on);for(let{node:u}of _)if(u&&u.columnid){let l=u.tableid,E=n.get(l);if(!t.get(E).has(l))if(r.has(l))l=r.get(l);else{Wt.info(`table specified as ${l} not found.`);continue}t.get(E).get(l).indexOf(u.columnid)<0&&t.get(E).get(l).push(u.columnid)}}),e.order){let c=new Us(e.order);for(let{node:_}of c)if(_&&_.columnid){let u=_.tableid,l=s.has(u)?s.get(u):i;if(u||(u=e.from[0].tableid),!t.get(l).has(u))if(r.has(u))u=r.get(u);else{Wt.info(`table specified as ${u} not found.`);return}t.get(l).get(u).indexOf(_.columnid)<0&&t.get(l).get(u).push(_.columnid)}}}a(v$,"getSelectAttributes");function H$(e,t,r){if(!e){Wt.info("getUpdateAttributes: invalid SQL syntax tree");return}let s=new Us(e.columns),n=e.table.databaseid;xi(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&WE(e.table.tableid,n,i.columnid,t,r)}a(H$,"getUpdateAttributes");function G$(e,t,r){if(!e){Wt.info("getDeleteAttributes: invalid SQL syntax tree");return}let s=new Us(e.where),n=e.table.databaseid;xi(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&WE(e.table.tableid,n,i.columnid,t,r)}a(G$,"getDeleteAttributes");function q$(e,t,r){if(!e){Wt.info("getInsertAttributes: invalid SQL syntax tree");return}let s=new Us(e.columns),n=e.into.databaseid;xi(e.into,t,r);for(let{node:i}of s)i&&i.columnid&&WE(e.into.tableid,n,i.columnid,t,r)}a(q$,"getInsertAttributes");function WE(e,t,r,s,n){if(!s.get(t))return;let i=e;s.get(t).has(i)||(i=n.get(i)),s.get(t).get(i).push(r)}a(WE,"pushAttribute");lN.exports=jc});var hN=h((YX,SN)=>{var F$=require("os"),dN=Y();SN.exports={checkPermission:V$};function V$(){if(F$.userInfo().username!==dN.get("install_user"))throw new Error(`Error: Must execute as ${dN.get("install_user")}`)}a(V$,"checkPermission")});var ZE=h((KX,AN)=>{var t_=Ai(),fN=require("chalk"),or=I(),TN=hN(),mN=require("prompt"),{promisify:k$}=require("util"),e_=T(),x$=require("fs-extra"),$$=require("path"),Y$=C(),K$=cE(),RN=Y();RN.initSync();var Q$=require("moment"),W$=k$(mN.get),J$=$$.join(RN.getHdbBasePath(),e_.LICENSE_KEY_DIR_NAME,e_.LICENSE_FILE_NAME,e_.LICENSE_FILE_NAME);AN.exports={getFingerprint:X$,setLicense:Z$,parseLicense:JE,register:z$,getRegistrationInfo:eY};async function Z$(e){if(e&&e.key&&e.company){try{or.info(`parsing license key: ${e.key} and `);let t=e.company.toString();await JE(e.key.trim(),t.trim())}catch(t){let r="There was an error parsing the license key.";throw or.error(r),or.error(t),new Error(r)}return"Wrote license key file.  Registration successful."}throw new Error("Invalid key or company specified for license file.")}a(Z$,"setLicense");async function X$(){try{TN.checkPermission()}catch(t){throw or.error(t),new Error("You do not have permission to generate a fingerprint.")}let e={};try{e=await t_.generateFingerPrint()}catch(t){let r="Error generating fingerprint.";throw or.error(r),or.error(t),new Error(r)}return e}a(X$,"getFingerprint");async function JE(e,t){if(!e||!t)throw new Error("Invalid entries for License Key and Customer Company");console.log("Validating license input...");let r=t_.validateLicense(e,t);if(console.log("checking for valid license..."),!r.valid_license)throw new Error("Invalid license found.");if(console.log("checking valid license date..."),!r.valid_date)throw new Error("This License has expired.");if(console.log(`checking for valid machine license ${r.valid_machine}`),!r.valid_machine)throw new Error("This license is in use on another machine.");try{or.info("writing license to disk"),await x$.writeFile(J$,JSON.stringify({license_key:e,company:t}))}catch(s){throw or.error("Failed to write License"),s}return"Registration successful."}a(JE,"parseLicense");async function z$(){let e=await j$();return JE(e.HDB_LICENSE,e.CUSTOMER_COMPANY)}a(z$,"register");async function j$(){try{TN.checkPermission()}catch(s){return console.error(s.message)}let e=await t_.generateFingerPrint(),t={properties:{CUSTOMER_COMPANY:{description:fN.magenta("[COMPANY] Please enter your company name"),required:!0},HDB_LICENSE:{description:fN.magenta(`[HDB_LICENSE] Your fingerprint is ${e} Please enter your license key`),required:!0}}};try{mN.start()}catch(s){or.error(s)}let r;try{r=await W$(t)}catch(s){throw console.error("There was a problem prompting for registration input.  Exiting."),s}return r}a(j$,"promptForRegistration");async function eY(){let e={registered:!1,version:null,storage_type:null,ram_allocation:null,license_expiration_date:null},t;try{t=await t_.getLicense()}catch(r){throw or.error(`There was an error when searching licenses due to: ${r.message}`),r}if(Y$.isEmptyOrZeroLength(t))throw new Error("There were no licenses found.");if(e.registered=t.enterprise,e.version=K$.version(),e.storage_type=e_.STORAGE_TYPES_ENUM.LMDB,e.ram_allocation=t.ram_allocation,isNaN(t.exp_date))e.license_expiration_date=t.enterprise?t.exp_date:null;else{let r=Q$.utc(t.exp_date).format("YYYY-MM-DD");e.license_expiration_date=t.enterprise?r:null}return e}a(eY,"getRegistrationInfo")});var td=h((QX,IN)=>{"use strict";var y=T(),K=I(),r_=C(),tY=z_(),XE=Kl(),ed=Rt(),rY=he(),pN=require("minimist"),{handleHDBError:zE,hdb_errors:sY}=D(),$i=hr(),{HTTP_STATUS_CODES:jE}=sY,q,ON=`Restarting HarperDB. This may take up to ${y.RESTART_TIMEOUT_MS/1e3} seconds.`,ys="HarperDB is currently restarting and must complete before another HarperDB restart can be initialized.",nY="Invalid service",iY="'service' is required",aY="Restarting all services",oY="Clustering is not enabled so cannot be restarted";IN.exports={stop:_Y,restartProcesses:cY,restartService:NN};async function cY(){K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP);try{q===void 0&&(q=gn());let e=tY(Object.keys(y.CONFIG_PARAM_MAP),!0);r_.isEmptyOrZeroLength(Object.keys(e))||$i.updateConfigValue(void 0,void 0,e,!0,!0);let t=$i.getConfigFromFile(y.CONFIG_PARAMS.CLUSTERING_ENABLED),r=$i.getConfigFromFile(y.CONFIG_PARAMS.CUSTOMFUNCTIONS_ENABLED),s=pN(process.argv);if(!r_.isEmpty(s.service)){if(typeof s.service!="string"){let c=`Restart service argument expected a string but received: ${s.service}`;return K.error(c),c}let o=s.service.split(",");for(let c of o){let _=c.toLowerCase();if(_===y.HDB_PROC_DESCRIPTOR.toLowerCase()&&await q.isHdbRestartRunning()===!0){K.notify(ys),console.error(ys);continue}if(y.PROCESS_DESCRIPTORS_VALIDATE[_]===void 0){console.error(`Restart received unrecognized service command argument: ${_}`),K.error(`Restart received unrecognized service command argument: ${_}`);continue}let u=y.PROCESS_DESCRIPTORS_VALIDATE[_];if(console.log(`Restarting ${u}`),K.trace(`Restarting ${u}`),u===y.PROCESS_DESCRIPTORS.PM2_LOGROTATE)await q.configureLogRotate();else if(_.toLowerCase().includes("clustering"))await Pn(_);else if(await q.isServiceRegistered(u))u===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS&&!r?(await q.stop(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Stopping ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`)):await NN({service:u});else if(u===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS)if(r)await q.startService(u),K.trace(`Starting ${u}`);else{let l=`${u} is not enabled in harperdb-config.yaml and cannot be restarted.`;K.error(l),console.log(l)}else await q.startService(u);K.notify(`${u} successfully restarted.`)}return}if(await q.isHdbRestartRunning()===!0)return K.notify(ys),console.error(ys),ys;console.log(ON),t&&await gN();let n=await q.isServiceRegistered(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS);r&&!n&&(await q.startService(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Starting ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`));let i=[y.PROCESS_DESCRIPTORS.CLUSTERING_HUB,y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF,y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE,y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE];return!r&&n&&(i.push(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),await q.stop(y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS),K.trace(`Stopping ${y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS}`)),await q.configureLogRotate(),K.notify(aY),await q.restartAllServices(i),ON}catch(e){let t=`There was an error restarting HarperDB. ${e}`;return K.error(t),t}}a(cY,"restartProcesses");async function NN(e){if(K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP),q===void 0&&(q=gn()),r_.isEmpty(e.service))throw zE(new Error,iY,jE.BAD_REQUEST,void 0,void 0,!0);let t=e.service.toLowerCase();if(y.PROCESS_DESCRIPTORS_VALIDATE[t]===void 0)throw zE(new Error,nY,jE.BAD_REQUEST,void 0,void 0,!0);let r=$i.getConfigFromFile(y.CONFIG_PARAMS.CUSTOMFUNCTIONS_ENABLED),s=y.PROCESS_DESCRIPTORS_VALIDATE[t];if(s===y.PROCESS_DESCRIPTORS.HDB){if(await q.isHdbRestartRunning()===!0)return K.notify(ys),ys;await q.reloadStopStart(s)}else if(s===y.PROCESS_DESCRIPTORS.PM2_LOGROTATE)await q.configureLogRotate();else if(s.toLowerCase().includes("clustering"))await Pn(s);else if(s===y.PROCESS_DESCRIPTORS.CUSTOM_FUNCTIONS||s===y.SERVICES.CUSTOM_FUNCTIONS){let i=await q.isServiceRegistered(s);if(r)i?(await q.reloadStopStart(s),K.trace(`Reloading ${s}`)):(await q.startService(s),K.trace(`Starting ${s}`));else if(!r&&i)await q.stop(s),K.trace(`Stopping ${s}`);else{let o=`${s} is not enabled in harperdb-config.yaml and cannot be restarted.`;throw K.error(o),zE(new Error,o,jE.BAD_REQUEST,void 0,void 0,!0)}}else await q.restart(s);let n=`Restarting ${s}`;return K.notify(n),n}a(NN,"restartService");async function _Y(){K.createLogFile(y.PROCESS_LOG_NAMES.CLI,y.PROCESS_DESCRIPTORS.STOP);try{q===void 0&&(q=gn());let e=pN(process.argv);if(r_.isEmpty(e.service))console.log("Stopping HarperDB."),await q.stopAllServices(),K.notify("HarperDB has stopped");else{if(typeof e.service!="string"){let r=`Stop service argument expected a string but received: ${e.service}`;K.error(r),console.log(r)}let t=e.service.split(",");for(let r of t){let s=r.toLowerCase();if(y.PROCESS_DESCRIPTORS_VALIDATE[s]===void 0){K.error(`Stop received unrecognized service command argument: ${s}`);continue}s==="clustering"?await q.stopClustering():await q.stop(y.PROCESS_DESCRIPTORS_VALIDATE[s]);let n=`${y.PROCESS_DESCRIPTORS_VALIDATE[s]} successfully stopped.`;K.notify(n),console.log(n)}}}catch(e){throw console.error(e),e}}a(_Y,"stop");async function gN(){await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE),await Pn(y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE),await ed.updateNodeNameLocalStreams(),await ed.closeConnection()}a(gN,"restartAllClusteringServices");async function Pn(e){e=y.PROCESS_DESCRIPTORS_VALIDATE[e.toLowerCase()];let t=$i.getConfigFromFile(y.CONFIG_PARAMS.CLUSTERING_ENABLED),r=e==="clustering",s=e==="clustering config",n=r?void 0:await q.isServiceRegistered(e),i=r||s?await q.isClusteringRunning():void 0;switch(!0){case s:if(!i){K.error(oY);break}await q.reloadClustering();break;case(r&&i&&!t):await q.stopClustering();break;case(r&&!i&&t):await q.startClustering();break;case(r&&i&&t):await gN();break;case(r&&!i&&!t):K.error(`${e} is not enabled in harperdb-config.yaml and cannot be restarted.`);break;case(n&&!t):await q.stop(e),K.trace(`Stopping ${e}`);break;case(!n&&t):e!==y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE&&e!==y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE&&await XE.generateNatsConfig(!0,e),await q.startService(e),K.trace(`Starting ${e}`),e===y.PROCESS_DESCRIPTORS.CLUSTERING_LEAF&&await ed.createWorkQueueStream(rY.WORK_QUEUE_CONSUMER_NAMES);break;case(!n&&!t):K.error(`${e} is not enabled in harperdb-config.yaml and cannot be restarted.`);break;case(n&&t):e===y.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE||e===y.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE?await q.reload(e):(await XE.generateNatsConfig(!0,e),await q.restart(e),await XE.removeNatsConfig(e));break;default:K.error(`Error restarting ${e}`)}}a(Pn,"restartClustering")});var vN=h((JX,BN)=>{"use strict";var WX=require("lodash"),Ze=T(),{handleHDBError:CN,hdb_errors:uY}=D(),{HDB_ERROR_MSGS:lY,HTTP_STATUS_CODES:EY}=uY,rd=I();BN.exports={getRolePermissions:SY};var Ds=Object.create(null),dY=a(e=>({key:e,perms:{}}),"perms_template_obj"),UN=a((e=!1)=>({describe:e,tables:{}}),"schema_perms_template"),yN=a((e=!1,t=!1,r=!1,s=!1)=>({[Ze.PERMS_CRUD_ENUM.READ]:e,[Ze.PERMS_CRUD_ENUM.INSERT]:t,[Ze.PERMS_CRUD_ENUM.UPDATE]:r,[Ze.PERMS_CRUD_ENUM.DELETE]:s}),"permissions_template"),sd=a((e=!1,t=!1,r=!1,s=!1,n=!1)=>({attribute_permissions:[],describe:e,...yN(t,r,s,n)}),"table_perms_template"),bN=a((e,t=yN())=>({attribute_name:e,describe:PN(t),[Yi]:t[Yi],[nd]:t[nd],[id]:t[id]}),"attr_perms_template"),wN=a((e,t=!1)=>({attribute_name:e,describe:t,[Yi]:t}),"timestamp_attr_perms_template"),{READ:Yi,INSERT:nd,UPDATE:id}=Ze.PERMS_CRUD_ENUM,DN=Object.values(Ze.PERMS_CRUD_ENUM),MN=[Yi,nd,id];function SY(e){let t;try{if(e.permission.super_user||e.permission.cluster_user)return e.permission;let r=Object.assign({},global.hdb_schema);delete r[Ze.SYSTEM_SCHEMA_NAME],t=e.role;let s=JSON.stringify([e.__updatedtime__,r]);if(Ds[t]&&Ds[t].key===s)return Ds[t].perms;let n=hY(e,r);return Ds[t]?Ds[t].key=s:Ds[t]=dY(s),Ds[t].perms=n,n}catch(r){if(!e[Ze.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]||e[Ze.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]<Ze.PERMS_UPDATE_RELEASE_TIMESTAMP){let s=`Role permissions for role '${t}' must be updated to align with new structure from the 2.2.0 release.`;throw rd.error(s),rd.debug(r),CN(new Error,lY.OUTDATED_PERMS_TRANSLATION_ERROR,EY.BAD_REQUEST)}else{let s=`There was an error while translating role permissions for role: ${t}.
 ${r.stack}`;throw rd.error(s),CN(new Error)}}}a(SY,"getRolePermissions");function hY(e,t){let r=Object.create(null);r.super_user=!1;let s=e.permission;r[Ze.SYSTEM_SCHEMA_NAME]=s[Ze.SYSTEM_SCHEMA_NAME],r.structure_user=s.structure_user;let n=Array.isArray(e.permission.structure_user)||e.permission.structure_user===!0?e.permission.structure_user:[];return Object.keys(t).forEach(i=>{if(n===!0||n.indexOf(i)>-1){r[i]=fY(t[i]);return}r[i]=UN(),s[i]?Object.keys(t[i]).forEach(o=>{if(s[i].tables[o]){let c=s[i].tables[o],_=t[i][o],u=TY(c,_);r[i].describe||DN.forEach(l=>{u[l]&&(r[i].describe=!0)}),r[i].tables[o]=u}else r[i].tables[o]=sd()}):Object.keys(t[i]).forEach(o=>{r[i].tables[o]=sd()})}),r}a(hY,"translateRolePermissions");function fY(e){let t=UN(!0);return Object.keys(e).forEach(r=>{t.tables[r]=sd(!0,!0,!0,!0,!0)}),t}a(fY,"createStructureUserPermissions");function TY(e,t){let{attribute_permissions:r}=e;if(r.length>0){let n=Object.assign({},e);n.attribute_permissions=[];let i=r.reduce((u,l)=>{let{attribute_name:E}=l,d=l;return Ze.TIME_STAMP_NAMES.includes(E)&&(d=wN(E,l[Yi])),u[E]=d,u},{}),o=t[Ze.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_HASH_ATTRIBUTE_KEY],c=!!i[o],_=bN(o);return t.attributes.forEach(({attribute:u})=>{if(i[u]){let l=i[u];l.describe=PN(l),n.attribute_permissions.push(l),c||mY(l,_)}else if(u!==o){let l;Ze.TIME_STAMP_NAMES.includes(u)?l=wN(u):l=bN(u),n.attribute_permissions.push(l)}}),c||n.attribute_permissions.push(_),n.describe=LN(n),n}else return e.describe=LN(e),e}a(TY,"getTableAttrPerms");function LN(e){return DN.filter(t=>e[t]).length>0}a(LN,"getSchemaTableDescribePerm");function PN(e){return MN.filter(t=>e[t]).length>0}a(PN,"getAttributeDescribePerm");function mY(e,t){MN.forEach(r=>{e[r]&&!t[r]&&(t[r]=!0,t.describe=!0)})}a(mY,"checkForHashPerms")});var xN=h((ZX,kN)=>{"use strict";var Ee=require("joi"),HN=require("fs-extra"),GN=require("path"),Bn=de(),qN=Y(),FN=T(),VN=I(),{hdb_errors:RY}=D(),{HDB_ERROR_MSGS:Xe}=RY,jr=/^[a-zA-Z0-9-_]+$/;kN.exports={getDropCustomFunctionValidator:OY,setCustomFunctionValidator:pY,addCustomFunctionProjectValidator:NY,dropCustomFunctionProjectValidator:gY,packageCustomFunctionProjectValidator:IY,deployCustomFunctionProjectValidator:CY};function Ki(e,t,r){try{let s=qN.get(FN.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),n=GN.join(s,t);return HN.existsSync(n)?e?t:r.message(Xe.PROJECT_EXISTS):e?r.message(Xe.NO_PROJECT):t}catch(s){return VN.error(s),r.message(Xe.VALIDATION_ERR)}}a(Ki,"checkProjectExists");function AY(e,t,r,s){try{let n=qN.get(FN.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),i=GN.join(n,e,t,r+".js");return HN.existsSync(i)?r:s.message(Xe.NO_FILE)}catch(n){return VN.error(n),s.message(Xe.VALIDATION_ERR)}}a(AY,"checkFileExists");function OY(e){let t=Ee.object({project:Ee.string().pattern(jr).custom(Ki.bind(null,!0)).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME}),type:Ee.string().valid("helpers","routes").required(),file:Ee.string().pattern(jr).custom(AY.bind(null,e.project,e.type)).required().messages({"string.pattern.base":Xe.BAD_FILE_NAME})});return Bn.validateBySchema(e,t)}a(OY,"getDropCustomFunctionValidator");function pY(e){let t=Ee.object({project:Ee.string().pattern(jr).custom(Ki.bind(null,!0)).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME}),type:Ee.string().valid("helpers","routes").required(),file:Ee.string().pattern(jr).required().messages({"string.pattern.base":Xe.BAD_FILE_NAME}),function_content:Ee.string().required()});return Bn.validateBySchema(e,t)}a(pY,"setCustomFunctionValidator");function NY(e){let t=Ee.object({project:Ee.string().pattern(jr).custom(Ki.bind(null,!1)).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME})});return Bn.validateBySchema(e,t)}a(NY,"addCustomFunctionProjectValidator");function gY(e){let t=Ee.object({project:Ee.string().pattern(jr).custom(Ki.bind(null,!0)).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME})});return Bn.validateBySchema(e,t)}a(gY,"dropCustomFunctionProjectValidator");function IY(e){let t=Ee.object({project:Ee.string().pattern(jr).custom(Ki.bind(null,!0)).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME}),skip_node_modules:Ee.boolean()});return Bn.validateBySchema(e,t)}a(IY,"packageCustomFunctionProjectValidator");function CY(e){let t=Ee.object({project:Ee.string().pattern(jr).required().messages({"string.pattern.base":Xe.BAD_PROJECT_NAME}),payload:Ee.string().required().messages({"string.pattern.base":Xe.BAD_PACKAGE}),file:Ee.string().required().messages({"string.pattern.base":Xe.BAD_FILE_PATH})});return Bn.validateBySchema(e,t)}a(CY,"deployCustomFunctionProjectValidator")});var od=h((XX,YN)=>{"use strict";var me=require("fs-extra"),s_=require("fast-glob"),ie=require("path"),$N=require("tar-fs"),bY=require("uuid").v4,Qi=require("normalize-path"),Ms=xN(),Le=I(),At=T(),Ot=Y(),{PACKAGE_ROOT:wY}=T(),{handleHDBError:ze,hdb_errors:LY}=D(),{HDB_ERROR_MSGS:es,HTTP_STATUS_CODES:je}=LY,UY=ie.join(wY,"custom_function_template"),n_=ie.join(Ot.get(At.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),"tmp");function ad(){let e=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY);if(!(e==="true"||e===!0||e==="TRUE"))throw ze(new Error,es.NOT_ENABLED,je.BAD_REQUEST,void 0,void 0,!0)}a(ad,"isCFEnabled");function yY(){Le.trace("getting custom api status");let e={};try{e={is_enabled:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY),port:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY),directory:Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY)}}catch(t){throw ze(new Error,es.FUNCTION_STATUS,je.INTERNAL_SERVER_ERROR,Le.ERR,t)}return e}a(yY,"customFunctionsStatus");function DY(){Le.trace("getting custom api endpoints");let e={},t=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY);try{s_.sync(Qi(`${t}/*`),{onlyDirectories:!0}).forEach(s=>{let n=s.split("/").pop();e[n]={routes:s_.sync(Qi(`${s}/routes/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),helpers:s_.sync(Qi(`${s}/helpers/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),static:me.existsSync(Qi(`${s}/static`))&&s_.sync(Qi(`${s}/static/**/*`)).length}})}catch(r){throw ze(new Error,es.GET_FUNCTIONS,je.INTERNAL_SERVER_ERROR,Le.ERR,r)}return e}a(DY,"getCustomFunctions");function MY(e){e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=Ms.getDropCustomFunctionValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("getting custom api endpoint file content");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i}=e,o=ie.join(r,s,n,i+".js");try{return me.readFileSync(o,{encoding:"utf8"})}catch(c){throw ze(new Error,es.GET_FUNCTION,je.INTERNAL_SERVER_ERROR,Le.ERR,c)}}a(MY,"getCustomFunction");function PY(e){ad(),e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=Ms.setCustomFunctionValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("setting custom function file content");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i,function_content:o}=e;try{return me.outputFileSync(ie.join(r,s,n,i+".js"),o),`Successfully updated custom function: ${i}.js`}catch(c){throw ze(new Error,es.SET_FUNCTION,je.INTERNAL_SERVER_ERROR,Le.ERR,c)}}a(PY,"setCustomFunction");function BY(e){e.project&&(e.project=ie.parse(e.project).name),e.file&&(e.file=ie.parse(e.file).name);let t=Ms.getDropCustomFunctionValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("dropping custom function file");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,type:n,file:i}=e;try{return me.unlinkSync(ie.join(r,s,n,i+".js")),`Successfully deleted custom function: ${i}.js`}catch(o){throw ze(new Error,es.DROP_FUNCTION,je.INTERNAL_SERVER_ERROR,Le.ERR,o)}}a(BY,"dropCustomFunction");function vY(e){ad(),e.project&&(e.project=ie.parse(e.project).name);let t=Ms.addCustomFunctionProjectValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("adding custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e;try{let n=ie.join(r,s);return me.mkdirSync(n,{recursive:!0}),me.copySync(UY,n),`Successfully created custom function project: ${s}`}catch(n){throw ze(new Error,es.ADD_FUNCTION,je.INTERNAL_SERVER_ERROR,Le.ERR,n)}}a(vY,"addCustomFunctionProject");function HY(e){e.project&&(e.project=ie.parse(e.project).name);let t=Ms.dropCustomFunctionProjectValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("dropping custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e;try{let n=ie.join(r,s);return me.rmSync(n,{recursive:!0}),`Successfully deleted project: ${s}`}catch(n){throw ze(new Error,es.DROP_FUNCTION_PROJECT,je.INTERNAL_SERVER_ERROR,Le.ERR,n)}}a(HY,"dropCustomFunctionProject");async function GY(e){e.project&&(e.project=ie.parse(e.project).name);let t=Ms.packageCustomFunctionProjectValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("packaging custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s}=e,n=ie.join(r,s),i=bY();if(!me.existsSync(n)){let l=`Unable to locate custom function project: ${s}`;throw Le.error(l),l}me.ensureDirSync(n_);let c=ie.join(n_,`${i}.tar`),_={};(e.skip_node_modules===!0||e.skip_node_modules==="true")&&(_={ignore:l=>l.includes(ie.join(n,"node_modules"))}),$N.pack(n,_).pipe(me.createWriteStream(c)),await new Promise(l=>setTimeout(l,2e3));let u=me.readFileSync(c,{encoding:"base64"});return me.unlinkSync(c),{project:s,payload:u,file:c}}a(GY,"packageCustomFunctionProject");async function qY(e){ad(),e.project&&(e.project=ie.parse(e.project).name);let t=Ms.deployCustomFunctionProjectValidator(e);if(t)throw ze(t,t.message,je.BAD_REQUEST);Le.trace("deploying custom function project");let r=Ot.get(At.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),{project:s,payload:n,file:i}=e,o=ie.join(r,s);return me.existsSync(o)||me.mkdirSync(o,{recursive:!0}),me.existsSync(n_)||me.mkdirSync(n_),me.writeFileSync(i,n,{encoding:"base64"}),await new Promise(_=>setTimeout(_,2e3)),me.createReadStream(i).pipe($N.extract(o)),me.unlinkSync(i),`Successfully deployed project: ${s}`}a(qY,"deployCustomFunctionProject");YN.exports={customFunctionsStatus:yY,getCustomFunctions:DY,getCustomFunction:MY,setCustomFunction:PY,dropCustomFunction:BY,addCustomFunctionProject:vY,dropCustomFunctionProject:HY,packageCustomFunctionProject:GY,deployCustomFunctionProject:qY}});var cd=h((zX,QN)=>{"use strict";var cr=require("joi"),KN=de();QN.exports={readTransactionLogValidator:FY,deleteTransactionLogsBeforeValidator:VY};function FY(e){let t=cr.object({schema:cr.string().required(),table:cr.string().required(),from:cr.date().timestamp(),to:cr.date().timestamp(),limit:cr.number().min(1)});return KN.validateBySchema(e,t)}a(FY,"readTransactionLogValidator");function VY(e){let t=cr.object({schema:cr.string().required(),table:cr.string().required(),timestamp:cr.date().timestamp().required()});return KN.validateBySchema(e,t)}a(VY,"deleteTransactionLogsBeforeValidator")});var a_=h((jX,zN)=>{"use strict";var _d=T(),i_=Rt(),WN=C(),JN=Y(),ZN=Fr(),{handleHDBError:vn,hdb_errors:kY}=D(),{HTTP_STATUS_CODES:Hn}=kY,{readTransactionLogValidator:xY,deleteTransactionLogsBeforeValidator:$Y}=cd(),XN="This operation relies on clustering and cannot run with it disable.",YY="Logs successfully deleted from transaction log.",KY="All logs successfully deleted from transaction log.";zN.exports={readTransactionLog:QY,deleteTransactionLogsBefore:WY};async function QY(e){let t=xY(e);if(t)throw vn(t,t.message,Hn.BAD_REQUEST,void 0,void 0,!0);if(!JN.get(_d.CONFIG_PARAMS.CLUSTERING_ENABLED))throw vn(new Error,XN,Hn.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s}=e,n=WN.checkSchemaTableExist(r,s);if(n)throw vn(new Error,n,Hn.NOT_FOUND,void 0,void 0,!0);let i=ZN.createNatsTableStreamName(r,s),o=await i_.viewStream(i,parseInt(e.from),e.limit),c=[];for(let _=0,u=o.length;_<u;_++){let l=o[_],E=Math.floor(l?.nats_timestamp/1e6);if(e.to&&E>e.to)break;let d={operation:l?.entry?.operation,user:l?.entry?.__origin?.user,timestamp:E,records:l?.entry?.records};l?.entry?.operation===_d.OPERATIONS_ENUM.DELETE&&(d.hash_values=l?.entry?.hash_values),c.push(d)}return c}a(QY,"readTransactionLog");async function WY(e){let t=$Y(e);if(t)throw vn(t,t.message,Hn.BAD_REQUEST,void 0,void 0,!0);if(!JN.get(_d.CONFIG_PARAMS.CLUSTERING_ENABLED))throw vn(new Error,XN,Hn.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s,timestamp:n}=e,i=WN.checkSchemaTableExist(r,s);if(i)throw vn(new Error,i,Hn.NOT_FOUND,void 0,void 0,!0);let o=ZN.createNatsTableStreamName(r,s),{jsm:c}=await i_.getNATSReferences(),_=await i_.getStreamInfo(o),u=new Date(_.state.first_ts).getTime();if(n<=u)return`No transactions exist before: ${n}`;let l=YY,E,d=new Date(_.state.last_ts).getTime();return n>d?(E=_.state.last_seq+1,l=KY):E=(await i_.viewStream(o,parseInt(n),1))[0].nats_sequence,await c.streams.purge(o,{seq:E}),l}a(WY,"deleteTransactionLogsBefore")});var ld=h((e3,cg)=>{"use strict";var o_=require("joi"),c_=require("path"),jN=require("fs-extra"),{exec:JY}=require("child_process"),ZY=require("util"),eg=ZY.promisify(JY),XY=T(),{handleHDBError:Gn,hdb_errors:zY}=D(),{HTTP_STATUS_CODES:qn}=zY,tg=Y(),jY=de(),__=I();tg.initSync();var ud=tg.get(XY.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY),rg="npm install --omit=dev --json",eK=`${rg} --dry-run`;cg.exports={installModules:tK,auditModules:rK};async function sg(e,t=void 0){let{stdout:r,stderr:s}=await eg(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(sg,"runCommand");async function tK(e){__.info(`starting installModules for request: ${e}`);let t=og(e);if(t)throw Gn(t,t.message,qn.BAD_REQUEST);let{projects:r,dry_run:s}=e,n=s===!0?eK:rg;await ig(),await ag(r);let i={};for(let o=0,c=r.length;o<c;o++){let _=r[o];i[_]={npm_output:null,npm_error:null};let u=c_.join(ud,_),l,E=null;try{let{stdout:d,stderr:S}=await eg(n,{cwd:u});l=d?d.replace(`
`,""):null,E=S?S.replace(`
`,""):null}catch(d){d.stderr?i[_].npm_error=ng(d.stderr):i[_].npm_error=d.message;continue}try{i[_].npm_output=JSON.parse(l)}catch{i[_].npm_output=l}try{i[_].npm_error=JSON.parse(E)}catch{i[_].npm_error=E}}return __.info(`finished installModules with response ${i}`),i}a(tK,"installModules");function ng(e){let t='"error": {',r=e.indexOf('"error": {'),s=e.indexOf(`}
`);return r>-1&&s>-1?JSON.parse(e.substring(r+t.length-1,s+1)):e}a(ng,"parseNPMStdErr");async function rK(e){__.info(`starting auditModules for request: ${e}`);let t=og(e);if(t)throw Gn(t,t.message,qn.BAD_REQUEST);let{projects:r}=e;await ig(),await ag(r);let s={};for(let n=0,i=r.length;n<i;n++){let o=r[n],c=c_.join(ud,o);s[o]={npm_output:null,npm_error:null};try{let _=await sg("npm audit --json",c);s[o].npm_output=JSON.parse(_)}catch(_){s[o].npm_error=ng(_.stderr)}}return __.info(`finished auditModules with response ${s}`),s}a(rK,"auditModules");async function ig(){try{return await sg("npm -v"),!0}catch{throw Gn(new Error,"Unable to install project dependencies: npm is not installed on this instance of HarperDB.",qn.BAD_REQUEST,void 0,void 0,!0)}}a(ig,"checkNPMInstalled");async function ag(e){if(!Array.isArray(e)||e.length===0)throw Gn(new Error,"projects argument must be an array with at least 1 element",qn.BAD_REQUEST,void 0,void 0,!0);let t=[],r=[];for(let s=0,n=e.length;s<n;s++){let i=e[s],o=c_.join(ud,i.toString());if(!await jN.pathExists(o)){t.push(i);continue}let _=c_.join(o,"package.json");await jN.pathExists(_)||r.push(i)}if(t.length>0)throw Gn(new Error,`Unable to install project dependencies: custom function projects '${t.join(",")}' does not exist.`,qn.BAD_REQUEST,void 0,void 0,!0);if(r.length>0)throw Gn(new Error,`Unable to install project dependencies: custom function projects '${r.join(",")}' do not have a package.json file.`,qn.BAD_REQUEST,void 0,void 0,!0)}a(ag,"checkProjectPaths");function og(e){let t=o_.object({projects:o_.array().min(1).items(o_.string()).required(),dry_run:o_.boolean().default(!1)});return jY.validateBySchema(e,t)}a(og,"modulesValidator")});var ug=h((t3,_g)=>{"use strict";var u_=class{constructor(t,r,s=[],n=[]){this.schema=t,this.table=r,this.required_table_permissions=s,this.required_attribute_permissions=n}};a(u_,"PermissionTableResponseObject");_g.exports=u_});var Eg=h((r3,lg)=>{"use strict";var l_=class{constructor(t,r=[]){this.attribute_name=t,this.required_permissions=r}};a(l_,"PermissionAttributeResponseObject");lg.exports=l_});var Ed=h((s3,Sg)=>{"use strict";var dg=ug(),sK=Eg(),{HDB_ERROR_MSGS:nK}=st(),E_=class{constructor(){this.error=nK.OP_AUTH_PERMS_ERROR,this.unauthorized_access={},this.invalid_schema_items=[]}handleUnauthorizedItem(t){return this.invalid_schema_items=[],this.unauthorized_access=[t],this}handleInvalidItem(t){return this.invalid_schema_items=[t],this.unauthorized_access=[],this}addInvalidItem(t,r,s){if(r&&s){let n=`${r}_${s}`;if(this.unauthorized_access[n])return}this.invalid_schema_items.push(t)}addUnauthorizedTable(t,r,s){let n=new dg(t,r,s),i=`${t}_${r}`;this.unauthorized_access[i]=n}addUnauthorizedAttributes(t,r,s,n){let i=[];t.forEach(c=>{let _=new sK(c,n[c]);i.push(_)});let o=`${r}_${s}`;if(this.unauthorized_access[o])this.unauthorized_access[o].required_attribute_permissions=i;else{let c=new dg(r,s,[],i);this.unauthorized_access[o]=c}}getPermsResponse(){let t=Object.values(this.unauthorized_access);return t.length>0||this.invalid_schema_items.length>0?(this.unauthorized_access=t,this):null}};a(E_,"PermissionResponseObject");Sg.exports=E_});var f_=h((n3,Lg)=>{"use strict";var dd=Ut(),d_=Tt(),Bt=Bc(),Zi=un(),Sd=ms(),iK=pE(),Xi=Kr(),S_=yE(),pe=I(),aK=PE(),oK=Yc(),cK=FE(),_K=Jc(),uK=VE(),lK=$E(),hd=QE(),Cr=C(),EK=EN(),fd=ZE(),Tg=td(),Pt=T(),mg=vN(),dK=Cc(),Rg=fc(),Ag=hr(),br=od(),SK=require("alasql"),Og=a_(),pg=ld(),Ng=Ed(),{handleHDBError:Et,hdb_errors:gg}=D(),{HDB_ERROR_MSGS:qe,HTTP_STATUS_CODES:Wi}=gg,O=new Map,Ig="delete",ts="insert",_r="read",Ps="update",Ji="describe",hg=Zi.describeSchema.name,fg=Zi.describeTable.name,Cg={delete:!0,deleteRecord:!0,update:!0,updateData:!0,dropAttribute:!0,dropTable:!0,dropSchema:!0,upsert:!0,upsertData:!0},hK="catchup",fK="handleGetJob",TK="handleGetJobsByStartDate",h_={CSV_DATA_LOAD:"csvDataLoad",CSV_URL_LOAD:"csvURLLoad",CSV_FILE_LOAD:"csvFileLoad",IMPORT_FROM_S3:"importFromS3"},mK=[Bt.createTable.name,Bt.createAttribute.name,Bt.dropTable.name,Bt.dropAttribute.name],bg={EXPORT_TO_S3:"export_to_s3",EXPORT_LOCAL:"export_local"},p=class{constructor(t,r){this.requires_su=t,this.perms=r}};a(p,"permission");O.set(dd.insert.name,new p(!1,[ts]));O.set(dd.update.name,new p(!1,[Ps]));O.set(dd.upsert.name,new p(!1,[ts,Ps]));O.set(d_.searchByConditions.name,new p(!1,[_r]));O.set(d_.searchByHash.name,new p(!1,[_r]));O.set(d_.searchByValue.name,new p(!1,[_r]));O.set(d_.search.name,new p(!1,[_r]));O.set(Bt.createSchema.name,new p(!0,[]));O.set(Bt.createTable.name,new p(!0,[]));O.set(Bt.createAttribute.name,new p(!1,[ts]));O.set(Bt.dropSchema.name,new p(!0,[]));O.set(Bt.dropTable.name,new p(!0,[]));O.set(Bt.dropAttribute.name,new p(!0,[]));O.set(Zi.describeSchema.name,new p(!1,[_r]));O.set(Zi.describeTable.name,new p(!1,[_r]));O.set(Sd.deleteRecord.name,new p(!1,[Ig]));O.set(Xi.addUser.name,new p(!0,[]));O.set(Xi.alterUser.name,new p(!0,[]));O.set(Xi.dropUser.name,new p(!0,[]));O.set(Xi.listUsersExternal.name,new p(!0,[]));O.set(S_.listRoles.name,new p(!0,[]));O.set(S_.addRole.name,new p(!0,[]));O.set(S_.alterRole.name,new p(!0,[]));O.set(S_.dropRole.name,new p(!0,[]));O.set(aK.name,new p(!0,[]));O.set(oK.name,new p(!0,[]));O.set(cK.name,new p(!0,[]));O.set(_K.name,new p(!0,[]));O.set(uK.name,new p(!0,[]));O.set(hd.setRoutes.name,new p(!0,[]));O.set(hd.getRoutes.name,new p(!0,[]));O.set(hd.deleteRoutes.name,new p(!0,[]));O.set(Ag.setConfiguration.name,new p(!0,[]));O.set(lK.clusterStatus.name,new p(!0,[]));O.set(fd.getFingerprint.name,new p(!0,[]));O.set(fd.setLicense.name,new p(!0,[]));O.set(Sd.deleteFilesBefore.name,new p(!0,[]));O.set(Sd.deleteAuditLogsBefore.name,new p(!0,[]));O.set(Tg.restartProcesses.name,new p(!0,[]));O.set(Tg.restartService.name,new p(!0,[]));O.set(iK.name,new p(!0,[]));O.set(dK.systemInformation.name,new p(!0,[]));O.set(Ag.getConfiguration.name,new p(!0,[]));O.set(Og.readTransactionLog.name,new p(!0,[]));O.set(Og.deleteTransactionLogsBefore.name,new p(!0,[]));O.set(pg.installModules.name,new p(!0,[]));O.set(pg.auditModules.name,new p(!0,[]));O.set(Rg.createTokens.name,new p(!1,[]));O.set(Rg.refreshOperationToken.name,new p(!1,[]));O.set(br.customFunctionsStatus.name,new p(!0,[]));O.set(br.getCustomFunctions.name,new p(!0,[]));O.set(br.getCustomFunction.name,new p(!0,[]));O.set(br.setCustomFunction.name,new p(!0,[]));O.set(br.dropCustomFunction.name,new p(!0,[]));O.set(br.addCustomFunctionProject.name,new p(!0,[]));O.set(br.dropCustomFunctionProject.name,new p(!0,[]));O.set(br.packageCustomFunctionProject.name,new p(!0,[]));O.set(br.deployCustomFunctionProject.name,new p(!0,[]));O.set(fd.getRegistrationInfo.name,new p(!1,[]));O.set(Xi.userInfo.name,new p(!1,[]));O.set(Zi.describeAll.name,new p(!1,[]));O.set(fK,new p(!1,[]));O.set(TK,new p(!0,[]));O.set(hK,new p(!0,[]));O.set(h_.CSV_DATA_LOAD,new p(!1,[ts,Ps]));O.set(h_.CSV_URL_LOAD,new p(!1,[ts,Ps]));O.set(h_.CSV_FILE_LOAD,new p(!1,[ts,Ps]));O.set(h_.IMPORT_FROM_S3,new p(!1,[ts,Ps]));O.set(bg.EXPORT_TO_S3,new p(!1,[_r]));O.set(bg.EXPORT_LOCAL,new p(!1,[_r]));O.set(Pt.VALID_SQL_OPS_ENUM.DELETE,new p(!1,[Ig]));O.set(Pt.VALID_SQL_OPS_ENUM.SELECT,new p(!1,[_r]));O.set(Pt.VALID_SQL_OPS_ENUM.INSERT,new p(!1,[ts]));O.set(Pt.VALID_SQL_OPS_ENUM.UPDATE,new p(!1,[Ps]));Lg.exports={verifyPerms:AK,verifyPermsAst:RK,verifyBulkLoadAttributePerms:pK};function RK(e,t,r){if(Cr.isEmptyOrZeroLength(e))throw pe.info("verify_perms_ast has an empty user parameter"),Et(new Error);if(Cr.isEmptyOrZeroLength(t))throw pe.info("verify_perms_ast has an empty user parameter"),Et(new Error);if(Cr.isEmptyOrZeroLength(r))throw pe.info("verify_perms_ast has a null operation parameter"),Et(new Error);try{let s=new Ng,n=new EK(e),i=n.getSchemas(),o=new Map;if((!i||i.length===0)&&n.affected_attributes&&n.affected_attributes.size>0)throw pe.info("No schemas defined in verifyPermsAst(), will not continue."),Et(new Error);let c=!!t.role.permission.super_user,_=i.includes("system");if(_&&Cg[r])throw Et(new Error,qe.DROP_SYSTEM,Wi.FORBIDDEN);if(c&&!_)return null;let u=mg.getRolePermissions(t.role);t.role.permission=u,!c&&e instanceof SK.yy.Select&&(e=n.updateAttributeWildcardsForRolePerms(u));for(let E=0;E<i.length;E++){let d=n.getTablesBySchemaName(i[E]);d&&o.set(i[E],d)}let l=wg(t,r,o,s);return l||(o.forEach((E,d)=>{for(let S=0;S<E.length;S++){let m=n.getAttributesBySchemaTableName(d,E[S]),R=md(t.role.permission,d,E[S]);Td(m,R,r,E[S],d,s)}}),s.getPermsResponse())}catch(s){throw Et(s)}}a(RK,"verifyPermsAst");function AK(e,t){if(e===null||t===null||e.hdb_user===void 0||e.hdb_user===null)throw pe.info("null required parameter in verifyPerms"),Et(new Error,qe.DEFAULT_INVALID_REQUEST,Wi.BAD_REQUEST);let r;t instanceof Function?r=t.name:r=t;let s=e.action,n=e.schema,i=e.table,o=new Map;n&&i&&o.set(n,[i]);let c=new Ng;if(Cr.isEmptyOrZeroLength(e.hdb_user.role)||Cr.isEmptyOrZeroLength(e.hdb_user.role.permission))return pe.info(`User ${e.hdb_user.username} has no role or permissions.  Please assign the user a valid role.`),c.handleUnauthorizedItem(qe.USER_HAS_NO_PERMS(e.hdb_user.username));let _=!!e.hdb_user.role.permission.super_user,u=e.hdb_user.role.permission.structure_user,l=o.has(Pt.SYSTEM_SCHEMA_NAME)||n===Pt.SYSTEM_SCHEMA_NAME;if(l&&Cg[r])throw Et(new Error,qe.DROP_SYSTEM,Wi.FORBIDDEN);if(_&&!l||u===!0&&(r===Bt.createSchema.name||r===Bt.dropSchema.name))return null;if(mK.indexOf(r)>=0&&(u===!0||Array.isArray(u)))return u===!0||u.indexOf(n)>=0?null:c.handleUnauthorizedItem(`User does not have access to perform '${e.operation}' against schema '${n}'`);let E=mg.getRolePermissions(e.hdb_user.role);if(e.hdb_user.role.permission=E,r===hg||r===fg){if(n===Pt.SYSTEM_SCHEMA_NAME)return c.handleUnauthorizedItem(qe.SCHEMA_PERM_ERROR(n));if(!E.super_user){if(r===hg&&(!E[n]||!E[n][Ji]))return c.handleInvalidItem(qe.SCHEMA_NOT_FOUND(n));if(r===fg&&(!E[n]||!E[n].tables[i]||!E[n].tables[i][Ji]))return c.handleInvalidItem(qe.TABLE_NOT_FOUND(n,i))}}let d=wg(e.hdb_user,r,o,c,s);if(d)return d;if(O.get(r)&&O.get(r).perms.length===0)return null;if(!_&&e.get_attributes&&Pt.SEARCH_WILDCARDS.includes(e.get_attributes[0])){let R=[],w=E[n].tables[i];w[Pt.PERMS_CRUD_ENUM.READ]&&(w.attribute_permissions.length>0?w.attribute_permissions.filter(B=>B[Pt.PERMS_CRUD_ENUM.READ]).forEach(B=>{R.push(B.attribute_name)}):R=global.hdb_schema[n][i].attributes.map(L=>L.attribute),e.get_attributes=R)}let S=OK(e),m=md(e.hdb_user.role.permission,n,i);return Td(S,m,r,i,n,c,s),c.getPermsResponse()}a(AK,"verifyPerms");function wg(e,t,r,s,n){if(Cr.arrayHasEmptyValues([e,t,r]))throw pe.info("hasPermissions has an invalid parameter"),Et(new Error);let i=r.has("system"),o=e.role.permission;if(o.super_user&&!i)return null;if(!O.get(t))throw pe.info(`operation ${t} not found.`),Et(new Error,qe.OP_NOT_FOUND(t),Wi.BAD_REQUEST);if(O.get(t)&&O.get(t).requires_su)return pe.info(`operation ${t} requires SU permissions.`),s.handleUnauthorizedItem(qe.OP_IS_SU_ONLY(t));let c=r.keys();for(let _ of c){try{if(_&&!o[_]||o[_][Ji]===!1){s.addInvalidItem(qe.SCHEMA_NOT_FOUND(_));continue}}catch{s.addInvalidItem(qe.SCHEMA_NOT_FOUND(_));continue}let u=r.get(_);for(let l of u){let E=o[_].tables[l];if(!E||E[Ji]===!1)s.addInvalidItem(qe.TABLE_NOT_FOUND(_,l));else try{let d=[],S=O.get(t).perms;!Cr.isEmpty(n)&&S.includes(n)&&(S=[n]);for(let m=0;m<S.length;m++){let R=S[m],w=E[R];(w==null||w===!1)&&(pe.info(`Required ${R} permission not found for ${t} ${n?`${n} `:""}operation in role ${e.role.id}`),d.push(R))}d.length>0&&s.addUnauthorizedTable(_,l,d)}catch(d){let S=qe.UNKNOWN_OP_AUTH_ERROR(t,_,l);throw pe.error(S),pe.error(d),Et(gg.CHECK_LOGS_WRAPPER(S))}}}return r.size<2?s.getPermsResponse():null}a(wg,"hasPermissions");function Td(e,t,r,s,n,i,o){if(!e||!t)throw pe.info("no attributes specified in checkAttributePerms."),Et(new Error);let c=O.get(r).perms;if(!c||c==="")throw pe.info(`no permissions found for ${r} in checkAttributePerms().`),Et(new Error);if(Cr.isEmptyOrZeroLength(t))return pe.info("No role permissions set (this is OK)."),null;o&&c.includes(o)&&(c=[o]);let _={};for(let l of e){let E=t.get(l);if(E){if(E[Ji]===!1){i.addInvalidItem(qe.ATTR_NOT_FOUND(n,s,l),n,s);continue}if(c)for(let d of c){if(Pt.TIME_STAMP_NAMES.includes(E.attribute_name)&&d!==_r)throw Et(new Error,qe.SYSTEM_TIMESTAMP_PERMS_ERR,Wi.FORBIDDEN);E[d]===!1&&(_[E.attribute_name]?_[E.attribute_name].push(d):_[E.attribute_name]=[d])}}else i.addInvalidItem(qe.ATTR_NOT_FOUND(n,s,l),n,s)}let u=Object.keys(_);u.length>0&&i.addUnauthorizedAttributes(u,n,s,_)}a(Td,"checkAttributePerms");function OK(e){let t=new Set;try{if(e.action)return t;if(e.operation===Pt.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS&&e.conditions.forEach(r=>{t.add(r.search_attribute)}),e&&e.search_attribute&&t.add(e.search_attribute),!e.records||e.records.length===0){if(!e.get_attributes||!e.get_attributes.length===0)return t;for(let r=0;r<e.get_attributes.length;r++)t.add(e.get_attributes[r])}else for(let r=0;r<e.records.length;r++){let s=Object.keys(e.records[r]);for(let n=0;n<s.length;n++)t.add(s[n])}}catch(r){pe.info(r)}return t}a(OK,"getRecordAttributes");function md(e,t,r){let s=new Map;if(Cr.isEmpty(e))return pe.info("no hdb_user specified in getAttributePermissions"),s;if(e.super_user||!t||!r)return s;try{e[t].tables[r].attribute_permissions.forEach(n=>{s.has(n.attribute_name)||s.set(n.attribute_name,n)})}catch{pe.info(`No attribute permissions found for schema ${t} and table ${r}.`)}return s}a(md,"getAttributePermissions");function pK(e,t,r,s,n,i,o){let c=new Set(i),_=md(e,s,n);Td(c,_,t,n,s,o,r)}a(pK,"verifyBulkLoadAttributePerms")});var m_=h((i3,Pg)=>{"use strict";Pg.exports={evaluateSQL:HK,processAST:Mg,convertSQLToAST:Dg,checkASTPermissions:yg};var Ug=Ut(),Od=require("util"),NK=Od.callbackify(Ug.insert),gK=Tt().search,IK=BO().update,CK=Od.callbackify(IK),bK=HO().convertDelete,rs=require("alasql"),wK=f_(),ji=I(),LK=Lo(),UK=C(),zi=T(),{hdb_errors:yK,handleHDBError:Rd}=D(),{HTTP_STATUS_CODES:Ad}=yK,DK=bn();function MK(e,t,r){return Promise.all([DK.postOperationHandler(e,t,r),Ug.flush(e)])}a(MK,"postWrite");var PK=Od.callbackify(MK);LK(rs);var BK=403,vK="There was a problem performing this insert. Please check the logs and try again.",T_=class{constructor(){this.ast=void 0,this.variant=void 0,this.permissions_checked=!1}};a(T_,"ParsedSQLObject");function HK(e,t){let r=e.parsed_sql_object;if(!r){r=Dg(e.sql);let s,n=r.ast.statements[0];if(n instanceof rs.yy.Insert?s=n.into.databaseid:n instanceof rs.yy.Select?s=n.from?n.from[0].databaseid:null:n instanceof rs.yy.Update||n instanceof rs.yy.Delete?s=n.table.databaseid:ji.error("AST in evaluateSQL is not a valid SQL type."),!(n instanceof rs.yy.Select)&&UK.isEmptyOrZeroLength(s))return t("No schema specified",null)}Mg(e,r,(s,n)=>{if(s)return t(s);t(null,n)})}a(HK,"evaluateSQL");function yg(e,t){let r;try{r=wK.verifyPermsAst(t.ast.statements[0],e.hdb_user,t.variant),t.permissions_checked=!0}catch(s){throw s}return r||null}a(yg,"checkASTPermissions");function Dg(e){let t=new T_;if(!e)throw Rd(new Error,"The 'sql' parameter is missing from the request body",Ad.BAD_REQUEST);try{let r=e.trim(),s=rs.parse(r),n=r.split(" ")[0].toLowerCase();t.ast=s,t.variant=n}catch(r){let s=r.message.split(`
`);throw s[1]?Rd(r,`Invalid SQL at: ${s[1]}. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.`,Ad.BAD_REQUEST):Rd(r,"We had trouble parsing your request. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.",Ad.BAD_REQUEST)}return t}a(Dg,"convertSQLToAST");function Mg(e,t,r){try{let s=GK;if(!e.bypass_auth&&!t.permissions_checked){let i=yg(e,t);if(i&&i.length>0)return r(BK,i)}let n={statement:t.ast.statements[0],hdb_user:e.hdb_user};switch(t.variant){case zi.VALID_SQL_OPS_ENUM.SELECT:s=gK,n=t.ast.statements[0];break;case zi.VALID_SQL_OPS_ENUM.INSERT:s=qK;break;case zi.VALID_SQL_OPS_ENUM.UPDATE:s=CK;break;case zi.VALID_SQL_OPS_ENUM.DELETE:s=bK;break;default:throw new Error(`unsupported SQL type ${t.variant} in SQL: ${e}`)}s(n,(i,o)=>{if(i){r(i);return}r(null,o)})}catch(s){return r(s)}}a(Mg,"processAST");function GK(e,t){ji.info(e),t("unknown sql statement")}a(GK,"nullFunction");function qK({statement:e,hdb_user:t},r){let s=e.into,n={schema:s.databaseid,table:s.tableid,operation:"insert",hdb_user:t},i=e.columns.map(o=>o.columnid);try{n.records=FK(i,e.values)}catch(o){return r(o)}NK(n,(o,c)=>{if(o)return r(o);PK(n,c,_=>{_&&ji.error(_)});try{delete c.new_attributes,delete c.txn_time}catch(_){ji.error(`Error delete new_attributes from insert response: ${_}`)}r(null,c)})}a(qK,"convertInsert");function FK(e,t){try{return t.map(r=>{if(e.length!==r.length)throw"number of values do not match number of columns in insert";let s={};return r.forEach((n,i)=>{if(n.columnid)throw"cannot use a column in insert value";"value"in n?s[e[i]]=n.value:s[e[i]]=rs.compile(`SELECT ${n.toString()} AS [${zi.FUNC_VAL}] FROM ?`)}),s})}catch(r){throw ji.error(r),new Error(vK)}}a(FK,"createDataObjects")});var Nd=h((a3,qg)=>{var N_=require("clone"),g_=de(),VK=C(),p_=T(),kK=I(),R_=require("fs"),{hdb_errors:xK,handleHDBError:ea}=D(),{HDB_ERROR_MSGS:$K,HTTP_STATUS_CODES:A_}=xK,{common_validators:O_}=Tr(),Bg=1e9,pd=" is required",YK=["insert","update","upsert"],I_={schema:{presence:!0,format:O_.schema_format,length:O_.schema_length},table:{presence:!0,format:O_.schema_format,length:O_.schema_length},action:{inclusion:{within:YK,message:"is required and must be either insert, update, or upsert"}},file_path:{},csv_url:{url:{allowLocal:!0}},data:{}},{AWS_ACCESS_KEY:KK,AWS_SECRET:QK,AWS_BUCKET:WK,AWS_FILE_KEY:JK}=p_.S3_BUCKET_AUTH_KEYS,ZK={s3:{presence:!0},[`s3.${KK}`]:{presence:!0,type:"String"},[`s3.${QK}`]:{presence:!0,type:"String"},[`s3.${WK}`]:{presence:!0,type:"String"},[`s3.${JK}`]:{presence:!0,type:"String",hasValidFileExt:[".csv",".json"]}},vg=N_(I_);vg.data.presence={message:pd};var Hg=N_(I_);Hg.file_path.presence={message:pd};var XK=Object.assign(N_(I_),ZK),Gg=N_(I_);Gg.csv_url.presence={message:pd};function zK(e){let t=g_.validateObject(e,vg);return C_(e,t)}a(zK,"dataObject");function jK(e){let t=g_.validateObject(e,Gg);return C_(e,t)}a(jK,"urlObject");function eQ(e){let t=g_.validateObject(e,Hg);return C_(e,t)}a(eQ,"fileObject");function tQ(e){let t=g_.validateObject(e,XK);return C_(e,t)}a(tQ,"s3FileObject");function C_(e,t){if(!t){let r=VK.checkGlobalSchemaTable(e.schema,e.table);if(r)return ea(new Error,r,A_.BAD_REQUEST);if(e.operation===p_.OPERATIONS_ENUM.CSV_FILE_LOAD){try{R_.accessSync(e.file_path,R_.constants.R_OK|R_.constants.F_OK)}catch(s){return s.code===p_.NODE_ERROR_CODES.ENOENT?ea(s,`No such file or directory ${s.path}`,A_.BAD_REQUEST):s.code===p_.NODE_ERROR_CODES.EACCES?ea(s,`Permission denied ${s.path}`,A_.BAD_REQUEST):ea(s)}try{let s=R_.statSync(e.file_path).size;if(s>Bg)return ea(new Error,$K.MAX_FILE_SIZE_ERR(s,Bg),A_.BAD_REQUEST)}catch(s){kK.error(s),console.error(s)}}}return t}a(C_,"postValidateChecks");qg.exports={dataObject:zK,urlObject:jK,fileObject:eQ,s3FileObject:tQ}});var gd=h((o3,Fg)=>{"use strict";var ta=I(),b_=T();async function rQ(e,t,r,s=[]){if(!e||typeof e!="function")throw new Error("Invalid function parameter");let n;try{return n=await e(t),r&&await r(t,n,s),t.operation===b_.OPERATIONS_ENUM.INSERT||t.operation===b_.OPERATIONS_ENUM.UPDATE||t.operation===b_.OPERATIONS_ENUM.UPSERT?(delete n.new_attributes,delete n.txn_time):t.operation===b_.OPERATIONS_ENUM.DELETE&&delete n.txn_time,n}catch(i){throw i.message&&typeof i.message=="string"&&i.message.includes("already exists")?(ta.info(i.message),i):i.http_resp_msg?(ta.error(`Error calling operation: ${e.name}`),ta.error(i.http_resp_msg),i):(ta.error(`Error calling operation: ${e.name}`),ta.error(i),i)}}a(rQ,"callOperationFunctionAsAwait");Fg.exports={callOperationFunctionAsAwait:rQ}});var Id=h((c3,kg)=>{"use strict";var sQ=require("aws-sdk/clients/s3");kg.exports={getFileStreamFromS3:nQ,getS3AuthObj:Vg};function nQ(e){let{s3:t}=e,r={Bucket:t.bucket,Key:t.key};return Vg(t.aws_access_key_id,t.aws_secret_access_key).getObject(r).createReadStream()}a(nQ,"getFileStreamFromS3");function Vg(e,t){return new sQ({accessKeyId:e,secretAccessKey:t})}a(Vg,"getS3AuthObj")});var $g=h((_3,xg)=>{"use strict";var w_=class{constructor(t,r,s,n,i,o,c=null){this.op=t,this.action=r,this.schema=s,this.table=n,this.file_path=i,this.file_type=o,this.role_perms=c}};a(w_,"BulkLoadFileObject");var L_=class{constructor(t,r,s,n){this.action=t,this.schema=r,this.table=s,this.data=n}};a(L_,"BulkLoadDataObject");xg.exports={BulkLoadFileObject:w_,BulkLoadDataObject:L_}});var Ud=h((u3,oI)=>{"use strict";var U_=Ut(),M_=Nd(),iQ=require("needle"),pt=T(),aQ=he(),ra=C(),{handleHDBError:ae,hdb_errors:jg}=D(),{HTTP_STATUS_CODES:Fe,HDB_ERROR_MSGS:Ne,CHECK_LOGS_WRAPPER:Hs}=jg,vs=I(),y_=require("papaparse");ra.promisifyPapaParse();var Jt=require("fs-extra"),oQ=require("path"),{chain:Yg}=require("stream-chain"),Kg=require("stream-json/streamers/StreamArray"),Qg=require("stream-json/utils/Batch"),Wg=require("stream-chain/utils/comp"),{finished:Jg}=require("stream"),Cd=Y(),cQ=bn(),eI=gd(),_Q=Id(),{BulkLoadFileObject:bd,BulkLoadDataObject:uQ}=$g(),wd=Ed(),{verifyBulkLoadAttributePerms:tI}=f_(),lQ=SE(),EQ=Rt(),dQ=Fr(),Zg="No records parsed from csv file.",Bs=`${Cd.get("HDB_ROOT")}/tmp`,{schema_regex:SQ}=Tr(),Xg=1024*1024*5,zg=5e3,hQ={"text/csv":!0,"application/octet-stream":!0,"text/plain":!0,"application/vnd.ms-excel":!0};oI.exports={csvDataLoad:fQ,csvURLLoad:TQ,csvFileLoad:mQ,importFromS3:RQ};async function fQ(e,t=[]){let r=M_.dataObject(e);if(r)throw ae(r,r.message,Fe.BAD_REQUEST,void 0,void 0,!0);let s={};try{let n=y_.parse(e.data,{header:!0,skipEmptyLines:!0,dynamicTyping:!0}),i=new wd;e.hdb_user&&e.hdb_user.role&&e.hdb_user.role.permission&&e.hdb_user.role.permission.super_user!==!0&&tI(e.hdb_user.role.permission,this.job_operation_function.name,e.action,e.schema,e.table,n.meta.fields,i);let o=i.getPermsResponse();if(o)throw ae(new Error,o,Fe.BAD_REQUEST,void 0,void 0,!0);let c=new uQ(e.action,e.schema,e.table,n.data);return s=await eI.callOperationFunctionAsAwait(nI,c,iI.bind(null,n.meta.fields),t),s.message===Zg?Zg:aI(s.records,s.number_written)}catch(n){throw Gs(n)}}a(fQ,"csvDataLoad");async function TQ(e){let t=M_.urlObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r=`${Date.now()}.csv`,s=`${Bs}/${r}`;try{await AQ(e.csv_url,r)}catch(n){throw vs.error(Ne.DOWNLOAD_FILE_ERR(r)+" - "+n),ae(n,Hs(Ne.DOWNLOAD_FILE_ERR(r)))}try{let n=new bd(this.job_operation_function.name,e.action,e.schema,e.table,s,pt.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission),i=await Ld(n);return await D_(s),i}catch(n){throw await D_(s),Gs(n)}}a(TQ,"csvURLLoad");async function mQ(e){let t=M_.fileObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r=new bd(this.job_operation_function.name,e.action,e.schema,e.table,e.file_path,pt.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission);try{return await Ld(r)}catch(s){throw Gs(s)}}a(mQ,"csvFileLoad");async function RQ(e){let t=M_.s3FileObject(e);if(t)throw ae(t,t.message,Fe.BAD_REQUEST,void 0,void 0,!0);let r;try{let s=oQ.extname(e.s3.key),n=`${Date.now()}${s}`;r=`${Bs}/${n}`;let i=new bd(this.job_operation_function.name,e.action,e.schema,e.table,r,s,e.hdb_user.role.permission);await OQ(n,e);let o=await Ld(i);return await D_(r),o}catch(s){throw await D_(r),Gs(s)}}a(RQ,"importFromS3");async function AQ(e,t){let r;try{r=await iQ("get",e)}catch(s){let n=`Error downloading CSV file from ${e}, status code: ${s.statusCode}. Check the log for more information.`;throw ae(s,n,s.statusCode,pt.LOG_LEVELS.ERROR,"Error downloading CSV file - "+s)}NQ(r,e),await pQ(t,r.raw)}a(AQ,"downloadCSVFile");async function OQ(e,t){try{let r=`${Bs}/${e}`;await Jt.mkdirp(Bs),await Jt.writeFile(`${Bs}/${e}`,"",{flag:"a+"});let s=await Jt.createWriteStream(r),n=_Q.getFileStreamFromS3(t);await new Promise((i,o)=>{n.on("error",function(c){o(c)}),n.pipe(s).on("error",function(c){o(c)}).on("close",function(){vs.info(`${t.s3.key} successfully downloaded to ${r}`),i()})})}catch(r){throw vs.error(Ne.S3_DOWNLOAD_ERR+" - "+r),ae(r,Hs(Ne.S3_DOWNLOAD_ERR))}}a(OQ,"downloadFileFromS3");async function pQ(e,t){try{await Jt.mkdirp(Bs),await Jt.writeFile(`${Bs}/${e}`,t)}catch(r){throw vs.error(Ne.WRITE_TEMP_FILE_ERR),ae(r,Hs(Ne.DEFAULT_BULK_LOAD_ERR))}}a(pQ,"writeFileToTempFolder");async function D_(e){if(e)try{await Jt.access(e),await Jt.unlink(e)}catch{vs.warn(`could not delete temp csv file at ${e}, file does not exist`)}}a(D_,"deleteTempFile");function NQ(e,t){if(e.statusCode!==jg.HTTP_STATUS_CODES.OK)throw ae(new Error,`CSV Load failed from URL: ${t}, status code: ${e.statusCode}, message: ${e.statusMessage}`,Fe.BAD_REQUEST);if(!hQ[e.headers["content-type"]])throw ae(new Error,`CSV Load failed from URL: ${t}, unsupported content type: ${e.headers["content-type"]}`,Fe.BAD_REQUEST);if(!e.raw)throw ae(new Error,`CSV Load failed from URL: ${t}, no csv found at url`,Fe.BAD_REQUEST)}a(NQ,"validateURLResponse");async function Ld(e){try{let t;switch(e.file_type){case pt.VALID_S3_FILE_TYPES.CSV:t=await gQ(e);break;case pt.VALID_S3_FILE_TYPES.JSON:t=await IQ(e);break;default:throw ae(new Error,Ne.DEFAULT_BULK_LOAD_ERR,Fe.BAD_REQUEST,pt.LOG_LEVELS.ERROR,Ne.INVALID_FILE_EXT_ERR(e))}return aI(t.records,t.number_written)}catch(t){throw Gs(t)}}a(Ld,"fileLoad");async function rI(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;n&&n.pause();let o={operation:e.action,schema:e.schema,table:e.table,records:i};try{let{attributes:c}=await U_.validation(o);e.role_perms&&e.role_perms.super_user!==!0&&tI(e.role_perms,e.op,e.action,e.schema,e.table,c,t),n&&n.resume()}catch(c){let _=ae(c);r(_)}}a(rI,"validateChunk");async function sI(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;ra.autoCastJSONDeep(i),n&&n.pause();let o=s.meta?s.meta.fields:null;if(o)i.forEach(c=>{!ra.isEmpty(c)&&!ra.isEmpty(c.__parsed_extra)&&delete c.__parsed_extra});else{let c=new Set;i.forEach(_=>{Object.keys(_).forEach(u=>c.add(u))}),o=[...c]}try{let c={schema:e.schema,table:e.table,action:e.action,data:i},_=await eI.callOperationFunctionAsAwait(nI,c,iI.bind(null,o));t.records+=_.records,t.number_written+=_.number_written,n&&n.resume()}catch(c){let _=ae(c,Hs(Ne.INSERT_CSV_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.INSERT_CSV_ERR+" - "+c);r(_)}}a(sI,"insertChunk");async function gQ(e){let t={records:0,number_written:0};try{let r=new wd,s=Jt.createReadStream(e.file_path,{highWaterMark:Xg});s.setEncoding("utf8"),await y_.parsePromise(s,rI.bind(null,e,r));let n=r.getPermsResponse();if(n)throw ae(new Error,n,Fe.BAD_REQUEST);return s=Jt.createReadStream(e.file_path,{highWaterMark:Xg}),s.setEncoding("utf8"),await y_.parsePromise(s,sI.bind(null,e,t)),s.destroy(),t}catch(r){throw ae(r,Hs(Ne.PAPA_PARSE_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.PAPA_PARSE_ERR+r)}}a(gQ,"callPapaParse");async function IQ(e){let t={records:0,number_written:0},r=a(s=>{throw s},"throwErr");try{let s=new wd,n=Yg([Jt.createReadStream(e.file_path,{encoding:"utf-8"}),Kg.withParser(),c=>c.value,new Qg({batchSize:zg}),Wg(async c=>{await rI(e,s,r,c)})]);await new Promise((c,_)=>{Jg(n,u=>{u?_(u):c()}),n.resume()});let i=s.getPermsResponse();if(i)throw ae(new Error,i,Fe.BAD_REQUEST);let o=Yg([Jt.createReadStream(e.file_path,{encoding:"utf-8"}),Kg.withParser(),c=>c.value,new Qg({batchSize:zg}),Wg(async c=>{await sI(e,t,r,c)})]);return await new Promise((c,_)=>{Jg(o,u=>{u?_(u):c()}),o.resume()}),t}catch(s){throw ae(s,Hs(Ne.INSERT_JSON_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.INSERT_JSON_ERR+s)}}a(IQ,"insertJson");async function nI(e){let t={};try{e.data&&e.data.length>0&&CQ(e.data[0])?t=await bQ(e.data,e.schema,e.table,e.action):(t.message="No records parsed from csv file.",vs.info(t.message))}catch(r){throw Gs(r)}return t}a(nI,"callBulkFileLoad");function CQ(e){let t=Object.keys(e);for(let r of t)if(!SQ.test(r))throw new Error(`Invalid column name '${r}', cancelling load operation`);return!0}a(CQ,"validateColumnNames");async function bQ(e,t,r,s){s||(s="insert");let n={operation:s,schema:t,table:r,records:e},i;switch(s){case"insert":i=U_.insert;break;case"update":i=U_.update;break;case"upsert":i=U_.upsert;break;default:throw ae(new Error,Ne.INVALID_ACTION_PARAM_ERR(s),Fe.BAD_REQUEST,pt.LOG_LEVELS.ERROR,Ne.INVALID_ACTION_PARAM_ERR(s))}try{let o=await i(n),c;switch(s){case"insert":c=o.inserted_hashes;break;case"update":c=o.update_hashes;break;case"upsert":c=o.upserted_hashes;break;default:break}if(Array.isArray(o.skipped_hashes)&&o.skipped_hashes.length>0){let l=global.hdb_schema[t][r].hash_attribute,E=e.length;for(;E--;)o.skipped_hashes.indexOf(e[E][l])>=0&&e.splice(E,1)}let _=ra.isEmptyOrZeroLength(c)?0:c.length;return{records:e.length,number_written:_,new_attributes:o.new_attributes}}catch(o){throw Gs(o)}}a(bQ,"bulkFileLoad");async function iI(e,t,r,s=[]){try{if(t.data.length===0||!Cd.get(pt.CONFIG_PARAMS.CLUSTERING_ENABLED))return;let n=y_.unparse(t.data,{header:!0,skipEmptyLines:!0,columns:e}),i;t.hdb_user&&t.hdb_user.username&&(i=t.hdb_user.username);let o={operation:"csv_data_load",action:t.action?t.action:"insert",schema:t.schema,table:t.table,data:n,__origin:new lQ(r.txn_time,i,Cd.get(pt.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY))};await EQ.publishToStream(`${aQ.SUBJECT_PREFIXES.TXN}.${t.schema}.${t.table}`,dQ.createNatsTableStreamName(t.schema,t.table),[o],s),await cQ.sendAttributeTransaction(r,t,s),delete r.new_attributes}catch(n){vs.error(n)}}a(iI,"postCSVLoadFunction");function aI(e,t){return`successfully loaded ${t} of ${e} records`}a(aI,"buildResponseMsg");function Gs(e){return ae(e,Hs(Ne.DEFAULT_BULK_LOAD_ERR),Fe.INTERNAL_SERVER_ERROR,pt.LOG_LEVELS.ERROR,Ne.DEFAULT_BULK_LOAD_ERR+" - "+e)}a(Gs,"buildTopLevelErrMsg")});var Dd=h((l3,hI)=>{"use strict";var uI=Tt(),wQ=m_(),LQ=Id(),{AsyncParser:UQ,Transform:yQ}=require("json2csv"),sa=require("stream"),DQ=require("events"),vt=C(),yd=require("fs-extra"),MQ=require("path"),et=I(),{promisify:P_}=require("util"),na=C(),{handleHDBError:ge,hdb_errors:PQ}=D(),{HDB_ERROR_MSGS:Nt,HTTP_STATUS_CODES:Ie}=PQ,cI=["search_by_value","search_by_hash","sql"],_I=["json","csv"],lI="json",EI="csv",BQ="Successfully exported JSON locally.",vQ="Successfully exported CSV locally.",HQ=1e3,GQ=1e3,qQ=P_(uI.searchByHash),FQ=P_(uI.searchByValue),VQ=P_(wQ.evaluateSQL),kQ=P_(sa.finished);hI.exports={export_to_s3:KQ,export_local:xQ};async function xQ(e){et.trace(`export_local request to path: ${e.path}, filename: ${e.filename}, format: ${e.format}`);let t=dI(e);if(!vt.isEmpty(t))throw et.error(t),ge(new Error,t,Ie.BAD_REQUEST,void 0,void 0,!0);if(vt.isEmpty(e.path))throw et.error(Nt.MISSING_VALUE("path")),ge(new Error,Nt.MISSING_VALUE("path"),Ie.BAD_REQUEST,void 0,void 0,!0);let r=(vt.isEmpty(e.filename)?new Date().getTime():e.filename)+"."+e.format;e.path.endsWith(MQ.sep)&&(e.path=e.path.substring(0,e.path.length-1));let s=vt.buildFolderPath(e.path,r);try{await $Q(e.path);let n=await SI(e);return await YQ(s,e.format,n)}catch(n){throw et.error(n),new Error(n)}}a(xQ,"export_local");async function $Q(e){if(et.trace("in confirmPath"),vt.isEmptyOrZeroLength(e))throw ge(new Error,`Invalid path: ${e}`,Ie.BAD_REQUEST,void 0,void 0,!0);let t;try{t=await yd.stat(e)}catch(r){let s;throw r.code==="ENOENT"?s=`path '${e}' does not exist`:r.code==="EACCES"?s=`access to path '${e}' is denied`:s=r.message,et.error(s),ge(new Error,s,Ie.BAD_REQUEST,void 0,void 0,!0)}if(!t.isDirectory()){let r=`path '${e}' is not a directory, please supply a valid folder path`;throw et.error(r),ge(new Error,r,Ie.BAD_REQUEST,void 0,void 0,!0)}return!0}a($Q,"confirmPath");async function YQ(e,t,r){if(et.trace("in saveToLocal"),na.isEmptyOrZeroLength(e))throw ge(new Error,Nt.INVALID_VALUE("file_path"),Ie.BAD_REQUEST,void 0,void 0,!0);if(na.isEmptyOrZeroLength(t))throw ge(new Error,Nt.INVALID_VALUE("Source format"),Ie.BAD_REQUEST,void 0,void 0,!0);if(na.isEmpty(r))throw ge(new Error,Nt.NOT_FOUND("Data"),Ie.BAD_REQUEST,void 0,void 0,!0);if(t===lI){let s=yd.createWriteStream(e),n=r.length;s.write("[");let i="";for await(let[o,c]of r.entries())i+=o===n-1?JSON.stringify(c):JSON.stringify(c)+",",o!==0&&o%GQ===0&&(s.write(i)||await DQ.once(s,"drain"),i="");return i.length!==0&&s.write(i),s.write("]"),s.end(),await kQ(s),BQ}else if(t===EI){let s=yd.createWriteStream(e),n=sa.Readable.from(r),i={},o={objectMode:!0};return await new UQ(i,o).fromInput(n).toOutput(s).promise(!1),vQ}throw ge(new Error,Nt.INVALID_VALUE("format"),Ie.BAD_REQUEST)}a(YQ,"saveToLocal");async function KQ(e){if(!e.s3||Object.keys(e.s3).length===0)throw ge(new Error,Nt.MISSING_VALUE("S3 object"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.aws_access_key_id))throw ge(new Error,Nt.MISSING_VALUE("aws_access_key_id"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.aws_secret_access_key))throw ge(new Error,Nt.MISSING_VALUE("aws_secret_access_key"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.bucket))throw ge(new Error,Nt.MISSING_VALUE("bucket"),Ie.BAD_REQUEST);if(vt.isEmptyOrZeroLength(e.s3.key))throw ge(new Error,Nt.MISSING_VALUE("key"),Ie.BAD_REQUEST);let t=dI(e);if(!vt.isEmpty(t))throw ge(new Error,t,Ie.BAD_REQUEST);et.trace(`called export_to_s3 to bucket: ${e.s3.bucket} and query ${e.search_operation.sql}`);let r;try{r=await SI(e)}catch(c){throw et.error(c),c}let s,n=LQ.getS3AuthObj(e.s3.aws_access_key_id,e.s3.aws_secret_access_key),i,o=new sa.PassThrough;if(e.format===EI){i=e.s3.key+".csv";let c=sa.Readable.from(r),_={},u={objectMode:!0},l=new yQ(_,u);l.on("error",E=>{throw E}),c.pipe(l).pipe(o)}else if(e.format===lI){i=e.s3.key+".json";let c=new sa.Readable;c.pipe(o),c.on("error",l=>{throw l}),c.push("[");let _=r.length,u="";for(let[l,E]of r.entries())u+=l===_-1?JSON.stringify(E):JSON.stringify(E)+",",l!==0&&l%HQ===0&&(c.push(u),u="");u.length!==0&&c.push(u),c.push("]"),c.push(null)}else throw ge(new Error,Nt.INVALID_VALUE("format"),Ie.BAD_REQUEST);try{s=await n.upload({Bucket:e.s3.bucket,Key:i,Body:o}).promise()}catch(c){throw et.error(c),c}return s}a(KQ,"export_to_s3");function dI(e){if(et.trace("in exportCoreValidation"),vt.isEmpty(e.format))return"format missing";if(_I.indexOf(e.format)<0)return`format invalid. must be one of the following values: ${_I.join(", ")}`;let t=e.search_operation.operation;if(vt.isEmpty(t))return"search_operation.operation missing";if(cI.indexOf(t)<0)return`search_operation.operation must be one of the following values: ${cI.join(", ")}`}a(dI,"exportCoreValidation");async function SI(e){et.trace("in getRecords");let t,r;if(na.isEmpty(e.search_operation)||na.isEmptyOrZeroLength(e.search_operation.operation))throw ge(new Error,Nt.INVALID_VALUE("Search operation"),Ie.BAD_REQUEST);switch(e.search_operation.operation){case"search_by_value":t=FQ;break;case"search_by_hash":t=qQ;break;case"sql":t=VQ;break;default:throw r=`Operation ${e.search_operation.operation} is not support by export.`,et.error(r),ge(new Error,r,Ie.BAD_REQUEST)}e.search_operation.hdb_user=e.hdb_user;try{return t(e.search_operation)}catch(s){throw et.error(s),s}}a(SI,"getRecords")});var TI=h((E3,fI)=>{"use strict";var B_=class{constructor(t,r){this.operation="sql",this.sql=t,this.hdb_user=r}};a(B_,"SqlSearchObject");fI.exports=B_});var AI=h((d3,RI)=>{"use strict";var QQ=T(),mI=require("moment"),WQ=require("uuid").v4,v_=class{constructor(){this.id=WQ(),this.type=void 0,this.start_datetime=mI().valueOf(),this.created_datetime=mI().valueOf(),this.end_datetime=void 0,this.status=QQ.JOB_STATUS_ENUM.CREATED,this.message=void 0,this.user=void 0,this.request=void 0}};a(v_,"JobObject");RI.exports=v_});var G_=h((S3,CI)=>{"use strict";var JQ=require("uuid").v4,NI=Ut(),gI=Tt(),ZQ=Kt(),XQ=Es(),zQ=TI(),oe=T(),jQ=AI(),eW=Wl(),Ht=I(),tW=ei(),Fn=C(),{promisify:Md}=require("util"),qs=require("moment"),rW=m_(),H_=Nd(),OI=ml(),{deleteTransactionLogsBeforeValidator:sW}=cd(),{handleHDBError:nW,hdb_errors:iW}=D(),{HTTP_STATUS_CODES:aW}=iW,pI=Md(gI.searchByValue),oW=Md(gI.searchByHash),cW=NI.insert,_W=Md(rW.evaluateSQL),uW=NI.update;CI.exports={addJob:dW,updateJob:hW,handleGetJob:lW,handleGetJobsByStartDate:EW,getJobById:II};async function lW(e){try{let t=await II(e.id);return Fn.isEmptyOrZeroLength(t)||(t[0].request!==void 0&&delete t[0].request,delete t[0].__createdtime__,delete t[0].__updatedtime__),t}catch(t){let r=`There was an error getting job: ${t}`;throw Ht.error(r),new Error(r)}}a(lW,"handleGetJob");async function EW(e){try{let t=await SW(e);if(Ht.trace(`Searching for jobs from ${e.from_date} to ${e.to_date}`),t&&t.length>0)for(let r of t)r.start_datetime&&(r.start_datetime_converted=qs(r.start_datetime)),r.end_datetime&&(r.end_datetime_converted=qs(r.end_datetime)),r.request!==void 0&&delete r.request,delete r.__createdtime__,delete r.__updatedtime__;return t}catch(t){let r=`There was an error searching jobs by date: ${t}`;throw Ht.error(r),new Error(r)}}a(EW,"handleGetJobsByStartDate");async function dW(e){let t={message:"",error:"",success:!1,createdJob:void 0};if(!e||Object.keys(e).length===0||Fn.isEmptyOrZeroLength(e.operation)){let l="job parameter is invalid";return Ht.info(l),t.error=l,t}if(!oe.JOB_TYPE_ENUM[e.operation])return Ht.info(`invalid job type specified: ${e.operation}.`),t;let r=e.operation,s;switch(r){case oe.OPERATIONS_ENUM.CSV_FILE_LOAD:s=H_.fileObject(e);break;case oe.OPERATIONS_ENUM.CSV_URL_LOAD:s=H_.urlObject(e);break;case oe.OPERATIONS_ENUM.CSV_DATA_LOAD:s=H_.dataObject(e);break;case oe.OPERATIONS_ENUM.IMPORT_FROM_S3:s=H_.s3FileObject(e);break;case oe.OPERATIONS_ENUM.DELETE_FILES_BEFORE:case oe.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE:s=OI(e,"date");break;case oe.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE:s=OI(e,"timestamp");break;case oe.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE:s=sW(e);break;default:break}if(s)throw nW(s,s.message,aW.BAD_REQUEST,void 0,void 0,!0);let n=new jQ;n.type=e.operation===oe.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE?oe.OPERATIONS_ENUM.DELETE_FILES_BEFORE:e.operation,n.type=e.operation,n.user=e.hdb_user.username;let i=new ZQ(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",n.id,"id",["id"]),o;try{o=await pI(i)}catch(l){let E=`There was an error inserting a new job: ${l}`;return Ht.error(E),t}let c=Array.isArray(o)?o:Object.keys(o);if(c&&c.length>0){n.id=JQ();try{o=await pI(i)}catch(l){let E=`There was an error inserting a new job: ${l}`;return Ht.error(E),t}if(c=Array.isArray(o)?o:Object.keys(o),c&&c.length>0)return Ht.error("Error creating a job, could not find a unique job id."),t}n.request=e;let _=new tW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",[n]),u;try{u=await cW(_)}catch(l){return Ht.error(`There was an error inserting a job for job type: ${e.operation} -- ${l}`),t.success=!1,t}if(u.inserted_hashes.length===0)t.message=`Had a problem creating a job with type ${n.operation} and id ${n.id}`;else{let l=`Created a job with type ${n.type} and id ${n.id}`;t.message=l,t.createdJob=n,t.success=!0,Ht.trace(l)}return t}a(dW,"addJob");async function SW(e){let t=qs(e.from_date,qs.ISO_8601),r=qs(e.to_date,qs.ISO_8601);if(!t.isValid())throw new Error("Invalid 'from' date, must be in ISO-8601 format (YYYY-MM-DD).");if(!r.isValid())throw new Error("Invalid 'to' date, must be in ISO-8601 format (YYYY-MM-DD)");let s=`select * from system.hdb_job where start_datetime > '${t.valueOf()}' and start_datetime < '${r.valueOf()}'`,n=new zQ(s,e.hdb_user);try{return await _W(n)}catch(i){throw Ht.error(`there was a problem searching for jobs from date ${e.from_date} to date ${e.to_date} ${i}`),new Error("there was an error searching for jobs.  Please check the log for details.")}}a(SW,"getJobsInDateRange");async function II(e){if(Fn.isEmptyOrZeroLength(e))return Fn.errorizeMessage("Invalid job ID specified.");let t=new XQ(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e],["*"]);try{return await oW(t)}catch(r){let s=`There was an error searching for a job by id: ${e} ${r}`;return Ht.error(s),Fn.errorizeMessage("there was an error searching for jobs.  Please check the log for details.")}}a(II,"getJobById");async function hW(e){if(Object.keys(e).length===0)throw new Error("invalid job object passed to updateJob");if(Fn.isEmptyOrZeroLength(e.id))throw new Error("invalid ID passed to updateJob");(e.status===oe.JOB_STATUS_ENUM.COMPLETE||e.status===oe.JOB_STATUS_ENUM.ERROR)&&(e.end_datetime=qs().valueOf());let t=new eW(oe.SYSTEM_SCHEMA_NAME,oe.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e]),r;try{r=await uW(t)}catch(s){throw new Error(s)}return r}a(hW,"updateJob")});var DI=h((h3,yI)=>{"use strict";var bI=C(),gt=T(),fW=require("moment"),q_=Ud(),F_=I(),wI=G_(),LI=Dd(),UI=ms(),TW=_c(),mW=gn(),RW=a_(),V_=class{constructor(t,r){this.job=t,this.json=r}};a(V_,"RunnerMessage");async function AW(e){if(!e||Object.keys(e).length===0)throw new Error("Empty runner passed to parseMessage");if(!e.json||Object.keys(e.json).length===0)throw new Error("Empty JSON passed to parseMessage");if(!e.job||Object.keys(e.job).length===0)throw new Error("Empty job passed to parseMessage");if(bI.isEmptyOrZeroLength(e.json.operation))throw new Error("Invalid operation");if(bI.isEmptyOrZeroLength(e.job.id))throw new Error("Empty job id specified");switch(e.json.operation){case gt.JOB_TYPE_ENUM.csv_file_load:await wr(e,q_.csvFileLoad);break;case gt.JOB_TYPE_ENUM.csv_url_load:await wr(e,q_.csvURLLoad);break;case gt.JOB_TYPE_ENUM.csv_data_load:await wr(e,q_.csvDataLoad);break;case gt.JOB_TYPE_ENUM.import_from_s3:await wr(e,q_.importFromS3);break;case gt.JOB_TYPE_ENUM.empty_trash:break;case gt.JOB_TYPE_ENUM.export_local:await wr(e,LI.export_local);break;case gt.JOB_TYPE_ENUM.export_to_s3:await wr(e,LI.export_to_s3);break;case gt.JOB_TYPE_ENUM.delete_files_before:case gt.JOB_TYPE_ENUM.delete_records_before:await wr(e,UI.deleteFilesBefore);break;case gt.JOB_TYPE_ENUM.delete_audit_logs_before:await wr(e,UI.deleteAuditLogsBefore);break;case gt.JOB_TYPE_ENUM.delete_transaction_logs_before:await wr(e,RW.deleteTransactionLogsBefore);break;default:return`Invalid operation ${e.json.operation} specified`}}a(AW,"parseMessage");async function wr(e,t){try{e.job.status=gt.JOB_STATUS_ENUM.IN_PROGRESS,e.job.start_datetime=fW().valueOf(),await wI.updateJob(e.job),await OW(e.job.id)}catch(r){let s=r.message!==void 0?r.message:r;typeof s=="string"?(s=`There was an error running ${t.name} job with id ${e.job.id} - ${s}`,r.message=s):F_.error(`There was an error running ${t.name} job with id ${e.job.id}`),F_.error(s),e.job.message=s,e.job.status=gt.JOB_STATUS_ENUM.ERROR;try{await wI.updateJob(e.job)}catch(n){throw F_.error(`Unable to update job with id ${e.job.id}`),n}throw r}}a(wr,"runJob");async function OW(e){let t=TW.generateJobConfig(e);F_.trace("launching job process:",e),await mW.start(t)}a(OW,"launchJobProcess");yI.exports={parseMessage:AW,RunnerMessage:V_}});var PI=h((f3,MI)=>{"use strict";var k_=class{constructor(t,r=void 0){this.operation_function=t,this.job_operation_function=r}};a(k_,"OperationFunctionObject");MI.exports=k_});var QI=h((T3,KI)=>{"use strict";var Y_=Tt(),Hd=m_(),x_=Ud(),Vn=Bc(),Pd=un(),aa=ms(),pW=pE(),ia=Kr(),$_=yE(),Lr=od(),Ve=I(),NW=PE(),gW=Yc(),IW=FE(),CW=Jc(),bW=VE(),wW=$E(),Bd=QE(),BI=Dd(),LW=f_(),Gd=G_(),A=T(),{hdb_errors:ca,handleHDBError:oa}=D(),{HTTP_STATUS_CODES:vI}=ca,vd=ZE(),HI=td(),K_=require("util"),Fs=Ut(),UW=hs(),yW=Cc(),$I=bn(),GI=DI(),qI=fc(),FI=hr(),VI=a_(),kI=ld(),DW=gd(),MW=K_.promisify(Y_.searchByHash),PW=K_.promisify(Y_.searchByValue),BW=K_.promisify(Y_.search),vW=K_.promisify(Hd.evaluateSQL),HW={[A.OPERATIONS_ENUM.CREATE_ATTRIBUTE]:!0,[A.OPERATIONS_ENUM.CREATE_TABLE]:!0,[A.OPERATIONS_ENUM.CREATE_SCHEMA]:!0,[A.OPERATIONS_ENUM.DROP_ATTRIBUTE]:!0,[A.OPERATIONS_ENUM.DROP_TABLE]:!0,[A.OPERATIONS_ENUM.DROP_SCHEMA]:!0},N=PI();function GW(e,t,r){return Promise.all([$I.postOperationHandler(e,t,r),e.table?Fs.flush(e):null])}a(GW,"postWrite");async function qW(e,t){try{if(e.body.operation!=="read_log"&&(Ve.log_level===A.LOG_LEVELS.INFO||Ve.log_level===A.LOG_LEVELS.DEBUG||Ve.log_level===A.LOG_LEVELS.TRACE)){let{hdb_user:s,hdb_auth_header:n,password:i,...o}=e.body;Ve.info(o)}}catch(s){Ve.error(s)}let r=A.CLUSTER_OPERATIONS[e.body.operation]===void 0?null:GW;try{let s=await DW.callOperationFunctionAsAwait(t,e.body,r);if(typeof s!="object"&&(s={message:s}),s instanceof Error)throw s;return HW[e.body.operation]&&UW.setSchemaDataToGlobal(n=>{n&&Ve.error(n)}),s}catch(s){throw Ve.info(s),s}}a(qW,"processLocalTransaction");var xI=kW();KI.exports={chooseOperation:FW,getOperationFunction:YI,processLocalTransaction:qW};function FW(e){let t;try{t=YI(e)}catch(n){throw Ve.error(`Error when selecting operation function - ${n}`),n}let{operation_function:r,job_operation_function:s}=t;try{if(e.operation==="sql"||e.search_operation&&e.search_operation.operation==="sql"){let n=e.operation==="sql"?e.sql:e.search_operation.sql,i=Hd.convertSQLToAST(n);if(e.parsed_sql_object=i,!e.bypass_auth){let o=Hd.checkASTPermissions(e,i);if(o)throw Ve.error(`${vI.FORBIDDEN} from operation ${e.search_operation}`),oa(new Error,o,ca.HTTP_STATUS_CODES.FORBIDDEN)}}else if(!e.bypass_auth&&e.operation!==A.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS){let n=s===void 0?r:s,i=e.search_operation?e.search_operation:e;i.hdb_user||(i.hdb_user=e.hdb_user);let o=LW.verifyPerms(i,n);if(o)throw Ve.error(`${vI.FORBIDDEN} from operation ${e.operation}`),oa(new Error,o,ca.HTTP_STATUS_CODES.FORBIDDEN)}}catch(n){throw oa(n,"There was an error when trying to choose an operation path")}return r}a(FW,"chooseOperation");function YI(e){if(Ve.trace(`getOperationFunction with operation: ${e.operation}`),xI.has(e.operation))return xI.get(e.operation);throw oa(new Error,ca.HDB_ERROR_MSGS.OP_NOT_FOUND(e.operation),ca.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}a(YI,"getOperationFunction");async function VW(e){Ve.trace("In serverUtils.catchup");let t=e.transaction,r=t.channel.split(":"),s=r[0],n=r[1];for(let i of t.transactions)try{i.schema=s,i.table=n,i[A.CLUSTERING_FLAG]=!0;let o;switch(i.operation){case A.OPERATIONS_ENUM.INSERT:o=await Fs.insert(i);break;case A.OPERATIONS_ENUM.UPDATE:o=await Fs.update(i);break;case A.OPERATIONS_ENUM.UPSERT:o=await Fs.upsert(i);break;case A.OPERATIONS_ENUM.DELETE:o=await aa.deleteRecord(i);break;default:Ve.warn("invalid operation in catchup");break}await $I.postOperationHandler(i,o,e)}catch(o){Ve.info("Invalid operation in transaction"),Ve.error(o)}}a(VW,"catchup");async function ur(e){let t,r;try{r=await Gd.addJob(e),t=r.createdJob;let s=new GI.RunnerMessage(t,e);return await GI.parseMessage(s),`Starting job with id ${t.id}`}catch(s){let n=`There was an error executing job: ${s.http_resp_msg?s.http_resp_msg:s}`;throw Ve.error(n),oa(s,n)}}a(ur,"executeJob");function kW(){let e=new Map;return e.set(A.OPERATIONS_ENUM.INSERT,new N(Fs.insert)),e.set(A.OPERATIONS_ENUM.UPDATE,new N(Fs.update)),e.set(A.OPERATIONS_ENUM.UPSERT,new N(Fs.upsert)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS,new N(Y_.searchByConditions)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_HASH,new N(MW)),e.set(A.OPERATIONS_ENUM.SEARCH_BY_VALUE,new N(PW)),e.set(A.OPERATIONS_ENUM.SEARCH,new N(BW)),e.set(A.OPERATIONS_ENUM.SQL,new N(vW)),e.set(A.OPERATIONS_ENUM.CSV_DATA_LOAD,new N(ur,x_.csvDataLoad)),e.set(A.OPERATIONS_ENUM.CSV_FILE_LOAD,new N(ur,x_.csvFileLoad)),e.set(A.OPERATIONS_ENUM.CSV_URL_LOAD,new N(ur,x_.csvURLLoad)),e.set(A.OPERATIONS_ENUM.IMPORT_FROM_S3,new N(ur,x_.importFromS3)),e.set(A.OPERATIONS_ENUM.CREATE_SCHEMA,new N(Vn.createSchema)),e.set(A.OPERATIONS_ENUM.CREATE_TABLE,new N(Vn.createTable)),e.set(A.OPERATIONS_ENUM.CREATE_ATTRIBUTE,new N(Vn.createAttribute)),e.set(A.OPERATIONS_ENUM.DROP_SCHEMA,new N(Vn.dropSchema)),e.set(A.OPERATIONS_ENUM.DROP_TABLE,new N(Vn.dropTable)),e.set(A.OPERATIONS_ENUM.DROP_ATTRIBUTE,new N(Vn.dropAttribute)),e.set(A.OPERATIONS_ENUM.DESCRIBE_SCHEMA,new N(Pd.describeSchema)),e.set(A.OPERATIONS_ENUM.DESCRIBE_TABLE,new N(Pd.describeTable)),e.set(A.OPERATIONS_ENUM.DESCRIBE_ALL,new N(Pd.describeAll)),e.set(A.OPERATIONS_ENUM.DELETE,new N(aa.deleteRecord)),e.set(A.OPERATIONS_ENUM.ADD_USER,new N(ia.addUser)),e.set(A.OPERATIONS_ENUM.ALTER_USER,new N(ia.alterUser)),e.set(A.OPERATIONS_ENUM.DROP_USER,new N(ia.dropUser)),e.set(A.OPERATIONS_ENUM.LIST_USERS,new N(ia.listUsersExternal)),e.set(A.OPERATIONS_ENUM.LIST_ROLES,new N($_.listRoles)),e.set(A.OPERATIONS_ENUM.ADD_ROLE,new N($_.addRole)),e.set(A.OPERATIONS_ENUM.ALTER_ROLE,new N($_.alterRole)),e.set(A.OPERATIONS_ENUM.DROP_ROLE,new N($_.dropRole)),e.set(A.OPERATIONS_ENUM.USER_INFO,new N(ia.userInfo)),e.set(A.OPERATIONS_ENUM.READ_LOG,new N(NW)),e.set(A.OPERATIONS_ENUM.ADD_NODE,new N(gW)),e.set(A.OPERATIONS_ENUM.UPDATE_NODE,new N(IW)),e.set(A.OPERATIONS_ENUM.REMOVE_NODE,new N(CW)),e.set(A.OPERATIONS_ENUM.CONFIGURE_CLUSTER,new N(bW)),e.set(A.OPERATIONS_ENUM.SET_CONFIGURATION,new N(FI.setConfiguration)),e.set(A.OPERATIONS_ENUM.CLUSTER_STATUS,new N(wW.clusterStatus)),e.set(A.OPERATIONS_ENUM.CLUSTER_SET_ROUTES,new N(Bd.setRoutes)),e.set(A.OPERATIONS_ENUM.CLUSTER_GET_ROUTES,new N(Bd.getRoutes)),e.set(A.OPERATIONS_ENUM.CLUSTER_DELETE_ROUTES,new N(Bd.deleteRoutes)),e.set(A.OPERATIONS_ENUM.EXPORT_TO_S3,new N(ur,BI.export_to_s3)),e.set(A.OPERATIONS_ENUM.DELETE_FILES_BEFORE,new N(ur,aa.deleteFilesBefore)),e.set(A.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE,new N(ur,aa.deleteFilesBefore)),e.set(A.OPERATIONS_ENUM.EXPORT_LOCAL,new N(ur,BI.export_local)),e.set(A.OPERATIONS_ENUM.SEARCH_JOBS_BY_START_DATE,new N(Gd.handleGetJobsByStartDate)),e.set(A.OPERATIONS_ENUM.GET_JOB,new N(Gd.handleGetJob)),e.set(A.OPERATIONS_ENUM.GET_FINGERPRINT,new N(vd.getFingerprint)),e.set(A.OPERATIONS_ENUM.SET_LICENSE,new N(vd.setLicense)),e.set(A.OPERATIONS_ENUM.GET_REGISTRATION_INFO,new N(vd.getRegistrationInfo)),e.set(A.OPERATIONS_ENUM.RESTART,new N(HI.restartProcesses)),e.set(A.OPERATIONS_ENUM.RESTART_SERVICE,new N(HI.restartService)),e.set(A.OPERATIONS_ENUM.CATCHUP,new N(VW)),e.set(A.OPERATIONS_ENUM.SYSTEM_INFORMATION,new N(yW.systemInformation)),e.set(A.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE,new N(ur,aa.deleteAuditLogsBefore)),e.set(A.OPERATIONS_ENUM.READ_AUDIT_LOG,new N(pW)),e.set(A.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS,new N(qI.createTokens)),e.set(A.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN,new N(qI.refreshOperationToken)),e.set(A.OPERATIONS_ENUM.GET_CONFIGURATION,new N(FI.getConfiguration)),e.set(A.OPERATIONS_ENUM.CUSTOM_FUNCTIONS_STATUS,new N(Lr.customFunctionsStatus)),e.set(A.OPERATIONS_ENUM.GET_CUSTOM_FUNCTIONS,new N(Lr.getCustomFunctions)),e.set(A.OPERATIONS_ENUM.GET_CUSTOM_FUNCTION,new N(Lr.getCustomFunction)),e.set(A.OPERATIONS_ENUM.SET_CUSTOM_FUNCTION,new N(Lr.setCustomFunction)),e.set(A.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION,new N(Lr.dropCustomFunction)),e.set(A.OPERATIONS_ENUM.ADD_CUSTOM_FUNCTION_PROJECT,new N(Lr.addCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION_PROJECT,new N(Lr.dropCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.PACKAGE_CUSTOM_FUNCTION_PROJECT,new N(Lr.packageCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.DEPLOY_CUSTOM_FUNCTION_PROJECT,new N(Lr.deployCustomFunctionProject)),e.set(A.OPERATIONS_ENUM.READ_TRANSACTION_LOG,new N(VI.readTransactionLog)),e.set(A.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE,new N(ur,VI.deleteTransactionLogsBefore)),e.set(A.OPERATIONS_ENUM.INSTALL_NODE_MODULES,new N(kI.installModules)),e.set(A.OPERATIONS_ENUM.AUDIT_NODE_MODULES,new N(kI.auditModules)),e}a(kW,"initializeOperationFunctionMap")});var XI=h((m3,ZI)=>{"use strict";var xW=require("node-ipc").IPC,WI=C(),JI=T(),Ur=I(),{IPC_ERRORS:kn}=st(),$W=require("os"),Q_=class{constructor(t,r){this.ipc=new xW,this.server_name=JI.HDB_IPC_SERVER,this.ipc.config.retry=$W.platform()=="win32"?6e5:100,this.ipc.config.id=JI.HDB_IPC_CLIENT_PREFIX+t,this.ipc.config.silent=!0,this.event_handlers=r,this.connect()}connect(){this.ipc.connectTo(this.server_name,()=>{this.generateEventHandlers(this.event_handlers)})}addEventHandler(t,r){this.ipc.of[this.server_name].on(t,r)}generateEventHandlers(t){this.ipc.of[this.server_name].on("connect",()=>{Ur.info(`IPC client ${this.ipc.config.id} connected to ${this.server_name}`)}),this.ipc.of[this.server_name].on("disconnect",()=>{Ur.info(`IPC client ${this.ipc.config.id} disconnected from ${this.server_name}`)}),this.ipc.of[this.server_name].on("error",r=>{r.code==="ECONNREFUSED"&&Ur.warn("Error connecting to HDB IPC server. Confirm that the server is running."),Ur.warn(`Error with IPC client ${this.ipc.config.id}`),Ur.warn(r)});for(let[r,s]of Object.entries(t))this.addEventHandler(r,s)}emitToServer(t){if(typeof t!="object")throw Ur.warn(kn.INVALID_IPC_DATA_TYPE),new Error(kn.INVALID_IPC_DATA_TYPE);if(WI.isEmpty(t.type))throw Ur.warn(kn.MISSING_TYPE),new Error(kn.MISSING_TYPE);if(WI.isEmpty(t.message))throw Ur.warn(kn.MISSING_MSG),new Error(kn.MISSING_MSG);Ur.trace(`IPC client ${this.ipc.config.id} emitting`,t),this.ipc.of[this.server_name].emit("message",t)}};a(Q_,"IPCClient");ZI.exports=Q_});var qd=T(),zI=C(),_a=I(),YW=hs(),KW=gn(),QW=Kr(),WW=require("util").promisify,JW=WW(YW.setSchemaDataToGlobal),ZW=QI(),XW=XI(),jI=require("moment"),eC=G_(),{cloneDeep:zW}=require("lodash"),tC=process.env[qd.PROCESS_NAME_ENV_PROP],Vs=tC.substring(4);a(async function(){let t={id:Vs,request:void 0};try{_a.notify("Starting job:",Vs),await JW(),await QW.setUsersToGlobal(),global.hdb_ipc=new XW(process.pid,{});let r=await eC.getJobById(Vs);if(zI.isEmptyOrZeroLength(r))throw new Error(`Unable to find a record in hdb_job for job: ${Vs}`);let{request:s}=r[0];if(zI.isEmptyOrZeroLength(s))throw new Error("Did not find job request in hdb_job table, unable to proceed");s=zW(s);let n=ZW.getOperationFunction(s);_a.trace("Running operation:",s.operation,"for job",Vs);let i=await n.job_operation_function(s);_a.trace("Result from job:",Vs,i),t.status=qd.JOB_STATUS_ENUM.COMPLETE,t.message=i,t.end_datetime=jI().valueOf(),_a.notify("Successfully completed job:",Vs)}catch(r){_a.error(r),t.status=qd.JOB_STATUS_ENUM.ERROR,t.message=r.message?r.message:r,t.end_datetime=jI().valueOf()}finally{await eC.updateJob(t),await KW.deleteProcess(tC)}},"job")();
